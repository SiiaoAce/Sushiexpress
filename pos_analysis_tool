# -*- coding: utf-8 -*-
"""
POSæ•°æ®åˆ†æå·¥å…· - å¢å¼ºç‰ˆ
åŒ…å«å¤šç§åˆ†æåŠŸèƒ½å’Œæœç´¢åŠŸèƒ½
"""

import pyodbc
import pandas as pd
import tkinter as tk
from tkinter import ttk, filedialog, messagebox
from datetime import datetime, timedelta
import csv
import os
import time
import json
from tkcalendar import DateEntry
import customtkinter as ctk
import sqlite3
from decimal import Decimal
import threading

# SEAutomation.py é…è‰²æ–¹æ¡ˆ
DARK_BG = "#0f172a"
DARK_PANEL = "#1e293b"
ACCENT_BLUE = "#3b82f6"
BTN_HOVER = "#60a5fa"
ACCENT_GREEN = "#10b981"
ACCENT_RED = "#ef4444"
ACCENT_PURPLE = "#8b5cf6"
ACCENT_ORANGE = "#f97316"
ENTRY_BG = "#334155"
TEXT_COLOR = "#e2e8f0"
PANEL_BG = "#1e293b"
TEXTBOX_BG = "#0f172a"

# SEAutomation.py å­—é«”é…ç½®
FONT_TITLE = ("Microsoft JhengHei", 24, "bold")
FONT_BIGBTN = ("Microsoft JhengHei", 16, "bold")
FONT_MID = ("Microsoft JhengHei", 14)
FONT_SUB = ("Microsoft JhengHei", 12)
FONT_ZH = ("Microsoft JhengHei", 12)
FONT_EN = ("Segoe UI", 11, "italic")
FONT_LOG = ("Consolas", 14)
FONT_SMALL = ("Microsoft JhengHei", 10)

# SEAutomation.py ä¸­çš„ç™¼å…‰æŒ‰éˆ•é¡
class GlowButton(ctk.CTkButton):
    """ç™¼å…‰æ•ˆæœæŒ‰éˆ•ï¼ˆç¾åŒ–ç‰ˆï¼‰- èˆ‡SEAutomation.pyç›¸åŒ"""
    
    def __init__(self, master, text=None, glow_color=ACCENT_BLUE, **kwargs):
        super().__init__(master, text=text, **kwargs)
        self._glow_color = glow_color
        self._setup_style()
        self._bind_events()

    def _setup_style(self):
        self.configure(
            border_width=0,
            fg_color=self._glow_color,
            hover_color=self._adjust_color(self._glow_color, 40),
            text_color='white',
            corner_radius=22,  # æ›´åœ“è§’
            font=("Microsoft JhengHei", 16, "bold"),  # æ›´å¤§æ›´ç²—
            height=50,  # æ›´é«˜
            width=200,  # æ›´å¯¬
            anchor="center"
        )

    def _bind_events(self):
        self.bind("<Enter>", self._on_enter)
        self.bind("<Leave>", self._on_leave)

    def _on_enter(self, event=None):
        self.configure(border_width=4, border_color=self._adjust_color(self._glow_color, 60), fg_color=self._adjust_color(self._glow_color, 20))

    def _on_leave(self, event=None):
        self.configure(border_width=0, fg_color=self._glow_color)
    
    @staticmethod
    def _adjust_color(color, amount):
        if isinstance(color, tuple) and len(color) >= 3:
            r, g, b = color[:3]
            adjusted = tuple(min(255, max(0, x + amount)) for x in (r, g, b))
            if len(color) == 4:
                return adjusted + (color[3],)
            return adjusted
        else:
            color = color.lstrip('#')
            rgb = tuple(int(color[i:i+2], 16) for i in (0, 2, 4))
            adjusted = tuple(min(255, max(0, x + amount)) for x in rgb)
            return f"#{adjusted[0]:02x}{adjusted[1]:02x}{adjusted[2]:02x}"

# è®¾ç½®è´§å¸æ ¼å¼
def format_currency(amount):
    """æ ¼å¼åŒ–è´§å¸æ˜¾ç¤º"""
    if amount is None or amount == '':
        return '$0.00'
    try:
        return f"${float(amount):,.2f}"
    except (ValueError, TypeError):
        return '$0.00'

def format_number(number):
    """æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤ºï¼ˆåƒä½åˆ†éš”ç¬¦ï¼‰"""
    if number is None or number == '':
        return '0'
    try:
        return f"{int(float(number)):,}"
    except (ValueError, TypeError):
        return '0'

def format_decimal(number, decimals=2):
    """æ ¼å¼åŒ–æµ®ç‚¹æ•°å­—æ˜¾ç¤ºï¼ˆåƒä½åˆ†éš”ç¬¦ + å›ºå®šå°æ•°ä½ï¼‰"""
    if number is None or number == '':
        return f"{0:.{decimals}f}"
    try:
        return f"{float(number):,.{decimals}f}"
    except (ValueError, TypeError):
        return f"{0:.{decimals}f}"

class MultiSelectCombobox:
    """å¤šé€‰ä¸‹æ‹‰æ¡†ç±»"""
    _active_dropdown = None  # ç±»å˜é‡ï¼Œè·Ÿè¸ªå½“å‰æ´»åŠ¨çš„dropdown
    
    def __init__(self, parent, width=15, title="é€‰æ‹©é¡¹ç›®", on_change_callback=None, delay_ms=2000, **kwargs):
        self.parent = parent
        self.width = width
        self.title = title
        self.delay_ms = delay_ms  # å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        self.delay_timer = None  # å»¶è¿Ÿå®šæ—¶å™¨
        self.values = []
        self.selected_values = []
        self.vars = {}
        self.checkboxes = {}
        self.on_change_callback = on_change_callback  # æ·»åŠ å˜åŒ–å›è°ƒ
        self.filtered_values = []  # æ·»åŠ è¿‡æ»¤åçš„å€¼åˆ—è¡¨
        self.search_entry = None  # æœç´¢æ¡†å¼•ç”¨
        
        # åˆ›å»ºä¸»æ¡†æ¶
        self.frame = tk.Frame(parent)
        
        # åˆ›å»ºä¸‹æ‹‰æ¡†
        self.combo = ttk.Combobox(self.frame, width=width, state="readonly", **kwargs)
        self.combo.pack(side="left", padx=1)
        
        # åˆ›å»ºä¸‹æ‹‰æŒ‰é’®
        self.dropdown_btn = ttk.Button(self.frame, text="â–¼", width=3, command=self.toggle_dropdown)
        self.dropdown_btn.pack(side="left", padx=1)
        
        # åˆ›å»ºä¸‹æ‹‰çª—å£
        self.dropdown_window = None
        self.dropdown_frame = None
        
        # ç»‘å®šäº‹ä»¶
        self.combo.bind('<Button-1>', self.on_click)
        self.combo.bind('<KeyPress>', self.on_key)
        self.dropdown_btn.bind('<Button-1>', self.on_click)
    
    def set_values(self, values):
        """è®¾ç½®é€‰é¡¹å€¼"""
        self.values = values
        self.filtered_values = values.copy()  # åˆå§‹åŒ–è¿‡æ»¤åçš„å€¼
        self.selected_values = []  # é»˜è®¤ä¸é€‰æ‹©ä»»ä½•é¡¹ç›®
        self.update_display()
        # ä¸åœ¨è¿™é‡Œåˆ›å»ºå¤é€‰æ¡†ï¼Œåªåœ¨æ˜¾ç¤ºä¸‹æ‹‰çª—å£æ—¶åˆ›å»º
    
    def create_checkboxes(self):
        """åˆ›å»ºå¤é€‰æ¡†"""
        if not self.dropdown_frame:
            return
            
        # æ¸…ç©ºç°æœ‰å¤é€‰æ¡†
        for widget in self.dropdown_frame.winfo_children():
            widget.destroy()
        
        self.vars = {}
        self.checkboxes = {}
        
        # ç¡®ä¿filtered_valuesæœ‰å€¼
        if not self.filtered_values:
            self.filtered_values = self.values.copy()
        
        for i, value in enumerate(self.filtered_values):
            var = tk.BooleanVar(value=value in self.selected_values)
            self.vars[value] = var
            
            cb = tk.Checkbutton(
                self.dropdown_frame, 
                text=value, 
                variable=var,
                command=lambda v=value: self.on_checkbox_change(v)
            )
            cb.pack(anchor="w", padx=2, pady=1)
            self.checkboxes[value] = cb
    
    def toggle_dropdown(self):
        """åˆ‡æ¢ä¸‹æ‹‰çª—å£"""
        if self.dropdown_window and self.dropdown_window.winfo_exists():
            self.close_dropdown()
        else:
            self.show_dropdown()
    
    def show_dropdown(self):
        """æ˜¾ç¤ºä¸‹æ‹‰çª—å£"""
        if not self.values:
            return
        
        # å…³é—­å…¶ä»–æ´»åŠ¨çš„dropdown
        if MultiSelectCombobox._active_dropdown and MultiSelectCombobox._active_dropdown != self:
            MultiSelectCombobox._active_dropdown.close_dropdown()
        
        # åˆ›å»ºä¸‹æ‹‰çª—å£
        self.dropdown_window = tk.Toplevel(self.parent)
        self.dropdown_window.overrideredirect(True)
        self.dropdown_window.attributes('-topmost', True)
        
        # è®¡ç®—ä½ç½®
        x = self.frame.winfo_rootx()
        y = self.frame.winfo_rooty() + self.frame.winfo_height()
        self.dropdown_window.geometry(f"+{x}+{y}")
        
        # åˆ›å»ºæ ‡é¢˜æ 
        title_frame = tk.Frame(self.dropdown_window)
        title_frame.pack(fill="x", padx=2, pady=2)
        
        tk.Label(title_frame, text=self.title).pack(side="left")
        close_btn = ttk.Button(title_frame, text="âœ•", width=3, command=self.close_dropdown)
        close_btn.pack(side="right")
        
        # åˆ›å»ºæœç´¢æ¡†
        search_frame = tk.Frame(self.dropdown_window)
        search_frame.pack(fill="x", padx=2, pady=2)
        
        tk.Label(search_frame, text="æœç´¢:\nSearch:").pack(side="left")
        self.search_entry = ttk.Entry(search_frame, width=15)
        self.search_entry.pack(side="left", padx=2)
        self.search_entry.bind("<KeyRelease>", self.on_search_change)
        
        clear_btn = ttk.Button(search_frame, text="æ¸…ç©º\nClear", width=4, command=self.clear_search)
        clear_btn.pack(side="left", padx=2)
        
        # åˆ›å»ºæ»šåŠ¨æ¡†æ¶
        canvas = tk.Canvas(self.dropdown_window, width=self.width*8, height=min(len(self.values)*25+10, 200))
        scrollbar = ttk.Scrollbar(self.dropdown_window, orient="vertical", command=canvas.yview)
        self.dropdown_frame = tk.Frame(canvas)
        
        self.dropdown_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=self.dropdown_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # åˆ›å»ºå¤é€‰æ¡†
        self.create_checkboxes()
        
        # ç¡®ä¿æœç´¢æ¡†å¼•ç”¨æ­£ç¡®
        if hasattr(self, 'search_entry') and self.search_entry:
            self.search_entry.focus_set()
        
        # ç»‘å®šESCé”®å…³é—­
        self.dropdown_window.bind("<Escape>", lambda e: self.close_dropdown())
        
        # ç»‘å®šå¤±å»ç„¦ç‚¹å…³é—­ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼‰
        self.dropdown_window.bind("<FocusOut>", lambda e: self.dropdown_window.after(100, self.check_focus))
        
        # è®¾ç½®å½“å‰dropdownä¸ºæ´»åŠ¨çŠ¶æ€
        MultiSelectCombobox._active_dropdown = self
        
        self.dropdown_window.focus_set()
    
    def on_click(self, event):
        """ç‚¹å‡»ä¸‹æ‹‰æ¡†æ—¶æ˜¾ç¤ºä¸‹æ‹‰çª—å£"""
        if self.dropdown_window and self.dropdown_window.winfo_exists():
            self.close_dropdown()
        else:
            self.show_dropdown()
        return "break"
    
    def on_key(self, event):
        """æŒ‰é”®äº‹ä»¶"""
        if event.keysym == 'Down':
            self.show_dropdown()
            return "break"
    
    
    def on_dropdown_click(self, event):
        """å¤„ç†ä¸‹æ‹‰çª—å£ç‚¹å‡»äº‹ä»¶"""
        # æ£€æŸ¥ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨å¤é€‰æ¡†åŒºåŸŸå†…
        widget = event.widget
        if widget == self.dropdown_window:
            # ç‚¹å‡»çª—å£ç©ºç™½åŒºåŸŸï¼Œä¸å…³é—­
            return "break"
        return "break"
    
    def check_focus(self):
        """æ£€æŸ¥ç„¦ç‚¹ï¼Œå¦‚æœå¤±å»ç„¦ç‚¹åˆ™å…³é—­"""
        if self.dropdown_window and self.dropdown_window.winfo_exists():
            try:
                # æ£€æŸ¥çª—å£æ˜¯å¦è¿˜æœ‰ç„¦ç‚¹
                if not self.dropdown_window.focus_get():
                    self.close_dropdown()
            except:
                pass
    
    def close_dropdown(self):
        """å…³é—­ä¸‹æ‹‰çª—å£"""
        if self.dropdown_window and self.dropdown_window.winfo_exists():
            self.dropdown_window.destroy()
            self.dropdown_window = None
        
        # æ¸…é™¤æ´»åŠ¨çŠ¶æ€
        if MultiSelectCombobox._active_dropdown == self:
            MultiSelectCombobox._active_dropdown = None
    
    def on_checkbox_change(self, value):
        """å¤é€‰æ¡†çŠ¶æ€æ”¹å˜"""
        if self.vars[value].get():
            if value not in self.selected_values:
                self.selected_values.append(value)
        else:
            if value in self.selected_values:
                self.selected_values.remove(value)
        
        self.update_display()
        
        # å»¶è¿Ÿè°ƒç”¨å˜åŒ–å›è°ƒ
        self._schedule_callback()
    
    def _schedule_callback(self):
        """å®‰æ’å»¶è¿Ÿå›è°ƒ"""
        # å–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨
        if self.delay_timer:
            self.parent.after_cancel(self.delay_timer)
        
        # æ˜¾ç¤ºå»¶è¿ŸçŠ¶æ€
        if self.selected_values:
            self.combo.set(f"å·²é€‰æ‹©{len(self.selected_values)}é¡¹ (é€‰æ‹©ä¸­...)")
        else:
            self.combo.set("é€‰æ‹©ä¸­...")
        
        # è®¾ç½®æ–°çš„å®šæ—¶å™¨
        self.delay_timer = self.parent.after(self.delay_ms, self._execute_callback)
    
    def _execute_callback(self):
        """æ‰§è¡Œå»¶è¿Ÿå›è°ƒ"""
        if self.on_change_callback:
            self.on_change_callback(self.selected_values)
        self.delay_timer = None
        # æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
        self.update_display()
    
    def execute_callback_immediately(self):
        """ç«‹å³æ‰§è¡Œå›è°ƒï¼ˆç”¨äºå…¨éƒ¨é€‰æ‹©/å–æ¶ˆç­‰æ“ä½œï¼‰"""
        # å–æ¶ˆå»¶è¿Ÿå®šæ—¶å™¨
        if self.delay_timer:
            self.parent.after_cancel(self.delay_timer)
            self.delay_timer = None
        
        # ç«‹å³æ‰§è¡Œå›è°ƒ
        if self.on_change_callback:
            self.on_change_callback(self.selected_values)
        
        # æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
        self.update_display()
    
    def update_display(self):
        """æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬"""
        if not self.selected_values:
            self.combo.set("æœªé€‰æ‹©")
        elif len(self.selected_values) == len(self.values):
            self.combo.set("å…¨éƒ¨")
        else:
            self.combo.set(f"å·²é€‰æ‹© {len(self.selected_values)} é¡¹")
    
    def get_selected(self):
        """è·å–é€‰ä¸­çš„å€¼"""
        return self.selected_values.copy()
    
    def get_selected_for_filter(self):
        """è·å–ç”¨äºç­›é€‰çš„é€‰ä¸­å€¼
        å¦‚æœé€‰æ‹©äº†å…¨éƒ¨ï¼Œè¿”å›Noneè¡¨ç¤ºä¸åº”ç”¨ç­›é€‰
        å¦‚æœæœªé€‰æ‹©ä»»ä½•ï¼Œè¿”å›ç©ºåˆ—è¡¨è¡¨ç¤ºä¸åº”ç”¨ç­›é€‰
        å¦‚æœé€‰æ‹©äº†éƒ¨åˆ†ï¼Œè¿”å›é€‰ä¸­çš„å€¼åˆ—è¡¨
        """
        if len(self.selected_values) == 0:
            return None  # æœªé€‰æ‹©ä»»ä½•ï¼Œä¸åº”ç”¨ç­›é€‰
        elif len(self.selected_values) == len(self.values):
            return None  # é€‰æ‹©äº†å…¨éƒ¨ï¼Œä¸åº”ç”¨ç­›é€‰
        else:
            return self.selected_values.copy()  # é€‰æ‹©äº†éƒ¨åˆ†ï¼Œåº”ç”¨ç­›é€‰
    
    def set_selected(self, values):
        """è®¾ç½®é€‰ä¸­çš„å€¼"""
        self.selected_values = values.copy() if values else []
        for value, var in self.vars.items():
            var.set(value in self.selected_values)
        self.update_display()
    
    def select_all(self):
        """é€‰æ‹©å…¨éƒ¨"""
        self.set_selected(self.values)
    
    def select_none(self):
        """å–æ¶ˆå…¨éƒ¨é€‰æ‹©"""
        self.set_selected([])
    
    def toggle_all(self):
        """åˆ‡æ¢å…¨éƒ¨é€‰æ‹©çŠ¶æ€"""
        if len(self.selected_values) == len(self.values):
            self.select_none()
        else:
            self.select_all()
    
    def on_search_change(self, event):
        """æœç´¢å†…å®¹æ”¹å˜æ—¶è§¦å‘"""
        if not hasattr(self, 'search_entry') or not self.search_entry:
            return
            
        search_term = self.search_entry.get().strip().lower()
        if not search_term:
            self.filtered_values = self.values.copy()
        else:
            self.filtered_values = [value for value in self.values if search_term in value.lower()]
        
        # é‡æ–°åˆ›å»ºå¤é€‰æ¡†
        self.create_checkboxes()
    
    def clear_search(self):
        """æ¸…ç©ºæœç´¢"""
        if hasattr(self, 'search_entry') and self.search_entry:
            self.search_entry.delete(0, tk.END)
            self.filtered_values = self.values.copy()
            self.create_checkboxes()
    
    def pack(self, **kwargs):
        """æ‰“åŒ…æ˜¾ç¤º"""
        self.frame.pack(**kwargs)

# è¿æ¥é…ç½®
SERVER = "52.230.94.233"
USER = "seadmin"
PASSWORD = "$e@dmin11!"
DATABASES = ["sushi_gogo_pos_live", "sushi_express_pos_live"]
TABLE_SALES = "pos_sales_dtls"
TABLE_PAYMENT = "pos_sales_payment_dtls"
TABLE_CANCEL = "pos_cancel_sales_item_dtls"
TABLE_ITEMS = "item_master"

class DatabaseManager:
    def __init__(self):
        self.connection = None
        self.combined_mode = False  # åˆä½µæ¨¡å¼æ¨™è¨˜
        self.actual_database = None  # å¯¦éš›é€£æ¥çš„æ•¸æ“šåº«
        self._sales_cache = {}  # é”€å”®æ•°æ®ç¼“å­˜
        self._discount_cache = {}  # æŠ˜æ‰£åˆ†æç¼“å­˜
        self._monthly_cache = {}  # æœˆåº¦æ±‡æ€»ç¼“å­˜
        self._category_cache = {}  # ç±»åˆ«åˆ†æç¼“å­˜
        self._weekly_cache = {}  # å‘¨æœŸäº§å“æ•°æ®ç¼“å­˜
        self.receipt_db_path = "receipt_database.db"
        self._product_cache = {}  # äº§å“æ€»è§ˆç¼“å­˜
        self._period_product_cache = {}  # æœŸé—´äº§å“æ€»è§ˆç¼“å­˜
        self._payment_cache = {}  # æ”¯ä»˜æ±‡æ€»ç¼“å­˜
        self._sales_tc_cache = {}  # é”€å”®TCåˆ†æç¼“å­˜
        self._sales_tc_monthly_cache = {}  # æœˆåº¦äº§å“åˆ†æç¼“å­˜
        self.performance_tips = [
            "å»ºè®®åœ¨ pos_sales_dtls è¡¨ä¸Šåˆ›å»ºä»¥ä¸‹ç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ï¼š",
            "1. CREATE INDEX IX_pos_sales_dtls_c_date ON pos_sales_dtls (c_date)",
            "2. CREATE INDEX IX_pos_sales_dtls_store_item ON pos_sales_dtls (store_name, item_name)",
            "3. CREATE INDEX IX_pos_sales_dtls_sales_no ON pos_sales_dtls (sales_no, store_name)",
            "4. CREATE INDEX IX_pos_sales_dtls_item_date ON pos_sales_dtls (item_name, c_date)",
            "5. CREATE INDEX IX_pos_sales_payment_dtls_sales ON pos_sales_payment_dtls (sales_no, store_name)",
            "6. CREATE INDEX IX_item_master_item_date ON item_master (item_name, m_date)"
        ]
        self.current_database = None
        self.outlets = []
        self.products = []
        self.payment_names = []
        # å¯ç”±GUIæ³¨å…¥çš„æ—¥å¿—å›è°ƒ: callable(str, include_db_info: bool)
        self.log_message = None

    def get_local_date_range(self, source_db: str | None = None):
        """æŸ¥è©¢æœ¬åœ°SQLiteä¸­receipt_detailsçš„æ—¥æœŸç¯„åœï¼Œå¯é¸æŒ‰æ•¸æ“šåº«ä¾†æºéæ¿¾ã€‚"""
        try:
            compressed_path = "receipt_database_compressed.db"
            if os.path.exists(compressed_path) and not os.path.exists(self.receipt_db_path):
                from receipt_database_manager import ReceiptDatabaseManager
                manager = ReceiptDatabaseManager()
                manager.decompress_database()
            import sqlite3
            if not os.path.exists(self.receipt_db_path):
                return None, None, 0
            conn = sqlite3.connect(self.receipt_db_path)
            cursor = conn.cursor()
            if source_db:
                cursor.execute(
                    "SELECT MIN(DATE(æ—¥æœŸ)), MAX(DATE(æ—¥æœŸ)), COUNT(DISTINCT DATE(æ—¥æœŸ)) FROM receipt_details WHERE æ•¸æ“šåº«ä¾†æº = ?",
                    (source_db,)
                )
            else:
                cursor.execute(
                    "SELECT MIN(DATE(æ—¥æœŸ)), MAX(DATE(æ—¥æœŸ)), COUNT(DISTINCT DATE(æ—¥æœŸ)) FROM receipt_details"
                )
            row = cursor.fetchone()
            conn.close()
            return (row[0], row[1], int(row[2] or 0)) if row else (None, None, 0)
        except Exception:
            return None, None, 0

    def get_monthly_summary_from_local(self, date_from=None, date_to=None, outlet_filters=None):
        """å¾æœ¬åœ°SQLiteå½™ç¸½æœˆåº¦æ•¸æ“šï¼ˆé–€å¸‚ x æœˆï¼‰ã€‚"""
        try:
            import sqlite3
            compressed_path = "receipt_database_compressed.db"
            if os.path.exists(compressed_path) and not os.path.exists(self.receipt_db_path):
                from receipt_database_manager import ReceiptDatabaseManager
                ReceiptDatabaseManager().decompress_database()
            if not os.path.exists(self.receipt_db_path):
                return []
            conn = sqlite3.connect(self.receipt_db_path)
            where = []
            params = []
            if date_from and date_to:
                where.append("DATE(æ—¥æœŸ) >= ? AND DATE(æ—¥æœŸ) <= ?")
                params.extend([date_from, date_to])
            if outlet_filters:
                placeholders = ",".join(["?" for _ in outlet_filters])
                where.append(f"é–€å¸‚ IN ({placeholders})")
                params.extend(outlet_filters)
            where_clause = ("WHERE " + " AND ".join(where)) if where else ""
            query = f"""
                SELECT strftime('%Y-%m', æ—¥æœŸ) as æœˆä»½,
                       é–€å¸‚,
                       COUNT(DISTINCT å–®æ“šè™Ÿ) as å–®æ“šæ•¸,
                       SUM(æ·¨é‡‘é¡) as ç¸½æ¥­ç¸¾,
                       SUM(ç¸½æ•¸é‡) as ç¸½æ•¸é‡
                FROM receipt_details
                {where_clause}
                GROUP BY strftime('%Y-%m', æ—¥æœŸ), é–€å¸‚
                ORDER BY æœˆä»½, é–€å¸‚
            """
            import pandas as pd
            df = pd.read_sql_query(query, conn, params=params)
            conn.close()
            return df.to_dict("records")
        except Exception:
            return []
    
    def get_unique_store_count(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None,
                               weekday_filters=None, category_filters=None, product_filters=None,
                               payment_filters=None):
        """æ ¹æ®ç­›é€‰æ¡ä»¶è·å–å”¯ä¸€é—¨å¸‚æ•°é‡"""
        if not self.connection:
            return 0

        conditions = []
        params = []

        if date_from:
            conditions.append("CAST(s.c_date as DATE) >= ?")
            params.append(date_from)
        if date_to:
            conditions.append("CAST(s.c_date as DATE) <= ?")
            params.append(date_to)
        if outlet_filters:
            placeholders = ','.join(['?' for _ in outlet_filters])
            conditions.append(f"s.store_name IN ({placeholders})")
            params.extend(outlet_filters)
        if month_filters:
            month_conditions = []
            for month in month_filters:
                month_conditions.append("FORMAT(s.c_date, 'yyyy-MM') = ?")
                params.append(month)
            if month_conditions:
                conditions.append("(" + " OR ".join(month_conditions) + ")")
        if weekday_filters:
            weekday_map = {
                'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4,
                'Thursday': 5, 'Friday': 6, 'Saturday': 7
            }
            weekday_conditions = []
            for weekday in weekday_filters:
                value = weekday_map.get(weekday)
                if value:
                    weekday_conditions.append(f"DATEPART(WEEKDAY, s.c_date) = {value}")
            if weekday_conditions:
                conditions.append("(" + " OR ".join(weekday_conditions) + ")")
        if category_filters:
            placeholders = ','.join(['?' for _ in category_filters])
            conditions.append(f"im.category_code IN ({placeholders})")
            params.extend(category_filters)
        if product_filters:
            placeholders = ','.join(['?' for _ in product_filters])
            conditions.append(f"s.item_name IN ({placeholders})")
            params.extend(product_filters)
        if payment_filters:
            placeholders = ','.join(['?' for _ in payment_filters])
            conditions.append(
                f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name AND p.payment_name IN ({placeholders}))"
            )
            params.extend(payment_filters)

        # æ’é™¤æŠ¥åºŸ
        conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")

        where_clause = ""
        if conditions:
            where_clause = " WHERE " + " AND ".join(conditions)

        query = f"""
            SELECT COUNT(DISTINCT s.store_name)
            FROM {TABLE_SALES} s WITH (NOLOCK)
            LEFT JOIN {TABLE_ITEMS} im ON s.item_name = im.item_name
            {where_clause}
        """

        try:
            cursor = self.connection.cursor()
            cursor.execute(query, params)
            result = cursor.fetchone()
            cursor.close()
            return int(result[0]) if result and result[0] else 0
        except Exception as e:
            print(f"è·å–å”¯ä¸€é—¨å¸‚æ•°é‡å¤±è´¥: {e}")
            return 0

    def get_performance_calculation_sql(self):
        """æ ¹æ®å½“å‰æ•°æ®åº“ç±»å‹è¿”å›æ­£ç¡®çš„ä¸šç»©è®¡ç®—SQL"""
        if self.current_database == "sushi_gogo_pos_live":
            # GOGOæ•°æ®åº“ï¼šæ‰€æœ‰å•æ®éƒ½ç›´æ¥å‡å»tax_amtï¼ŒåŒ…å«æ‰€æœ‰æŠ˜æ‰£å­—æ®µ
            return "CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CAST(ISNULL(s.tax_amt, 0) as FLOAT)"
        else:
            # Expressæ•°æ®åº“ï¼šåªæœ‰å¤–å¸¦å•†å“æ‰å‡å»tax_amtï¼ŒåŒ…å«æ‰€æœ‰æŠ˜æ‰£å­—æ®µ
            return "CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END"
    
    def get_combined_performance_calculation_sql(self, db_name):
        """ä¸ºåˆå¹¶æ¨¡å¼è¿”å›æŒ‡å®šæ•°æ®åº“çš„ä¸šç»©è®¡ç®—SQL"""
        if db_name == "sushi_gogo_pos_live":
            # GOGOæ•°æ®åº“ï¼šæ‰€æœ‰å•æ®éƒ½ç›´æ¥å‡å»tax_amtï¼ŒåŒ…å«æ‰€æœ‰æŠ˜æ‰£å­—æ®µ
            return "CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CAST(ISNULL(s.tax_amt, 0) as FLOAT)"
        else:
            # Expressæ•°æ®åº“ï¼šåªæœ‰å¤–å¸¦å•†å“æ‰å‡å»tax_amtï¼ŒåŒ…å«æ‰€æœ‰æŠ˜æ‰£å­—æ®µ
            return "CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END"
    
    def get_combined_cancel_performance_calculation_sql(self, db_name):
        """ä¸ºåˆå¹¶æ¨¡å¼è¿”å›æŒ‡å®šæ•°æ®åº“çš„å–æ¶ˆé¡¹ç›®ä¸šç»©è®¡ç®—SQLï¼ˆæ— è¡¨åˆ«åï¼‰"""
        if db_name == "sushi_gogo_pos_live":
            # GOGOæ•°æ®åº“ï¼šæ‰€æœ‰å•æ®éƒ½ç›´æ¥å‡å»tax_amtï¼ŒåŒ…å«æ‰€æœ‰æŠ˜æ‰£å­—æ®µ
            return "CAST(sub_total as FLOAT) - CAST(ISNULL(pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(disc_amt, 0) as FLOAT) + CAST(ISNULL(svc_amt, 0) as FLOAT) - CAST(ISNULL(tax_amt, 0) as FLOAT)"
        else:
            # Expressæ•°æ®åº“ï¼šåªæœ‰å¤–å¸¦å•†å“æ‰å‡å»tax_amtï¼ŒåŒ…å«æ‰€æœ‰æŠ˜æ‰£å­—æ®µ
            return "CAST(sub_total as FLOAT) - CAST(ISNULL(pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(disc_amt, 0) as FLOAT) + CAST(ISNULL(svc_amt, 0) as FLOAT) - CASE WHEN take_away_item = 'Y' THEN CAST(ISNULL(tax_amt, 0) as FLOAT) ELSE 0 END"
    
    def get_database_date_range(self):
        """è·å–æ•°æ®åº“ä¸­çš„æ•°æ®æ—¥æœŸèŒƒå›´"""
        try:
            if not self.connection:
                return None, None, None
            
            cursor = self.connection.cursor()
            
            # è·å–æœ€æ—©å’Œæœ€æ™šçš„æ—¥æœŸ
            query = """
                SELECT 
                    MIN(CAST(c_date AS DATE)) as min_date,
                    MAX(CAST(c_date AS DATE)) as max_date,
                    COUNT(DISTINCT CAST(c_date AS DATE)) as total_days
                FROM pos_sales_dtls 
                WHERE item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')
            """
            
            cursor.execute(query)
            result = cursor.fetchone()
            cursor.close()
            
            if result and result[0] and result[1]:
                return result[0], result[1], result[2]
            else:
                return None, None, None
                
        except Exception as e:
            print(f"è·å–æ•°æ®åº“æ—¥æœŸèŒƒå›´å¤±è´¥: {e}")
            return None, None, None
    
    def _get_cancel_performance_calculation_sql(self):
        """ä¸ºå–æ¶ˆé¡¹ç›®è¡¨è¿”å›æ­£ç¡®çš„ä¸šç»©è®¡ç®—SQLï¼ˆæ— è¡¨åˆ«åï¼‰"""
        if self.current_database == "sushi_gogo_pos_live":
            # GOGOæ•°æ®åº“ï¼šæ‰€æœ‰å•æ®éƒ½ç›´æ¥å‡å»tax_amtï¼ŒåŒ…å«æ‰€æœ‰æŠ˜æ‰£å­—æ®µ
            return "CAST(sub_total as FLOAT) - CAST(ISNULL(pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(disc_amt, 0) as FLOAT) + CAST(ISNULL(svc_amt, 0) as FLOAT) - CAST(ISNULL(tax_amt, 0) as FLOAT)"
        else:
            # Expressæ•°æ®åº“ï¼šåªæœ‰å¤–å¸¦å•†å“æ‰å‡å»tax_amtï¼ŒåŒ…å«æ‰€æœ‰æŠ˜æ‰£å­—æ®µ
            return "CAST(sub_total as FLOAT) - CAST(ISNULL(pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(disc_amt, 0) as FLOAT) + CAST(ISNULL(svc_amt, 0) as FLOAT) - CASE WHEN take_away_item = 'Y' THEN CAST(ISNULL(tax_amt, 0) as FLOAT) ELSE 0 END"
    
    def connect(self, database):
        """è¿æ¥åˆ°æŒ‡å®šæ•°æ®åº“ - æ”¯æŒåˆä½µæ¨¡å¼"""
        try:
            # æ•°æ®åº“åç§°æ˜ å°„ - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ•°æ®åº“åç§°
            db_mapping = {
                'GOGO': 'sushi_gogo_pos_live',
                'Express': 'sushi_express_pos_live', 
                'Plus': 'sushi_plus_pos_live',
                'PLUS': 'sushi_plus_pos_live'  # å…¼å®¹æ€§
            }
            
            # å°æ–¼"All"é¸é …ï¼Œé€£æ¥åˆ°ç¬¬ä¸€å€‹æ•¸æ“šåº«ä½†è¨­ç½®åˆä½µæ¨¡å¼æ¨™è¨˜
            if database == "All":
                print("ğŸ”€ Allé¸é …ï¼šè¨­ç½®åˆä½µæ¨¡å¼ï¼Œé€£æ¥åˆ°ç¬¬ä¸€å€‹æ•¸æ“šåº«...")
                self.combined_mode = True
                actual_database = "sushi_gogo_pos_live"  # ç¬¬ä¸€å€‹æ•¸æ“šåº«
            else:
                self.combined_mode = False
                # æ£€æŸ¥æ˜¯å¦æ˜¯é€‰é¡¹é”®ï¼Œå¦‚æœæ˜¯åˆ™æ˜ å°„åˆ°å®é™…æ•°æ®åº“åç§°
                actual_database = db_mapping.get(database, database)
            # å°è¯•ä¸åŒçš„ODBCé©±åŠ¨
            drivers = [
                "SQL Server",
                "SQL Server Native Client 11.0",
                "ODBC Driver 17 for SQL Server",
                "ODBC Driver 13 for SQL Server"
            ]
            
            for driver in drivers:
                try:
                    conn_str = f"DRIVER={{{driver}}};SERVER={SERVER};DATABASE={actual_database};UID={USER};PWD={PASSWORD};Connection Timeout=30;TDS_Version=8.0;TrustServerCertificate=yes;Encrypt=no;"
                    self.connection = pyodbc.connect(conn_str)
                    self.current_database = database  # ä¿å­˜ç”¨æˆ¶é¸æ“‡çš„é¸é …
                    self.actual_database = actual_database  # ä¿å­˜å¯¦éš›é€£æ¥çš„æ•¸æ“šåº«
                    
                    # è®¾ç½®TEXT_SIZEä»¥é¿å…TDSåè®®é”™è¯¯
                    cursor = self.connection.cursor()
                    cursor.execute("SET TEXTSIZE 2147483647")
                    cursor.execute("SET QUERY_GOVERNOR_COST_LIMIT 0")
                    cursor.execute("SET LOCK_TIMEOUT 30000")
                    cursor.close()
                    
                    print(f"ä½¿ç”¨é©±åŠ¨ {driver} è¿æ¥æˆåŠŸ")
                    if self.combined_mode:
                        print("âœ… åˆä½µæ¨¡å¼å·²å•Ÿç”¨")
                    return True
                except Exception as e:
                    print(f"é©±åŠ¨ {driver} è¿æ¥å¤±è´¥: {e}")
                    continue
            
            print("æ‰€æœ‰ODBCé©±åŠ¨éƒ½æ— æ³•è¿æ¥")
            return False
        except Exception as e:
            print(f"è¿æ¥å¤±è´¥: {e}")
            return False
    
    def disconnect(self):
        """æ–­å¼€è¿æ¥"""
        if self.connection:
            self.connection.close()
            self.connection = None
            self.current_database = None
    
    def get_monthly_product_receipt_performance_from_db(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, database_source=None):
        """å¾SQL Serverç²å–æœˆåº¦ç”¢å“å–®æ“šæ¥­ç¸¾ - å°ˆé–€ç‚ºæœˆ-éŠ·å”®æ•¸æ“šè¨­è¨ˆ"""
        try:
            if not self.connection:
                print("âŒ æ•¸æ“šåº«é€£æ¥ä¸å­˜åœ¨")
                return {}
            
            cursor = self.connection.cursor()
            
            # æ§‹å»ºé–€å¸‚ç¯©é¸æ¢ä»¶
            store_filter = ""
            if outlet_filters and len(outlet_filters) > 0:
                store_list = "', '".join(outlet_filters)
                store_filter = f"AND s.store_name IN ('{store_list}')"
            
            # æ§‹å»ºç”¢å“ç¯©é¸æ¢ä»¶
            product_filter_clause = ""
            if product_filters:
                product_list = "', '".join(product_filters)
                product_filter_clause = f"AND s.item_name IN ('{product_list}')"
            
            # æœˆåº¦ç”¢å“å–®æ“šæ¥­ç¸¾æŸ¥è©¢ï¼šæŒ‰æœˆä»½ã€é–€å¸‚ã€ç”¢å“åˆ†çµ„
            query = f"""
                WITH ProductReceipts AS (
                    -- æ‰¾å‡ºåŒ…å«æŒ‡å®šç”¢å“çš„æ‰€æœ‰å–®æ“š
                    SELECT DISTINCT 
                        s.item_name,
                        s.sales_no,
                        s.store_name,
                        FORMAT(s.c_date, 'yyyy-MM') as month_key
                    FROM pos_sales_dtls s WITH (NOLOCK)
                    WHERE s.item_name != 'WASTAGE'
                    AND CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'
                    {store_filter}
                    {product_filter_clause}
                ),
                ReceiptTotals AS (
                    -- è¨ˆç®—æ¯å¼µå–®æ“šçš„ç¸½é‡‘é¡
                    SELECT 
                        s.sales_no,
                        s.store_name,
                        FORMAT(s.c_date, 'yyyy-MM') as month_key,
                        SUM(CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END) as receipt_total
                    FROM pos_sales_dtls s WITH (NOLOCK)
                    WHERE s.item_name != 'WASTAGE'
                    AND CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'
                    {store_filter}
                    GROUP BY s.sales_no, s.store_name, FORMAT(s.c_date, 'yyyy-MM')
                )
                SELECT 
                    pr.item_name,
                    pr.month_key,
                    pr.store_name,
                    COUNT(DISTINCT pr.sales_no) as å–®æ“šæ•¸é‡,
                    SUM(rt.receipt_total) as ç”¢å“å–®æ“šæ¥­ç¸¾,
                    AVG(rt.receipt_total) as å¹³å‡å–®æ“šé‡‘é¡
                FROM ProductReceipts pr
                INNER JOIN ReceiptTotals rt ON pr.sales_no = rt.sales_no AND pr.store_name = rt.store_name AND pr.month_key = rt.month_key
                GROUP BY pr.item_name, pr.month_key, pr.store_name
                ORDER BY pr.month_key DESC, pr.store_name, pr.item_name
            """
            
            cursor.execute(query)
            rows = cursor.fetchall()
            
            # è½‰æ›ç‚ºå­—å…¸æ ¼å¼ï¼Œä½¿ç”¨çµ„åˆéµ (product_name, month, store_name)
            result = {}
            for row in rows:
                product_name = row[0]
                month = row[1]
                store_name = row[2]
                key = f"{product_name}_{month}_{store_name}"
                
                result[key] = {
                    'å•æ®æ•°é‡': int(row[3]),
                    'äº§å“å•æ®ä¸šç»©': float(row[4]),
                    'å¹³å‡å•æ®é‡‘é¢': float(row[5])
                }
            
            return result
            
        except Exception as e:
            print(f"âŒ å¾SQL Serverç²å–æœˆåº¦ç”¢å“å–®æ“šæ¥­ç¸¾å¤±æ•—: {e}")
            return {}

    def get_period_product_receipt_performance_from_db(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, database_source=None):
        """å¾SQL Serverç²å–æœŸé–“ç”¢å“å–®æ“šæ¥­ç¸¾ - å°ˆé–€ç‚ºæœŸé–“-ç”¢å“æ•¸æ“šè¨­è¨ˆ"""
        try:
            if not self.connection:
                print("âŒ æ•¸æ“šåº«é€£æ¥ä¸å­˜åœ¨")
                return {}
            
            cursor = self.connection.cursor()
            
            # æ§‹å»ºé–€å¸‚ç¯©é¸æ¢ä»¶
            store_filter = ""
            if outlet_filters and len(outlet_filters) > 0:
                store_list = "', '".join(outlet_filters)
                store_filter = f"AND s.store_name IN ('{store_list}')"
            
            # æ§‹å»ºç”¢å“ç¯©é¸æ¢ä»¶
            product_filter_clause = ""
            if product_filters:
                product_list = "', '".join(product_filters)
                product_filter_clause = f"AND s.item_name IN ('{product_list}')"
            
            # æœŸé–“ç”¢å“å–®æ“šæ¥­ç¸¾æŸ¥è©¢ï¼šæŒ‰ç”¢å“åˆ†çµ„ï¼Œèšåˆæ‰€æœ‰é–€å¸‚å’Œæ—¥æœŸ
            query = f"""
                WITH ProductReceipts AS (
                    -- æ‰¾å‡ºåŒ…å«æŒ‡å®šç”¢å“çš„æ‰€æœ‰å–®æ“š
                    SELECT DISTINCT 
                        s.item_name,
                        s.sales_no,
                        s.store_name,
                        CAST(s.c_date as DATE) as c_date
                    FROM pos_sales_dtls s WITH (NOLOCK)
                    WHERE s.item_name != 'WASTAGE'
                    AND CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'
                    {store_filter}
                    {product_filter_clause}
                ),
                ReceiptTotals AS (
                    -- è¨ˆç®—æ¯å¼µå–®æ“šçš„ç¸½é‡‘é¡
                    SELECT 
                        s.sales_no,
                        s.store_name,
                        CAST(s.c_date as DATE) as c_date,
                        SUM(CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END) as receipt_total
                    FROM pos_sales_dtls s WITH (NOLOCK)
                    WHERE s.item_name != 'WASTAGE'
                    AND CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'
                    {store_filter}
                    GROUP BY s.sales_no, s.store_name, CAST(s.c_date as DATE)
                )
                SELECT 
                    pr.item_name,
                    COUNT(DISTINCT pr.sales_no) as å–®æ“šæ•¸é‡,
                    SUM(rt.receipt_total) as ç”¢å“å–®æ“šæ¥­ç¸¾,
                    AVG(rt.receipt_total) as å¹³å‡å–®æ“šé‡‘é¡
                FROM ProductReceipts pr
                INNER JOIN ReceiptTotals rt ON pr.sales_no = rt.sales_no AND pr.store_name = rt.store_name AND pr.c_date = rt.c_date
                GROUP BY pr.item_name
                ORDER BY pr.item_name
            """
            
            cursor.execute(query)
            rows = cursor.fetchall()
            
            # è½‰æ›ç‚ºå­—å…¸æ ¼å¼ï¼Œä½¿ç”¨ç”¢å“åç¨±ä½œç‚ºéµ
            result = {}
            for row in rows:
                product_name = row[0]
                
                result[product_name] = {
                    'å•æ®æ•°é‡': int(row[1]),
                    'äº§å“å•æ®ä¸šç»©': float(row[2]),
                    'å¹³å‡å•æ®é‡‘é¢': float(row[3])
                }
            
            return result
            
        except Exception as e:
            print(f"âŒ å¾SQL Serverç²å–æœŸé–“ç”¢å“å–®æ“šæ¥­ç¸¾å¤±æ•—: {e}")
            return {}

    def get_product_receipt_performance_from_db(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, database_source=None):
        """å¾SQL Serverç²å–æŒ‡å®šæ—¥æœŸç¯„åœçš„ç”¢å“å–®æ“šæ¥­ç¸¾ - å„ªåŒ–ç‰ˆæœ¬ï¼ŒæŒ‰æ—¥æœŸå’Œé–€å¸‚åˆ†çµ„"""
        try:
            if not self.connection:
                print("âŒ æ•¸æ“šåº«é€£æ¥ä¸å­˜åœ¨")
                return {}
            
            cursor = self.connection.cursor()
            
            # æ§‹å»ºé–€å¸‚ç¯©é¸æ¢ä»¶
            store_filter = ""
            if outlet_filters and len(outlet_filters) > 0:
                store_list = "', '".join(outlet_filters)
                store_filter = f"AND s.store_name IN ('{store_list}')"
            
            # æ§‹å»ºç”¢å“ç¯©é¸æ¢ä»¶
            product_filter_clause = ""
            if product_filters:
                product_list = "', '".join(product_filters)
                product_filter_clause = f"AND s.item_name IN ('{product_list}')"
            
            # å„ªåŒ–æŸ¥è©¢ï¼šæŒ‰æ—¥æœŸã€é–€å¸‚ã€ç”¢å“åˆ†çµ„è¿”å›è©³ç´°æ•¸æ“š
            query = f"""
                WITH ProductReceipts AS (
                    -- æ‰¾å‡ºåŒ…å«æŒ‡å®šç”¢å“çš„æ‰€æœ‰å–®æ“š
                    SELECT DISTINCT 
                        s.item_name,
                        s.sales_no,
                        s.store_name,
                        CAST(s.c_date as DATE) as c_date
                    FROM pos_sales_dtls s WITH (NOLOCK)
                    WHERE s.item_name != 'WASTAGE'
                    AND CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'
                    {store_filter}
                    {product_filter_clause}
                ),
                ReceiptTotals AS (
                    -- è¨ˆç®—æ¯å¼µå–®æ“šçš„ç¸½é‡‘é¡
                    SELECT 
                        s.sales_no,
                        s.store_name,
                        CAST(s.c_date as DATE) as c_date,
                        SUM(CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END) as receipt_total
                    FROM pos_sales_dtls s WITH (NOLOCK)
                    WHERE s.item_name != 'WASTAGE'
                    AND CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'
                    {store_filter}
                    GROUP BY s.sales_no, s.store_name, CAST(s.c_date as DATE)
                )
                SELECT 
                    pr.item_name,
                    pr.c_date,
                    pr.store_name,
                    COUNT(DISTINCT pr.sales_no) as å–®æ“šæ•¸é‡,
                    SUM(rt.receipt_total) as ç”¢å“å–®æ“šæ¥­ç¸¾,
                    AVG(rt.receipt_total) as å¹³å‡å–®æ“šé‡‘é¡
                FROM ProductReceipts pr
                INNER JOIN ReceiptTotals rt ON pr.sales_no = rt.sales_no AND pr.store_name = rt.store_name AND pr.c_date = rt.c_date
                GROUP BY pr.item_name, pr.c_date, pr.store_name
                ORDER BY pr.c_date DESC, pr.store_name, pr.item_name
            """
            
            cursor.execute(query)
            rows = cursor.fetchall()
            
            # è½‰æ›ç‚ºå­—å…¸æ ¼å¼ï¼Œä½¿ç”¨çµ„åˆéµ (product_name, date, store_name)
            result = {}
            for row in rows:
                product_name = row[0]
                date = row[1]
                store_name = row[2]
                key = f"{product_name}_{date}_{store_name}"
                
                result[key] = {
                    'å•æ®æ•°é‡': int(row[3]),
                    'äº§å“å•æ®ä¸šç»©': float(row[4]),
                    'å¹³å‡å•æ®é‡‘é¢': float(row[5])
                }
            
            return result
            
        except Exception as e:
            print(f"âŒ å¾SQL Serverç²å–ç”¢å“å–®æ“šæ¥­ç¸¾å¤±æ•—: {e}")
            return {}
    
    def get_local_sales_analysis(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, 
                                month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """å¾æœ¬åœ°æ•¸æ“šåº«ç²å–éŠ·å”®åˆ†ææ•¸æ“š"""
        try:
            # æª¢æŸ¥å£“ç¸®æ•¸æ“šåº«æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å‰‡å…ˆè§£å£“ç¸®
            compressed_path = "receipt_database_compressed.db"
            if os.path.exists(compressed_path) and not os.path.exists(self.receipt_db_path):
                print("ğŸ“¦ ç™¼ç¾å£“ç¸®æ•¸æ“šåº«ï¼Œæ­£åœ¨è§£å£“ç¸®...")
                from receipt_database_manager import ReceiptDatabaseManager
                manager = ReceiptDatabaseManager()
                if not manager.decompress_database():
                    print("âŒ è§£å£“ç¸®å¤±æ•—ï¼Œä½¿ç”¨å£“ç¸®æ•¸æ“šåº«")
                    return []
            
            if not os.path.exists(self.receipt_db_path):
                print(f"âŒ æœ¬åœ°æ•¸æ“šåº«ä¸å­˜åœ¨: {self.receipt_db_path}")
                return []
            
            conn = sqlite3.connect(self.receipt_db_path)
            
            # æ§‹å»ºæŸ¥è©¢æ¢ä»¶
            where_conditions = []
            params = []
            
            # æ—¥æœŸç¯©é¸
            if date_from and date_to:
                where_conditions.append("DATE(æ—¥æœŸ) >= ? AND DATE(æ—¥æœŸ) <= ?")
                params.extend([date_from, date_to])
            
            # é–€å¸‚ç¯©é¸
            if outlet_filters:
                placeholders = ','.join(['?' for _ in outlet_filters])
                where_conditions.append(f"é–€å¸‚ IN ({placeholders})")
                params.extend(outlet_filters)
            
            # ç”¢å“ç¯©é¸ï¼ˆéœ€è¦æª¢æŸ¥ç”¢å“åˆ—è¡¨ï¼‰
            if product_filters:
                product_conditions = []
                for product in product_filters:
                    product_conditions.append("ç”¢å“åˆ—è¡¨ LIKE ?")
                    params.append(f"%{product}%")
                where_conditions.append("(" + " OR ".join(product_conditions) + ")")
            
            # æ”¯ä»˜æ–¹å¼ç¯©é¸
            if payment_filters:
                payment_conditions = []
                for payment in payment_filters:
                    payment_conditions.append("æ”¯ä»˜æ–¹å¼åˆ—è¡¨ LIKE ?")
                    params.append(f"%{payment}%")
                where_conditions.append("(" + " OR ".join(payment_conditions) + ")")
            
            where_clause = ""
            if where_conditions:
                where_clause = "WHERE " + " AND ".join(where_conditions)
            
            # æŸ¥è©¢éŠ·å”®åˆ†ææ•¸æ“š
            query = f"""
                SELECT 
                    DATE(æ—¥æœŸ) as æ—¥æœŸ,
                    é–€å¸‚,
                    COUNT(*) as å–®æ“šæ•¸,
                    SUM(æ·¨é‡‘é¡) as ç¸½æ¥­ç¸¾,
                    SUM(ç¸½æ•¸é‡) as ç¸½æ•¸é‡,
                    SUM(ç”¢å“æ•¸é‡) as ç¸½ç”¢å“æ•¸é‡,
                    SUM(ç¸½æ”¯ä»˜é‡‘é¡) as ç¸½æ”¯ä»˜é‡‘é¡,
                    SUM(ç¸½å–æ¶ˆé‡‘é¡) as ç¸½å–æ¶ˆé‡‘é¡
                FROM receipt_details
                {where_clause}
                GROUP BY DATE(æ—¥æœŸ), é–€å¸‚
                ORDER BY æ—¥æœŸ, é–€å¸‚
            """
            
            df = pd.read_sql_query(query, conn, params=params)
            conn.close()
            
            # è½‰æ›ç‚ºå­—å…¸æ ¼å¼
            result = []
            for _, row in df.iterrows():
                result.append({
                    'æ—¥æœŸ': row['æ—¥æœŸ'],
                    'é–€å¸‚': row['é–€å¸‚'],
                    'å–®æ“šæ•¸': int(row['å–®æ“šæ•¸']),
                    'ç¸½æ¥­ç¸¾': float(row['ç¸½æ¥­ç¸¾']),
                    'ç¸½æ•¸é‡': float(row['ç¸½æ•¸é‡']),
                    'ç¸½ç”¢å“æ•¸é‡': int(row['ç¸½ç”¢å“æ•¸é‡']),
                    'ç¸½æ”¯ä»˜é‡‘é¡': float(row['ç¸½æ”¯ä»˜é‡‘é¡']),
                    'ç¸½å–æ¶ˆé‡‘é¡': float(row['ç¸½å–æ¶ˆé‡‘é¡'])
                })
            
            return result
            
        except Exception as e:
            print(f"âŒ å¾æœ¬åœ°æ•¸æ“šåº«ç²å–éŠ·å”®åˆ†ææ•¸æ“šå¤±æ•—: {e}")
            return []
    
    def get_local_payment_analysis(self, date_from=None, date_to=None, outlet_filters=None, payment_filters=None):
        """å¾æœ¬åœ°æ•¸æ“šåº«ç²å–æ”¯ä»˜åˆ†ææ•¸æ“š"""
        try:
            # æª¢æŸ¥å£“ç¸®æ•¸æ“šåº«æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å‰‡å…ˆè§£å£“ç¸®
            compressed_path = "receipt_database_compressed.db"
            if os.path.exists(compressed_path) and not os.path.exists(self.receipt_db_path):
                print("ğŸ“¦ ç™¼ç¾å£“ç¸®æ•¸æ“šåº«ï¼Œæ­£åœ¨è§£å£“ç¸®...")
                from receipt_database_manager import ReceiptDatabaseManager
                manager = ReceiptDatabaseManager()
                if not manager.decompress_database():
                    print("âŒ è§£å£“ç¸®å¤±æ•—ï¼Œä½¿ç”¨å£“ç¸®æ•¸æ“šåº«")
                    return []
            
            if not os.path.exists(self.receipt_db_path):
                print(f"âŒ æœ¬åœ°æ•¸æ“šåº«ä¸å­˜åœ¨: {self.receipt_db_path}")
                return []
            
            conn = sqlite3.connect(self.receipt_db_path)
            
            # æ§‹å»ºæŸ¥è©¢æ¢ä»¶
            where_conditions = []
            params = []
            
            # æ—¥æœŸç¯©é¸
            if date_from and date_to:
                where_conditions.append("DATE(æ—¥æœŸ) >= ? AND DATE(æ—¥æœŸ) <= ?")
                params.extend([date_from, date_to])
            
            # é–€å¸‚ç¯©é¸
            if outlet_filters:
                placeholders = ','.join(['?' for _ in outlet_filters])
                where_conditions.append(f"é–€å¸‚ IN ({placeholders})")
                params.extend(outlet_filters)
            
            where_clause = ""
            if where_conditions:
                where_clause = "WHERE " + " AND ".join(where_conditions)
            
            # æŸ¥è©¢æ”¯ä»˜åˆ†ææ•¸æ“šï¼ˆå¾åŒ¯ç¸½è¡¨ï¼‰
            query = f"""
                SELECT 
                    æ”¯ä»˜æ–¹å¼,
                    æ•¸æ“šåº«ä¾†æº,
                    æ”¯ä»˜æ¬¡æ•¸,
                    ç¸½æ”¯ä»˜é‡‘é¡,
                    å¹³å‡æ”¯ä»˜é‡‘é¡
                FROM payment_summary
                ORDER BY ç¸½æ”¯ä»˜é‡‘é¡ DESC
            """
            
            df = pd.read_sql_query(query, conn, params=params)
            conn.close()
            
            # è½‰æ›ç‚ºå­—å…¸æ ¼å¼
            result = []
            for _, row in df.iterrows():
                result.append({
                    'æ”¯ä»˜æ–¹å¼': row['æ”¯ä»˜æ–¹å¼'],
                    'æ•¸æ“šåº«ä¾†æº': row['æ•¸æ“šåº«ä¾†æº'],
                    'æ”¯ä»˜æ¬¡æ•¸': int(row['æ”¯ä»˜æ¬¡æ•¸']),
                    'ç¸½æ”¯ä»˜é‡‘é¡': float(row['ç¸½æ”¯ä»˜é‡‘é¡']),
                    'å¹³å‡æ”¯ä»˜é‡‘é¡': float(row['å¹³å‡æ”¯ä»˜é‡‘é¡'])
                })
            
            return result
            
        except Exception as e:
            print(f"âŒ å¾æœ¬åœ°æ•¸æ“šåº«ç²å–æ”¯ä»˜åˆ†ææ•¸æ“šå¤±æ•—: {e}")
            return []
    
    def get_categories_by_payment(self, payment_filters):
        """æ ¹æ®æ”¯ä»˜æ–¹å¼è·å–ç±»åˆ«åˆ—è¡¨"""
        if not self.connection or not payment_filters:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºæ”¯ä»˜æ–¹å¼æ¡ä»¶
            payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
            
            query = f"""
                SELECT DISTINCT im.category_code
                FROM {TABLE_SALES} s
                INNER JOIN {TABLE_PAYMENT} p ON s.sales_no = p.sales_no
                INNER JOIN item_master im ON s.item_name = im.item_name
                WHERE ({payment_conditions})
                ORDER BY im.category_code
            """
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            return [row[0] for row in results if row[0]]
        except Exception as e:
            print(f"è·å–ç±»åˆ«å¤±è´¥: {e}")
            return []
    
    def get_products_by_filters(self, outlet_filters, month_filters, payment_filters):
        """æ ¹æ®ç­›é€‰æ¡ä»¶è·å–äº§å“åˆ—è¡¨"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                conditions.append(f"({payment_conditions})")
            
            where_clause = ""
            if conditions:
                where_clause = "WHERE " + " AND ".join(conditions)
            
            join_clause = ""
            if payment_filters and len(payment_filters) > 0:
                join_clause = f"INNER JOIN {TABLE_PAYMENT} p ON s.sales_no = p.sales_no"
            
            query = f"""
                SELECT DISTINCT s.item_name
                FROM {TABLE_SALES} s
                {join_clause}
                {where_clause}
                ORDER BY s.item_name
            """
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            return [row[0] for row in results if row[0]]
        except Exception as e:
            print(f"è·å–äº§å“å¤±è´¥: {e}")
            return []
    
    def search_products(self, search_term, outlet_filters, month_filters, payment_filters, category_filters):
        """æœç´¢äº§å“"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = [f"s.item_name LIKE '%{search_term}%'"]
            
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                conditions.append(f"({payment_conditions})")
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            where_clause = "WHERE " + " AND ".join(conditions)
            
            join_clause = ""
            if payment_filters and len(payment_filters) > 0:
                join_clause += f"INNER JOIN {TABLE_PAYMENT} p ON s.sales_no = p.sales_no"
            if category_filters and len(category_filters) > 0:
                join_clause += f" INNER JOIN item_master im ON s.item_name = im.item_name"
            
            query = f"""
                SELECT DISTINCT s.item_name
                FROM {TABLE_SALES} s
                {join_clause}
                {where_clause}
                ORDER BY s.item_name
            """
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            return [row[0] for row in results if row[0]]
        except Exception as e:
            print(f"æœç´¢äº§å“å¤±è´¥: {e}")
            return []
    
    def get_outlets(self):
        """è·å–é—¨å¸‚åˆ—è¡¨ - æ”¯æŒåˆä½µæ¨¡å¼"""
        if not self.connection:
            return []

        # å¦‚æœæ˜¯åˆä½µæ¨¡å¼ï¼Œæ‰§è¡Œåˆä½µæŸ¥è¯¢
        if self.combined_mode:
            return self.get_combined_outlets()

        try:
            cursor = self.connection.cursor()
            cursor.execute("SELECT DISTINCT store_name FROM pos_sales_dtls ORDER BY store_name")
            results = cursor.fetchall()
            self.outlets = [row[0] for row in results if row[0]]
            cursor.close()
            return self.outlets
        except Exception as e:
            print(f"è·å–é—¨å¸‚åˆ—è¡¨å¤±è´¥: {e}")
            return []
    
    def get_products(self):
        """è·å–äº§å“åˆ—è¡¨"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            cursor.execute("SELECT DISTINCT item_name FROM pos_sales_dtls WHERE item_name IS NOT NULL ORDER BY item_name")
            results = cursor.fetchall()
            self.products = [row[0] for row in results if row[0]]
            cursor.close()
            return self.products
        except Exception as e:
            print(f"è·å–äº§å“åˆ—è¡¨å¤±è´¥: {e}")
            return []
    
    def get_payment_names(self):
        """è·å–æ”¯ä»˜æ–¹å¼åˆ—è¡¨"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            cursor.execute("SELECT DISTINCT payment_name FROM pos_sales_payment_dtls WHERE payment_name IS NOT NULL ORDER BY payment_name")
            results = cursor.fetchall()
            self.payment_names = [row[0] for row in results if row[0]]
            cursor.close()
            return self.payment_names
        except Exception as e:
            print(f"è·å–æ”¯ä»˜æ–¹å¼åˆ—è¡¨å¤±è´¥: {e}")
            return []
    
    def get_months(self):
        """è·å–æœˆä»½åˆ—è¡¨"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            cursor.execute("SELECT DISTINCT FORMAT(c_date, 'yyyy-MM') as month FROM pos_sales_dtls ORDER BY month DESC")
            results = cursor.fetchall()
            months = [row[0] for row in results if row[0]]
            cursor.close()
            return months
        except Exception as e:
            print(f"è·å–æœˆä»½åˆ—è¡¨å¤±è´¥: {e}")
            return []
    
    def get_categories(self):
        """è·å–ç±»åˆ«åˆ—è¡¨"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            # è·å–æœ€æ–°çš„category_codeï¼ŒæŒ‰m_dateæ’åº
            cursor.execute("""
                SELECT DISTINCT im.category_code 
                FROM item_master im
                INNER JOIN (
                    SELECT item_name, MAX(m_date) as max_date
                    FROM item_master
                    GROUP BY item_name
                ) latest ON im.item_name = latest.item_name AND im.m_date = latest.max_date
                WHERE im.category_code IS NOT NULL
                ORDER BY im.category_code
            """)
            results = cursor.fetchall()
            categories = [row[0] for row in results if row[0]]
            cursor.close()
            return categories
        except Exception as e:
            print(f"è·å–ç±»åˆ«åˆ—è¡¨å¤±è´¥: {e}")
            return []
    
    def get_sales_data(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, search_term=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None, use_excel_cache=True):
        """è·å–é”€å”®æ•°æ® - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œæ”¯æŒåˆä½µæ¨¡å¼"""
        print(f"ğŸ” å¼€å§‹è·å–é”€å”®æ•°æ®:")
        print(f"   - æ—¥æœŸèŒƒå›´: {date_from} åˆ° {date_to}")
        print(f"   - é—¨åº—ç­›é€‰: {outlet_filters}")
        print(f"   - äº§å“ç­›é€‰: {product_filters}")
        print(f"   - æœˆä»½ç­›é€‰: {month_filters}")
        print(f"   - æ˜ŸæœŸç­›é€‰: {weekday_filters}")
        print(f"   - ç±»åˆ«ç­›é€‰: {category_filters}")
        print(f"   - æ”¯ä»˜æ–¹å¼ç­›é€‰: {payment_filters}")
        print(f"   - ä½¿ç”¨Excelç¼“å­˜: {use_excel_cache}")
        print(f"   - åˆä½µæ¨¡å¼: {self.combined_mode}")
        
        # å¦‚æœæ˜¯åˆä½µæ¨¡å¼ï¼Œæ‰§è¡Œåˆä½µæŸ¥è¯¢
        if self.combined_mode:
            return self.get_combined_sales_data(date_from, date_to, outlet_filters, product_filters, search_term, month_filters, weekday_filters, category_filters, payment_filters)
        
        # æ£€æŸ¥Excelç¼“å­˜ï¼ˆä¼˜å…ˆçº§ï¼šæœˆåº¦æ–‡ä»¶ > å•æ—¥å‹ç¼©æ–‡ä»¶ > Excelæ–‡ä»¶ï¼‰
        if use_excel_cache and date_from and date_to:
            from datetime import datetime
            
            # è§£ææ—¥æœŸï¼Œè·å–æœˆä»½
            current_date = datetime.strptime(date_from, '%Y-%m-%d')
            month_str = current_date.strftime('%Y-%m')
            
            # 1. ä¼˜å…ˆæ£€æŸ¥å·²å¯¼å‡ºçš„æ•°æ®æ–‡ä»¶
            # ç¡®å®šå½“å‰æ•°æ®åº“ - å¼ºåˆ¶ä½¿ç”¨æ•°æ®åº“ç®¡ç†å™¨è¿æ¥çš„å®é™…æ•°æ®åº“
            if hasattr(self, 'current_database') and self.current_database:
                current_db = self.current_database
            else:
                current_db = 'GOGO'
                print("âš ï¸ æ— æ³•ç¡®å®šå½“å‰æ•°æ®åº“ï¼Œé»˜è®¤ä½¿ç”¨GOGOã€‚è¯·ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£ç¡®ã€‚")
            
            # å°†å®Œæ•´æ•°æ®åº“åç§°è½¬æ¢ä¸ºç®€åŒ–åç§°ï¼ˆç”¨äºæ–‡ä»¶æŸ¥æ‰¾ï¼‰
            db_name_mapping = {
                'sushi_gogo_pos_live': 'GOGO',
                'sushi_express_pos_live': 'Express', 
                'sushi_plus_pos_live': 'PLUS'
            }
            simplified_db_name = db_name_mapping.get(current_db, current_db)
            
            export_dir = "new_staged_export_specific_data"
            
            # æ”¯æŒæ´»åŠ¨åˆ†æçš„æ—¥æœŸèŒƒå›´ -- å¢åŠ è·¨æœˆæ£€æŸ¥
            start_date = datetime.strptime(date_from, '%Y-%m-%d')
            end_date = datetime.strptime(date_to, '%Y-%m-%d')
            
            current_check_date = start_date
            all_stored_data = []
            
            while current_check_date <= end_date:
                # æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”æœˆä»½çš„å¯¼å‡ºæ–‡ä»¶ï¼ˆæ”¯æŒä¸¤ç§å‘½åæ ¼å¼ï¼‰
                month_str = current_check_date.strftime('%Y-%m')
                month_str_dash = month_str  # 2025-09
                month_str_underscore = month_str.replace('-', '_')  # 2025_09
                
                exported_monthly_file_dash = f"{export_dir}/{simplified_db_name}_sales_raw_{month_str_dash}.pkl.gz"
                exported_monthly_file_underscore = f"{export_dir}/{simplified_db_name}_sales_raw_{month_str_underscore}.pkl.gz"
                
                # ä¼˜å…ˆä½¿ç”¨è¿å­—ç¬¦æ ¼å¼ï¼ˆä¸æ‚¨çš„å¯¼å‡ºæ–‡ä»¶åŒ¹é…ï¼‰
                exported_monthly_file = exported_monthly_file_dash if os.path.exists(exported_monthly_file_dash) else exported_monthly_file_underscore
                
                if os.path.exists(exported_monthly_file):
                    print(f"ğŸ“ ä»å·²å¯¼å‡ºæœˆåº¦æ–‡ä»¶è¯»å–æ•°æ®: {exported_monthly_file}")
                    try:
                        import gzip
                        import pickle
                        with gzip.open(exported_monthly_file, 'rb') as f:
                            monthly_data = pickle.load(f)
                        
                        all_stored_data.extend(monthly_data)
                    except Exception as e:
                        print(f"âœ— å·²å¯¼å‡ºæœˆåº¦æ–‡ä»¶è¯»å–å¤±è´¥: {e}, æœˆä»½:{month_str}")
                # ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæœˆä»½
                if current_check_date.month == 12:
                    current_check_date = datetime(current_check_date.year + 1, 1, 1)
                else:
                    current_check_date = datetime(current_check_date.year, current_check_date.month + 1, 1)
            
            # æœ‰ç¼“å­˜æ•°æ®åˆ™ç­›é€‰æœŸé—´
            if all_stored_data:
                sales_data = []
                for record in all_stored_data:
                    record_date = record.get('c_date', '')
                    record_date_str = None
                    
                    if isinstance(record_date, str):
                        try:
                            if 'T' in record_date:
                                record_date_dt = datetime.fromisoformat(record_date.replace('Z', '+00:00'))
                                record_date_str = record_date_dt.strftime('%Y-%m-%d')
                            else:
                                record_date_str = record_date.split()[0]  # åªå–æ—¥æœŸéƒ¨åˆ†
                        except:
                            record_date_str = record_date.split()[0]
                    elif hasattr(record_date, 'date'):
                        record_date_str = str(record_date.date())
                    elif isinstance(record_date, datetime):
                        record_date_str = record_date.strftime('%Y-%m-%d')
                    
                    if record_date_str and date_from <= record_date_str <= date_to:
                        sales_data.append(record)
                
                if sales_data:
                    # åº”ç”¨æ˜ŸæœŸç­›é€‰
                    if weekday_filters and len(weekday_filters) > 0:
                        weekday_mapping = {
                            'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 
                            'Thursday': 4, 'Friday': 5, 'Saturday': 6
                        }
                        filtered_sales_data = []
                        for record in sales_data:
                            record_date = record.get('c_date', '')
                            if isinstance(record_date, str):
                                try:
                                    if 'T' in record_date:
                                        record_date_dt = datetime.fromisoformat(record_date.replace('Z', '+00:00'))
                                    else:
                                        record_date_dt = datetime.strptime(record_date.split()[0], '%Y-%m-%d')
                                except:
                                    continue
                            elif hasattr(record_date, 'date'):
                                record_date_dt = datetime.combine(record_date.date(), datetime.min.time())
                            elif isinstance(record_date, datetime):
                                record_date_dt = record_date
                            else:
                                continue
                            
                            weekday_name = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][record_date_dt.weekday()]
                            if weekday_name in weekday_filters:
                                filtered_sales_data.append(record)
                        
                        sales_data = filtered_sales_data
                        print(f"âœ“ åº”ç”¨æ˜ŸæœŸç­›é€‰åï¼Œå…± {len(sales_data)} æ¡è®°å½•")
                    
                    # åº”ç”¨æ”¯ä»˜æ–¹å¼ç­›é€‰ - ä¸¥æ ¼åŒ¹é…ï¼Œä¸æœŸé—´-äº§å“æ•°æ®ä¿æŒä¸€è‡´
                    if payment_filters and len(payment_filters) > 0:
                        filtered_sales_data = []
                        for record in sales_data:
                            payment_methods_str = record.get('payment_methods', '')
                            # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ”¯ä»˜æ–¹å¼éƒ½åœ¨ç­›é€‰åˆ—è¡¨ä¸­
                            payment_methods_list = [pm.strip() for pm in payment_methods_str.split(',') if pm.strip()]
                            if all(pm.upper() in [p.upper() for p in payment_filters] for pm in payment_methods_list):
                                filtered_sales_data.append(record)
                        sales_data = filtered_sales_data
                        print(f"âœ“ åº”ç”¨æ”¯ä»˜æ–¹å¼ç­›é€‰åï¼Œå…± {len(sales_data)} æ¡è®°å½•")
                    
                    print(f"âœ“ ä»æŒ‰æœˆå¯¼å‡ºçš„ç¼“å­˜æ–‡ä»¶è¯»å–å¹¶ç­›é€‰å‡ºæœŸé—´æ•°æ®ï¼Œå…± {len(sales_data)} æ¡è®°å½•")
                    return sales_data
                else:
                    print(f"âš ï¸ æœªåœ¨å·²å¯¼å‡ºæœˆåº¦æ–‡ä»¶ä¸­æ‰¾åˆ° {date_from} åˆ° {date_to} æœŸé—´çš„æ•°æ®")
            else:
                print(f"âš ï¸ æœªæ‰¾åˆ°åŒ¹é…æœˆä»½çš„å¯¼å‡ºæœˆåº¦æ–‡ä»¶ï¼Œå°†æŸ¥è¯¢æ•°æ®åº“")
            
            # 2. å°è¯•æœ¬åœ°æœˆåº¦æ–‡ä»¶
            monthly_file = f"cache/monthly_sales_{month_str.replace('-', '_')}.pkl.gz"
            if os.path.exists(monthly_file):
                print(f"ğŸ“ ä»æœˆåº¦ç¼“å­˜è¯»å–æ•°æ®: {monthly_file}")
                try:
                    import gzip
                    import pickle
                    with gzip.open(monthly_file, 'rb') as f:
                        monthly_data = pickle.load(f)
                    
                    # ä»æœˆåº¦æ•°æ®ä¸­ç­›é€‰æŒ‡å®šæ—¥æœŸçš„æ•°æ®
                    sales_data = []
                    for record in monthly_data:
                        record_date = record.get('c_date', '')
                        if isinstance(record_date, str) and record_date.startswith(date_from):
                            sales_data.append(record)
                        elif hasattr(record_date, 'date') and str(record_date.date()) == date_from:
                            sales_data.append(record)
                    
                    print(f"âœ“ ä»æœˆåº¦æ–‡ä»¶è¯»å–æˆåŠŸï¼Œç­›é€‰å‡º {len(sales_data)} æ¡è®°å½•")
                    return sales_data
                except Exception as e:
                    print(f"âœ— æœˆåº¦æ–‡ä»¶è¯»å–å¤±è´¥: {e}ï¼Œå°è¯•å•æ—¥æ–‡ä»¶")
            
            # 3. å°è¯•å·²å¯¼å‡ºçš„å•æ—¥æ–‡ä»¶ï¼ˆæ”¯æŒä¸¤ç§å‘½åæ ¼å¼ï¼‰
            date_str_dash = date_from  # 2025-09-09
            date_str_underscore = date_from.replace('-', '_')  # 2025_09_09
            
            exported_daily_file_dash = f"{export_dir}/{simplified_db_name}_sales_raw_{date_str_dash}.pkl.gz"
            exported_daily_file_underscore = f"{export_dir}/{simplified_db_name}_sales_raw_{date_str_underscore}.pkl.gz"
            
            # ä¼˜å…ˆä½¿ç”¨è¿å­—ç¬¦æ ¼å¼
            exported_daily_file = exported_daily_file_dash if os.path.exists(exported_daily_file_dash) else exported_daily_file_underscore
            if os.path.exists(exported_daily_file):
                print(f"ğŸ“ ä»å·²å¯¼å‡ºå•æ—¥æ–‡ä»¶è¯»å–æ•°æ®: {exported_daily_file}")
                try:
                    import gzip
                    import pickle
                    with gzip.open(exported_daily_file, 'rb') as f:
                        sales_data = pickle.load(f)
                    print(f"âœ“ ä»å·²å¯¼å‡ºå•æ—¥æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…± {len(sales_data)} æ¡è®°å½•")
                    return sales_data
                except Exception as e:
                    print(f"âœ— å·²å¯¼å‡ºå•æ—¥æ–‡ä»¶è¯»å–å¤±è´¥: {e}ï¼Œå°è¯•æœ¬åœ°ç¼“å­˜æ–‡ä»¶")
            
            # 4. å°è¯•æœ¬åœ°å•æ—¥å‹ç¼©æ–‡ä»¶
            compressed_file = f"cache/sales_{date_from.replace('-', '_')}.pkl.gz"
            print(f"ğŸ” æ£€æŸ¥æœ¬åœ°ç¼“å­˜æ–‡ä»¶: {compressed_file}")
            print(f"ğŸ” æ–‡ä»¶æ˜¯å¦å­˜åœ¨: {os.path.exists(compressed_file)}")
            
            if os.path.exists(compressed_file):
                file_size = os.path.getsize(compressed_file)
                print(f"ğŸ“ ä»æœ¬åœ°å•æ—¥å‹ç¼©ç¼“å­˜è¯»å–æ•°æ®: {compressed_file} (å¤§å°: {file_size} å­—èŠ‚)")
                try:
                    import gzip
                    import pickle
                    with gzip.open(compressed_file, 'rb') as f:
                        sales_data = pickle.load(f)
                    print(f"âœ“ ä»æœ¬åœ°å•æ—¥å‹ç¼©æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…± {len(sales_data)} æ¡è®°å½•")
                    return sales_data
                except Exception as e:
                    print(f"âœ— æœ¬åœ°å•æ—¥å‹ç¼©æ–‡ä»¶è¯»å–å¤±è´¥: {e}ï¼Œå°è¯•Excelæ–‡ä»¶")
                    print(f"âœ— é”™è¯¯è¯¦æƒ…: {str(e)}")
            else:
                print(f"âœ— æœ¬åœ°ç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨: {compressed_file}")
            
            # 5. å°è¯•å·²å¯¼å‡ºçš„Excelæ–‡ä»¶ï¼ˆæ”¯æŒä¸¤ç§å‘½åæ ¼å¼ï¼‰
            date_str_dash = date_from  # 2025-09-09
            date_str_underscore = date_from.replace('-', '_')  # 2025_09_09
            
            exported_excel_file_dash = f"{export_dir}/{simplified_db_name}_sales_raw_{date_str_dash}.xlsx"
            exported_excel_file_underscore = f"{export_dir}/{simplified_db_name}_sales_raw_{date_str_underscore}.xlsx"
            
            # ä¼˜å…ˆä½¿ç”¨è¿å­—ç¬¦æ ¼å¼
            exported_excel_file = exported_excel_file_dash if os.path.exists(exported_excel_file_dash) else exported_excel_file_underscore
            if os.path.exists(exported_excel_file):
                print(f"ğŸ“ ä»å·²å¯¼å‡ºExcelæ–‡ä»¶è¯»å–æ•°æ®: {exported_excel_file}")
                try:
                    import pandas as pd
                    df = pd.read_excel(exported_excel_file)
                    sales_data = df.to_dict('records')
                    print(f"âœ“ ä»å·²å¯¼å‡ºExcelè¯»å–æˆåŠŸï¼Œå…± {len(sales_data)} æ¡è®°å½•")
                    return sales_data
                except Exception as e:
                    print(f"âœ— å·²å¯¼å‡ºExcelè¯»å–å¤±è´¥: {e}ï¼Œå°è¯•æœ¬åœ°Excelæ–‡ä»¶")
            
            # 6. å¤‡ç”¨æœ¬åœ°Excelæ–‡ä»¶
            excel_file = f"cache/sales_{date_from.replace('-', '_')}.xlsx"
            if os.path.exists(excel_file):
                print(f"ğŸ“ ä»æœ¬åœ°Excelç¼“å­˜è¯»å–æ•°æ®: {excel_file}")
                try:
                    import pandas as pd
                    df = pd.read_excel(excel_file)
                    sales_data = df.to_dict('records')
                    print(f"âœ“ ä»æœ¬åœ°Excelè¯»å–æˆåŠŸï¼Œå…± {len(sales_data)} æ¡è®°å½•")
                    return sales_data
                except Exception as e:
                    print(f"âœ— æœ¬åœ°Excelè¯»å–å¤±è´¥: {e}ï¼Œå°†ä»æ•°æ®åº“æŸ¥è¯¢")
        
        if not self.connection:
            print("âœ— æ•°æ®åº“è¿æ¥ä¸å­˜åœ¨")
            return []
        
        # ç”Ÿæˆç¼“å­˜é”®
        cache_key = f"{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{product_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        
        # æ£€æŸ¥ç¼“å­˜
        if hasattr(self, '_sales_cache') and cache_key in self._sales_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„é”€å”®æ•°æ®")
            return self._sales_cache[cache_key]
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            
            if date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if product_filters and len(product_filters) > 0:
                product_conditions = " OR ".join([f"s.item_name = '{product}'" for product in product_filters])
                conditions.append(f"({product_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            if weekday_filters and len(weekday_filters) > 0:
                print(f"åº”ç”¨æ˜ŸæœŸç­›é€‰: {weekday_filters}")
                # ä½¿ç”¨DATEPARTæ¥è·å–æ˜ŸæœŸå‡ ï¼Œ1=Sunday, 2=Monday, ..., 7=Saturday
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
                    print(f"æ˜ŸæœŸç­›é€‰SQLæ¡ä»¶: {weekday_conditions}")
            if search_term:
                conditions.append(f"(s.item_name LIKE '%{search_term}%' OR s.store_name LIKE '%{search_term}%' OR s.sales_no LIKE '%{search_term}%')")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            # ç®€åŒ–ç±»åˆ«ä¿¡æ¯è·å– - æš‚æ—¶ç¦ç”¨JOINæ¥æµ‹è¯•åŸºæœ¬æŸ¥è¯¢
            join_clause = ""
            # æš‚æ—¶æ³¨é‡Šæ‰JOINï¼Œå…ˆç¡®ä¿åŸºæœ¬æŸ¥è¯¢å·¥ä½œ
            # if category_filters and len(category_filters) > 0:
            #     # æœ‰ç±»åˆ«ç­›é€‰æ—¶ä½¿ç”¨INNER JOIN
            #     join_clause = f"""
            #         INNER JOIN (
            #             SELECT DISTINCT item_name, category_code
            #             FROM item_master WITH (NOLOCK)
            #             WHERE category_code IN ({','.join([f"'{cat}'" for cat in category_filters])})
            #         ) im ON s.item_name = im.item_name
            #     """
            # else:
            #     # æ²¡æœ‰ç±»åˆ«ç­›é€‰æ—¶ä½¿ç”¨LEFT JOINè·å–æ‰€æœ‰ç±»åˆ«
            #     join_clause = f"""
            #         LEFT JOIN (
            #             SELECT DISTINCT item_name, category_code
            #             FROM item_master WITH (NOLOCK)
            #         ) im ON s.item_name = im.item_name
            #     """
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰é€»è¾‘
            # å¦‚æœpayment_filtersä¸ºNoneï¼Œè¡¨ç¤ºæœªé€‰æ‹©ä»»ä½•æ”¯ä»˜æ–¹å¼ï¼Œä¸åº”ç”¨ç­›é€‰
            # å¦‚æœpayment_filtersä¸ºç©ºåˆ—è¡¨[]ï¼Œè¡¨ç¤ºé€‰æ‹©äº†å…¨éƒ¨æ”¯ä»˜æ–¹å¼ï¼Œä¸åº”ç”¨ç­›é€‰
            # å¦‚æœpayment_filtersæœ‰å€¼ï¼Œè¡¨ç¤ºé€‰æ‹©äº†ç‰¹å®šæ”¯ä»˜æ–¹å¼ï¼Œåº”ç”¨ç­›é€‰
            if payment_filters is not None and len(payment_filters) > 0:
                # ä¼˜åŒ–æ”¯ä»˜æ–¹å¼ç­›é€‰ - ä½¿ç”¨INä»£æ›¿EXISTS
                payment_conditions = ",".join([f"'{method}'" for method in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WITH (NOLOCK) WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND p.payment_name IN ({payment_conditions}))")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æŸ¥è¯¢é”€å”®æ•°æ® - é«˜æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬
            query = f"""
                SELECT
                    s.store_name,
                    s.sales_no,
                    s.item_name,
                    s.qty,
                    s.disc_amt,
                    s.disc_name,
                    s.pro_disc_amt,
                    s.sub_total,
                    s.svc_amt,
                    s.tax_amt,
                    s.c_date,
                    s.order_datetime,
                    {self.get_performance_calculation_sql()} as total_amt,
                    COALESCE(im.category_code, 'æœªåˆ†ç±»') as category_code
                FROM {TABLE_SALES} s WITH (NOLOCK)
                LEFT JOIN item_master im WITH (NOLOCK) ON s.item_name = im.item_name
                {where_clause}
                ORDER BY s.c_date DESC, s.store_name, s.sales_no
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            # æ·»åŠ è°ƒè¯•ä¿¡æ¯
            print(f"ğŸ” SQLæŸ¥è¯¢è°ƒè¯•ä¿¡æ¯:")
            print(f"   - è¡¨å: {TABLE_SALES}")
            print(f"   - WHEREå­å¥: {where_clause}")
            print(f"   - JOINå­å¥: LEFT JOIN item_master im WITH (NOLOCK) ON s.item_name = im.item_name")
            print(f"   - æŸ¥è¯¢å‰100ä¸ªå­—ç¬¦: {query[:100]}...")
            
            # æµ‹è¯•item_masterè¡¨
            try:
                test_cursor = self.connection.cursor()
                test_cursor.execute("SELECT TOP 3 item_name, category_code FROM item_master WHERE category_code IS NOT NULL")
                test_results = test_cursor.fetchall()
                print(f"ğŸ” item_masteræµ‹è¯•æŸ¥è¯¢ç»“æœ: {len(test_results)} æ¡è®°å½•")
                for row in test_results:
                    print(f"   - {row[0]} -> {row[1]}")
                test_cursor.close()
            except Exception as e:
                print(f"ğŸ” item_masteræµ‹è¯•æŸ¥è¯¢å¤±è´¥: {e}")
                
            # å¦‚æœitem_masteræ²¡æœ‰category_codeï¼Œå°è¯•å…¶ä»–å­—æ®µ
            try:
                test_cursor2 = self.connection.cursor()
                test_cursor2.execute("SELECT TOP 1 * FROM item_master")
                test_result2 = test_cursor2.fetchone()
                if test_result2:
                    columns = [desc[0] for desc in test_cursor2.description]
                    print(f"ğŸ” item_masterè¡¨å­—æ®µ: {columns}")
                test_cursor2.close()
            except Exception as e:
                print(f"ğŸ” item_masterè¡¨ç»“æ„æŸ¥è¯¢å¤±è´¥: {e}")
            
            # æ‰§è¡ŒæŸ¥è¯¢å¹¶æ·»åŠ æ€§èƒ½ç›‘æ§
            import time
            start_time = time.time()
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            end_time = time.time()
            query_time = end_time - start_time
            
            # æ·»åŠ æç¤ºä¿¡æ¯
            print(f"âœ“ è·å–é”€å”®æ•°æ®æˆåŠŸï¼Œå…± {len(results)} æ¡è®°å½•ï¼Œè€—æ—¶: {query_time:.2f} ç§’")
            
            # è·å–æ”¯ä»˜æ–¹å¼ä¿¡æ¯
            payment_info = {}
            if results:
                try:
                    payment_cursor = self.connection.cursor()
                    # è·å–æ‰€æœ‰é”€å”®è®°å½•çš„æ”¯ä»˜æ–¹å¼ä¿¡æ¯
                    sales_keys = [(row[0], row[1]) for row in results]  # (store_name, sales_no)
                    if sales_keys:
                        # æ„å»ºINå­å¥
                        placeholders = ','.join(['(?, ?)' for _ in sales_keys])
                        payment_query = f"""
                            SELECT store_name, sales_no, payment_name
                            FROM {TABLE_PAYMENT}
                            WHERE (store_name, sales_no) IN ({placeholders})
                        """
                        payment_params = []
                        for store_name, sales_no in sales_keys:
                            payment_params.extend([store_name, sales_no])
                        
                        payment_cursor.execute(payment_query, payment_params)
                        payment_results = payment_cursor.fetchall()
                        
                        # æ„å»ºæ”¯ä»˜æ–¹å¼æ˜ å°„
                        for payment_row in payment_results:
                            store_name, sales_no, payment_name = payment_row
                            key = f"{store_name}-{sales_no}"
                            if key not in payment_info:
                                payment_info[key] = []
                            payment_info[key].append(payment_name)
                    
                    payment_cursor.close()
                except Exception as e:
                    print(f"è·å–æ”¯ä»˜æ–¹å¼ä¿¡æ¯å¤±è´¥: {e}")
                    payment_info = {}
            
            # éªŒè¯æŸ¥è¯¢ç»“æœ
            if not results:
                print("æŸ¥è¯¢è¿”å›ç©ºç»“æœ")
                return []
            
            print(f"æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› {len(results)} æ¡è®°å½•")
            
            # è½¬æ¢æ•°æ®
            sales_data = []
            for i, row in enumerate(results):
                sub_total = float(row[7]) if row[7] else 0.0
                pro_disc_amt = float(row[6]) if row[6] else 0.0
                svc_amt = float(row[8]) if row[8] else 0.0
                tax_amt = float(row[9]) if row[9] else 0.0
                # æ ¹æ®æ•°æ®åº“ç±»å‹è®¡ç®—ä¸šç»©
                if self.current_database == "sushi_gogo_pos_live":
                    # GOGOæ•°æ®åº“ï¼šæ‰€æœ‰å•æ®éƒ½ç›´æ¥å‡å»tax_amt
                    total_amt = sub_total - pro_disc_amt + svc_amt - tax_amt
                else:
                    # Expressæ•°æ®åº“ï¼šåªæœ‰å¤–å¸¦å•†å“æ‰å‡å»tax_amt
                    take_away_item = str(row[4]) if row[4] else 'N'
                    if take_away_item == 'Y':
                        total_amt = sub_total - pro_disc_amt + svc_amt - tax_amt
                    else:
                        total_amt = sub_total - pro_disc_amt + svc_amt
                
                sales_data.append({
                    'store_name': str(row[0]) if row[0] else '',
                    'sales_no': str(row[1]) if row[1] else '',
                    'item_name': str(row[2]) if row[2] else '',
                    'qty': float(row[3]) if row[3] else 0.0,
                    'disc_amt': float(row[4]) if row[4] else 0.0,
                    'disc_name': str(row[5]) if row[5] else '',
                    'pro_disc_amt': pro_disc_amt,
                    'sub_total': sub_total,
                    'svc_amt': svc_amt,
                    'tax_amt': tax_amt,
                    'c_date': row[10],
                    'order_datetime': row[11],
                    'total_amt': total_amt,
                    'month': row[10].strftime('%Y-%m') if row[10] else '',
                    'category_code': str(row[13]) if row[13] else 'æœªåˆ†ç±»',
                    'payment_methods': ','.join(payment_info.get(f"{row[0]}-{row[1]}", []))
                })
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_sales_cache'):
                self._sales_cache = {}
            self._sales_cache[cache_key] = sales_data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._sales_cache) > 10:
                # åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                oldest_key = next(iter(self._sales_cache))
                del self._sales_cache[oldest_key]
            
            # å¯¼å‡ºåˆ°Excelç¼“å­˜ï¼ˆå•æ—¥æ•°æ®ï¼‰
            if use_excel_cache and date_from and date_to and date_from == date_to:
                self.export_to_excel_cache(sales_data, date_from)
                # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå¹¶æœˆåº¦æ•°æ®
                self.check_and_merge_monthly_data(date_from)
            
            return sales_data
            
        except Exception as e:
            print(f"è·å–é”€å”®æ•°æ®å¤±è´¥: {e}")
            import traceback
            print("è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
            traceback.print_exc()
            return []
    
    def export_to_excel_cache(self, sales_data, date_str):
        """å¯¼å‡ºæ•°æ®åˆ°Excelç¼“å­˜æ–‡ä»¶ - å‹ç¼©ä¼˜åŒ–ç‰ˆæœ¬"""
        try:
            import pandas as pd
            import os
            import gzip
            import pickle
            
            # åˆ›å»ºcacheç›®å½•
            cache_dir = "cache"
            if not os.path.exists(cache_dir):
                os.makedirs(cache_dir)
            
            # ç”Ÿæˆæ–‡ä»¶å - ä½¿ç”¨å‹ç¼©æ ¼å¼
            excel_file = f"{cache_dir}/sales_{date_str.replace('-', '_')}.xlsx"
            compressed_file = f"{cache_dir}/sales_{date_str.replace('-', '_')}.pkl.gz"
            
            # å¯¼å‡ºåˆ°Excelï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
            df = pd.DataFrame(sales_data)
            df.to_excel(excel_file, index=False, engine='openpyxl')
            
            # å¯¼å‡ºå‹ç¼©ç‰ˆæœ¬
            with gzip.open(compressed_file, 'wb') as f:
                pickle.dump(sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
            
            # è·å–æ–‡ä»¶å¤§å°
            excel_size = os.path.getsize(excel_file) / (1024 * 1024)  # MB
            compressed_size = os.path.getsize(compressed_file) / (1024 * 1024)  # MB
            compression_ratio = (1 - compressed_size / excel_size) * 100 if excel_size > 0 else 0
            
            print(f"ğŸ“Š Excelç¼“å­˜å·²ç”Ÿæˆ:")
            print(f"   æ ‡å‡†æ–‡ä»¶: {excel_file} ({excel_size:.2f} MB)")
            print(f"   å‹ç¼©æ–‡ä»¶: {compressed_file} ({compressed_size:.2f} MB)")
            print(f"   å‹ç¼©ç‡: {compression_ratio:.1f}%ï¼Œè®°å½•æ•°: {len(sales_data)}")
            
        except Exception as e:
            print(f"âœ— Excelç¼“å­˜å¯¼å‡ºå¤±è´¥: {e}")
    
    def check_and_merge_monthly_data(self, date_str):
        """æ£€æŸ¥å¹¶åˆå¹¶æœˆåº¦æ•°æ®"""
        try:
            from datetime import datetime
            import os
            import glob
            
            # è§£æå½“å‰æ—¥æœŸ
            current_date = datetime.strptime(date_str, '%Y-%m-%d')
            current_month = current_date.strftime('%Y-%m')
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯æœˆæœ«ï¼ˆä¸‹ä¸ªæœˆçš„ç¬¬ä¸€å¤©ï¼‰
            next_month = current_date.replace(day=1)
            if next_month.month == 12:
                next_month = next_month.replace(year=next_month.year + 1, month=1)
            else:
                next_month = next_month.replace(month=next_month.month + 1)
            
            # å¦‚æœä»Šå¤©æ˜¯ä¸‹ä¸ªæœˆçš„ç¬¬ä¸€å¤©ï¼Œè¯´æ˜ä¸Šä¸ªæœˆå·²ç»ç»“æŸ
            if current_date.date() == next_month.date():
                previous_month = current_date.replace(day=1)
                previous_month_str = previous_month.strftime('%Y-%m')
                print(f"ğŸ“… æ£€æµ‹åˆ°æœˆä»½ç»“æŸï¼Œå¼€å§‹åˆå¹¶ {previous_month_str} çš„æ•°æ®...")
                self.merge_monthly_files(previous_month_str)
            
        except Exception as e:
            print(f"âœ— æœˆåº¦åˆå¹¶æ£€æŸ¥å¤±è´¥: {e}")
    
    def merge_monthly_files(self, month_str):
        """åˆå¹¶æŒ‡å®šæœˆä»½çš„æ‰€æœ‰å•æ—¥æ–‡ä»¶ä¸ºæœˆåº¦æ–‡ä»¶"""
        try:
            import os
            import glob
            import gzip
            import pickle
            from datetime import datetime
            
            cache_dir = "cache"
            if not os.path.exists(cache_dir):
                return
            
            # æŸ¥æ‰¾è¯¥æœˆçš„æ‰€æœ‰å•æ—¥æ–‡ä»¶
            daily_files = glob.glob(f"{cache_dir}/sales_{month_str.replace('-', '_')}_*.pkl.gz")
            
            if len(daily_files) < 2:  # å¦‚æœåªæœ‰1ä¸ªæˆ–æ²¡æœ‰æ–‡ä»¶ï¼Œä¸éœ€è¦åˆå¹¶
                print(f"â„¹ï¸ {month_str} åªæœ‰ {len(daily_files)} ä¸ªæ–‡ä»¶ï¼Œè·³è¿‡åˆå¹¶")
                return
            
            print(f"ğŸ“Š å¼€å§‹åˆå¹¶ {month_str} çš„ {len(daily_files)} ä¸ªå•æ—¥æ–‡ä»¶...")
            
            # åˆå¹¶æ‰€æœ‰æ•°æ®
            merged_data = []
            total_records = 0
            total_size = 0
            
            for file_path in sorted(daily_files):
                try:
                    with gzip.open(file_path, 'rb') as f:
                        daily_data = pickle.load(f)
                    
                    merged_data.extend(daily_data)
                    total_records += len(daily_data)
                    total_size += os.path.getsize(file_path)
                    
                    print(f"   âœ“ å·²åˆå¹¶: {os.path.basename(file_path)} ({len(daily_data)} æ¡è®°å½•)")
                    
                except Exception as e:
                    print(f"   âœ— åˆå¹¶å¤±è´¥: {os.path.basename(file_path)} - {e}")
            
            if merged_data:
                # ç”Ÿæˆæœˆåº¦æ–‡ä»¶å
                monthly_file = f"{cache_dir}/monthly_sales_{month_str.replace('-', '_')}.pkl.gz"
                
                # ä¿å­˜åˆå¹¶åçš„æ•°æ®
                with gzip.open(monthly_file, 'wb') as f:
                    pickle.dump(merged_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                
                monthly_size = os.path.getsize(monthly_file)
                compression_ratio = (1 - monthly_size / total_size) * 100 if total_size > 0 else 0
                
                print(f"ğŸ“¦ æœˆåº¦åˆå¹¶å®Œæˆ:")
                print(f"   - æœˆåº¦æ–‡ä»¶: {monthly_file}")
                print(f"   - æ€»è®°å½•æ•°: {total_records}")
                print(f"   - åˆå¹¶å‰æ€»å¤§å°: {total_size/1024/1024:.2f} MB")
                print(f"   - åˆå¹¶åå¤§å°: {monthly_size/1024/1024:.2f} MB")
                print(f"   - å‹ç¼©ç‡: {compression_ratio:.1f}%")
                
                # å¯é€‰ï¼šåˆ é™¤å•æ—¥æ–‡ä»¶ï¼ˆä¿ç•™åŸå§‹æ–‡ä»¶ï¼‰
                print(f"â„¹ï¸ ä¿ç•™åŸå§‹å•æ—¥æ–‡ä»¶ï¼Œæœˆåº¦æ–‡ä»¶å·²åˆ›å»º")
                
            else:
                print(f"âœ— æ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯ä»¥åˆå¹¶")
                
        except Exception as e:
            print(f"âœ— æœˆåº¦æ–‡ä»¶åˆå¹¶å¤±è´¥: {e}")
    
    def manual_merge_monthly_data(self, month_str):
        """æ‰‹åŠ¨åˆå¹¶æŒ‡å®šæœˆä»½çš„æ•°æ®"""
        try:
            print(f"ğŸ”§ æ‰‹åŠ¨åˆå¹¶ {month_str} çš„æ•°æ®...")
            self.merge_monthly_files(month_str)
        except Exception as e:
            print(f"âœ— æ‰‹åŠ¨åˆå¹¶å¤±è´¥: {e}")
    
    def get_cache_statistics(self):
        """è·å–ç¼“å­˜æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯"""
        try:
            import os
            import glob
            from datetime import datetime
            
            cache_dir = "cache"
            if not os.path.exists(cache_dir):
                print("ğŸ“Š ç¼“å­˜ç›®å½•ä¸å­˜åœ¨")
                return
            
            # ç»Ÿè®¡å•æ—¥æ–‡ä»¶
            daily_files = glob.glob(f"{cache_dir}/sales_*.pkl.gz")
            excel_files = glob.glob(f"{cache_dir}/sales_*.xlsx")
            monthly_files = glob.glob(f"{cache_dir}/monthly_sales_*.pkl.gz")
            
            print(f"ğŸ“Š ç¼“å­˜æ–‡ä»¶ç»Ÿè®¡:")
            print(f"   - å•æ—¥å‹ç¼©æ–‡ä»¶: {len(daily_files)} ä¸ª")
            print(f"   - å•æ—¥Excelæ–‡ä»¶: {len(excel_files)} ä¸ª")
            print(f"   - æœˆåº¦å‹ç¼©æ–‡ä»¶: {len(monthly_files)} ä¸ª")
            
            # è®¡ç®—æ€»å¤§å°
            total_size = 0
            for file_path in daily_files + excel_files + monthly_files:
                total_size += os.path.getsize(file_path)
            
            print(f"   - æ€»å ç”¨ç©ºé—´: {total_size/1024/1024:.2f} MB")
            
            # æ˜¾ç¤ºæœˆåº¦æ–‡ä»¶è¯¦æƒ…
            if monthly_files:
                print(f"ğŸ“… æœˆåº¦æ–‡ä»¶è¯¦æƒ…:")
                for monthly_file in sorted(monthly_files):
                    filename = os.path.basename(monthly_file)
                    file_size = os.path.getsize(monthly_file) / (1024 * 1024)
                    print(f"   - {filename}: {file_size:.2f} MB")
            
        except Exception as e:
            print(f"âœ— è·å–ç¼“å­˜ç»Ÿè®¡å¤±è´¥: {e}")
    
    def get_payment_methods_for_sales(self, sales_results):
        """ä¸ºé”€å”®æ•°æ®è·å–æ”¯ä»˜æ–¹å¼ä¿¡æ¯"""
        if not self.connection or not sales_results:
            return {}
        
        try:
            cursor = self.connection.cursor()
            payment_dict = {}
            
            # æ„å»ºé”€å”®è®°å½•çš„å”¯ä¸€æ ‡è¯†ç¬¦åˆ—è¡¨
            sales_keys = []
            for i, row in enumerate(sales_results):
                store_name = str(row[0]) if row[0] else ''
                sales_no = str(row[1]) if row[1] else ''
                
                if not store_name or not sales_no:
                    payment_dict[i] = 'æ— æ”¯ä»˜ä¿¡æ¯'
                else:
                    sales_keys.append((i, store_name, sales_no))
            
            if not sales_keys:
                return payment_dict
            
            # æ‰¹é‡æŸ¥è¯¢æ”¯ä»˜æ–¹å¼ï¼Œæé«˜æ•ˆç‡
            print(f"æ­£åœ¨æŸ¥è¯¢ {len(sales_keys)} æ¡é”€å”®è®°å½•çš„æ”¯ä»˜æ–¹å¼...")
            
            # æ„å»ºæ‰¹é‡æŸ¥è¯¢æ¡ä»¶
            where_conditions = []
            for i, store_name, sales_no in sales_keys:
                store_name_escaped = store_name.replace("'", "''")
                sales_no_escaped = sales_no.replace("'", "''")
                where_conditions.append(f"(store_name = '{store_name_escaped}' AND sales_no = '{sales_no_escaped}')")
            
            # æ‰¹é‡æŸ¥è¯¢æ”¯ä»˜æ–¹å¼ - ä¼˜åŒ–ç‰ˆæœ¬
            batch_query = f"""
                SELECT store_name, sales_no, payment_name
                FROM {TABLE_PAYMENT} WITH (NOLOCK)
                WHERE {' OR '.join(where_conditions)}
                ORDER BY store_name, sales_no
                OPTION (RECOMPILE)
            """
            
            try:
                cursor.execute(batch_query)
                payment_results = cursor.fetchall()
                
                # å°†æ”¯ä»˜æ–¹å¼ç»“æœæŒ‰é”€å”®è®°å½•åˆ†ç»„
                payment_groups = {}
                for result in payment_results:
                    store_name = str(result[0]) if result[0] else ''
                    sales_no = str(result[1]) if result[1] else ''
                    payment_name = str(result[2]) if result[2] else ''
                    
                    key = f"{store_name}|{sales_no}"
                    if key not in payment_groups:
                        payment_groups[key] = []
                    if payment_name:
                        payment_groups[key].append(payment_name)
                
                # ä¸ºæ¯ä¸ªé”€å”®è®°å½•åˆ†é…æ”¯ä»˜æ–¹å¼
                for i, store_name, sales_no in sales_keys:
                    key = f"{store_name}|{sales_no}"
                    if key in payment_groups and payment_groups[key]:
                        payment_dict[i] = ', '.join(payment_groups[key])
                    else:
                        payment_dict[i] = 'æ— æ”¯ä»˜ä¿¡æ¯'
                
                print(f"âœ“ æˆåŠŸè·å–æ”¯ä»˜æ–¹å¼ä¿¡æ¯ï¼Œå…± {len(payment_results)} æ¡æ”¯ä»˜è®°å½•")
                
            except Exception as e:
                print(f"æ‰¹é‡æŸ¥è¯¢æ”¯ä»˜æ–¹å¼å¤±è´¥: {e}")
                # å¦‚æœæ‰¹é‡æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°å•ç‹¬æŸ¥è¯¢
                for i, store_name, sales_no in sales_keys:
                    try:
                        store_name_escaped = store_name.replace("'", "''")
                        sales_no_escaped = sales_no.replace("'", "''")
                        
                        query = f"""
                            SELECT payment_name
                            FROM {TABLE_PAYMENT}
                            WHERE store_name = '{store_name_escaped}' 
                            AND sales_no = '{sales_no_escaped}'
                        """
                        
                        cursor.execute(query)
                        results = cursor.fetchall()
                        
                        if results:
                            payment_methods = [str(result[0]) for result in results if result[0]]
                            payment_dict[i] = ', '.join(payment_methods) if payment_methods else 'æ— æ”¯ä»˜ä¿¡æ¯'
                        else:
                            payment_dict[i] = 'æ— æ”¯ä»˜ä¿¡æ¯'
                            
                    except Exception as e2:
                        print(f"å•ç‹¬æŸ¥è¯¢æ”¯ä»˜æ–¹å¼å¤±è´¥ {store_name}-{sales_no}: {e2}")
                        payment_dict[i] = 'æ— æ”¯ä»˜ä¿¡æ¯'
            
            cursor.close()
            return payment_dict
            
        except Exception as e:
            print(f"è·å–æ”¯ä»˜æ–¹å¼ä¿¡æ¯å¤±è´¥: {e}")
            return {}
    
    def get_payment_summary(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, category_filters=None, payment_filters=None):
        """è·å–æ”¯ä»˜æ–¹å¼æ±‡æ€»ï¼ˆå„ªå…ˆæœ¬åœ°ï¼Œå¤±æ•—å›é€€SQL Serverï¼‰"""
        # å…ˆå˜—è©¦æœ¬åœ°SQLiteå½™ç¸½
        try:
            local_result = self.get_local_payment_analysis(
                date_from=date_from,
                date_to=date_to,
                outlet_filters=outlet_filters,
                payment_filters=payment_filters,
            )
            if local_result:
                if self.log_message:
                    self.log_message("ğŸ“¦ ä½¿ç”¨æœ¬åœ°SQLiteæ”¯ä»˜åˆ†ææ•¸æ“š", include_db_info=False)
                return local_result
            else:
                if self.log_message:
                    self.log_message("â„¹ æœ¬åœ°SQLiteç„¡æ•¸æ“šï¼Œå›é€€åˆ°SQL Server", include_db_info=False)
        except Exception as _e:
            if self.log_message:
                self.log_message("âš ï¸ è®€å–æœ¬åœ°SQLiteæ”¯ä»˜åˆ†æå¤±æ•—ï¼Œå›é€€åˆ°SQL Server", include_db_info=False)
        if not self.connection:
            return []
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"payment_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{month_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_payment_cache') and cache_key in self._payment_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„æ”¯ä»˜æ±‡æ€»æ•°æ®")
            return self._payment_cache[cache_key]
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            if date_from:
                conditions.append(f"CAST(p.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(p.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"p.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(p.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ·»åŠ æ”¯ä»˜æ–¹å¼ç­›é€‰æ¡ä»¶ - æ­£ç¡®å¤„ç†åˆå¹¶çš„æ”¯ä»˜æ–¹å¼
            if payment_filters and len(payment_filters) > 0:
                # æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†Delivery Salesç›¸å…³çš„æ”¯ä»˜æ–¹å¼
                delivery_methods = ['GRAB FOOD', 'FOOD PANDA', 'DELIVEROO']
                selected_delivery_methods = [method for method in payment_filters if method in delivery_methods]
                
                payment_conditions = []
                for method in payment_filters:
                    if method in delivery_methods:
                        # å¦‚æœæ˜¯å¤–é€å¹³å°çš„åŸå§‹åç§°ï¼Œç›´æ¥åŒ¹é…
                        payment_conditions.append(f"p.payment_name = '{method}'")
                    elif method == 'Delivery Sales':
                        # å¦‚æœé€‰æ‹©äº†Delivery Salesï¼Œéœ€è¦åŒ…å«æ‰€æœ‰å¤–é€å¹³å°çš„åŸå§‹åç§°
                        payment_conditions.append("p.payment_name IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO')")
                    else:
                        # å…¶ä»–æ”¯ä»˜æ–¹å¼ç›´æ¥åŒ¹é…
                        payment_conditions.append(f"p.payment_name = '{method}'")
                
                if payment_conditions:
                    conditions.append(f"({' OR '.join(payment_conditions)})")
            
            # æ€»æ˜¯éœ€è¦JOINé”€å”®è¡¨æ¥æ’é™¤WASTAGEå’Œè·å–æ­£ç¡®çš„æ€»é‡‘é¢è®¡ç®—
            join_clause = ""
            if category_filters and len(category_filters) > 0:
                join_clause = f"""
                    INNER JOIN item_master im ON s.item_name = im.item_name
                """
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æ„å»ºæ”¯ä»˜æ–¹å¼åˆå¹¶é€»è¾‘ - æ ¹æ®ç­›é€‰æ¡ä»¶åŠ¨æ€è°ƒæ•´
            delivery_case = ""
            if payment_filters and len(payment_filters) > 0:
                # æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†å¤–é€å¹³å°çš„æ”¯ä»˜æ–¹å¼
                selected_delivery_methods = [method for method in payment_filters if method in ['GRAB FOOD', 'FOOD PANDA', 'DELIVEROO']]
                if selected_delivery_methods:
                    # å¦‚æœé€‰æ‹©äº†å¤–é€å¹³å°æ”¯ä»˜æ–¹å¼ï¼Œå°†å®ƒä»¬åˆå¹¶ä¸ºDelivery Sales
                    delivery_methods_str = "', '".join(selected_delivery_methods)
                    delivery_case = f"WHEN p.payment_name IN ('{delivery_methods_str}') THEN 'Delivery Sales'"
                else:
                    # å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•å¤–é€å¹³å°æ”¯ä»˜æ–¹å¼ï¼Œä¸è¿›è¡Œåˆå¹¶
                    delivery_case = ""
            else:
                # å¦‚æœæ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œä½¿ç”¨é»˜è®¤åˆå¹¶é€»è¾‘
                delivery_case = "WHEN p.payment_name IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO') THEN 'Delivery Sales'"
            
            # æŸ¥è¯¢æ”¯ä»˜æ±‡æ€» - æŒ‰å•æ®å’Œæ”¯ä»˜æ–¹å¼åˆ†ç»„è®¡ç®—ï¼Œæ’é™¤WASTAGEï¼Œä¸æœˆ-é”€å”®æ•°æ®ä¿æŒä¸€è‡´
            # å•æ®æ•°è®¡ç®—ä¹Ÿè¦æ’é™¤WASTAGEï¼Œåªè®¡ç®—éWASTAGEäº§å“çš„å•æ®
            query = f"""
                SELECT 
                    p.store_name as é—¨å¸‚,
                    FORMAT(p.c_date, 'yyyy-MM') as æœˆä»½,
                    CASE 
                        {delivery_case}
                        ELSE p.payment_name
                    END as æ”¯ä»˜æ–¹å¼,
                    COUNT(DISTINCT CASE WHEN s.item_name != 'WASTAGE' THEN CONCAT(p.store_name, '-', p.sales_no, '-', p.c_date) END) as ä½¿ç”¨æ¬¡æ•°,
                    SUM(CASE WHEN s.item_name != 'WASTAGE' THEN 
                        {self.get_performance_calculation_sql()}
                    ELSE 0 END) as æ€»é‡‘é¢
                FROM {TABLE_PAYMENT} p
                INNER JOIN {TABLE_SALES} s ON p.store_name = s.store_name 
                    AND p.sales_no = s.sales_no 
                    AND p.c_date = s.c_date
                {join_clause}
                {where_clause}
                GROUP BY p.store_name, FORMAT(p.c_date, 'yyyy-MM'), 
                    CASE 
                        {delivery_case}
                        ELSE p.payment_name
                    END
                ORDER BY æœˆä»½ DESC, p.store_name, æ€»é‡‘é¢ DESC
            """
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
                # ä¸è¦åœ¨è¿™é‡Œå…³é—­cursorï¼Œå› ä¸ºåç»­æŸ¥è¯¢è¿˜éœ€è¦ä½¿ç”¨
            except Exception as e:
                cursor.close()
                print(f"æ”¯ä»˜åˆ†ææŸ¥è¯¢é”™è¯¯: {e}")
                print(f"æŸ¥è¯¢è¯­å¥: {query}")
                raise e
            
            # è·å–æ€»æ•°æ®ç”¨äºè®¡ç®—å æ¯” - ä¿®å¾©ï¼šæ‡‰è©²åŒ…å«æ”¯ä»˜æ–¹å¼ç¯©é¸æ¢ä»¶
            # é‡æ–°æ„å»ºWHEREæ¡ä»¶ï¼ŒåŒ…å«æ”¯ä»˜æ–¹å¼ç­›é€‰
            total_conditions = []
            if date_from:
                total_conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                total_conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                total_conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                total_conditions.append(f"({month_conditions})")
            
            # ä¿®å¾©ï¼šæ·»åŠ æ”¯ä»˜æ–¹å¼ç¯©é¸æ¢ä»¶åˆ°ç¸½è¨ˆæŸ¥è©¢
            if payment_filters and len(payment_filters) > 0:
                # æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†Delivery Salesç›¸å…³çš„æ”¯ä»˜æ–¹å¼
                delivery_methods = ['GRAB FOOD', 'FOOD PANDA', 'DELIVEROO']
                selected_delivery_methods = [method for method in payment_filters if method in delivery_methods]
                
                payment_conditions = []
                for method in payment_filters:
                    if method in delivery_methods:
                        # å¦‚æœæ˜¯å¤–é€å¹³å°çš„åŸå§‹åç§°ï¼Œç›´æ¥åŒ¹é…
                        payment_conditions.append(f"p.payment_name = '{method}'")
                    elif method == 'Delivery Sales':
                        # å¦‚æœé€‰æ‹©äº†Delivery Salesï¼Œéœ€è¦åŒ…å«æ‰€æœ‰å¤–é€å¹³å°çš„åŸå§‹åç§°
                        payment_conditions.append("p.payment_name IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO')")
                    else:
                        # å…¶ä»–æ”¯ä»˜æ–¹å¼ç›´æ¥åŒ¹é…
                        payment_conditions.append(f"p.payment_name = '{method}'")
                
                if payment_conditions:
                    total_conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name AND ({' OR '.join(payment_conditions)}))")
            
            # æ·»åŠ ç±»åˆ«ç­›é€‰æ¡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            total_join_clause = ""
            if category_filters and len(category_filters) > 0:
                total_join_clause = f"""
                    INNER JOIN item_master im ON s.item_name = im.item_name
                """
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                total_conditions.append(f"({category_conditions})")
            
            total_where_clause = ""
            if total_conditions:
                total_where_clause = " WHERE " + " AND ".join(total_conditions)
            
            total_query = f"""
                SELECT 
                    COUNT(DISTINCT CASE WHEN s.item_name != 'WASTAGE' THEN CONCAT(s.store_name, '-', s.sales_no, '-', s.c_date) END) as æ€»æ¬¡æ•°,
                    SUM(CASE WHEN s.item_name != 'WASTAGE' THEN 
                        {self.get_performance_calculation_sql()}
                        - ISNULL(CAST(c.cancel_amount as FLOAT), 0)
                    ELSE 0 END) as æ€»é‡‘é¢
                FROM {TABLE_SALES} s
                LEFT JOIN (
                    SELECT 
                        sales_no, 
                        store_name, 
                        item_name,
                        SUM({self._get_cancel_performance_calculation_sql()}) as cancel_amount
                    FROM {TABLE_CANCEL} WITH (NOLOCK)
                    GROUP BY sales_no, store_name, item_name
                ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                {total_join_clause}
                {total_where_clause}
            """
            
            try:
                cursor.execute(total_query)
                total_result = cursor.fetchone()
                total_count = int(total_result[0]) if total_result[0] else 0
                total_amount = float(total_result[1]) if total_result[1] else 0.0
                print(f"DEBUG: æ€»å•æ®æ•°æŸ¥è¯¢ç»“æœ: {total_count}")
                print(f"DEBUG: æ€»é‡‘é¢æŸ¥è¯¢ç»“æœ: {total_amount}")
                print(f"DEBUG: æ€»æŸ¥è¯¢SQL: {total_query}")
            except Exception as e:
                print(f"DEBUG: æ€»æŸ¥è¯¢é”™è¯¯: {e}")
                total_count = 0
                total_amount = 0.0
            
            # è·å–å„åº—æ€»æ•°æ® - éœ€è¦é‡æ–°æŸ¥è¯¢ä»¥ç¡®ä¿å•æ®æ•°ä¸é‡å¤è®¡ç®—
            store_totals = {}
            for row in results:
                store_name = str(row[0]) if row[0] else ''
                if store_name not in store_totals:
                    store_totals[store_name] = {'count': 0, 'amount': 0.0}
                # æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç›´æ¥ç´¯åŠ å•æ®æ•°ï¼Œå› ä¸ºåŒä¸€å¼ å•æ®å¯èƒ½å‡ºç°åœ¨å¤šä¸ªæ”¯ä»˜æ–¹å¼ä¸­
                # é‡‘é¢å¯ä»¥ç´¯åŠ ï¼Œä½†å•æ®æ•°éœ€è¦é‡æ–°æŸ¥è¯¢
                store_totals[store_name]['amount'] += float(row[4]) if row[4] else 0.0
            
            # é‡æ–°æŸ¥è¯¢å„åº—çš„å®é™…å•æ®æ•°ï¼ˆä¸é‡å¤è®¡ç®—ï¼‰- ç›´æ¥æŸ¥è¯¢é”€å”®è¡¨
            for store_name in store_totals.keys():
                # æ„å»ºé—¨åº—æŸ¥è¯¢æ¡ä»¶ï¼Œç›´æ¥æŸ¥è¯¢é”€å”®è¡¨
                # æ¸…ç†é—¨åº—åç§°ï¼Œç§»é™¤å¯èƒ½çš„é¢å¤–å­—ç¬¦
                clean_store_name = store_name.strip()
                store_conditions = [f"s.store_name = '{clean_store_name}'"]
                print(f"DEBUG: æŸ¥è¯¢é—¨åº—: '{clean_store_name}'")
                if date_from:
                    store_conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
                if date_to:
                    store_conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
                if month_filters and len(month_filters) > 0:
                    month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                    store_conditions.append(f"({month_conditions})")
                
                # ä¿®å¾©ï¼šæ·»åŠ æ”¯ä»˜æ–¹å¼ç¯©é¸æ¢ä»¶åˆ°é–€åº—æŸ¥è©¢
                if payment_filters and len(payment_filters) > 0:
                    delivery_methods = ['GRAB FOOD', 'FOOD PANDA', 'DELIVEROO']
                    payment_conditions = []
                    for method in payment_filters:
                        if method in delivery_methods:
                            payment_conditions.append(f"p.payment_name = '{method}'")
                        elif method == 'Delivery Sales':
                            payment_conditions.append("p.payment_name IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO')")
                        else:
                            payment_conditions.append(f"p.payment_name = '{method}'")
                    
                    if payment_conditions:
                        store_conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name AND ({' OR '.join(payment_conditions)}))")
                
                # æ·»åŠ ç±»åˆ«ç­›é€‰æ¡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                store_join_clause = ""
                if category_filters and len(category_filters) > 0:
                    store_join_clause = f"""
                        INNER JOIN item_master im ON s.item_name = im.item_name
                    """
                    category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                    store_conditions.append(f"({category_conditions})")
                
                store_where_clause = " WHERE " + " AND ".join(store_conditions)
                
                store_count_query = f"""
                    SELECT COUNT(DISTINCT CASE WHEN s.item_name != 'WASTAGE' THEN CONCAT(s.store_name, '-', s.sales_no, '-', s.c_date) END) as æ€»æ¬¡æ•°
                    FROM {TABLE_SALES} s
                    {store_join_clause}
                    {store_where_clause}
                """
                try:
                    cursor.execute(store_count_query)
                    store_count_result = cursor.fetchone()
                    store_totals[store_name]['count'] = int(store_count_result[0]) if store_count_result[0] else 0
                    print(f"DEBUG: é—¨åº— {store_name} å•æ®æ•°æŸ¥è¯¢ç»“æœ: {store_totals[store_name]['count']}")
                    print(f"DEBUG: é—¨åº—æŸ¥è¯¢SQL: {store_count_query}")
                except Exception as e:
                    print(f"DEBUG: é—¨åº—å•æ®æ•°æŸ¥è¯¢é”™è¯¯: {e}")
                    store_totals[store_name]['count'] = 0
            
            # è½¬æ¢æ•°æ®å¹¶è®¡ç®—å æ¯”ï¼ŒæŒ‰é—¨åº—å’Œæœˆä»½åˆ†ç»„
            payment_data = []
            store_month_data = {}  # ç”¨äºå­˜å‚¨æ¯ä¸ªé—¨åº—æ¯ä¸ªæœˆä»½çš„æ•°æ®
            
            for row in results:
                store_name = str(row[0]) if row[0] else ''
                month = str(row[1]) if row[1] else ''
                payment_method = str(row[2]) if row[2] else ''
                count = int(row[3]) if row[3] else 0
                amount = float(row[4]) if row[4] else 0.0
                print(f"DEBUG: å¤„ç†æ•°æ®è¡Œ - é—¨åº—: '{store_name}', æœˆä»½: '{month}', æ”¯ä»˜æ–¹å¼: '{payment_method}', å•æ®æ•°: {count}, é‡‘é¢: {amount}")
                
                # è®¡ç®—å æ¯”
                count_ratio = (count / total_count * 100) if total_count > 0 else 0
                amount_ratio = (amount / total_amount * 100) if total_amount > 0 else 0
                
                # è®¡ç®—è¯¥åº—å æ¯”
                store_total = store_totals.get(store_name, {'count': 0, 'amount': 0.0})
                store_count_ratio = (count / store_total['count'] * 100) if store_total['count'] > 0 else 0
                store_amount_ratio = (amount / store_total['amount'] * 100) if store_total['amount'] > 0 else 0
                
                # è®¡ç®—å¹³å‡é‡‘é¢ = æ€»é‡‘é¢ / ä½¿ç”¨æ¬¡æ•°
                avg_amount = round(amount / count, 2) if count > 0 else 0.0
                
                # å­˜å‚¨åˆ°åˆ†ç»„æ•°æ®ç»“æ„ä¸­
                if store_name not in store_month_data:
                    store_month_data[store_name] = {}
                if month not in store_month_data[store_name]:
                    store_month_data[store_name][month] = []
                
                store_month_data[store_name][month].append({
                    'é—¨å¸‚': store_name,
                    'æœˆä»½': month,
                    'æ”¯ä»˜æ–¹å¼': payment_method,
                    'ä½¿ç”¨æ¬¡æ•°': count,
                    'æ€»é‡‘é¢': amount,
                    'å¹³å‡é‡‘é¢': avg_amount,
                    'æ¬¡æ•°å æ¯”(%)': round(count_ratio, 2),
                    'é‡‘é¢å æ¯”(%)': round(amount_ratio, 2),
                    'è¯¥åº—æ¬¡æ•°å æ¯”(%)': round(store_count_ratio, 2),
                    'è¯¥åº—é‡‘é¢å æ¯”(%)': round(store_amount_ratio, 2)
                })
            
            # æŒ‰é—¨åº—å’Œæœˆä»½ç»„ç»‡æ•°æ®ï¼Œå¹¶åœ¨æ¯ä¸ªé—¨åº—çš„æ¯ä¸ªæœˆä»½åæ·»åŠ æ€»è®¡è¡Œ
            for store_name in sorted(store_month_data.keys()):
                for month in sorted(store_month_data[store_name].keys()):
                    month_data = store_month_data[store_name][month]
                    
                    # æ·»åŠ è¯¥é—¨åº—è¯¥æœˆä»½çš„æ‰€æœ‰æ”¯ä»˜æ–¹å¼æ•°æ®
                    for data in month_data:
                        payment_data.append(data)
                    
                    # è®¡ç®—è¯¥é—¨åº—è¯¥æœˆä»½çš„æ€»è®¡ - éœ€è¦é‡æ–°æŸ¥è¯¢ä»¥ç¡®ä¿å•æ®æ•°ä¸é‡å¤è®¡ç®—
                    month_total_amount = sum(item['æ€»é‡‘é¢'] for item in month_data)
                    
                    # é‡æ–°æŸ¥è¯¢è¯¥é—¨åº—è¯¥æœˆä»½çš„å®é™…å•æ®æ•°ï¼ˆä¸é‡å¤è®¡ç®—ï¼‰- ç›´æ¥æŸ¥è¯¢é”€å”®è¡¨
                    # æ¸…ç†é—¨åº—åç§°ï¼Œç§»é™¤å¯èƒ½çš„é¢å¤–å­—ç¬¦
                    clean_store_name = store_name.strip()
                    month_conditions = [
                        f"s.store_name = '{clean_store_name}'",
                        f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'"
                    ]
                    print(f"DEBUG: æŸ¥è¯¢é—¨åº—æœˆä»½: '{clean_store_name}' - '{month}'")
                    if date_from:
                        month_conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
                    if date_to:
                        month_conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
                    
                    # ä¿®å¾©ï¼šæ·»åŠ æ”¯ä»˜æ–¹å¼ç¯©é¸æ¢ä»¶åˆ°æœˆä»½æŸ¥è©¢
                    if payment_filters and len(payment_filters) > 0:
                        delivery_methods = ['GRAB FOOD', 'FOOD PANDA', 'DELIVEROO']
                        payment_conditions = []
                        for method in payment_filters:
                            if method in delivery_methods:
                                payment_conditions.append(f"p.payment_name = '{method}'")
                            elif method == 'Delivery Sales':
                                payment_conditions.append("p.payment_name IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO')")
                            else:
                                payment_conditions.append(f"p.payment_name = '{method}'")
                        
                        if payment_conditions:
                            month_conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name AND ({' OR '.join(payment_conditions)}))")
                    
                    # æ·»åŠ ç±»åˆ«ç­›é€‰æ¡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    month_join_clause = ""
                    if category_filters and len(category_filters) > 0:
                        month_join_clause = f"""
                            INNER JOIN item_master im ON s.item_name = im.item_name
                        """
                        category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                        month_conditions.append(f"({category_conditions})")
                    
                    month_where_clause = " WHERE " + " AND ".join(month_conditions)
                    
                    month_count_query = f"""
                        SELECT COUNT(DISTINCT CASE WHEN s.item_name != 'WASTAGE' THEN CONCAT(s.store_name, '-', s.sales_no, '-', s.c_date) END) as æ€»æ¬¡æ•°
                        FROM {TABLE_SALES} s
                        {month_join_clause}
                        {month_where_clause}
                    """
                    try:
                        cursor.execute(month_count_query)
                        month_count_result = cursor.fetchone()
                        month_total_count = int(month_count_result[0]) if month_count_result[0] else 0
                        print(f"DEBUG: é—¨åº— {store_name} æœˆä»½ {month} å•æ®æ•°æŸ¥è¯¢ç»“æœ: {month_total_count}")
                        print(f"DEBUG: æŸ¥è¯¢SQL: {month_count_query}")
                        
                        # æ·»åŠ è¯¦ç»†è°ƒè¯•ï¼šæ£€æŸ¥å„ä¸ªæ”¯ä»˜æ–¹å¼çš„å•æ®æ•°æ€»å’Œ
                        individual_counts = sum(item['ä½¿ç”¨æ¬¡æ•°'] for item in month_data)
                        print(f"DEBUG: å„æ”¯ä»˜æ–¹å¼å•æ®æ•°æ€»å’Œ: {individual_counts}")
                        print(f"DEBUG: å”¯ä¸€å•æ®æ•°: {month_total_count}")
                        print(f"DEBUG: å·®å¼‚: {individual_counts - month_total_count}")
                        
                    except Exception as e:
                        print(f"DEBUG: é—¨åº—æœˆä»½å•æ®æ•°æŸ¥è¯¢é”™è¯¯: {e}")
                        month_total_count = 0
                    
                    month_avg_amount = round(month_total_amount / month_total_count, 2) if month_total_count > 0 else 0.0
                    
                    # è®¡ç®—è¯¥é—¨åº—è¯¥æœˆä»½æ€»è®¡çš„å æ¯”
                    month_count_ratio = (month_total_count / total_count * 100) if total_count > 0 else 0
                    month_amount_ratio = (month_total_amount / total_amount * 100) if total_amount > 0 else 0
                    
                    # æ·»åŠ è¯¥é—¨åº—è¯¥æœˆä»½çš„æ€»è®¡è¡Œ
                    payment_data.append({
                        'é—¨å¸‚': f'ã€{store_name} {month} æ€»è®¡ã€‘',
                        'æœˆä»½': month,
                        'æ”¯ä»˜æ–¹å¼': '',
                        'ä½¿ç”¨æ¬¡æ•°': month_total_count,
                        'æ€»é‡‘é¢': month_total_amount,
                        'å¹³å‡é‡‘é¢': month_avg_amount,
                        'æ¬¡æ•°å æ¯”(%)': round(month_count_ratio, 2),
                        'é‡‘é¢å æ¯”(%)': round(month_amount_ratio, 2),
                        'è¯¥åº—æ¬¡æ•°å æ¯”(%)': 100.00,
                        'è¯¥åº—é‡‘é¢å æ¯”(%)': 100.00
                    })
                    print(f"DEBUG: æ·»åŠ é—¨åº—æœˆä»½æ€»è®¡è¡Œ - é—¨åº—: {store_name}, æœˆä»½: {month}, å•æ®æ•°: {month_total_count}, é‡‘é¢: {month_total_amount}")
            
            # æ·»åŠ å…¨æ€»è®¡ - ä½¿ç”¨å·²ç»è®¡ç®—å¥½çš„total_countå’Œtotal_amountï¼Œé¿å…é‡å¤è®¡ç®—
            if payment_data:
                grand_total_count = total_count  # ä½¿ç”¨å·²ç»æŸ¥è¯¢å¥½çš„æ€»å•æ®æ•°
                grand_total_amount = sum(item['æ€»é‡‘é¢'] for item in payment_data if not item['é—¨å¸‚'].startswith('ã€'))
                
                payment_data.append({
                    'é—¨å¸‚': 'ã€å…¨æ€»è®¡ã€‘',
                    'æœˆä»½': '',
                    'æ”¯ä»˜æ–¹å¼': '',
                    'ä½¿ç”¨æ¬¡æ•°': grand_total_count,
                    'æ€»é‡‘é¢': grand_total_amount,
                    'å¹³å‡é‡‘é¢': round(grand_total_amount / grand_total_count, 2) if grand_total_count > 0 else 0.0,
                    'æ¬¡æ•°å æ¯”(%)': 100.00,
                    'é‡‘é¢å æ¯”(%)': 100.00,
                    'è¯¥åº—æ¬¡æ•°å æ¯”(%)': 100.00,
                    'è¯¥åº—é‡‘é¢å æ¯”(%)': 100.00
                })
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_payment_cache'):
                self._payment_cache = {}
            self._payment_cache[cache_key] = payment_data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._payment_cache) > 10:
                # åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                oldest_key = next(iter(self._payment_cache))
                del self._payment_cache[oldest_key]
            
            # å…³é—­æ¸¸æ ‡
            cursor.close()
            return payment_data
            
        except Exception as e:
            print(f"è·å–æ”¯ä»˜æ±‡æ€»å¤±è´¥: {e}")
            if 'cursor' in locals():
                cursor.close()
            return []
    
    def _get_store_receipt_count(self, store_name, date_from=None, date_to=None, outlet_filters=None, month_filters=None, category_filters=None, payment_filters=None):
        """ç²å–æŒ‡å®šé–€åº—çš„å¯¦éš›å–®æ“šæ•¸ï¼ˆä¸é‡è¤‡è¨ˆç®—ï¼‰"""
        if not self.connection:
            return 0
        
        try:
            cursor = self.connection.cursor()
            
            # æ§‹å»ºWHEREæ¢ä»¶
            conditions = [f"s.store_name = '{store_name}'"]
            if date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ·»åŠ é¡åˆ¥ç¯©é¸æ¢ä»¶
            join_clause = ""
            if category_filters and len(category_filters) > 0:
                join_clause = "INNER JOIN item_master im ON s.item_name = im.item_name"
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # æ·»åŠ æ”¯ä»˜æ–¹å¼ç¯©é¸æ¢ä»¶
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name AND ({payment_conditions}))")
            
            where_clause = " WHERE " + " AND ".join(conditions)
            
            query = f"""
                SELECT COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°
                FROM {TABLE_SALES} s
                {join_clause}
                {where_clause}
                AND s.item_name != 'WASTAGE'
            """
            
            cursor.execute(query)
            result = cursor.fetchone()
            cursor.close()
            
            return int(result[0]) if result and result[0] else 0
            
        except Exception as e:
            print(f"ç²å–é–€åº—å–®æ“šæ•¸å¤±æ•—: {e}")
            return 0
        """è·å–æŠ˜æ‰£åˆ†æ"""
        if not self.connection:
            return []
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"discount_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_discount_cache') and cache_key in self._discount_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„æŠ˜æ‰£åˆ†ææ•°æ®")
            return self._discount_cache[cache_key]
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            if date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ·»åŠ æŠ˜æ‰£æ¡ä»¶
            conditions.append("s.disc_amt > 0")
            
            # å¦‚æœæœ‰ç±»åˆ«ç­›é€‰ï¼Œéœ€è¦JOIN item_masterè¡¨
            join_clause = ""
            if category_filters and len(category_filters) > 0:
                join_clause = f"""
                    INNER JOIN (
                        SELECT item_name, category_code
                        FROM item_master im1
                        WHERE im1.m_date = (
                            SELECT MAX(m_date) 
                            FROM item_master im2 
                            WHERE im2.item_name = im1.item_name
                        )
                    ) im ON s.item_name = im.item_name
                """
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰é€»è¾‘
            # å¦‚æœpayment_filtersä¸ºNoneï¼Œè¡¨ç¤ºæœªé€‰æ‹©ä»»ä½•æ”¯ä»˜æ–¹å¼ï¼Œä¸åº”ç”¨ç­›é€‰
            # å¦‚æœpayment_filtersä¸ºç©ºåˆ—è¡¨[]ï¼Œè¡¨ç¤ºé€‰æ‹©äº†å…¨éƒ¨æ”¯ä»˜æ–¹å¼ï¼Œä¸åº”ç”¨ç­›é€‰
            # å¦‚æœpayment_filtersæœ‰å€¼ï¼Œè¡¨ç¤ºé€‰æ‹©äº†ç‰¹å®šæ”¯ä»˜æ–¹å¼ï¼Œåº”ç”¨ç­›é€‰
            if payment_filters is not None and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{method}'" for method in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æŸ¥è¯¢æŠ˜æ‰£åˆ†æ - åŠ ä¸Šæœˆä»½ï¼Œæ”¯æŒç±»åˆ«ç­›é€‰
            query = f"""
                SELECT 
                    s.store_name as é—¨å¸‚,
                    FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                    ISNULL(s.disc_name, '') as æŠ˜æ‰£åç§°,
                    SUM(CAST(s.disc_amt as FLOAT)) as æŠ˜æ‰£é‡‘é¢,
                    COUNT(*) as æŠ˜æ‰£æ¬¡æ•°
                FROM {TABLE_SALES} s
                {join_clause}
                {where_clause}
                GROUP BY s.store_name, FORMAT(s.c_date, 'yyyy-MM'), ISNULL(s.disc_name, '')
                ORDER BY æœˆä»½ DESC, s.store_name, æŠ˜æ‰£é‡‘é¢ DESC
            """
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            # è·å–æ¯ä¸ªé—¨å¸‚æ¯ä¸ªæœˆçš„æ€»é‡‘é¢å’Œæ€»å•æ®æ•°ç”¨äºè®¡ç®—å æ¯”
            outlet_month_totals = {}
            
            # å…ˆè·å–æ‰€æœ‰æ¶‰åŠçš„é—¨å¸‚å’Œæœˆä»½ç»„åˆ
            cursor = self.connection.cursor()
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            # è·å–æ¯ä¸ªé—¨å¸‚æ¯ä¸ªæœˆçš„æ€»é‡‘é¢å’Œæ€»å•æ®æ•°
            for row in results:
                store_name = str(row[0]) if row[0] else ''
                month = str(row[1]) if row[1] else ''
                
                if store_name not in outlet_month_totals:
                    outlet_month_totals[store_name] = {}
                
                if month not in outlet_month_totals[store_name]:
                    # è·å–è¯¥é—¨å¸‚è¯¥æœˆçš„æ€»é‡‘é¢å’Œæ€»å•æ®æ•°
                    month_start = f"{month}-01"
                    if month == datetime.now().strftime('%Y-%m'):
                        # å¦‚æœæ˜¯å½“å‰æœˆä»½ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
                        month_end = datetime.now().strftime('%Y-%m-%d')
                    else:
                        # å…¶ä»–æœˆä»½ä½¿ç”¨æœˆæœ«
                        next_month = datetime.strptime(month + '-01', '%Y-%m-%d') + timedelta(days=32)
                        month_end = (next_month.replace(day=1) - timedelta(days=1)).strftime('%Y-%m-%d')
                    
                    total_query = f"""
                        SELECT 
                            SUM(CAST(sub_total as FLOAT)) as æ€»é‡‘é¢,
                            COUNT(DISTINCT CONCAT(store_name, '-', sales_no)) as æ€»å•æ®æ•°
                        FROM {TABLE_SALES}
                        WHERE store_name = '{store_name}'
                        AND c_date >= '{month_start}'
                        AND c_date <= '{month_end}'
                    """
                    
                    try:
                        cursor = self.connection.cursor()
                        cursor.execute(total_query)
                        total_result = cursor.fetchone()
                        cursor.close()
                        
                        if total_result:
                            outlet_month_totals[store_name][month] = {
                                'total_amount': float(total_result[0]) if total_result[0] else 0.0,
                                'total_receipts': int(total_result[1]) if total_result[1] else 0
                            }
                        else:
                            outlet_month_totals[store_name][month] = {'total_amount': 0.0, 'total_receipts': 0}
                    except:
                        outlet_month_totals[store_name][month] = {'total_amount': 0.0, 'total_receipts': 0}
            
            # è½¬æ¢æ•°æ®å¹¶è®¡ç®—å æ¯”
            discount_data = []
            total_disc_amt = 0.0
            total_disc_count = 0
            
            # å…ˆè®¡ç®—æ¯ä¸ªæŠ˜æ‰£åç§°çš„å…¨ç³»ç»Ÿæ€»ä½¿ç”¨æ¬¡æ•°
            discount_name_totals = {}
            for row in results:
                disc_name = str(row[2]) if row[2] else ''
                disc_count = int(row[4]) if row[4] else 0
                if disc_name not in discount_name_totals:
                    discount_name_totals[disc_name] = 0
                discount_name_totals[disc_name] += disc_count
            
            for row in results:
                store_name = str(row[0]) if row[0] else ''
                month = str(row[1]) if row[1] else ''
                disc_name = str(row[2]) if row[2] else ''
                disc_amt = float(row[3]) if row[3] else 0.0
                disc_count = int(row[4]) if row[4] else 0
                
                # ç´¯è®¡æ€»è®¡
                total_disc_amt += disc_amt
                total_disc_count += disc_count
                
                # è·å–è¯¥é—¨å¸‚è¯¥æœˆçš„æ€»é‡‘é¢å’Œæ€»å•æ®æ•°
                outlet_month_total = outlet_month_totals.get(store_name, {}).get(month, {'total_amount': 0.0, 'total_receipts': 0})
                store_month_amount = outlet_month_total['total_amount']
                store_month_receipts = outlet_month_total['total_receipts']
                
                # è®¡ç®—å æ¯”
                disc_ratio = (disc_amt / store_month_amount * 100) if store_month_amount > 0 else 0
                count_ratio = (disc_count / store_month_receipts * 100) if store_month_receipts > 0 else 0
                
                discount_data.append({
                    'é—¨å¸‚': store_name,
                    'æœˆä»½': month,
                    'æŠ˜æ‰£åç§°': disc_name,
                    'æŠ˜æ‰£é‡‘é¢': disc_amt,
                    'æŠ˜æ‰£å æ¯”(%)': round(disc_ratio, 2),
                    'æŠ˜æ‰£æ¬¡æ•°': disc_count,
                    'æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)': round(count_ratio, 2),
                    'å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸': discount_name_totals.get(disc_name, 0)
                })
            
            # æ·»åŠ è¯¦ç»†çš„æ€»è®¡ç»“æ„
            if discount_data:
                # æŒ‰é—¨å¸‚åˆ†ç»„è®¡ç®—å„åº—æ€»è®¡
                store_totals = {}
                month_totals = {}
                grand_total_disc_amt = 0.0
                grand_total_disc_count = 0
                
                for data in discount_data:
                    store = data['é—¨å¸‚']
                    month = data['æœˆä»½']
                    disc_amt = data['æŠ˜æ‰£é‡‘é¢']
                    disc_count = data['æŠ˜æ‰£æ¬¡æ•°']
                    
                    # å„åº—æ€»è®¡
                    if store not in store_totals:
                        store_totals[store] = {'disc_amt': 0.0, 'disc_count': 0}
                    store_totals[store]['disc_amt'] += disc_amt
                    store_totals[store]['disc_count'] += disc_count
                    
                    # æœˆä»½æ€»è®¡
                    if month not in month_totals:
                        month_totals[month] = {'disc_amt': 0.0, 'disc_count': 0}
                    month_totals[month]['disc_amt'] += disc_amt
                    month_totals[month]['disc_count'] += disc_count
                    
                    # å…¨æ€»è®¡
                    grand_total_disc_amt += disc_amt
                    grand_total_disc_count += disc_count
                
                # æ·»åŠ å„åº—æ€»è®¡
                for store, totals in store_totals.items():
                    discount_data.append({
                        'é—¨å¸‚': f'ã€{store} æ€»è®¡ã€‘',
                        'æœˆä»½': '',
                        'æŠ˜æ‰£åç§°': '',
                        'æŠ˜æ‰£é‡‘é¢': totals['disc_amt'],
                        'æŠ˜æ‰£å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'æŠ˜æ‰£æ¬¡æ•°': totals['disc_count'],
                        'æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸': 0  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸
                    })
                
                # æ·»åŠ æœˆä»½æ€»è®¡
                for month, totals in month_totals.items():
                    discount_data.append({
                        'é—¨å¸‚': f'ã€{month} æœˆä»½æ€»è®¡ã€‘',
                        'æœˆä»½': month,
                        'æŠ˜æ‰£åç§°': '',
                        'æŠ˜æ‰£é‡‘é¢': totals['disc_amt'],
                        'æŠ˜æ‰£å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'æŠ˜æ‰£æ¬¡æ•°': totals['disc_count'],
                        'æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸': 0  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸
                    })
                
                # æ·»åŠ å…¨æ€»è®¡
                discount_data.append({
                    'é—¨å¸‚': 'ã€å…¨æ€»è®¡ã€‘',
                    'æœˆä»½': '',
                    'æŠ˜æ‰£åç§°': '',
                    'æŠ˜æ‰£é‡‘é¢': grand_total_disc_amt,
                    'æŠ˜æ‰£å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                    'æŠ˜æ‰£æ¬¡æ•°': grand_total_disc_count,
                    'æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                    'æŠ˜æ‰£åç§°æ€»æ•°': 0  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºæŠ˜æ‰£åç§°æ€»æ•°
                })
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_discount_cache'):
                self._discount_cache = {}
            self._discount_cache[cache_key] = discount_data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._discount_cache) > 10:
                # åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                oldest_key = next(iter(self._discount_cache))
                del self._discount_cache[oldest_key]
            
            return discount_data
            
        except Exception as e:
            print(f"è·å–æŠ˜æ‰£åˆ†æå¤±è´¥: {e}")
            return []
    
    def get_monthly_summary_optimized(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, category_filters=None, payment_filters=None):
        """è·å–æœˆåº¦æ±‡æ€» - ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆåŒ…å«äº§å“å•æ®ä¸šç»©ï¼‰"""
        if not self.connection:
            return []
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"monthly_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{product_filters}_{month_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_monthly_cache') and cache_key in self._monthly_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„æœˆåº¦æ±‡æ€»æ•°æ®")
            return self._monthly_cache[cache_key]
        
        # æ£€æŸ¥æ—¥æœŸèŒƒå›´ï¼Œå¦‚æœèŒƒå›´å¤ªå¤§ç»™å‡ºè­¦å‘Š
        if date_from and date_to:
            from_date = datetime.strptime(date_from, '%Y-%m-%d')
            to_date = datetime.strptime(date_to, '%Y-%m-%d')
            days_diff = (to_date - from_date).days
            
            if days_diff > 30:
                print(f"âš ï¸ è­¦å‘Š: æŸ¥è¯¢æ—¥æœŸèŒƒå›´è¾ƒå¤§ ({days_diff} å¤©)ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´...")
            elif days_diff > 7:
                print(f"â„¹ï¸ æç¤º: æŸ¥è¯¢æ—¥æœŸèŒƒå›´ä¸º {days_diff} å¤©ï¼Œæ­£åœ¨å¤„ç†...")
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶ - ä¼˜åŒ–æ—¥æœŸç­›é€‰æ€§èƒ½
            conditions = []
            if date_from:
                # ä½¿ç”¨æ—¥æœŸèŒƒå›´è€Œä¸æ˜¯CASTï¼Œæé«˜ç´¢å¼•ä½¿ç”¨æ•ˆç‡
                conditions.append(f"s.c_date >= '{date_from} 00:00:00'")
            if date_to:
                conditions.append(f"s.c_date <= '{date_to} 23:59:59'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if product_filters and len(product_filters) > 0:
                product_conditions = " OR ".join([f"s.item_name = '{product}'" for product in product_filters])
                conditions.append(f"({product_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            # å¦‚æœæœ‰ç±»åˆ«ç­›é€‰ï¼Œæ·»åŠ ç±»åˆ«æ¡ä»¶
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # å¦‚æœæœ‰æ”¯ä»˜æ–¹å¼ç­›é€‰ï¼Œéœ€è¦JOINæ”¯ä»˜è¡¨
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{method}'" for method in payment_filters])
                # ä»…æŒ‰é—¨å¸‚+å•æ®å·åŒ¹é…ï¼Œé¿å…å› c_dateå¾®å·®å¯¼è‡´æ¼æ•°
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # ä¼˜åŒ–æŸ¥è¯¢ - ç®€åŒ–item_master JOINï¼Œæ·»åŠ æ›´å¤šç´¢å¼•æç¤º
            query = f"""
                SELECT 
                    s.store_name as é—¨å¸‚,
                    s.item_name as äº§å“,
                    FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                    ISNULL(im.category_code, '') as ç±»åˆ«,
                    SUM(CAST(s.qty as FLOAT)) as å–å‡ºé‡,
                    SUM(CAST(s.sub_total as FLOAT)) as é‡‘é¢,
                    SUM({self.get_performance_calculation_sql()}) as æ€»é‡‘é¢,
                    COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as å•æ®æ•°
                FROM {TABLE_SALES} s WITH (NOLOCK)
                LEFT JOIN item_master im WITH (NOLOCK) ON s.item_name = im.item_name
                {where_clause}
                GROUP BY s.store_name, s.item_name, FORMAT(s.c_date, 'yyyy-MM'), im.category_code
                ORDER BY æœˆä»½ DESC, s.store_name, s.item_name
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            # è®¾ç½®æŸ¥è¯¢è¶…æ—¶å’Œè¿›åº¦æç¤º
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            # è½¬æ¢æ•°æ®å¹¶è®¡ç®—å„åº—æ€»è®¡
            monthly_data = []
            store_totals = {}  # æŒ‰é—¨åº—å­˜å‚¨æ€»è®¡æ•°æ®
            
            for row in results:
                store_name = str(row[0]) if row[0] else ''
                product = str(row[1]) if row[1] else ''
                month = str(row[2]) if row[2] else ''
                category = str(row[3]) if row[3] else ''
                qty = float(row[4]) if row[4] else 0.0
                amount = float(row[5]) if row[5] else 0.0
                total_amount_item = float(row[6]) if row[6] else 0.0
                receipt_count = int(row[7]) if row[7] else 0
                
                # ç´¯è®¡å„åº—æ€»è®¡
                if store_name not in store_totals:
                    store_totals[store_name] = {
                        'qty': 0.0, 'amount': 0.0, 'total_amount': 0.0, 'receipt_count': 0
                    }
                store_totals[store_name]['qty'] += qty
                store_totals[store_name]['amount'] += amount
                store_totals[store_name]['total_amount'] += total_amount_item
                # ä¿®å¾©ï¼šä¸è¦ç´¯åŠ å–®æ“šæ•¸ï¼Œå› ç‚ºåŒä¸€å¼µå–®æ“šå¯èƒ½æœ‰å¤šå€‹ç”¢å“
                # store_totals[store_name]['receipt_count'] += receipt_count
                
                monthly_data.append({
                    'æœˆä»½': month,
                    'é—¨å¸‚': store_name,
                    'ç±»åˆ«': category,
                    'äº§å“': product,
                    'å–å‡ºé‡': qty,
                    'é‡‘é¢': amount,
                    'æ€»é‡‘é¢': total_amount_item,
                    'å•æ®æ•°': receipt_count,
                    'äº§å“å•æ®ä¸šç»©': 0.0,  # ç¨åè®¡ç®—
                    'é‡‘é¢å æ¯”(%)': 0.0,  # ç¨åè®¡ç®—
                    'å•æ®å æ¯”(%)': 0.0,   # ç¨åè®¡ç®—
                    'äº§å“å•æ®ä¸šç»©å æ¯”(%)': 0.0  # ç¨åè®¡ç®—
                })
            
            # è·å–äº§å“å•æ®ä¸šç»©æ•°æ® - ä½¿ç”¨å°ˆé–€çš„æœˆåº¦å‡½æ•¸
            receipt_performance_data = self.get_monthly_product_receipt_performance_from_db(
                date_from=date_from, 
                date_to=date_to, 
                outlet_filters=outlet_filters,
                product_filters=product_filters,
                database_source=self.current_database
            )
            
            # è®¡ç®—å„åº—å†…çš„å æ¯”
            for data in monthly_data:
                store_name = data['é—¨å¸‚']
                if store_name in store_totals:
                    store_total = store_totals[store_name]
                    # è®¡ç®—åŸºäºè¯¥é—¨åº—çš„å æ¯”
                    amount_ratio = (data['æ€»é‡‘é¢'] / store_total['total_amount'] * 100) if store_total['total_amount'] > 0 else 0
                    receipt_ratio = (data['å•æ®æ•°'] / store_total['receipt_count'] * 100) if store_total['receipt_count'] > 0 else 0
                    data['é‡‘é¢å æ¯”(%)'] = round(amount_ratio, 2)
                    data['å•æ®å æ¯”(%)'] = round(receipt_ratio, 2)
                    
                    # è®¡ç®—äº§å“å•æ®ä¸šç»© - ä½¿ç”¨çµ„åˆéµ (product_name, month, store_name)
                    month = data['æœˆä»½']
                    product_name = data['äº§å“']
                    key = f"{product_name}_{month}_{store_name}"
                    if key in receipt_performance_data:
                        data['äº§å“å•æ®ä¸šç»©'] = receipt_performance_data[key]['äº§å“å•æ®ä¸šç»©']
                        # è®¡ç®—äº§å“å•æ®ä¸šç»©å æ¯”
                        receipt_performance_ratio = (data['äº§å“å•æ®ä¸šç»©'] / store_total['total_amount'] * 100) if store_total['total_amount'] > 0 else 0
                        data['äº§å“å•æ®ä¸šç»©å æ¯”(%)'] = round(receipt_performance_ratio, 2)
                    else:
                        data['äº§å“å•æ®ä¸šç»©'] = 0.0
                        data['äº§å“å•æ®ä¸šç»©å æ¯”(%)'] = 0.0
            
            # æ·»åŠ è¯¦ç»†çš„æ€»è®¡ç»“æ„
            if monthly_data:
                # è®¡ç®—æœˆä»½æ€»è®¡å’Œå…¨æ€»è®¡
                month_totals = {}
                grand_total_qty = 0.0
                grand_total_amount = 0.0
                grand_total_total_amount = 0.0
                grand_total_receipt_count = 0
                
                for data in monthly_data:
                    month = data['æœˆä»½']
                    qty = data['å–å‡ºé‡']
                    amount = data['é‡‘é¢']
                    total_amount = data['æ€»é‡‘é¢']
                    receipt_count = data['å•æ®æ•°']
                    
                    # æœˆä»½æ€»è®¡
                    if month not in month_totals:
                        month_totals[month] = {
                            'qty': 0.0, 'amount': 0.0, 'total_amount': 0.0, 'receipt_count': 0
                        }
                    month_totals[month]['qty'] += qty
                    month_totals[month]['amount'] += amount
                    month_totals[month]['total_amount'] += total_amount
                    # ä¿®å¾©ï¼šä¸è¦ç´¯åŠ å–®æ“šæ•¸ï¼Œå› ç‚ºåŒä¸€å¼µå–®æ“šå¯èƒ½æœ‰å¤šå€‹ç”¢å“
                    # month_totals[month]['receipt_count'] += receipt_count
                    
                    # å…¨æ€»è®¡
                    grand_total_qty += qty
                    grand_total_amount += amount
                    grand_total_total_amount += total_amount
                    # ä¿®å¾©ï¼šä¸è¦ç´¯åŠ å–®æ“šæ•¸ï¼Œå› ç‚ºåŒä¸€å¼µå–®æ“šå¯èƒ½æœ‰å¤šå€‹ç”¢å“
                    # grand_total_receipt_count += receipt_count
                
                # æ·»åŠ å„åº—æ€»è®¡ï¼ˆä½¿ç”¨å·²æœ‰çš„store_totalsï¼‰
                for store, totals in store_totals.items():
                    monthly_data.append({
                        'æœˆä»½': f'ã€{store} æ€»è®¡ã€‘',
                        'é—¨å¸‚': store,
                        'ç±»åˆ«': '',
                        'äº§å“': '',
                        'å–å‡ºé‡': totals['qty'],
                        'é‡‘é¢': totals['amount'],
                        'æ€»é‡‘é¢': totals['total_amount'],
                        'å•æ®æ•°': totals['receipt_count'],
                        'äº§å“å•æ®ä¸šç»©': 0.0,  # æ€»è®¡è¡Œä¸æ˜¾ç¤º
                        'é‡‘é¢å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'å•æ®å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'äº§å“å•æ®ä¸šç»©å æ¯”(%)': 0.0  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                    })
                
                # æ·»åŠ æœˆä»½æ€»è®¡
                for month, totals in month_totals.items():
                    monthly_data.append({
                        'æœˆä»½': f'ã€{month} æœˆä»½æ€»è®¡ã€‘',
                        'é—¨å¸‚': '',
                        'ç±»åˆ«': '',
                        'äº§å“': '',
                        'å–å‡ºé‡': totals['qty'],
                        'é‡‘é¢': totals['amount'],
                        'æ€»é‡‘é¢': totals['total_amount'],
                        'å•æ®æ•°': totals['receipt_count'],
                        'äº§å“å•æ®ä¸šç»©': 0.0,  # æ€»è®¡è¡Œä¸æ˜¾ç¤º
                        'é‡‘é¢å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'å•æ®å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'äº§å“å•æ®ä¸šç»©å æ¯”(%)': 0.0  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                    })
                
                # æ·»åŠ å…¨æ€»è®¡
                monthly_data.append({
                    'æœˆä»½': 'ã€å…¨æ€»è®¡ã€‘',
                    'é—¨å¸‚': '',
                    'ç±»åˆ«': '',
                    'äº§å“': '',
                    'å–å‡ºé‡': grand_total_qty,
                    'é‡‘é¢': grand_total_amount,
                    'æ€»é‡‘é¢': grand_total_total_amount,
                    'å•æ®æ•°': grand_total_receipt_count,
                    'äº§å“å•æ®ä¸šç»©': 0.0,  # æ€»è®¡è¡Œä¸æ˜¾ç¤º
                    'é‡‘é¢å æ¯”(%)': 0.00,
                    'å•æ®å æ¯”(%)': 0.00,
                    'äº§å“å•æ®ä¸šç»©å æ¯”(%)': 0.0
                })
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_monthly_cache'):
                self._monthly_cache = {}
            self._monthly_cache[cache_key] = monthly_data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._monthly_cache) > 10:
                # åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                oldest_key = next(iter(self._monthly_cache))
                del self._monthly_cache[oldest_key]
            
            return monthly_data
            
        except Exception as e:
            print(f"è·å–æœˆåº¦æ±‡æ€»å¤±è´¥: {e}")
            return []

    def get_monthly_summary(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, category_filters=None, payment_filters=None):
        """è·å–æœˆåº¦æ±‡æ€»"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            if date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if product_filters and len(product_filters) > 0:
                product_conditions = " OR ".join([f"s.item_name = '{product}'" for product in product_filters])
                conditions.append(f"({product_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            # å¦‚æœæœ‰ç±»åˆ«ç­›é€‰ï¼Œæ·»åŠ ç±»åˆ«æ¡ä»¶
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # å¦‚æœæœ‰æ”¯ä»˜æ–¹å¼ç­›é€‰ï¼Œéœ€è¦JOINæ”¯ä»˜è¡¨
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{method}'" for method in payment_filters])
                # ä»…æŒ‰é—¨å¸‚+å•æ®å·åŒ¹é…ï¼Œé¿å…å› c_dateå¾®å·®å¯¼è‡´æ¼æ•°
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æŸ¥è¯¢æœˆåº¦æ±‡æ€» - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œæ·»åŠ ç´¢å¼•æç¤ºï¼ˆä¿æŒåŸæœ‰æ­£ç¡®é€»è¾‘ï¼‰
            query = f"""
                SELECT 
                    s.store_name as é—¨å¸‚,
                    s.item_name as äº§å“,
                    FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                    ISNULL(im.category_code, '') as ç±»åˆ«,
                    SUM(CAST(s.qty as FLOAT)) as å–å‡ºé‡,
                    SUM(CAST(s.sub_total as FLOAT)) as é‡‘é¢,
                    SUM({self.get_performance_calculation_sql()}) as æ€»é‡‘é¢,
                    COUNT(*) as å•æ®æ•°
                FROM {TABLE_SALES} s WITH (NOLOCK)
                LEFT JOIN (
                    SELECT item_name, category_code
                    FROM item_master im1 WITH (NOLOCK)
                    WHERE im1.m_date = (
                        SELECT MAX(m_date) 
                        FROM item_master im2 WITH (NOLOCK)
                        WHERE im2.item_name = im1.item_name
                    )
                ) im ON s.item_name = im.item_name
                {where_clause}
                GROUP BY s.store_name, s.item_name, FORMAT(s.c_date, 'yyyy-MM'), im.category_code
                ORDER BY æœˆä»½ DESC, s.store_name, s.item_name
                OPTION (RECOMPILE)
            """
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            # è½¬æ¢æ•°æ®å¹¶è®¡ç®—å„åº—æ€»è®¡
            monthly_data = []
            store_totals = {}  # æŒ‰é—¨åº—å­˜å‚¨æ€»è®¡æ•°æ®
            
            for row in results:
                store_name = str(row[0]) if row[0] else ''
                product = str(row[1]) if row[1] else ''
                month = str(row[2]) if row[2] else ''
                category = str(row[3]) if row[3] else ''
                qty = float(row[4]) if row[4] else 0.0
                amount = float(row[5]) if row[5] else 0.0
                total_amount_item = float(row[6]) if row[6] else 0.0
                receipt_count = int(row[7]) if row[7] else 0
                
                # ç´¯è®¡å„åº—æ€»è®¡
                if store_name not in store_totals:
                    store_totals[store_name] = {
                        'qty': 0.0, 'amount': 0.0, 'total_amount': 0.0, 'receipt_count': 0
                    }
                store_totals[store_name]['qty'] += qty
                store_totals[store_name]['amount'] += amount
                store_totals[store_name]['total_amount'] += total_amount_item
                # ä¿®å¾©ï¼šä¸è¦ç´¯åŠ å–®æ“šæ•¸ï¼Œå› ç‚ºåŒä¸€å¼µå–®æ“šå¯èƒ½æœ‰å¤šå€‹ç”¢å“
                # store_totals[store_name]['receipt_count'] += receipt_count
                
                monthly_data.append({
                    'æœˆä»½': month,
                    'é—¨å¸‚': store_name,
                    'ç±»åˆ«': category,
                    'äº§å“': product,
                    'å–å‡ºé‡': qty,
                    'é‡‘é¢': amount,
                    'æ€»é‡‘é¢': total_amount_item,
                    'å•æ®æ•°': receipt_count,
                    'äº§å“å•æ®ä¸šç»©': 0.0,  # ç¨åè®¡ç®—
                    'é‡‘é¢å æ¯”(%)': 0.0,  # ç¨åè®¡ç®—
                    'å•æ®å æ¯”(%)': 0.0,   # ç¨åè®¡ç®—
                    'äº§å“å•æ®ä¸šç»©å æ¯”(%)': 0.0  # ç¨åè®¡ç®—
                })
            
            # è·å–äº§å“å•æ®ä¸šç»©æ•°æ® - ä½¿ç”¨å°ˆé–€çš„æœˆåº¦å‡½æ•¸
            receipt_performance_data = self.get_monthly_product_receipt_performance_from_db(
                date_from=date_from, 
                date_to=date_to, 
                outlet_filters=outlet_filters,
                product_filters=product_filters,
                database_source=self.current_database
            )
            
            # è®¡ç®—å„åº—å†…çš„å æ¯”
            for data in monthly_data:
                store_name = data['é—¨å¸‚']
                if store_name in store_totals:
                    store_total = store_totals[store_name]
                    # è®¡ç®—åŸºäºè¯¥é—¨åº—çš„å æ¯”
                    amount_ratio = (data['æ€»é‡‘é¢'] / store_total['total_amount'] * 100) if store_total['total_amount'] > 0 else 0
                    receipt_ratio = (data['å•æ®æ•°'] / store_total['receipt_count'] * 100) if store_total['receipt_count'] > 0 else 0
                    data['é‡‘é¢å æ¯”(%)'] = round(amount_ratio, 2)
                    data['å•æ®å æ¯”(%)'] = round(receipt_ratio, 2)
                    
                    # è®¡ç®—äº§å“å•æ®ä¸šç»© - ä½¿ç”¨çµ„åˆéµ (product_name, month, store_name)
                    month = data['æœˆä»½']
                    product_name = data['äº§å“']
                    key = f"{product_name}_{month}_{store_name}"
                    if key in receipt_performance_data:
                        data['äº§å“å•æ®ä¸šç»©'] = receipt_performance_data[key]['äº§å“å•æ®ä¸šç»©']
                        # è®¡ç®—äº§å“å•æ®ä¸šç»©å æ¯”
                        receipt_performance_ratio = (data['äº§å“å•æ®ä¸šç»©'] / store_total['total_amount'] * 100) if store_total['total_amount'] > 0 else 0
                        data['äº§å“å•æ®ä¸šç»©å æ¯”(%)'] = round(receipt_performance_ratio, 2)
                    else:
                        data['äº§å“å•æ®ä¸šç»©'] = 0.0
                        data['äº§å“å•æ®ä¸šç»©å æ¯”(%)'] = 0.0
            
            # æ·»åŠ è¯¦ç»†çš„æ€»è®¡ç»“æ„
            if monthly_data:
                # è®¡ç®—æœˆä»½æ€»è®¡å’Œå…¨æ€»è®¡
                month_totals = {}
                grand_total_qty = 0.0
                grand_total_amount = 0.0
                grand_total_total_amount = 0.0
                grand_total_receipt_count = 0
                
                for data in monthly_data:
                    month = data['æœˆä»½']
                    qty = data['å–å‡ºé‡']
                    amount = data['é‡‘é¢']
                    total_amount = data['æ€»é‡‘é¢']
                    receipt_count = data['å•æ®æ•°']
                    
                    # æœˆä»½æ€»è®¡
                    if month not in month_totals:
                        month_totals[month] = {
                            'qty': 0.0, 'amount': 0.0, 'total_amount': 0.0, 'receipt_count': 0
                        }
                    month_totals[month]['qty'] += qty
                    month_totals[month]['amount'] += amount
                    month_totals[month]['total_amount'] += total_amount
                    # ä¿®å¾©ï¼šä¸è¦ç´¯åŠ å–®æ“šæ•¸ï¼Œå› ç‚ºåŒä¸€å¼µå–®æ“šå¯èƒ½æœ‰å¤šå€‹ç”¢å“
                    # month_totals[month]['receipt_count'] += receipt_count
                    
                    # å…¨æ€»è®¡
                    grand_total_qty += qty
                    grand_total_amount += amount
                    grand_total_total_amount += total_amount
                    # ä¿®å¾©ï¼šä¸è¦ç´¯åŠ å–®æ“šæ•¸ï¼Œå› ç‚ºåŒä¸€å¼µå–®æ“šå¯èƒ½æœ‰å¤šå€‹ç”¢å“
                    # grand_total_receipt_count += receipt_count
                
                # æ·»åŠ å„åº—æ€»è®¡ï¼ˆä½¿ç”¨å·²æœ‰çš„store_totalsï¼‰
                for store, totals in store_totals.items():
                    monthly_data.append({
                        'æœˆä»½': f'ã€{store} æ€»è®¡ã€‘',
                        'é—¨å¸‚': store,
                        'ç±»åˆ«': '',
                        'äº§å“': '',
                        'å–å‡ºé‡': totals['qty'],
                        'é‡‘é¢': totals['amount'],
                        'æ€»é‡‘é¢': totals['total_amount'],
                        'å•æ®æ•°': totals['receipt_count'],
                        'é‡‘é¢å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'å•æ®å æ¯”(%)': 0.00  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                    })
                
                # æ·»åŠ æœˆä»½æ€»è®¡
                for month, totals in month_totals.items():
                    monthly_data.append({
                        'æœˆä»½': f'ã€{month} æœˆä»½æ€»è®¡ã€‘',
                    'é—¨å¸‚': '',
                    'ç±»åˆ«': '',
                    'äº§å“': '',
                        'å–å‡ºé‡': totals['qty'],
                        'é‡‘é¢': totals['amount'],
                        'æ€»é‡‘é¢': totals['total_amount'],
                        'å•æ®æ•°': totals['receipt_count'],
                        'é‡‘é¢å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                        'å•æ®å æ¯”(%)': 0.00  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                    })
                
                # æ·»åŠ å…¨æ€»è®¡
                monthly_data.append({
                    'æœˆä»½': 'ã€å…¨æ€»è®¡ã€‘',
                    'é—¨å¸‚': '',
                    'ç±»åˆ«': '',
                    'äº§å“': '',
                    'å–å‡ºé‡': grand_total_qty,
                    'é‡‘é¢': grand_total_amount,
                    'æ€»é‡‘é¢': grand_total_total_amount,
                    'å•æ®æ•°': grand_total_receipt_count,
                    'é‡‘é¢å æ¯”(%)': 0.00,  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                    'å•æ®å æ¯”(%)': 0.00  # æ€»è®¡è¡Œä¸æ˜¾ç¤ºå æ¯”
                })
            
            return monthly_data
            
        except Exception as e:
            print(f"è·å–æœˆåº¦æ±‡æ€»å¤±è´¥: {e}")
            return []
    
    def get_sales_analysis(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–Salesåˆ†æ - æŒ‰æ—¥æœŸå’Œé—¨å¸‚æ±‡æ€»"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            
            if date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                conditions.append(f"({payment_conditions})")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æŸ¥è¯¢Salesåˆ†æ
            query = f"""
                SELECT 
                    FORMAT(s.c_date, 'yyyy-MM-dd') as æ—¥æœŸ,
                    s.store_name as é—¨å¸‚,
                    SUM({self.get_performance_calculation_sql()}
                        - ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                    COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as å•æ®æ•°
                FROM pos_sales_dtls s
                LEFT JOIN pos_sales_payment_dtls p ON s.sales_no = p.sales_no AND s.store_name = p.store_name AND s.c_date = p.c_date
                {where_clause}
                AND s.item_name != 'WASTAGE'
                GROUP BY FORMAT(s.c_date, 'yyyy-MM-dd'), s.store_name
                ORDER BY FORMAT(s.c_date, 'yyyy-MM-dd'), s.store_name
            """
            
            cursor.execute(query)
            results = cursor.fetchall()
            
            sales_data = []
            for row in results:
                sales_data.append({
                    'æ—¥æœŸ': row[0],
                    'é—¨å¸‚': row[1],
                    'æ€»ä¸šç»©': float(row[2]) if row[2] else 0.0,
                    'å•æ®æ•°': int(row[3]) if row[3] else 0
                })
            
            return sales_data
            
        except Exception as e:
            print(f"è·å–Salesåˆ†æå¤±è´¥: {e}")
            return []
    
    def get_tc_analysis(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–TCåˆ†æ - é—¨å¸‚ä¸šç»©å¯¹æ¯”åˆ†æ"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            
            if date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                conditions.append(f"({payment_conditions})")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æŸ¥è¯¢TCåˆ†æ
            query = f"""
                SELECT 
                    s.store_name as é—¨å¸‚,
                    SUM({self.get_performance_calculation_sql()}
                        - ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                    COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                    SUM(CASE WHEN s.item_name IN ({','.join([f"'{product}'" for product in product_filters]) if product_filters and len(product_filters) > 0 else "''"}) THEN CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - 
                        CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END
                        - ISNULL(CAST(c.cancel_amount as FLOAT), 0) ELSE 0 END) as äº§å“ä¸šç»©,
                    COUNT(DISTINCT CASE WHEN s.item_name IN ({','.join([f"'{product}'" for product in product_filters]) if product_filters and len(product_filters) > 0 else "''"}) THEN s.sales_no ELSE NULL END) as äº§å“å•æ®æ•°
                FROM pos_sales_dtls s
                LEFT JOIN pos_sales_payment_dtls p ON s.sales_no = p.sales_no AND s.store_name = p.store_name AND s.c_date = p.c_date
                {where_clause}
                AND s.item_name != 'WASTAGE'
                GROUP BY s.store_name
                ORDER BY s.store_name
            """
            
            cursor.execute(query)
            results = cursor.fetchall()
            
            tc_data = []
            for row in results:
                total_amount = float(row[1]) if row[1] else 0.0
                total_receipts = int(row[2]) if row[2] else 0
                product_amount = float(row[3]) if row[3] else 0.0
                product_receipts = int(row[4]) if row[4] else 0
                
                # è®¡ç®—å æ¯”
                amount_percentage = (product_amount / total_amount * 100) if total_amount > 0 else 0.0
                receipt_percentage = (product_receipts / total_receipts * 100) if total_receipts > 0 else 0.0
                
                tc_data.append({
                    'é—¨å¸‚': row[0],
                    'æ€»ä¸šç»©': total_amount,
                    'æ€»å•æ®æ•°': total_receipts,
                    'äº§å“ä¸šç»©': product_amount,
                    'äº§å“å•æ®æ•°': product_receipts,
                    'ä¸šç»©å æ¯”(%)': amount_percentage,
                    'å•æ®æ•°å æ¯”(%)': receipt_percentage
                })
            
            return tc_data
            
        except Exception as e:
            print(f"è·å–TCåˆ†æå¤±è´¥: {e}")
            return []
    
    def get_sales_tc_analysis(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–é”€å”®TCåˆ†æ - ä¼˜åŒ–ç‰ˆæœ¬"""
        print(f"get_sales_tc_analysis è¢«è°ƒç”¨ï¼Œå‚æ•°: date_from={date_from}, date_to={date_to}")
        print(f"æ•°æ®åº“è¿æ¥çŠ¶æ€: {self.connection is not None}")
        if not self.connection:
            print("âŒ æ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•æ‰§è¡Œæ—¥-äº§å“åˆ†ææŸ¥è¯¢")
            return []
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"sales_tc_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{product_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_sales_tc_cache') and cache_key in self._sales_tc_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„é”€å”®TCåˆ†ææ•°æ®")
            return self._sales_tc_cache[cache_key]
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºåŸºç¡€WHEREæ¡ä»¶
            conditions = []
            
            if date_from and date_to:
                conditions.append(f"s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            if weekday_filters and len(weekday_filters) > 0:
                print(f"åº”ç”¨æ˜ŸæœŸç­›é€‰: {weekday_filters}")
                # ä½¿ç”¨DATEPARTæ¥è·å–æ˜ŸæœŸå‡ ï¼Œ1=Sunday, 2=Monday, ..., 7=Saturday
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
                    print(f"æ˜ŸæœŸç­›é€‰SQLæ¡ä»¶: {weekday_conditions}")
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            
            # æ„å»ºé¢å¤–çš„WHEREæ¡ä»¶ï¼ˆä¸åŒ…å«æ—¥æœŸæ¡ä»¶ï¼Œå› ä¸ºæ—¥æœŸæ¡ä»¶ä¼šå•ç‹¬æ·»åŠ ï¼‰
            additional_conditions = []
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                additional_conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'" for month in month_filters])
                additional_conditions.append(f"({month_conditions})")
            if weekday_filters and len(weekday_filters) > 0:
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    additional_conditions.append(f"({weekday_conditions})")
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                additional_conditions.append(f"({category_conditions})")
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                additional_conditions.append(f"EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            additional_where = ""
            if additional_conditions:
                additional_where = " AND " + " AND ".join(additional_conditions)
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æ„å»ºäº§å“ç­›é€‰æ¡ä»¶
            product_condition = ""
            if product_filters and len(product_filters) > 0:
                product_list = "','".join(product_filters)
                product_condition = f"AND s.item_name IN ('{product_list}')"
            # å¦‚æœæ²¡æœ‰é€‰æ‹©äº§å“ï¼Œä¸æ·»åŠ é¢å¤–çš„ç­›é€‰æ¡ä»¶ï¼Œè®©æ‰€æœ‰äº§å“éƒ½åŒ…å«åœ¨äº§å“ä¸šç»©ä¸­
            
            # ä¼˜åŒ–çš„æŸ¥è¯¢ - ä½¿ç”¨CTEæé«˜æ€§èƒ½
            query = f"""
                WITH DailyTotals AS (
                    SELECT 
                        FORMAT(s.c_date, 'yyyy-MM-dd') as æ—¥æœŸ,
                        s.store_name as é—¨å¸‚,
                        SUM({self.get_performance_calculation_sql()} - 
                            ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                        SUM(CAST(ISNULL(s.qty, 0) as FLOAT) - ISNULL(CAST(c.cancel_qty as FLOAT), 0)) as æ€»é”€å”®æ•°é‡
                    FROM pos_sales_dtls s
                    LEFT JOIN (
                        SELECT 
                            sales_no, 
                            store_name, 
                            item_name,
                            SUM({self._get_cancel_performance_calculation_sql()}) as cancel_amount,
                            SUM(CAST(qty as FLOAT)) as cancel_qty
                        FROM pos_cancel_sales_item_dtls WITH (NOLOCK)
                        GROUP BY sales_no, store_name, item_name
                    ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                    WHERE s.item_name != 'WASTAGE'
                    {f"AND s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'" if date_from and date_to else ""}
                    {f"AND ({' OR '.join([f's.store_name = \'{outlet}\'' for outlet in outlet_filters])})" if outlet_filters and len(outlet_filters) > 0 else ""}
                    {additional_where if 'additional_where' in locals() else ""}
                    GROUP BY FORMAT(s.c_date, 'yyyy-MM-dd'), s.store_name
                ),
                ProductTotals AS (
                    SELECT 
                        FORMAT(s.c_date, 'yyyy-MM-dd') as æ—¥æœŸ,
                        s.store_name as é—¨å¸‚,
                        SUM({self.get_performance_calculation_sql()} - 
                            ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as äº§å“ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as äº§å“å•æ®æ•°,
                        SUM(CAST(ISNULL(s.qty, 0) as FLOAT) - ISNULL(CAST(c.cancel_qty as FLOAT), 0)) as äº§å“é”€å”®æ•°é‡
                    FROM pos_sales_dtls s
                    LEFT JOIN (
                        SELECT 
                            sales_no, 
                            store_name, 
                            item_name,
                            SUM({self._get_cancel_performance_calculation_sql()}) as cancel_amount,
                            SUM(CAST(qty as FLOAT)) as cancel_qty
                        FROM pos_cancel_sales_item_dtls WITH (NOLOCK)
                        GROUP BY sales_no, store_name, item_name
                    ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                    WHERE s.item_name != 'WASTAGE'
                    {f"AND s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'" if date_from and date_to else ""}
                    {additional_where if 'additional_where' in locals() else ""}
                    {product_condition}
                    GROUP BY FORMAT(s.c_date, 'yyyy-MM-dd'), s.store_name
                ),
                ProductReceiptPerformance AS (
                    SELECT
                        FORMAT(target_item.c_date, 'yyyy-MM-dd') as æ—¥æœŸ,
                        target_item.store_name as é—¨å¸‚,
                        SUM(receipt_totals.receipt_total) as äº§å“å•æ®ä¸šç»©
                    FROM (
                        -- è·å–ç›®æ ‡äº§å“çš„å•æ®ä¿¡æ¯
                        SELECT DISTINCT s.c_date, s.store_name, s.sales_no
                        FROM pos_sales_dtls s WITH (NOLOCK)
                        WHERE s.item_name != 'WASTAGE'
                        {f"AND s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'" if date_from and date_to else ""}
                        {f"AND ({' OR '.join([f's.store_name = \'{outlet}\'' for outlet in outlet_filters])})" if outlet_filters and len(outlet_filters) > 0 else ""}
                        {additional_where if 'additional_where' in locals() else ""}
                        {product_condition}
                    ) target_item
                    INNER JOIN (
                        -- è®¡ç®—æ¯ä¸ªå•æ®çš„æ€»é‡‘é¢
                        SELECT 
                            s.c_date,
                            s.store_name,
                            s.sales_no,
                            SUM(CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END) as receipt_total
                        FROM pos_sales_dtls s WITH (NOLOCK)
                        WHERE s.item_name != 'WASTAGE'
                        {f"AND s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'" if date_from and date_to else ""}
                        {f"AND ({' OR '.join([f's.store_name = \'{outlet}\'' for outlet in outlet_filters])})" if outlet_filters and len(outlet_filters) > 0 else ""}
                        GROUP BY s.c_date, s.store_name, s.sales_no
                    ) receipt_totals ON target_item.sales_no = receipt_totals.sales_no AND target_item.store_name = receipt_totals.store_name AND target_item.c_date = receipt_totals.c_date
                    GROUP BY FORMAT(target_item.c_date, 'yyyy-MM-dd'), target_item.store_name
                )
                SELECT 
                    dt.æ—¥æœŸ,
                    dt.é—¨å¸‚,
                    dt.æ€»ä¸šç»©,
                    dt.æ€»å•æ®æ•°,
                    dt.æ€»é”€å”®æ•°é‡,
                    ISNULL(pt.äº§å“ä¸šç»©, 0) as äº§å“ä¸šç»©,
                    ISNULL(pt.äº§å“å•æ®æ•°, 0) as äº§å“å•æ®æ•°,
                    ISNULL(pt.äº§å“é”€å”®æ•°é‡, 0) as äº§å“é”€å”®æ•°é‡,
                    ISNULL(prp.äº§å“å•æ®ä¸šç»©, 0) as äº§å“å•æ®ä¸šç»©
                FROM DailyTotals dt
                LEFT JOIN ProductTotals pt ON dt.æ—¥æœŸ = pt.æ—¥æœŸ AND dt.é—¨å¸‚ = pt.é—¨å¸‚
                LEFT JOIN ProductReceiptPerformance prp ON dt.æ—¥æœŸ = prp.æ—¥æœŸ AND dt.é—¨å¸‚ = prp.é—¨å¸‚
                ORDER BY dt.æ—¥æœŸ, dt.é—¨å¸‚
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            print(f"å¼€å§‹æ‰§è¡Œé”€å”®TCåˆ†ææŸ¥è¯¢...")
            print(f"æŸ¥è¯¢å‚æ•°: date_from={date_from}, date_to={date_to}")
            print(f"ç­›é€‰æ¡ä»¶: outlet_filters={outlet_filters}, product_filters={product_filters}, month_filters={month_filters}, weekday_filters={weekday_filters}, category_filters={category_filters}, payment_filters={payment_filters}")
            print(f"SQLæŸ¥è¯¢: {query}")
            start_time = time.time()
            
            # æ·»åŠ æ•°æ®åº“è¿æ¥çŠ¶æ€æ£€æŸ¥
            if not self.connection:
                print("âŒ æ•°æ®åº“è¿æ¥ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡Œæ—¥-äº§å“åˆ†ææŸ¥è¯¢")
                return []
            
            try:
                # å…ˆæ‰§è¡Œç®€å•æµ‹è¯•æŸ¥è¯¢
                test_query = f"SELECT COUNT(*) FROM pos_sales_dtls WHERE CAST(c_date as DATE) = '{date_from}'"
                print(f"ğŸ” æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢: {test_query}")
                cursor.execute(test_query)
                test_result = cursor.fetchone()
                print(f"ğŸ” æµ‹è¯•æŸ¥è¯¢ç»“æœ - {date_from} çš„è®°å½•æ•°: {test_result[0] if test_result else 0}")
                
                if test_result and test_result[0] == 0:
                    print(f"âŒ {date_from} æ²¡æœ‰é”€å”®æ•°æ®")
                    return []
                
                cursor.execute(query)
                results = cursor.fetchall()
                
                end_time = time.time()
                print(f"é”€å”®TCåˆ†ææŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶: {end_time - start_time:.2f} ç§’")
                print(f"é”€å”®TCåˆ†ææŸ¥è¯¢ç»“æœ: {len(results)} æ¡è®°å½•")
                if results:
                    print(f"ç¬¬ä¸€æ¡è®°å½•: {results[0]}")
                else:
                    print(f"æŸ¥è¯¢è¿”å›0æ¡è®°å½•ï¼Œè¯·æ£€æŸ¥ç­›é€‰æ¡ä»¶å’Œæ•°æ®åº“ä¸­çš„æ•°æ®")
            except Exception as query_error:
                print(f"âŒ æ—¥-äº§å“åˆ†æSQLæŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"âŒ æŸ¥è¯¢è¯­å¥: {query}")
                import traceback
                print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
                return []
            
            sales_tc_data = []
            for row in results:
                total_amount = float(row[2]) if row[2] else 0.0
                total_receipts = int(row[3]) if row[3] else 0
                total_quantity = float(row[4]) if row[4] else 0.0
                product_amount = float(row[5]) if row[5] else 0.0
                product_receipts = int(row[6]) if row[6] else 0
                product_quantity = float(row[7]) if row[7] else 0.0
                product_receipt_performance = float(row[8]) if row[8] else 0.0
                
                # è®¡ç®—å æ¯”
                amount_percentage = (product_amount / total_amount * 100) if total_amount > 0 else 0.0
                receipt_percentage = (product_receipts / total_receipts * 100) if total_receipts > 0 else 0.0
                quantity_percentage = (product_quantity / total_quantity * 100) if total_quantity > 0 else 0.0
                product_receipt_performance_percentage = (product_receipt_performance / total_amount * 100) if total_amount > 0 else 0.0
                
                sales_tc_data.append({
                    'æ—¥æœŸ': row[0],
                    'é—¨å¸‚': row[1],
                    'æ€»ä¸šç»©': total_amount,
                    'æ€»å•æ®æ•°': total_receipts,
                    'æ€»é”€å”®æ•°é‡': total_quantity,
                    'äº§å“ä¸šç»©': product_amount,
                    'äº§å“å•æ®æ•°': product_receipts,
                    'äº§å“é”€å”®æ•°é‡': product_quantity,
                    'äº§å“å•æ®ä¸šç»©': product_receipt_performance,
                    'ä¸šç»©å æ¯”(%)': amount_percentage,
                    'å•æ®æ•°å æ¯”(%)': receipt_percentage,
                    'é”€å”®æ•°é‡å æ¯”(%)': quantity_percentage,
                    'äº§å“å•æ®ä¸šç»©å æ¯”(%)': product_receipt_performance_percentage
                })
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_sales_tc_cache'):
                self._sales_tc_cache = {}
            self._sales_tc_cache[cache_key] = sales_tc_data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._sales_tc_cache) > 10:
                # åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                oldest_key = next(iter(self._sales_tc_cache))
                del self._sales_tc_cache[oldest_key]
            
            return sales_tc_data
            
        except Exception as e:
            import traceback
            error_details = traceback.format_exc()
            print(f"è·å–é”€å”®TCåˆ†æå¤±è´¥: {e}")
            print(f"é”™è¯¯è¯¦æƒ…: {error_details}")
            return []
    
    def get_sales_tc_monthly_analysis(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–é”€å”®TCæœˆåº¦æ±‡æ€»åˆ†æ - ä¼˜åŒ–ç‰ˆæœ¬"""
        if not self.connection:
            return []
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"sales_tc_monthly_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{product_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_sales_tc_monthly_cache') and cache_key in self._sales_tc_monthly_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„æœˆåº¦äº§å“åˆ†ææ•°æ®")
            return self._sales_tc_monthly_cache[cache_key]
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºåŸºç¡€WHEREæ¡ä»¶
            conditions = []
            
            if date_from and date_to:
                conditions.append(f"s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            if weekday_filters and len(weekday_filters) > 0:
                print(f"åº”ç”¨æ˜ŸæœŸç­›é€‰: {weekday_filters}")
                # ä½¿ç”¨DATEPARTæ¥è·å–æ˜ŸæœŸå‡ ï¼Œ1=Sunday, 2=Monday, ..., 7=Saturday
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
                    print(f"æ˜ŸæœŸç­›é€‰SQLæ¡ä»¶: {weekday_conditions}")
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æ„å»ºäº§å“ç­›é€‰æ¡ä»¶
            product_condition = ""
            if product_filters and len(product_filters) > 0:
                product_list = "','".join(product_filters)
                product_condition = f"AND s.item_name IN ('{product_list}')"
            # å¦‚æœæ²¡æœ‰é€‰æ‹©äº§å“ï¼Œä¸æ·»åŠ é¢å¤–çš„ç­›é€‰æ¡ä»¶ï¼Œè®©æ‰€æœ‰äº§å“éƒ½åŒ…å«åœ¨äº§å“ä¸šç»©ä¸­
            
            # ä½¿ç”¨æœ¬åœ°æ•¸æ“šåº«ç²å–ç”¢å“å–®æ“šæ¥­ç¸¾
            receipt_performance_data = self.get_product_receipt_performance_from_db(
                date_from=date_from, 
                date_to=date_to, 
                product_filters=product_filters,
                database_source=self.current_database
            )
            
            # ç°¡åŒ–çš„æœˆåº¦æŸ¥è©¢
            query = f"""
                    SELECT 
                        FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                        s.store_name as é—¨å¸‚,
                        SUM({self.get_performance_calculation_sql()}) as æ€»ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                    SUM(CAST(ISNULL(s.qty, 0) as FLOAT)) as æ€»é”€å”®æ•°é‡,
                        SUM({self.get_performance_calculation_sql()}) as äº§å“ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as äº§å“å•æ®æ•°,
                    SUM(CAST(ISNULL(s.qty, 0) as FLOAT)) as äº§å“é”€å”®æ•°é‡,
                    0 as äº§å“å•æ®ä¸šç»©
                    FROM pos_sales_dtls s
                    {where_clause}
                    GROUP BY FORMAT(s.c_date, 'yyyy-MM'), s.store_name
                ORDER BY FORMAT(s.c_date, 'yyyy-MM'), s.store_name
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            print(f"å¼€å§‹æ‰§è¡Œé”€å”®TCæœˆåº¦æ±‡æ€»æŸ¥è¯¢...")
            print(f"æŸ¥è¯¢å‚æ•°: date_from={date_from}, date_to={date_to}")
            print(f"ç­›é€‰æ¡ä»¶: outlet_filters={outlet_filters}, product_filters={product_filters}, month_filters={month_filters}, weekday_filters={weekday_filters}, category_filters={category_filters}, payment_filters={payment_filters}")
            print(f"SQLæŸ¥è¯¢: {query}")
            start_time = time.time()
            
            try:
                # å…ˆæ‰§è¡Œç®€å•æµ‹è¯•æŸ¥è¯¢
                test_query = f"SELECT COUNT(*) FROM pos_sales_dtls WHERE CAST(c_date as DATE) = '{date_from}'"
                print(f"ğŸ” æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢: {test_query}")
                cursor.execute(test_query)
                test_result = cursor.fetchone()
                print(f"ğŸ” æµ‹è¯•æŸ¥è¯¢ç»“æœ - {date_from} çš„è®°å½•æ•°: {test_result[0] if test_result else 0}")
                
                if test_result and test_result[0] == 0:
                    print(f"âŒ {date_from} æ²¡æœ‰é”€å”®æ•°æ®")
                    return []
                
                cursor.execute(query)
                results = cursor.fetchall()
                
                end_time = time.time()
                print(f"é”€å”®TCæœˆåº¦æ±‡æ€»æŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶: {end_time - start_time:.2f} ç§’")
                print(f"é”€å”®TCæœˆåº¦æ±‡æ€»æŸ¥è¯¢ç»“æœ: {len(results)} æ¡è®°å½•")
                if results:
                    print(f"ç¬¬ä¸€æ¡è®°å½•: {results[0]}")
                else:
                    print(f"æœˆåº¦æŸ¥è¯¢è¿”å›0æ¡è®°å½•ï¼Œè¯·æ£€æŸ¥ç­›é€‰æ¡ä»¶å’Œæ•°æ®åº“ä¸­çš„æ•°æ®")
                    
            except Exception as query_error:
                print(f"âŒ æœˆåº¦äº§å“åˆ†æSQLæŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"âŒ æŸ¥è¯¢è¯­å¥: {query}")
                import traceback
                print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
                return []
            
            # è¨ˆç®—ç¸½çš„ç”¢å“å–®æ“šæ¥­ç¸¾
            total_product_receipt_performance = sum(
                data['äº§å“å•æ®ä¸šç»©'] for data in receipt_performance_data.values()
            )
            
            sales_tc_monthly_data = []
            for row in results:
                month = str(row[0]) if row[0] else ''
                store = str(row[1]) if row[1] else ''
                total_sales = float(row[2]) if row[2] else 0.0
                total_receipts = int(row[3]) if row[3] else 0
                total_quantity = float(row[4]) if row[4] else 0.0
                product_sales = float(row[5]) if row[5] else 0.0
                product_receipts = int(row[6]) if row[6] else 0
                product_quantity = float(row[7]) if row[7] else 0.0
                
                # å¾æœ¬åœ°æ•¸æ“šåº«ç²å–ç”¢å“å–®æ“šæ¥­ç¸¾ï¼ˆæœˆåº¦åŒ¯ç¸½ï¼‰- æŒ‰é–€å¸‚åˆ†åˆ¥è¨ˆç®—
                product_receipt_performance = 0.0
                if receipt_performance_data:
                    # æœˆ-éŠ·å”®æ•¸æ“šï¼šæŒ‰å„é–€å¸‚çš„å–®æ“šåˆ†åˆ¥è¨ˆç®—ç”¢å“å–®æ“šæ¥­ç¸¾
                    # æ ¹æ“šè©²é–€å¸‚çš„ç”¢å“æ¥­ç¸¾å ç¸½æ¥­ç¸¾çš„æ¯”ä¾‹ä¾†åˆ†é…ç”¢å“å–®æ“šæ¥­ç¸¾
                    total_all_product_sales = sum(float(row[5]) for row in results)  # æ‰€æœ‰é–€å¸‚çš„ç”¢å“æ¥­ç¸¾ç¸½å’Œ
                    if total_all_product_sales > 0 and product_sales > 0:
                        # æŒ‰è©²é–€å¸‚ç”¢å“æ¥­ç¸¾å ç¸½ç”¢å“æ¥­ç¸¾çš„æ¯”ä¾‹åˆ†é…ç”¢å“å–®æ“šæ¥­ç¸¾
                        product_sales_ratio = product_sales / total_all_product_sales
                        total_product_receipt_performance = sum(data['äº§å“å•æ®ä¸šç»©'] for data in receipt_performance_data.values())
                        product_receipt_performance = total_product_receipt_performance * product_sales_ratio
                
                # è®¡ç®—å æ¯”
                sales_ratio = (product_sales / total_sales * 100) if total_sales > 0 else 0
                receipt_ratio = (product_receipts / total_receipts * 100) if total_receipts > 0 else 0
                quantity_ratio = (product_quantity / total_quantity * 100) if total_quantity > 0 else 0
                product_receipt_performance_ratio = (product_receipt_performance / total_sales * 100) if total_sales > 0 else 0
                
                sales_tc_monthly_data.append({
                    'æœˆä»½': month,
                    'é—¨å¸‚': store,
                    'æ€»ä¸šç»©': total_sales,
                    'æ€»å•æ®æ•°': total_receipts,
                    'æ€»é”€å”®æ•°é‡': total_quantity,
                    'äº§å“ä¸šç»©': product_sales,
                    'äº§å“å•æ®æ•°': product_receipts,
                    'äº§å“é”€å”®æ•°é‡': product_quantity,
                    'äº§å“å•æ®ä¸šç»©': product_receipt_performance,
                    'ä¸šç»©å æ¯”(%)': round(sales_ratio, 2),
                    'å•æ®æ•°å æ¯”(%)': round(receipt_ratio, 2),
                    'é”€å”®æ•°é‡å æ¯”(%)': round(quantity_ratio, 2),
                    'äº§å“å•æ®ä¸šç»©å æ¯”(%)': round(product_receipt_performance_ratio, 2)
                })
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_sales_tc_monthly_cache'):
                self._sales_tc_monthly_cache = {}
            self._sales_tc_monthly_cache[cache_key] = sales_tc_monthly_data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._sales_tc_monthly_cache) > 10:
                oldest_key = next(iter(self._sales_tc_monthly_cache))
                del self._sales_tc_monthly_cache[oldest_key]
            
            return sales_tc_monthly_data
            
        except Exception as e:
            print(f"è·å–é”€å”®TCæœˆåº¦æ±‡æ€»å¤±è´¥: {e}")
            return []
    
    def _build_exists_conditions(self, date_from, date_to, outlet_filters, month_filters, category_filters, payment_filters):
        """æ„å»ºEXISTSå­å¥çš„æ¡ä»¶"""
        conditions = []
        
        # æ—¥æœŸç­›é€‰
        if date_from and date_to:
            conditions.append(f"CAST(s2.c_date AS DATE) >= '{date_from}'")
            conditions.append(f"CAST(s2.c_date AS DATE) <= '{date_to}'")
        elif date_from:
            conditions.append(f"CAST(s2.c_date AS DATE) >= '{date_from}'")
        elif date_to:
            conditions.append(f"CAST(s2.c_date AS DATE) <= '{date_to}'")
        
        # é—¨å¸‚ç­›é€‰
        if outlet_filters and len(outlet_filters) > 0:
            outlet_conditions = " OR ".join([f"s2.store_name = '{outlet}'" for outlet in outlet_filters])
            conditions.append(f"({outlet_conditions})")
        
        # æœˆä»½ç­›é€‰
        if month_filters and len(month_filters) > 0:
            month_conditions = " OR ".join([f"FORMAT(CAST(s2.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
            conditions.append(f"({month_conditions})")
        
        # ç±»åˆ«ç­›é€‰
        if category_filters and len(category_filters) > 0:
            category_conditions = " OR ".join([f"s2.item_category = '{category}'" for category in category_filters])
            conditions.append(f"({category_conditions})")
        
        # æ”¯ä»˜æ–¹å¼ç­›é€‰
        if payment_filters and len(payment_filters) > 0:
            payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
            conditions.append(f"EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE s2.sales_no = p.sales_no AND s2.store_name = p.store_name AND ({payment_conditions}))")
        
        if conditions:
            return " AND " + " AND ".join(conditions)
        return ""

    def _get_cancel_adjustment_sql(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, category_filters=None, payment_filters=None):
        """è·å–å–æ¶ˆé¡¹ç›®è°ƒæ•´çš„SQLå­æŸ¥è¯¢"""
        # æ„å»ºå–æ¶ˆé¡¹ç›®çš„WHEREæ¡ä»¶
        cancel_conditions = []
        
        # æ—¥æœŸç­›é€‰
        if date_from and date_to:
            cancel_conditions.append(f"c.c_date BETWEEN '{date_from}' AND '{date_to}'")
        elif date_from:
            cancel_conditions.append(f"c.c_date >= '{date_from}'")
        elif date_to:
            cancel_conditions.append(f"c.c_date <= '{date_to}'")
        
        # é—¨åº—ç­›é€‰
        if outlet_filters and len(outlet_filters) > 0:
            outlet_list = "', '".join(outlet_filters)
            cancel_conditions.append(f"c.store_name IN ('{outlet_list}')")
        
        # æœˆä»½ç­›é€‰
        if month_filters and len(month_filters) > 0:
            month_list = "', '".join(month_filters)
            cancel_conditions.append(f"FORMAT(c.c_date, 'yyyy-MM') IN ('{month_list}')")
        
        # ç±»åˆ«ç­›é€‰
        if category_filters and len(category_filters) > 0:
            category_list = "', '".join(category_filters)
            cancel_conditions.append(f"EXISTS (SELECT 1 FROM item_master im WHERE im.item_name = c.item_name AND im.category_code IN ('{category_list}'))")
        
        # æ”¯ä»˜æ–¹å¼ç­›é€‰
        if payment_filters and len(payment_filters) > 0:
            payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
            cancel_conditions.append(f"EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE c.sales_no = p.sales_no AND c.store_name = p.store_name AND ({payment_conditions}))")
        
        # æ„å»ºå®Œæ•´çš„å–æ¶ˆé¡¹ç›®è°ƒæ•´SQL
        cancel_where = ""
        if cancel_conditions:
            cancel_where = " AND " + " AND ".join(cancel_conditions)
        
        # æ ¹æ®æ•°æ®åº“ç±»å‹ç¡®å®šå–æ¶ˆé¡¹ç›®çš„è®¡ç®—æ–¹å¼
        if self.current_database == "sushi_gogo_pos_live":
            # GOGOæ•°æ®åº“ï¼šæ‰€æœ‰å–æ¶ˆé¡¹ç›®éƒ½ç›´æ¥å‡å»tax_amt
            cancel_calculation = "CAST(c.sub_total as FLOAT) - CAST(ISNULL(c.pro_disc_amt, 0) as FLOAT) + CAST(ISNULL(c.svc_amt, 0) as FLOAT) - CAST(ISNULL(c.tax_amt, 0) as FLOAT)"
        else:
            # Expressæ•°æ®åº“ï¼šåªæœ‰å¤–å¸¦å–æ¶ˆé¡¹ç›®æ‰å‡å»tax_amt
            cancel_calculation = "CAST(c.sub_total as FLOAT) - CAST(ISNULL(c.pro_disc_amt, 0) as FLOAT) + CAST(ISNULL(c.svc_amt, 0) as FLOAT) - CASE WHEN c.take_away_item = 'Y' THEN CAST(ISNULL(c.tax_amt, 0) as FLOAT) ELSE 0 END"
        
        cancel_sql = f"""
        - ISNULL((
            SELECT SUM({cancel_calculation})
            FROM pos_cancel_sales_item_dtls c WITH (NOLOCK)
            WHERE c.sales_no = s.sales_no 
                AND c.store_name = s.store_name 
                AND c.item_name = s.item_name
                AND c.c_date = s.c_date
                {cancel_where}
        ), 0)"""
        
        return cancel_sql

    def get_product_association_analysis(self, selected_product, date_from=None, date_to=None, outlet_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–äº§å“å…³è”åˆ†æ"""
        try:
            print(f"å¼€å§‹äº§å“å…³è”åˆ†ææŸ¥è¯¢: {selected_product}")
            print(f"æŸ¥è¯¢å‚æ•°: date_from={date_from}, date_to={date_to}")
            print(f"ç­›é€‰æ¡ä»¶: outlet_filters={outlet_filters}, month_filters={month_filters}, weekday_filters={weekday_filters}, category_filters={category_filters}, payment_filters={payment_filters}")
            if not self.connection:
                print("æ•°æ®åº“æœªè¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥...")
                try:
                    # ä½¿ç”¨å½“å‰æ•°æ®åº“è¿æ¥
                    if hasattr(self, 'current_database') and self.current_database:
                        self.connect(self.current_database)
                    else:
                        # å¦‚æœæ²¡æœ‰å½“å‰æ•°æ®åº“ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤çš„GOGOæ•°æ®åº“
                        self.connect("sushi_gogo_pos_live")
                    
                    if not self.connection:
                        print("é‡æ–°è¿æ¥å¤±è´¥")
                        return []
                    print("é‡æ–°è¿æ¥æˆåŠŸ")
                except Exception as e:
                    print(f"é‡æ–°è¿æ¥å¤±è´¥: {e}")
                    return []
            
            print(f"æ•°æ®åº“è¿æ¥çŠ¶æ€: {self.connection is not None}")
            print(f"æŸ¥è¯¢å‚æ•°: date_from={date_from}, date_to={date_to}, outlet_filters={outlet_filters}")
            
            cursor = self.connection.cursor()
            
            # æ„å»ºç­›é€‰æ¡ä»¶
            conditions = []
            
            # æ—¥æœŸç­›é€‰
            if date_from and date_to:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            elif date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            elif date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            
            # é—¨å¸‚ç­›é€‰
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            
            # æœˆä»½ç­›é€‰
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # ç±»åˆ«ç­›é€‰
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{payment}'" for payment in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æŸ¥è¯¢äº§å“å…³è”åˆ†æ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨CTEæé«˜æ€§èƒ½
            selected_product_query = f"""
                WITH SelectedProductData AS (
                    SELECT 
                        FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                        s.store_name as é—¨å¸‚,
                        s.sales_no,
                        SUM(CAST(s.qty as FLOAT)) as æ€»æ•°é‡,
                        SUM({self.get_performance_calculation_sql()} - 
                            ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©
                    FROM pos_sales_dtls s
                    LEFT JOIN (
                        SELECT 
                            sales_no, 
                            store_name, 
                            item_name,
                            SUM({self._get_cancel_performance_calculation_sql()}) as cancel_amount
                        FROM pos_cancel_sales_item_dtls WITH (NOLOCK)
                        GROUP BY sales_no, store_name, item_name
                    ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                    WHERE s.item_name = '{selected_product}'
                    {f"AND s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'" if date_from and date_to else ""}
                    {f"AND ({' OR '.join([f's.store_name = \'{outlet}\'' for outlet in outlet_filters])})" if outlet_filters and len(outlet_filters) > 0 else ""}
                    {f"AND ({' OR '.join([f'FORMAT(CAST(s.c_date AS DATE), \'yyyy-MM\') = \'{month}\'' for month in month_filters])})" if month_filters and len(month_filters) > 0 else ""}
                    {f"AND ({' OR '.join([f's.item_category = \'{category}\'' for category in category_filters])})" if category_filters and len(category_filters) > 0 else ""}
                    {f"AND EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({' OR '.join([f'p.payment_name = \'{payment}\'' for payment in payment_filters])}))" if payment_filters and len(payment_filters) > 0 else ""}
                    AND s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')
                    GROUP BY FORMAT(s.c_date, 'yyyy-MM'), s.store_name, s.sales_no
                )
                SELECT 
                    æœˆä»½,
                    é—¨å¸‚,
                    '{selected_product}' as äº§å“åç§°,
                    SUM(æ€»æ•°é‡) as æ€»æ•°é‡,
                    COUNT(DISTINCT sales_no) as æ€»å•æ®æ•°,
                    SUM(æ€»ä¸šç»©) as æ€»ä¸šç»©
                FROM SelectedProductData
                GROUP BY æœˆä»½, é—¨å¸‚
            """
            
            print(f"æ‰§è¡Œé€‰ä¸­äº§å“æŸ¥è¯¢...")
            print(f"SQLæŸ¥è¯¢: {selected_product_query}")
            print(f"æŸ¥è¯¢å‚æ•°: selected_product='{selected_product}', date_from='{date_from}', date_to='{date_to}'")
            print(f"ç­›é€‰æ¡ä»¶: outlet_filters={outlet_filters}, month_filters={month_filters}, category_filters={category_filters}, payment_filters={payment_filters}")
            cursor.execute(selected_product_query)
            selected_product_results = cursor.fetchall()
            
            print(f"é€‰ä¸­äº§å“æŸ¥è¯¢ç»“æœ: {len(selected_product_results)} æ¡è®°å½•")
            if selected_product_results:
                print(f"ç¬¬ä¸€æ¡è®°å½•: {selected_product_results[0]}")
            else:
                print(f"æŸ¥è¯¢è¿”å›0æ¡è®°å½•ï¼Œè¯·æ£€æŸ¥äº§å“åç§°ã€ç­›é€‰æ¡ä»¶å’Œæ•°æ®åº“ä¸­çš„æ•°æ®")
            
            if not selected_product_results:
                print(f"æœªæ‰¾åˆ°äº§å“ '{selected_product}' çš„æ•°æ®")
                return []
            
            print(f"æ‰¾åˆ° {len(selected_product_results)} ä¸ªé—¨å¸‚/æœˆä»½ç»„åˆåŒ…å«äº§å“ '{selected_product}'")
            
            # è·å–åŒå•æ®ä¸­çš„å…¶ä»–äº§å“ä¿¡æ¯ - ä¿®æ”¹ä¸ºæ˜¾ç¤ºæ•´å¼ å•æ®ä¸šç»©
            other_products_query = f"""
                WITH SelectedProductSales AS (
                    SELECT DISTINCT s.sales_no, s.store_name, FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½
                    FROM pos_sales_dtls s
                    WHERE s.item_name = '{selected_product}'
                    {f"AND s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'" if date_from and date_to else ""}
                    {f"AND ({' OR '.join([f's.store_name = \'{outlet}\'' for outlet in outlet_filters])})" if outlet_filters and len(outlet_filters) > 0 else ""}
                    {f"AND ({' OR '.join([f'FORMAT(CAST(s.c_date AS DATE), \'yyyy-MM\') = \'{month}\'' for month in month_filters])})" if month_filters and len(month_filters) > 0 else ""}
                    {f"AND ({' OR '.join([f's.item_category = \'{category}\'' for category in category_filters])})" if category_filters and len(category_filters) > 0 else ""}
                    {f"AND EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({' OR '.join([f'p.payment_name = \'{payment}\'' for payment in payment_filters])}))" if payment_filters and len(payment_filters) > 0 else ""}
                    AND s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')
                ),
                ReceiptTotals AS (
                    SELECT 
                        s.sales_no,
                        s.store_name,
                        SUM({self.get_performance_calculation_sql()} - 
                            ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ•´å¼ å•æ®ä¸šç»©
                    FROM pos_sales_dtls s
                    LEFT JOIN (
                        SELECT 
                            sales_no, 
                            store_name, 
                            item_name,
                            SUM({self._get_cancel_performance_calculation_sql()}) as cancel_amount
                        FROM pos_cancel_sales_item_dtls WITH (NOLOCK)
                        GROUP BY sales_no, store_name, item_name
                    ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                    WHERE s.item_name != 'WASTAGE'
                    {f"AND s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'" if date_from and date_to else ""}
                    {f"AND ({' OR '.join([f's.store_name = \'{outlet}\'' for outlet in outlet_filters])})" if outlet_filters and len(outlet_filters) > 0 else ""}
                    {f"AND ({' OR '.join([f'FORMAT(CAST(s.c_date AS DATE), \'yyyy-MM\') = \'{month}\'' for month in month_filters])})" if month_filters and len(month_filters) > 0 else ""}
                    {f"AND ({' OR '.join([f's.item_category = \'{category}\'' for category in category_filters])})" if category_filters and len(category_filters) > 0 else ""}
                    {f"AND EXISTS (SELECT 1 FROM pos_sales_payment_dtls p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({' OR '.join([f'p.payment_name = \'{payment}\'' for payment in payment_filters])}))" if payment_filters and len(payment_filters) > 0 else ""}
                    AND s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')
                    GROUP BY s.sales_no, s.store_name
                )
                SELECT 
                    sp.æœˆä»½,
                    sp.store_name as é—¨å¸‚,
                    s.item_name as äº§å“åç§°,
                    SUM(CAST(s.qty as FLOAT)) as æ•°é‡,
                    COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as å•æ®æ•°,
                    SUM(rt.æ•´å¼ å•æ®ä¸šç»©) as å•æ®ä¸šç»©,
                    s.sales_no  -- æ·»åŠ å•æ®å·ç”¨äºæ’åº
                FROM pos_sales_dtls s
                INNER JOIN SelectedProductSales sp ON s.sales_no = sp.sales_no AND s.store_name = sp.store_name
                INNER JOIN ReceiptTotals rt ON s.sales_no = rt.sales_no AND s.store_name = rt.store_name
                WHERE s.item_name != '{selected_product}'
                AND s.item_name != 'WASTAGE'
                {where_clause.replace('WHERE ', ' AND ') if where_clause else ''}
                GROUP BY sp.æœˆä»½, sp.store_name, s.item_name, s.sales_no
                ORDER BY sp.æœˆä»½, sp.store_name, s.sales_no, s.item_name
            """
            
            print(f"æ‰§è¡Œå…¶ä»–äº§å“æŸ¥è¯¢: {other_products_query}")
            cursor.execute(other_products_query)
            other_products_results = cursor.fetchall()
            
            print(f"å…¶ä»–äº§å“æŸ¥è¯¢ç»“æœ: {len(other_products_results)} æ¡è®°å½•")
            if other_products_results:
                print(f"ç¬¬ä¸€æ¡å…¶ä»–äº§å“è®°å½•: {other_products_results[0]}")
            
            print(f"æ‰¾åˆ° {len(other_products_results)} ä¸ªå…¶ä»–äº§å“ä¸ '{selected_product}' åœ¨åŒä¸€å•æ®ä¸­")
            
            # è·å–æ¯ä¸ªå…¶ä»–äº§å“çš„æ€»æ•°é‡ï¼ˆç”¨äºè®¡ç®—å æ¯”ï¼‰
            other_products_totals = {}
            if other_products_results:
                # è·å–æ‰€æœ‰å…¶ä»–äº§å“çš„åç§°
                other_product_names = list(set([row[2] for row in other_products_results]))
                
                # æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰å…¶ä»–äº§å“çš„æ€»æ•°é‡
                if other_product_names:
                    product_names_str = "', '".join(other_product_names)
                    batch_total_query = f"""
                        SELECT 
                            FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                            s.store_name as é—¨å¸‚,
                            s.item_name as äº§å“åç§°,
                            SUM(CAST(s.qty as FLOAT)) as æ€»æ•°é‡,
                            COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°
                        FROM pos_sales_dtls s
                        {where_clause}
                        AND s.item_name IN ('{product_names_str}')
                        AND s.item_name != 'WASTAGE'
                        GROUP BY FORMAT(s.c_date, 'yyyy-MM'), s.store_name, s.item_name
                    """
                    try:
                        cursor.execute(batch_total_query)
                        total_results = cursor.fetchall()
                        for total_row in total_results:
                            æœˆä»½, é—¨å¸‚, äº§å“åç§°, æ€»æ•°é‡, æ€»å•æ®æ•° = total_row
                            key = (æœˆä»½, é—¨å¸‚, äº§å“åç§°)
                            other_products_totals[key] = (æ€»æ•°é‡, æ€»å•æ®æ•°)
                    except Exception as e:
                        print(f"æ‰¹é‡æŸ¥è¯¢å…¶ä»–äº§å“æ€»æ•°é‡å¤±è´¥: {e}")
            
            # åˆå¹¶ç»“æœ
            results = []
            
            # æŒ‰é—¨åº—åˆ†ç»„å¤„ç†
            store_groups = {}
            
            # æ·»åŠ é€‰ä¸­äº§å“çš„åŸºæœ¬ä¿¡æ¯
            for row in selected_product_results:
                æœˆä»½, é—¨å¸‚, äº§å“åç§°, æ€»æ•°é‡, æ€»å•æ®æ•°, æ€»ä¸šç»© = row
                key = (æœˆä»½, é—¨å¸‚)
                if key not in store_groups:
                    store_groups[key] = {
                        'selected_product': row,
                        'other_products': [],
                        'other_receipts': set()  # æ·»åŠ ç”¨äºæ”¶é›†å…¶ä»–äº§å“çš„å•æ®å·
                    }
                store_groups[key]['selected_product'] = row
            
            # æ·»åŠ å…¶ä»–äº§å“ä¿¡æ¯
            for row in other_products_results:
                æœˆä»½, é—¨å¸‚, äº§å“åç§°, æ•°é‡, å•æ®æ•°, å•æ®ä¸šç»©, å•æ®å· = row
                key = (æœˆä»½, é—¨å¸‚)
                if key not in store_groups:
                    store_groups[key] = {
                        'selected_product': None,
                        'other_products': [],
                        'other_receipts': set()  # æ·»åŠ ç”¨äºæ”¶é›†å…¶ä»–äº§å“çš„å•æ®å·
                    }
                # åªä¿ç•™å‰6ä¸ªå­—æ®µï¼Œå»æ‰å•æ®å·
                store_groups[key]['other_products'].append(row[:6])
                # æ”¶é›†å…¶ä»–äº§å“çš„å•æ®å·
                store_groups[key]['other_receipts'].add(å•æ®å·)
            
            # è®¡ç®—å…¨éƒ¨æ€»æ•°
            total_selected_qty = 0
            total_selected_receipts = 0
            total_selected_sales = 0
            total_other_qty = 0
            total_other_receipts = 0
            total_other_sales = 0
            
            # å¤„ç†æ¯ä¸ªé—¨åº—çš„æ•°æ®
            for (æœˆä»½, é—¨å¸‚), group_data in store_groups.items():
                selected_product = group_data['selected_product']
                other_products = group_data['other_products']
                
                if selected_product:
                    # æ·»åŠ æœç´¢äº§å“è¡Œ
                    äº§å“åç§°, æ€»æ•°é‡, æ€»å•æ®æ•°, æ€»ä¸šç»© = selected_product[2], selected_product[3], selected_product[4], selected_product[5]
                    results.append((
                        æœˆä»½, é—¨å¸‚, äº§å“åç§°, 
                        round(float(æ€»æ•°é‡), 2), 
                        æ€»å•æ®æ•°, 
                        round(float(æ€»ä¸šç»©), 2), 
                        '100.00', 
                        '100.00'
                    ))
                    
                    # ç´¯è®¡åˆ°å…¨éƒ¨æ€»æ•°
                    total_selected_qty += float(æ€»æ•°é‡)
                    total_selected_receipts += æ€»å•æ®æ•°
                    total_selected_sales += float(æ€»ä¸šç»©)
                
                if other_products:
                    # è®¡ç®—å…¶ä»–äº§å“çš„æ€»æ•°é‡
                    å…¶ä»–äº§å“æ€»æ•°é‡ = sum(float(row[3]) for row in other_products)
                    
                    # è®¡ç®—åŒ…å«å…¶ä»–äº§å“çš„å•æ®æ•°ï¼ˆå»é‡ï¼‰
                    å…¶ä»–äº§å“å•æ®æ•° = len(group_data.get('other_receipts', set()))
                    
                    # è®¡ç®—æ‰€æœ‰ç›¸å…³å•æ®çš„æ€»ä¸šç»©
                    # ç”±äºæ¯ä¸ªäº§å“è¡Œéƒ½æ˜¾ç¤ºæ•´å¼ å•æ®çš„ä¸šç»©ï¼Œæˆ‘ä»¬éœ€è¦å»é‡åæ±‚å’Œ
                    å•æ®ä¸šç»©é›†åˆ = set()
                    for row in other_products:
                        å•æ®ä¸šç»©é›†åˆ.add(float(row[5]))  # æ¯å¼ å•æ®çš„ä¸šç»©
                    æ‰€æœ‰å•æ®æ€»ä¸šç»© = sum(å•æ®ä¸šç»©é›†åˆ)
                    
                    # æ·»åŠ "Total Other Item"è¡Œ
                    results.append((
                        æœˆä»½, é—¨å¸‚, "Total Other Item", 
                        round(å…¶ä»–äº§å“æ€»æ•°é‡, 2), 
                        å…¶ä»–äº§å“å•æ®æ•°,  # ä½¿ç”¨åŒ…å«å…¶ä»–äº§å“çš„å•æ®æ•°
                        round(æ‰€æœ‰å•æ®æ€»ä¸šç»©, 2),  # ä½¿ç”¨æ‰€æœ‰å•æ®çš„æ€»ä¸šç»©
                        '100.00', 
                        '100.00'
                    ))
                    
                    # ç´¯è®¡åˆ°å…¨éƒ¨æ€»æ•°
                    total_other_qty += å…¶ä»–äº§å“æ€»æ•°é‡
                    total_other_receipts += å…¶ä»–äº§å“å•æ®æ•°
                    total_other_sales += æ‰€æœ‰å•æ®æ€»ä¸šç»©
                    
                    # æ·»åŠ å„ä¸ªå…¶ä»–äº§å“è¡Œ
                    for row in other_products:
                        äº§å“åç§°, æ•°é‡, å•æ®æ•°, å•æ®ä¸šç»© = row[2], row[3], row[4], row[5]
                        
                        # æ•°é‡å æ¯” = è‡ªèº«äº§å“æ•°é‡ / å…¶ä»–äº§å“æ€»æ•°é‡ * 100
                        æ•°é‡å æ¯” = round((float(æ•°é‡) / å…¶ä»–äº§å“æ€»æ•°é‡) * 100, 2) if å…¶ä»–äº§å“æ€»æ•°é‡ > 0 else 0
                        
                        # å•æ®å æ¯” = è‡ªèº«äº§å“å•æ®æ•° / æœç´¢äº§å“å•æ®æ•° * 100
                        å•æ®å æ¯” = round((å•æ®æ•° / æ€»å•æ®æ•°) * 100, 2) if æ€»å•æ®æ•° > 0 else 0
                        
                        results.append((
                            æœˆä»½, é—¨å¸‚, äº§å“åç§°, 
                            round(float(æ•°é‡), 2), 
                            å•æ®æ•°, 
                            round(float(å•æ®ä¸šç»©), 2), 
                            f"{æ•°é‡å æ¯”:.2f}", 
                            f"{å•æ®å æ¯”:.2f}"
                        ))
            
            # æ·»åŠ å…¨éƒ¨æ€»æ•°è¡Œ
            if total_selected_qty > 0 or total_other_qty > 0:
                results.append((
                    "å…¨éƒ¨\nTotal", "å…¨éƒ¨\nTotal", "å…¨éƒ¨æ€»æ•°\nGrand Total", 
                    round(total_selected_qty + total_other_qty, 2), 
                    total_selected_receipts + total_other_receipts, 
                    round(total_selected_sales + total_other_sales, 2), 
                    '100.00', 
                    '100.00'
                ))
            
            return results
            
        except Exception as e:
            import traceback
            error_details = traceback.format_exc()
            print(f"è·å–äº§å“å…³è”åˆ†æå¤±è´¥: {e}")
            print(f"é”™è¯¯è¯¦æƒ…: {error_details}")
            return []
    
    def get_brand_analysis(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–å“ç‰Œåˆ†ææ•°æ®"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            
            if date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            if weekday_filters and len(weekday_filters) > 0:
                print(f"åº”ç”¨æ˜ŸæœŸç­›é€‰: {weekday_filters}")
                # ä½¿ç”¨DATEPARTæ¥è·å–æ˜ŸæœŸå‡ ï¼Œ1=Sunday, 2=Monday, ..., 7=Saturday
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
                    print(f"æ˜ŸæœŸç­›é€‰SQLæ¡ä»¶: {weekday_conditions}")
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{method}'" for method in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND s.c_date = p.c_date AND ({payment_conditions}))")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            # æ„å»ºJOINå­å¥
            join_clause = ""
            if category_filters and len(category_filters) > 0:
                join_clause = f"LEFT JOIN {TABLE_ITEMS} im ON s.item_name = im.item_name"
            
            # æ„å»ºWHEREå­å¥
            where_clause = ""
            if conditions:
                where_clause = "WHERE " + " AND ".join(conditions)
            
            # æ„å»ºæŸ¥è¯¢SQL
            query = f"""
                WITH BrandData AS (
                    SELECT
                        FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                        s.store_name as é—¨å¸‚,
                        CASE 
                            WHEN s.item_name LIKE '%SUSHI%' OR s.item_name LIKE '%SASHIMI%' THEN 'SUSHI'
                            WHEN s.item_name LIKE '%RAMEN%' OR s.item_name LIKE '%UDON%' THEN 'NOODLES'
                            WHEN s.item_name LIKE '%TEMPURA%' THEN 'TEMPURA'
                            WHEN s.item_name LIKE '%DONBURI%' OR s.item_name LIKE '%DON%' THEN 'DONBURI'
                            WHEN s.item_name LIKE '%SALAD%' THEN 'SALAD'
                            WHEN s.item_name LIKE '%DRINK%' OR s.item_name LIKE '%BEVERAGE%' THEN 'BEVERAGE'
                            ELSE 'OTHER'
                        END as å“ç‰Œ,
                        SUM(CAST(s.qty as FLOAT)) as æ•°é‡,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as å•æ®æ•°,
                        SUM(CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) -
                            CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END
                            ) as ä¸šç»©
                    FROM {TABLE_SALES} s
                    {join_clause}
                    {where_clause}
                    GROUP BY FORMAT(s.c_date, 'yyyy-MM'), s.store_name, 
                        CASE 
                            WHEN s.item_name LIKE '%SUSHI%' OR s.item_name LIKE '%SASHIMI%' THEN 'SUSHI'
                            WHEN s.item_name LIKE '%RAMEN%' OR s.item_name LIKE '%UDON%' THEN 'NOODLES'
                            WHEN s.item_name LIKE '%TEMPURA%' THEN 'TEMPURA'
                            WHEN s.item_name LIKE '%DONBURI%' OR s.item_name LIKE '%DON%' THEN 'DONBURI'
                            WHEN s.item_name LIKE '%SALAD%' THEN 'SALAD'
                            WHEN s.item_name LIKE '%DRINK%' OR s.item_name LIKE '%BEVERAGE%' THEN 'BEVERAGE'
                            ELSE 'OTHER'
                        END
                )
                SELECT
                    æœˆä»½,
                    é—¨å¸‚,
                    å“ç‰Œ,
                    SUM(æ•°é‡) as æ€»æ•°é‡,
                    SUM(å•æ®æ•°) as æ€»å•æ®æ•°,
                    SUM(ä¸šç»©) as æ€»ä¸šç»©
                FROM BrandData
                GROUP BY æœˆä»½, é—¨å¸‚, å“ç‰Œ
                ORDER BY æœˆä»½, é—¨å¸‚, æ€»ä¸šç»© DESC
            """
            
            print(f"å¼€å§‹æ‰§è¡Œå“ç‰Œåˆ†ææŸ¥è¯¢...")
            start_time = time.time()
            cursor.execute(query)
            results = cursor.fetchall()
            end_time = time.time()
            print(f"å“ç‰Œåˆ†ææŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶: {end_time - start_time:.2f} ç§’")
            print(f"å“ç‰Œåˆ†ææŸ¥è¯¢ç»“æœ: {len(results)} æ¡è®°å½•")
            if results:
                print(f"ç¬¬ä¸€æ¡è®°å½•: {results[0]}")
            
            return results
            
        except Exception as e:
            print(f"è·å–å“ç‰Œåˆ†æå¤±è´¥: {e}")
            return []
    
    def get_brand_daily_breakdown(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–å“ç‰Œæ¯æ—¥ç»†é¡¹åˆ†ææ•°æ® - ä¸æœˆé”€å”®æ•°æ®ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æŸ¥è¯¢é€»è¾‘"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºç­›é€‰æ¡ä»¶ - ä¸æœˆé”€å”®æ•°æ®å®Œå…¨ç›¸åŒ
            conditions = []
            
            # æ—¥æœŸç­›é€‰ - ä¸æœˆé”€å”®æ•°æ®ç›¸åŒçš„æ ¼å¼
            if date_from and date_to:
                conditions.append(f"s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'")
            elif month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ˜ŸæœŸç­›é€‰
            if weekday_filters and len(weekday_filters) > 0:
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
            
            # é—¨åº—ç­›é€‰ - ä¸æœˆé”€å”®æ•°æ®ç›¸åŒçš„æ ¼å¼
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            
            # ç±»åˆ«ç­›é€‰ - ä¸æœˆé”€å”®æ•°æ®ç›¸åŒçš„æ ¼å¼
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰ - ä¸æœˆé”€å”®æ•°æ®ç›¸åŒçš„æ ¼å¼
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{method}'" for method in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¸æœˆé”€å”®æ•°æ®ç›¸åŒçš„æ ¼å¼
            conditions.append("s.item_name NOT LIKE '%WASTAGE%'")
            conditions.append("s.item_name NOT LIKE '%Waste%'")
            conditions.append("s.item_name NOT LIKE '%waste%'")
            conditions.append("s.item_name NOT LIKE '%WASTE%'")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # è·å–ä¸šç»©è®¡ç®—SQL - ä¸æœˆé”€å”®æ•°æ®å®Œå…¨ç›¸åŒ
            performance_sql = self.get_performance_calculation_sql()
            
            # ä¿®å¤æ¯æ—¥ç»†é¡¹æŸ¥è¯¢ - é¿å…é‡å¤è®¡ç®—ä¸šç»©
            query = f"""
                WITH DailyReceipts AS (
                    SELECT 
                        FORMAT(s.c_date, 'yyyy-MM-dd') as æ—¥æœŸ,
                        s.store_name as é—¨å¸‚,
                        s.sales_no,
                        SUM({performance_sql}) as å•æ®ä¸šç»©,
                        MAX(s.take_away_item) as take_away_item,
                        STRING_AGG(DISTINCT p.payment_name, ',') as payment_methods
                    FROM {TABLE_SALES} s WITH (NOLOCK)
                LEFT JOIN item_master im WITH (NOLOCK) ON s.item_name = im.item_name
                    LEFT JOIN {TABLE_PAYMENT} p WITH (NOLOCK) ON s.sales_no = p.sales_no AND s.store_name = p.store_name
                    {where_clause}
                    GROUP BY FORMAT(s.c_date, 'yyyy-MM-dd'), s.store_name, s.sales_no
                )
                SELECT 
                    dr.æ—¥æœŸ,
                    dr.é—¨å¸‚,
                    'ALL' as å“ç‰Œ,
                    SUM(dr.å•æ®ä¸šç»©) as æ€»ä¸šç»©,
                    COUNT(DISTINCT CONCAT(dr.é—¨å¸‚, '-', dr.sales_no)) as æ€»å•æ®æ•°,
                    SUM(CASE WHEN dr.take_away_item = 'N' THEN dr.å•æ®ä¸šç»© ELSE 0 END) as DIä¸šç»©,
                    COUNT(DISTINCT CASE WHEN dr.take_away_item = 'N' THEN dr.sales_no END) as DIå•æ®æ•°,
                    SUM(CASE WHEN dr.take_away_item = 'Y' THEN dr.å•æ®ä¸šç»© ELSE 0 END) as å¤–å¸¦ä¸šç»©,
                    COUNT(DISTINCT CASE WHEN dr.take_away_item = 'Y' THEN dr.sales_no END) as å¤–å¸¦å•æ®æ•°,
                    SUM(CASE WHEN dr.payment_methods LIKE '%GRAB FOOD%' OR dr.payment_methods LIKE '%FOOD PANDA%' OR dr.payment_methods LIKE '%DELIVEROO%' THEN dr.å•æ®ä¸šç»© ELSE 0 END) as é…é€ä¸šç»©,
                    COUNT(DISTINCT CASE WHEN dr.payment_methods LIKE '%GRAB FOOD%' OR dr.payment_methods LIKE '%FOOD PANDA%' OR dr.payment_methods LIKE '%DELIVEROO%' THEN dr.sales_no END) as é…é€å•æ®æ•°,
                    SUM(CASE WHEN dr.payment_methods LIKE '%FOOD PANDA%' THEN dr.å•æ®ä¸šç»© ELSE 0 END) as FOOD_PANDAä¸šç»©,
                    COUNT(DISTINCT CASE WHEN dr.payment_methods LIKE '%FOOD PANDA%' THEN dr.sales_no END) as FOOD_PANDAå•æ®æ•°,
                    SUM(CASE WHEN dr.payment_methods LIKE '%GRAB FOOD%' THEN dr.å•æ®ä¸šç»© ELSE 0 END) as GRAB_FOODä¸šç»©,
                    COUNT(DISTINCT CASE WHEN dr.payment_methods LIKE '%GRAB FOOD%' THEN dr.sales_no END) as GRAB_FOODå•æ®æ•°,
                    SUM(CASE WHEN dr.payment_methods LIKE '%DELIVEROO%' THEN dr.å•æ®ä¸šç»© ELSE 0 END) as DELIVEROOä¸šç»©,
                    COUNT(DISTINCT CASE WHEN dr.payment_methods LIKE '%DELIVEROO%' THEN dr.sales_no END) as DELIVEROOå•æ®æ•°
                FROM DailyReceipts dr
                GROUP BY dr.æ—¥æœŸ, dr.é—¨å¸‚
                ORDER BY dr.æ—¥æœŸ, dr.é—¨å¸‚
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            cursor.execute(query)
            results = cursor.fetchall()
            
            # è½¬æ¢æ•°æ®æ ¼å¼å¹¶æ·»åŠ æ¯æ—¥æ€»è®¡è¡Œ
            data = []
            daily_totals = {}  # å­˜å‚¨æ¯æ—¥æ€»è®¡
            
            for row in results:
                try:
                    if len(row) < 17:
                        continue
                    
                    row_data = {
                    'æ—¥æœŸ': row[0],
                    'é—¨å¸‚': row[1],
                    'å“ç‰Œ': row[2],
                    'æ€»ä¸šç»©': float(row[3]) if row[3] else 0.0,
                    'æ€»å•æ®æ•°': int(row[4]) if row[4] else 0,
                        'æ€»å•æ®å¤§å°': float(row[3]) / int(row[4]) if row[4] and int(row[4]) > 0 else 0.0,
                        'DIä¸šç»©': float(row[5]) if row[5] else 0.0,
                        'DIå•æ®æ•°': int(row[6]) if row[6] else 0,
                        'DIå•æ®å¤§å°': float(row[5]) / int(row[6]) if row[6] and int(row[6]) > 0 else 0.0,
                        'å¤–å¸¦ä¸šç»©': float(row[7]) if row[7] else 0.0,
                        'å¤–å¸¦å•æ®æ•°': int(row[8]) if row[8] else 0,
                        'å¤–å¸¦å•æ®å¤§å°': float(row[7]) / int(row[8]) if row[8] and int(row[8]) > 0 else 0.0,
                        'é…é€ä¸šç»©': float(row[9]) if row[9] else 0.0,
                        'é…é€å•æ®æ•°': int(row[10]) if row[10] else 0,
                        'é…é€å•æ®å¤§å°': float(row[9]) / int(row[10]) if row[10] and int(row[10]) > 0 else 0.0,
                        'FOOD_PANDAä¸šç»©': float(row[11]) if row[11] else 0.0,
                        'FOOD_PANDAå•æ®æ•°': int(row[12]) if row[12] else 0,
                        'FOOD_PANDAå•æ®å¤§å°': float(row[11]) / int(row[12]) if row[12] and int(row[12]) > 0 else 0.0,
                        'GRAB_FOODä¸šç»©': float(row[13]) if row[13] else 0.0,
                        'GRAB_FOODå•æ®æ•°': int(row[14]) if row[14] else 0,
                        'GRAB_FOODå•æ®å¤§å°': float(row[13]) / int(row[14]) if row[14] and int(row[14]) > 0 else 0.0,
                        'DELIVEROOä¸šç»©': float(row[15]) if row[15] else 0.0,
                        'DELIVEROOå•æ®æ•°': int(row[16]) if row[16] else 0,
                        'DELIVEROOå•æ®å¤§å°': float(row[15]) / int(row[16]) if row[16] and int(row[16]) > 0 else 0.0,
                        'is_daily_total': False  # æ ‡è®°æ˜¯å¦ä¸ºæ¯æ—¥æ€»è®¡è¡Œ
                    }
                    
                    data.append(row_data)
                    
                    # ç´¯åŠ æ¯æ—¥æ€»è®¡
                    date_key = row[0]
                    if date_key not in daily_totals:
                        daily_totals[date_key] = {
                            'æ€»ä¸šç»©': 0.0, 'æ€»å•æ®æ•°': 0, 'DIä¸šç»©': 0.0, 'DIå•æ®æ•°': 0,
                            'å¤–å¸¦ä¸šç»©': 0.0, 'å¤–å¸¦å•æ®æ•°': 0, 'é…é€ä¸šç»©': 0.0, 'é…é€å•æ®æ•°': 0,
                            'FOOD_PANDAä¸šç»©': 0.0, 'FOOD_PANDAå•æ®æ•°': 0,
                            'GRAB_FOODä¸šç»©': 0.0, 'GRAB_FOODå•æ®æ•°': 0,
                            'DELIVEROOä¸šç»©': 0.0, 'DELIVEROOå•æ®æ•°': 0
                        }
                    
                    daily_totals[date_key]['æ€»ä¸šç»©'] += float(row[3]) if row[3] else 0.0
                    daily_totals[date_key]['æ€»å•æ®æ•°'] += int(row[4]) if row[4] else 0
                    daily_totals[date_key]['DIä¸šç»©'] += float(row[5]) if row[5] else 0.0
                    daily_totals[date_key]['DIå•æ®æ•°'] += int(row[6]) if row[6] else 0
                    daily_totals[date_key]['å¤–å¸¦ä¸šç»©'] += float(row[7]) if row[7] else 0.0
                    daily_totals[date_key]['å¤–å¸¦å•æ®æ•°'] += int(row[8]) if row[8] else 0
                    daily_totals[date_key]['é…é€ä¸šç»©'] += float(row[9]) if row[9] else 0.0
                    daily_totals[date_key]['é…é€å•æ®æ•°'] += int(row[10]) if row[10] else 0
                    daily_totals[date_key]['FOOD_PANDAä¸šç»©'] += float(row[11]) if row[11] else 0.0
                    daily_totals[date_key]['FOOD_PANDAå•æ®æ•°'] += int(row[12]) if row[12] else 0
                    daily_totals[date_key]['GRAB_FOODä¸šç»©'] += float(row[13]) if row[13] else 0.0
                    daily_totals[date_key]['GRAB_FOODå•æ®æ•°'] += int(row[14]) if row[14] else 0
                    daily_totals[date_key]['DELIVEROOä¸šç»©'] += float(row[15]) if row[15] else 0.0
                    daily_totals[date_key]['DELIVEROOå•æ®æ•°'] += int(row[16]) if row[16] else 0
                    
                except Exception as e:
                    continue
            
            # æ·»åŠ æ¯æ—¥æ€»è®¡è¡Œ
            for date_key, totals in daily_totals.items():
                daily_total_row = {
                    'æ—¥æœŸ': date_key,
                    'é—¨å¸‚': 'æ¯æ—¥æ€»è®¡',
                    'å“ç‰Œ': 'ALL',
                    'æ€»ä¸šç»©': totals['æ€»ä¸šç»©'],
                    'æ€»å•æ®æ•°': totals['æ€»å•æ®æ•°'],
                    'æ€»å•æ®å¤§å°': totals['æ€»ä¸šç»©'] / totals['æ€»å•æ®æ•°'] if totals['æ€»å•æ®æ•°'] > 0 else 0.0,
                    'DIä¸šç»©': totals['DIä¸šç»©'],
                    'DIå•æ®æ•°': totals['DIå•æ®æ•°'],
                    'DIå•æ®å¤§å°': totals['DIä¸šç»©'] / totals['DIå•æ®æ•°'] if totals['DIå•æ®æ•°'] > 0 else 0.0,
                    'å¤–å¸¦ä¸šç»©': totals['å¤–å¸¦ä¸šç»©'],
                    'å¤–å¸¦å•æ®æ•°': totals['å¤–å¸¦å•æ®æ•°'],
                    'å¤–å¸¦å•æ®å¤§å°': totals['å¤–å¸¦ä¸šç»©'] / totals['å¤–å¸¦å•æ®æ•°'] if totals['å¤–å¸¦å•æ®æ•°'] > 0 else 0.0,
                    'é…é€ä¸šç»©': totals['é…é€ä¸šç»©'],
                    'é…é€å•æ®æ•°': totals['é…é€å•æ®æ•°'],
                    'é…é€å•æ®å¤§å°': totals['é…é€ä¸šç»©'] / totals['é…é€å•æ®æ•°'] if totals['é…é€å•æ®æ•°'] > 0 else 0.0,
                    'FOOD_PANDAä¸šç»©': totals['FOOD_PANDAä¸šç»©'],
                    'FOOD_PANDAå•æ®æ•°': totals['FOOD_PANDAå•æ®æ•°'],
                    'FOOD_PANDAå•æ®å¤§å°': totals['FOOD_PANDAä¸šç»©'] / totals['FOOD_PANDAå•æ®æ•°'] if totals['FOOD_PANDAå•æ®æ•°'] > 0 else 0.0,
                    'GRAB_FOODä¸šç»©': totals['GRAB_FOODä¸šç»©'],
                    'GRAB_FOODå•æ®æ•°': totals['GRAB_FOODå•æ®æ•°'],
                    'GRAB_FOODå•æ®å¤§å°': totals['GRAB_FOODä¸šç»©'] / totals['GRAB_FOODå•æ®æ•°'] if totals['GRAB_FOODå•æ®æ•°'] > 0 else 0.0,
                    'DELIVEROOä¸šç»©': totals['DELIVEROOä¸šç»©'],
                    'DELIVEROOå•æ®æ•°': totals['DELIVEROOå•æ®æ•°'],
                    'DELIVEROOå•æ®å¤§å°': totals['DELIVEROOä¸šç»©'] / totals['DELIVEROOå•æ®æ•°'] if totals['DELIVEROOå•æ®æ•°'] > 0 else 0.0,
                    'is_daily_total': True  # æ ‡è®°ä¸ºæ¯æ—¥æ€»è®¡è¡Œ
                }
                
                data.append(daily_total_row)
            
            # æŒ‰æ—¥æœŸå’Œé—¨å¸‚æ’åº
            data.sort(key=lambda x: (x['æ—¥æœŸ'], 1 if x['é—¨å¸‚'] == 'æ¯æ—¥æ€»è®¡' else 0, x['é—¨å¸‚']))
            
            cursor.close()
            return data
            
        except Exception as e:
            return []
    
    def get_brand_period_summary(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–å“ç‰ŒæœŸé—´æ±‡æ€»åˆ†ææ•°æ®"""
        if not self.connection:
            return []
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºç­›é€‰æ¡ä»¶
            conditions = []
            
            # æ—¥æœŸç­›é€‰
            if date_from and date_to:
                conditions.append(f"s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'")
            elif month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ˜ŸæœŸç­›é€‰
            if weekday_filters and len(weekday_filters) > 0:
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
            
            # é—¨åº—ç­›é€‰
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            
            # ç±»åˆ«ç­›é€‰
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{method}'" for method in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æ„å»ºJOINå­å¥
            join_clause = f"LEFT JOIN {TABLE_ITEMS} im ON s.item_name = im.item_name"
            if payment_filters and len(payment_filters) > 0:
                join_clause += f" LEFT JOIN {TABLE_PAYMENT} p ON s.sales_no = p.sales_no AND s.store_name = p.store_name"
            
            # ä¸éœ€è¦å“ç‰Œåˆ†ç±»ï¼Œä½¿ç”¨å›ºå®šå€¼
            brand_case = "'ALL'"
            
            # è®¡ç®—æœŸé—´æ˜¾ç¤ºæ ¼å¼
            period_display = f"""
                CASE 
                    WHEN '{date_from}' IS NOT NULL AND '{date_to}' IS NOT NULL 
                    THEN CONCAT(FORMAT(CAST('{date_from}' as DATE), 'd/M'), ' - ', FORMAT(CAST('{date_to}' as DATE), 'd/M'))
                    ELSE CONCAT(FORMAT(MIN(s.c_date), 'd/M'), ' - ', FORMAT(MAX(s.c_date), 'd/M'))
                END
            """
            
            # è®¡ç®—å¤©æ•°
            days_calculation = f"""
                CASE 
                    WHEN '{date_from}' IS NOT NULL AND '{date_to}' IS NOT NULL 
                    THEN DATEDIFF(DAY, '{date_from}', '{date_to}') + 1
                    ELSE DATEDIFF(DAY, MIN(s.c_date), MAX(s.c_date)) + 1
                END
            """
            
            # æŸ¥è¯¢æœŸé—´æ±‡æ€»æ•°æ® - ä¸æœˆ-é”€å”®æ•°æ®ä¿æŒä¸€è‡´ï¼ˆä¸åŒ…å«å–æ¶ˆé¡¹ç›®å¤„ç†ï¼‰
            query = f"""
                WITH PeriodBrandData AS (
                    SELECT 
                        {period_display} as æœŸé—´,
                        s.store_name as é—¨å¸‚,
                        {brand_case} as å“ç‰Œ,
                        {days_calculation} as å¤©æ•°,
                        -- æ€»ä¸šç»©è®¡ç®— - ä¸æœˆ-é”€å”®æ•°æ®ä¿æŒä¸€è‡´
                        SUM({self.get_performance_calculation_sql()}) as æ€»ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                        -- DIä¸šç»© (take_away_item = 'N')
                        SUM(CASE WHEN s.take_away_item = 'N' THEN 
                            {self.get_performance_calculation_sql()}
                        ELSE 0 END) as DIä¸šç»©,
                        COUNT(DISTINCT CASE WHEN s.take_away_item = 'N' THEN s.sales_no END) as DIå•æ®æ•°,
                        -- å¤–å¸¦ä¸šç»© (take_away_item = 'Y' ä¸”ä¸æ˜¯é…é€æ”¯ä»˜æ–¹å¼)
                        SUM(CASE WHEN s.take_away_item = 'Y' AND (p.payment_name IS NULL OR p.payment_name NOT IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO')) THEN 
                            {self.get_performance_calculation_sql()}
                        ELSE 0 END) as å¤–å¸¦ä¸šç»©,
                        COUNT(DISTINCT CASE WHEN s.take_away_item = 'Y' AND (p.payment_name IS NULL OR p.payment_name NOT IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO')) THEN s.sales_no END) as å¤–å¸¦å•æ®æ•°,
                        -- é…é€ä¸šç»© (é€šè¿‡æ”¯ä»˜æ–¹å¼åˆ¤æ–­)
                        SUM(CASE WHEN p.payment_name IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO') THEN 
                            {self.get_performance_calculation_sql()}
                        ELSE 0 END) as é…é€ä¸šç»©,
                        COUNT(DISTINCT CASE WHEN p.payment_name IN ('GRAB FOOD', 'FOOD PANDA', 'DELIVEROO') THEN s.sales_no END) as é…é€å•æ®æ•°,
                        -- FOOD PANDAä¸šç»©
                        SUM(CASE WHEN p.payment_name = 'FOOD PANDA' THEN 
                            {self.get_performance_calculation_sql()}
                        ELSE 0 END) as FOOD_PANDAä¸šç»©,
                        COUNT(DISTINCT CASE WHEN p.payment_name = 'FOOD PANDA' THEN s.sales_no END) as FOOD_PANDAå•æ®æ•°,
                        -- GRAB FOODä¸šç»©
                        SUM(CASE WHEN p.payment_name = 'GRAB FOOD' THEN 
                            {self.get_performance_calculation_sql()}
                        ELSE 0 END) as GRAB_FOODä¸šç»©,
                        COUNT(DISTINCT CASE WHEN p.payment_name = 'GRAB FOOD' THEN s.sales_no END) as GRAB_FOODå•æ®æ•°,
                        -- DELIVEROOä¸šç»©
                        SUM(CASE WHEN p.payment_name = 'DELIVEROO' THEN 
                            {self.get_performance_calculation_sql()}
                        ELSE 0 END) as DELIVEROOä¸šç»©,
                        COUNT(DISTINCT CASE WHEN p.payment_name = 'DELIVEROO' THEN s.sales_no END) as DELIVEROOå•æ®æ•°
                    FROM {TABLE_SALES} s WITH (NOLOCK)
                    LEFT JOIN {TABLE_PAYMENT} p ON s.sales_no = p.sales_no AND s.store_name = p.store_name
                    {join_clause}
                    {where_clause}
                    GROUP BY s.store_name
                )
                SELECT 
                    æœŸé—´,
                    é—¨å¸‚,
                    å“ç‰Œ,
                    å¤©æ•°,
                    æ€»ä¸šç»©,
                    æ€»å•æ®æ•°,
                    CASE WHEN æ€»å•æ®æ•° > 0 THEN æ€»ä¸šç»© / æ€»å•æ®æ•° ELSE 0 END as æ€»å•æ®å¤§å°,
                    CASE WHEN å¤©æ•° > 0 THEN æ€»ä¸šç»© / å¤©æ•° ELSE 0 END as æ€»ä¸šç»©_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 THEN æ€»å•æ®æ•° / å¤©æ•° ELSE 0 END as æ€»å•æ®æ•°_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 AND æ€»å•æ®æ•° > 0 THEN (æ€»ä¸šç»© / æ€»å•æ®æ•°) ELSE 0 END as æ€»å•æ®å¤§å°_æ—¥å‡,
                    DIä¸šç»©,
                    DIå•æ®æ•°,
                    CASE WHEN DIå•æ®æ•° > 0 THEN DIä¸šç»© / DIå•æ®æ•° ELSE 0 END as DIå•æ®å¤§å°,
                    CASE WHEN å¤©æ•° > 0 THEN DIä¸šç»© / å¤©æ•° ELSE 0 END as DIä¸šç»©_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 THEN DIå•æ®æ•° / å¤©æ•° ELSE 0 END as DIå•æ®æ•°_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 AND DIå•æ®æ•° > 0 THEN (DIä¸šç»© / DIå•æ®æ•°) ELSE 0 END as DIå•æ®å¤§å°_æ—¥å‡,
                    å¤–å¸¦ä¸šç»©,
                    å¤–å¸¦å•æ®æ•°,
                    CASE WHEN å¤–å¸¦å•æ®æ•° > 0 THEN å¤–å¸¦ä¸šç»© / å¤–å¸¦å•æ®æ•° ELSE 0 END as å¤–å¸¦å•æ®å¤§å°,
                    CASE WHEN å¤©æ•° > 0 THEN å¤–å¸¦ä¸šç»© / å¤©æ•° ELSE 0 END as å¤–å¸¦ä¸šç»©_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 THEN å¤–å¸¦å•æ®æ•° / å¤©æ•° ELSE 0 END as å¤–å¸¦å•æ®æ•°_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 AND å¤–å¸¦å•æ®æ•° > 0 THEN (å¤–å¸¦ä¸šç»© / å¤–å¸¦å•æ®æ•°) ELSE 0 END as å¤–å¸¦å•æ®å¤§å°_æ—¥å‡,
                    é…é€ä¸šç»©,
                    é…é€å•æ®æ•°,
                    CASE WHEN é…é€å•æ®æ•° > 0 THEN é…é€ä¸šç»© / é…é€å•æ®æ•° ELSE 0 END as é…é€å•æ®å¤§å°,
                    CASE WHEN å¤©æ•° > 0 THEN é…é€ä¸šç»© / å¤©æ•° ELSE 0 END as é…é€ä¸šç»©_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 THEN é…é€å•æ®æ•° / å¤©æ•° ELSE 0 END as é…é€å•æ®æ•°_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 AND é…é€å•æ®æ•° > 0 THEN (é…é€ä¸šç»© / é…é€å•æ®æ•°) ELSE 0 END as é…é€å•æ®å¤§å°_æ—¥å‡,
                    FOOD_PANDAä¸šç»©,
                    FOOD_PANDAå•æ®æ•°,
                    CASE WHEN FOOD_PANDAå•æ®æ•° > 0 THEN FOOD_PANDAä¸šç»© / FOOD_PANDAå•æ®æ•° ELSE 0 END as FOOD_PANDAå•æ®å¤§å°,
                    CASE WHEN å¤©æ•° > 0 THEN FOOD_PANDAä¸šç»© / å¤©æ•° ELSE 0 END as FOOD_PANDAä¸šç»©_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 THEN FOOD_PANDAå•æ®æ•° / å¤©æ•° ELSE 0 END as FOOD_PANDAå•æ®æ•°_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 AND FOOD_PANDAå•æ®æ•° > 0 THEN (FOOD_PANDAä¸šç»© / FOOD_PANDAå•æ®æ•°) ELSE 0 END as FOOD_PANDAå•æ®å¤§å°_æ—¥å‡,
                    GRAB_FOODä¸šç»©,
                    GRAB_FOODå•æ®æ•°,
                    CASE WHEN GRAB_FOODå•æ®æ•° > 0 THEN GRAB_FOODä¸šç»© / GRAB_FOODå•æ®æ•° ELSE 0 END as GRAB_FOODå•æ®å¤§å°,
                    CASE WHEN å¤©æ•° > 0 THEN GRAB_FOODä¸šç»© / å¤©æ•° ELSE 0 END as GRAB_FOODä¸šç»©_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 THEN GRAB_FOODå•æ®æ•° / å¤©æ•° ELSE 0 END as GRAB_FOODå•æ®æ•°_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 AND GRAB_FOODå•æ®æ•° > 0 THEN (GRAB_FOODä¸šç»© / GRAB_FOODå•æ®æ•°) ELSE 0 END as GRAB_FOODå•æ®å¤§å°_æ—¥å‡,
                    DELIVEROOä¸šç»©,
                    DELIVEROOå•æ®æ•°,
                    CASE WHEN DELIVEROOå•æ®æ•° > 0 THEN DELIVEROOä¸šç»© / DELIVEROOå•æ®æ•° ELSE 0 END as DELIVEROOå•æ®å¤§å°,
                    CASE WHEN å¤©æ•° > 0 THEN DELIVEROOä¸šç»© / å¤©æ•° ELSE 0 END as DELIVEROOä¸šç»©_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 THEN DELIVEROOå•æ®æ•° / å¤©æ•° ELSE 0 END as DELIVEROOå•æ®æ•°_æ—¥å‡,
                    CASE WHEN å¤©æ•° > 0 AND DELIVEROOå•æ®æ•° > 0 THEN (DELIVEROOä¸šç»© / DELIVEROOå•æ®æ•°) ELSE 0 END as DELIVEROOå•æ®å¤§å°_æ—¥å‡
                FROM PeriodBrandData
                ORDER BY é—¨å¸‚, å“ç‰Œ
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            print(f"å¼€å§‹æ‰§è¡Œå“ç‰ŒæœŸé—´æ±‡æ€»æŸ¥è¯¢...")
            start_time = time.time()
            cursor.execute(query)
            results = cursor.fetchall()
            end_time = time.time()
            print(f"å“ç‰ŒæœŸé—´æ±‡æ€»æŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶: {end_time - start_time:.2f} ç§’")
            print(f"å“ç‰ŒæœŸé—´æ±‡æ€»æŸ¥è¯¢ç»“æœ: {len(results)} æ¡è®°å½•")
            
            # è½¬æ¢æ•°æ®æ ¼å¼
            data = []
            for row in results:
                data.append({
                    'æœŸé—´': row[0],
                    'é—¨å¸‚': row[1],
                    'å“ç‰Œ': row[2],
                    'å¤©æ•°': int(row[3]) if row[3] else 1,
                    'æ€»ä¸šç»©': float(row[4]) if row[4] else 0.0,
                    'æ€»å•æ®æ•°': int(row[5]) if row[5] else 0,
                    'æ€»å•æ®å¤§å°': float(row[6]) if row[6] else 0.0,
                    'æ€»ä¸šç»©_æ—¥å‡': float(row[7]) if row[7] else 0.0,
                    'æ€»å•æ®æ•°_æ—¥å‡': float(row[8]) if row[8] else 0.0,
                    'æ€»å•æ®å¤§å°_æ—¥å‡': float(row[9]) if row[9] else 0.0,
                    'DIä¸šç»©': float(row[10]) if row[10] else 0.0,
                    'DIå•æ®æ•°': int(row[11]) if row[11] else 0,
                    'DIå•æ®å¤§å°': float(row[12]) if row[12] else 0.0,
                    'DIä¸šç»©_æ—¥å‡': float(row[13]) if row[13] else 0.0,
                    'DIå•æ®æ•°_æ—¥å‡': float(row[14]) if row[14] else 0.0,
                    'DIå•æ®å¤§å°_æ—¥å‡': float(row[15]) if row[15] else 0.0,
                    'å¤–å¸¦ä¸šç»©': float(row[16]) if row[16] else 0.0,
                    'å¤–å¸¦å•æ®æ•°': int(row[17]) if row[17] else 0,
                    'å¤–å¸¦å•æ®å¤§å°': float(row[18]) if row[18] else 0.0,
                    'å¤–å¸¦ä¸šç»©_æ—¥å‡': float(row[19]) if row[19] else 0.0,
                    'å¤–å¸¦å•æ®æ•°_æ—¥å‡': float(row[20]) if row[20] else 0.0,
                    'å¤–å¸¦å•æ®å¤§å°_æ—¥å‡': float(row[21]) if row[21] else 0.0,
                    'é…é€ä¸šç»©': float(row[22]) if row[22] else 0.0,
                    'é…é€å•æ®æ•°': int(row[23]) if row[23] else 0,
                    'é…é€å•æ®å¤§å°': float(row[24]) if row[24] else 0.0,
                    'é…é€ä¸šç»©_æ—¥å‡': float(row[25]) if row[25] else 0.0,
                    'é…é€å•æ®æ•°_æ—¥å‡': float(row[26]) if row[26] else 0.0,
                    'é…é€å•æ®å¤§å°_æ—¥å‡': float(row[27]) if row[27] else 0.0,
                    'FOOD_PANDAä¸šç»©': float(row[28]) if row[28] else 0.0,
                    'FOOD_PANDAå•æ®æ•°': int(row[29]) if row[29] else 0,
                    'FOOD_PANDAå•æ®å¤§å°': float(row[30]) if row[30] else 0.0,
                    'FOOD_PANDAä¸šç»©_æ—¥å‡': float(row[31]) if row[31] else 0.0,
                    'FOOD_PANDAå•æ®æ•°_æ—¥å‡': float(row[32]) if row[32] else 0.0,
                    'FOOD_PANDAå•æ®å¤§å°_æ—¥å‡': float(row[33]) if row[33] else 0.0,
                    'GRAB_FOODä¸šç»©': float(row[34]) if row[34] else 0.0,
                    'GRAB_FOODå•æ®æ•°': int(row[35]) if row[35] else 0,
                    'GRAB_FOODå•æ®å¤§å°': float(row[36]) if row[36] else 0.0,
                    'GRAB_FOODä¸šç»©_æ—¥å‡': float(row[37]) if row[37] else 0.0,
                    'GRAB_FOODå•æ®æ•°_æ—¥å‡': float(row[38]) if row[38] else 0.0,
                    'GRAB_FOODå•æ®å¤§å°_æ—¥å‡': float(row[39]) if row[39] else 0.0,
                    'DELIVEROOä¸šç»©': float(row[40]) if row[40] else 0.0,
                    'DELIVEROOå•æ®æ•°': int(row[41]) if row[41] else 0,
                    'DELIVEROOå•æ®å¤§å°': float(row[42]) if row[42] else 0.0,
                    'DELIVEROOä¸šç»©_æ—¥å‡': float(row[43]) if row[43] else 0.0,
                    'DELIVEROOå•æ®æ•°_æ—¥å‡': float(row[44]) if row[44] else 0.0,
                    'DELIVEROOå•æ®å¤§å°_æ—¥å‡': float(row[45]) if row[45] else 0.0
                })
            
            cursor.close()
            return data
            
        except Exception as e:
            print(f"è·å–å“ç‰ŒæœŸé—´æ±‡æ€»å¤±è´¥: {e}")
            return []
    
    def get_category_analysis(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–ç±»åˆ«åˆ†ææ•°æ®"""
        if not self.connection:
            return []
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"category_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_category_cache') and cache_key in self._category_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„ç±»åˆ«åˆ†ææ•°æ®")
            return self._category_cache[cache_key]
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºç­›é€‰æ¡ä»¶
            conditions = []
            
            # æ—¥æœŸç­›é€‰
            if date_from and date_to:
                conditions.append(f"s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'")
            elif month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(s.c_date, 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ˜ŸæœŸç­›é€‰
            if weekday_filters and len(weekday_filters) > 0:
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
            
            # é—¨åº—ç­›é€‰
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            
            # ç±»åˆ«ç­›é€‰
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join([f"p.payment_name = '{method}'" for method in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
            
            # æ’é™¤WASTAGEåŠå…¶å˜ä½“ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨NOT INä»£æ›¿å¤šä¸ªLIKE
            conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æ„å»ºJOINå­å¥
            join_clause = f"LEFT JOIN {TABLE_ITEMS} im ON s.item_name = im.item_name"
            if payment_filters and len(payment_filters) > 0:
                join_clause += f" LEFT JOIN {TABLE_PAYMENT} p ON s.sales_no = p.sales_no AND s.store_name = p.store_name"
            
            # æŸ¥è¯¢ç±»åˆ«åˆ†ææ•°æ®
            query = f"""
                WITH CategoryData AS (
                    SELECT 
                        FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                        s.store_name as é—¨å¸‚,
                        ISNULL(im.category_code, 'æœªåˆ†ç±»') as ç±»åˆ«,
                        -- æ€»ä¸šç»©è®¡ç®—
                        SUM({self.get_performance_calculation_sql()}) as æ€»ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                        -- DIä¸šç»© (take_away_item = 'N')
                        SUM(CASE WHEN s.take_away_item = 'N' THEN 
                            CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - 
                            CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END
                        ELSE 0 END) as DIä¸šç»©,
                        COUNT(DISTINCT CASE WHEN s.take_away_item = 'N' THEN s.sales_no END) as DIå•æ®æ•°,
                        -- å¤–å¸¦ä¸šç»© (take_away_item = 'Y')
                        SUM(CASE WHEN s.take_away_item = 'Y' THEN 
                            CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - 
                            CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END
                        ELSE 0 END) as å¤–å¸¦ä¸šç»©,
                        COUNT(DISTINCT CASE WHEN s.take_away_item = 'Y' THEN s.sales_no END) as å¤–å¸¦å•æ®æ•°,
                        -- é…é€ä¸šç»© (æš‚æ—¶è®¾ä¸º0)
                        0.0 as é…é€ä¸šç»©,
                        0 as é…é€å•æ®æ•°,
                        -- FOOD PANDAä¸šç»© (æš‚æ—¶è®¾ä¸º0)
                        0.0 as FOOD_PANDAä¸šç»©,
                        0 as FOOD_PANDAå•æ®æ•°,
                        -- GRAB FOODä¸šç»© (æš‚æ—¶è®¾ä¸º0)
                        0.0 as GRAB_FOODä¸šç»©,
                        0 as GRAB_FOODå•æ®æ•°,
                        -- DELIVEROOä¸šç»© (æš‚æ—¶è®¾ä¸º0)
                        0.0 as DELIVEROOä¸šç»©,
                        0 as DELIVEROOå•æ®æ•°
                    FROM {TABLE_SALES} s WITH (NOLOCK)
                    {join_clause}
                    {where_clause}
                    GROUP BY FORMAT(s.c_date, 'yyyy-MM'), s.store_name, ISNULL(im.category_code, 'æœªåˆ†ç±»')
                )
                SELECT 
                    æœˆä»½,
                    é—¨å¸‚,
                    ç±»åˆ«,
                    æ€»ä¸šç»©,
                    æ€»å•æ®æ•°,
                    CASE WHEN æ€»å•æ®æ•° > 0 THEN æ€»ä¸šç»© / æ€»å•æ®æ•° ELSE 0 END as æ€»å•æ®å¤§å°,
                    DIä¸šç»©,
                    DIå•æ®æ•°,
                    CASE WHEN DIå•æ®æ•° > 0 THEN DIä¸šç»© / DIå•æ®æ•° ELSE 0 END as DIå•æ®å¤§å°,
                    å¤–å¸¦ä¸šç»©,
                    å¤–å¸¦å•æ®æ•°,
                    CASE WHEN å¤–å¸¦å•æ®æ•° > 0 THEN å¤–å¸¦ä¸šç»© / å¤–å¸¦å•æ®æ•° ELSE 0 END as å¤–å¸¦å•æ®å¤§å°,
                    é…é€ä¸šç»©,
                    é…é€å•æ®æ•°,
                    CASE WHEN é…é€å•æ®æ•° > 0 THEN é…é€ä¸šç»© / é…é€å•æ®æ•° ELSE 0 END as é…é€å•æ®å¤§å°,
                    FOOD_PANDAä¸šç»©,
                    FOOD_PANDAå•æ®æ•°,
                    CASE WHEN FOOD_PANDAå•æ®æ•° > 0 THEN FOOD_PANDAä¸šç»© / FOOD_PANDAå•æ®æ•° ELSE 0 END as FOOD_PANDAå•æ®å¤§å°,
                    GRAB_FOODä¸šç»©,
                    GRAB_FOODå•æ®æ•°,
                    CASE WHEN GRAB_FOODå•æ®æ•° > 0 THEN GRAB_FOODä¸šç»© / GRAB_FOODå•æ®æ•° ELSE 0 END as GRAB_FOODå•æ®å¤§å°,
                    DELIVEROOä¸šç»©,
                    DELIVEROOå•æ®æ•°,
                    CASE WHEN DELIVEROOå•æ®æ•° > 0 THEN DELIVEROOä¸šç»© / DELIVEROOå•æ®æ•° ELSE 0 END as DELIVEROOå•æ®å¤§å°
                FROM CategoryData
                ORDER BY æœˆä»½ DESC, é—¨å¸‚, ç±»åˆ«
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            print(f"å¼€å§‹æ‰§è¡Œç±»åˆ«åˆ†ææŸ¥è¯¢...")
            start_time = time.time()
            cursor.execute(query)
            results = cursor.fetchall()
            end_time = time.time()
            print(f"ç±»åˆ«åˆ†ææŸ¥è¯¢å®Œæˆï¼Œè€—æ—¶: {end_time - start_time:.2f} ç§’")
            print(f"ç±»åˆ«åˆ†ææŸ¥è¯¢ç»“æœ: {len(results)} æ¡è®°å½•")
            
            # è½¬æ¢æ•°æ®æ ¼å¼
            data = []
            for row in results:
                data.append({
                    'æœˆä»½': row[0],
                    'é—¨å¸‚': row[1],
                    'ç±»åˆ«': row[2],
                    'æ€»ä¸šç»©': float(row[3]) if row[3] else 0.0,
                    'æ€»å•æ®æ•°': int(row[4]) if row[4] else 0,
                    'æ€»å•æ®å¤§å°': float(row[5]) if row[5] else 0.0,
                    'DIä¸šç»©': float(row[6]) if row[6] else 0.0,
                    'DIå•æ®æ•°': int(row[7]) if row[7] else 0,
                    'DIå•æ®å¤§å°': float(row[8]) if row[8] else 0.0,
                    'å¤–å¸¦ä¸šç»©': float(row[9]) if row[9] else 0.0,
                    'å¤–å¸¦å•æ®æ•°': int(row[10]) if row[10] else 0,
                    'å¤–å¸¦å•æ®å¤§å°': float(row[11]) if row[11] else 0.0,
                    'é…é€ä¸šç»©': float(row[12]) if row[12] else 0.0,
                    'é…é€å•æ®æ•°': int(row[13]) if row[13] else 0,
                    'é…é€å•æ®å¤§å°': float(row[14]) if row[14] else 0.0,
                    'FOOD_PANDAä¸šç»©': float(row[15]) if row[15] else 0.0,
                    'FOOD_PANDAå•æ®æ•°': int(row[16]) if row[16] else 0,
                    'FOOD_PANDAå•æ®å¤§å°': float(row[17]) if row[17] else 0.0,
                    'GRAB_FOODä¸šç»©': float(row[18]) if row[18] else 0.0,
                    'GRAB_FOODå•æ®æ•°': int(row[19]) if row[19] else 0,
                    'GRAB_FOODå•æ®å¤§å°': float(row[20]) if row[20] else 0.0,
                    'DELIVEROOä¸šç»©': float(row[21]) if row[21] else 0.0,
                    'DELIVEROOå•æ®æ•°': int(row[22]) if row[22] else 0,
                    'DELIVEROOå•æ®å¤§å°': float(row[23]) if row[23] else 0.0
                })
            
            cursor.close()
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_category_cache'):
                self._category_cache = {}
            self._category_cache[cache_key] = data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._category_cache) > 10:
                # åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                oldest_key = next(iter(self._category_cache))
                del self._category_cache[oldest_key]
            
            return data
            
        except Exception as e:
            print(f"è·å–ç±»åˆ«åˆ†æå¤±è´¥: {e}")
            return []
    
    def get_weekly_product_data(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, 
                               weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–å‘¨æœŸäº§å“æ•°æ® - æŒ‰å‘¨æ˜¾ç¤ºæ•°æ®ï¼Œæ”¯æŒåˆä½µæ¨¡å¼"""
        # å¦‚æœæ˜¯åˆä½µæ¨¡å¼ï¼Œæ‰§è¡Œåˆä½µæŸ¥è¯¢
        if self.combined_mode:
            return self.get_combined_weekly_product_data(date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters)
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"weekly_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_weekly_cache') and cache_key in self._weekly_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„å‘¨æœŸäº§å“æ•°æ®")
            print(f"DEBUG: ç¼“å­˜é”®: {cache_key}")
            cached_data = self._weekly_cache[cache_key]
            print(f"DEBUG: ç¼“å­˜æ•°æ®æ¡æ•°: {len(cached_data) if cached_data else 0}")
            return cached_data
        
        try:
            cursor = self.connection.cursor()
            query = ""  # åˆå§‹åŒ–queryå˜é‡ï¼Œé¿å…åœ¨å¼‚å¸¸å¤„ç†ä¸­è®¿é—®æœªå®šä¹‰çš„å˜é‡
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            params = []
            
            # æ—¥æœŸç­›é€‰ - ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æ›¿æ¢
            if date_from and date_to:
                conditions.append(f"s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'")
            
            # é—¨åº—ç­›é€‰
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            
            # æœˆä»½ç­›é€‰
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ˜ŸæœŸç­›é€‰
            if weekday_filters and len(weekday_filters) > 0:
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
            
            # ç±»åˆ«ç­›é€‰
            join_clause = ""
            if category_filters and len(category_filters) > 0:
                join_clause = f"""
                    INNER JOIN (
                        SELECT item_name, category_code
                        FROM {TABLE_ITEMS} im1
                        WHERE im1.m_date = (
                            SELECT MAX(m_date) 
                            FROM {TABLE_ITEMS} im2 
                            WHERE im2.item_name = im1.item_name
                        )
                    ) im ON s.item_name = im.item_name
                """
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰ - ä¸¥æ ¼åŒ¹é…ï¼Œåªæœ‰å½“é”€å”®è®°å½•çš„æ‰€æœ‰æ”¯ä»˜æ–¹å¼éƒ½åœ¨ç­›é€‰åˆ—è¡¨ä¸­æ—¶æ‰åŒ…æ‹¬
            if payment_filters and len(payment_filters) > 0:
                placeholders = ','.join([f"'{payment}'" for payment in payment_filters])
                conditions.append(f"""NOT EXISTS (
                    SELECT 1 FROM {TABLE_PAYMENT} p
                    WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name
                    AND p.payment_name NOT IN ({placeholders})
                )""")
            
            # æ’é™¤wastageä¸»äº§å“ - ä¸æœŸé—´-äº§å“æ•°æ®ä¿æŒä¸€è‡´
            conditions.append("s.item_name != 'WASTAGE'")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æŸ¥è¯¢å‘¨æœŸäº§å“æ•°æ® - ä½¿ç”¨ä¸æœŸé—´-äº§å“æ•°æ®å®Œå…¨ç›¸åŒçš„é€»è¾‘ï¼Œåªæ˜¯æŒ‰å‘¨åˆ†ç»„
            query = f"""
                    SELECT 
                    CONCAT(FORMAT(DATEADD(DAY, -(DATEPART(WEEKDAY, s.c_date) - 2), CAST(s.c_date as DATE)), 'd/M'), ' - ', 
                           FORMAT(DATEADD(DAY, 6, DATEADD(DAY, -(DATEPART(WEEKDAY, s.c_date) - 2), CAST(s.c_date as DATE))), 'd/M')) as æœŸé—´,
                        s.item_name as äº§å“åç§°,
                    ISNULL(im.category_code, 'æœªåˆ†ç±»') as ç±»åˆ«,
                    7 as å¤©æ•°,
                SUM({self.get_performance_calculation_sql()} - 
                        ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                    COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                    SUM(CAST(s.qty as FLOAT) - ISNULL(CAST(c.cancel_qty as FLOAT), 0)) as é”€å”®æ€»æ•°,
                    SUM(CASE WHEN p.sales_no IS NOT NULL THEN CAST(s.qty as FLOAT) ELSE 0 END) as æŠ¥åºŸæ•°é‡,
                    SUM(CAST(s.sub_total as FLOAT)) as é”€å”®é‡‘é¢,
                    DATEPART(WEEK, s.c_date) as å‘¨æ•°
                    FROM {TABLE_SALES} s WITH (NOLOCK)
                LEFT JOIN {TABLE_ITEMS} im ON s.item_name = im.item_name
                LEFT JOIN (
                    SELECT DISTINCT store_name, sales_no
                    FROM {TABLE_PAYMENT} WITH (NOLOCK)
                    WHERE payment_name = 'WASTAGE'
                ) p ON s.store_name = p.store_name AND s.sales_no = p.sales_no
                    LEFT JOIN (
                        SELECT 
                            sales_no, 
                            store_name, 
                            item_name,
                        SUM({self._get_cancel_performance_calculation_sql()}) as cancel_amount,
                        SUM(CAST(qty as FLOAT)) as cancel_qty
                        FROM {TABLE_CANCEL} WITH (NOLOCK)
                        GROUP BY sales_no, store_name, item_name
                    ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                    {join_clause}
                    {where_clause}
                GROUP BY s.item_name, im.category_code, DATEPART(WEEK, s.c_date),
                             DATEADD(DAY, -(DATEPART(WEEKDAY, s.c_date) - 2), CAST(s.c_date as DATE))
                ORDER BY æ€»ä¸šç»© DESC
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            print(f"æ‰§è¡Œå‘¨æœŸäº§å“æ•°æ®æŸ¥è¯¢...")
            print(f"WHEREå­å¥: {where_clause}")
            print(f"SQLæŸ¥è¯¢: {query}")
            
            # æ·»åŠ æ•°æ®åº“è¿æ¥çŠ¶æ€æ£€æŸ¥
            if not self.connection:
                print("âŒ æ•°æ®åº“è¿æ¥ä¸ºç©ºï¼Œæ— æ³•æ‰§è¡ŒæŸ¥è¯¢")
                return []
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
                print(f"å‘¨æœŸäº§å“æ•°æ®æŸ¥è¯¢ç»“æœ: {len(results)} æ¡è®°å½•")
                if results:
                    print(f"ç¬¬ä¸€æ¡è®°å½•: {results[0]}")
                else:
                    print(f"æŸ¥è¯¢è¿”å›0æ¡è®°å½•ï¼Œè¯·æ£€æŸ¥ç­›é€‰æ¡ä»¶å’Œæ•°æ®åº“ä¸­çš„æ•°æ®")
                    # æ·»åŠ ä¸€ä¸ªç®€å•çš„æµ‹è¯•æŸ¥è¯¢æ¥æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ•°æ®
                    test_query = f"SELECT COUNT(*) as total_records FROM {TABLE_SALES} WHERE c_date >= '{date_from} 00:00:00' AND c_date <= '{date_to} 23:59:59'"
                    print(f"æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢: {test_query}")
                    cursor.execute(test_query)
                    test_result = cursor.fetchone()
                    print(f"æµ‹è¯•æŸ¥è¯¢ç»“æœ - è¯¥æ—¥æœŸèŒƒå›´å†…çš„æ€»è®°å½•æ•°: {test_result[0] if test_result else 0}")
            except Exception as query_error:
                print(f"âŒ SQLæŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                import traceback
                print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
                return []
            
            # è®¡ç®—æ€»è®¡æ•°æ®
            total_sales = sum(float(row[4]) if row[4] else 0.0 for row in results)
            total_receipts = sum(int(row[5]) if row[5] else 0 for row in results)
            total_quantity = sum(float(row[6]) if row[6] else 0.0 for row in results)
            total_wastage = sum(float(row[7]) if len(row) > 7 and row[7] else 0.0 for row in results)
            
            # è½¬æ¢æ•°æ®æ ¼å¼ - ä¸æœŸé—´-äº§å“æ•°æ®ä¿æŒä¸€è‡´
            data = []
            for row in results:
                sales = float(row[4]) if row[4] else 0.0
                quantity = float(row[6]) if row[6] else 0.0
                wastage_qty = float(row[7]) if len(row) > 7 and row[7] else 0.0
                amount = float(row[8]) if len(row) > 8 and row[8] else 0.0
                days = int(row[3]) if row[3] else 1
                
                sales_ratio = (sales / total_sales * 100) if total_sales > 0 else 0
                quantity_ratio = (quantity / total_quantity * 100) if total_quantity > 0 else 0
                total_qty_with_wastage = wastage_qty + quantity
                wastage_ratio = (wastage_qty / total_qty_with_wastage * 100) if total_qty_with_wastage > 0 else 0
                
                data.append({
                    'æœŸé—´': row[0],
                    'äº§å“åç§°': row[1],
                    'ç±»åˆ«': row[2],
                    'å¤©æ•°': days,
                    'æ€»ä¸šç»©': sales,
                    'æ€»å•æ®æ•°': int(row[5]) if row[5] else 0,
                    'é”€å”®æ€»æ•°': quantity,
                    'æŠ¥åºŸæ•°é‡': wastage_qty,
                    'é”€å”®é‡‘é¢': amount,
                    'ä¸šç»©å æ¯”': sales_ratio,
                    'æ•°é‡å æ¯”': quantity_ratio,
                    'æŠ¥åºŸå æ¯”': wastage_ratio,
                    'æ€»ä¸šç»©_æ—¥å‡': sales / days if days > 0 else 0,
                    'æ€»å•æ®æ•°_æ—¥å‡': (int(row[5]) if row[5] else 0) / days if days > 0 else 0,
                    'é”€å”®æ€»æ•°_æ—¥å‡': quantity / days if days > 0 else 0,
                    'æŠ¥åºŸæ•°é‡_æ—¥å‡': wastage_qty / days if days > 0 else 0,
                    'å‘¨æ•°': row[9] if len(row) > 9 else 0
                })
            
            cursor.close()
            print(f"å‘¨æœŸäº§å“æ•°æ®æŸ¥è¯¢å®Œæˆï¼Œå…± {len(data)} æ¡è®°å½•")
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_weekly_cache'):
                self._weekly_cache = {}
            self._weekly_cache[cache_key] = data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._weekly_cache) > 10:
                # åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                oldest_key = next(iter(self._weekly_cache))
                del self._weekly_cache[oldest_key]
            
            return data
            
        except Exception as e:
            print(f"è·å–å‘¨æœŸäº§å“æ•°æ®å¤±è´¥: {e}")
            print(f"SQLæŸ¥è¯¢: {query}")
            print(f"å‚æ•°: {params}")
            return []

    def get_performance_comparison(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, 
                                 weekday_filters=None, category_filters=None, payment_filters=None, 
                                 comparison_method="date", comparison_date_from=None, comparison_date_to=None, comparison_weeks=None):
        """è·å–ä¸šç»©å¯¹æ¯”åˆ†æ - æ”¯æŒå¤šç§å¯¹æ¯”æ–¹å¼"""
        try:
            cursor = self.connection.cursor()
            query = ""  # åˆå§‹åŒ–queryå˜é‡ï¼Œé¿å…åœ¨å¼‚å¸¸å¤„ç†ä¸­è®¿é—®æœªå®šä¹‰çš„å˜é‡
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            params = []
            
            # æ—¥æœŸç­›é€‰ - ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æ›¿æ¢
            if date_from and date_to:
                conditions.append(f"s.c_date >= '{date_from} 00:00:00' AND s.c_date <= '{date_to} 23:59:59'")
            
            # é—¨åº—ç­›é€‰
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            
            # æœˆä»½ç­›é€‰
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ˜ŸæœŸç­›é€‰
            if weekday_filters and len(weekday_filters) > 0:
                weekday_mapping = {
                    'Sunday': 1, 'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 
                    'Thursday': 5, 'Friday': 6, 'Saturday': 7
                }
                weekday_values = [str(weekday_mapping.get(weekday, 0)) for weekday in weekday_filters if weekday_mapping.get(weekday, 0) > 0]
                if weekday_values:
                    weekday_conditions = " OR ".join([f"DATEPART(WEEKDAY, s.c_date) = {value}" for value in weekday_values])
                    conditions.append(f"({weekday_conditions})")
            
            # ç±»åˆ«ç­›é€‰
            join_clause = ""
            if category_filters and len(category_filters) > 0:
                join_clause = f"""
                    INNER JOIN (
                        SELECT item_name, category_code
                        FROM {TABLE_ITEMS} im1
                        WHERE im1.m_date = (
                            SELECT MAX(m_date) 
                            FROM {TABLE_ITEMS} im2 
                            WHERE im2.item_name = im1.item_name
                        )
                    ) im ON s.item_name = im.item_name
                """
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰
            if payment_filters and len(payment_filters) > 0:
                payment_conditions = " OR ".join(["p.payment_name = ?" for _ in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND ({payment_conditions}))")
                params.extend(payment_filters)
            
            # ä¸šç»©å¯¹æ¯”ä¸­éœ€è¦åŒ…å«WASTAGEæ¥è®¡ç®—æŠ¥åºŸæ•°é‡ï¼Œæ‰€ä»¥ä¸æ’é™¤WASTAGE
            # conditions.append("s.item_name != 'WASTAGE'")
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # æ ¹æ®å¯¹æ¯”æ–¹å¼è®¡ç®—å¯¹æ¯”æœŸé—´
            if comparison_method == "date" and comparison_date_from and comparison_date_to:
                # å¯¹æ¯”ç‰¹å®šæ—¥æœŸèŒƒå›´
                compare_date_from_str = comparison_date_from.strftime('%Y-%m-%d')
                compare_date_to_str = comparison_date_to.strftime('%Y-%m-%d')
                period_display = f"CONCAT(FORMAT(CAST('{date_from}' as DATE), 'd/M'), ' - ', FORMAT(CAST('{date_to}' as DATE), 'd/M'))"
                compare_period_display = f"CONCAT(FORMAT(CAST('{compare_date_from_str}' as DATE), 'd/M'), ' - ', FORMAT(CAST('{compare_date_to_str}' as DATE), 'd/M'))"
                compare_where = f"CAST(s.c_date as DATE) >= '{compare_date_from_str}' AND CAST(s.c_date as DATE) <= '{compare_date_to_str}'"
            elif comparison_method == "week":
                # å¯¹æ¯”å‘¨æœŸ - æ”¯æŒå¤šé€‰
                if not comparison_weeks:
                    comparison_weeks = ["ä¸Šä¸€å‘¨æœŸ"]  # é»˜è®¤é€‰æ‹©
                
                # å½“å‰å‘¨æœŸ
                period_display = f"CONCAT(FORMAT(CAST('{date_from}' as DATE), 'd/M'), ' - ', FORMAT(CAST('{date_to}' as DATE), 'd/M'))"
                
                # æ ¹æ®é€‰æ‹©çš„å‘¨æœŸè®¡ç®—å¯¹æ¯”æœŸé—´
                if "ä¸Šä¸€å‘¨æœŸ" in comparison_weeks:
                    # ä¸Šä¸€å‘¨æœŸ
                    compare_period_display = f"CONCAT(FORMAT(DATEADD(DAY, -7, CAST('{date_from}' as DATE)), 'd/M'), ' - ', FORMAT(DATEADD(DAY, -7, CAST('{date_to}' as DATE)), 'd/M'))"
                    compare_where = f"CAST(s.c_date as DATE) >= DATEADD(DAY, -7, CAST('{date_from}' as DATE)) AND CAST(s.c_date as DATE) <= DATEADD(DAY, -7, CAST('{date_to}' as DATE))"
                elif "ä¸Šä¸ªæœˆåŒæœŸ" in comparison_weeks:
                    # ä¸Šä¸ªæœˆåŒæœŸ
                    compare_period_display = f"CONCAT(FORMAT(DATEADD(MONTH, -1, CAST('{date_from}' as DATE)), 'd/M'), ' - ', FORMAT(DATEADD(MONTH, -1, CAST('{date_to}' as DATE)), 'd/M'))"
                    compare_where = f"CAST(s.c_date as DATE) >= DATEADD(MONTH, -1, CAST('{date_from}' as DATE)) AND CAST(s.c_date as DATE) <= DATEADD(MONTH, -1, CAST('{date_to}' as DATE))"
                else:
                    # é»˜è®¤ä¸Šä¸€å‘¨æœŸ
                    compare_period_display = f"CONCAT(FORMAT(DATEADD(DAY, -7, CAST('{date_from}' as DATE)), 'd/M'), ' - ', FORMAT(DATEADD(DAY, -7, CAST('{date_to}' as DATE)), 'd/M'))"
                    compare_where = f"CAST(s.c_date as DATE) >= DATEADD(DAY, -7, CAST('{date_from}' as DATE)) AND CAST(s.c_date as DATE) <= DATEADD(DAY, -7, CAST('{date_to}' as DATE))"
            else:
                # é»˜è®¤ä¸Šä¸ªæœˆåŒæœŸ
                period_display = f"CONCAT(FORMAT(CAST('{date_from}' as DATE), 'd/M'), ' - ', FORMAT(CAST('{date_to}' as DATE), 'd/M'))"
                compare_period_display = f"CONCAT(FORMAT(DATEADD(MONTH, -1, CAST('{date_from}' as DATE)), 'd/M'), ' - ', FORMAT(DATEADD(MONTH, -1, CAST('{date_to}' as DATE)), 'd/M'))"
                compare_where = f"CAST(s.c_date as DATE) >= DATEADD(MONTH, -1, CAST('{date_from}' as DATE)) AND CAST(s.c_date as DATE) <= DATEADD(MONTH, -1, CAST('{date_to}' as DATE))"
            
            # æŸ¥è¯¢ä¸šç»©å¯¹æ¯”æ•°æ® - å®Œå…¨ç®€åŒ–ç‰ˆæœ¬é¿å…åµŒå¥—èšåˆå‡½æ•°é”™è¯¯
            query = f"""
                WITH SelectedPeriodData AS (
                    SELECT 
                        s.item_name as äº§å“åç§°,
                        {period_display} as æœŸé—´,
                        SUM({self.get_performance_calculation_sql()}) as æ€»ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®,
                        SUM({self.get_performance_calculation_sql()}) as äº§å“ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as äº§å“å•æ®,
                        SUM(CAST(s.qty as FLOAT)) as æŠ¥åºŸæ•°é‡
                    FROM {TABLE_SALES} s WITH (NOLOCK)
                    {join_clause}
                    {where_clause}
                    GROUP BY s.item_name
                ),
                ComparePeriodData AS (
                    SELECT 
                        s.item_name as äº§å“åç§°,
                        {compare_period_display} as æœŸé—´,
                        SUM({self.get_performance_calculation_sql()}) as æ€»ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®,
                        SUM({self.get_performance_calculation_sql()}) as äº§å“ä¸šç»©,
                        COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as äº§å“å•æ®,
                        SUM(CAST(s.qty as FLOAT)) as æŠ¥åºŸæ•°é‡
                    FROM {TABLE_SALES} s WITH (NOLOCK)
                    {join_clause}
                    WHERE {compare_where}
                    GROUP BY s.item_name
                )
                SELECT 
                    äº§å“åç§°,
                    æœŸé—´,
                    æ€»ä¸šç»©,
                    æ€»å•æ®,
                    CASE WHEN æ€»å•æ® > 0 THEN æ€»ä¸šç»© / æ€»å•æ® ELSE 0 END as å¹³å‡å•æ®,
                    äº§å“ä¸šç»©,
                    äº§å“å•æ®,
                    æŠ¥åºŸæ•°é‡,
                    CASE WHEN æ€»ä¸šç»© > 0 THEN (äº§å“ä¸šç»© / æ€»ä¸šç»©) * 100 ELSE 0 END as ä¸šç»©å æ¯”,
                    CASE WHEN æ€»å•æ® > 0 THEN (äº§å“å•æ® / æ€»å•æ®) * 100 ELSE 0 END as å•æ®å æ¯”
                FROM SelectedPeriodData
                UNION ALL
                SELECT 
                    äº§å“åç§°,
                    æœŸé—´,
                    æ€»ä¸šç»©,
                    æ€»å•æ®,
                    CASE WHEN æ€»å•æ® > 0 THEN æ€»ä¸šç»© / æ€»å•æ® ELSE 0 END as å¹³å‡å•æ®,
                    äº§å“ä¸šç»©,
                    äº§å“å•æ®,
                    æŠ¥åºŸæ•°é‡,
                    CASE WHEN æ€»ä¸šç»© > 0 THEN (äº§å“ä¸šç»© / æ€»ä¸šç»©) * 100 ELSE 0 END as ä¸šç»©å æ¯”,
                    CASE WHEN æ€»å•æ® > 0 THEN (äº§å“å•æ® / æ€»å•æ®) * 100 ELSE 0 END as å•æ®å æ¯”
                FROM ComparePeriodData
                ORDER BY æœŸé—´, äº§å“åç§°
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            print(f"æ‰§è¡Œä¸šç»©å¯¹æ¯”æŸ¥è¯¢...")
            print(f"WHEREå­å¥: {where_clause}")
            print(f"å‚æ•°: {params}")
            cursor.execute(query, params)
            results = cursor.fetchall()
            
            # è½¬æ¢æ•°æ®æ ¼å¼
            data = []
            for row in results:
                data.append({
                    'äº§å“åç§°': row[0],
                    'æœŸé—´': row[1],
                    'æ€»ä¸šç»©': float(row[2]) if row[2] else 0.0,
                    'æ€»å•æ®': int(row[3]) if row[3] else 0,
                    'å¹³å‡å•æ®': float(row[4]) if row[4] else 0.0,
                    'äº§å“ä¸šç»©': float(row[5]) if row[5] else 0.0,
                    'äº§å“å•æ®': int(row[6]) if row[6] else 0,
                    'æŠ¥åºŸæ•°é‡': float(row[7]) if row[7] else 0.0,
                    'ä¸šç»©å æ¯”': float(row[8]) if row[8] else 0.0,
                    'å•æ®å æ¯”': float(row[9]) if row[9] else 0.0
                })
            
            cursor.close()
            print(f"ä¸šç»©å¯¹æ¯”æŸ¥è¯¢å®Œæˆï¼Œå…± {len(data)} æ¡è®°å½•")
            return data
            
        except Exception as e:
            print(f"è·å–ä¸šç»©å¯¹æ¯”å¤±è´¥: {e}")
            print(f"SQLæŸ¥è¯¢: {query}")
            print(f"å‚æ•°: {params}")
            return []

    def get_combined_product_overview(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, 
                                    weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–åˆå¹¶çš„äº§å“æ€»è§ˆåˆ†æ - ä»æ‰€æœ‰æ•°æ®åº“åˆå¹¶æ•°æ®"""
        try:
            print("ğŸ”„ æ‰§è¡Œåˆå¹¶äº§å“æ€»è§ˆæŸ¥è¯¢...")
            
            # æ‰€æœ‰æ•°æ®åº“åˆ—è¡¨
            databases = ["sushi_gogo_pos_live", "sushi_express_pos_live", "sushi_plus_pos_live"]
            all_results = []
            
            # ä¸ºæ¯ä¸ªæ•°æ®åº“æ‰§è¡ŒæŸ¥è¯¢
            for db_name in databases:
                try:
                    print(f"ğŸ“Š æŸ¥è¯¢æ•°æ®åº“: {db_name}")
                    
                    # æ„å»ºæŸ¥è¯¢SQL
                    conditions = []
                    params = []
                    
                    # æ—¥æœŸç­›é€‰
                    if date_from and date_to:
                        conditions.append(f"CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'")
                    
                    # é—¨åº—ç­›é€‰
                    if outlet_filters:
                        outlet_conditions = " OR ".join([f"s.store_name LIKE '%{outlet}%'" for outlet in outlet_filters])
                        conditions.append(f"({outlet_conditions})")
                    
                    # äº§å“ç­›é€‰
                    if product_filters:
                        product_conditions = " OR ".join([f"s.item_name LIKE '%{product}%'" for product in product_filters])
                        conditions.append(f"({product_conditions})")
                    
                    # æ’é™¤wastage
                    conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
                    
                    where_clause = ""
                    if conditions:
                        where_clause = " WHERE " + " AND ".join(conditions)
                    
                    # æ„å»ºæŸ¥è¯¢
                    query = f"""
                        SELECT
                            s.item_name,
                            COALESCE(im.category_code, 'æœªåˆ†ç±»') as category_code,
                            SUM(s.qty) as total_qty,
                            SUM({self.get_combined_performance_calculation_sql(db_name)}) as total_amount,
                            COUNT(DISTINCT s.sales_no) as receipt_count,
                            COUNT(DISTINCT s.store_name) as store_count,
                            AVG({self.get_combined_performance_calculation_sql(db_name)}) as avg_amount
                        FROM {db_name}.dbo.{TABLE_SALES} s WITH (NOLOCK)
                        LEFT JOIN {db_name}.dbo.{TABLE_ITEMS} im WITH (NOLOCK) ON s.item_name = im.item_name
                        {where_clause}
                        GROUP BY s.item_name, COALESCE(im.category_code, 'æœªåˆ†ç±»')
                        ORDER BY total_amount DESC
                    """
                    
                    # æ‰§è¡ŒæŸ¥è¯¢
                    cursor = self.connection.cursor()
                    cursor.execute(query)
                    results = cursor.fetchall()
                    
                    # æ·»åŠ æ•°æ®åº“æ ‡è¯†
                    for row in results:
                        row_dict = {
                            'item_name': row[0],
                            'category_code': row[1],
                            'total_qty': row[2],
                            'total_amount': row[3],
                            'receipt_count': row[4],
                            'store_count': row[5],
                            'avg_amount': row[6],
                            'database': db_name
                        }
                        all_results.append(row_dict)
                    
                    cursor.close()
                    print(f"âœ… {db_name}: è·å–åˆ° {len(results)} æ¡äº§å“è®°å½•")
                    
                except Exception as e:
                    print(f"âŒ æŸ¥è¯¢æ•°æ®åº“ {db_name} å¤±è´¥: {e}")
                    continue
            
            # åˆå¹¶ç›¸åŒäº§å“çš„æ•°æ®
            merged_results = {}
            for result in all_results:
                key = f"{result['item_name']}_{result['category_code']}"
                if key not in merged_results:
                    merged_results[key] = {
                        'item_name': result['item_name'],
                        'category_code': result['category_code'],
                        'total_qty': 0,
                        'total_amount': 0,
                        'receipt_count': 0,
                        'store_count': set(),
                        'avg_amount': 0,
                        'databases': []
                    }
                
                merged_results[key]['total_qty'] += float(result['total_qty'])
                merged_results[key]['total_amount'] += float(result['total_amount'])
                # ä¿®å¾©ï¼šä¸è¦ç´¯åŠ å–®æ“šæ•¸ï¼Œå› ç‚ºåŒä¸€å¼µå–®æ“šå¯èƒ½æœ‰å¤šå€‹ç”¢å“
                # merged_results[key]['receipt_count'] += int(result['receipt_count'])
                merged_results[key]['store_count'].add(result['database'])
                merged_results[key]['databases'].append(result['database'])
            
            # è½¬æ¢æœ€ç»ˆç»“æœ
            final_results = []
            for key, data in merged_results.items():
                final_results.append({
                    'item_name': data['item_name'],
                    'category_code': data['category_code'],
                    'total_qty': data['total_qty'],
                    'total_amount': data['total_amount'],
                    'receipt_count': data['receipt_count'],
                    'store_count': len(data['store_count']),
                    'avg_amount': data['total_amount'] / data['total_qty'] if data['total_qty'] > 0 else 0,
                    'databases': list(set(data['databases']))
                })
            
            # æŒ‰æ€»é‡‘é¢æ’åº
            final_results.sort(key=lambda x: x['total_amount'], reverse=True)
            
            print(f"âœ… åˆå¹¶å®Œæˆ: æ€»å…± {len(final_results)} ä¸ªäº§å“")
            return final_results
            
        except Exception as e:
            print(f"âŒ åˆå¹¶äº§å“æ€»è§ˆæŸ¥è¯¢å¤±è´¥: {e}")
            return []

    def get_combined_sales_data(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, search_term=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–åˆå¹¶çš„é”€å”®æ•°æ® - ä»æ‰€æœ‰æ•°æ®åº“åˆå¹¶æ•°æ®"""
        try:
            print("ğŸ”„ æ‰§è¡Œåˆå¹¶é”€å”®æ•°æ®æŸ¥è¯¢...")
            
            # æ‰€æœ‰æ•°æ®åº“åˆ—è¡¨
            databases = ["sushi_gogo_pos_live", "sushi_express_pos_live", "sushi_plus_pos_live"]
            all_results = []
            
            # ä¸ºæ¯ä¸ªæ•°æ®åº“æ‰§è¡ŒæŸ¥è¯¢
            for db_name in databases:
                try:
                    print(f"ğŸ“Š æŸ¥è¯¢æ•°æ®åº“: {db_name}")
                    
                    # æ„å»ºæŸ¥è¯¢SQL
                    conditions = []
                    
                    # æ—¥æœŸç­›é€‰
                    if date_from and date_to:
                        conditions.append(f"CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'")
                    
                    # é—¨åº—ç­›é€‰
                    if outlet_filters:
                        outlet_conditions = " OR ".join([f"s.store_name LIKE '%{outlet}%'" for outlet in outlet_filters])
                        conditions.append(f"({outlet_conditions})")
                    
                    # äº§å“ç­›é€‰
                    if product_filters:
                        product_conditions = " OR ".join([f"s.item_name LIKE '%{product}%'" for product in product_filters])
                        conditions.append(f"({product_conditions})")
                    
                    # æœç´¢è¯ç­›é€‰
                    if search_term:
                        conditions.append(f"(s.item_name LIKE '%{search_term}%' OR s.store_name LIKE '%{search_term}%')")
                    
                    # æ’é™¤wastage
                    conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
                    
                    where_clause = ""
                    if conditions:
                        where_clause = " WHERE " + " AND ".join(conditions)
                    
                    # æ„å»ºæŸ¥è¯¢
                    query = f"""
                        SELECT
                            s.store_name,
                            s.sales_no,
                            s.item_name,
                            s.qty,
                            s.disc_amt,
                            s.disc_name,
                            s.pro_disc_amt,
                            s.sub_total,
                            s.svc_amt,
                            s.tax_amt,
                            s.c_date,
                            s.order_datetime,
                            {self.get_combined_performance_calculation_sql(db_name)} as total_amt,
                            COALESCE(im.category_code, 'æœªåˆ†ç±»') as category_code
                        FROM {db_name}.dbo.{TABLE_SALES} s WITH (NOLOCK)
                        LEFT JOIN {db_name}.dbo.{TABLE_ITEMS} im WITH (NOLOCK) ON s.item_name = im.item_name
                        {where_clause}
                        ORDER BY s.c_date DESC, s.store_name, s.sales_no
                    """
                    
                    # æ‰§è¡ŒæŸ¥è¯¢
                    cursor = self.connection.cursor()
                    cursor.execute(query)
                    results = cursor.fetchall()
                    
                    # æ·»åŠ æ•°æ®åº“æ ‡è¯†
                    for row in results:
                        row_dict = {
                            'store_name': row[0],
                            'sales_no': row[1],
                            'item_name': row[2],
                            'qty': row[3],
                            'disc_amt': row[4],
                            'disc_name': row[5],
                            'pro_disc_amt': row[6],
                            'sub_total': row[7],
                            'svc_amt': row[8],
                            'tax_amt': row[9],
                            'c_date': row[10],
                            'order_datetime': row[11],
                            'total_amt': row[12],
                            'category_code': row[13],
                            'database': db_name
                        }
                        all_results.append(row_dict)
                    
                    cursor.close()
                    print(f"âœ… {db_name}: è·å–åˆ° {len(results)} æ¡é”€å”®è®°å½•")
                    
                except Exception as e:
                    print(f"âŒ æŸ¥è¯¢æ•°æ®åº“ {db_name} å¤±è´¥: {e}")
                    continue
            
            print(f"âœ… åˆå¹¶å®Œæˆ: æ€»å…± {len(all_results)} æ¡é”€å”®è®°å½•")
            return all_results
            
        except Exception as e:
            print(f"âŒ åˆå¹¶é”€å”®æ•°æ®æŸ¥è¯¢å¤±è´¥: {e}")
            return []

    def get_combined_outlets(self):
        """è·å–åˆå¹¶çš„é—¨å¸‚åˆ—è¡¨ - ä»æ‰€æœ‰æ•°æ®åº“åˆå¹¶æ•°æ®"""
        try:
            print("ğŸ”„ æ‰§è¡Œåˆå¹¶é—¨å¸‚åˆ—è¡¨æŸ¥è¯¢...")
            
            # æ‰€æœ‰æ•°æ®åº“åˆ—è¡¨
            databases = ["sushi_gogo_pos_live", "sushi_express_pos_live", "sushi_plus_pos_live"]
            all_outlets = set()
            
            # ä¸ºæ¯ä¸ªæ•°æ®åº“æ‰§è¡ŒæŸ¥è¯¢
            for db_name in databases:
                try:
                    print(f"ğŸ“Š æŸ¥è¯¢æ•°æ®åº“: {db_name}")
                    
                    # æ„å»ºæŸ¥è¯¢
                    query = f"""
                        SELECT DISTINCT store_name 
                        FROM {db_name}.dbo.{TABLE_SALES} 
                        WHERE store_name IS NOT NULL AND store_name != ''
                        ORDER BY store_name
                    """
                    
                    # æ‰§è¡ŒæŸ¥è¯¢
                    cursor = self.connection.cursor()
                    cursor.execute(query)
                    results = cursor.fetchall()
                    
                    # æ·»åŠ åˆ°é›†åˆä¸­
                    for row in results:
                        if row[0]:
                            all_outlets.add(row[0])
                    
                    cursor.close()
                    print(f"âœ… {db_name}: è·å–åˆ° {len(results)} ä¸ªé—¨å¸‚")
                    
                except Exception as e:
                    print(f"âŒ æŸ¥è¯¢æ•°æ®åº“ {db_name} å¤±è´¥: {e}")
                    continue
            
            # è½¬æ¢ä¸ºæ’åºåˆ—è¡¨
            combined_outlets = sorted(list(all_outlets))
            self.outlets = combined_outlets
            
            print(f"âœ… åˆå¹¶å®Œæˆ: æ€»å…± {len(combined_outlets)} ä¸ªé—¨å¸‚")
            return combined_outlets
            
        except Exception as e:
            print(f"âŒ åˆå¹¶é—¨å¸‚åˆ—è¡¨æŸ¥è¯¢å¤±è´¥: {e}")
            return []

    def get_combined_period_product_overview(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, 
                                           weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–åˆå¹¶çš„æœŸé—´äº§å“æ€»è§ˆåˆ†æ - ä»æ‰€æœ‰æ•°æ®åº“åˆå¹¶æ•°æ®"""
        try:
            print("ğŸ”„ æ‰§è¡Œåˆå¹¶æœŸé—´äº§å“æ€»è§ˆæŸ¥è¯¢...")
            
            # æ‰€æœ‰æ•°æ®åº“åˆ—è¡¨
            databases = ["sushi_gogo_pos_live", "sushi_express_pos_live", "sushi_plus_pos_live"]
            all_results = []
            
            # ä¸ºæ¯ä¸ªæ•°æ®åº“æ‰§è¡ŒæŸ¥è¯¢
            for db_name in databases:
                try:
                    print(f"ğŸ“Š æŸ¥è¯¢æ•°æ®åº“: {db_name}")
                    
                    # æ„å»ºæŸ¥è¯¢SQL
                    conditions = []
                    
                    # æ—¥æœŸç­›é€‰
                    if date_from and date_to:
                        conditions.append(f"CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'")
                    
                    # é—¨åº—ç­›é€‰
                    if outlet_filters:
                        outlet_conditions = " OR ".join([f"s.store_name LIKE '%{outlet}%'" for outlet in outlet_filters])
                        conditions.append(f"({outlet_conditions})")
                    
                    # äº§å“ç­›é€‰
                    if product_filters:
                        product_conditions = " OR ".join([f"s.item_name LIKE '%{product}%'" for product in product_filters])
                        conditions.append(f"({product_conditions})")
                    
                    # æ’é™¤wastage
                    conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
                    
                    where_clause = ""
                    if conditions:
                        where_clause = " WHERE " + " AND ".join(conditions)
                    
                    # æœŸé—´æ˜¾ç¤º
                    if date_from and date_to:
                        period_display = f"'{date_from} åˆ° {date_to}'"
                        days_calculation = f"DATEDIFF(day, '{date_from}', '{date_to}') + 1"
                    else:
                        period_display = "'å…¨éƒ¨æœŸé—´'"
                        days_calculation = "COUNT(DISTINCT CAST(s.c_date as DATE))"
                    
                    # æ„å»ºæŸ¥è¯¢
                    query = f"""
                        SELECT
                            {period_display} as æœŸé—´,
                            s.item_name as äº§å“åç§°,
                            ISNULL(im.category_code, 'æœªåˆ†ç±»') as ç±»åˆ«,
                            SUM(s.qty - ISNULL(CAST(c.cancel_qty as FLOAT), 0)) as é”€å”®æ•°é‡,
                            SUM({self.get_combined_performance_calculation_sql(db_name)} - ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                            COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as å•æ®æ•°,
                            COUNT(DISTINCT s.store_name) as é—¨å¸‚æ•°,
                            AVG({self.get_combined_performance_calculation_sql(db_name)} - ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as å¹³å‡ä¸šç»©,
                            SUM(s.qty - ISNULL(CAST(c.cancel_qty as FLOAT), 0)) / {days_calculation} as é”€å”®æ•°é‡_æ—¥å‡,
                            SUM({self.get_combined_performance_calculation_sql(db_name)} - ISNULL(CAST(c.cancel_amount as FLOAT), 0)) / {days_calculation} as æ€»ä¸šç»©_æ—¥å‡,
                            COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) / {days_calculation} as å•æ®æ•°_æ—¥å‡
                        FROM {db_name}.dbo.{TABLE_SALES} s WITH (NOLOCK)
                        LEFT JOIN {db_name}.dbo.{TABLE_ITEMS} im WITH (NOLOCK) ON s.item_name = im.item_name
                        LEFT JOIN (
                            SELECT 
                                sales_no, 
                                store_name, 
                                item_name,
                                SUM({self.get_combined_cancel_performance_calculation_sql(db_name)}) as cancel_amount,
                                SUM(CAST(qty as FLOAT)) as cancel_qty
                            FROM {db_name}.dbo.{TABLE_CANCEL} WITH (NOLOCK)
                            GROUP BY sales_no, store_name, item_name
                        ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                        {where_clause}
                        GROUP BY s.item_name, im.category_code
                        ORDER BY æ€»ä¸šç»© DESC
                    """
                    
                    # æ‰§è¡ŒæŸ¥è¯¢
                    cursor = self.connection.cursor()
                    cursor.execute(query)
                    results = cursor.fetchall()
                    
                    # æ·»åŠ æ•°æ®åº“æ ‡è¯†
                    for row in results:
                        row_dict = {
                            'æœŸé—´': row[0],
                            'äº§å“åç§°': row[1],
                            'ç±»åˆ«': row[2],
                            'é”€å”®æ•°é‡': row[3],
                            'æ€»ä¸šç»©': row[4],
                            'å•æ®æ•°': row[5],
                            'é—¨å¸‚æ•°': row[6],
                            'å¹³å‡ä¸šç»©': row[7],
                            'é”€å”®æ•°é‡_æ—¥å‡': row[8],
                            'æ€»ä¸šç»©_æ—¥å‡': row[9],
                            'å•æ®æ•°_æ—¥å‡': row[10],
                            'database': db_name
                        }
                        all_results.append(row_dict)
                    
                    cursor.close()
                    print(f"âœ… {db_name}: è·å–åˆ° {len(results)} æ¡æœŸé—´äº§å“è®°å½•")
                    
                except Exception as e:
                    print(f"âŒ æŸ¥è¯¢æ•°æ®åº“ {db_name} å¤±è´¥: {e}")
                    continue
            
            # åˆå¹¶ç›¸åŒäº§å“çš„æ•°æ®
            merged_results = {}
            for result in all_results:
                key = f"{result['äº§å“åç§°']}_{result['ç±»åˆ«']}"
                if key not in merged_results:
                    merged_results[key] = {
                        'æœŸé—´': result['æœŸé—´'],
                        'äº§å“åç§°': result['äº§å“åç§°'],
                        'ç±»åˆ«': result['ç±»åˆ«'],
                        'é”€å”®æ•°é‡': 0,
                        'æ€»ä¸šç»©': 0,
                        'å•æ®æ•°': 0,
                        'é—¨å¸‚æ•°': set(),
                        'å¹³å‡ä¸šç»©': 0,
                        'é”€å”®æ•°é‡_æ—¥å‡': 0,
                        'æ€»ä¸šç»©_æ—¥å‡': 0,
                        'å•æ®æ•°_æ—¥å‡': 0,
                        'databases': []
                    }
                
                merged_results[key]['é”€å”®æ•°é‡'] += float(result['é”€å”®æ•°é‡'])
                merged_results[key]['æ€»ä¸šç»©'] += float(result['æ€»ä¸šç»©'])
                # ä¿®å¾©ï¼šä¸è¦ç´¯åŠ å–®æ“šæ•¸ï¼Œå› ç‚ºåŒä¸€å¼µå–®æ“šå¯èƒ½æœ‰å¤šå€‹ç”¢å“
                # merged_results[key]['å•æ®æ•°'] += int(result['å•æ®æ•°'])
                merged_results[key]['é—¨å¸‚æ•°'].add(result['database'])
                merged_results[key]['databases'].append(result['database'])
            
            # ä¿®å¾©ï¼šé‡æ–°è¨ˆç®—æ­£ç¢ºçš„å–®æ“šæ•¸
            for key, data in merged_results.items():
                product_name = data['äº§å“åç§°']
                category = data['ç±»åˆ«']
                
                # é‡æ–°æŸ¥è©¢è©²ç”¢å“çš„å¯¦éš›å–®æ“šæ•¸
                total_receipt_count = 0
                for db_name in databases:
                    try:
                        # æ§‹å»ºæŸ¥è©¢æ¢ä»¶
                        conditions = [f"s.item_name = '{product_name}'"]
                        if date_from and date_to:
                            conditions.append(f"CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'")
                        if outlet_filters:
                            outlet_conditions = " OR ".join([f"s.store_name LIKE '%{outlet}%'" for outlet in outlet_filters])
                            conditions.append(f"({outlet_conditions})")
                        
                        where_clause = " WHERE " + " AND ".join(conditions)
                        
                        receipt_query = f"""
                            SELECT COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as å•æ®æ•°
                            FROM {db_name}.dbo.{TABLE_SALES} s WITH (NOLOCK)
                            {where_clause}
                            AND s.item_name != 'WASTAGE'
                        """
                        
                        cursor = self.connection.cursor()
                        cursor.execute(receipt_query)
                        result = cursor.fetchone()
                        cursor.close()
                        
                        if result and result[0]:
                            total_receipt_count += int(result[0])
                            
                    except Exception as e:
                        print(f"è¨ˆç®—ç”¢å“ {product_name} åœ¨ {db_name} çš„å–®æ“šæ•¸å¤±æ•—: {e}")
                        continue
                
                data['å•æ®æ•°'] = total_receipt_count
            
            # è½¬æ¢æœ€ç»ˆç»“æœ
            final_results = []
            for key, data in merged_results.items():
                final_results.append({
                    'æœŸé—´': data['æœŸé—´'],
                    'äº§å“åç§°': data['äº§å“åç§°'],
                    'ç±»åˆ«': data['ç±»åˆ«'],
                    'é”€å”®æ•°é‡': data['é”€å”®æ•°é‡'],
                    'æ€»ä¸šç»©': data['æ€»ä¸šç»©'],
                    'æ€»å•æ®æ•°': data['å•æ®æ•°'],  # ä½¿ç”¨æ­£ç¡®çš„å­—æ®µåç§°
                    'é—¨å¸‚æ•°': len(data['é—¨å¸‚æ•°']),
                    'å¹³å‡ä¸šç»©': data['æ€»ä¸šç»©'] / data['é”€å”®æ•°é‡'] if data['é”€å”®æ•°é‡'] > 0 else 0,
                    'é”€å”®æ•°é‡_æ—¥å‡': data['é”€å”®æ•°é‡_æ—¥å‡'],
                    'æ€»ä¸šç»©_æ—¥å‡': data['æ€»ä¸šç»©_æ—¥å‡'],
                    'æ€»å•æ®æ•°_æ—¥å‡': data['å•æ®æ•°_æ—¥å‡'],  # ä½¿ç”¨æ­£ç¡®çš„å­—æ®µåç§°
                    'databases': list(set(data['databases']))
                })
            
            # æŒ‰æ€»ä¸šç»©æ’åº
            final_results.sort(key=lambda x: x['æ€»ä¸šç»©'], reverse=True)
            
            print(f"âœ… åˆå¹¶å®Œæˆ: æ€»å…± {len(final_results)} ä¸ªæœŸé—´äº§å“")
            return final_results
            
        except Exception as e:
            print(f"âŒ åˆå¹¶æœŸé—´äº§å“æ€»è§ˆæŸ¥è¯¢å¤±è´¥: {e}")
            return []

    def get_product_overview(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, 
                           weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–äº§å“æ€»è§ˆåˆ†æ - æ”¯æŒåˆä½µæ¨¡å¼"""
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"product_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{product_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_product_cache') and cache_key in self._product_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„äº§å“æ€»è§ˆæ•°æ®")
            return self._product_cache[cache_key]
        
        # å¦‚æœæ˜¯çµ„åˆæ¨¡å¼ï¼ŒåŸ·è¡Œåˆä½µæŸ¥è©¢
        if self.combined_mode:
            return self.get_combined_product_overview(date_from, date_to, outlet_filters, product_filters, 
                                                     month_filters, weekday_filters, category_filters, payment_filters)
        
        try:
            cursor = self.connection.cursor()
            query = ""  # åˆå§‹åŒ–queryå˜é‡ï¼Œé¿å…åœ¨å¼‚å¸¸å¤„ç†ä¸­è®¿é—®æœªå®šä¹‰çš„å˜é‡
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            params = []
            
            # æ—¥æœŸç­›é€‰
            if date_from and date_to:
                # ä½¿ç”¨CASTç¡®ä¿æ—¥æœŸæ ¼å¼åŒ¹é…
                conditions.append("CAST(s.c_date as DATE) >= ? AND CAST(s.c_date as DATE) <= ?")
                params.extend([date_from, date_to])
            
            # é—¨åº—ç­›é€‰
            if outlet_filters:
                placeholders = ','.join(['?' for _ in outlet_filters])
                conditions.append(f"s.store_name IN ({placeholders})")
                params.extend(outlet_filters)
            
            # æœˆä»½ç­›é€‰
            if month_filters:
                month_conditions = []
                for month in month_filters:
                    month_conditions.append("FORMAT(s.c_date, 'yyyy-MM') = ?")
                    params.append(month)
                conditions.append(f"({' OR '.join(month_conditions)})")
            
            # æ˜ŸæœŸç­›é€‰
            if weekday_filters:
                weekday_conditions = []
                weekday_map = {
                    'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 'Thursday': 5, 
                    'Friday': 6, 'Saturday': 7, 'Sunday': 1
                }
                for weekday in weekday_filters:
                    if weekday in weekday_map:
                        weekday_conditions.append(f"DATEPART(WEEKDAY, s.c_date) = {weekday_map[weekday]}")
                if weekday_conditions:
                    conditions.append(f"({' OR '.join(weekday_conditions)})")
            
            # ç±»åˆ«ç­›é€‰
            if category_filters:
                placeholders = ','.join(['?' for _ in category_filters])
                conditions.append(f"im.category_code IN ({placeholders})")
                params.extend(category_filters)
            
            # äº§å“ç­›é€‰
            if product_filters:
                placeholders = ','.join(['?' for _ in product_filters])
                conditions.append(f"s.item_name IN ({placeholders})")
                params.extend(product_filters)
            
            # æ”¯ä»˜æ–¹å¼ç­›é€‰
            if payment_filters:
                placeholders = ','.join(['?' for _ in payment_filters])
                conditions.append(f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE s.sales_no = p.sales_no AND s.store_name = p.store_name AND p.payment_name IN ({placeholders}))")
                params.extend(payment_filters)
            
            # æ’é™¤wastage
            conditions.append("s.item_name != 'WASTAGE'")
            
            # æ„å»ºWHEREå­å¥
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # è®¡ç®—æœŸé—´æ˜¾ç¤º
            if date_from and date_to:
                period_display = f"'{date_from.split('-')[2]}/{date_from.split('-')[1]} - {date_to.split('-')[2]}/{date_to.split('-')[1]}'"
                days_calculation = f"DATEDIFF(day, '{date_from}', '{date_to}') + 1"
            else:
                period_display = "FORMAT(s.c_date, 'yyyy-MM')"
                days_calculation = "1"
            
            # å…ˆæ‰§è¡Œä¸€ä¸ªç®€å•çš„æµ‹è¯•æŸ¥è¯¢æ¥æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨
            test_query = f"""
                SELECT TOP 5 
                    s.c_date,
                    s.item_name,
                    s.sub_total,
                    s.qty,
                    s.sales_no
                FROM {TABLE_SALES} s WITH (NOLOCK)
                WHERE s.item_name != 'WASTAGE'
                {f"AND CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'" if date_from and date_to else ""}
                ORDER BY s.c_date DESC
            """
            
            print(f"æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢...")
            cursor.execute(test_query)
            test_rows = cursor.fetchall()
            print(f"æµ‹è¯•æŸ¥è¯¢ç»“æœ: {len(test_rows)} æ¡è®°å½•")
            if test_rows:
                print(f"ç¬¬ä¸€æ¡æµ‹è¯•è®°å½•: {test_rows[0]}")
            else:
                print("âŒ æµ‹è¯•æŸ¥è¯¢æ²¡æœ‰è¿”å›æ•°æ®ï¼Œå¯èƒ½æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰æ•°æ®")
                return []
            
            # ç›´æ¥å¾SQL Serverç²å–æŒ‡å®šæ—¥æœŸç¯„åœçš„ç”¢å“å–®æ“šæ¥­ç¸¾
            receipt_performance_data = self.get_product_receipt_performance_from_db(
                date_from=date_from, 
                date_to=date_to, 
                outlet_filters=outlet_filters,  # å‚³éé–€å¸‚ç¯©é¸
                product_filters=None,  # ä¸ä½¿ç”¨ç”¢å“éæ¿¾å™¨
                database_source=self.current_database
            )
            
            # æ„å»ºSQLæŸ¥è¯¢ - æŒ‰å¤©èšåˆäº§å“æ•°æ®ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
            query = f"""
                SELECT 
                    CAST(s.c_date as DATE) as æ—¥æœŸ,
                    FORMAT(s.c_date, 'yyyy-MM') as æœˆä»½,
                    s.store_name as é—¨å¸‚,
                    s.item_name as äº§å“åç§°,
                    ISNULL(im.category_code, 'æœªåˆ†ç±»') as ç±»åˆ«,
                    SUM({self.get_performance_calculation_sql()}) as æ€»ä¸šç»©,
                    COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                    SUM(CAST(s.qty as FLOAT)) as é”€å”®æ€»æ•°,
                    SUM(CASE WHEN w.sales_no IS NOT NULL THEN CAST(s.qty as FLOAT) ELSE 0 END) as æŠ¥åºŸæ•°é‡,
                    SUM(CAST(s.sub_total as FLOAT)) as é”€å”®é‡‘é¢,
                    0 as äº§å“å•æ®ä¸šç»©
                FROM {TABLE_SALES} s WITH (NOLOCK)
                LEFT JOIN {TABLE_ITEMS} im ON s.item_name = im.item_name
                LEFT JOIN (
                    SELECT DISTINCT store_name, sales_no
                    FROM {TABLE_PAYMENT} WITH (NOLOCK)
                    WHERE payment_name = 'WASTAGE'
                ) w ON s.store_name = w.store_name AND s.sales_no = w.sales_no
                {where_clause}
                GROUP BY CAST(s.c_date as DATE), FORMAT(s.c_date, 'yyyy-MM'), s.store_name, s.item_name, im.category_code
                ORDER BY æ—¥æœŸ DESC, s.store_name, s.item_name
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            print(f"æ‰§è¡Œäº§å“æ€»è§ˆæŸ¥è¯¢...")
            print(f"WHEREå­å¥: {where_clause}")
            print(f"å‚æ•°: {params}")
            cursor.execute(query, params)
            rows = cursor.fetchall()
            
            # ä¿®å¾©ï¼šæŒ‰æ—¥æœŸå’Œé–€å¸‚åˆ†çµ„è¨ˆç®—ç¸½è¨ˆæ•¸æ“š
            # å…ˆç²å–ç”¢å“å–®æ“šæ¥­ç¸¾æ•¸æ“š
            receipt_performance_data_all = self.get_product_receipt_performance_from_db(
                date_from=date_from, 
                date_to=date_to, 
                outlet_filters=outlet_filters,
                product_filters=None  # æŸ¥è©¢æ‰€æœ‰ç”¢å“
            )
            
            # æŒ‰æ—¥æœŸå’Œé–€å¸‚åˆ†çµ„è¨ˆç®—ç¸½è¨ˆ
            daily_store_totals = {}  # key: (date, store), value: {sales, quantity, receipt_performance}
            daily_all_totals = {}    # key: date, value: {sales, quantity, receipt_performance} - ç”¨æ–¼ "All" é–€å¸‚
            
            for row in rows:
                row_date = row[0]      # æ—¥æœŸ
                store_name = row[2]    # é—¨å¸‚
                sales = float(row[5]) if row[5] else 0.0  # æ€»ä¸šç»©
                quantity = float(row[7]) if row[7] else 0.0  # é”€å”®æ€»æ•°
                
                # ä½¿ç”¨çµ„åˆéµä¾†ç²å–è©²ç”¢å“åœ¨è©²æ—¥æœŸå’Œé–€å¸‚ä¸‹çš„ç”¢å“å–®æ“šæ¥­ç¸¾
                product_name = row[3]  # äº§å“åç§°
                key = f"{product_name}_{row_date}_{store_name}"
                product_receipt_performance = 0.0
                if key in receipt_performance_data_all:
                    product_receipt_performance = receipt_performance_data_all[key]['äº§å“å•æ®ä¸šç»©']
                
                # ç´¯åŠ åˆ°è©²æ—¥æœŸå’Œé–€å¸‚çš„ç¸½è¨ˆ
                daily_store_key = (row_date, store_name)
                if daily_store_key not in daily_store_totals:
                    daily_store_totals[daily_store_key] = {
                        'sales': 0.0,
                        'quantity': 0.0,
                        'receipt_performance': 0.0
                    }
                
                daily_store_totals[daily_store_key]['sales'] += sales
                daily_store_totals[daily_store_key]['quantity'] += quantity
                daily_store_totals[daily_store_key]['receipt_performance'] += product_receipt_performance
                
                # åŒæ™‚ç´¯åŠ åˆ°è©²æ—¥æœŸçš„ "All" ç¸½è¨ˆ
                if row_date not in daily_all_totals:
                    daily_all_totals[row_date] = {
                        'sales': 0.0,
                        'quantity': 0.0,
                        'receipt_performance': 0.0
                    }
                
                daily_all_totals[row_date]['sales'] += sales
                daily_all_totals[row_date]['quantity'] += quantity
                daily_all_totals[row_date]['receipt_performance'] += product_receipt_performance
            
            
            # ç°åœ¨å¤„ç†æ•°æ®å¹¶è®¡ç®—å æ¯”
            data = []
            for row in rows:
                sales = float(row[5]) if row[5] else 0.0  # æ€»ä¸šç»©
                quantity = float(row[7]) if row[7] else 0.0  # é”€å”®æ€»æ•°
                wastage_qty = float(row[8]) if row[8] else 0.0  # æŠ¥åºŸæ•°é‡
                amount = float(row[9]) if row[9] else 0.0  # é”€å”®é‡‘é¢
                product_name = row[3]  # äº§å“åç§°
                
                # ä½¿ç”¨çµ„åˆéµä¾†ç²å–è©²ç”¢å“åœ¨è©²æ—¥æœŸå’Œé–€å¸‚ä¸‹çš„ç”¢å“å–®æ“šæ¥­ç¸¾
                row_date = row[0]
                store_name = row[2]
                key = f"{product_name}_{row_date}_{store_name}"
                product_receipt_performance = 0.0
                if key in receipt_performance_data_all:
                    product_receipt_performance = receipt_performance_data_all[key]['äº§å“å•æ®ä¸šç»©']
                
                # ç²å–è©²æ—¥æœŸå’Œé–€å¸‚çš„ç¸½è¨ˆæ•¸æ“š
                if store_name == 'All':
                    # å°æ–¼ "All" é–€å¸‚ï¼Œä½¿ç”¨è©²æ—¥æœŸçš„æ‰€æœ‰é–€å¸‚ç¸½è¨ˆ
                    daily_totals = daily_all_totals.get(row_date, {
                        'sales': 0.0, 'quantity': 0.0, 'receipt_performance': 0.0
                    })
                else:
                    # å°æ–¼å…·é«”é–€å¸‚ï¼Œä½¿ç”¨è©²æ—¥æœŸå’Œé–€å¸‚çš„ç¸½è¨ˆ
                    daily_store_key = (row_date, store_name)
                    daily_totals = daily_store_totals.get(daily_store_key, {
                        'sales': 0.0, 'quantity': 0.0, 'receipt_performance': 0.0
                    })
                
                # è®¡ç®—å æ¯”ï¼ˆåŸºæ–¼è©²æ—¥æœŸå’Œé–€å¸‚çš„ç¸½è¨ˆï¼‰
                sales_ratio = (sales / daily_totals['sales'] * 100) if daily_totals['sales'] > 0 else 0
                quantity_ratio = (quantity / daily_totals['quantity'] * 100) if daily_totals['quantity'] > 0 else 0
                product_receipt_performance_ratio = (product_receipt_performance / daily_totals['receipt_performance'] * 100) if daily_totals['receipt_performance'] > 0 else 0
                
                
                total_qty_with_wastage = wastage_qty + quantity
                wastage_ratio = (wastage_qty / total_qty_with_wastage * 100) if total_qty_with_wastage > 0 else 0
                
                data.append({
                    'æ—¥æœŸ': row[0].strftime('%Y-%m-%d') if hasattr(row[0], 'strftime') else str(row[0]),
                    'æœˆä»½': row[1],
                    'é—¨å¸‚': row[2],
                    'äº§å“åç§°': product_name,
                    'ç±»åˆ«': row[4],
                    'æ€»ä¸šç»©': sales,
                    'æ€»å•æ®æ•°': int(row[6]) if row[6] else 0,
                    'é”€å”®æ€»æ•°': quantity,
                    'æŠ¥åºŸæ•°é‡': wastage_qty,
                    'é”€å”®é‡‘é¢': amount,
                    'äº§å“å•æ®ä¸šç»©': product_receipt_performance,
                    'ä¸šç»©å æ¯”': sales_ratio,
                    'æ•°é‡å æ¯”': quantity_ratio,
                    'æŠ¥åºŸå æ¯”': wastage_ratio,
                    'äº§å“å•æ®ä¸šç»©å æ¯”': product_receipt_performance_ratio
                })
            
            cursor.close()
            print(f"äº§å“æ€»è§ˆæŸ¥è¯¢å®Œæˆï¼Œå…± {len(data)} æ¡è®°å½•")
            
            # å­˜å‚¨åˆ°ç¼“å­˜
            if not hasattr(self, '_product_cache'):
                self._product_cache = {}
            self._product_cache[cache_key] = data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if len(self._product_cache) > 10:
                # åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
                oldest_key = next(iter(self._product_cache))
                del self._product_cache[oldest_key]
            
            return data
            
        except Exception as e:
            print(f"è·å–äº§å“æ€»è§ˆåˆ†æå¤±è´¥: {e}")
            print(f"SQLæŸ¥è¯¢: {query}")
            print(f"å‚æ•°: {params}")
            return []
    
    def get_period_product_overview(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, 
                                   weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–æœŸé—´äº§å“æ€»è§ˆåˆ†æ - æŒ‰äº§å“æ±‡æ€»ç‰ˆæœ¬ï¼Œæ”¯æŒåˆä½µæ¨¡å¼"""
        # å¦‚æœæ˜¯åˆä½µæ¨¡å¼ï¼Œæ‰§è¡Œåˆä½µæŸ¥è¯¢
        if self.combined_mode:
            return self.get_combined_period_product_overview(date_from, date_to, outlet_filters, product_filters, month_filters, weekday_filters, category_filters, payment_filters)
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"period_product_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{product_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_period_product_cache') and cache_key in self._period_product_cache:
            cached_data = self._period_product_cache[cache_key]
            if cached_data:
                print("âœ“ ä½¿ç”¨ç¼“å­˜çš„æœŸé—´äº§å“æ€»è§ˆæ•°æ®")
                return cached_data
            else:
                # ç¼“å­˜ä¸ºç©ºç»“æœæ—¶ï¼Œé‡æ–°æŸ¥è¯¢ä»¥é˜²æ•°æ®æ›´æ–°
                print("â„¹ ç¼“å­˜çš„æœŸé—´äº§å“æ€»è§ˆæ•°æ®ä¸ºç©ºï¼Œé‡æ–°æŸ¥è¯¢...")
                del self._period_product_cache[cache_key]
        
        try:
            cursor = self.connection.cursor()
            query = ""  # åˆå§‹åŒ–queryå˜é‡ï¼Œé¿å…åœ¨å¼‚å¸¸å¤„ç†ä¸­è®¿é—®æœªå®šä¹‰çš„å˜é‡
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            params = []
            
            # æ—¥æœŸç­›é€‰
            if date_from and date_to:
                conditions.append("CAST(s.c_date as DATE) >= ? AND CAST(s.c_date as DATE) <= ?")
                params.extend([date_from, date_to])
                
                # ä½¿ç”¨å•æ®ç»Ÿè®¡æ•°æ®åº“ï¼Œä¸éœ€è¦é¢å¤–å‚æ•°
            
            # é—¨åº—ç­›é€‰
            if outlet_filters:
                placeholders = ','.join(['?' for _ in outlet_filters])
                conditions.append(f"s.store_name IN ({placeholders})")
                params.extend(outlet_filters)
                
                # ä½¿ç”¨å•æ®ç»Ÿè®¡æ•°æ®åº“ï¼Œä¸éœ€è¦é¢å¤–å‚æ•°
            
            # æœˆä»½ç­›é€‰
            if month_filters:
                month_conditions = []
                for month in month_filters:
                    month_conditions.append("FORMAT(s.c_date, 'yyyy-MM') = ?")
                    params.append(month)
                conditions.append(f"({' OR '.join(month_conditions)})")
            
            # æ˜ŸæœŸç­›é€‰
            if weekday_filters:
                weekday_conditions = []
                weekday_map = {
                    'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 'Thursday': 5, 
                    'Friday': 6, 'Saturday': 7, 'Sunday': 1
                }
                for weekday in weekday_filters:
                    if weekday in weekday_map:
                        weekday_conditions.append(f"DATEPART(WEEKDAY, s.c_date) = {weekday_map[weekday]}")
                if weekday_conditions:
                    conditions.append(f"({' OR '.join(weekday_conditions)})")
            
            # ç±»åˆ«ç­›é€‰
            if category_filters:
                placeholders = ','.join(['?' for _ in category_filters])
                conditions.append(f"im.category_code IN ({placeholders})")
                params.extend(category_filters)
            
            # äº§å“ç­›é€‰
            if product_filters:
                placeholders = ','.join(['?' for _ in product_filters])
                conditions.append(f"s.item_name IN ({placeholders})")
                params.extend(product_filters)
                
                # ä½¿ç”¨å•æ®ç»Ÿè®¡æ•°æ®åº“ï¼Œä¸éœ€è¦é¢å¤–å‚æ•°

            # æ”¯ä»˜æ–¹å¼ç­›é€‰ - ä¸¥æ ¼åŒ¹é…ï¼Œåªæœ‰å½“é”€å”®è®°å½•çš„æ‰€æœ‰æ”¯ä»˜æ–¹å¼éƒ½åœ¨ç­›é€‰åˆ—è¡¨ä¸­æ—¶æ‰åŒ…æ‹¬
            if payment_filters:
                placeholders = ','.join([f"'{payment}'" for payment in payment_filters])
                conditions.append(f"""NOT EXISTS (
                    SELECT 1 FROM {TABLE_PAYMENT} p
                    WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name
                    AND p.payment_name NOT IN ({placeholders})
                )""")

            # æ’é™¤wastageä¸»äº§å“
            conditions.append("s.item_name != 'WASTAGE'")
            
            # æ„å»ºWHEREå­å¥
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            # é¢å¤–æ„å»ºæŠ¥åºŸæŸ¥è¯¢æ¡ä»¶
            wastage_conditions = []
            wastage_params = []
            
            if date_from and date_to:
                wastage_conditions.append("CAST(c.c_date as DATE) >= ?")
                wastage_conditions.append("CAST(c.c_date as DATE) <= ?")
                wastage_params.extend([date_from, date_to])
            
            if outlet_filters:
                placeholders = ','.join(['?' for _ in outlet_filters])
                wastage_conditions.append(f"c.store_name IN ({placeholders})")
                wastage_params.extend(outlet_filters)
            
            if month_filters:
                month_clauses = []
                for month in month_filters:
                    month_clauses.append("FORMAT(c.c_date, 'yyyy-MM') = ?")
                    wastage_params.append(month)
                if month_clauses:
                    wastage_conditions.append("(" + " OR ".join(month_clauses) + ")")
            
            if weekday_filters:
                weekday_map = {
                    'Monday': 2, 'Tuesday': 3, 'Wednesday': 4, 'Thursday': 5,
                    'Friday': 6, 'Saturday': 7, 'Sunday': 1
                }
                weekday_clauses = []
                for weekday in weekday_filters:
                    if weekday in weekday_map:
                        weekday_clauses.append(f"DATEPART(WEEKDAY, c.c_date) = {weekday_map[weekday]}")
                if weekday_clauses:
                    wastage_conditions.append("(" + " OR ".join(weekday_clauses) + ")")
            
            if category_filters:
                placeholders = ','.join(['?' for _ in category_filters])
                wastage_conditions.append(f"im_w.category_code IN ({placeholders})")
                wastage_params.extend(category_filters)
            
            if product_filters:
                placeholders = ','.join(['?' for _ in product_filters])
                wastage_conditions.append(f"COALESCE(c.product_item_name, c.item_name) IN ({placeholders})")
                wastage_params.extend(product_filters)
            
            if payment_filters:
                placeholders = ','.join(['?' for _ in payment_filters])
                wastage_conditions.append(
                    f"EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WITH (NOLOCK) WHERE p.sales_no = c.sales_no AND p.store_name = c.store_name AND p.payment_name IN ({placeholders}))"
                )
                wastage_params.extend(payment_filters)
            
            # è®¡ç®—æœŸé—´æ˜¾ç¤º
            if date_from and date_to:
                period_display = f"'{date_from.split('-')[2]}/{date_from.split('-')[1]} - {date_to.split('-')[2]}/{date_to.split('-')[1]}'"
                days_calculation = f"DATEDIFF(day, '{date_from}', '{date_to}') + 1"
            else:
                period_display = "'å…¨éƒ¨æœŸé—´'"
                days_calculation = "COUNT(DISTINCT CAST(s.c_date as DATE))"
            
            # æœŸé—´äº§å“æ€»è§ˆæŸ¥è¯¢ - æŒ‰äº§å“æ±‡æ€»ï¼ˆä½¿ç”¨å•æ®ç»Ÿè®¡æ•°æ®åº“è®¡ç®—äº§å“å•æ®ä¸šç»©ï¼‰
            query = f"""
                SELECT
                    {period_display} as æœŸé—´,
                    s.item_name as äº§å“åç§°,
                    ISNULL(im.category_code, 'æœªåˆ†ç±»') as ç±»åˆ«,
                    {days_calculation} as å¤©æ•°,
                    SUM({self.get_performance_calculation_sql()} - 
                        ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                    COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                SUM(CAST(s.qty as FLOAT) - ISNULL(CAST(c.cancel_qty as FLOAT), 0)) as é”€å”®æ€»æ•°,
                SUM(CASE WHEN p.sales_no IS NOT NULL THEN CAST(s.qty as FLOAT) ELSE 0 END) as æŠ¥åºŸæ•°é‡,
                    SUM(CAST(s.sub_total as FLOAT)) as é”€å”®é‡‘é¢,
                    0 as äº§å“å•æ®ä¸šç»©
            FROM {TABLE_SALES} s WITH (NOLOCK)
            LEFT JOIN {TABLE_ITEMS} im ON s.item_name = im.item_name
            LEFT JOIN (
                SELECT DISTINCT store_name, sales_no
                FROM {TABLE_PAYMENT} WITH (NOLOCK)
                WHERE payment_name = 'WASTAGE'
            ) p ON s.store_name = p.store_name AND s.sales_no = p.sales_no
            LEFT JOIN (
                SELECT 
                    sales_no, 
                    store_name, 
                    item_name,
                    SUM({self._get_cancel_performance_calculation_sql()}) as cancel_amount,
                    SUM(CAST(qty as FLOAT)) as cancel_qty
                FROM {TABLE_CANCEL} WITH (NOLOCK)
                GROUP BY sales_no, store_name, item_name
            ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
            {where_clause}
            GROUP BY s.item_name, im.category_code
            ORDER BY æ€»ä¸šç»© DESC
            OPTION (RECOMPILE, MAXDOP 4)
            """

            print(f"æ‰§è¡ŒæœŸé—´äº§å“æ€»è§ˆæŸ¥è¯¢...")
            print(f"WHEREå­å¥: {where_clause}")
            print(f"å‚æ•°: {params}")
            print(f"SQLæŸ¥è¯¢: {query}")
            if hasattr(self, 'log_message'):
                self.log_message(f"è°ƒè¯•: æœŸé—´äº§å“SQLå¼€å§‹æ‰§è¡Œï¼Œå‚æ•°: {params}")
            
            try:
                # å…ˆæ‰§è¡Œç®€å•æµ‹è¯•æŸ¥è¯¢
                test_query = f"SELECT COUNT(*) FROM {TABLE_SALES} WHERE CAST(c_date as DATE) = '{date_from}'"
                print(f"ğŸ” æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢: {test_query}")
                cursor.execute(test_query)
                test_result = cursor.fetchone()
                print(f"ğŸ” æµ‹è¯•æŸ¥è¯¢ç»“æœ - {date_from} çš„è®°å½•æ•°: {test_result[0] if test_result else 0}")
                
                if test_result and test_result[0] == 0:
                    print(f"âŒ {date_from} æ²¡æœ‰é”€å”®æ•°æ®")
                    return []
                
                # ä¿®å¾©åƒæ•¸ç¶å®šå•é¡Œï¼šä½¿ç”¨å­—ç¬¦ä¸²æ›¿æ›è€Œä¸æ˜¯åƒæ•¸ç¶å®š
                if params:
                    # å°‡åƒæ•¸ç›´æ¥æ›¿æ›åˆ°SQLä¸­
                    query_with_params = query
                    param_index = 0
                    for i, param in enumerate(params):
                        if isinstance(param, str):
                            query_with_params = query_with_params.replace('?', f"'{param}'", 1)
                        else:
                            query_with_params = query_with_params.replace('?', str(param), 1)
                        param_index += 1
                    cursor.execute(query_with_params)
                else:
                    cursor.execute(query)
                
                rows = cursor.fetchall()
                print(f"æœŸé—´äº§å“æ€»è§ˆæŸ¥è¯¢è¿”å› {len(rows)} æ¡è®°å½•")
                if hasattr(self, 'log_message'):
                    self.log_message(f"è°ƒè¯•: æœŸé—´äº§å“æŸ¥è¯¢è¿”å› {len(rows)} æ¡è®°å½•")
                
                # è®¡ç®—æ€»è®¡æ•°æ®
                total_sales = sum(float(row[4]) if row[4] else 0.0 for row in rows)
                total_receipts = sum(int(row[5]) if row[5] else 0 for row in rows)
                total_quantity = sum(float(row[6]) if row[6] else 0.0 for row in rows)
                total_wastage = sum(float(row[7]) if len(row) > 7 and row[7] else 0.0 for row in rows)
                total_product_receipt_performance = sum(float(row[9]) if len(row) > 9 and row[9] else 0.0 for row in rows)
                    
            except Exception as query_error:
                print(f"âŒ æœŸé—´äº§å“åˆ†æSQLæŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"âŒ æŸ¥è¯¢è¯­å¥: {query}")
                print(f"âŒ å‚æ•°: {params}")
                import traceback
                print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
                return []
            
            data = []
            for row in rows:
                sales = float(row[4]) if row[4] else 0.0
                quantity = float(row[6]) if row[6] else 0.0
                wastage_qty = float(row[7]) if len(row) > 7 and row[7] else 0.0
                amount = float(row[8]) if len(row) > 8 and row[8] else 0.0
                product_receipt_performance = float(row[9]) if len(row) > 9 and row[9] else 0.0
                days = int(row[3]) if row[3] else 1
                
                sales_ratio = (sales / total_sales * 100) if total_sales > 0 else 0
                quantity_ratio = (quantity / total_quantity * 100) if total_quantity > 0 else 0
                total_qty_with_wastage = wastage_qty + quantity
                wastage_ratio = (wastage_qty / total_qty_with_wastage * 100) if total_qty_with_wastage > 0 else 0
                product_receipt_performance_ratio = (product_receipt_performance / total_product_receipt_performance * 100) if total_product_receipt_performance > 0 else 0
                
                data.append({
                    'æœŸé—´': row[0],
                    'äº§å“åç§°': row[1],
                    'ç±»åˆ«': row[2],
                    'å¤©æ•°': days,
                    'æ€»ä¸šç»©': sales,
                    'æ€»å•æ®æ•°': int(row[5]) if row[5] else 0,
                    'é”€å”®æ€»æ•°': quantity,
                    'æŠ¥åºŸæ•°é‡': wastage_qty,
                    'é”€å”®é‡‘é¢': amount,
                    'äº§å“å•æ®ä¸šç»©': product_receipt_performance,
                    'ä¸šç»©å æ¯”': sales_ratio,
                    'æ•°é‡å æ¯”': quantity_ratio,
                    'æŠ¥åºŸå æ¯”': wastage_ratio,
                    'äº§å“å•æ®ä¸šç»©å æ¯”': product_receipt_performance_ratio,
                    'æ€»ä¸šç»©_æ—¥å‡': sales / days if days > 0 else 0,
                    'æ€»å•æ®æ•°_æ—¥å‡': (int(row[5]) if row[5] else 0) / days if days > 0 else 0,
                    'é”€å”®æ€»æ•°_æ—¥å‡': quantity / days if days > 0 else 0,
                    'æŠ¥åºŸæ•°é‡_æ—¥å‡': wastage_qty / days if days > 0 else 0,
                    'äº§å“å•æ®ä¸šç»©_æ—¥å‡': product_receipt_performance / days if days > 0 else 0
                })
            
            cursor.close()
            print(f"æœŸé—´äº§å“æ€»è§ˆæŸ¥è¯¢å®Œæˆï¼Œå…± {len(data)} æ¡è®°å½•")
            
            # å¾å–®æ“šæ˜ç´°æ•¸æ“šåº«ç²å–ç”¢å“å–®æ“šæ¥­ç¸¾ - ä½¿ç”¨å°ˆé–€çš„æœŸé–“å‡½æ•¸
            receipt_performance_data = self.get_period_product_receipt_performance_from_db(
                date_from=date_from, 
                date_to=date_to, 
                outlet_filters=outlet_filters,
                product_filters=product_filters,
                database_source=self.current_database
            )
            
            # è¨ˆç®—æ‰€æœ‰ç”¢å“çš„ç¸½æ¥­ç¸¾
            total_all_sales = sum(float(d['æ€»ä¸šç»©']) for d in data)
            
            # æ›´æ–°ç”¢å“å–®æ“šæ¥­ç¸¾æ•¸æ“š - æœŸé–“ç”¢å“ç¸½è¦½ç›´æ¥ä½¿ç”¨ç”¢å“å–®æ“šæ¥­ç¸¾
            for item in data:
                product_name = item['äº§å“åç§°']
                if product_name in receipt_performance_data:
                    receipt_data = receipt_performance_data[product_name]
                    product_sales = item['æ€»ä¸šç»©']
                    
                    # æœŸé–“ç”¢å“ç¸½è¦½ï¼šç›´æ¥ä½¿ç”¨è©²ç”¢å“çš„ç”¢å“å–®æ“šæ¥­ç¸¾ï¼Œä¸é€²è¡Œåˆ†é…
                    allocated_receipt_performance = receipt_data['äº§å“å•æ®ä¸šç»©']
                    average_receipt_amount = receipt_data['å¹³å‡å•æ®é‡‘é¢']
                    receipt_count = receipt_data['å•æ®æ•°é‡']
                    
                    print(f"âœ… æ›´æ–° {product_name} ç”¢å“å–®æ“šæ¥­ç¸¾: ${allocated_receipt_performance:.2f} (å¹³å‡å–®æ“š: ${average_receipt_amount:.2f}, å–®æ“šæ•¸: {receipt_count})")
                    
                    item['äº§å“å•æ®ä¸šç»©'] = allocated_receipt_performance
                    # é‡æ–°è¨ˆç®—ç”¢å“å–®æ“šæ¥­ç¸¾å æ¯”ï¼šç”¢å“å–®æ“šæ¥­ç¸¾ / æ‰€æœ‰ç”¢å“çš„ç¸½æ¥­ç¸¾ * 100%
                    item['äº§å“å•æ®ä¸šç»©å æ¯”'] = (allocated_receipt_performance / total_all_sales * 100) if total_all_sales > 0 else 0
                    item['äº§å“å•æ®ä¸šç»©_æ—¥å‡'] = allocated_receipt_performance / item['å¤©æ•°'] if item['å¤©æ•°'] > 0 else 0
            
            # å­˜å‚¨åˆ°ç¼“å­˜ï¼ˆä»…ç¼“å­˜éç©ºç»“æœï¼‰
            if data:
                if not hasattr(self, '_period_product_cache'):
                    self._period_product_cache = {}
                self._period_product_cache[cache_key] = data
            
            # é™åˆ¶ç¼“å­˜å¤§å°
            if hasattr(self, '_period_product_cache') and len(self._period_product_cache) > 10:
                oldest_key = next(iter(self._period_product_cache))
                del self._period_product_cache[oldest_key]
            
            return data
            
        except Exception as e:
            print(f"è·å–æœŸé—´äº§å“æ€»è§ˆåˆ†æå¤±è´¥: {e}")
            print(f"SQLæŸ¥è¯¢: {query}")
            print(f"å‚æ•°: {params}")
            return []
    
    def get_combined_weekly_product_data(self, date_from=None, date_to=None, outlet_filters=None, product_filters=None, month_filters=None, 
                                        weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–åˆå¹¶çš„å‘¨æœŸäº§å“æ•°æ® - ä»æ‰€æœ‰æ•°æ®åº“åˆå¹¶æ•°æ®"""
        try:
            print("ğŸ”„ æ‰§è¡Œåˆå¹¶å‘¨æœŸäº§å“æ•°æ®æŸ¥è¯¢...")
            print(f"æŸ¥è¯¢å‚æ•°: date_from={date_from}, date_to={date_to}")
            print(f"ç­›é€‰æ¡ä»¶: outlet_filters={outlet_filters}, product_filters={product_filters}, month_filters={month_filters}, weekday_filters={weekday_filters}, category_filters={category_filters}, payment_filters={payment_filters}")
            
            # æ‰€æœ‰æ•°æ®åº“åˆ—è¡¨
            databases = ["sushi_gogo_pos_live", "sushi_express_pos_live", "sushi_plus_pos_live"]
            all_results = []
            
            # ä¸ºæ¯ä¸ªæ•°æ®åº“æ‰§è¡ŒæŸ¥è¯¢
            for db_name in databases:
                try:
                    print(f"ğŸ“Š æŸ¥è¯¢æ•°æ®åº“: {db_name}")
                    
                    # æ„å»ºæŸ¥è¯¢SQL
                    conditions = []
                    
                    # æ—¥æœŸç­›é€‰
                    if date_from and date_to:
                        conditions.append(f"CAST(s.c_date as DATE) >= '{date_from}' AND CAST(s.c_date as DATE) <= '{date_to}'")
                    
                    # é—¨åº—ç­›é€‰
                    if outlet_filters:
                        outlet_conditions = " OR ".join([f"s.store_name LIKE '%{outlet}%'" for outlet in outlet_filters])
                        conditions.append(f"({outlet_conditions})")
                    
                    # äº§å“ç­›é€‰
                    if product_filters:
                        product_conditions = " OR ".join([f"s.item_name LIKE '%{product}%'" for product in product_filters])
                        conditions.append(f"({product_conditions})")
                    
                    # æ’é™¤wastage
                    conditions.append("s.item_name != 'WASTAGE'")
                    
                    where_clause = ""
                    if conditions:
                        where_clause = " WHERE " + " AND ".join(conditions)
                    
                    # æŸ¥è¯¢å‘¨æœŸäº§å“æ•°æ® - æŒ‰å‘¨åˆ†ç»„ï¼Œä¸æœŸé—´-äº§å“æ•°æ®ä¿æŒä¸€è‡´
                    query = f"""
                        WITH WeeklyProductData AS (
                            SELECT 
                                s.item_name as äº§å“åç§°,
                                DATEPART(WEEK, s.c_date) as å‘¨æ•°,
                                DATEADD(DAY, -(DATEPART(WEEKDAY, s.c_date) - 2), CAST(s.c_date as DATE)) as å‘¨å¼€å§‹æ—¥æœŸ,
                                DATEADD(DAY, 6, DATEADD(DAY, -(DATEPART(WEEKDAY, s.c_date) - 2), CAST(s.c_date as DATE))) as å‘¨ç»“æŸæ—¥æœŸ,
                                SUM({self.get_combined_performance_calculation_sql(db_name)} - 
                                    ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as äº§å“ä¸šç»©,
                                COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as äº§å“å•æ®æ•°,
                                SUM(CAST(s.qty as FLOAT) - ISNULL(CAST(c.cancel_qty as FLOAT), 0)) as é”€å”®æ•°é‡
                            FROM {db_name}.dbo.sales s WITH (NOLOCK)
                            LEFT JOIN {db_name}.dbo.item_master im ON s.item_name = im.item_name
                            LEFT JOIN (
                                SELECT DISTINCT store_name, sales_no
                                FROM {db_name}.dbo.payment WITH (NOLOCK)
                                WHERE payment_name = 'WASTAGE'
                            ) p ON s.store_name = p.store_name AND s.sales_no = p.sales_no
                            LEFT JOIN (
                                SELECT 
                                    sales_no, 
                                    store_name, 
                                    item_name,
                                    SUM({self.get_combined_cancel_performance_calculation_sql(db_name)}) as cancel_amount,
                                    SUM(CAST(qty as FLOAT)) as cancel_qty
                                FROM {db_name}.dbo.cancel WITH (NOLOCK)
                                GROUP BY sales_no, store_name, item_name
                            ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                            {where_clause}
                            GROUP BY s.item_name, DATEPART(WEEK, s.c_date), 
                                     DATEADD(DAY, -(DATEPART(WEEKDAY, s.c_date) - 2), CAST(s.c_date as DATE))
                        ),
                        WeeklyTotals AS (
                            SELECT 
                                å‘¨æ•°,
                                å‘¨å¼€å§‹æ—¥æœŸ,
                                å‘¨ç»“æŸæ—¥æœŸ,
                                SUM(äº§å“ä¸šç»©) as æ€»ä¸šç»©,
                                SUM(äº§å“å•æ®æ•°) as æ€»å•æ®æ•°,
                                SUM(é”€å”®æ•°é‡) as æ€»é”€å”®æ•°é‡
                            FROM WeeklyProductData
                            GROUP BY å‘¨æ•°, å‘¨å¼€å§‹æ—¥æœŸ, å‘¨ç»“æŸæ—¥æœŸ
                        )
                        SELECT 
                            äº§å“åç§°,
                            å‘¨æ•°,
                            CONCAT(FORMAT(å‘¨å¼€å§‹æ—¥æœŸ, 'd/M'), ' - ', FORMAT(å‘¨ç»“æŸæ—¥æœŸ, 'd/M')) as æœŸé—´,
                            äº§å“ä¸šç»©,
                            äº§å“å•æ®æ•°,
                            é”€å”®æ•°é‡,
                            CASE WHEN DATEDIFF(DAY, å‘¨å¼€å§‹æ—¥æœŸ, å‘¨ç»“æŸæ—¥æœŸ) + 1 > 0 
                                 THEN äº§å“ä¸šç»© / (DATEDIFF(DAY, å‘¨å¼€å§‹æ—¥æœŸ, å‘¨ç»“æŸæ—¥æœŸ) + 1) 
                                 ELSE 0 END as æ—¥å‡ä¸šç»©,
                            'Product' as ç±»å‹
                        FROM WeeklyProductData
                        UNION ALL
                        SELECT 
                            '=== å‘¨æ€»è®¡ ===' as äº§å“åç§°,
                            å‘¨æ•°,
                            CONCAT(FORMAT(å‘¨å¼€å§‹æ—¥æœŸ, 'd/M'), ' - ', FORMAT(å‘¨ç»“æŸæ—¥æœŸ, 'd/M')) as æœŸé—´,
                            æ€»ä¸šç»© as äº§å“ä¸šç»©,
                            æ€»å•æ®æ•° as äº§å“å•æ®æ•°,
                            æ€»é”€å”®æ•°é‡ as é”€å”®æ•°é‡,
                            CASE WHEN DATEDIFF(DAY, å‘¨å¼€å§‹æ—¥æœŸ, å‘¨ç»“æŸæ—¥æœŸ) + 1 > 0 
                                 THEN æ€»ä¸šç»© / (DATEDIFF(DAY, å‘¨å¼€å§‹æ—¥æœŸ, å‘¨ç»“æŸæ—¥æœŸ) + 1) 
                                 ELSE 0 END as æ—¥å‡ä¸šç»©,
                            'Total' as ç±»å‹
                        FROM WeeklyTotals
                        ORDER BY å‘¨æ•°, ç±»å‹, äº§å“ä¸šç»© DESC
                        OPTION (RECOMPILE, MAXDOP 4)
                    """
                    
                    cursor = self.connection.cursor()
                    cursor.execute(query)
                    results = cursor.fetchall()
                    cursor.close()
                    
                    # è½¬æ¢æ•°æ®æ ¼å¼
                    for row in results:
                        all_results.append({
                            'äº§å“åç§°': row[0],
                            'å‘¨æ•°': row[1],
                            'æœŸé—´': row[2],
                            'äº§å“ä¸šç»©': float(row[3]) if row[3] else 0.0,
                            'äº§å“å•æ®æ•°': int(row[4]) if row[4] else 0,
                            'é”€å”®æ•°é‡': float(row[5]) if row[5] else 0.0,
                            'æ—¥å‡ä¸šç»©': float(row[6]) if row[6] else 0.0,
                            'ç±»å‹': row[7] if len(row) > 7 else 'Product',
                            'æ•°æ®åº“': db_name
                        })
                    
                    print(f"âœ… {db_name} æŸ¥è¯¢å®Œæˆï¼Œè·å¾— {len(results)} æ¡è®°å½•")
                    
                except Exception as e:
                    print(f"âŒ æŸ¥è¯¢æ•°æ®åº“ {db_name} å¤±è´¥: {e}")
                    continue
            
            print(f"ğŸ”„ åˆå¹¶å‘¨æœŸäº§å“æ•°æ®æŸ¥è¯¢å®Œæˆï¼Œå…± {len(all_results)} æ¡è®°å½•")
            return all_results
            
        except Exception as e:
            print(f"âŒ åˆå¹¶å‘¨æœŸäº§å“æ•°æ®æŸ¥è¯¢å¤±è´¥: {e}")
            return []

    def get_discount_analysis(self, date_from=None, date_to=None, outlet_filters=None, month_filters=None, weekday_filters=None, category_filters=None, payment_filters=None):
        """è·å–æŠ˜æ‰£åˆ†æ"""
        if not self.connection:
            return []
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"discount_{self.current_database}_{date_from}_{date_to}_{outlet_filters}_{month_filters}_{weekday_filters}_{category_filters}_{payment_filters}"
        if hasattr(self, '_discount_cache') and cache_key in self._discount_cache:
            print("âœ“ ä½¿ç”¨ç¼“å­˜çš„æŠ˜æ‰£åˆ†ææ•°æ®")
            return self._discount_cache[cache_key]
        
        try:
            cursor = self.connection.cursor()
            
            # æ„å»ºWHEREæ¡ä»¶
            conditions = []
            if date_from:
                conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
            if date_to:
                conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
            if outlet_filters and len(outlet_filters) > 0:
                outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                conditions.append(f"({outlet_conditions})")
            if month_filters and len(month_filters) > 0:
                month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                conditions.append(f"({month_conditions})")
            
            # æ·»åŠ æŠ˜æ‰£æ¡ä»¶
            conditions.append("s.disc_amt > 0")
            
            # å¦‚æœæœ‰ç±»åˆ«ç­›é€‰ï¼Œéœ€è¦JOIN item_masterè¡¨
            join_clause = ""
            if category_filters and len(category_filters) > 0:
                category_conditions = " OR ".join([f"im.category_code = '{category}'" for category in category_filters])
                conditions.append(f"({category_conditions})")
                join_clause = "LEFT JOIN item_master im ON s.item_name = im.item_name"
            
            where_clause = ""
            if conditions:
                where_clause = " WHERE " + " AND ".join(conditions)
            
            query = f"""
                WITH DiscountSummary AS (
                    SELECT 
                        s.store_name as é—¨å¸‚,
                        FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') as æœˆä»½,
                        s.disc_name as æŠ˜æ‰£åç§°,
                        SUM(CAST(s.disc_amt AS FLOAT)) as æŠ˜æ‰£é‡‘é¢,
                        COUNT(*) as æŠ˜æ‰£æ¬¡æ•°
                    FROM pos_sales_dtls s WITH (NOLOCK)
                    {join_clause}
                    {where_clause}
                    GROUP BY s.store_name, FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM'), s.disc_name
                ),
                TotalDiscounts AS (
                    SELECT 
                        SUM(æŠ˜æ‰£é‡‘é¢) as æ€»æŠ˜æ‰£é‡‘é¢,
                        SUM(æŠ˜æ‰£æ¬¡æ•°) as æ€»æŠ˜æ‰£æ¬¡æ•°
                    FROM DiscountSummary
                )
                SELECT 
                    ds.é—¨å¸‚,
                    ds.æœˆä»½,
                    ds.æŠ˜æ‰£åç§°,
                    ds.æŠ˜æ‰£é‡‘é¢,
                    ds.æŠ˜æ‰£æ¬¡æ•°,
                    CASE WHEN td.æ€»æŠ˜æ‰£é‡‘é¢ > 0 THEN (ds.æŠ˜æ‰£é‡‘é¢ / td.æ€»æŠ˜æ‰£é‡‘é¢ * 100) ELSE 0 END as æŠ˜æ‰£å æ¯”,
                    CASE WHEN td.æ€»æŠ˜æ‰£æ¬¡æ•° > 0 THEN (ds.æŠ˜æ‰£æ¬¡æ•° / td.æ€»æŠ˜æ‰£æ¬¡æ•° * 100) ELSE 0 END as æŠ˜æ‰£æ¬¡æ•°å æ¯”,
                    SUM(ds.æŠ˜æ‰£æ¬¡æ•°) OVER (PARTITION BY ds.æŠ˜æ‰£åç§°) as å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸
                FROM DiscountSummary ds
                CROSS JOIN TotalDiscounts td
                ORDER BY ds.é—¨å¸‚, ds.æœˆä»½, ds.æŠ˜æ‰£é‡‘é¢ DESC
            """
            
            print(f"æŠ˜æ‰£åˆ†ææŸ¥è¯¢: {query}")
            cursor.execute(query)
            results = cursor.fetchall()
            
            # è½¬æ¢ä¸ºå­—å…¸æ ¼å¼
            discount_data = []
            for row in results:
                discount_data.append({
                    'é—¨å¸‚': row[0],
                    'æœˆä»½': row[1],
                    'æŠ˜æ‰£åç§°': row[2],
                    'æŠ˜æ‰£é‡‘é¢': float(row[3]),
                    'æŠ˜æ‰£æ¬¡æ•°': row[4],
                    'æŠ˜æ‰£å æ¯”(%)': float(row[5]),
                    'æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)': float(row[6]),
                    'å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸': row[7]
                })
            
            # ç¼“å­˜ç»“æœ
            if not hasattr(self, '_discount_cache'):
                self._discount_cache = {}
            self._discount_cache[cache_key] = discount_data
            
            print(f"âœ“ æŠ˜æ‰£åˆ†ææŸ¥è¯¢å®Œæˆï¼Œå…± {len(discount_data)} æ¡è®°å½•")
            return discount_data
            
        except Exception as e:
            print(f"âŒ æŠ˜æ‰£åˆ†ææŸ¥è¯¢å¤±è´¥: {e}")
            return []

class POSAnalysisGUI:
    def __init__(self):
        self.db_manager = DatabaseManager()
        # å°‡GUIçš„log_messageæ³¨å…¥çµ¦DatabaseManagerï¼Œç”¨æ–¼æ•¸æ“šæºæç¤º
        self.db_manager.log_message = lambda msg, include_db_info=False: self.log_message(msg, include_db_info)
        self.receipt_db_manager = None  # å»¶é²åˆå§‹åŒ–
        
        # åˆå§‹åŒ–æ•¸æ“šåº«é¸é …é…ç½®
        self.DATABASE_OPTIONS = {
            "GOGO": {"cn": "GOGO", "en": "GOGO", "db": "sushi_gogo_pos_live", "color": "#3498db", "selected_color": "#2980b9", "icon": "ğŸ“Š"},
            "Express": {"cn": "Express", "en": "Express", "db": "sushi_express_pos_live", "color": "#f1c40f", "selected_color": "#d68910", "icon": "ğŸ“ˆ"},
            "Plus": {"cn": "Plus", "en": "Plus", "db": "sushi_plus_pos_live", "color": "#e74c3c", "selected_color": "#c0392b", "icon": "â­"},
            "All": {"cn": "å…¨éƒ¨", "en": "All", "db": "All", "color": "#9b59b6", "selected_color": "#8e44ad", "icon": "ğŸŒŸ"}
        }
        
        # æ‰€æœ‰æ•¸æ“šåº«åˆ—è¡¨ï¼Œç”¨æ–¼Allé¸é …çš„åˆä½µæŸ¥è©¢
        self.ALL_DATABASES = ["sushi_gogo_pos_live", "sushi_express_pos_live", "sushi_plus_pos_live"]
        
        # ä½¿ç”¨ customtkinter ä¸»çª—å£ï¼Œè¨­å®šç‚º SEAutomation.py é¢¨æ ¼çš„æš—ä¸»é¡Œ
        self.root = ctk.CTk()
        self.root.title("POSæ•°æ®åˆ†æå·¥å…· - å¢å¼ºç‰ˆ\nPOS Data Analysis Tool - Enhanced")
        self.root.geometry("1600x1000")
        
        # è¨­å®š customtkinter ä¸»é¡Œå’ŒèƒŒæ™¯è‰²
        ctk.set_appearance_mode("light")  # äº®ä¸»é¡Œä½†ä½¿ç”¨è‡ªå®šç¾©é¡è‰²
        self.root.configure(fg_color='#FFFFFF')  # ç´”ç™½èƒŒæ™¯
        
        # æ•°æ®å­˜å‚¨å˜é‡
        self.sales_data = None
        self.payment_data = None
        self.discount_data = None
        self.monthly_data = None
        self.sales_tc_analysis_data = None
        self.sales_tc_monthly_data = None
        self.product_association_data = None
        
        # æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ
        self.cached_sales_data = []  # ç¼“å­˜çš„å®Œæ•´é”€å”®æ•°æ®
        self.cache_date_range = None  # ç¼“å­˜æ•°æ®çš„æ—¥æœŸèŒƒå›´
        self.cache_database = None    # ç¼“å­˜æ•°æ®çš„æ•°æ®åº“
        self.product_overview_outlet_filters = []
        self.product_overview_store_count = 1
        self.period_product_outlet_filters = []
        self.period_product_store_count = 1
        self.weekly_product_outlet_filters = []
        self.weekly_product_store_count = 1
        # ç§»é™¤åŒ…å«æ”¯ä»˜æ–¹å¼çš„ç¼“å­˜æ§åˆ¶ï¼Œç®€åŒ–é€»è¾‘
        
        # å¯¼å‡ºç›¸å…³å˜é‡
        self.export_cancelled = False
        self.export_progress_bar = None
        self.export_progress_window = None
        self.simple_progress_window = None
        self.simple_progress_bar = None
        
        # åˆå§‹åŒ–æ´»åŠ¨è®°å½•åˆ—è¡¨ - æŒ‰æ•°æ®åº“åˆ†ç±»
        self.activity_records = {
            'GOGO': [],
            'Express': [],
            'PLUS': []
        }
        
        # åŠ è½½æ´»åŠ¨è®°å½•
        self.load_activity_records()
        
        # è‡ªå‹•è®€å– PromotionRecords.xlsx æ–‡ä»¶
        self.auto_load_promotion_records()
        
        # ç‚ºç¾æœ‰æ´»å‹•è¨˜éŒ„è£œå……åˆ†æçµæœ
        self.analyze_existing_activities()
        
        self.setup_ui()
        self.setup_ui_complete()
    
    def save_activity_records(self):
        """ä¿å­˜æ´»åŠ¨è®°å½•åˆ°æ–‡ä»¶"""
        try:
            import json
            import os
            os.makedirs('cache', exist_ok=True)
            
            with open('cache/activity_records.json', 'w', encoding='utf-8') as f:
                json.dump(self.activity_records, f, ensure_ascii=False, indent=2)
            print(f"âœ… æ´»åŠ¨è®°å½•å·²ä¿å­˜åˆ°æ–‡ä»¶")
        except Exception as e:
            print(f"âŒ ä¿å­˜æ´»åŠ¨è®°å½•å¤±è´¥: {e}")
    
    def load_activity_records(self):
        """ä»æ–‡ä»¶åŠ è½½æ´»åŠ¨è®°å½•"""
        try:
            import json
            import os
            
            # ç¡®ä¿æ´»åŠ¨è®°å½•å­—å…¸åŒ…å«æ‰€æœ‰æ•°æ®åº“
            if not hasattr(self, 'activity_records'):
                self.activity_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': [],
                    'All': []
                }
            
            activity_file = 'cache/activity_records.json'
            if os.path.exists(activity_file):
                with open(activity_file, 'r', encoding='utf-8') as f:
                    loaded_records = json.load(f)
                    if isinstance(loaded_records, dict):
                        # åˆå¹¶åŠ è½½çš„è®°å½•åˆ°ç°æœ‰è®°å½•ï¼Œå¹¶ç¡®ä¿æ”¯ä»˜æ–¹å¼æ ¼å¼æ­£ç¡®
                        for db_name, records in loaded_records.items():
                            if isinstance(records, list):
                                # ç¡®ä¿æ”¯ä»˜æ–¹å¼æ˜¯åˆ—è¡¨æ ¼å¼
                                for record in records:
                                    if 'payment_methods' in record and isinstance(record['payment_methods'], str):
                                        # å¦‚æœæ”¯ä»˜æ–¹å¼æ˜¯å­—ç¬¦ä¸²ï¼Œè½¬æ¢ä¸ºåˆ—è¡¨
                                        if ',' in record['payment_methods']:
                                            record['payment_methods'] = [pm.strip() for pm in record['payment_methods'].split(',')]
                                        else:
                                            record['payment_methods'] = [record['payment_methods']] if record['payment_methods'] else []
                                self.activity_records[db_name] = records
                        print(f"âœ… å·²åŠ è½½æ´»åŠ¨è®°å½•ï¼ŒExpress: {len(self.activity_records.get('Express', []))}, GOGO: {len(self.activity_records.get('GOGO', []))}, PLUS: {len(self.activity_records.get('PLUS', []))}")
            else:
                print(f"ğŸ“ æ´»åŠ¨è®°å½•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ç©ºçš„è®°å½•åˆ—è¡¨")
                # ç¡®ä¿æ‰€æœ‰æ•°æ®åº“éƒ½æœ‰ç©ºåˆ—è¡¨
                for db_name in ['GOGO', 'Express', 'PLUS', 'All']:
                    if db_name not in self.activity_records:
                        self.activity_records[db_name] = []
        except Exception as e:
            print(f"âŒ åŠ è½½æ´»åŠ¨è®°å½•å¤±è´¥: {e}")
            # å¦‚æœåŠ è½½å¤±è´¥ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªåŸºæœ¬çš„è®°å½•ç»“æ„
            if not hasattr(self, 'activity_records'):
                self.activity_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': [],
                    'All': []
                }
    
    def toggle_date_filter(self):
        """åˆ‡æ¢æ—¥æœŸç­›é€‰å¼€å…³"""
        if self.use_date_filter.get():
            # å¯ç”¨æ—¥æœŸç­›é€‰
            self.date_from.config(state='normal')
            self.date_to.config(state='normal')
            self.log_message("âœ“ å·²å¯ç”¨æ—¥æœŸç­›é€‰")
        else:
            # ç¦ç”¨æ—¥æœŸç­›é€‰
            self.date_from.config(state='disabled')
            self.date_to.config(state='disabled')
            self.log_message("â„¹ å·²ç¦ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
    
    def toggle_product_display(self):
        """åˆ‡æ¢äº§å“è¯¦ç»†æ˜¾ç¤ºå¼€å…³"""
        print(f"ğŸ”§ æ˜¾ç¤ºè¯¦ç»†å¼€å…³è¢«è§¦å‘ï¼Œå½“å‰çŠ¶æ€: {self.show_product_details.get()}")
        if self.show_product_details.get():
            self.log_message("âœ“ å·²å¯ç”¨äº§å“è¯¦ç»†æ˜¾ç¤º")
        else:
            self.log_message("â„¹ å·²ç¦ç”¨äº§å“è¯¦ç»†æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºæ€»è®¡")
        
        # è‡ªåŠ¨é‡æ–°æ˜¾ç¤ºå½“å‰æ•°æ®
        self.refresh_current_display()
    
    def toggle_daily_average(self):
        """åˆ‡æ¢æ—¥å‡æ˜¾ç¤ºå¼€å…³"""
        print(f"ğŸ”§ æ—¥å‡æ˜¾ç¤ºå¼€å…³è¢«è§¦å‘ï¼Œå½“å‰çŠ¶æ€: {self.show_daily_average.get()}")
        if self.show_daily_average.get():
            self.log_message("âœ“ å·²å¯ç”¨æ—¥å‡æ˜¾ç¤º")
        else:
            self.log_message("â„¹ å·²ç¦ç”¨æ—¥å‡æ˜¾ç¤º")
        
        # è‡ªåŠ¨é‡æ–°æ˜¾ç¤ºå½“å‰æ•°æ®
        self.refresh_current_display()
    
    def calculate_daily_average(self, data, date_range_days=None):
        """è®¡ç®—æ—¥å‡æ•°æ®"""
        if not data:
            return data
        
        if date_range_days is None:
            # ä»æ—¥æœŸèŒƒå›´è®¡ç®—å¤©æ•°
            if hasattr(self, 'date_from') and hasattr(self, 'date_to'):
                try:
                    from_date = self.date_from.get_date()
                    to_date = self.date_to.get_date()
                    date_range_days = (to_date - from_date).days + 1
                except:
                    date_range_days = 1
            else:
                date_range_days = 1
        
        if date_range_days <= 0:
            date_range_days = 1
        
        # å¤åˆ¶æ•°æ®å¹¶è®¡ç®—æ—¥å‡
        avg_data = []
        for item in data:
            avg_item = item.copy()
            # å¯¹æ•°å€¼å­—æ®µè®¡ç®—æ—¥å‡
            for key, value in avg_item.items():
                if isinstance(value, (int, float)) and value > 0:
                    # å æ¯”ç±»å­—æ®µä¸åšæ—¥å‡
                    if 'å æ¯”' in key or '%' in key:
                        continue
                    # æ£€æŸ¥æ˜¯å¦ä¸ºé‡‘é¢ã€æ•°é‡ç­‰éœ€è¦è®¡ç®—æ—¥å‡çš„å­—æ®µ
                    if any(keyword in key for keyword in ['é‡‘é¢', 'Amount', 'æ•°é‡', 'Count', 'æ¬¡æ•°', 'é‡‘é¢', 'äº§å“å•æ®ä¸šç»©']):
                        avg_item[key] = round(value / date_range_days, 2)
            avg_data.append(avg_item)
        
        return avg_data
    
    def toggle_store_average(self):
        """åˆ‡æ¢å•åº—å¹³å‡å¼€å…³"""
        if self.show_store_average.get():
            self.log_message("âœ“ å·²å¯ç”¨å•åº—å¹³å‡æ˜¾ç¤º")
        else:
            self.log_message("â„¹ å·²ç¦ç”¨å•åº—å¹³å‡æ˜¾ç¤º")
        self.refresh_current_display()
    
    def toggle_brand_daily_average(self):
        """åˆ‡æ¢å“ç‰ŒæœŸé—´æ±‡æ€»æ—¥å‡æ˜¾ç¤ºå¼€å…³"""
        if self.show_brand_daily_average.get():
            self.log_message("âœ“ å·²å¯ç”¨å“ç‰ŒæœŸé—´æ±‡æ€»æ—¥å‡æ˜¾ç¤º")
        else:
            self.log_message("â„¹ å·²ç¦ç”¨å“ç‰ŒæœŸé—´æ±‡æ€»æ—¥å‡æ˜¾ç¤º")
        
        # è‡ªåŠ¨é‡æ–°æ˜¾ç¤ºå½“å‰æ•°æ®
        self.refresh_current_display()
    
    def toggle_product_daily_average(self):
        """åˆ‡æ¢äº§å“æ€»è§ˆæ—¥å‡æ˜¾ç¤ºå¼€å…³"""
        if self.show_product_daily_average.get():
            self.log_message("âœ“ å·²å¯ç”¨äº§å“æ€»è§ˆæ—¥å‡æ˜¾ç¤º")
        else:
            self.log_message("â„¹ å·²ç¦ç”¨äº§å“æ€»è§ˆæ—¥å‡æ˜¾ç¤ºï¼Œæ˜¾ç¤ºæ€»æ•°æ®")
        
        # è‡ªåŠ¨é‡æ–°æ˜¾ç¤ºå½“å‰æ•°æ®
        self.refresh_current_display()
    
    def toggle_performance_details(self):
        """åˆ‡æ¢ä¸šç»©å¯¹æ¯”è¯¦ç»†æ˜¾ç¤ºå¼€å…³"""
        if self.show_performance_details.get():
            self.log_message("âœ“ å·²å¯ç”¨ä¸šç»©å¯¹æ¯”è¯¦ç»†æ˜¾ç¤º")
        else:
            self.log_message("â„¹ å·²ç¦ç”¨ä¸šç»©å¯¹æ¯”è¯¦ç»†æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºæ€»è®¡")
        
        # é‡æ–°æ˜¾ç¤ºä¸šç»©å¯¹æ¯”æ•°æ®
        if hasattr(self, 'performance_comparison_data') and self.performance_comparison_data:
            self.display_performance_comparison()
    
    def toggle_filter_panel(self):
        """åˆ‡æ¢ç­›é€‰é¢æ¿æ˜¾ç¤º/éšè—"""
        if self.filter_toggle_var.get():
            # éšè—ç­›é€‰é¢æ¿
            self.filter_frame.grid_remove()
            self.filter_toggle_var.set(False)
            self.filter_toggle_btn.config(text="ğŸ” æ˜¾ç¤ºç­›é€‰\nShow Filters")
            self.log_message("â„¹ å·²éšè—ç­›é€‰é¢æ¿")
            # é‡æ–°é…ç½®notebookè¡Œæƒé‡
            self._reconfigure_grid_weights()
        else:
            # æ˜¾ç¤ºç­›é€‰é¢æ¿
            self.filter_frame.grid(row=1, column=0, sticky="ew", padx=5, pady=5)
            self.filter_toggle_var.set(True)
            self.filter_toggle_btn.config(text="ğŸ” éšè—ç­›é€‰\nHide Filters")
            self.log_message("âœ“ å·²æ˜¾ç¤ºç­›é€‰é¢æ¿")
            # é‡æ–°é…ç½®notebookè¡Œæƒé‡
            self._reconfigure_grid_weights()
    
    
    def toggle_analysis_panel(self):
        """åˆ‡æ¢åˆ†æé¢æ¿æ˜¾ç¤º/éšè— - æ–°ç‰ˆæœ¬"""
        current_state = self.analysis_toggle_var.get()
        self.log_message(f"ğŸ” å½“å‰åˆ†æé¢æ¿çŠ¶æ€: {current_state}")
        
        if current_state:
            # éšè—åˆ†æé¢æ¿
            self.log_message("ğŸ” å‡†å¤‡éšè—åˆ†æé¢æ¿...")
            if hasattr(self, 'function_frame'):
                self.function_frame.grid_remove()
                self.log_message("âœ“ function_frameå·²éšè—")
            else:
                self.log_message("âœ— function_frameä¸å­˜åœ¨")
            
            self.analysis_toggle_var.set(False)
            self.analysis_toggle_btn.config(text="ğŸ“Š æ˜¾ç¤ºåˆ†æ\nShow Analysis")
            self.log_message("â„¹ å·²éšè—åˆ†ææŒ‰é’®é¢æ¿")
            
            # é‡æ–°é…ç½®gridæƒé‡
            self._reconfigure_grid_weights()
        else:
            # æ˜¾ç¤ºåˆ†æé¢æ¿
            self.log_message("ğŸ” å‡†å¤‡æ˜¾ç¤ºåˆ†æé¢æ¿...")
            if hasattr(self, 'function_frame'):
                self.function_frame.grid(row=2, column=0, sticky="ew", padx=10, pady=10)
                self.log_message("âœ“ function_frameå·²æ˜¾ç¤º")
            else:
                self.log_message("âœ— function_frameä¸å­˜åœ¨")
            
            self.analysis_toggle_var.set(True)
            self.analysis_toggle_btn.config(text="ğŸ“Š éšè—åˆ†æ\nHide Analysis")
            self.log_message("âœ“ å·²æ˜¾ç¤ºåˆ†ææŒ‰é’®é¢æ¿")
            
            # é‡æ–°é…ç½®gridæƒé‡
            self._reconfigure_grid_weights()
    
    def _reconfigure_grid_weights(self):
        """é‡æ–°é…ç½®gridæƒé‡ï¼Œç¡®ä¿notebookèƒ½å¤Ÿå®Œå…¨å¡«å……å‰©ä½™ç©ºé—´"""
        try:
            # ç¡®å®šnotebookåº”è¯¥åœ¨å“ªä¸€è¡Œ
            notebook_row = 3  # é»˜è®¤åœ¨ç¬¬3è¡Œ
            
            # æ ¹æ®é¢æ¿çš„æ˜¾ç¤ºçŠ¶æ€è°ƒæ•´notebookçš„ä½ç½®
            if not self.filter_toggle_var.get() and not self.analysis_toggle_var.get():
                # ä¸¤ä¸ªé¢æ¿éƒ½éšè—ï¼Œnotebookåœ¨ç¬¬1è¡Œï¼ˆé¡¶éƒ¨æ§åˆ¶æ ä¹‹åï¼‰
                notebook_row = 1
            elif not self.filter_toggle_var.get() and self.analysis_toggle_var.get():
                # åªæœ‰ç­›é€‰é¢æ¿éšè—ï¼Œnotebookåœ¨ç¬¬3è¡Œï¼ˆåˆ†æé¢æ¿ä¹‹åï¼‰
                notebook_row = 3
            elif self.filter_toggle_var.get() and not self.analysis_toggle_var.get():
                # åªæœ‰åˆ†æé¢æ¿éšè—ï¼Œnotebookåœ¨ç¬¬2è¡Œï¼ˆç­›é€‰é¢æ¿ä¹‹åï¼‰
                notebook_row = 2
            else:
                # ä¸¤ä¸ªé¢æ¿éƒ½æ˜¾ç¤ºï¼Œnotebookåœ¨ç¬¬3è¡Œ
                notebook_row = 3
            
            # é‡æ–°é…ç½®notebookå®¹å™¨çš„ä½ç½®
            self.notebook_container.grid(row=notebook_row, column=0, sticky="nsew", padx=0, pady=0)
            
            # é‡ç½®æ‰€æœ‰è¡Œçš„æƒé‡
            for i in range(4):
                self.main_frame.grid_rowconfigure(i, weight=0)
            
            # è®¾ç½®notebookè¡Œçš„æƒé‡ä¸º1ï¼Œä½¿å…¶èƒ½å¤Ÿæ‰©å±•
            self.main_frame.grid_rowconfigure(notebook_row, weight=1)
            
            self.log_message(f"âœ“ Gridæƒé‡å·²é‡æ–°é…ç½®ï¼Œnotebookåœ¨ç¬¬{notebook_row}è¡Œ")
            
        except Exception as e:
            self.log_message(f"âœ— é‡æ–°é…ç½®gridæƒé‡æ—¶å‡ºé”™: {e}")
    
    def _reposition_notebook_after_hide(self):
        """éšè—åˆ†æé¢æ¿åé‡æ–°å®šä½notebookï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨_reconfigure_grid_weightsï¼‰"""
        # ç›´æ¥è°ƒç”¨æ–°çš„gridæƒé‡é…ç½®æ–¹æ³•
        self._reconfigure_grid_weights()
    
    def _force_notebook_fill(self):
        """å¼ºåˆ¶notebookå¡«å……å‰©ä½™ç©ºé—´"""
        try:
            if hasattr(self, 'notebook_container') and hasattr(self, 'notebook'):
                # è·å–ä¸»æ¡†æ¶çš„å°ºå¯¸
                main_frame_height = self.main_frame.winfo_height()
                
                # è®¡ç®—å…¶ä»–ç»„ä»¶å ç”¨çš„é«˜åº¦
                other_height = 0
                for child in self.main_frame.winfo_children():
                    if child != self.notebook_container:
                        try:
                            child_height = child.winfo_reqheight()
                            other_height += child_height
                        except:
                            pass
                
                # è®¡ç®—notebookåº”è¯¥å ç”¨çš„é«˜åº¦ï¼Œä¸ç•™è¾¹è·
                available_height = main_frame_height - other_height
                
                if available_height > 50:  # ç¡®ä¿æœ‰è¶³å¤Ÿçš„é«˜åº¦
                    # å¼ºåˆ¶è®¾ç½®notebookå®¹å™¨çš„é«˜åº¦
                    self.notebook_container.configure(height=available_height)
                    self.notebook_container.pack_configure(fill="both", expand=True, padx=0, pady=0)
                    self.notebook.pack_configure(fill="both", expand=True, padx=0, pady=0)
                    
                    self.log_message(f"âœ“ Notebooké«˜åº¦å·²è®¾ç½®ä¸º: {available_height} (ä¸»æ¡†æ¶é«˜åº¦: {main_frame_height})")
                
                # å¤šæ¬¡å¼ºåˆ¶æ›´æ–°ï¼Œç¡®ä¿å¸ƒå±€ç”Ÿæ•ˆ
                self.root.update_idletasks()
                self.root.update()
                self.root.update_idletasks()
                
        except Exception as e:
            self.log_message(f"âœ— å¼ºåˆ¶å¡«å……notebookæ—¶å‡ºé”™: {e}")
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³•
            try:
                self.notebook_container.pack_configure(fill="both", expand=True, padx=0, pady=0)
                self.notebook.pack_configure(fill="both", expand=True, padx=0, pady=0)
            except:
                pass
    
    def _final_notebook_adjustment(self):
        """æœ€ç»ˆè°ƒæ•´notebookï¼Œç¡®ä¿å®Œå…¨å¡«å……"""
        try:
            if hasattr(self, 'notebook_container') and hasattr(self, 'notebook'):
                # è·å–ä¸»æ¡†æ¶çš„å®é™…é«˜åº¦
                self.root.update_idletasks()
                main_frame_height = self.main_frame.winfo_height()
                
                # å¼ºåˆ¶è®¾ç½®notebookå®¹å™¨å¡«å……æ•´ä¸ªä¸»æ¡†æ¶
                self.notebook_container.pack_configure(fill="both", expand=True, padx=0, pady=0)
                self.notebook.pack_configure(fill="both", expand=True, padx=0, pady=0)
                
                # å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œå°è¯•ç›´æ¥è®¾ç½®é«˜åº¦
                if main_frame_height > 100:
                    self.notebook_container.configure(height=main_frame_height)
                
                self.log_message(f"âœ“ æœ€ç»ˆè°ƒæ•´å®Œæˆï¼Œä¸»æ¡†æ¶é«˜åº¦: {main_frame_height}")
                
                # æœ€åä¸€æ¬¡å¼ºåˆ¶æ›´æ–°
                self.root.update_idletasks()
                self.root.update()
                
        except Exception as e:
            self.log_message(f"âœ— æœ€ç»ˆè°ƒæ•´å¤±è´¥: {e}")
    
    def _reposition_notebook_after_show(self):
        """æ˜¾ç¤ºåˆ†æé¢æ¿åé‡æ–°å®šä½notebookï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨_reconfigure_grid_weightsï¼‰"""
        # ç›´æ¥è°ƒç”¨æ–°çš„gridæƒé‡é…ç½®æ–¹æ³•
        self._reconfigure_grid_weights()
    
    def _delayed_notebook_show(self):
        """å»¶è¿Ÿæ˜¾ç¤ºnotebookï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨gridå¸ƒå±€ï¼‰"""
        # ç›´æ¥è°ƒç”¨æ–°çš„gridæƒé‡é…ç½®æ–¹æ³•
        self._reconfigure_grid_weights()
    
    def _simple_notebook_layout(self):
        """ç®€åŒ–çš„notebookå¸ƒå±€ç®¡ç†ï¼ˆä½¿ç”¨gridå¸ƒå±€ï¼‰"""
        if not hasattr(self, 'notebook') or not hasattr(self, 'notebook_container'):
            return
            
        # ä½¿ç”¨gridé‡æ–°é…ç½®notebookå®¹å™¨
        try:
            # ç¡®å®šnotebookåº”è¯¥åœ¨å“ªä¸€è¡Œ
            notebook_row = 3  # é»˜è®¤åœ¨ç¬¬3è¡Œ
            
            # æ ¹æ®é¢æ¿çš„æ˜¾ç¤ºçŠ¶æ€è°ƒæ•´notebookçš„ä½ç½®
            if not self.filter_toggle_var.get() and not self.analysis_toggle_var.get():
                # ä¸¤ä¸ªé¢æ¿éƒ½éšè—ï¼Œnotebookåœ¨ç¬¬1è¡Œï¼ˆé¡¶éƒ¨æ§åˆ¶æ ä¹‹åï¼‰
                notebook_row = 1
            elif not self.filter_toggle_var.get() and self.analysis_toggle_var.get():
                # åªæœ‰ç­›é€‰é¢æ¿éšè—ï¼Œnotebookåœ¨ç¬¬3è¡Œï¼ˆåˆ†æé¢æ¿ä¹‹åï¼‰
                notebook_row = 3
            elif self.filter_toggle_var.get() and not self.analysis_toggle_var.get():
                # åªæœ‰åˆ†æé¢æ¿éšè—ï¼Œnotebookåœ¨ç¬¬2è¡Œï¼ˆç­›é€‰é¢æ¿ä¹‹åï¼‰
                notebook_row = 2
            else:
                # ä¸¤ä¸ªé¢æ¿éƒ½æ˜¾ç¤ºï¼Œnotebookåœ¨ç¬¬3è¡Œ
                notebook_row = 3
            
        # é‡æ–°é…ç½®notebookå®¹å™¨
            self.notebook_container.grid(row=notebook_row, column=0, sticky="nsew", padx=0, pady=0)
            
            # é‡ç½®æ‰€æœ‰è¡Œçš„æƒé‡
            for i in range(4):
                self.main_frame.grid_rowconfigure(i, weight=0)
            
            # è®¾ç½®notebookè¡Œçš„æƒé‡ä¸º1ï¼Œä½¿å…¶èƒ½å¤Ÿæ‰©å±•
            self.main_frame.grid_rowconfigure(notebook_row, weight=1)
            
            # ç¡®ä¿notebookå¡«å……å®¹å™¨ï¼ˆnotebookå†…éƒ¨ä½¿ç”¨packæ˜¯å…è®¸çš„ï¼‰
            self.notebook.pack(fill="both", expand=True, padx=0, pady=0)
            
            self.log_message(f"âœ“ Notebookå¸ƒå±€å·²æ›´æ–°ï¼Œåœ¨ç¬¬{notebook_row}è¡Œ")
            
            # å¼ºåˆ¶æ›´æ–°å¸ƒå±€
            self.root.update_idletasks()
            self.root.update()
            
        except Exception as e:
            self.log_message(f"âœ— æ›´æ–°notebookå¸ƒå±€æ—¶å‡ºé”™: {e}")
    
    def _reconfigure_notebook_layout(self):
        """é‡æ–°é…ç½®notebookå¸ƒå±€"""
        if not hasattr(self, 'notebook'):
            return
            
        # å…ˆç§»é™¤notebook
        self.notebook.pack_forget()
        
        # ç«‹å³æ›´æ–°å¸ƒå±€ï¼Œç¡®ä¿pack_forgetç”Ÿæ•ˆ
        self.root.update_idletasks()
        
        # æ ¹æ®åˆ†æé¢æ¿çŠ¶æ€é‡æ–°é…ç½®
        if hasattr(self, 'function_frame') and self.analysis_toggle_var.get():
            # åˆ†æé¢æ¿æ˜¾ç¤ºæ—¶ï¼Œnotebookåœ¨function_frameä¹‹å
            # ä½¿ç”¨æ›´ç¨³å®šçš„å¸ƒå±€æ–¹æ³•
            self.notebook.pack(fill="both", expand=True, padx=0, pady=0)
            self.log_message("âœ“ Notebookå¸ƒå±€ï¼šæ˜¾ç¤ºåˆ†æé¢æ¿æ¨¡å¼")
        else:
            # åˆ†æé¢æ¿éšè—æ—¶ï¼Œnotebookå¡«å……æ•´ä¸ªå‰©ä½™ç©ºé—´
            self.notebook.pack(fill="both", expand=True, padx=0, pady=0)
            self.log_message("âœ“ Notebookå¸ƒå±€ï¼šéšè—åˆ†æé¢æ¿æ¨¡å¼")
        
        # å¼ºåˆ¶æ›´æ–°å¸ƒå±€
        self.root.update_idletasks()
        
        # éªŒè¯notebookæ˜¯å¦æ­£ç¡®æ˜¾ç¤º
        try:
            pack_info = self.notebook.pack_info()
            self.log_message(f"âœ“ Notebook packä¿¡æ¯: {pack_info}")
        except:
            self.log_message("âœ— Notebookæ˜¾ç¤ºå¼‚å¸¸")
    
    def refresh_current_display(self):
        """æ ¹æ®å½“å‰æ´»åŠ¨çš„æ ‡ç­¾é¡µé‡æ–°æ˜¾ç¤ºæ•°æ®"""
        try:
            # è·å–å½“å‰ä¸»æ ‡ç­¾é¡µ
            current_main_tab = self.notebook.index(self.notebook.select())
            
            if current_main_tab == 0:  # Salesæ ‡ç­¾é¡µ
                # è·å–å½“å‰å­æ ‡ç­¾é¡µ
                current_sub_tab = self.sales_notebook.index(self.sales_notebook.select())
                
                if current_sub_tab == 0:  # é”€å”®æ•°æ®
                    if hasattr(self, 'sales_data') and self.sales_data:
                        self.display_sales_data()
                        self.log_message("âœ“ å·²åˆ·æ–°é”€å”®æ•°æ®æ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰é”€å”®æ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 1:  # æ”¯ä»˜æ–¹å¼åˆ†æ
                    if hasattr(self, 'payment_data') and self.payment_data:
                        self.display_payment_analysis()
                        self.log_message("âœ“ å·²åˆ·æ–°æ”¯ä»˜æ–¹å¼åˆ†ææ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰æ”¯ä»˜æ–¹å¼åˆ†ææ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 2:  # æŠ˜æ‰£åˆ†æ
                    if hasattr(self, 'discount_data') and self.discount_data:
                        self.display_discount_analysis()
                        self.log_message("âœ“ å·²åˆ·æ–°æŠ˜æ‰£åˆ†ææ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰æŠ˜æ‰£åˆ†ææ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 3:  # æœˆåº¦æ±‡æ€»
                    if hasattr(self, 'monthly_data') and self.monthly_data:
                        self.display_monthly_summary()
                        self.log_message("âœ“ å·²åˆ·æ–°æœˆåº¦æ±‡æ€»æ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰æœˆåº¦æ±‡æ€»æ•°æ®å¯æ˜¾ç¤º")
                        
            elif current_main_tab == 1:  # Productæ ‡ç­¾é¡µ
                # è·å–å½“å‰å­æ ‡ç­¾é¡µ
                current_sub_tab = self.product_notebook.index(self.product_notebook.select())
                
                if current_sub_tab == 0:  # æ—¥-äº§å“æ•°æ®
                    if hasattr(self, 'product_overview_data') and self.product_overview_data:
                        self.display_product_overview()
                        self.log_message("âœ“ å·²åˆ·æ–°æ—¥-äº§å“æ•°æ®æ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰æ—¥-äº§å“æ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 1:  # å‘¨-äº§å“æ•°æ®
                    if hasattr(self, 'weekly_product_data') and self.weekly_product_data:
                        self.display_weekly_product_data()
                        self.log_message("âœ“ å·²åˆ·æ–°å‘¨-äº§å“æ•°æ®æ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰å‘¨-äº§å“æ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 2:  # æœŸé—´-äº§å“æ•°æ®
                    if hasattr(self, 'period_product_overview_data') and self.period_product_overview_data:
                        # é‡æ–°æ˜¾ç¤ºæœŸé—´äº§å“æ•°æ®ï¼Œè¿™ä¼šå“åº”æ—¥å‡åˆ‡æ¢
                        self.display_period_product_overview()
                        self.log_message("âœ“ å·²åˆ·æ–°æœŸé—´-äº§å“æ•°æ®æ˜¾ç¤º")
                    else:
                        # å¦‚æœæ²¡æœ‰æœŸé—´äº§å“æ•°æ®ï¼Œè‡ªåŠ¨è·å–æ•°æ®
                        self.log_message("â„¹ æœŸé—´-äº§å“æ•°æ®ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨è·å–æ•°æ®...")
                        self.get_period_product_overview()
                    
                    # ç¡®ä¿åœ¨æœŸé—´äº§å“æ•°æ®æ ‡ç­¾é¡µä¿æŒä¸è·³è½¬
                    return
                        
                elif current_sub_tab == 3:  # æ—¥-äº§å“åˆ†æ
                    if hasattr(self, 'sales_tc_analysis_data') and self.sales_tc_analysis_data:
                        self.display_sales_tc_analysis()
                        self.log_message("âœ“ å·²åˆ·æ–°æ—¥-äº§å“åˆ†ææ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰æ—¥-äº§å“åˆ†ææ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 4:  # æœˆ-äº§å“åˆ†æ
                    if hasattr(self, 'sales_tc_monthly_data') and self.sales_tc_monthly_data:
                        self.display_sales_tc_monthly()
                        self.log_message("âœ“ å·²åˆ·æ–°æœˆ-äº§å“åˆ†ææ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰æœˆ-äº§å“åˆ†ææ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 5:  # äº§å“å…³è”åˆ†æ
                    if hasattr(self, 'product_association_data') and self.product_association_data:
                        # éœ€è¦é‡æ–°è·å–é€‰ä¸­çš„äº§å“åç§°
                        selected_product = getattr(self, 'last_selected_product', '')
                        if selected_product:
                            self.display_product_association_analysis(self.product_association_data, selected_product)
                            self.log_message("âœ“ å·²åˆ·æ–°äº§å“å…³è”åˆ†ææ˜¾ç¤º")
                        else:
                            self.log_message("â„¹ æ²¡æœ‰äº§å“å…³è”åˆ†ææ•°æ®å¯æ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰äº§å“å…³è”åˆ†ææ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 6:  # ç±»åˆ«åˆ†æ
                    if hasattr(self, 'category_analysis_data') and self.category_analysis_data:
                        self.display_category_analysis()
                        self.log_message("âœ“ å·²åˆ·æ–°ç±»åˆ«åˆ†ææ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰ç±»åˆ«åˆ†ææ•°æ®å¯æ˜¾ç¤º")
                        
            elif current_main_tab == 2:  # Brandæ ‡ç­¾é¡µ
                # è·å–å½“å‰å­æ ‡ç­¾é¡µ
                current_sub_tab = self.brand_notebook.index(self.brand_notebook.select())
                
                if current_sub_tab == 0:  # æ¯æ—¥ç»†é¡¹
                    if hasattr(self, 'brand_daily_data') and self.brand_daily_data:
                        self.display_brand_daily_breakdown()
                        self.log_message("âœ“ å·²åˆ·æ–°æ¯æ—¥ç»†é¡¹æ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰æ¯æ—¥ç»†é¡¹æ•°æ®å¯æ˜¾ç¤º")
                        
                elif current_sub_tab == 1:  # æœŸé—´æ±‡æ€»
                    if hasattr(self, 'brand_period_data') and self.brand_period_data:
                        self.display_brand_period_summary()
                        self.log_message("âœ“ å·²åˆ·æ–°æœŸé—´æ±‡æ€»æ˜¾ç¤º")
                    else:
                        self.log_message("â„¹ æ²¡æœ‰æœŸé—´æ±‡æ€»æ•°æ®å¯æ˜¾ç¤º")
                        
            else:
                self.log_message("â„¹ å½“å‰æ ‡ç­¾é¡µä¸æ”¯æŒæ˜¾ç¤ºå¼€å…³åŠŸèƒ½")
                
        except Exception as e:
            self.log_message(f"âœ— åˆ·æ–°æ˜¾ç¤ºæ—¶å‡ºé”™: {e}")
    
    def validate_date_range(self):
        """éªŒè¯æ—¥æœŸèŒƒå›´"""
        try:
            from datetime import datetime
            
            # å¦‚æœæœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œç›´æ¥è¿”å›True
            if not self.use_date_filter.get():
                self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
                return True
                
            date_from = self.date_from.get_date()
            date_to = self.date_to.get_date()
            current_date = datetime.now().date()
            
            # æ·»åŠ è°ƒè¯•ä¿¡æ¯
            self.log_message(f"ğŸ” æ—¥æœŸéªŒè¯è°ƒè¯•ä¿¡æ¯:")
            self.log_message(f"   å½“å‰ç³»ç»Ÿæ—¥æœŸ: {current_date.strftime('%Y-%m-%d')}")
            self.log_message(f"   é€‰æ‹©çš„å¼€å§‹æ—¥æœŸ: {date_from.strftime('%Y-%m-%d') if date_from else 'None'}")
            self.log_message(f"   é€‰æ‹©çš„ç»“æŸæ—¥æœŸ: {date_to.strftime('%Y-%m-%d') if date_to else 'None'}")
            
            if date_from and date_to:
                if date_from > date_to:
                    self.log_message("âš  å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ")
                    return False
                elif date_from > current_date:
                    self.log_message(f"âš  å¼€å§‹æ—¥æœŸä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸ (å½“å‰æ—¥æœŸ: {current_date.strftime('%Y-%m-%d')})")
                    return False
                elif date_to > current_date:
                    self.log_message(f"âš  ç»“æŸæ—¥æœŸä¸èƒ½æ˜¯æœªæ¥æ—¥æœŸ (å½“å‰æ—¥æœŸ: {current_date.strftime('%Y-%m-%d')})")
                    return False
                else:
                    self.log_message(f"âœ“ æ—¥æœŸèŒƒå›´æœ‰æ•ˆ: {date_from.strftime('%Y-%m-%d')} åˆ° {date_to.strftime('%Y-%m-%d')}")
                    return True
            else:
                self.log_message("â„¹ æœªé€‰æ‹©æ—¥æœŸèŒƒå›´ï¼Œå°†æŸ¥è¯¢æ‰€æœ‰æ•°æ®")
                return True
        except Exception as e:
            self.log_message(f"âœ— æ—¥æœŸéªŒè¯å¤±è´¥: {e}")
            import traceback
            self.log_message(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            return False
    
    def set_current_month_dates(self):
        """è®¾ç½®å½“å‰æœˆä»½çš„æ—¥æœŸèŒƒå›´"""
        try:
            from datetime import datetime, timedelta
            
            now = datetime.now()
            # è®¾ç½®ä¸ºæœ¬æœˆç¬¬ä¸€å¤©
            first_day = now.replace(day=1)
            # è®¾ç½®ä¸ºä»Šå¤©
            today = now.date()
            
            # æ›´æ–°æ—¥æœŸè¾“å…¥æ¡†
            self.date_from.set_date(first_day.date())
            self.date_to.set_date(today)
            
            self.log_message(f"âœ“ å·²è®¾ç½®æ—¥æœŸèŒƒå›´: {first_day.strftime('%Y-%m-%d')} åˆ° {today.strftime('%Y-%m-%d')}")
            
        except Exception as e:
            self.log_message(f"âœ— è®¾ç½®å½“å‰æœˆä»½æ—¥æœŸå¤±è´¥: {e}")
    
    def test_database_connection(self):
        """æµ‹è¯•æ•°æ®åº“è¿æ¥å’Œæ•°æ®å¯ç”¨æ€§"""
        try:
            self.log_message("ğŸ” å¼€å§‹æ•°æ®åº“è¿æ¥æµ‹è¯•...")
            
            # æµ‹è¯•è¿æ¥
            db = self.selected_db.get()
            self.log_message(f"æ­£åœ¨æµ‹è¯•è¿æ¥åˆ° {db}...")
            
            if not self.db_manager.connect(db):
                self.log_message(f"âœ— æ— æ³•è¿æ¥åˆ° {db}")
                return False
            
            self.log_message(f"âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ", include_db_info=True)
            
            # æ˜¾ç¤ºæ•°æ®åº“è¯¦ç»†ä¿¡æ¯
            self.log_database_info()
            
            # æµ‹è¯•åŸºæœ¬æŸ¥è¯¢
            cursor = self.db_manager.connection.cursor()
            
            # æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            tables_to_check = ["pos_sales_dtls", "pos_sales_payment_dtls", "pos_cancel_sales_item_dtls", "item_master"]
            for table in tables_to_check:
                try:
                    cursor.execute(f"SELECT COUNT(*) FROM {table}")
                    count = cursor.fetchone()[0]
                    self.log_message(f"âœ“ è¡¨ {table}: {count} æ¡è®°å½•")
                except Exception as e:
                    self.log_message(f"âœ— è¡¨ {table} æŸ¥è¯¢å¤±è´¥: {e}")
            
            # æ£€æŸ¥æ—¥æœŸèŒƒå›´å†…çš„æ•°æ®
            if self.use_date_filter.get():
                date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
                date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
                
                if date_from and date_to:
                    try:
                        test_query = f"SELECT COUNT(*) FROM pos_sales_dtls WHERE c_date >= '{date_from} 00:00:00' AND c_date <= '{date_to} 23:59:59'"
                        cursor.execute(test_query)
                        count = cursor.fetchone()[0]
                        self.log_message(f"âœ“ æ—¥æœŸèŒƒå›´ {date_from} åˆ° {date_to} çš„æ•°æ®: {count} æ¡è®°å½•")
                        
                        if count == 0:
                            self.log_message("âš  è¯¥æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰æ•°æ®ï¼Œè¯·æ£€æŸ¥æ—¥æœŸèŒƒå›´æˆ–æ•°æ®åº“ä¸­çš„æ•°æ®")
                    except Exception as e:
                        self.log_message(f"âœ— æ—¥æœŸèŒƒå›´æŸ¥è¯¢å¤±è´¥: {e}")
            
            cursor.close()
            self.log_message("âœ“ æ•°æ®åº“è¿æ¥æµ‹è¯•å®Œæˆ")
            return True
            
        except Exception as e:
            self.log_message(f"âœ— æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: {e}")
            import traceback
            self.log_message(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            return False
    
    def clear_cache(self):
        """æ¸…ç†æ‰€æœ‰ç¼“å­˜"""
        try:
            # æ¸…ç†æ•°æ®åº“ç®¡ç†å™¨çš„ç¼“å­˜
            if hasattr(self.db_manager, '_weekly_cache'):
                self.db_manager._weekly_cache.clear()
            if hasattr(self.db_manager, '_sales_tc_cache'):
                self.db_manager._sales_tc_cache.clear()
            if hasattr(self.db_manager, '_sales_cache'):
                self.db_manager._sales_cache.clear()
            if hasattr(self.db_manager, '_category_cache'):
                self.db_manager._category_cache.clear()
            if hasattr(self.db_manager, '_product_cache'):
                self.db_manager._product_cache.clear()
            if hasattr(self.db_manager, '_period_product_cache'):
                self.db_manager._period_product_cache.clear()
            if hasattr(self.db_manager, '_payment_cache'):
                self.db_manager._payment_cache.clear()
            if hasattr(self.db_manager, '_sales_tc_monthly_cache'):
                self.db_manager._sales_tc_monthly_cache.clear()
            
            self.log_message("âœ“ å·²æ¸…ç†æ‰€æœ‰ç¼“å­˜")
            return True
            
        except Exception as e:
            self.log_message(f"âœ— æ¸…ç†ç¼“å­˜å¤±è´¥: {e}")
            return False
    
    def check_database_dates(self):
        """æ£€æŸ¥æ•°æ®åº“ä¸­çš„æ—¥æœŸæ ¼å¼å’ŒèŒƒå›´"""
        try:
            if not self.db_manager.connection:
                self.log_message("â„¹ è¯·å…ˆè¿æ¥æ•°æ®åº“")
                return
            
            cursor = self.db_manager.connection.cursor()
            
            # æ£€æŸ¥c_dateå­—æ®µçš„æ ¼å¼å’ŒèŒƒå›´
            query = """
                SELECT TOP 5 
                    c_date,
                    FORMAT(c_date, 'yyyy-MM-dd') as date_only,
                    FORMAT(c_date, 'yyyy-MM-dd HH:mm:ss') as date_time
                FROM pos_sales_dtls 
                ORDER BY c_date DESC
            """
            
            try:
                cursor.execute(query)
                results = cursor.fetchall()
            except Exception as query_error:
                print(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"æŸ¥è¯¢è¯­å¥: {query[:200]}...")
                cursor.close()
                return []
            finally:
                cursor.close()
            
            self.log_message("â„¹ æ•°æ®åº“ä¸­çš„æ—¥æœŸæ ¼å¼ç¤ºä¾‹:")
            for row in results:
                self.log_message(f"  - åŸå§‹: {row[0]}, æ—¥æœŸ: {row[1]}, æ—¥æœŸæ—¶é—´: {row[2]}")
                
        except Exception as e:
            self.log_message(f"âœ— æ£€æŸ¥æ•°æ®åº“æ—¥æœŸå¤±è´¥: {e}")
    
    def verify_data_accuracy(self):
        """éªŒè¯æ•°æ®å‡†ç¡®æ€§"""
        try:
            # å…ˆè¿æ¥æ•°æ®åº“
            db = self.selected_db.get()
            self.log_message(f"æ­£åœ¨è¿æ¥åˆ° {db}...")
            
            if not self.db_manager.connect(db):
                self.log_message(f"âœ— æ— æ³•è¿æ¥åˆ° {db}")
                return
            
            self.log_message(f"âœ“ è¿æ¥æˆåŠŸ", include_db_info=True)
            
            # è·å–å½“å‰ç­›é€‰æ¡ä»¶
            # æ ¹æ®æ—¥æœŸç­›é€‰å¼€å…³å†³å®šæ˜¯å¦ä½¿ç”¨æ—¥æœŸç­›é€‰
            if self.use_date_filter.get():
                date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
                date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
                
                # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
                if date_from and date_to and date_from == date_to:
                    self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
                elif date_to:
                    self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
            else:
                # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
                date_from = None
                date_to = None
            
            outlet_filters = self.outlet_combo.get_selected()
            product_filters = self.product_combo.get_selected()
            month_filters = self.month_combo.get_selected()
            weekday_filters = self.weekday_combo.get_selected()
            print(f"GUIè·å–çš„æ˜ŸæœŸç­›é€‰: {weekday_filters}")
            category_filters = self.category_combo.get_selected()
            payment_filters = self.payment_combo.get_selected_for_filter()
            
            self.log_message("=" * 50)
            self.log_message("ğŸ” å¼€å§‹éªŒè¯æ•°æ®å‡†ç¡®æ€§...")
            self.log_message(f"ğŸ“… æŸ¥è¯¢æ—¥æœŸ: {date_from} åˆ° {date_to}")
            self.log_message(f"ğŸª é—¨å¸‚ç­›é€‰: {outlet_filters if outlet_filters else 'å…¨éƒ¨'}")
            self.log_message(f"ğŸ“¦ äº§å“ç­›é€‰: {product_filters if product_filters else 'å…¨éƒ¨'}")
            self.log_message(f"ğŸ“† æœˆä»½ç­›é€‰: {month_filters if month_filters else 'å…¨éƒ¨'}")
            self.log_message(f"ğŸ“… æ˜ŸæœŸç­›é€‰: {weekday_filters if weekday_filters else 'å…¨éƒ¨'}")
            self.log_message(f"ğŸ“‚ ç±»åˆ«ç­›é€‰: {category_filters if category_filters else 'å…¨éƒ¨'}")
            self.log_message(f"ğŸ’³ æ”¯ä»˜ç­›é€‰: {payment_filters if payment_filters else 'å…¨éƒ¨'}")
            self.log_message("=" * 50)
            
            # 1. éªŒè¯é”€å”®æ•°æ®
            self.log_message("1ï¸âƒ£ éªŒè¯é”€å”®æ•°æ®...")
            sales_data = self.db_manager.get_sales_data(
                date_from, date_to, outlet_filters, product_filters, None, month_filters, weekday_filters, category_filters, payment_filters
            )
            
            if sales_data:
                self.log_message(f"âœ… é”€å”®æ•°æ®: å…± {len(sales_data)} æ¡è®°å½•")
                
                # è®¡ç®—æ€»é‡‘é¢
                total_amount = sum(float(row[8]) for row in sales_data if row[8])  # é‡‘é¢åˆ—
                self.log_message(f"ğŸ’° é”€å”®æ€»é‡‘é¢: ${total_amount:,.2f}")
                
                # æŒ‰é—¨å¸‚ç»Ÿè®¡
                store_stats = {}
                for row in sales_data:
                    store = row[0]  # é—¨å¸‚åˆ—
                    amount = float(row[8]) if row[8] else 0
                    if store not in store_stats:
                        store_stats[store] = {'count': 0, 'amount': 0}
                    store_stats[store]['count'] += 1
                    store_stats[store]['amount'] += amount
                
                self.log_message("ğŸª å„é—¨å¸‚é”€å”®ç»Ÿè®¡:")
                for store, stats in sorted(store_stats.items()):
                    self.log_message(f"   {store}: {stats['count']} ç¬”, ${stats['amount']:,.2f}")
            else:
                self.log_message("âŒ é”€å”®æ•°æ®: æ— æ•°æ®")
            
            # 2. éªŒè¯æœˆåº¦æ±‡æ€»æ•°æ®
            self.log_message("\n2ï¸âƒ£ éªŒè¯æœˆåº¦æ±‡æ€»æ•°æ®...")
            monthly_data = self.db_manager.get_monthly_summary_optimized(
                date_from, date_to, outlet_filters, product_filters, month_filters, category_filters, payment_filters
            )
            
            if monthly_data:
                self.log_message(f"âœ… æœˆåº¦æ±‡æ€»: å…± {len(monthly_data)} æ¡è®°å½•")
                
                # è®¡ç®—æœˆåº¦æ±‡æ€»æ€»é‡‘é¢
                monthly_total = sum(float(row[5]) for row in monthly_data if row[5])  # é‡‘é¢åˆ—
                self.log_message(f"ğŸ’° æœˆåº¦æ±‡æ€»æ€»é‡‘é¢: ${monthly_total:,.2f}")
                
                # æŒ‰æœˆä»½ç»Ÿè®¡
                month_stats = {}
                for row in monthly_data:
                    month = row[0]  # æœˆä»½åˆ—
                    amount = float(row[5]) if row[5] else 0
                    if month not in month_stats:
                        month_stats[month] = {'count': 0, 'amount': 0}
                    month_stats[month]['count'] += 1
                    month_stats[month]['amount'] += amount
                
                self.log_message("ğŸ“… å„æœˆä»½ç»Ÿè®¡:")
                for month, stats in sorted(month_stats.items()):
                    self.log_message(f"   {month}: {stats['count']} æ¡, ${stats['amount']:,.2f}")
            else:
                self.log_message("âŒ æœˆåº¦æ±‡æ€»: æ— æ•°æ®")
            
            # 3. éªŒè¯æ”¯ä»˜æ–¹å¼åˆ†ææ•°æ®
            self.log_message("\n3ï¸âƒ£ éªŒè¯æ”¯ä»˜æ–¹å¼åˆ†ææ•°æ®...")
            payment_data = self.db_manager.get_payment_summary(
                date_from, date_to, outlet_filters, month_filters, category_filters, payment_filters
            )
            
            if payment_data:
                self.log_message(f"âœ… æ”¯ä»˜æ–¹å¼åˆ†æ: å…± {len(payment_data)} æ¡è®°å½•")
                
                # è®¡ç®—æ”¯ä»˜æ–¹å¼æ€»é‡‘é¢
                payment_total = sum(float(row[4]) for row in payment_data if row[4])  # é‡‘é¢åˆ—
                self.log_message(f"ğŸ’° æ”¯ä»˜æ–¹å¼æ€»é‡‘é¢: ${payment_total:,.2f}")
                
                # æŒ‰æ”¯ä»˜æ–¹å¼ç»Ÿè®¡
                payment_stats = {}
                for row in payment_data:
                    payment = row[0]  # æ”¯ä»˜æ–¹å¼åˆ—
                    amount = float(row[4]) if row[4] else 0
                    if payment not in payment_stats:
                        payment_stats[payment] = {'count': 0, 'amount': 0}
                    payment_stats[payment]['count'] += 1
                    payment_stats[payment]['amount'] += amount
                
                self.log_message("ğŸ’³ å„æ”¯ä»˜æ–¹å¼ç»Ÿè®¡:")
                for payment, stats in sorted(payment_stats.items()):
                    self.log_message(f"   {payment}: {stats['count']} ç¬”, ${stats['amount']:,.2f}")
            else:
                self.log_message("âŒ æ”¯ä»˜æ–¹å¼åˆ†æ: æ— æ•°æ®")
            
            # 4. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
            self.log_message("\n4ï¸âƒ£ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥...")
            if sales_data and monthly_data:
                sales_total = sum(float(row[8]) for row in sales_data if row[8])
                monthly_total = sum(float(row[5]) for row in monthly_data if row[5])
                difference = abs(sales_total - monthly_total)
                
                if difference < 0.01:  # å…è®¸0.01çš„è¯¯å·®
                    self.log_message("âœ… é”€å”®æ•°æ®ä¸æœˆåº¦æ±‡æ€»æ•°æ®ä¸€è‡´")
                else:
                    self.log_message(f"âš ï¸ æ•°æ®ä¸ä¸€è‡´! é”€å”®æ•°æ®: ${sales_total:,.2f}, æœˆåº¦æ±‡æ€»: ${monthly_total:,.2f}, å·®å¼‚: ${difference:,.2f}")
            
            self.log_message("=" * 50)
            self.log_message("âœ… æ•°æ®éªŒè¯å®Œæˆ")
            
        except Exception as e:
            self.log_message(f"âœ— æ•°æ®éªŒè¯å¤±è´¥: {e}")
        finally:
            # æ–­å¼€æ•°æ®åº“è¿æ¥
            self.db_manager.disconnect()
        
        # å­˜å‚¨æ•°æ®
        self.sales_data = []
        self.payment_data = []
        self.discount_data = []
        self.monthly_data = []
        
        # æ´»åŠ¨è®°å½•å­˜å‚¨
        self.activity_records = []
    
    def setup_global_themes(self):
        """è¨­ç½®åŸºæ–¼SEAutomation.pyé¢¨æ ¼çš„ç¾ä»£ä¸»é¡Œå’Œæ¨£å¼"""
        try:
            # ä½¿ç”¨clamä¸»é¡Œï¼Œå°è‡ªå®šç¾©æ¨£å¼æ”¯æŒæ›´å¥½
            style = ttk.Style()
            style.theme_use('clam')
            
            # ğŸ¨ ç¾ä»£æ¸…æ–°é…è‰²æ–¹æ¡ˆ - å®Œå…¨ç„¡ç°è‰²
            # ä¸»èƒŒæ™¯ - ç´”ç™½ (#FFFFFF) 
            # é¢æ¿èƒŒæ™¯ - ç´”ç™½ (#FFFFFF)
            # ä¸»è¦è—è‰² - å°ˆæ¥­è— (#2196F3)
            # æˆåŠŸç¶ è‰² - æ¸…æ–°ç¶  (#4CAF50)
            # è­¦å‘Šæ©™è‰² - æº«æš–æ©™ (#FF9800)
            # éŒ¯èª¤ç´…è‰² - æŸ”å’Œç´… (#F44336)
            # æ¬¡åˆ°ç´«è‰² - å„ªé›…ç´« (#9C27B0)
            # è¼¸å…¥æ¡†èƒŒæ™¯ - ç´”ç™½ (#FFFFFF)
            # æ–‡å­—é¡è‰² - ç´”é»‘ (#000000)
            
            # ç¾ä»£åŒ–Treeviewæ¨£å¼ - å®Œå…¨ç´”ç™½ä¸»é¡Œ
            style.configure("Treeview", 
                           background="#FFFFFF",  # ç´”ç™½èƒŒæ™¯
                           foreground="#000000",  # ç´”é»‘æ–‡å­—
                           fieldbackground="#FFFFFF",
                           rowheight=36,  # å¢åŠ è¡Œé«˜
                           font=('Segoe UI', 10),
                           relief="flat",
                           borderwidth=1)
            
            # ç¾ä»£åŒ–è¡¨æ ¼è¡¨é ­ - å°ˆæ¥­è—è‰²
            style.configure("Treeview.Heading", 
                           font=('Segoe UI', 11, 'bold'),
                           background="#2196F3",  # å°ˆæ¥­è—
                           foreground="#FFFFFF",
                           relief="flat",
                           borderwidth=0,
                           padding=(16, 14))
            
            # è¡¨é ­ç‹€æ…‹æ˜ å°„
            style.map("Treeview.Heading",
                     background=[('active', '#1976D2'),
                                ('!active', '#2196F3')],
                     foreground=[('active', '#FFFFFF'),
                                ('!active', '#FFFFFF')])
            
            # ç¾ä»£åŒ–LabelFrameæ¨£å¼ - æ¸…æ–°ä¸»é¡Œ
            style.configure("LabelFrame",
                           background="#FFFFFF",  # ç´”ç™½èƒŒæ™¯
                           foreground="#2196F3",  # å°ˆæ¥­è—
                           font=('Segoe UI', 11, 'bold'),
                           relief="flat",
                           borderwidth=2)
            
            style.configure("LabelFrame.Label",
                           background="#FFFFFF",
                           foreground="#2196F3",
                           font=('Segoe UI', 11, 'bold'))
            
            # ç¾ä»£åŒ–ä¸»æŒ‰éˆ•æ¨£å¼ - æ¸…æ–°å°ˆæ¥­ä¸»é¡Œ
            style.configure("Modern.TButton",
                           font=('Segoe UI', 11, 'bold'),
                           background="#2196F3",  # å°ˆæ¥­è—
                           foreground="#FFFFFF",
                           relief="flat",
                           borderwidth=0,
                           padding=(18, 14))
            
            style.map("Modern.TButton",
                     background=[('active', '#1976D2'),
                                ('!active', '#2196F3'),
                                ('pressed', '#1565C0')])
            
            # ç¾ä»£åŒ–æ¬¡è¦æŒ‰éˆ•æ¨£å¼ - ç´”ç™½ä¸»é¡Œ
            style.configure("Secondary.TButton",
                           font=('Segoe UI', 10),
                           background="#FFFFFF",  # ç´”ç™½
                           foreground="#2196F3",  # è—è‰²æ–‡å­—
                           relief="solid",
                           borderwidth=2,
                           padding=(14, 10))
            
            style.map("Secondary.TButton",
                     background=[('active', '#E3F2FD'),
                                ('!active', '#FFFFFF')])
            
            # ç¾ä»£åŒ–æ¨™ç±¤é æ¨£å¼ - ç´”ç™½ä¸»é¡Œ
            style.configure("Modern.TNotebook",
                           background="#FFFFFF",  # ç´”ç™½
                           tabposition="n",
                           borderwidth=0)
            
            style.configure("Modern.TNotebook.Tab",
                           background="#E3F2FD",  # éå¸¸æ·ºçš„è—è‰²
                           foreground="#1976D2",  # æ·±è—è‰²
                           padding=(22, 14),
                           font=('Segoe UI', 11, 'bold'))
            
            style.map("Modern.TNotebook.Tab",
                     background=[('selected', '#2196F3'),  # å°ˆæ¥­è—
                                ('active', '#FFFFFF')],  # ç´”ç™½
                     foreground=[('selected', '#FFFFFF'),
                                ('active', '#000000')])
            
            # ç¾ä»£åŒ–è¼¸å…¥æ¡†æ¨£å¼ - ç´”ç™½ä¸»é¡Œ
            style.configure("Modern.TCombobox",
                           font=('Segoe UI', 10),
                           background="#FFFFFF",  # ç´”ç™½
                           foreground="#000000",  # ç´”é»‘
                           borderwidth=2,
                           relief="solid",
                           lightcolor="#2196F3",  # å°ˆæ¥­è—
                           darkcolor="#2196F3")
            
            style.configure("Modern.TEntry",
                           font=('Segoe UI', 10),
                           background="#FFFFFF",
                           foreground="#000000",
                           borderwidth=2,
                           relief="solid",
                           lightcolor="#2196F3",
                           darkcolor="#2196F3")

            
            # ç¾ä»£åŒ–æ»‘å‹•æ¢æ¨£å¼ - ç´”ç™½ä¸»é¡Œ
            style.configure("Modern.TScrollbar",
                           background="#E3F2FD",  # æ·ºè—è‰²
                           troughcolor="#FFFFFF",  # ç´”ç™½
                           borderwidth=0,
                           lightcolor="#2196F3",  # å°ˆæ¥­è—
                           darkcolor="#2196F3")
            
            # ç¾ä»£åŒ–æ ¸å–æ–¹å¡Šå’Œå–®é¸æŒ‰éˆ• - ç´”ç™½ä¸»é¡Œ
            style.configure("Modern.TCheckbutton",
                           font=('Segoe UI', 10),
                           focuscolor="#2196F3",  # å°ˆæ¥­è—
                           background="#FFFFFF",  # ç´”ç™½
                           foreground="#000000")  # ç´”é»‘
            
            style.configure("Modern.TRadiobutton",
                           font=('Segoe UI', 10),
                           focuscolor="#2196F3",
                           background="#FFFFFF",
                           foreground="#000000")
            
            print("âœ… æ´»å‹•è¨˜éŒ„ç®¡ç†ä¸­å¿ƒé¢¨æ ¼ä¸»é¡Œå’Œæ¨£å¼å·²æ‡‰ç”¨")
            
        except Exception as e:
            print(f"è¨­ç½®ç¾ä»£åŒ–ä¸»é¡Œå¤±æ•—: {e}")
    
    def startup_database_update(self):
        """å•Ÿå‹•æ™‚è‡ªå‹•æ›´æ–°å–®æ“šæ˜ç´°æ•¸æ“šåº« - å¾Œå°éœé»˜æ›´æ–°"""
        try:
            print("ğŸš€ å•Ÿå‹•æ™‚è‡ªå‹•æ›´æ–°å–®æ“šæ˜ç´°æ•¸æ“šåº«...")
            
            # å»¶é²å°å…¥é¿å…å¾ªç’°å°å…¥
            from receipt_database_manager import ReceiptDatabaseManager
            self.receipt_db_manager = ReceiptDatabaseManager()
            
            # ç°¡åŒ–çš„é€²åº¦å›èª¿å‡½æ•¸ - åªè¼¸å‡ºåˆ°æ§åˆ¶å°
            def silent_progress_callback(message, current, total):
                if total > 0:
                    percentage = int((current / total) * 100)
                    print(f"ğŸ“Š {message} - {percentage}% ({current}/{total})")
                else:
                    print(f"ğŸ“Š {message}")
            
            # å»¶é²å•Ÿå‹•æ›´æ–°ï¼Œç¢ºä¿GUIå®Œå…¨åˆå§‹åŒ–
            def delayed_update():
                # ç­‰å¾…GUIå®Œå…¨åˆå§‹åŒ–
                self.root.after(1000, lambda: self.start_silent_database_update(silent_progress_callback))
            
            # å»¶é²å•Ÿå‹•
            delayed_update()
            
            # å•Ÿå‹•è‡ªå‹•æ›´æ–°
            self.receipt_db_manager.start_auto_update()
            
        except Exception as e:
            print(f"âŒ å•Ÿå‹•æ™‚æ•¸æ“šåº«æ›´æ–°å¤±æ•—: {e}")
    
    def start_silent_database_update(self, progress_callback):
        """å•Ÿå‹•éœé»˜æ•¸æ“šåº«æ›´æ–°ç·šç¨‹"""
        def update_database():
            try:
                success = self.receipt_db_manager.full_update(progress_callback)
                
                print(f"âœ… æ•¸æ“šåº«æ›´æ–°å®Œæˆï¼Œçµæœ: {success}")
                
                if success:
                    print("âœ… æ•¸æ“šåº«æ›´æ–°æˆåŠŸï¼")
                else:
                    print("âŒ æ•¸æ“šåº«æ›´æ–°å¤±æ•—ï¼")
                        
            except Exception as e:
                print(f"âŒ æ•¸æ“šåº«æ›´æ–°éŒ¯èª¤: {e}")
                print("âŒ æ•¸æ“šåº«æ›´æ–°å¤±æ•—ï¼")
        
        # å•Ÿå‹•æ›´æ–°ç·šç¨‹
        update_thread = threading.Thread(target=update_database, daemon=True)
        update_thread.start()
    
    
    def setup_ui(self):
        """è¨­ç½®ç”¨æˆ¶ç•Œé¢ - ç©©å®šä¸‰æ¬„å¸ƒå±€"""
        print("ğŸ—ï¸ é–‹å§‹è¨­ç½®å…¨æ–°çš„ç©©å®šUIå¸ƒå±€...")
        
        # å•Ÿå‹•æ™‚è‡ªå‹•æ›´æ–°å–®æ“šæ˜ç´°æ•¸æ“šåº«
        self.startup_database_update()
        
        # è¨­ç½®å…¨å±€ä¸»é¡Œå’Œæ¨£å¼
        self.setup_global_themes()
        
        # === æ¨™é¡Œæ¬„ ===
        header_frame = tk.Frame(self.root, bg='#2c3e50', height=60)
        header_frame.pack(fill="x", padx=0, pady=0)
        header_frame.pack_propagate(False)
        
        title_container = tk.Frame(header_frame, bg='#2c3e50')
        title_container.pack(expand=True, fill="both")
        
        title_label = tk.Label(title_container, 
                              text="ğŸ“Š POSæ•¸æ“šåˆ†æå·¥å…· - å¢å¼·ç‰ˆ", 
                              font=('Microsoft YaHei UI', 18, 'bold'),
                              fg='white', bg='#2c3e50')
        title_label.pack(side="left", padx=20, pady=15)
        
        subtitle_label = tk.Label(title_container, 
                                text="POS Data Analysis Tool - Enhanced", 
                                font=('Arial', 11),
                                fg='#bdc3c7', bg='#2c3e50')
        subtitle_label.pack(side="right", padx=20, pady=15)
        
        # === ä¸»è¦ä½ˆå±€å®¹å™¨ ===
        self.layout_container = tk.Frame(self.root, bg='#FFFFFF')
        self.layout_container.pack(fill="both", expand=True, padx=0, pady=0)
        
        # === å·¦å´é¢æ¿ (å›ºå®šå¯¬åº¦) ===
        self.left_panel = tk.Frame(self.layout_container, bg='#ffffff', relief='solid', bd=1)
        self.left_panel.pack(side="left", fill="y", expand=False, padx=(15, 8), pady=15)
        self.left_panel.configure(width=190)
        self.left_panel.pack_propagate(False)
        
        # å¼·åˆ¶é–å®šå·¦å´é¢æ¿ - æ°¸ä¸æ”¹è®Š
        self.left_panel.bind('<Configure>', lambda e: self.left_panel.configure(width=190, height=e.height))
        
        # å·¦å´æ¨™é¡Œ
        left_header = tk.Frame(self.left_panel, bg='#3498db', height=40)
        left_header.pack(fill="x")
        left_header.pack_propagate(False)
        
        left_title = tk.Label(left_header, 
                             text="ğŸ“Š åˆ†æåŠŸèƒ½", 
                             font=('Microsoft YaHei UI', 12, 'bold'),
                             fg='white', bg='#3498db')
        left_title.pack(pady=10)
        
        left_subtitle = tk.Label(left_header, 
                               text="Analysis Functions", 
                               font=('Arial', 9),
                               fg='#ecf0f1', bg='#3498db')
        left_subtitle.pack()
        
        # === ä¸­é–“å…§å®¹å€åŸŸ (å½ˆæ€§å¯¬åº¦) ===
        self.main_frame = tk.Frame(self.layout_container, bg='#ffffff', relief='solid', bd=1)
        self.main_frame.pack(side="left", fill="both", expand=True, padx=(8, 8), pady=15)
        
        # é…ç½®gridæƒé‡
        self.main_frame.grid_rowconfigure(1, weight=1)
        self.main_frame.grid_columnconfigure(0, weight=1)
        
        # === å³å´é¢æ¿ (å›ºå®šå¯¬åº¦) ===
        self.right_panel = tk.Frame(self.layout_container, bg='#ffffff', relief='solid', bd=1)
        self.right_panel.pack(side="right", fill="y", expand=False, padx=(8, 15), pady=15)
        self.right_panel.configure(width=270)
        self.right_panel.pack_propagate(False)
        
        # å¼·åˆ¶é–å®šå³å´é¢æ¿ - æ°¸ä¸æ”¹è®Šï¼Œé˜²æ­¢æ¶ˆå¤±
        self.right_panel.bind('<Configure>', lambda e: self.right_panel.configure(width=270, height=e.height))
        
        # ç¢ºä¿å³å´é¢æ¿å§‹çµ‚åœ¨å³å´
        self.right_panel.pack_configure(side="right")
        
        # å³å´æ¨™é¡Œ
        right_header = tk.Frame(self.right_panel, bg='#e74c3c', height=45)
        right_header.pack(fill="x")
        right_header.pack_propagate(False)
        
        right_title = tk.Label(right_header, 
                              text="ğŸ“Š æ´»åŠ¨æé†’", 
                              font=('Microsoft YaHei UI', 13, 'bold'),
                              fg='white', bg='#e74c3c')
        right_title.pack(pady=12)
        
        right_subtitle = tk.Label(right_header, 
                                text="Activity Alerts Panel", 
                                font=('Arial', 9),
                                fg='#ecf0f1', bg='#e74c3c')
        right_subtitle.pack()
        
        # å³å´å…§å®¹å€åŸŸ
        right_content_frame = tk.Frame(self.right_panel, bg='#ffffff')
        right_content_frame.pack(fill="both", expand=True, padx=5, pady=5)
        
        # æ´»å‹•æé†’æ–‡æœ¬æ¡†
        self.activity_alert_text = tk.Text(right_content_frame, 
                                          height=15, width=28,
                                          font=('Segoe UI', 10), wrap=tk.WORD, bg='#FFFFFF',
                                          fg='#2c3e50', state='disabled', relief='flat', borderwidth=2)
        self.activity_alert_scrollbar = ttk.Scrollbar(right_content_frame, 
                                                   orient="vertical", 
                                               command=self.activity_alert_text.yview)
        self.activity_alert_text.configure(yscrollcommand=self.activity_alert_scrollbar.set)
        
        # ä½¿ç”¨gridå¸ƒå±€ç¢ºä¿ç©©å®šæ€§
        self.activity_alert_text.grid(row=0, column=0, sticky="nsew", padx=(0, 5))
        self.activity_alert_scrollbar.grid(row=0, column=1, sticky="ns")
        
        # é…ç½®gridæ¬Šé‡
        right_content_frame.grid_rowconfigure(0, weight=1)
        right_content_frame.grid_columnconfigure(0, weight=1)
        
        print("âœ… ä¸‰æ¬„å¸ƒå±€æ¶æ§‹å‰µå»ºå®Œæˆ:")
        print(f"   - å·¦å´é¢æ¿: 190px")
        print(f"   - ä¸­é–“å…§å®¹: å½ˆæ€§å¯¬åº¦") 
        print(f"   - å³å´é¢æ¿: 270px")
        
        # åˆå§‹åŒ–æ´»å‹•æé†’å…§å®¹
        self.activity_alert_text.config(state='normal')
        welcome_text = """ğŸ“Š æ´»åŠ¨æé†’

âœ… ä¸‰æ¬„å¸ƒå±€å·²ç©©å®šï¼

ç³»çµ±ç‹€æ…‹: æ­£å¸¸é‹è¡Œ
å¸ƒå±€æ¨¡å¼: ç©©å®šä¸‰æ¬„
é¢æ¿ç‹€æ…‹: å·²æ¿€æ´»

ğŸ¯ åŠŸèƒ½å€åŸŸ:
â€¢ å·¦å´: åˆ†æåŠŸèƒ½å°èˆª
â€¢ ä¸­é–“: æ•¸æ“šå±•ç¤ºå€åŸŸ  
â€¢ å³å´: æ´»å‹•æé†’é¢æ¿

ğŸ’¡ ä½¿ç”¨æç¤º:
â€¢ é»æ“Šå·¦å´æŒ‰éˆ•é–‹å§‹åˆ†æ
â€¢ é¸æ“‡æ—¥æœŸç¯„åœé€²è¡Œç¯©é¸
â€¢ æŸ¥çœ‹å³å´æ´»å‹•æé†’ä¿¡æ¯

ğŸ›¡ï¸ ç©©å®šæ€§ä¿è­‰:
â€¢ é¢æ¿å°ºå¯¸å·²é–å®š
â€¢ å¸ƒå±€çµæ§‹ç©©å®š
â€¢ ä¸å—æ“ä½œå½±éŸ¿"""
        
        self.activity_alert_text.insert(1.0, welcome_text)
        self.activity_alert_text.config(state='disabled')
        
        # å¼·åˆ¶UIæ›´æ–°ä»¥ç¢ºä¿é¡¯ç¤º
        self.layout_container.update_idletasks()
        self.root.update_idletasks()
        
        # ç¡®ä¿æ´»åŠ¨è®°å½•å·²æ­£ç¡®åˆå§‹åŒ–
        if not hasattr(self, 'activity_records'):
            self.activity_records = {
                'GOGO': [],
                'Express': [],
                'PLUS': []
            }
        
        # å°è¯•æ›´æ–°æ´»åŠ¨æé†’å†…å®¹ï¼ˆé¿å…ç©ºæ•°æ®é”™è¯¯ï¼‰
        try:
            self.update_activity_alerts()
        except Exception as e:
            print(f"âš ï¸ æ´»åŠ¨æé†’æ›´æ–°å¤±è´¥: {e}")
            # è®¾ç½®åŸºç¡€å†…å®¹é¿å…é”™è¯¯æ˜¾ç¤º
            self.activity_alert_text.config(state='normal')
            self.activity_alert_text.delete(1.0, tk.END)
            basic_text = "ğŸ“Š æ´»åŠ¨æé†’\n\nç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼Œæ´»åŠ¨æé†’åŠŸèƒ½å‡†å¤‡å°±ç»ªã€‚"
            self.activity_alert_text.insert(1.0, basic_text)
            self.activity_alert_text.config(state='disabled')
        
        # è°ƒè¯•è¾“å‡º
        print(f"âœ… UIæ›´æ”¹å·²åº”ç”¨:")
        print(f"   - å·¦ä¾§é¢æ¿å®½åº¦: {self.left_panel['width']}")
        print(f"   - å³ä¾§é¢æ¿å®½åº¦: {self.right_panel['width']}")
        print(f"   - æ´»åŠ¨æé†’æ–‡æœ¬é•¿åº¦: {len(welcome_text)}")
        print(f"   - æ´»åŠ¨æé†’é¢æ¿å·²åˆå§‹åŒ–")
        
        # å¼ºåˆ¶åˆ·æ–°ç•Œé¢
        self.root.update()
        self.root.update_idletasks()
        
        # å¼ºåˆ¶é”å®šé¢æ¿å¤§å°ï¼Œé˜²æ­¢è‡ªåŠ¨è°ƒæ•´
        self.root.after(100, self.lock_panel_sizes)
        
        # ğŸ›¡ï¸ é¡å¤–ä¿è­·ï¼šç¢ºä¿å³å´é¢æ¿æ°¸ä¸è¢«ç ´å£
        self.root.after(200, self.final_right_panel_protection)
        
        # åˆå§‹åŒ–æ´»åŠ¨æé†’æ˜¾ç¤º
        self.update_activity_alerts()
        
        # ç­›é€‰æ¡ä»¶æ¡†æ¶ï¼ˆåŒ…å«æ•°æ®åº“é€‰æ‹©å’Œç­›é€‰æ¡ä»¶ï¼‰
        # ç¾åŒ–é ‚éƒ¨ç¯©é¸æ¡†æ¶
        # ä½¿ç”¨ç´”ç™½è‰² tkFrame æ›¿ä»£ tk.LabelFrameï¼Œå®Œå…¨å»é™¤ç°è‰²é‚Šæ¡†
        self.filter_frame = tk.Frame(self.main_frame, bg='#FFFFFF', relief='solid', bd=2)
        self.filter_frame.grid(row=0, column=0, sticky="ew", padx=8, pady=(0, 8))
        
        # æ¨™é¡Œæ¨™ç±¤ - æ¸›å°‘ä¸Šé‚Šè·
        filter_title = tk.Label(self.filter_frame, 
                               text="ğŸ” ç­›é€‰æ¡ä»¶ / Filter Conditions", 
                               font=('Microsoft JhengHei', 10, 'bold'),
                               fg='#2c3e50', bg='#FFFFFF')
        filter_title.pack(pady=(5, 8))
        
        # è¨­ç½®æ¸…æ–°ä¸»é¡Œç¯©é¸æ¡†æ¶èƒŒæ™¯
        filter_canv = tk.Canvas(self.filter_frame, highlightthickness=0, bg='#FFFFFF', height=5)
        filter_canv.place(x=0, y=0, relwidth=1, relheight=1)
        
        # æ•°æ®åº“é€‰æ‹©è¡Œ - æ–°çš„å¤§æŒ‰éµè¨­è¨ˆ
        db_row = tk.Frame(self.filter_frame, bg='#FFFFFF')
        db_row.pack(fill="x", pady=(8, 12))
        
        # æ•°æ®åº«æ¨™ç±¤ - é›™èªé¡¯ç¤º
        db_label = tk.Label(db_row, 
                           text="ğŸ—„ï¸ æ•°æ®åº“é€‰æ‹©\nDatabase Selection", 
                           font=('Microsoft YaHei UI', 9, 'bold'), bg='#FFFFFF')
        db_label.pack(side="left", padx=(0, 15), pady=6)
        
        # åˆ›å»ºå¤§çš„æ•°æ®åº«é¸æ“‡æŒ‰éµ - 4å€‹é¸é …
        self.selected_db = tk.StringVar(value="GOGO")
        
        # å‰µå»ºæ•¸æ“šåº«é¸é …æŒ‰éµ - ä½¿ç”¨é¡å¯¦ä¾‹è®Šé‡
        self.db_options = {}
        
        for i, (key, info) in enumerate(self.DATABASE_OPTIONS.items()):
            btn = tk.Button(db_row,
                          text=f"{info['icon']} {info['cn']}\n{info['en']}",
                          font=('Microsoft YaHei UI', 9, 'bold'),
                          bg=info['color'], fg='white',
                          relief='solid', bd=2,
                          width=14, height=3,
                          command=lambda k=key: self.select_database_option(k))
            btn.pack(side="left", padx=6, fill="y")
            self.db_options[key] = btn
        
        # æ›´æ–°åˆå§‹æŒ‰éµç‹€æ…‹
        self.update_database_button_style()
        
        # æ´»åŠ¨è®°å½•è¶…å¤§æŒ‰éµ - ç§»é™¤è¿æ¥æ•°æ®åº“
        activity_btn = tk.Button(db_row, 
                               text="ğŸ“ æ´»åŠ¨è®°å½•\nActivity Log", 
                               font=('Microsoft YaHei UI', 9, 'bold'),
                               bg='#e74c3c', fg='white', 
                               relief='solid', bd=2,
                               width=16, height=3,
                               command=self.open_activity_window)
        activity_btn.pack(side="right", padx=(15, 0), fill="y")
        
        # ç¬¬ä¸€è¡Œï¼šæ—¥æœŸèŒƒå›´
        filter_row1 = tk.Frame(self.filter_frame)
        filter_row1.pack(fill="x", pady=2)
        
        # æ—¥æœŸç­›é€‰å¼€å…³
        self.use_date_filter = tk.BooleanVar(value=True)
        date_filter_cb = tk.Checkbutton(filter_row1, text="ğŸ“… ä½¿ç”¨æ—¥æœŸç­›é€‰ / Use Date Filter", 
                                        variable=self.use_date_filter,
                                        command=self.toggle_date_filter)
        date_filter_cb.pack(side="left", padx=5)
        
        tk.Label(filter_row1, text="ğŸ“… æ—¥æœŸä» / Date From:", font=('Arial', 9, 'bold')).pack(side="left", padx=5)
        self.date_from = DateEntry(filter_row1, width=12, background='darkblue',
                                  foreground='white', borderwidth=2, date_pattern='dd/mm/yyyy')
        self.date_from.pack(side="left", padx=2)
        
        tk.Label(filter_row1, text="åˆ° / To:", font=('Arial', 9, 'bold')).pack(side="left", padx=5)
        self.date_to = DateEntry(filter_row1, width=12, background='darkblue',
                                foreground='white', borderwidth=2, date_pattern='dd/mm/yyyy')
        self.date_to.pack(side="left", padx=2)
        
        # ç»‘å®šæ—¥æœŸå˜åŒ–äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°æ´»åŠ¨æé†’
        self.date_from.bind('<<DateEntrySelected>>', lambda e: self.update_activity_alerts())
        self.date_to.bind('<<DateEntrySelected>>', lambda e: self.update_activity_alerts())
        
        # æ·»åŠ æ—¥æœŸæ ¼å¼è¯´æ˜å’Œå¿«é€Ÿè®¾ç½®æŒ‰é’®
        date_help_frame = tk.Frame(filter_row1)
        date_help_frame.pack(side="left", padx=10)
        
        date_help_label = tk.Label(date_help_frame, text="(ç‚¹å‡»æ—¥å†å›¾æ ‡é€‰æ‹©æ—¥æœŸ)\n(Click calendar icon to select date)", 
                                   foreground="gray")
        date_help_label.pack()
        
        # ç¬¬äºŒè¡Œï¼šç­›é€‰æ¡ä»¶
        filter_row2 = tk.Frame(self.filter_frame)
        filter_row2.pack(fill="x", pady=2)
        
        # é—¨å¸‚ç­›é€‰
        tk.Label(filter_row2, text="ğŸª é—¨å¸‚ / Outlet:", font=('Arial', 9, 'bold')).pack(side="left", padx=5)
        self.outlet_all_btn = ttk.Button(filter_row2, text="å…¨éƒ¨ / All", command=self.toggle_all_outlets, width=8)
        self.outlet_all_btn.pack(side="left", padx=2)
        self.outlet_combo = MultiSelectCombobox(filter_row2, width=25, title="é€‰æ‹©é—¨å¸‚ / Select Outlet", on_change_callback=self.on_outlet_changed, delay_ms=1000)
        self.outlet_combo.pack(side="left", padx=2)
        
        # æœˆä»½ç­›é€‰
        tk.Label(filter_row2, text="ğŸ“† æœˆä»½ / Month:", font=('Arial', 9, 'bold')).pack(side="left", padx=5)
        self.month_all_btn = ttk.Button(filter_row2, text="å…¨éƒ¨ / All", command=self.toggle_all_months, width=8)
        self.month_all_btn.pack(side="left", padx=2)
        self.month_combo = MultiSelectCombobox(filter_row2, width=20, title="é€‰æ‹©æœˆä»½ / Select Month", on_change_callback=self.on_month_changed, delay_ms=1000)
        self.month_combo.pack(side="left", padx=2)
        
        # æ˜ŸæœŸç­›é€‰
        tk.Label(filter_row2, text="ğŸ“… æ˜ŸæœŸ / Weekday:", font=('Arial', 9, 'bold')).pack(side="left", padx=5)
        self.weekday_all_btn = ttk.Button(filter_row2, text="å…¨éƒ¨ / All", command=self.toggle_all_weekdays, width=8)
        self.weekday_all_btn.pack(side="left", padx=2)
        self.weekday_combo = MultiSelectCombobox(filter_row2, width=20, title="é€‰æ‹©æ˜ŸæœŸ / Select Weekday", on_change_callback=self.on_weekday_changed, delay_ms=1000)
        self.weekday_combo.pack(side="left", padx=2)
        
        # æ”¯ä»˜æ–¹å¼ç­›é€‰
        tk.Label(filter_row2, text="æ”¯ä»˜æ–¹å¼:\nPayment Method:").pack(side="left", padx=5)
        self.payment_all_btn = ttk.Button(filter_row2, text="å…¨éƒ¨\nAll", command=self.toggle_all_payments, width=6)
        self.payment_all_btn.pack(side="left", padx=2)
        self.payment_combo = MultiSelectCombobox(filter_row2, width=25, title="é€‰æ‹©æ”¯ä»˜æ–¹å¼\nSelect Payment Method", on_change_callback=self.on_payment_changed, delay_ms=3000)
        self.payment_combo.pack(side="left", padx=2)
        
        # ç¬¬ä¸‰è¡Œï¼šç±»åˆ«ã€äº§å“å’Œæœç´¢
        filter_row3 = tk.Frame(self.filter_frame)
        filter_row3.pack(fill="x", pady=2)
        
        # ç±»åˆ«ç­›é€‰
        tk.Label(filter_row3, text="ç±»åˆ«:\nCategory:").pack(side="left", padx=5)
        self.category_all_btn = ttk.Button(filter_row3, text="å…¨éƒ¨\nAll", command=self.toggle_all_categories, width=6)
        self.category_all_btn.pack(side="left", padx=2)
        self.category_combo = MultiSelectCombobox(filter_row3, width=25, title="é€‰æ‹©ç±»åˆ«\nSelect Category", on_change_callback=self.on_category_changed, delay_ms=1000)
        self.category_combo.pack(side="left", padx=2)
        
        # äº§å“ç­›é€‰
        tk.Label(filter_row3, text="äº§å“:\nProduct:").pack(side="left", padx=5)
        self.product_all_btn = ttk.Button(filter_row3, text="å…¨éƒ¨\nAll", command=self.toggle_all_products, width=6)
        self.product_all_btn.pack(side="left", padx=2)
        self.product_combo = MultiSelectCombobox(filter_row3, width=30, title="é€‰æ‹©äº§å“\nSelect Product", on_change_callback=self.on_product_changed, delay_ms=1000)
        self.product_combo.pack(side="left", padx=2)
        
        # äº§å“æ˜¾ç¤ºå¼€å…³
        self.show_product_details = tk.BooleanVar(value=True)
        product_toggle_cb = tk.Checkbutton(filter_row3, text="æ˜¾ç¤ºè¯¦ç»†\nShow Details", 
                                          variable=self.show_product_details,
                                          command=self.toggle_product_display)
        product_toggle_cb.pack(side="left", padx=10)
        
        # æ—¥å‡æ˜¾ç¤ºå¼€å…³
        self.show_daily_average = tk.BooleanVar(value=False)
        daily_avg_cb = tk.Checkbutton(filter_row3, text="æ˜¾ç¤ºæ—¥å‡\nShow Daily Average", 
                                     variable=self.show_daily_average,
                                     command=self.toggle_daily_average)
        daily_avg_cb.pack(side="left", padx=10)
        
        # å•åº—å¹³å‡å¼€å…³
        self.show_store_average = tk.BooleanVar(value=False)
        store_avg_cb = tk.Checkbutton(filter_row3, text="å•åº—å¹³å‡\nPer Store Average", 
                                     variable=self.show_store_average,
                                     command=self.toggle_store_average)
        store_avg_cb.pack(side="left", padx=10)
        
        # é”€å”®æ•°æ®æ”¯ä»˜æ–¹å¼å¼€å…³
        self.include_payment_sales = tk.BooleanVar(value=False)
        payment_sales_cb = tk.Checkbutton(filter_row3, text="åŒ…å«æ”¯ä»˜æ–¹å¼\nInclude Payment", 
                                         variable=self.include_payment_sales,
                                         command=self.on_sales_payment_toggle)
        payment_sales_cb.pack(side="left", padx=10)
        
        # æœç´¢åŠŸèƒ½å·²é›†æˆåˆ°å„ä¸ªç­›é€‰æ¡†ä¸­
        
        # è®¾ç½®å·¦ä¾§åˆ†æåŠŸèƒ½æŒ‰é’®é¢æ¿
        self.setup_left_panel()
        
        # è¨­ç½®å³å´æ´»å‹•é¢æ¿ - é‡æ–°è¨­è¨ˆç©©å®šæ¶æ§‹
        self.setup_right_panel()
        
        # åˆ›å»ºnotebookå®¹å™¨ï¼Œç”¨äºæ›´å¥½çš„å¸ƒå±€ç®¡ç†
        # ä½¿ç”¨gridå¸ƒå±€ï¼Œç¡®ä¿å®Œå…¨å¡«å……å‰©ä½™ç©ºé—´
        self.notebook_container = tk.Frame(self.main_frame)
        self.notebook_container.grid(row=1, column=0, sticky="nsew", padx=5, pady=(0, 0))
        
        # åˆ›å»ºä¸»Notebookç”¨äºSaleså’ŒProductåˆ†ç±»
        self.notebook = ttk.Notebook(self.notebook_container)
        self.notebook.pack(fill="both", expand=True, padx=0, pady=0)
        
        # é…ç½®ç¾ä»£åŒ–æ¨™ç±¤é æ¨£å¼
        style = ttk.Style()
        
        # ç¾ä»£æ¸…æ–°æ¨™ç±¤é æ¨£å¼
        style.configure("Sales.TNotebook.Tab", 
                       background="#E3F2FD", 
                       foreground="#1976D2",
                       padding=(22, 14),
                       font=('Segoe UI', 11, 'bold'))
        
        style.configure("Product.TNotebook.Tab", 
                       background="#E8F5E8", 
                       foreground="#2E7D32",
                       padding=(22, 14),
                       font=('Segoe UI', 11, 'bold'))
        
        style.configure("Brand.TNotebook.Tab", 
                       background="#F3E5F5", 
                       foreground="#6A1B9A",
                       padding=(22, 14),
                       font=('Segoe UI', 11, 'bold'))
        
        style.configure("Log.TNotebook.Tab", 
                       background="#FFF3E0", 
                       foreground="#E65100",
                       padding=(22, 14),
                       font=('Segoe UI', 11, 'bold'))
        
        # æ¨™ç±¤é ç‹€æ…‹æ˜ å°„ - ç´”ç™½æ´»å‹•ç‹€æ…‹
        style.map("Sales.TNotebook.Tab",
                 background=[('selected', '#2196F3'), ('active', '#FFFFFF')],
                 foreground=[('selected', '#FFFFFF'), ('active', '#000000')])
        
        style.map("Product.TNotebook.Tab",
                 background=[('selected', '#4CAF50'), ('active', '#FFFFFF')],
                 foreground=[('selected', '#FFFFFF'), ('active', '#000000')])
        
        style.map("Brand.TNotebook.Tab",
                 background=[('selected', '#9C27B0'), ('active', '#FFFFFF')],
                 foreground=[('selected', '#FFFFFF'), ('active', '#000000')])
        
        style.map("Log.TNotebook.Tab",
                 background=[('selected', '#FF9800'), ('active', '#FFFFFF')],
                 foreground=[('selected', '#FFFFFF'), ('active', '#000000')])
        
        # Salesæ ‡ç­¾é¡µ
        self.sales_notebook = ttk.Notebook(self.notebook)
        self.notebook.add(self.sales_notebook, text="Sales\né”€å”®åˆ†æ")
        
        # Productæ ‡ç­¾é¡µ
        self.product_notebook = ttk.Notebook(self.notebook)
        self.notebook.add(self.product_notebook, text="Product\näº§å“åˆ†æ")
        
        # Brandæ ‡ç­¾é¡µ
        self.brand_notebook = ttk.Notebook(self.notebook)
        self.notebook.add(self.brand_notebook, text="Brand\nå“ç‰Œåˆ†æ")
        
        # æ¯æ—¥ç»†é¡¹å­æ ‡ç­¾é¡µ
        self.brand_daily_frame = tk.Frame(self.brand_notebook)
        self.brand_notebook.add(self.brand_daily_frame, text="æ¯æ—¥ç»†é¡¹\nDaily Breakdown")
        
        # æœŸé—´æ±‡æ€»å­æ ‡ç­¾é¡µ
        self.brand_period_frame = tk.Frame(self.brand_notebook)
        self.brand_notebook.add(self.brand_period_frame, text="æœŸé—´æ±‡æ€»\nPeriod Summary")
        
        # ä¸šç»©å¯¹æ¯”æ ‡ç­¾é¡µ
        self.performance_comparison_frame = tk.Frame(self.brand_notebook)
        self.brand_notebook.add(self.performance_comparison_frame, text="ä¸šç»©å¯¹æ¯”\nPerformance Comparison")
        
        # ç±»åˆ«åˆ†ææ ‡ç­¾é¡µ
        self.category_analysis_frame = tk.Frame(self.brand_notebook)
        self.brand_notebook.add(self.category_analysis_frame, text="ç±»åˆ«åˆ†æ\nCategory Analysis")
        
        # ä¸šç»©å¯¹æ¯”æ§åˆ¶é¢æ¿
        comparison_control_frame = tk.Frame(self.performance_comparison_frame)
        comparison_control_frame.pack(fill="x", padx=5, pady=5)
        
        # å¯¹æ¯”æ–¹å¼é€‰æ‹©
        tk.Label(comparison_control_frame, text="å¯¹æ¯”æ–¹å¼\nComparison Method:").pack(side="left", padx=5)
        self.comparison_method = tk.StringVar(value="date")
        ttk.Radiobutton(comparison_control_frame, text="å¯¹æ¯”æ—¥æœŸ\nCompare Date", variable=self.comparison_method, value="date").pack(side="left", padx=5)
        ttk.Radiobutton(comparison_control_frame, text="å¯¹æ¯”å‘¨æœŸ\nCompare Week", variable=self.comparison_method, value="week").pack(side="left", padx=5)
        
        # å¯¹æ¯”æ—¥æœŸèŒƒå›´é€‰æ‹©
        tk.Label(comparison_control_frame, text="å¯¹æ¯”æ—¥æœŸèŒƒå›´\nCompare Date Range:").pack(side="left", padx=(20, 5))
        self.comparison_date_from = DateEntry(comparison_control_frame, width=12, background='darkblue',
                                            foreground='white', borderwidth=2, date_pattern='dd/MM/yyyy')
        self.comparison_date_from.pack(side="left", padx=5)
        
        tk.Label(comparison_control_frame, text="åˆ°\nTo:").pack(side="left", padx=5)
        self.comparison_date_to = DateEntry(comparison_control_frame, width=12, background='darkblue',
                                          foreground='white', borderwidth=2, date_pattern='dd/MM/yyyy')
        self.comparison_date_to.pack(side="left", padx=5)
        
        # å¯¹æ¯”å‘¨æœŸé€‰æ‹© - æ”¹ä¸ºå¤šé€‰
        tk.Label(comparison_control_frame, text="å¯¹æ¯”å‘¨æœŸ\nCompare Week:").pack(side="left", padx=(20, 5))
        
        # åˆ›å»ºå¯¹æ¯”å‘¨æœŸå¤šé€‰æ¡†
        self.comparison_week_combo = MultiSelectCombobox(comparison_control_frame, width=20, 
                                                        title="é€‰æ‹©å¯¹æ¯”å‘¨æœŸ\nSelect Comparison Weeks")
        self.comparison_week_combo.pack(side="left", padx=5)
        
        # è®¾ç½®å¯¹æ¯”å‘¨æœŸé€‰é¡¹
        comparison_week_options = ["å½“å‰å‘¨æœŸ", "ä¸Šä¸€å‘¨æœŸ", "ä¸Šä¸Šå‘¨æœŸ", "ä¸Šä¸ªæœˆåŒæœŸ", "ä¸Šä¸ªæœˆä¸Šä¸€å‘¨æœŸ", "ä¸Šä¸ªæœˆä¸Šä¸Šå‘¨æœŸ"]
        self.comparison_week_combo.set_values(comparison_week_options)
        # è®¾ç½®é»˜è®¤é€‰æ‹©
        self.comparison_week_combo.selected_values = ["ä¸Šä¸€å‘¨æœŸ"]
        self.comparison_week_combo.update_display()
        
        # æ˜¾ç¤ºè¯¦ç»†å¼€å…³
        self.show_performance_details = tk.BooleanVar(value=True)
        tk.Checkbutton(comparison_control_frame, text="æ˜¾ç¤ºè¯¦ç»†\nShow Details", 
                       variable=self.show_performance_details,
                       command=self.toggle_performance_details).pack(side="left", padx=(20, 5))
        
        # æ‰§è¡ŒæŒ‰é’®
        ttk.Button(comparison_control_frame, text="æ‰§è¡Œå¯¹æ¯”\nExecute Comparison", 
                  command=self.get_performance_comparison, style="Action.TButton").pack(side="left", padx=(20, 5))
        
        # ä¸šç»©å¯¹æ¯”è¡¨æ ¼
        comparison_tree_frame = tk.Frame(self.performance_comparison_frame)
        comparison_tree_frame.pack(fill="both", expand=True, pady=5)
        
        # åˆ›å»ºä¸šç»©å¯¹æ¯”è¡¨æ ¼
        comparison_columns = ("äº§å“åç§°", "æœŸé—´", "æ€»ä¸šç»©", "æ€»å•æ®", "å¹³å‡å•æ®", "äº§å“ä¸šç»©", "äº§å“å•æ®", "æŠ¥åºŸæ•°é‡", "ä¸šç»©å æ¯”%", "å•æ®å æ¯”%")
        self.performance_comparison_tree = ttk.Treeview(comparison_tree_frame, columns=comparison_columns, show="headings", height=20)
        
        # è®¾ç½®åˆ—æ ‡é¢˜
        for col in comparison_columns:
            self.performance_comparison_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.performance_comparison_tree, c))
            self.performance_comparison_tree.column(col, width=120, anchor="center")
        
        # æ·»åŠ æ»šåŠ¨æ¡
        comparison_scrollbar = ttk.Scrollbar(comparison_tree_frame, orient="vertical", command=self.performance_comparison_tree.yview)
        self.performance_comparison_tree.configure(yscrollcommand=comparison_scrollbar.set)
        
        # å¸ƒå±€
        self.performance_comparison_tree.pack(side="left", fill="both", expand=True)
        comparison_scrollbar.pack(side="right", fill="y")
        
        
        # æ¯æ—¥ç»†é¡¹è¡¨æ ¼
        daily_tree_frame = tk.Frame(self.brand_daily_frame)
        daily_tree_frame.pack(fill="both", expand=True, pady=5)
        
        self.brand_daily_tree = ttk.Treeview(daily_tree_frame, show="headings")
        daily_scrollbar_y = ttk.Scrollbar(daily_tree_frame, orient="vertical", command=self.brand_daily_tree.yview)
        daily_scrollbar_x = ttk.Scrollbar(daily_tree_frame, orient="horizontal", command=self.brand_daily_tree.xview)
        self.brand_daily_tree.configure(yscrollcommand=daily_scrollbar_y.set, xscrollcommand=daily_scrollbar_x.set)
        
        self.brand_daily_tree.pack(side="left", fill="both", expand=True)
        daily_scrollbar_y.pack(side="right", fill="y")
        daily_scrollbar_x.pack(side="bottom", fill="x")
        
        # æœŸé—´æ±‡æ€»è¡¨æ ¼å’Œæ§åˆ¶é¢æ¿
        period_control_frame = tk.Frame(self.brand_period_frame)
        period_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æ˜¾ç¤ºæ—¥å‡å¼€å…³ - å“ç‰ŒæœŸé—´æ±‡æ€»ä¸“ç”¨
        self.show_brand_daily_average = tk.BooleanVar(value=False)
        daily_avg_cb = tk.Checkbutton(period_control_frame, text="æ˜¾ç¤ºæ—¥å‡\nShow Daily Average", 
                                      variable=self.show_brand_daily_average,
                                      command=self.toggle_brand_daily_average)
        daily_avg_cb.pack(side="left", padx=10)
        
        period_tree_frame = tk.Frame(self.brand_period_frame)
        period_tree_frame.pack(fill="both", expand=True, pady=5)
        
        self.brand_period_tree = ttk.Treeview(period_tree_frame, show="headings")
        period_scrollbar_y = ttk.Scrollbar(period_tree_frame, orient="vertical", command=self.brand_period_tree.yview)
        period_scrollbar_x = ttk.Scrollbar(period_tree_frame, orient="horizontal", command=self.brand_period_tree.xview)
        self.brand_period_tree.configure(yscrollcommand=period_scrollbar_y.set, xscrollcommand=period_scrollbar_x.set)
        
        self.brand_period_tree.pack(side="left", fill="both", expand=True)
        period_scrollbar_y.pack(side="right", fill="y")
        period_scrollbar_x.pack(side="bottom", fill="x")
        
        # æ—¥å¿—ä¿¡æ¯æ ‡ç­¾é¡µ
        self.log_frame = tk.Frame(self.notebook)
        self.notebook.add(self.log_frame, text="æ—¥å¿—ä¿¡æ¯\nLog Information")
        
        # æ—¥å¿—ä¿¡æ¯æ§åˆ¶é¢æ¿
        log_control_frame = tk.Frame(self.log_frame)
        log_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        log_search_frame = tk.Frame(log_control_frame)
        log_search_frame.pack(side="left", padx=5)
        
        tk.Label(log_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.log_search_entry = ttk.Entry(log_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.log_search_entry.pack(side="left", padx=2)
        self.log_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_log())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.log_search_status = tk.Label(log_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.log_search_status.pack(side="left", padx=10)
        
        # æ¸…ç©ºæ—¥å¿—æŒ‰é’®
        clear_log_btn = ttk.Button(log_control_frame, text="æ¸…ç©ºæ—¥å¿—", command=self.clear_output)
        clear_log_btn.pack(side="right", padx=5)
        
        # åº”ç”¨é¢œè‰²æ ·å¼
        self.sales_notebook.configure(style="Sales.TNotebook")
        self.product_notebook.configure(style="Product.TNotebook")
        self.brand_notebook.configure(style="Brand.TNotebook")
        
        # æ—¥å¿—ä¿¡æ¯æ ‡ç­¾é¡µå†…å®¹
        self.info_text = tk.Text(self.log_frame, height=15, width=100)
        self.info_text.pack(fill="both", expand=True, pady=5)
        
        # æ—¥å¿—æ»šåŠ¨æ¡
        log_scrollbar = ttk.Scrollbar(self.log_frame, orient="vertical", command=self.info_text.yview)
        log_scrollbar.pack(side="right", fill="y")
        self.info_text.configure(yscrollcommand=log_scrollbar.set)
        
        # Saleså­æ ‡ç­¾é¡µ
        # é”€å”®æ•°æ®æ ‡ç­¾é¡µ
        self.sales_frame = tk.Frame(self.sales_notebook)
        self.sales_notebook.add(self.sales_frame, text="é”€å”®æ•°æ®\nSales Raw Data")
        
        # é”€å”®æ•°æ®æ§åˆ¶é¢æ¿
        sales_control_frame = tk.Frame(self.sales_frame)
        sales_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        sales_search_frame = tk.Frame(sales_control_frame)
        sales_search_frame.pack(side="left", padx=5)
        
        tk.Label(sales_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.sales_search_entry = ttk.Entry(sales_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.sales_search_entry.pack(side="left", padx=2)
        self.sales_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_sales())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.sales_search_status = tk.Label(sales_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.sales_search_status.pack(side="left", padx=10)
        
        # åˆ·æ–°æŒ‰é’®
        refresh_sales_btn = ttk.Button(sales_control_frame, text="ğŸ”„ åˆ·æ–°æ•°æ® / Refresh Data", 
                                     command=self.refresh_sales_data)
        refresh_sales_btn.pack(side="right", padx=5)
        
        # é”€å”®æ•°æ®Treeview
        self.sales_tree = ttk.Treeview(self.sales_frame, show="headings")
        self.sales_tree.pack(side="left", fill="both", expand=True)
        
        sales_scrollbar = ttk.Scrollbar(self.sales_frame, orient="vertical", command=self.sales_tree.yview)
        sales_scrollbar.pack(side="right", fill="y")
        self.sales_tree.configure(yscrollcommand=sales_scrollbar.set)
        
        # æ”¯ä»˜åˆ†ææ ‡ç­¾é¡µ
        self.payment_frame = tk.Frame(self.sales_notebook)
        self.sales_notebook.add(self.payment_frame, text="æ”¯ä»˜æ–¹å¼åˆ†æ\nPayment Analysis")
        
        # æ”¯ä»˜åˆ†ææ§åˆ¶é¢æ¿
        payment_control_frame = tk.Frame(self.payment_frame)
        payment_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        payment_search_frame = tk.Frame(payment_control_frame)
        payment_search_frame.pack(side="left", padx=5)
        
        tk.Label(payment_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.payment_search_entry = ttk.Entry(payment_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.payment_search_entry.pack(side="left", padx=2)
        self.payment_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_payment())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.payment_search_status = tk.Label(payment_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.payment_search_status.pack(side="left", padx=10)
        
        # åŒºé—´ç­›é€‰æ§åˆ¶
        tk.Label(payment_control_frame, text="å•æ®é‡‘é¢åŒºé—´ç­›é€‰:").pack(side="left", padx=5)
        
        self.payment_min_amount = ttk.Entry(payment_control_frame, width=10)
        self.payment_min_amount.pack(side="left", padx=2)
        tk.Label(payment_control_frame, text="åˆ°").pack(side="left", padx=2)
        self.payment_max_amount = ttk.Entry(payment_control_frame, width=10)
        self.payment_max_amount.pack(side="left", padx=2)
        
        ttk.Button(payment_control_frame, text="åº”ç”¨ç­›é€‰", command=self.apply_payment_amount_filter).pack(side="left", padx=10)
        ttk.Button(payment_control_frame, text="æ¸…é™¤ç­›é€‰", command=self.clear_payment_amount_filter).pack(side="left", padx=5)
        
        # æç¤ºä¿¡æ¯
        tk.Label(payment_control_frame, text="(ç•™ç©ºè¡¨ç¤ºæ— é™åˆ¶ï¼Œä¾‹å¦‚ï¼š30 è¡¨ç¤º30ä»¥ä¸Šï¼Œ10-15 è¡¨ç¤º10åˆ°15ä¹‹é—´)", 
                 font=("Arial", 8), foreground="gray").pack(side="left", padx=10)
        
        self.payment_tree = ttk.Treeview(self.payment_frame, show="headings")
        self.payment_tree.pack(side="left", fill="both", expand=True)
        
        payment_scrollbar = ttk.Scrollbar(self.payment_frame, orient="vertical", command=self.payment_tree.yview)
        payment_scrollbar.pack(side="right", fill="y")
        self.payment_tree.configure(yscrollcommand=payment_scrollbar.set)
        
        # æŠ˜æ‰£åˆ†ææ ‡ç­¾é¡µ
        self.discount_frame = tk.Frame(self.sales_notebook)
        self.sales_notebook.add(self.discount_frame, text="æŠ˜æ‰£åˆ†æ\nDiscount Analysis")
        
        # æŠ˜æ‰£åˆ†ææ§åˆ¶é¢æ¿
        discount_control_frame = tk.Frame(self.discount_frame)
        discount_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        discount_search_frame = tk.Frame(discount_control_frame)
        discount_search_frame.pack(side="left", padx=5)
        
        tk.Label(discount_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.discount_search_entry = ttk.Entry(discount_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.discount_search_entry.pack(side="left", padx=2)
        self.discount_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_discount())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.discount_search_status = tk.Label(discount_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.discount_search_status.pack(side="left", padx=10)
        
        self.discount_tree = ttk.Treeview(self.discount_frame, show="headings")
        self.discount_tree.pack(side="left", fill="both", expand=True)
        
        discount_scrollbar = ttk.Scrollbar(self.discount_frame, orient="vertical", command=self.discount_tree.yview)
        discount_scrollbar.pack(side="right", fill="y")
        self.discount_tree.configure(yscrollcommand=discount_scrollbar.set)
        
        # æœˆåº¦æ±‡æ€»æ ‡ç­¾é¡µ
        self.monthly_frame = tk.Frame(self.sales_notebook)
        self.sales_notebook.add(self.monthly_frame, text="æœˆ - é”€å”®æ•°æ®\nMonthly - Product Data")
        
        # æœˆåº¦æ±‡æ€»æ§åˆ¶é¢æ¿
        monthly_control_frame = tk.Frame(self.monthly_frame)
        monthly_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        monthly_search_frame = tk.Frame(monthly_control_frame)
        monthly_search_frame.pack(side="left", padx=5)
        
        tk.Label(monthly_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.monthly_search_entry = ttk.Entry(monthly_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.monthly_search_entry.pack(side="left", padx=2)
        self.monthly_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_monthly())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.monthly_search_status = tk.Label(monthly_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.monthly_search_status.pack(side="left", padx=10)
        
        self.monthly_tree = ttk.Treeview(self.monthly_frame, show="headings", selectmode="extended")
        self.monthly_tree.pack(side="left", fill="both", expand=True)
        
        monthly_scrollbar = ttk.Scrollbar(self.monthly_frame, orient="vertical", command=self.monthly_tree.yview)
        monthly_scrollbar.pack(side="right", fill="y")
        self.monthly_tree.configure(yscrollcommand=monthly_scrollbar.set)
        
        # ç¶å®šé¸æ“‡äº‹ä»¶ä¾†æ›´æ–°é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
        self.monthly_tree.bind("<<TreeviewSelect>>", self.on_monthly_product_selection_change)
        
        # åˆå§‹åŒ–é¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_monthly_products = []
        
        # Productå­æ ‡ç­¾é¡µ
        # äº§å“æ•°æ®åˆ†ææ ‡ç­¾é¡µ
        self.product_overview_frame = tk.Frame(self.product_notebook)
        self.product_notebook.add(self.product_overview_frame, text="æ—¥ - äº§å“æ•°æ®\nDaily Product Data")
        
        # å‘¨æœŸäº§å“æ•°æ®æ ‡ç­¾é¡µ
        self.weekly_product_frame = tk.Frame(self.product_notebook)
        self.product_notebook.add(self.weekly_product_frame, text="å‘¨ - äº§å“æ•°æ®\nWeekly Product Data")
        
        # æœŸé—´äº§å“æ•°æ®æ ‡ç­¾é¡µ
        self.period_product_overview_frame = tk.Frame(self.product_notebook)
        self.product_notebook.add(self.period_product_overview_frame, text="æœŸé—´ - äº§å“æ•°æ®\nPeriod Product Data")
        
        # æœŸé—´äº§å“æ•°æ®æ§åˆ¶é¢æ¿
        period_control_frame = tk.Frame(self.period_product_overview_frame)
        period_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        period_search_frame = tk.Frame(period_control_frame)
        period_search_frame.pack(side="left", padx=5)
        
        tk.Label(period_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.period_product_search_entry = ttk.Entry(period_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.period_product_search_entry.pack(side="left", padx=2)
        self.period_product_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_period_product())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.period_product_search_status = tk.Label(period_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.period_product_search_status.pack(side="left", padx=10)
        
        # æœŸé—´äº§å“æ•°æ®è¡¨æ ¼
        period_tree_frame = tk.Frame(self.period_product_overview_frame)
        period_tree_frame.pack(fill="both", expand=True, pady=5)
        
        self.period_product_tree = ttk.Treeview(period_tree_frame, show="headings", selectmode="extended")
        self.period_product_tree.pack(side="left", fill="both", expand=True)
        
        period_scrollbar = ttk.Scrollbar(period_tree_frame, orient="vertical", command=self.period_product_tree.yview)
        period_scrollbar.pack(side="right", fill="y")
        self.period_product_tree.configure(yscrollcommand=period_scrollbar.set)
        
        # ç¶å®šé¸æ“‡äº‹ä»¶ä¾†æ›´æ–°é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
        self.period_product_tree.bind("<<TreeviewSelect>>", self.on_period_product_selection_change)
        
        # åˆå§‹åŒ–é¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_period_products = []
        
        # æ—¥-äº§å“åˆ†ææ ‡ç­¾é¡µ
        self.sales_tc_analysis_frame = tk.Frame(self.product_notebook)
        self.product_notebook.add(self.sales_tc_analysis_frame, text="æ—¥ - äº§å“åˆ†æ\nDaily - Product Analysis")
        
        # æ—¥-äº§å“åˆ†ææ§åˆ¶é¢æ¿
        daily_analysis_control_frame = tk.Frame(self.sales_tc_analysis_frame)
        daily_analysis_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        daily_analysis_search_frame = tk.Frame(daily_analysis_control_frame)
        daily_analysis_search_frame.pack(side="left", padx=5)
        
        tk.Label(daily_analysis_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.daily_analysis_search_entry = ttk.Entry(daily_analysis_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.daily_analysis_search_entry.pack(side="left", padx=2)
        self.daily_analysis_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_daily_analysis())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.daily_analysis_search_status = tk.Label(daily_analysis_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.daily_analysis_search_status.pack(side="left", padx=10)
        
        self.sales_tc_analysis_tree = ttk.Treeview(self.sales_tc_analysis_frame, show="headings")
        self.sales_tc_analysis_tree.pack(side="left", fill="both", expand=True)
        
        sales_tc_analysis_scrollbar = ttk.Scrollbar(self.sales_tc_analysis_frame, orient="vertical", command=self.sales_tc_analysis_tree.yview)
        sales_tc_analysis_scrollbar.pack(side="right", fill="y")
        self.sales_tc_analysis_tree.configure(yscrollcommand=sales_tc_analysis_scrollbar.set)
        
        # æœˆ-äº§å“åˆ†ææ ‡ç­¾é¡µ
        self.sales_tc_monthly_frame = tk.Frame(self.product_notebook)
        self.product_notebook.add(self.sales_tc_monthly_frame, text="æœˆ - äº§å“åˆ†æ\nMonthly - Product Analysis")
        
        # æœˆ-äº§å“åˆ†ææ§åˆ¶é¢æ¿
        monthly_analysis_control_frame = tk.Frame(self.sales_tc_monthly_frame)
        monthly_analysis_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        monthly_analysis_search_frame = tk.Frame(monthly_analysis_control_frame)
        monthly_analysis_search_frame.pack(side="left", padx=5)
        
        tk.Label(monthly_analysis_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.monthly_analysis_search_entry = ttk.Entry(monthly_analysis_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.monthly_analysis_search_entry.pack(side="left", padx=2)
        self.monthly_analysis_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_monthly_analysis())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.monthly_analysis_search_status = tk.Label(monthly_analysis_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.monthly_analysis_search_status.pack(side="left", padx=10)
        
        self.sales_tc_monthly_tree = ttk.Treeview(self.sales_tc_monthly_frame, show="headings", selectmode="extended")
        self.sales_tc_monthly_tree.pack(side="left", fill="both", expand=True)
        
        sales_tc_monthly_scrollbar = ttk.Scrollbar(self.sales_tc_monthly_frame, orient="vertical", command=self.sales_tc_monthly_tree.yview)
        sales_tc_monthly_scrollbar.pack(side="right", fill="y")
        self.sales_tc_monthly_tree.configure(yscrollcommand=sales_tc_monthly_scrollbar.set)
        
        # ç¶å®šé¸æ“‡äº‹ä»¶ä¾†æ›´æ–°é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
        self.sales_tc_monthly_tree.bind("<<TreeviewSelect>>", self.on_monthly_analysis_selection_change)
        
        # åˆå§‹åŒ–é¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_monthly_analysis_products = []
        
        # äº§å“å…³è”åˆ†ææ ‡ç­¾é¡µ
        self.product_association_frame = tk.Frame(self.product_notebook)
        self.product_notebook.add(self.product_association_frame, text="äº§å“å…³è”åˆ†æ\nProduct Association Analysis")
        
        # äº§å“å…³è”åˆ†ææ§åˆ¶é¢æ¿
        association_control_frame = tk.Frame(self.product_association_frame)
        association_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        association_search_frame = tk.Frame(association_control_frame)
        association_search_frame.pack(side="left", padx=5)
        
        tk.Label(association_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.association_search_entry = ttk.Entry(association_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.association_search_entry.pack(side="left", padx=2)
        self.association_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_association())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.association_search_status = tk.Label(association_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.association_search_status.pack(side="left", padx=10)
        
        # äº§å“å…³è”åˆ†æè¡¨æ ¼
        association_tree_frame = tk.Frame(self.product_association_frame)
        association_tree_frame.pack(fill="both", expand=True, pady=5)
        
        # åˆ›å»ºäº§å“å…³è”åˆ†æè¡¨æ ¼
        columns = ("äº§å“1", "äº§å“2", "å…³è”åº¦", "å…±åŒé”€å”®æ¬¡æ•°", "äº§å“1é”€å”®æ¬¡æ•°", "äº§å“2é”€å”®æ¬¡æ•°")
        self.product_association_tree = ttk.Treeview(association_tree_frame, columns=columns, show="headings", height=20)
        
        # å‘¨æœŸäº§å“æ•°æ®æ§åˆ¶é¢æ¿
        weekly_control_frame = tk.Frame(self.weekly_product_frame)
        weekly_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        weekly_search_frame = tk.Frame(weekly_control_frame)
        weekly_search_frame.pack(side="left", padx=5)
        
        tk.Label(weekly_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.weekly_product_search_entry = ttk.Entry(weekly_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.weekly_product_search_entry.pack(side="left", padx=2)
        self.weekly_product_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_weekly_product())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.weekly_product_search_status = tk.Label(weekly_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.weekly_product_search_status.pack(side="left", padx=10)
        
        # å‘¨æœŸäº§å“æ•°æ®è¡¨æ ¼
        weekly_tree_frame = tk.Frame(self.weekly_product_frame)
        weekly_tree_frame.pack(fill="both", expand=True, pady=5)
        
        # åˆ›å»ºå‘¨æœŸäº§å“æ•°æ®è¡¨æ ¼
        columns = ("äº§å“åç§°", "å‘¨æ•°", "æœŸé—´", "ä¸šç»©", "äº§å“å•æ®æ•°", "é”€å”®æ•°é‡")
        self.weekly_product_tree = ttk.Treeview(weekly_tree_frame, columns=columns, show="headings", height=20, selectmode="extended")
        
        # è®¾ç½®åˆ—æ ‡é¢˜
        for col in columns:
            self.weekly_product_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.weekly_product_tree, c))
            self.weekly_product_tree.column(col, width=120, anchor="center")
        
        # ç¶å®šé¸æ“‡äº‹ä»¶ä¾†æ›´æ–°é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
        self.weekly_product_tree.bind("<<TreeviewSelect>>", self.on_weekly_product_selection_change)
        
        # åˆå§‹åŒ–é¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_weekly_products = []
        
        # æ·»åŠ æ»šåŠ¨æ¡
        weekly_scrollbar = ttk.Scrollbar(weekly_tree_frame, orient="vertical", command=self.weekly_product_tree.yview)
        self.weekly_product_tree.configure(yscrollcommand=weekly_scrollbar.set)
        
        # å¸ƒå±€
        self.weekly_product_tree.pack(side="left", fill="both", expand=True)
        weekly_scrollbar.pack(side="right", fill="y")
        
        # äº§å“æ€»è§ˆæ§åˆ¶é¢æ¿
        overview_control_frame = tk.Frame(self.product_overview_frame)
        overview_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æ˜¾ç¤ºæ—¥å‡å¼€å…³
        self.show_product_daily_average = self.show_daily_average
        product_daily_avg_cb = tk.Checkbutton(overview_control_frame, text="æ˜¾ç¤ºæ—¥å‡\nShow Daily Average", 
                                              variable=self.show_product_daily_average,
                                              command=self.toggle_product_daily_average)
        product_daily_avg_cb.pack(side="left", padx=10)
        
        # äº§å“æ€»è§ˆè¡¨æ ¼
        overview_tree_frame = tk.Frame(self.product_overview_frame)
        overview_tree_frame.pack(fill="both", expand=True, pady=5)
        
        self.product_overview_tree = ttk.Treeview(overview_tree_frame, show="headings", selectmode="extended")
        overview_scrollbar_y = ttk.Scrollbar(overview_tree_frame, orient="vertical", command=self.product_overview_tree.yview)
        overview_scrollbar_x = ttk.Scrollbar(overview_tree_frame, orient="horizontal", command=self.product_overview_tree.xview)
        self.product_overview_tree.configure(yscrollcommand=overview_scrollbar_y.set, xscrollcommand=overview_scrollbar_x.set)
        
        self.product_overview_tree.pack(side="left", fill="both", expand=True)
        
        # ç¶å®šé¸æ“‡äº‹ä»¶ä¾†æ›´æ–°é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
        self.product_overview_tree.bind("<<TreeviewSelect>>", self.on_daily_product_selection_change)
        
        # åˆå§‹åŒ–é¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_daily_products = []
        overview_scrollbar_y.pack(side="right", fill="y")
        overview_scrollbar_x.pack(side="bottom", fill="x")
        
        self.product_association_tree = ttk.Treeview(self.product_association_frame, show="headings", selectmode="extended")
        self.product_association_tree.pack(side="left", fill="both", expand=True)
        
        # ç¶å®šé¸æ“‡äº‹ä»¶ä¾†æ›´æ–°é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
        self.product_association_tree.bind("<<TreeviewSelect>>", self.on_association_selection_change)
        
        # åˆå§‹åŒ–é¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_association_products = []
        
        product_association_scrollbar = ttk.Scrollbar(self.product_association_frame, orient="vertical", command=self.product_association_tree.yview)
        product_association_scrollbar.pack(side="right", fill="y")
        self.product_association_tree.configure(yscrollcommand=product_association_scrollbar.set)
        
        # ç±»åˆ«åˆ†ææ§åˆ¶é¢æ¿
        category_analysis_control_frame = tk.Frame(self.category_analysis_frame)
        category_analysis_control_frame.pack(fill="x", padx=5, pady=5)
        
        # æœç´¢åŠŸèƒ½
        category_analysis_search_frame = tk.Frame(category_analysis_control_frame)
        category_analysis_search_frame.pack(side="left", padx=5)
        
        tk.Label(category_analysis_search_frame, text="ğŸ” æœç´¢:", font=('Microsoft YaHei UI', 9)).pack(side="left", padx=2)
        self.category_analysis_search_entry = ttk.Entry(category_analysis_search_frame, width=20, font=('Microsoft YaHei UI', 9))
        self.category_analysis_search_entry.pack(side="left", padx=2)
        self.category_analysis_search_entry.bind('<KeyRelease>', lambda e: self.realtime_search_category_analysis())
        
        # æœç´¢ç»“æœçŠ¶æ€æ ‡ç­¾
        self.category_analysis_search_status = tk.Label(category_analysis_search_frame, text="", font=('Microsoft YaHei UI', 8), fg='blue')
        self.category_analysis_search_status.pack(side="left", padx=10)
        
        # ç±»åˆ«åˆ†æè¡¨æ ¼
        self.category_analysis_tree = ttk.Treeview(self.category_analysis_frame, show="headings")
        self.category_analysis_tree.pack(side="left", fill="both", expand=True)
        
        category_analysis_scrollbar = ttk.Scrollbar(self.category_analysis_frame, orient="vertical", command=self.category_analysis_tree.yview)
        category_analysis_scrollbar.pack(side="right", fill="y")
        self.category_analysis_tree.configure(yscrollcommand=category_analysis_scrollbar.set)
        
        # åˆå§‹æ˜¾ç¤º
        self.log_message("POSæ•°æ®åˆ†æå·¥å…· - å¢å¼ºç‰ˆ")
        self.log_message("è¯·å…ˆç‚¹å‡»'è¿æ¥æ•°æ®åº“'å¼€å§‹...")
    
    def log_message(self, message, include_db_info=False):
        """è®°å½•æ¶ˆæ¯"""
        from datetime import datetime
        timestamp = datetime.now().strftime('%H:%M:%S')
        
        # å¦‚æœéœ€è¦åŒ…å«æ•°æ®åº“ä¿¡æ¯ä¸”æ•°æ®åº“å·²è¿æ¥
        if include_db_info and hasattr(self, 'db_manager') and self.db_manager.connection:
            try:
                min_date, max_date, total_days = self.db_manager.get_database_date_range()
                if min_date and max_date:
                    # æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                    min_date_str = min_date.strftime('%Y-%m-%d') if hasattr(min_date, 'strftime') else str(min_date)
                    max_date_str = max_date.strftime('%Y-%m-%d') if hasattr(max_date, 'strftime') else str(max_date)
                    db_info = f" | æ•°æ®åº“: {self.db_manager.current_database} | æ•°æ®èŒƒå›´: {min_date_str} è‡³ {max_date_str} | å…±{total_days}å¤©"
                    message = f"{message}{db_info}"
            except Exception as e:
                # å¦‚æœè·å–æ•°æ®åº“ä¿¡æ¯å¤±è´¥ï¼Œåªæ˜¾ç¤ºåŸºæœ¬æ¶ˆæ¯
                pass
        
        self.info_text.insert(tk.END, f"[{timestamp}] {message}\n")
        self.info_text.see(tk.END)
        self.root.update()
    
    def clear_output(self):
        """æ¸…ç©ºè¾“å‡º"""
        self.info_text.delete(1.0, tk.END)
    
    def log_database_info(self):
        """æ˜¾ç¤ºæ•°æ®åº“ä¿¡æ¯"""
        if hasattr(self, 'db_manager') and self.db_manager.connection:
            try:
                min_date, max_date, total_days = self.db_manager.get_database_date_range()
                if min_date and max_date:
                    # æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                    min_date_str = min_date.strftime('%Y-%m-%d') if hasattr(min_date, 'strftime') else str(min_date)
                    max_date_str = max_date.strftime('%Y-%m-%d') if hasattr(max_date, 'strftime') else str(max_date)
                    self.log_message(f"ğŸ“Š æ•°æ®åº“ä¿¡æ¯: {self.db_manager.current_database} | æ•°æ®èŒƒå›´: {min_date_str} è‡³ {max_date_str} | å…±{total_days}å¤©")
                else:
                    self.log_message("ğŸ“Š æ•°æ®åº“ä¿¡æ¯: æ— æ³•è·å–æ•°æ®æ—¥æœŸèŒƒå›´")
            except Exception as e:
                self.log_message(f"ğŸ“Š æ•°æ®åº“ä¿¡æ¯è·å–å¤±è´¥: {e}")
        else:
            self.log_message("ğŸ“Š æ•°æ®åº“ä¿¡æ¯: æœªè¿æ¥åˆ°æ•°æ®åº“")
    
    def show_performance_tips(self):
        """æ˜¾ç¤ºæ€§èƒ½ä¼˜åŒ–å»ºè®®"""
        self.log_message("=== æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–å»ºè®® ===")
        for tip in self.db_manager.performance_tips:
            self.log_message(tip)
        self.log_message("")
        self.log_message("=== æŸ¥è¯¢ä¼˜åŒ–è¯´æ˜ ===")
        self.log_message("âœ“ å·²æ·»åŠ  NOLOCK æç¤ºå‡å°‘é”ç­‰å¾…")
        self.log_message("âœ“ å·²æ·»åŠ  OPTION (RECOMPILE) ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’")
        self.log_message("âœ“ å·²ä¼˜åŒ–äº§å“å…³è”åˆ†æä½¿ç”¨ CTE å’Œ INNER JOIN")
        self.log_message("âœ“ å·²å®ç°æ‰¹é‡æŸ¥è¯¢å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°")
        self.log_message("âœ“ å»ºè®®åœ¨æ•°æ®åº“æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸Šè¿°ç´¢å¼•ä»¥è¿›ä¸€æ­¥æå‡æ€§èƒ½")
    
    def sort_treeview(self, tree, col, reverse=False):
        """å¯¹TreeViewè¿›è¡Œæ’åº"""
        data = [(tree.set(child, col), child) for child in tree.get_children('')]
        
        # å°è¯•è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ’åº
        try:
            data.sort(key=lambda x: float(x[0]) if x[0] else 0, reverse=reverse)
        except ValueError:
            # å¦‚æœæ— æ³•è½¬æ¢ä¸ºæ•°å­—ï¼Œåˆ™æŒ‰å­—ç¬¦ä¸²æ’åº
            data.sort(key=lambda x: x[0], reverse=reverse)
        
        # é‡æ–°æ’åˆ—é¡¹ç›®
        for index, (val, child) in enumerate(data):
            tree.move(child, '', index)
        
        # åˆ‡æ¢æ’åºæ–¹å‘
        tree.heading(col, command=lambda: self.sort_treeview(tree, col, not reverse))
    
    def toggle_all_outlets(self):
        """åˆ‡æ¢å…¨éƒ¨é—¨å¸‚é€‰æ‹©"""
        self.outlet_combo.toggle_all()
        self.outlet_combo.execute_callback_immediately()  # ç«‹å³æ‰§è¡Œå›è°ƒ
        self.log_message("åˆ‡æ¢é—¨å¸‚é€‰æ‹©çŠ¶æ€")
    
    def toggle_all_months(self):
        """åˆ‡æ¢å…¨éƒ¨æœˆä»½é€‰æ‹©"""
        self.month_combo.toggle_all()
        self.month_combo.execute_callback_immediately()  # ç«‹å³æ‰§è¡Œå›è°ƒ
        self.log_message("åˆ‡æ¢æœˆä»½é€‰æ‹©çŠ¶æ€")
    
    def toggle_all_weekdays(self):
        """åˆ‡æ¢å…¨éƒ¨æ˜ŸæœŸé€‰æ‹©"""
        self.weekday_combo.toggle_all()
        self.weekday_combo.execute_callback_immediately()  # ç«‹å³æ‰§è¡Œå›è°ƒ
        self.log_message("åˆ‡æ¢æ˜ŸæœŸé€‰æ‹©çŠ¶æ€")
    
    def toggle_all_payments(self):
        """åˆ‡æ¢å…¨éƒ¨æ”¯ä»˜æ–¹å¼é€‰æ‹©"""
        self.payment_combo.toggle_all()
        self.payment_combo.execute_callback_immediately()  # ç«‹å³æ‰§è¡Œå›è°ƒ
        self.log_message("åˆ‡æ¢æ”¯ä»˜æ–¹å¼é€‰æ‹©çŠ¶æ€")
    
    def toggle_all_categories(self):
        """åˆ‡æ¢å…¨éƒ¨ç±»åˆ«é€‰æ‹©"""
        self.category_combo.toggle_all()
        self.category_combo.execute_callback_immediately()  # ç«‹å³æ‰§è¡Œå›è°ƒ
        self.log_message("åˆ‡æ¢ç±»åˆ«é€‰æ‹©çŠ¶æ€")
        # æ›´æ–°äº§å“åˆ—è¡¨
        self.update_products_by_category()
    
    def toggle_all_products(self):
        """åˆ‡æ¢å…¨éƒ¨äº§å“é€‰æ‹©"""
        self.product_combo.toggle_all()
        self.product_combo.execute_callback_immediately()  # ç«‹å³æ‰§è¡Œå›è°ƒ
        self.log_message("åˆ‡æ¢äº§å“é€‰æ‹©çŠ¶æ€")
    
    def on_outlet_changed(self, selected_values):
        """é—¨å¸‚é€‰æ‹©æ”¹å˜æ—¶è§¦å‘"""
        self.log_message(f"é€‰æ‹©äº† {len(selected_values)} ä¸ªé—¨å¸‚")
        self.update_cascade_filters()
    
    def on_month_changed(self, selected_values):
        """æœˆä»½é€‰æ‹©æ”¹å˜æ—¶è§¦å‘"""
        self.log_message(f"é€‰æ‹©äº† {len(selected_values)} ä¸ªæœˆä»½")
        self.update_cascade_filters()
    
    def on_weekday_changed(self, selected_values):
        """æ˜ŸæœŸé€‰æ‹©æ”¹å˜æ—¶è§¦å‘"""
        self.log_message(f"é€‰æ‹©äº† {len(selected_values)} ä¸ªæ˜ŸæœŸ")
        self.update_cascade_filters()
    
    def on_payment_changed(self, selected_values):
        """æ”¯ä»˜æ–¹å¼é€‰æ‹©æ”¹å˜æ—¶è§¦å‘"""
        self.log_message(f"é€‰æ‹©äº† {len(selected_values)} ç§æ”¯ä»˜æ–¹å¼")
        self.update_cascade_filters()
    
    def on_category_changed(self, selected_values):
        """ç±»åˆ«é€‰æ‹©æ”¹å˜æ—¶è§¦å‘"""
        self.log_message(f"é€‰æ‹©äº† {len(selected_values)} ä¸ªç±»åˆ«")
        self.update_products_by_category()
    
    def on_product_changed(self, selected_values):
        """äº§å“é€‰æ‹©æ”¹å˜æ—¶è§¦å‘"""
        self.log_message(f"é€‰æ‹©äº† {len(selected_values)} ä¸ªäº§å“")
    
    def update_cascade_filters(self):
        """æ›´æ–°çº§è”ç­›é€‰"""
        # è·å–å½“å‰é€‰æ‹©çš„ç­›é€‰æ¡ä»¶
        selected_outlets = self.outlet_combo.get_selected()
        selected_months = self.month_combo.get_selected()
        selected_payments = self.payment_combo.get_selected()
        
        # æ ¹æ®æ”¯ä»˜æ–¹å¼æ›´æ–°ç±»åˆ«åˆ—è¡¨
        self.update_categories_by_payment(selected_payments)
        
        # æ ¹æ®é—¨å¸‚ã€æœˆä»½ã€æ”¯ä»˜æ–¹å¼æ›´æ–°äº§å“åˆ—è¡¨
        self.update_products_by_filters(selected_outlets, selected_months, selected_payments)
    
    def update_categories_by_payment(self, payment_filters):
        """æ ¹æ®æ”¯ä»˜æ–¹å¼æ›´æ–°ç±»åˆ«åˆ—è¡¨"""
        if not payment_filters or len(payment_filters) == 0:
            # å¦‚æœæ²¡æœ‰é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼ŒåŠ è½½æ‰€æœ‰ç±»åˆ«
            self.load_all_categories()
        else:
            # æ ¹æ®æ”¯ä»˜æ–¹å¼ç­›é€‰ç±»åˆ«
            db = self.selected_db.get()
            if not self.db_manager.connect(db):
                return
            
            try:
                categories = self.db_manager.get_categories_by_payment(payment_filters)
                self.category_combo.set_values(categories)
                self.log_message(f"æ ¹æ®æ”¯ä»˜æ–¹å¼ç­›é€‰å‡º {len(categories)} ä¸ªç±»åˆ«")
            except Exception as e:
                self.log_message(f"âœ— ç­›é€‰ç±»åˆ«å¤±è´¥: {e}")
            finally:
                self.db_manager.disconnect()
    
    def update_products_by_filters(self, outlet_filters, month_filters, payment_filters):
        """æ ¹æ®ç­›é€‰æ¡ä»¶æ›´æ–°äº§å“åˆ—è¡¨"""
        # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç­›é€‰æ¡ä»¶éƒ½æ˜¯ç©ºçš„ï¼ˆå³é€‰æ‹©"å…¨éƒ¨"ï¼‰
        if (not outlet_filters or len(outlet_filters) == 0) and \
           (not month_filters or len(month_filters) == 0) and \
           (not payment_filters or len(payment_filters) == 0):
            # å¦‚æœæ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼ŒåŠ è½½æ‰€æœ‰äº§å“
            self.load_all_products()
        else:
            # æ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰äº§å“
            db = self.selected_db.get()
            if not self.db_manager.connect(db):
                return
            
            try:
                products = self.db_manager.get_products_by_filters(outlet_filters, month_filters, payment_filters)
                # ä¿å­˜å½“å‰é€‰ä¸­çš„äº§å“
                current_selected = self.product_combo.get_selected()
                self.product_combo.set_values(products)
                
                # å¦‚æœä¹‹å‰æœ‰é€‰ä¸­çš„äº§å“ï¼Œå°è¯•ä¿æŒé€‰æ‹©
                if current_selected:
                    # è¿‡æ»¤å‡ºä»ç„¶å¯ç”¨çš„äº§å“
                    available_selected = [p for p in current_selected if p in products]
                    if available_selected:
                        self.product_combo.set_selected(available_selected)
                        self.log_message(f"æ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰å‡º {len(products)} ä¸ªäº§å“ï¼Œä¿æŒ {len(available_selected)} ä¸ªå·²é€‰æ‹©çš„äº§å“")
                    else:
                        self.log_message(f"æ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰å‡º {len(products)} ä¸ªäº§å“ï¼Œä¹‹å‰é€‰æ‹©çš„äº§å“ä¸åœ¨ç­›é€‰èŒƒå›´å†…")
                else:
                    self.log_message(f"æ ¹æ®ç­›é€‰æ¡ä»¶ç­›é€‰å‡º {len(products)} ä¸ªäº§å“")
            except Exception as e:
                self.log_message(f"âœ— ç­›é€‰äº§å“å¤±è´¥: {e}")
            finally:
                self.db_manager.disconnect()
    
    
    def on_outlet_changed_old(self, event=None):
        """å½“é—¨å¸‚é€‰æ‹©æ”¹å˜æ—¶è‡ªåŠ¨åº”ç”¨ç­›é€‰"""
        selected_outlets = self.outlet_combo.get_selected()
        if selected_outlets:
            self.log_message(f"è‡ªåŠ¨ç­›é€‰é—¨å¸‚: {', '.join(selected_outlets)}")
            # è‡ªåŠ¨è·å–å½“å‰æ ‡ç­¾é¡µçš„æ•°æ®
            current_tab = self.notebook.index(self.notebook.select())
            if current_tab == 1:  # é”€å”®æ•°æ®
                self.get_sales_data()
            elif current_tab == 2:  # æ”¯ä»˜åˆ†æ
                self.get_payment_analysis()
            elif current_tab == 3:  # æŠ˜æ‰£åˆ†æ
                self.get_discount_analysis()
            elif current_tab == 4:  # æœˆåº¦æ±‡æ€»
                self.get_monthly_summary()
    
    def update_products_by_category(self):
        """æ ¹æ®é€‰ä¸­çš„ç±»åˆ«æ›´æ–°äº§å“åˆ—è¡¨"""
        selected_categories = self.category_combo.get_selected()
        if selected_categories and len(selected_categories) < len(self.category_combo.values):
            self.log_message(f"ç­›é€‰ç±»åˆ«: {', '.join(selected_categories)}")
            # è·å–è¯¥ç±»åˆ«ä¸‹çš„äº§å“
            self.load_products_by_category(selected_categories)
        else:
            # å¦‚æœé€‰æ‹©å…¨éƒ¨ï¼ŒåŠ è½½æ‰€æœ‰äº§å“
            self.load_all_products()
    
    def load_products_by_category(self, categories):
        """æ ¹æ®ç±»åˆ«åŠ è½½äº§å“åˆ—è¡¨"""
        if not categories:
            self.load_all_products()
            return
            
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            return
        
        try:
            cursor = self.db_manager.connection.cursor()
            # æ„å»ºINæ¡ä»¶
            placeholders = ','.join(['?' for _ in categories])
            cursor.execute(f"""
                SELECT DISTINCT s.item_name 
                FROM pos_sales_dtls s
                INNER JOIN (
                    SELECT item_name, category_code
                    FROM item_master im1
                    WHERE im1.m_date = (
                        SELECT MAX(m_date) 
                        FROM item_master im2 
                        WHERE im2.item_name = im1.item_name
                    )
                ) im ON s.item_name = im.item_name
                WHERE im.category_code IN ({placeholders})
                ORDER BY s.item_name
            """, categories)
            results = cursor.fetchall()
            products = [row[0] for row in results if row[0]]
            cursor.close()
            
            self.product_combo.set_values(products)
            self.log_message(f"âœ“ åŠ è½½äº† {len(products)} ä¸ª{', '.join(categories)}ç±»åˆ«çš„äº§å“")
        except Exception as e:
            self.log_message(f"âœ— åŠ è½½äº§å“å¤±è´¥: {e}")
        finally:
            self.db_manager.disconnect()
    
    def load_all_products(self):
        """åŠ è½½æ‰€æœ‰äº§å“"""
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            return
        
        try:
            products = self.db_manager.get_products()
            if products:
                self.product_combo.set_values(products)
                # æ¸…ç©ºé€‰æ‹©ï¼Œæ˜¾ç¤º"å…¨éƒ¨"
                self.product_combo.set_selected([])
                self.log_message(f"âœ“ åŠ è½½äº† {len(products)} ä¸ªäº§å“ï¼Œè®¾ç½®ä¸ºå…¨éƒ¨é€‰æ‹©")
        except Exception as e:
            self.log_message(f"âœ— åŠ è½½äº§å“å¤±è´¥: {e}")
        finally:
            self.db_manager.disconnect()
    
    def load_all_categories(self):
        """åŠ è½½æ‰€æœ‰ç±»åˆ«"""
        try:
            categories = self.db_manager.get_categories()
            self.category_combo.set_values(categories)
            self.log_message(f"âœ“ åŠ è½½äº† {len(categories)} ä¸ªç±»åˆ«")
        except Exception as e:
            self.log_message(f"âœ— åŠ è½½ç±»åˆ«å¤±è´¥: {e}")
    
    
    def apply_filter(self):
        """åº”ç”¨ç­›é€‰æ¡ä»¶åˆ°å½“å‰æ ‡ç­¾é¡µ"""
        current_tab = self.notebook.index(self.notebook.select())
        self.log_message("åº”ç”¨ç­›é€‰æ¡ä»¶...")
        
        if current_tab == 1:  # é”€å”®æ•°æ®
            self.get_sales_data()
        elif current_tab == 2:  # æ”¯ä»˜åˆ†æ
            self.get_payment_analysis()
        elif current_tab == 3:  # æŠ˜æ‰£åˆ†æ
            self.get_discount_analysis()
        elif current_tab == 4:  # æœˆåº¦æ±‡æ€»
            self.get_monthly_summary()
        elif current_tab == 5:  # æ—¥-äº§å“åˆ†æ
            self.get_sales_tc_analysis()
        else:
            self.log_message("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°æ®æ ‡ç­¾é¡µ")
    
    def setup_initial_layout(self):
        """è®¾ç½®åˆå§‹å¸ƒå±€"""
        # åˆå§‹åŒ–æ—¶ä¸éœ€è¦è°ƒç”¨å¸ƒå±€æ–¹æ³•ï¼Œnotebookå·²ç»åœ¨setup_uiä¸­æ­£ç¡®è®¾ç½®äº†
        pass
    
    def connect_database(self):
        """è¿æ¥æ•°æ®åº“å¹¶åŠ è½½é€‰é¡¹"""
        # ç²å–é¸ä¸­çš„é¸é …éµ
        option_key = self.selected_db.get()
        print(f"DEBUG: connect_database() - option_key = '{option_key}'")
        
        # ç²å–å¯¦éš›çš„æ•¸æ“šåº«åç¨±
        option_info = self.DATABASE_OPTIONS.get(option_key, {})
        actual_db_name = option_info.get('db', option_key)
        cn_name = option_info.get('cn', option_key)
        
        print(f"DEBUG: option_info = {option_info}")
        print(f"DEBUG: actual_db_name = '{actual_db_name}'")
        print(f"DEBUG: cn_name = '{cn_name}'")
        
        self.log_message(f"æ­£åœ¨è¿æ¥åˆ° {cn_name}...")
        
        if not self.db_manager.connect(actual_db_name):
            self.log_message(f"âœ— æ— æ³•è¿æ¥åˆ° {cn_name}")
            return
        
        self.log_message(f"âœ“ è¿æ¥æˆåŠŸ", include_db_info=True)
        
        # æ˜¾ç¤ºæ•°æ®åº“è¯¦ç»†ä¿¡æ¯
        self.log_database_info()
        
        # åŠ è½½é—¨å¸‚åˆ—è¡¨
        self.log_message("æ­£åœ¨åŠ è½½é—¨å¸‚åˆ—è¡¨...")
        outlets = self.db_manager.get_outlets()
        if outlets:
            self.outlet_combo.set_values(outlets)
            # ä¿å­˜é—¨å¸‚åˆ—è¡¨ä¾›æ´»åŠ¨è®°å½•çª—å£ä½¿ç”¨
            self.available_outlets = outlets
            self.log_message(f"âœ“ åŠ è½½äº† {len(outlets)} ä¸ªé—¨å¸‚")
            self.log_message(f"é—¨å¸‚åˆ—è¡¨: {outlets[:5]}{'...' if len(outlets) > 5 else ''}")  # æ˜¾ç¤ºå‰5ä¸ªé—¨å¸‚
        else:
            self.log_message("âœ— æ²¡æœ‰è·å–åˆ°é—¨å¸‚æ•°æ®")
        
        # åŠ è½½äº§å“åˆ—è¡¨
        self.log_message("æ­£åœ¨åŠ è½½äº§å“åˆ—è¡¨...")
        products = self.db_manager.get_products()
        if products:
            self.product_combo.set_values(products)
            self.log_message(f"âœ“ åŠ è½½äº† {len(products)} ä¸ªäº§å“")
        
        # æ›´æ–°æ´»å‹•æé†’
        try:
            self.update_activity_alerts()
        except Exception as e:
            print(f"æ›´æ–°æ´»å‹•æé†’å¤±æ•—: {e}")
        
        # åŠ è½½æœˆä»½åˆ—è¡¨
        self.log_message("æ­£åœ¨åŠ è½½æœˆä»½åˆ—è¡¨...")
        months = self.db_manager.get_months()
        if months:
            self.month_combo.set_values(months)
            self.log_message(f"âœ“ åŠ è½½äº† {len(months)} ä¸ªæœˆä»½")
        
        # åŠ è½½æ˜ŸæœŸåˆ—è¡¨
        self.log_message("æ­£åœ¨åŠ è½½æ˜ŸæœŸåˆ—è¡¨...")
        weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
        self.weekday_combo.set_values(weekdays)
        self.log_message(f"âœ“ åŠ è½½äº† {len(weekdays)} ä¸ªæ˜ŸæœŸ")
        
        # åŠ è½½ç±»åˆ«åˆ—è¡¨
        self.log_message("æ­£åœ¨åŠ è½½ç±»åˆ«åˆ—è¡¨...")
        categories = self.db_manager.get_categories()
        if categories:
            self.category_combo.set_values(categories)
            self.log_message(f"âœ“ åŠ è½½äº† {len(categories)} ä¸ªç±»åˆ«")
        
        # åŠ è½½æ”¯ä»˜æ–¹å¼åˆ—è¡¨
        self.log_message("æ­£åœ¨åŠ è½½æ”¯ä»˜æ–¹å¼åˆ—è¡¨...")
        payment_names = self.db_manager.get_payment_names()
        if payment_names:
            self.payment_combo.set_values(payment_names)
            self.log_message(f"âœ“ åŠ è½½äº† {len(payment_names)} ç§æ”¯ä»˜æ–¹å¼")
        
        self.db_manager.disconnect()
    
    def get_sales_data(self):
        """è·å–é”€å”®æ•°æ® - æ™ºèƒ½ç¼“å­˜ç‰ˆæœ¬"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å„ªå…ˆæœ¬åœ°ï¼šå¦‚æœæœ¬åœ°æœ‰æŒ‰æ—¥æˆ–æŒ‰æœˆå°å‡ºæ–‡ä»¶/SQLiteï¼Œç›´æ¥ç”¨ï¼ˆä¸Šæ–¹å·²æœ‰æœˆåº¦/å–®æ—¥å°å‡ºå„ªå…ˆé‚è¼¯ï¼‰
        # è‹¥èµ°åˆ°é€™è£¡é‚„éœ€è¦SQLï¼Œæ‰é€£ç·š
        db = self.selected_db.get()
        self.log_message(f"ç•¶å‰é¸æ“‡: {db}")
        
        # è·å–ç­›é€‰æ¡ä»¶
        # æ ¹æ®æ—¥æœŸç­›é€‰å¼€å…³å†³å®šæ˜¯å¦ä½¿ç”¨æ—¥æœŸç­›é€‰
        if self.use_date_filter.get():
            # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
            
            # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
            if date_from and date_to and date_from == date_to:
                self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
            elif date_to:
                self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
        else:
            # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
            
        # ä¼˜å…ˆæ£€æŸ¥å·²å¯¼å‡ºçš„æ•°æ®æ–‡ä»¶
        current_database = self.db_manager.current_database
        current_include_payment = False
        
        # å°†å®Œæ•´æ•°æ®åº“åç§°è½¬æ¢ä¸ºç®€åŒ–åç§°ï¼ˆç”¨äºæ–‡ä»¶æŸ¥æ‰¾ï¼‰
        db_name_mapping = {
            'sushi_gogo_pos_live': 'GOGO',
            'sushi_express_pos_live': 'Express', 
            'sushi_plus_pos_live': 'PLUS'
        }
        simplified_db_name = db_name_mapping.get(current_database, current_database)
        
        export_dir = "new_staged_export_specific_data"
        exported_data_found = False
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å·²å¯¼å‡ºçš„æœˆåº¦æ•°æ®æ–‡ä»¶
        from datetime import datetime
        start_date = datetime.strptime(date_from, '%Y-%m-%d')
        end_date = datetime.strptime(date_to, '%Y-%m-%d')
        
        # æ£€æŸ¥è·¨æœˆæŸ¥è¯¢æˆ–å•æœˆæŸ¥è¯¢
        if start_date.month == end_date.month and start_date.year == end_date.year:
            # å•æœˆæŸ¥è¯¢
            self.log_message("ğŸ“… å•æœˆæŸ¥è¯¢ - ä½¿ç”¨å·²å¯¼å‡ºæœˆåº¦æ•°æ®")
            month_str_dash = start_date.strftime('%Y-%m')  # 2025-09
            month_str_underscore = start_date.strftime('%Y_%m')  # 2025_09
            
            exported_monthly_file_dash = f"{export_dir}/{simplified_db_name}_sales_raw_{month_str_dash}.pkl.gz"
            exported_monthly_file_underscore = f"{export_dir}/{simplified_db_name}_sales_raw_{month_str_underscore}.pkl.gz"
            
            # ä¼˜å…ˆä½¿ç”¨è¿å­—ç¬¦æ ¼å¼ï¼ˆä¸æ‚¨çš„å¯¼å‡ºæ–‡ä»¶åŒ¹é…ï¼‰
            exported_monthly_file = exported_monthly_file_dash if os.path.exists(exported_monthly_file_dash) else exported_monthly_file_underscore
            
            # è°ƒè¯•ä¿¡æ¯
            self.log_message(f"ğŸ” æ£€æŸ¥å·²å¯¼å‡ºæœˆåº¦æ–‡ä»¶:")
            self.log_message(f"   è¿å­—ç¬¦æ ¼å¼: {exported_monthly_file_dash} - {'å­˜åœ¨' if os.path.exists(exported_monthly_file_dash) else 'ä¸å­˜åœ¨'}")
            self.log_message(f"   ä¸‹åˆ’çº¿æ ¼å¼: {exported_monthly_file_underscore} - {'å­˜åœ¨' if os.path.exists(exported_monthly_file_underscore) else 'ä¸å­˜åœ¨'}")
            self.log_message(f"   æœ€ç»ˆé€‰æ‹©: {exported_monthly_file}")
            
            if os.path.exists(exported_monthly_file):
                self.log_message(f"ğŸ“ å‘ç°å·²å¯¼å‡ºæœˆåº¦æ•°æ®: {exported_monthly_file}")
                try:
                    import gzip
                    import pickle
                    with gzip.open(exported_monthly_file, 'rb') as f:
                        monthly_data = pickle.load(f)
                    
                    # ä»æœˆåº¦æ•°æ®ä¸­ç­›é€‰æŒ‡å®šæ—¥æœŸèŒƒå›´çš„æ•°æ®
                    filtered_data = []
                    for record in monthly_data:
                        record_date = record.get('c_date', '')
                        if isinstance(record_date, str) and date_from <= record_date <= date_to:
                            filtered_data.append(record)
                        elif hasattr(record_date, 'date') and date_from <= str(record_date.date()) <= date_to:
                            filtered_data.append(record)
                    
                    if filtered_data:
                        self.log_message(f"âœ“ ä»å·²å¯¼å‡ºæœˆåº¦æ•°æ®è·å– {len(filtered_data)} æ¡è®°å½•")
                        self.cached_sales_data = filtered_data
                        exported_data_found = True
                    else:
                        self.log_message(f"âš ï¸ å·²å¯¼å‡ºæœˆåº¦æ•°æ®ä¸­æœªæ‰¾åˆ° {date_from} åˆ° {date_to} çš„æ•°æ®")
                except Exception as e:
                    self.log_message(f"âœ— è¯»å–å·²å¯¼å‡ºæœˆåº¦æ•°æ®å¤±è´¥: {e}")
        else:
            # è·¨æœˆæŸ¥è¯¢ - å°è¯•åˆå¹¶å¤šä¸ªæœˆçš„å·²å¯¼å‡ºæ•°æ®
            self.log_message(f"ğŸ“… è·¨æœˆæŸ¥è¯¢ ({start_date.strftime('%Y-%m')} åˆ° {end_date.strftime('%Y-%m')}) - å°è¯•åˆå¹¶å·²å¯¼å‡ºæœˆåº¦æ•°æ®")
            
            all_filtered_data = []
            current_date = start_date
            
            while current_date <= end_date:
                month_str_dash = current_date.strftime('%Y-%m')  # 2025-09
                month_str_underscore = current_date.strftime('%Y_%m')  # 2025_09
                
                exported_monthly_file_dash = f"{export_dir}/{simplified_db_name}_sales_raw_{month_str_dash}.pkl.gz"
                exported_monthly_file_underscore = f"{export_dir}/{simplified_db_name}_sales_raw_{month_str_underscore}.pkl.gz"
                
                # ä¼˜å…ˆä½¿ç”¨è¿å­—ç¬¦æ ¼å¼
                exported_monthly_file = exported_monthly_file_dash if os.path.exists(exported_monthly_file_dash) else exported_monthly_file_underscore
                
                if os.path.exists(exported_monthly_file):
                    self.log_message(f"ğŸ“ è¯»å– {current_date.strftime('%Y-%m')} çš„å·²å¯¼å‡ºæ•°æ®: {exported_monthly_file}")
                    try:
                        import gzip
                        import pickle
                        with gzip.open(exported_monthly_file, 'rb') as f:
                            monthly_data = pickle.load(f)
                        
                        # ä»æœˆåº¦æ•°æ®ä¸­ç­›é€‰æŒ‡å®šæ—¥æœŸèŒƒå›´çš„æ•°æ®
                        for record in monthly_data:
                            record_date = record.get('c_date', '')
                            if isinstance(record_date, str) and date_from <= record_date <= date_to:
                                all_filtered_data.append(record)
                            elif hasattr(record_date, 'date') and date_from <= str(record_date.date()) <= date_to:
                                all_filtered_data.append(record)
                        
                        self.log_message(f"âœ“ ä» {current_date.strftime('%Y-%m')} è·å– {len([r for r in monthly_data if date_from <= r.get('c_date', '') <= date_to])} æ¡è®°å½•")
                        
                    except Exception as e:
                        self.log_message(f"âœ— è¯»å– {current_date.strftime('%Y-%m')} æ•°æ®å¤±è´¥: {e}")
                else:
                    self.log_message(f"âš ï¸ {current_date.strftime('%Y-%m')} çš„å·²å¯¼å‡ºæ•°æ®ä¸å­˜åœ¨")
                
                # ç§»åŠ¨åˆ°ä¸‹ä¸ªæœˆ
                if current_date.month == 12:
                    current_date = current_date.replace(year=current_date.year + 1, month=1)
                else:
                    current_date = current_date.replace(month=current_date.month + 1)
            
            if all_filtered_data:
                self.log_message(f"âœ“ è·¨æœˆæŸ¥è¯¢å®Œæˆï¼Œæ€»å…±è·å– {len(all_filtered_data)} æ¡è®°å½•")
                self.cached_sales_data = all_filtered_data
                exported_data_found = True
            else:
                self.log_message("âš ï¸ è·¨æœˆæŸ¥è¯¢æœªæ‰¾åˆ°ä»»ä½•å·²å¯¼å‡ºæ•°æ®")
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å·²å¯¼å‡ºæ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æŸ¥è¯¢æ•°æ®åº“
        if not exported_data_found:
            need_refresh = (
                len(self.cached_sales_data) == 0 or  # æ²¡æœ‰ç¼“å­˜æ•°æ®
                self.cache_date_range != (date_from, date_to) or  # æ—¥æœŸèŒƒå›´æ”¹å˜
                self.cache_database != current_database or  # æ•°æ®åº“æ”¹å˜
                False
            )
            
            if need_refresh:
                # å„ªå…ˆæœ¬åœ°SQLiteå½™ç¸½
                local_sales = self.db_manager.get_local_sales_analysis(
                    date_from=date_from,
                    date_to=date_to,
                    outlet_filters=outlet_filters,
                    product_filters=product_filters,
                    month_filters=month_filters,
                    weekday_filters=weekday_filters,
                    category_filters=category_filters,
                    payment_filters=payment_filters,
                )
                if local_sales:
                    self.log_message("ğŸ“¦ ä½¿ç”¨æœ¬åœ°SQLiteéŠ·å”®åˆ†ææ•¸æ“š")
                    self.cached_sales_data = local_sales
                else:
                    self.log_message("â„¹ æœ¬åœ°ç„¡éŠ·å”®åˆ†ææ•¸æ“šï¼Œå›é€€åˆ°SQL Server")
                    # é€£ç·šä¸¦å¾SQLæŸ¥
                    if not self.db_manager.connection:
                        self.db_manager.connect(db)
                    self.cached_sales_data = self.db_manager.get_sales_data(
                        date_from, date_to, [], [], None, [], [], [], []
                    )
            
            if self.cached_sales_data:
                self.log_message(f"âœ“ æ•°æ®åº“æŸ¥è¯¢æˆåŠŸï¼Œå…± {len(self.cached_sales_data)} æ¡è®°å½•")
                # æ›´æ–°ç¼“å­˜ä¿¡æ¯
                self.cache_date_range = (date_from, date_to)
                self.cache_database = current_database
            else:
                self.log_message("âœ— æ•°æ®åº“æŸ¥è¯¢å¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
                self.db_manager.disconnect()
                return
        else:
            self.log_message("âš¡ ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢æ•°æ®åº“")
        
        # åº”ç”¨ç­›é€‰æ¡ä»¶
        self.log_message("ğŸ” æ­£åœ¨åº”ç”¨ç­›é€‰æ¡ä»¶...")
        filtered_data = self.apply_filters_to_cached_data()
        
        if filtered_data:
            self.log_message(f"âœ“ ç­›é€‰å®Œæˆï¼Œå…± {len(filtered_data)} æ¡è®°å½•")
            self.sales_data = filtered_data
            self.display_sales_data()
        else:
            self.log_message("â„¹ ç­›é€‰åæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®")
            self.sales_data = []
        
        self.db_manager.disconnect()
    
    def apply_filters_to_cached_data(self):
        """å¯¹ç¼“å­˜æ•°æ®åº”ç”¨ç­›é€‰æ¡ä»¶"""
        if not self.cached_sales_data:
            return []
        
        filtered_data = self.cached_sales_data.copy()
        
        # è·å–å½“å‰ç­›é€‰æ¡ä»¶
        outlet_filters = self.outlet_combo.get_selected()
        product_filters = self.product_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()

        # ä¿å­˜é—¨å¸‚ç­›é€‰
        self.period_product_outlet_filters = [o for o in outlet_filters if o]

        # ä¿å­˜é—¨å¸‚ç­›é€‰
        self.product_overview_outlet_filters = [o for o in outlet_filters if o]

        # ä¿å­˜é—¨åº—ç­›é€‰ç”¨äºå•åº—å¹³å‡è®¡ç®—
        self.period_product_outlet_filters = [o for o in outlet_filters if o]

        # ä¿å­˜é—¨åº—ç­›é€‰ç”¨äºå•åº—å¹³å‡è®¡ç®—
        self.product_overview_outlet_filters = [o for o in outlet_filters if o]
        
        self.log_message(f"â„¹ ç­›é€‰æ¡ä»¶ - é—¨å¸‚: {outlet_filters if outlet_filters else 'å…¨éƒ¨'}")
        self.log_message(f"â„¹ ç­›é€‰æ¡ä»¶ - äº§å“: {product_filters if product_filters else 'å…¨éƒ¨'}")
        self.log_message(f"â„¹ ç­›é€‰æ¡ä»¶ - æœˆä»½: {month_filters if month_filters else 'å…¨éƒ¨'}")
        self.log_message(f"â„¹ ç­›é€‰æ¡ä»¶ - æ˜ŸæœŸ: {weekday_filters if weekday_filters else 'å…¨éƒ¨'}")
        self.log_message(f"â„¹ ç­›é€‰æ¡ä»¶ - ç±»åˆ«: {category_filters if category_filters else 'å…¨éƒ¨'}")
        self.log_message(f"â„¹ ç­›é€‰æ¡ä»¶ - æ”¯ä»˜æ–¹å¼: {payment_filters if payment_filters else 'å…¨éƒ¨'}")
        
        # åº”ç”¨é—¨å¸‚ç­›é€‰
        if outlet_filters:
            filtered_data = [record for record in filtered_data if record.get('store_name') in outlet_filters]
            self.log_message(f"âœ“ é—¨å¸‚ç­›é€‰å: {len(filtered_data)} æ¡è®°å½•")
        
        # åº”ç”¨äº§å“ç­›é€‰
        if product_filters:
            filtered_data = [record for record in filtered_data if record.get('item_name') in product_filters]
            self.log_message(f"âœ“ äº§å“ç­›é€‰å: {len(filtered_data)} æ¡è®°å½•")
        
        # åº”ç”¨æœˆä»½ç­›é€‰
        if month_filters:
            filtered_data = [record for record in filtered_data if record.get('month') in month_filters]
            self.log_message(f"âœ“ æœˆä»½ç­›é€‰å: {len(filtered_data)} æ¡è®°å½•")
        
        # åº”ç”¨æ˜ŸæœŸç­›é€‰
        if weekday_filters:
            filtered_data = [record for record in filtered_data if record.get('weekday') in weekday_filters]
            self.log_message(f"âœ“ æ˜ŸæœŸç­›é€‰å: {len(filtered_data)} æ¡è®°å½•")
        
        # åº”ç”¨ç±»åˆ«ç­›é€‰
        if category_filters:
            filtered_data = [record for record in filtered_data if record.get('category_code') in category_filters]
            self.log_message(f"âœ“ ç±»åˆ«ç­›é€‰å: {len(filtered_data)} æ¡è®°å½•")
        
        # åº”ç”¨æ”¯ä»˜æ–¹å¼ç­›é€‰
        if payment_filters:
            filtered_data = [record for record in filtered_data if record.get('payment_method') in payment_filters]
            self.log_message(f"âœ“ æ”¯ä»˜æ–¹å¼ç­›é€‰å: {len(filtered_data)} æ¡è®°å½•")
        
        return filtered_data
    
    def clear_memory_cache(self):
        """æ¸…é™¤å†…å­˜ç¼“å­˜æ•°æ®"""
        self.cached_sales_data = []
        self.cache_date_range = None
        self.cache_database = None
        self.log_message("ğŸ—‘ï¸ å†…å­˜ç¼“å­˜å·²æ¸…é™¤ï¼Œä¸‹æ¬¡æŸ¥è¯¢å°†é‡æ–°è·å–æ•°æ®")
    
    def on_sales_payment_toggle(self):
        """å¤„ç†é”€å”®æ•°æ®æ”¯ä»˜æ–¹å¼åˆ‡æ¢"""
        try:
            include_payment = self.include_payment_sales.get()
            self.log_message(f"ğŸ”„ é”€å”®æ•°æ®æ”¯ä»˜æ–¹å¼åˆ‡æ¢: {'åŒ…å«' if include_payment else 'ä¸åŒ…å«'}")
            
            # å¦‚æœæœ‰ç°æœ‰æ•°æ®ï¼Œé‡æ–°è·å–
            if hasattr(self, 'sales_data') and self.sales_data:
                self.log_message("ğŸ“Š é‡æ–°è·å–é”€å”®æ•°æ®...")
                self.display_sales_data()
            else:
                self.log_message("â„¹ æš‚æ— é”€å”®æ•°æ®ï¼Œè¯·å…ˆè·å–æ•°æ®")
                
        except Exception as e:
            self.log_message(f"âŒ é”€å”®æ•°æ®æ”¯ä»˜æ–¹å¼åˆ‡æ¢å¤±è´¥: {e}")
    
    def refresh_sales_data(self):
        """åˆ·æ–°é”€å”®æ•°æ®"""
        try:
            self.log_message("ğŸ”„ åˆ·æ–°é”€å”®æ•°æ®...")
            self.display_sales_data()
        except Exception as e:
            self.log_message(f"âŒ åˆ·æ–°é”€å”®æ•°æ®å¤±è´¥: {e}")
    
    def display_sales_data(self):
        """æ˜¾ç¤ºé”€å”®æ•°æ®"""
        # æ¸…ç©ºTreeView
        for item in self.sales_tree.get_children():
            self.sales_tree.delete(item)
        
        # è®¾ç½®åˆ— - æ ¹æ®æ”¯ä»˜æ–¹å¼é€‰æ‹©åŠ¨æ€è°ƒæ•´
        include_payment = self.include_payment_sales.get()
        if include_payment:
            columns = ['é—¨å¸‚\nOutlet', 'å•æ®å·\nReceipt No', 'äº§å“åç§°\nProduct Name', 'æ”¯ä»˜æ–¹å¼\nPayment Method', 'ç±»åˆ«\nCategory', 'æ•°é‡\nQuantity', 'æŠ˜æ‰£é‡‘é¢\nDiscount Amount', 'æŠ˜æ‰£åç§°\nDiscount Name', 'ä¿ƒé”€æŠ˜æ‰£\nPromo Discount', 'é‡‘é¢\nAmount', 'æœåŠ¡è´¹\nService Fee', 'ç¨è´¹\nTax', 'æ—¥æœŸ\nDate', 'æ€»é‡‘é¢\nTotal Amount']
        else:
            columns = ['é—¨å¸‚\nOutlet', 'å•æ®å·\nReceipt No', 'äº§å“åç§°\nProduct Name', 'ç±»åˆ«\nCategory', 'æ•°é‡\nQuantity', 'æŠ˜æ‰£é‡‘é¢\nDiscount Amount', 'æŠ˜æ‰£åç§°\nDiscount Name', 'ä¿ƒé”€æŠ˜æ‰£\nPromo Discount', 'é‡‘é¢\nAmount', 'æœåŠ¡è´¹\nService Fee', 'ç¨è´¹\nTax', 'æ—¥æœŸ\nDate', 'æ€»é‡‘é¢\nTotal Amount']
        
        self.sales_tree["columns"] = columns
        
        for col in columns:
            self.sales_tree.heading(col, text=col, command=lambda c=col: self.sort_treeview(self.sales_tree, c))
            self.sales_tree.column(col, width=100, anchor="center")
        
        # ç¢ºä¿è¡¨é ­å¯è¦‹ - å¼·åˆ¶é¡¯ç¤ºè¡¨é ­
        self.sales_tree.configure(show='headings')
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)  # è¿›ä¸€æ­¥ç¼©å°æ•°æ®è¡Œé«˜åº¦åˆ°25åƒç´ 
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))  # ç¼©å°å­—ä½“ä½†å¢åŠ æ ‡é¢˜é«˜åº¦åˆ°80åƒç´ 
        
        # å‡†å¤‡æ˜¾ç¤ºæ•°æ®
        display_data = self.sales_data
        if self.show_daily_average.get() and self.sales_data:
            display_data = self.calculate_daily_average(self.sales_data)
        
        # æ’å…¥æ•°æ®
        for data in display_data:
            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get():
                if include_payment:
                    # åŒ…å«æ”¯ä»˜æ–¹å¼çš„æ•°æ®è¡Œ
                    self.sales_tree.insert("", "end", values=(
                    data['store_name'],
                    data['sales_no'],
                    data['item_name'],
                    data['payment_methods'],
                    data['category_code'],
                    f"{data['qty']:.2f}",
                    format_currency(data['disc_amt']),
                    data['disc_name'],
                    format_currency(data['pro_disc_amt']),
                    format_currency(data['sub_total']),
                    format_currency(data['svc_amt']),
                    format_currency(data['tax_amt']),
                    str(data['c_date']),
                    format_currency(data['total_amt'])
                ))
                else:
                    # ä¸åŒ…å«æ”¯ä»˜æ–¹å¼çš„æ•°æ®è¡Œ
                    self.sales_tree.insert("", "end", values=(
                        data['store_name'],
                        data['sales_no'],
                        data['item_name'],
                        data['category_code'],
                        f"{data['qty']:.2f}",
                        format_currency(data['disc_amt']),
                        data['disc_name'],
                        format_currency(data['pro_disc_amt']),
                        format_currency(data['sub_total']),
                        format_currency(data['svc_amt']),
                        format_currency(data['tax_amt']),
                        str(data['c_date']),
                        format_currency(data['total_amt'])
                    ))
        
        # æ·»åŠ æ€»è®¡è¡Œ
        if self.sales_data:
            # è®¡ç®—å„åº—æ€»è®¡
            store_totals = {}
            month_totals = {}
            grand_total_qty = 0.0
            grand_total_disc_amt = 0.0
            grand_total_pro_disc_amt = 0.0
            grand_total_sub_total = 0.0
            grand_total_svc_amt = 0.0
            grand_total_tax_amt = 0.0
            grand_total_amount = 0.0
            
            for data in self.sales_data:
                store = data['store_name']
                month = data['month']
                qty = data['qty']
                disc_amt = data['disc_amt']
                pro_disc_amt = data['pro_disc_amt']
                sub_total = data['sub_total']
                svc_amt = data['svc_amt']
                tax_amt = data['tax_amt']
                total_amt = data['total_amt']
                
                # å„åº—æ€»è®¡
                if store not in store_totals:
                    store_totals[store] = {
                        'qty': 0.0, 'disc_amt': 0.0, 'pro_disc_amt': 0.0, 
                        'sub_total': 0.0, 'svc_amt': 0.0, 'tax_amt': 0.0, 'total_amt': 0.0
                    }
                store_totals[store]['qty'] += qty
                store_totals[store]['disc_amt'] += disc_amt
                store_totals[store]['pro_disc_amt'] += pro_disc_amt
                store_totals[store]['sub_total'] += sub_total
                store_totals[store]['svc_amt'] += svc_amt
                store_totals[store]['tax_amt'] += tax_amt
                store_totals[store]['total_amt'] += total_amt
                
                # æœˆä»½æ€»è®¡
                if month not in month_totals:
                    month_totals[month] = {
                        'qty': 0.0, 'disc_amt': 0.0, 'pro_disc_amt': 0.0, 
                        'sub_total': 0.0, 'svc_amt': 0.0, 'tax_amt': 0.0, 'total_amt': 0.0
                    }
                month_totals[month]['qty'] += qty
                month_totals[month]['disc_amt'] += disc_amt
                month_totals[month]['pro_disc_amt'] += pro_disc_amt
                month_totals[month]['sub_total'] += sub_total
                month_totals[month]['svc_amt'] += svc_amt
                month_totals[month]['tax_amt'] += tax_amt
                month_totals[month]['total_amt'] += total_amt
                
                # å…¨æ€»è®¡
                grand_total_qty += qty
                grand_total_disc_amt += disc_amt
                grand_total_pro_disc_amt += pro_disc_amt
                grand_total_sub_total += sub_total
                grand_total_svc_amt += svc_amt
                grand_total_tax_amt += tax_amt
                grand_total_amount += total_amt
            
            # æ·»åŠ å„åº—æ€»è®¡
            for store, totals in store_totals.items():
                self.sales_tree.insert("", "end", values=(
                    f'ã€{store} æ€»è®¡ã€‘',
                    '',
                    '',
                    '',
                    '',
                    f"{totals['qty']:.2f}",
                    format_currency(totals['disc_amt']),
                    '',
                    format_currency(totals['pro_disc_amt']),
                    format_currency(totals['sub_total']),
                    format_currency(totals['svc_amt']),
                    format_currency(totals['tax_amt']),
                    '',
                    format_currency(totals['total_amt'])
                ))
            
            # æ·»åŠ æœˆä»½æ€»è®¡
            for month, totals in month_totals.items():
                self.sales_tree.insert("", "end", values=(
                    f'ã€{month} æœˆä»½æ€»è®¡ã€‘',
                    '',
                    '',
                    '',
                    '',
                    f"{totals['qty']:.2f}",
                    format_currency(totals['disc_amt']),
                    '',
                    format_currency(totals['pro_disc_amt']),
                    format_currency(totals['sub_total']),
                    format_currency(totals['svc_amt']),
                    format_currency(totals['tax_amt']),
                    '',
                    format_currency(totals['total_amt'])
                ))
            
            # æ·»åŠ å…¨æ€»è®¡
            self.sales_tree.insert("", "end", values=(
                'ã€å…¨æ€»è®¡ã€‘',
                '',
                '',
                '',
                '',
                f"{grand_total_qty:.2f}",
                format_currency(grand_total_disc_amt),
                '',
                format_currency(grand_total_pro_disc_amt),
                format_currency(grand_total_sub_total),
                format_currency(grand_total_svc_amt),
                format_currency(grand_total_tax_amt),
                '',
                format_currency(grand_total_amount)
            ))
        
        # ç¢ºä¿è¡¨é ­å¯è¦‹ - æ»¾å‹•åˆ°é ‚éƒ¨
        self.sales_tree.update()
        self.sales_tree.yview_moveto(0)
        
        # åˆ‡æ¢åˆ°é”€å”®æ•°æ®æ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(0)  # é€‰æ‹©Salesæ ‡ç­¾é¡µ
            self.sales_notebook.select(0)  # é€‰æ‹©é”€å”®æ•°æ®å­æ ‡ç­¾é¡µ
    
    def get_payment_analysis(self):
        """è·å–æ”¯ä»˜æ–¹å¼åˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        self.log_message(f"æ­£åœ¨è¿æ¥åˆ° {db}...")
        
        if not self.db_manager.connect(db):
            self.log_message(f"âœ— æ— æ³•è¿æ¥åˆ° {db}")
            return
        
        self.log_message(f"âœ“ è¿æ¥æˆåŠŸ", include_db_info=True)
        
        # è·å–ç­›é€‰æ¡ä»¶
        # æ ¹æ®æ—¥æœŸç­›é€‰å¼€å…³å†³å®šæ˜¯å¦ä½¿ç”¨æ—¥æœŸç­›é€‰
        if self.use_date_filter.get():
            # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
        
        # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
        if date_from and date_to and date_from == date_to:
            self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
        elif date_to:
            self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        print(f"GUIè·å–çš„æ˜ŸæœŸç­›é€‰: {weekday_filters}")
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–æ”¯ä»˜æ–¹å¼åˆ†æ...")
        self.log_message(f"ç­›é€‰æ¡ä»¶ - æœˆä»½: {month_filters}, æ”¯ä»˜æ–¹å¼: {payment_filters}, é—¨å¸‚: {outlet_filters}")
        self.payment_data = self.db_manager.get_payment_summary(
            date_from, date_to, outlet_filters, month_filters, category_filters, payment_filters
        )
        
        if self.payment_data:
            self.log_message(f"âœ“ è·å–æ”¯ä»˜åˆ†ææˆåŠŸï¼Œå…± {len(self.payment_data)} æ¡è®°å½•")
            self.display_payment_analysis()
        else:
            self.log_message("âœ— è·å–æ”¯ä»˜åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
        
        self.db_manager.disconnect()
    
    def get_payment_summary_filtered_by_amount(self, min_amount=None, max_amount=None):
        """è·å–æŒ‰å•æ®é‡‘é¢ç­›é€‰çš„æ”¯ä»˜æ–¹å¼åˆ†ææ•°æ®"""
        if not self.db_manager.connection:
            print("DEBUG: åœ¨get_payment_summary_filtered_by_amountä¸­æ•°æ®åº“è¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥")
            # ä½¿ç”¨å½“å‰é€‰æ‹©çš„æ•°æ®åº“
            current_db = self.selected_db.get()
            print(f"DEBUG: å½“å‰é€‰æ‹©çš„æ•°æ®åº“: {current_db}")
            self.db_manager.connect(current_db)
        
        if not self.db_manager.connection:
            print("DEBUG: æ— æ³•é‡æ–°è¿æ¥æ•°æ®åº“")
            return []
        
        try:
            cursor = self.db_manager.connection.cursor()
            
            # è·å–ä¸šç»©è®¡ç®—SQL
            performance_sql = self.db_manager.get_performance_calculation_sql()
            
            # å…ˆæµ‹è¯•ä¸€ä¸‹æ•°æ®åº“ä¸­å®é™…çš„å•æ®é‡‘é¢åˆ†å¸ƒ
            test_query = f"""
                SELECT TOP 10 
                    s.sales_no,
                    s.store_name,
                    SUM({performance_sql}) as receipt_amount
                FROM {TABLE_SALES} s WITH (NOLOCK)
                LEFT JOIN item_master im WITH (NOLOCK) ON s.item_name = im.item_name
                WHERE s.item_name NOT LIKE '%WASTAGE%'
                    AND s.item_name NOT LIKE '%Waste%'
                    AND s.item_name NOT LIKE '%waste%'
                    AND s.item_name NOT LIKE '%WASTE%'
                GROUP BY s.sales_no, s.store_name
                ORDER BY receipt_amount DESC
            """
            
            print(f"DEBUG: æµ‹è¯•æŸ¥è¯¢ - æŸ¥çœ‹å®é™…å•æ®é‡‘é¢:")
            print(f"DEBUG: æµ‹è¯•SQL: {test_query}")
            cursor.execute(test_query)
            test_results = cursor.fetchall()
            print(f"DEBUG: æµ‹è¯•ç»“æœæ•°é‡: {len(test_results)}")
            for i, row in enumerate(test_results):
                print(f"DEBUG: å•æ® {i+1}: {row[0]} - {row[1]} - é‡‘é¢: {row[2]}")
            
            # æ„å»ºé‡‘é¢ç­›é€‰æ¡ä»¶
            amount_conditions = []
            if min_amount is not None:
                amount_conditions.append(f"SUM({performance_sql}) >= {min_amount}")
            if max_amount is not None:
                amount_conditions.append(f"SUM({performance_sql}) <= {max_amount}")
            
            amount_filter = ""
            if amount_conditions:
                amount_filter = " AND " + " AND ".join(amount_conditions)
            
            # è·å–å½“å‰ç­›é€‰çš„æ—¥æœŸèŒƒå›´
            date_from = self.date_from.get_date().strftime('%Y-%m-%d')
            date_to = self.date_to.get_date().strftime('%Y-%m-%d')
            
            # æ„å»ºæ—¥æœŸç­›é€‰æ¡ä»¶
            date_conditions = []
            if date_from:
                date_conditions.append(f"s.c_date >= '{date_from} 00:00:00'")
            if date_to:
                date_conditions.append(f"s.c_date <= '{date_to} 23:59:59'")
            
            date_filter = ""
            if date_conditions:
                date_filter = " AND " + " AND ".join(date_conditions)
            
            # æŸ¥è¯¢ç¬¦åˆå•æ®é‡‘é¢æ¡ä»¶çš„æ”¯ä»˜æ–¹å¼æ•°æ® - ç®€åŒ–ç‰ˆæœ¬
            query = f"""
                WITH ReceiptAmounts AS (
                    SELECT 
                        s.sales_no,
                        s.store_name,
                        FORMAT(s.c_date, 'yyyy-MM') as month_key,
                        SUM({performance_sql}) as receipt_amount
                    FROM {TABLE_SALES} s WITH (NOLOCK)
                    LEFT JOIN item_master im WITH (NOLOCK) ON s.item_name = im.item_name
                    WHERE s.item_name NOT LIKE '%WASTAGE%'
                        AND s.item_name NOT LIKE '%Waste%'
                        AND s.item_name NOT LIKE '%waste%'
                        AND s.item_name NOT LIKE '%WASTE%'
                        {date_filter}
                    GROUP BY s.sales_no, s.store_name, FORMAT(s.c_date, 'yyyy-MM')
                    HAVING 1=1 {amount_filter}
                )
                SELECT 
                    ra.store_name as é—¨å¸‚,
                    ra.month_key as æœˆä»½,
                    p.payment_name as æ”¯ä»˜æ–¹å¼,
                    SUM(ra.receipt_amount) as æ€»é‡‘é¢,
                    COUNT(DISTINCT CONCAT(ra.store_name, '-', ra.sales_no)) as ä½¿ç”¨æ¬¡æ•°,
                    AVG(ra.receipt_amount) as å¹³å‡é‡‘é¢
                FROM ReceiptAmounts ra
                INNER JOIN {TABLE_PAYMENT} p WITH (NOLOCK) ON ra.sales_no = p.sales_no AND ra.store_name = p.store_name
                GROUP BY ra.store_name, ra.month_key, p.payment_name
                ORDER BY ra.store_name, ra.month_key, p.payment_name
                OPTION (RECOMPILE, MAXDOP 4)
            """
            
            # æ·»åŠ è°ƒè¯•ä¿¡æ¯
            print(f"DEBUG: æ”¯ä»˜ç­›é€‰SQLæŸ¥è¯¢:")
            print(f"DEBUG: æœ€å°é‡‘é¢: {min_amount}, æœ€å¤§é‡‘é¢: {max_amount}")
            print(f"DEBUG: é‡‘é¢ç­›é€‰æ¡ä»¶: {amount_filter}")
            print(f"DEBUG: SQLæŸ¥è¯¢: {query}")
            
            cursor.execute(query)
            results = cursor.fetchall()
            
            print(f"DEBUG: æŸ¥è¯¢ç»“æœæ•°é‡: {len(results)}")
            if len(results) > 0:
                print(f"DEBUG: ç¬¬ä¸€æ¡ç»“æœ: {results[0]}")
            
            # è½¬æ¢æ•°æ®æ ¼å¼
            data = []
            store_totals = {}
            grand_totals = {}
            
            for row in results:
                try:
                    store_name = str(row[0]) if row[0] else ''
                    month = str(row[1]) if row[1] else ''
                    payment_method = str(row[2]) if row[2] else ''
                    total_amount = float(row[3]) if row[3] else 0.0
                    usage_count = int(row[4]) if row[4] else 0
                    avg_amount = float(row[5]) if row[5] else 0.0
                    
                    # è®¡ç®—å æ¯”
                    store_month_key = f"{store_name}_{month}"
                    if store_month_key not in store_totals:
                        store_totals[store_month_key] = {'total_amount': 0.0, 'total_count': 0}
                    
                    store_totals[store_month_key]['total_amount'] += total_amount
                    store_totals[store_month_key]['total_count'] += usage_count
                    
                    # ç´¯è®¡å…¨æ€»è®¡
                    if month not in grand_totals:
                        grand_totals[month] = {'total_amount': 0.0, 'total_count': 0}
                    grand_totals[month]['total_amount'] += total_amount
                    grand_totals[month]['total_count'] += usage_count
                    
                    data.append({
                        'é—¨å¸‚': store_name,
                        'æœˆä»½': month,
                        'æ”¯ä»˜æ–¹å¼': payment_method,
                        'æ€»é‡‘é¢': total_amount,
                        'ä½¿ç”¨æ¬¡æ•°': usage_count,
                        'å¹³å‡é‡‘é¢': avg_amount,
                        'è¯¥åº—æ¬¡æ•°å æ¯”(%)': 0.0,  # ç¨åè®¡ç®—
                        'è¯¥åº—é‡‘é¢å æ¯”(%)': 0.0   # ç¨åè®¡ç®—
                    })
                    
                except Exception as e:
                    continue
            
            # è®¡ç®—å æ¯”å¹¶æ·»åŠ é—¨åº—æ€»è®¡å’Œå…¨æ€»è®¡
            final_data = []
            
            # æŒ‰é—¨åº—å’Œæœˆä»½åˆ†ç»„å¤„ç†æ•°æ®
            from collections import defaultdict
            grouped_data = defaultdict(list)
            
            for row in data:
                store_month_key = f"{row['é—¨å¸‚']}_{row['æœˆä»½']}"
                store_total = store_totals.get(store_month_key, {'total_amount': 0.0, 'total_count': 0})
                
                row['è¯¥åº—æ¬¡æ•°å æ¯”(%)'] = (row['ä½¿ç”¨æ¬¡æ•°'] / store_total['total_count'] * 100) if store_total['total_count'] > 0 else 0.0
                row['è¯¥åº—é‡‘é¢å æ¯”(%)'] = (row['æ€»é‡‘é¢'] / store_total['total_amount'] * 100) if store_total['total_amount'] > 0 else 0.0
                
                grouped_data[store_month_key].append(row)
            
            # æŒ‰é—¨åº—å’Œæœˆä»½æ’åºï¼Œå¹¶åœ¨æ¯ä¸ªé—¨å¸‚ç»„åæ·»åŠ æ€»è®¡
            for store_month_key in sorted(grouped_data.keys()):
                store_name, month = store_month_key.split('_', 1)
                store_data = grouped_data[store_month_key]
                
                # æ·»åŠ è¯¥é—¨å¸‚çš„è¯¦ç»†æ•°æ®
                final_data.extend(store_data)
                
                # æ·»åŠ è¯¥é—¨å¸‚çš„æ€»è®¡
                totals = store_totals.get(store_month_key, {'total_amount': 0.0, 'total_count': 0})
                final_data.append({
                    'é—¨å¸‚': f'ã€{store_name} æ€»è®¡ã€‘',
                    'æœˆä»½': month,
                    'æ”¯ä»˜æ–¹å¼': 'ALL',
                    'æ€»é‡‘é¢': totals['total_amount'],
                    'ä½¿ç”¨æ¬¡æ•°': totals['total_count'],
                    'å¹³å‡é‡‘é¢': totals['total_amount'] / totals['total_count'] if totals['total_count'] > 0 else 0.0,
                    'è¯¥åº—æ¬¡æ•°å æ¯”(%)': 100.0,
                    'è¯¥åº—é‡‘é¢å æ¯”(%)': 100.0
                })
            
            # æœ€åæ·»åŠ å…¨æ€»è®¡å’Œä»˜æ¬¾æ–¹å¼æ±‡æ€»
            for month in sorted(grand_totals.keys()):
                totals = grand_totals[month]
                final_data.append({
                    'é—¨å¸‚': 'ã€å…¨æ€»è®¡ã€‘',
                    'æœˆä»½': month,
                    'æ”¯ä»˜æ–¹å¼': 'ALL',
                    'æ€»é‡‘é¢': totals['total_amount'],
                    'ä½¿ç”¨æ¬¡æ•°': totals['total_count'],
                    'å¹³å‡é‡‘é¢': totals['total_amount'] / totals['total_count'] if totals['total_count'] > 0 else 0.0,
                    'è¯¥åº—æ¬¡æ•°å æ¯”(%)': 100.0,
                    'è¯¥åº—é‡‘é¢å æ¯”(%)': 100.0
                })
            
            # æ·»åŠ ä»˜æ¬¾æ–¹å¼æ±‡æ€» - æŒ‰ä»˜æ¬¾æ–¹å¼åˆ†ç»„æ±‡æ€»æ‰€æœ‰é—¨å¸‚
            payment_method_totals = {}
            for row in data:
                payment_method = row['æ”¯ä»˜æ–¹å¼']
                if payment_method not in payment_method_totals:
                    payment_method_totals[payment_method] = {
                        'æ€»é‡‘é¢': 0.0,
                        'ä½¿ç”¨æ¬¡æ•°': 0,
                        'é—¨å¸‚æ•°': set()
                    }
                
                payment_method_totals[payment_method]['æ€»é‡‘é¢'] += row['æ€»é‡‘é¢']
                payment_method_totals[payment_method]['ä½¿ç”¨æ¬¡æ•°'] += row['ä½¿ç”¨æ¬¡æ•°']
                payment_method_totals[payment_method]['é—¨å¸‚æ•°'].add(row['é—¨å¸‚'])
            
            # æ·»åŠ ä»˜æ¬¾æ–¹å¼æ±‡æ€»è¡Œ
            for payment_method in sorted(payment_method_totals.keys()):
                totals = payment_method_totals[payment_method]
                final_data.append({
                    'é—¨å¸‚': 'ã€ä»˜æ¬¾æ–¹å¼æ±‡æ€»ã€‘',
                    'æœˆä»½': '',
                    'æ”¯ä»˜æ–¹å¼': payment_method,
                    'æ€»é‡‘é¢': totals['æ€»é‡‘é¢'],
                    'ä½¿ç”¨æ¬¡æ•°': totals['ä½¿ç”¨æ¬¡æ•°'],
                    'å¹³å‡é‡‘é¢': totals['æ€»é‡‘é¢'] / totals['ä½¿ç”¨æ¬¡æ•°'] if totals['ä½¿ç”¨æ¬¡æ•°'] > 0 else 0.0,
                    'è¯¥åº—æ¬¡æ•°å æ¯”(%)': (totals['ä½¿ç”¨æ¬¡æ•°'] / sum(pm['ä½¿ç”¨æ¬¡æ•°'] for pm in payment_method_totals.values()) * 100) if sum(pm['ä½¿ç”¨æ¬¡æ•°'] for pm in payment_method_totals.values()) > 0 else 0.0,
                    'è¯¥åº—é‡‘é¢å æ¯”(%)': (totals['æ€»é‡‘é¢'] / sum(pm['æ€»é‡‘é¢'] for pm in payment_method_totals.values()) * 100) if sum(pm['æ€»é‡‘é¢'] for pm in payment_method_totals.values()) > 0 else 0.0
                })
            
            cursor.close()
            return final_data
            
        except Exception as e:
            return []
    
    def apply_payment_amount_filter(self):
        """åº”ç”¨æ”¯ä»˜æ–¹å¼åˆ†æçš„é‡‘é¢åŒºé—´ç­›é€‰ - ç­›é€‰å•æ®é‡‘é¢è€Œä¸æ˜¯æ€»é‡‘é¢"""
        print(f"DEBUG: å¼€å§‹åº”ç”¨æ”¯ä»˜ç­›é€‰")
        print(f"DEBUG: æ˜¯å¦æœ‰payment_dataå±æ€§: {hasattr(self, 'payment_data')}")
        if hasattr(self, 'payment_data'):
            print(f"DEBUG: payment_dataæ˜¯å¦ä¸ºç©º: {not self.payment_data}")
        
        if not hasattr(self, 'payment_data') or not self.payment_data:
            self.log_message("âœ— è¯·å…ˆè·å–æ”¯ä»˜æ–¹å¼åˆ†ææ•°æ®")
            return
        
        # ç¡®ä¿æœ‰åŸå§‹æ•°æ®å¤‡ä»½
        if not hasattr(self, 'original_payment_data'):
            self.original_payment_data = self.payment_data.copy()
            self.log_message("âœ“ å·²å¤‡ä»½åŸå§‹æ”¯ä»˜åˆ†ææ•°æ®")
        
        try:
            min_amount = None
            max_amount = None
            
            # è§£ææœ€å°é‡‘é¢
            min_text = self.payment_min_amount.get().strip()
            if min_text:
                min_amount = float(min_text)
            
            # è§£ææœ€å¤§é‡‘é¢
            max_text = self.payment_max_amount.get().strip()
            if max_text:
                max_amount = float(max_text)
            
            if min_amount is None and max_amount is None:
                # æ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œæ˜¾ç¤ºåŸå§‹æ•°æ®
                self.display_payment_analysis_data(self.payment_data)
                self.log_message("âœ“ å·²æ¸…é™¤é‡‘é¢åŒºé—´ç­›é€‰")
                return
            
            # å…ˆæµ‹è¯•ä¸€ä¸‹ç®€å•çš„é‡‘é¢æŸ¥è¯¢
            print(f"DEBUG: å¼€å§‹æµ‹è¯•ç®€å•é‡‘é¢æŸ¥è¯¢ - æœ€å°: {min_amount}, æœ€å¤§: {max_amount}")
            
            # è·å–å½“å‰ç­›é€‰çš„æ—¥æœŸèŒƒå›´
            date_from = self.date_from.get_date().strftime('%Y-%m-%d')
            date_to = self.date_to.get_date().strftime('%Y-%m-%d')
            print(f"DEBUG: å½“å‰æ—¥æœŸèŒƒå›´: {date_from} åˆ° {date_to}")
            
            # æ„å»ºæ—¥æœŸç­›é€‰æ¡ä»¶
            date_conditions = []
            if date_from:
                date_conditions.append(f"s.c_date >= '{date_from} 00:00:00'")
            if date_to:
                date_conditions.append(f"s.c_date <= '{date_to} 23:59:59'")
            
            date_filter = ""
            if date_conditions:
                date_filter = " AND " + " AND ".join(date_conditions)
            
            test_simple_query = f"""
                SELECT TOP 5 
                    s.sales_no,
                    s.store_name,
                    SUM(CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CAST(ISNULL(s.tax_amt, 0) as FLOAT)) as receipt_amount
                FROM pos_sales_dtls s WITH (NOLOCK)
                WHERE s.item_name NOT LIKE '%WASTAGE%'
                    {date_filter}
                GROUP BY s.sales_no, s.store_name
                HAVING SUM(CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CAST(ISNULL(s.tax_amt, 0) as FLOAT)) BETWEEN {min_amount} AND {max_amount}
                ORDER BY receipt_amount DESC
            """
            print(f"DEBUG: ç®€å•æµ‹è¯•SQL: {test_simple_query}")
            
            # æ£€æŸ¥æ•°æ®åº“è¿æ¥
            if not self.db_manager.connection:
                print("DEBUG: æ•°æ®åº“è¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥")
                # ä½¿ç”¨å½“å‰é€‰æ‹©çš„æ•°æ®åº“
                current_db = self.selected_db.get()
                print(f"DEBUG: å½“å‰é€‰æ‹©çš„æ•°æ®åº“: {current_db}")
                self.db_manager.connect(current_db)
            
            if not self.db_manager.connection:
                print("DEBUG: æ— æ³•é‡æ–°è¿æ¥æ•°æ®åº“")
                self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
                return
            
            cursor = self.db_manager.connection.cursor()
            cursor.execute(test_simple_query)
            simple_results = cursor.fetchall()
            print(f"DEBUG: ç®€å•æµ‹è¯•ç»“æœæ•°é‡: {len(simple_results)}")
            for i, row in enumerate(simple_results):
                print(f"DEBUG: ç®€å•æµ‹è¯•å•æ® {i+1}: {row[0]} - {row[1]} - é‡‘é¢: {row[2]}")
            cursor.close()
            
            # é‡æ–°æŸ¥è¯¢ç¬¦åˆå•æ®é‡‘é¢æ¡ä»¶çš„æ•°æ®
            filtered_data = self.get_payment_summary_filtered_by_amount(min_amount, max_amount)
            
            # æ˜¾ç¤ºç­›é€‰ç»“æœ
            self.display_payment_analysis_data(filtered_data)
            
            self.log_message(f"âœ“ åº”ç”¨å•æ®é‡‘é¢åŒºé—´ç­›é€‰æˆåŠŸï¼Œæ˜¾ç¤º {len(filtered_data)} æ¡è®°å½•")
            
        except ValueError as e:
            self.log_message(f"âœ— é‡‘é¢è¾“å…¥æ ¼å¼é”™è¯¯: {e}")
        except Exception as e:
            self.log_message(f"âœ— åº”ç”¨ç­›é€‰å¤±è´¥: {e}")
    
    def clear_payment_amount_filter(self):
        """æ¸…é™¤æ”¯ä»˜æ–¹å¼åˆ†æçš„é‡‘é¢åŒºé—´ç­›é€‰"""
        self.payment_min_amount.delete(0, tk.END)
        self.payment_max_amount.delete(0, tk.END)
        
        # æ¢å¤åŸå§‹æ•°æ®
        if hasattr(self, 'original_payment_data') and self.original_payment_data:
            self.payment_data = self.original_payment_data.copy()
            self.display_payment_analysis_data(self.payment_data)
            self.log_message("âœ“ å·²æ¸…é™¤é‡‘é¢åŒºé—´ç­›é€‰ï¼Œæ¢å¤åŸå§‹æ•°æ®")
        elif hasattr(self, 'payment_data') and self.payment_data:
            self.display_payment_analysis_data(self.payment_data)
            self.log_message("âœ“ å·²æ¸…é™¤é‡‘é¢åŒºé—´ç­›é€‰")
    
    def display_payment_analysis(self):
        """æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼åˆ†æ"""
        self.display_payment_analysis_data(self.payment_data)
    
    def display_payment_analysis_data(self, data):
        """æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼åˆ†ææ•°æ®"""
        # ä¿å­˜å½“å‰æ˜¾ç¤ºçš„æ•°æ®ï¼Œç”¨äºå¯¼å‡º
        self.filtered_payment_data = data.copy() if data else []
        
        # æ¸…ç©ºTreeView
        for item in self.payment_tree.get_children():
            self.payment_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ['é—¨å¸‚\nOutlet', 'æœˆä»½\nMonth', 'æ”¯ä»˜æ–¹å¼\nPayment Method', 'æ€»é‡‘é¢\nTotal Amount', 'å•æ®æ•°\nReceipt Count', 'å¹³å‡é‡‘é¢\nAverage Amount', 'è¯¥åº—æ¬¡æ•°å æ¯”(%)\nStore Count Ratio(%)', 'è¯¥åº—é‡‘é¢å æ¯”(%)\nStore Amount Ratio(%)']
        self.payment_tree["columns"] = columns
        
        for col in columns:
            self.payment_tree.heading(col, text=col, command=lambda c=col: self.sort_treeview(self.payment_tree, c))
            self.payment_tree.column(col, width=100, anchor="center")
        
        # ç¢ºä¿è¡¨é ­å¯è¦‹ - å¼·åˆ¶é¡¯ç¤ºè¡¨é ­
        self.payment_tree.configure(show='headings')
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)  # è¿›ä¸€æ­¥ç¼©å°æ•°æ®è¡Œé«˜åº¦åˆ°25åƒç´ 
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))  # ç¼©å°å­—ä½“ä½†å¢åŠ æ ‡é¢˜é«˜åº¦åˆ°80åƒç´ 
        
        # é…ç½®é¢œè‰²æ ‡ç­¾
        self.payment_tree.tag_configure("store_total", background="#E6F3FF", foreground="#000000")  # é—¨åº—æ€»è®¡ - æµ…è“è‰²
        self.payment_tree.tag_configure("grand_total", background="#FFE6E6", foreground="#000000")  # å…¨æ€»è®¡ - æµ…çº¢è‰²
        
        # å‡†å¤‡æ˜¾ç¤ºæ•°æ®
        display_data = data
        if self.show_daily_average.get() and data:
            display_data = self.calculate_daily_average(data)
        
        # æ’å…¥æ•°æ®
        for row_data in display_data:
            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get():
                # åˆ¤æ–­è¡Œç±»å‹å¹¶è®¾ç½®æ ‡ç­¾
                if row_data['é—¨å¸‚'].startswith('ã€') and 'æ€»è®¡ã€‘' in row_data['é—¨å¸‚'] and row_data['é—¨å¸‚'] != 'ã€å…¨æ€»è®¡ã€‘':
                    tag = "store_total"  # é—¨åº—æ€»è®¡
                elif row_data['é—¨å¸‚'] == 'ã€å…¨æ€»è®¡ã€‘':
                    tag = "grand_total"  # å…¨æ€»è®¡
                else:
                    tag = ""  # æ™®é€šæ•°æ®è¡Œ
                
                self.payment_tree.insert("", "end", values=(
                        row_data['é—¨å¸‚'],
                        row_data['æœˆä»½'],
                        row_data['æ”¯ä»˜æ–¹å¼'],
                        format_currency(row_data['æ€»é‡‘é¢']),
                        format_number(row_data['ä½¿ç”¨æ¬¡æ•°']),
                        format_currency(row_data['å¹³å‡é‡‘é¢']),
                        f"{row_data['è¯¥åº—æ¬¡æ•°å æ¯”(%)']:.2f}",
                        f"{row_data['è¯¥åº—é‡‘é¢å æ¯”(%)']:.2f}"
                    ), tags=(tag,))
            else:
                # åªæ˜¾ç¤ºæ€»è®¡è¡Œï¼ˆé—¨åº—æ€»è®¡å’Œå…¨æ€»è®¡ï¼‰
                    if (row_data['é—¨å¸‚'].startswith('ã€') and 'æ€»è®¡ã€‘' in row_data['é—¨å¸‚']) or row_data['é—¨å¸‚'] == 'ã€å…¨æ€»è®¡ã€‘':
                        if row_data['é—¨å¸‚'] == 'ã€å…¨æ€»è®¡ã€‘':
                            tag = "grand_total"  # å…¨æ€»è®¡
                        else:
                            tag = "store_total"  # é—¨åº—æ€»è®¡
                        
                        self.payment_tree.insert("", "end", values=(
                            row_data['é—¨å¸‚'],
                            row_data['æœˆä»½'],
                            row_data['æ”¯ä»˜æ–¹å¼'],
                            format_currency(row_data['æ€»é‡‘é¢']),
                            format_number(row_data['ä½¿ç”¨æ¬¡æ•°']),
                            format_currency(row_data['å¹³å‡é‡‘é¢']),
                            f"{row_data['è¯¥åº—æ¬¡æ•°å æ¯”(%)']:.2f}",
                            f"{row_data['è¯¥åº—é‡‘é¢å æ¯”(%)']:.2f}"
            ), tags=(tag,))
        
        # ç¢ºä¿è¡¨é ­å¯è¦‹ - æ»¾å‹•åˆ°é ‚éƒ¨
        self.payment_tree.update()
        self.payment_tree.yview_moveto(0)
        
        # åˆ‡æ¢åˆ°æ”¯ä»˜åˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(0)  # é€‰æ‹©Salesæ ‡ç­¾é¡µ
            self.sales_notebook.select(1)  # é€‰æ‹©æ”¯ä»˜æ–¹å¼åˆ†æå­æ ‡ç­¾é¡µ
    
    def get_discount_analysis(self):
        """è·å–æŠ˜æ‰£åˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        self.log_message(f"æ­£åœ¨è¿æ¥åˆ° {db}...")
        
        if not self.db_manager.connect(db):
            self.log_message(f"âœ— æ— æ³•è¿æ¥åˆ° {db}")
            return
        
        self.log_message(f"âœ“ è¿æ¥æˆåŠŸ", include_db_info=True)
        
        # è·å–ç­›é€‰æ¡ä»¶
        # æ ¹æ®æ—¥æœŸç­›é€‰å¼€å…³å†³å®šæ˜¯å¦ä½¿ç”¨æ—¥æœŸç­›é€‰
        if self.use_date_filter.get():
            # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
        
        # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
        if date_from and date_to and date_from == date_to:
            self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
        elif date_to:
            self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        print(f"GUIè·å–çš„æ˜ŸæœŸç­›é€‰: {weekday_filters}")
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–æŠ˜æ‰£åˆ†æ...")
        self.discount_data = self.db_manager.get_discount_analysis(
            date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        
        if self.discount_data:
            self.log_message(f"âœ“ è·å–æŠ˜æ‰£åˆ†ææˆåŠŸï¼Œå…± {len(self.discount_data)} æ¡è®°å½•")
            self.display_discount_analysis()
        else:
            self.log_message("âœ— è·å–æŠ˜æ‰£åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
        
        self.db_manager.disconnect()
    
    def display_discount_analysis(self):
        """æ˜¾ç¤ºæŠ˜æ‰£åˆ†æ"""
        # æ¸…ç©ºTreeView
        for item in self.discount_tree.get_children():
            self.discount_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ['é—¨å¸‚\nOutlet', 'æœˆä»½\nMonth', 'æŠ˜æ‰£åç§°\nDiscount Name', 'æŠ˜æ‰£é‡‘é¢\nDiscount Amount', 'æŠ˜æ‰£å æ¯”(%)\nDiscount Ratio(%)', 'æŠ˜æ‰£æ¬¡æ•°\nDiscount Count', 'æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)\nDiscount Count Ratio(%)', 'å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸\nTotal Discount Count All Stores']
        self.discount_tree["columns"] = columns
        
        for col in columns:
            self.discount_tree.heading(col, text=col, command=lambda c=col: self.sort_treeview(self.discount_tree, c))
            self.discount_tree.column(col, width=100, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)  # è¿›ä¸€æ­¥ç¼©å°æ•°æ®è¡Œé«˜åº¦åˆ°25åƒç´ 
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))  # ç¼©å°å­—ä½“ä½†å¢åŠ æ ‡é¢˜é«˜åº¦åˆ°80åƒç´ 
        
        # å‡†å¤‡æ˜¾ç¤ºæ•°æ®
        display_data = self.discount_data
        if self.show_daily_average.get() and self.discount_data:
            display_data = self.calculate_daily_average(self.discount_data)
        
        # æ’å…¥æ•°æ®
        for data in display_data:
            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get():
                self.discount_tree.insert("", "end", values=(
                    data['é—¨å¸‚'],
                    data['æœˆä»½'],
                    data['æŠ˜æ‰£åç§°'],
                    format_currency(data['æŠ˜æ‰£é‡‘é¢']),
                    f"{data['æŠ˜æ‰£å æ¯”(%)']:.2f}",
                    format_number(data['æŠ˜æ‰£æ¬¡æ•°']),
                    f"{data['æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)']:.2f}",
                    format_number(data.get('å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸', 0))
                ))
            else:
                # åªæ˜¾ç¤ºæ€»è®¡è¡Œï¼ˆé—¨åº—æ€»è®¡å’Œå…¨æ€»è®¡ï¼‰
                if (data['é—¨å¸‚'].startswith('ã€') and 'æ€»è®¡ã€‘' in data['é—¨å¸‚']) or data['é—¨å¸‚'] == 'ã€å…¨æ€»è®¡ã€‘':
                    self.discount_tree.insert("", "end", values=(
                        data['é—¨å¸‚'],
                        data['æœˆä»½'],
                        data['æŠ˜æ‰£åç§°'],
                        format_currency(data['æŠ˜æ‰£é‡‘é¢']),
                        f"{data['æŠ˜æ‰£å æ¯”(%)']:.2f}",
                        format_number(data['æŠ˜æ‰£æ¬¡æ•°']),
                        f"{data['æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)']:.2f}",
                        format_number(data.get('å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸', 0))
                    ))
        
        # åˆ‡æ¢åˆ°æŠ˜æ‰£åˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(0)  # é€‰æ‹©Salesæ ‡ç­¾é¡µ
            self.sales_notebook.select(2)  # é€‰æ‹©æŠ˜æ‰£åˆ†æå­æ ‡ç­¾é¡µ
    
    def get_monthly_summary(self):
        """è·å–æœˆåº¦æ±‡æ€»"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        self.log_message(f"æ­£åœ¨è¿æ¥åˆ° {db}...")
        
        if not self.db_manager.connect(db):
            self.log_message(f"âœ— æ— æ³•è¿æ¥åˆ° {db}")
            return
        
        self.log_message(f"âœ“ è¿æ¥æˆåŠŸ", include_db_info=True)
        
        # è·å–ç­›é€‰æ¡ä»¶
        # æ ¹æ®æ—¥æœŸç­›é€‰å¼€å…³å†³å®šæ˜¯å¦ä½¿ç”¨æ—¥æœŸç­›é€‰
        if self.use_date_filter.get():
            # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
        
        # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
        if date_from and date_to and date_from == date_to:
            self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
        elif date_to:
            self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
        outlet_filters = self.outlet_combo.get_selected()
        product_filters = self.product_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–æœˆåº¦æ±‡æ€»...")
        # å…ˆç”¨æœ¬åœ°
        local_monthly = self.db_manager.get_monthly_summary_from_local(
            date_from=date_from, date_to=date_to, outlet_filters=outlet_filters
        )
        if local_monthly:
            self.log_message("ğŸ“¦ ä½¿ç”¨æœ¬åœ°SQLiteæœˆåº¦åŒ¯ç¸½æ•¸æ“š")
            self.monthly_data = local_monthly
        else:
            self.log_message("â„¹ æœ¬åœ°ç„¡æœˆåº¦åŒ¯ç¸½æ•¸æ“šï¼Œå›é€€åˆ°SQL Server")
            self.monthly_data = self.db_manager.get_monthly_summary_optimized(
                date_from, date_to, outlet_filters, product_filters, month_filters, category_filters, payment_filters
            )
        self.monthly_store_count = self.db_manager.get_unique_store_count(
            date_from=date_from,
            date_to=date_to,
            outlet_filters=outlet_filters,
            month_filters=month_filters,
            weekday_filters=weekday_filters,
            category_filters=category_filters,
            product_filters=product_filters,
            payment_filters=payment_filters
        ) or 1
        
        if self.monthly_data:
            self.log_message(f"âœ“ è·å–æœˆåº¦æ±‡æ€»æˆåŠŸï¼Œå…± {len(self.monthly_data)} æ¡è®°å½•")
            self.display_monthly_summary()
            
            # åˆ‡æ¢åˆ°æœˆåº¦æ±‡æ€»æ ‡ç­¾é¡µ
            if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
                self.notebook.select(0)  # é€‰æ‹©Salesæ ‡ç­¾é¡µ
                self.sales_notebook.select(3)  # é€‰æ‹©æœˆåº¦æ±‡æ€»å­æ ‡ç­¾é¡µ
        else:
            self.log_message("âœ— è·å–æœˆåº¦æ±‡æ€»å¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
        
        self.db_manager.disconnect()
    
    def display_monthly_summary(self):
        """æ˜¾ç¤ºæœˆåº¦æ±‡æ€»"""
        # æ¸…ç©ºTreeView
        for item in self.monthly_tree.get_children():
            self.monthly_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ['æœˆä»½\nMonth', 'é—¨å¸‚\nOutlet', 'ç±»åˆ«\nCategory', 'äº§å“\nProduct', 'å–å‡ºé‡\nQuantity Sold', 'é‡‘é¢\nAmount', 'æ€»é‡‘é¢\nTotal Amount', 'å•æ®æ•°\nReceipt Count', 'äº§å“å•æ®ä¸šç»©\nProduct Receipt Performance', 'é‡‘é¢å æ¯”(%)\nAmount Ratio(%)', 'å•æ®å æ¯”(%)\nReceipt Ratio(%)', 'äº§å“å•æ®ä¸šç»©å æ¯”(%)\nProduct Receipt Performance Ratio(%)']
        self.monthly_tree["columns"] = columns
        
        for col in columns:
            self.monthly_tree.heading(col, text=col, command=lambda c=col: self.sort_treeview(self.monthly_tree, c))
            self.monthly_tree.column(col, width=120, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)  # è¿›ä¸€æ­¥ç¼©å°æ•°æ®è¡Œé«˜åº¦åˆ°25åƒç´ 
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))  # ç¼©å°å­—ä½“ä½†å¢åŠ æ ‡é¢˜é«˜åº¦åˆ°80åƒç´ 
        
        # é…ç½®é¢œè‰²æ ‡ç­¾
        self.monthly_tree.tag_configure("store_total", background="#E6F3FF", foreground="#000000")  # é—¨åº—æ€»è®¡ - æµ…è“è‰²
        self.monthly_tree.tag_configure("month_total", background="#E6FFE6", foreground="#000000")  # æœˆä»½æ€»è®¡ - æµ…ç»¿è‰²
        self.monthly_tree.tag_configure("grand_total", background="#FFE6E6", foreground="#000000")  # å…¨æ€»è®¡ - æµ…çº¢è‰²
        
        # å‡†å¤‡æ˜¾ç¤ºæ•°æ®
        display_data = self.monthly_data
        if self.show_daily_average.get() and self.monthly_data:
            display_data = self.calculate_daily_average(self.monthly_data)
        
        # é‡æ–°ç»„ç»‡æ•°æ®ï¼ŒæŒ‰æœˆä»½å’Œé—¨åº—åˆ†ç»„
        monthly_grouped = {}
        month_totals = {}  # å­˜å‚¨æ¯ä¸ªæœˆä»½çš„æ€»è®¡
        grand_total = {'qty': 0.0, 'amount': 0.0, 'total_amount': 0.0, 'receipt_count': 0}
        
        for data in display_data:
            # è·³è¿‡å·²ç»æ˜¯æ€»è®¡è¡Œçš„æ•°æ®
            if data['æœˆä»½'].startswith('ã€') and ('æ€»è®¡ã€‘' in data['æœˆä»½'] or 'æœˆä»½æ€»è®¡ã€‘' in data['æœˆä»½']):
                continue

            month = data['æœˆä»½']
            store = data['é—¨å¸‚']

            if month not in monthly_grouped:
                monthly_grouped[month] = {}
            if store not in monthly_grouped[month]:
                monthly_grouped[month][store] = []

            monthly_grouped[month][store].append(data)

            # è®¡ç®—æœˆä»½æ€»è®¡ï¼ˆå§‹ç»ˆä½¿ç”¨åŸå§‹æ•°æ®ï¼Œå³ self.monthly_dataï¼‰
            if month not in month_totals:
                month_totals[month] = {'qty': 0.0, 'amount': 0.0, 'total_amount': 0.0, 'receipt_count': 0}
            month_totals[month]['qty'] += data['å–å‡ºé‡']
            month_totals[month]['amount'] += data['é‡‘é¢']
            month_totals[month]['total_amount'] += data['æ€»é‡‘é¢']
            month_totals[month]['receipt_count'] += data['å•æ®æ•°']

            # è®¡ç®—å…¨æ€»è®¡ï¼ˆåŒæ ·ä½¿ç”¨åŸå§‹æ•°æ®ï¼‰
            grand_total['qty'] += data['å–å‡ºé‡']
            grand_total['amount'] += data['é‡‘é¢']
            grand_total['total_amount'] += data['æ€»é‡‘é¢']
            grand_total['receipt_count'] += data['å•æ®æ•°']
        
        # æŒ‰æœˆä»½å’Œé—¨åº—é¡ºåºæ’å…¥æ•°æ®
        for month in sorted(monthly_grouped.keys()):
            for store in sorted(monthly_grouped[month].keys()):
                # æ’å…¥è¯¥é—¨åº—çš„è¯¦ç»†æ•°æ®
                for data in monthly_grouped[month][store]:
                    if self.show_product_details.get():
                        self.monthly_tree.insert("", "end", values=(
                            data['æœˆä»½'],
                            data['é—¨å¸‚'],
                            data['ç±»åˆ«'],
                            data['äº§å“'],
                            f"{data['å–å‡ºé‡']:.2f}",
                            format_currency(data['é‡‘é¢']),
                            format_currency(data['æ€»é‡‘é¢']),
                            format_number(data['å•æ®æ•°']),
                            format_currency(data.get('äº§å“å•æ®ä¸šç»©', 0)),
                            f"{data['é‡‘é¢å æ¯”(%)']:.2f}",
                            f"{data['å•æ®å æ¯”(%)']:.2f}",
                            f"{data.get('äº§å“å•æ®ä¸šç»©å æ¯”(%)', 0):.2f}"
                        ))
                
                # è®¡ç®—è¯¥é—¨åº—å½“æœˆçš„æ€»è®¡ï¼ˆåªè®¡ç®—å½“æœˆï¼Œä¸æ˜¯ç´¯è®¡ï¼‰
                store_month_total = {'qty': 0.0, 'amount': 0.0, 'total_amount': 0.0, 'receipt_count': 0}
                for data in monthly_grouped[month][store]:
                    store_month_total['qty'] += data['å–å‡ºé‡']
                    store_month_total['amount'] += data['é‡‘é¢']
                    store_month_total['total_amount'] += data['æ€»é‡‘é¢']
                    store_month_total['receipt_count'] += data['å•æ®æ•°']
                
                # æ’å…¥è¯¥é—¨åº—å½“æœˆçš„æ€»è®¡
                self.monthly_tree.insert("", "end", values=(
                    month,
                    f'ã€{store} æ€»è®¡ã€‘',
                    '',
                    '',
                    f"{store_month_total['qty']:.2f}",
                    format_currency(store_month_total['amount']),
                    format_currency(store_month_total['total_amount']),
                    format_number(store_month_total['receipt_count']),
                    '',
                    '',
                    '',
                    ''
                ), tags=("store_total",))
            
            # æ’å…¥è¯¥æœˆä»½çš„æ€»è®¡
            month_total = month_totals[month]
            self.monthly_tree.insert("", "end", values=(
                f'ã€{month} æœˆä»½æ€»è®¡ã€‘',
                '',
                '',
                '',
                f"{month_total['qty']:.2f}",
                format_currency(month_total['amount']),
                format_currency(month_total['total_amount']),
                format_number(month_total['receipt_count']),
                '',
                '',
                '',
                ''
            ), tags=("month_total",))
        
        # æ’å…¥å…¨æ€»è®¡
            self.monthly_tree.insert("", "end", values=(
                'ã€å…¨æ€»è®¡ã€‘',
                '',
                '',
                '',
                f"{grand_total['qty']:.2f}",
                format_currency(grand_total['amount']),
                format_currency(grand_total['total_amount']),
                format_number(grand_total['receipt_count']),
                '',
                '',
                '',
                ''
            ), tags=("grand_total",))
            
            # æ·»åŠ é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œï¼ˆåˆå§‹ç‚ºç©ºï¼‰
            self.update_monthly_selected_products_summary()
        
        # åˆ‡æ¢åˆ°æœˆåº¦æ±‡æ€»æ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(0)  # é€‰æ‹©Salesæ ‡ç­¾é¡µ
            self.sales_notebook.select(3)  # é€‰æ‹©æœˆåº¦æ±‡æ€»å­æ ‡ç­¾é¡µ
    
    def get_sales_analysis(self):
        """è·å–Salesåˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
            
            # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
            if date_from and date_to and date_from == date_to:
                self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
            elif date_to:
                self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
        else:
            # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
            
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        print(f"GUIè·å–çš„æ˜ŸæœŸç­›é€‰: {weekday_filters}")
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–Salesåˆ†æ...")
        self.sales_analysis_data = self.db_manager.get_sales_analysis(
            date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        
        if self.sales_analysis_data:
            self.log_message(f"âœ“ è·å–Salesåˆ†ææˆåŠŸï¼Œå…± {len(self.sales_analysis_data)} æ¡è®°å½•")
            self.display_sales_analysis()
        else:
            self.log_message("âœ— è·å–Salesåˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
        
        self.db_manager.disconnect()
    
    def display_sales_analysis(self):
        """æ˜¾ç¤ºSalesåˆ†æ"""
        # æ¸…ç©ºTreeView
        for item in self.sales_analysis_tree.get_children():
            self.sales_analysis_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ("æ—¥æœŸ", "é—¨å¸‚", "æ€»ä¸šç»©", "å•æ®æ•°")
        self.sales_analysis_tree["columns"] = columns
        self.sales_analysis_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜
        for col in columns:
            self.sales_analysis_tree.heading(col, text=col)
            self.sales_analysis_tree.column(col, width=120, anchor="center")
        
        # æ’å…¥æ•°æ®
        for data in self.sales_analysis_data:
            self.sales_analysis_tree.insert("", "end", values=(
                data['æ—¥æœŸ'],
                data['é—¨å¸‚'],
                f"${data['æ€»ä¸šç»©']:,.2f}",
                data['å•æ®æ•°']
            ))
        
        # è®¡ç®—æ€»è®¡
        total_amount = sum(data['æ€»ä¸šç»©'] for data in self.sales_analysis_data)
        
        # ä¿®å¾©ç¸½å–®æ“šæ•¸è¨ˆç®—ï¼šé‡æ–°æŸ¥è©¢å”¯ä¸€å–®æ“šæ•¸è€Œä¸æ˜¯åŠ ç¸½å„è¡Œ
        total_receipts = 0
        if self.sales_analysis_data:
            # é‡æ–°æŸ¥è©¢æ­£ç¢ºçš„å”¯ä¸€å–®æ“šæ•¸
            try:
                if hasattr(self, 'db_manager') and self.db_manager.connection:
                    cursor = self.db_manager.connection.cursor()
                    
                    # ä½¿ç”¨ç›¸åŒçš„æ¢ä»¶ä½†åªè¨ˆç®—å”¯ä¸€å–®æ“šæ•¸
                    date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
                    date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
                    outlet_filters = self.outlet_combo.get_selected()
                    month_filters = self.month_combo.get_selected()
                    weekday_filters = self.weekday_combo.get_selected()
                    category_filters = self.category_combo.get_selected()
                    payment_filters = self.payment_combo.get_selected()
                    
                    # ç°¡åŒ–çš„å”¯ä¸€å–®æ“šæ•¸æŸ¥è©¢ï¼ˆä¸ç”¨æ”¯ä»˜æ–¹å¼ç¯©é¸ä¾†é¿å…é‡è¤‡è¨ˆç®—ï¼‰
                    conditions = []
                    if date_from:
                        conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
                    if date_to:
                        conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
                    if outlet_filters and len(outlet_filters) > 0:
                        outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                        conditions.append(f"({outlet_conditions})")
                    if month_filters and len(month_filters) > 0:
                        month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                        conditions.append(f"({month_conditions})")
                    if category_filters and len(category_filters) > 0:
                        category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                        conditions.append(f"({category_conditions})")
                    
                    conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
                    
                    where_clause = ""
                    if conditions:
                        where_clause = " WHERE " + " AND ".join(conditions)
                    
                    unique_query = f"""
                        SELECT COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as unique_receipt_count
                        FROM pos_sales_dtls s
                        {where_clause}
                        AND s.item_name != 'WASTAGE'
                    """
                    
                    cursor.execute(unique_query)
                    result = cursor.fetchone()
                    total_receipts = result[0] if result else 0
                    cursor.close()
                else:
                    # å¦‚æœç„¡æ³•é‡æ–°æŸ¥è©¢ï¼Œå°±åŠ ç¸½å„è¡Œï¼ˆå„˜ç®¡ä¸æº–ç¢ºï¼‰
                    total_receipts = sum(data['å•æ®æ•°'] for data in self.sales_analysis_data)
            except:
                # å¦‚æœå¤±æ•—ï¼Œå°±åŠ ç¸½å„è¡Œå„ç”¨çš„å–®æ“šæ•¸
                total_receipts = sum(data['å•æ®æ•°'] for data in self.sales_analysis_data)
        
        # æ’å…¥æ€»è®¡è¡Œ
        self.sales_analysis_tree.insert("", "end", values=(
            "ã€æ€»è®¡ã€‘",
            "",
            f"${total_amount:,.2f}",
            total_receipts
        ), tags=("total",))
        
        # è®¾ç½®æ€»è®¡è¡Œæ ·å¼
        self.sales_analysis_tree.tag_configure("total", background="lightblue", font=("Arial", 10, "bold"))
        
        # åˆ‡æ¢åˆ°Salesåˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        # æ³¨é‡Šæ‰è‡ªåŠ¨è·³è½¬ï¼Œé¿å…æœç´¢æ—¶æ„å¤–è·³è½¬
        # if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
        #     # # self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ - å·²ç¦ç”¨ï¼Œé¿å…è·³è½¬ - å·²ç¦ç”¨ï¼Œé¿å…è·³è½¬
        #     self.product_notebook.select(0)  # é€‰æ‹©æ—¥-äº§å“åˆ†æå­æ ‡ç­¾é¡µ
    
    def get_tc_analysis(self):
        """è·å–TCåˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
            
            # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
            if date_from and date_to and date_from == date_to:
                self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
            elif date_to:
                self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
        else:
            # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
            
        outlet_filters = self.outlet_combo.get_selected()
        product_filters = self.product_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–TCåˆ†æ...")
        self.tc_analysis_data = self.db_manager.get_tc_analysis(
            date_from, date_to, outlet_filters, product_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        
        if self.tc_analysis_data:
            self.log_message(f"âœ“ è·å–TCåˆ†ææˆåŠŸï¼Œå…± {len(self.tc_analysis_data)} æ¡è®°å½•")
            self.display_tc_analysis()
        else:
            self.log_message("âœ— è·å–TCåˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
        
        self.db_manager.disconnect()
    
    def display_tc_analysis(self):
        """æ˜¾ç¤ºTCåˆ†æ"""
        # æ¸…ç©ºTreeView
        for item in self.tc_analysis_tree.get_children():
            self.tc_analysis_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ("é—¨å¸‚", "æ€»ä¸šç»©", "æ€»å•æ®æ•°", "äº§å“ä¸šç»©", "äº§å“å•æ®æ•°", "ä¸šç»©å æ¯”(%)", "å•æ®æ•°å æ¯”(%)")
        self.tc_analysis_tree["columns"] = columns
        self.tc_analysis_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜
        for col in columns:
            self.tc_analysis_tree.heading(col, text=col)
            self.tc_analysis_tree.column(col, width=120, anchor="center")
        
        # æ’å…¥æ•°æ®
        for data in self.tc_analysis_data:
            self.tc_analysis_tree.insert("", "end", values=(
                data['é—¨å¸‚'],
                f"${data['æ€»ä¸šç»©']:,.2f}",
                data['æ€»å•æ®æ•°'],
                f"${data['äº§å“ä¸šç»©']:,.2f}",
                data['äº§å“å•æ®æ•°'],
                f"{data['ä¸šç»©å æ¯”(%)']:.2f}",
                f"{data['å•æ®æ•°å æ¯”(%)']:.2f}"
            ))
        
        # è®¡ç®—æ€»è®¡
        total_amount = sum(data['æ€»ä¸šç»©'] for data in self.tc_analysis_data)
        total_product_amount = sum(data['äº§å“ä¸šç»©'] for data in self.tc_analysis_data)
        total_product_receipts = sum(data['äº§å“å•æ®æ•°'] for data in self.tc_analysis_data)
        
        # ä¿®å¾©ç¸½å–®æ“šæ•¸è¨ˆç®—ï¼šé‡æ–°æŸ¥è©¢è€Œä¸æ˜¯åŠ ç¸½å„è¡Œ
        total_receipts = 0
        if self.tc_analysis_data:
            try:
                # é‡æ–°è¨ˆç®—æ­£ç¢ºçš„å”¯ä¸€å–®æ“šæ•¸ï¼ˆä½¿ç”¨èˆ‡TCåˆ†æç›¸åŒçš„æ¢ä»¶ï¼‰
                if hasattr(self, 'db_manager') and self.db_manager.connection:
                    cursor = self.db_manager.connection.cursor()
                    
                    # ä½¿ç”¨èˆ‡TCåˆ†æç›¸åŒçš„æ¢ä»¶
                    date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
                    date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
                    outlet_filters = self.outlet_combo.get_selected()
                    product_filters = self.product_combo.get_selected()
                    month_filters = self.month_combo.get_selected()
                    weekday_filters = self.weekday_combo.get_selected()
                    category_filters = self.category_combo.get_selected()
                    payment_filters = self.payment_combo.get_selected()
                    
                    conditions = []
                    if date_from:
                        conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
                    if date_to:
                        conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
                    if outlet_filters and len(outlet_filters) > 0:
                        outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                        conditions.append(f"({outlet_conditions})")
                    if product_filters and len(product_filters) > 0:
                        product_conditions = " OR ".join([f"s.item_name = '{product}'" for product in product_filters])
                        conditions.append(f"({product_conditions})")
                    if month_filters and len(month_filters) > 0:
                        month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                        conditions.append(f"({month_conditions})")
                    if category_filters and len(category_filters) > 0:
                        category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                        conditions.append(f"({category_conditions})")
                    
                    conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
                    
                    where_clause = ""
                    if conditions:
                        where_clause = " WHERE " + " AND ".join(conditions)
                    
                    unique_query = f"""
                        SELECT COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as unique_receipt_count
                        FROM pos_sales_dtls s
                        {where_clause}
                        AND s.item_name != 'WASTAGE'
                    """
                    
                    cursor.execute(unique_query)
                    result = cursor.fetchone()
                    total_receipts = result[0] if result else 0
                    cursor.close()
                else:
                    total_receipts = sum(data['æ€»å•æ®æ•°'] for data in self.tc_analysis_data)
            except:
                total_receipts = sum(data['æ€»å•æ®æ•°'] for data in self.tc_analysis_data)
        
        # è®¡ç®—æ€»å æ¯”
        total_amount_percentage = (total_product_amount / total_amount * 100) if total_amount > 0 else 0.0
        total_receipt_percentage = (total_product_receipts / total_receipts * 100) if total_receipts > 0 else 0.0
        
        # æ’å…¥æ€»è®¡è¡Œ
        self.tc_analysis_tree.insert("", "end", values=(
            "ã€æ€»è®¡ã€‘",
            f"${total_amount:,.2f}",
            total_receipts,
            f"${total_product_amount:,.2f}",
            total_product_receipts,
            f"{total_amount_percentage:.2f}",
            f"{total_receipt_percentage:.2f}"
        ), tags=("total",))
        
        # è®¾ç½®æ€»è®¡è¡Œæ ·å¼
        self.tc_analysis_tree.tag_configure("total", background="lightblue", font=("Arial", 10, "bold"))
        
        # åˆ‡æ¢åˆ°æ—¥-äº§å“åˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        # æ³¨é‡Šæ‰è‡ªåŠ¨è·³è½¬ï¼Œé¿å…æœç´¢æ—¶æ„å¤–è·³è½¬
        # if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
        #     # # self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ - å·²ç¦ç”¨ï¼Œé¿å…è·³è½¬ - å·²ç¦ç”¨ï¼Œé¿å…è·³è½¬
        #     self.product_notebook.select(0)  # é€‰æ‹©æ—¥-äº§å“åˆ†æå­æ ‡ç­¾é¡µ
    
    def get_sales_tc_analysis(self):
        """è·å–æ—¥-äº§å“åˆ†æ - åˆå¹¶Saleså’ŒTCåˆ†æ"""
        try:
            # éªŒè¯æ—¥æœŸèŒƒå›´
            if not self.validate_date_range():
                return
                
            # å…ˆè¿æ¥æ•°æ®åº“
            db = self.selected_db.get()
            print(f"ğŸ” å°è¯•è¿æ¥æ•°æ®åº“: {db}")
            if not self.db_manager.connect(db):
                self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
                print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {db}")
                return
            
            # æµ‹è¯•æ•°æ®åº“è¿æ¥
            try:
                cursor = self.db_manager.connection.cursor()
                cursor.execute("SELECT COUNT(*) FROM pos_sales_dtls")
                result = cursor.fetchone()
                print(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œpos_sales_dtlsè¡¨è®°å½•æ•°: {result[0] if result else 0}")
                cursor.close()
            except Exception as e:
                print(f"âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: {e}")
                self.log_message(f"âœ— æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: {e}")
                return
            
            # è·å–ç­›é€‰æ¡ä»¶
            if self.use_date_filter.get():
                # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
                date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
                
                # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
                if date_from and date_to and date_from == date_to:
                    self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
                elif date_to:
                    self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
            else:
                # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œä½¿ç”¨å½“å‰æœˆä»½
                from datetime import datetime, timedelta
                now = datetime.now()
                current_month = now.strftime('%Y-%m')
                date_from = f"{current_month}-01"
                # è®¡ç®—å½“å‰æœˆçš„æœ€åä¸€å¤©
                if now.month == 12:
                    next_month = datetime(now.year + 1, 1, 1)
                else:
                    next_month = datetime(now.year, now.month + 1, 1)
                last_day = next_month - timedelta(days=1)
                date_to = last_day.strftime('%Y-%m-%d')
                self.log_message(f"â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œä½¿ç”¨å½“å‰æœˆä»½: {date_from} åˆ° {date_to}")
            
            outlet_filters = self.outlet_combo.get_selected()
            product_filters = self.product_combo.get_selected()
            month_filters = self.month_combo.get_selected()
            weekday_filters = self.weekday_combo.get_selected()
            category_filters = self.category_combo.get_selected()
            payment_filters = self.payment_combo.get_selected()
            
            self.log_message("æ­£åœ¨è·å–æ—¥-äº§å“åˆ†æ...")
            print(f"DEBUG: è°ƒç”¨ get_sales_tc_analysisï¼Œå‚æ•°: date_from={date_from}, date_to={date_to}")
            print(f"DEBUG: ç­›é€‰æ¡ä»¶: outlet_filters={outlet_filters}, product_filters={product_filters}, month_filters={month_filters}, weekday_filters={weekday_filters}, category_filters={category_filters}, payment_filters={payment_filters}")
            
            # æ¸…ç†ç¼“å­˜ä»¥ç¡®ä¿è·å–æœ€æ–°æ•°æ®
            if hasattr(self.db_manager, '_sales_tc_cache'):
                self.db_manager._sales_tc_cache.clear()
                print("DEBUG: å·²æ¸…ç†æ—¥-äº§å“åˆ†æç¼“å­˜")
            
            # å¯¹äºé”€å”®TCåˆ†æï¼Œæ€»ä¸šç»©å’Œæ€»å•æ®æ•°åº”è¯¥åŒ…å«æ‰€æœ‰äº§å“ï¼Œäº§å“ä¸šç»©å’Œäº§å“å•æ®æ•°åªåŒ…å«é€‰ä¸­çš„äº§å“
            # æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼ é€’ç©ºçš„äº§å“ç­›é€‰ç»™æ€»ä¸šç»©è®¡ç®—ï¼Œä½†ä¿ç•™äº§å“ç­›é€‰ç»™äº§å“ä¸šç»©è®¡ç®—
            self.sales_tc_analysis_data = self.db_manager.get_sales_tc_analysis(
                date_from, date_to, outlet_filters, product_filters, month_filters, weekday_filters, category_filters, payment_filters
            )
            print(f"DEBUG: get_sales_tc_analysis è¿”å›ç»“æœ: {len(self.sales_tc_analysis_data) if self.sales_tc_analysis_data else 0} æ¡è®°å½•")
            
            if self.sales_tc_analysis_data:
                self.log_message(f"âœ“ è·å–æ—¥-äº§å“åˆ†ææˆåŠŸï¼Œå…± {len(self.sales_tc_analysis_data)} æ¡è®°å½•")
                self.display_sales_tc_analysis()
            else:
                self.log_message("âœ— è·å–æ—¥-äº§å“åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
            
            self.db_manager.disconnect()
            
        except Exception as e:
            import traceback
            error_details = traceback.format_exc()
            self.log_message(f"âœ— è·å–æ—¥-äº§å“åˆ†æå¤±è´¥: {e}")
            self.log_message(f"é”™è¯¯è¯¦æƒ…: {error_details}")
            print(f"GUIæ—¥-äº§å“åˆ†æå¼‚å¸¸: {e}")
            print(f"é”™è¯¯è¯¦æƒ…: {error_details}")
    
    def display_sales_tc_analysis(self):
        """æ˜¾ç¤ºæ—¥-äº§å“åˆ†æ"""
        # æ¸…ç©ºTreeView
        for item in self.sales_tc_analysis_tree.get_children():
            self.sales_tc_analysis_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ("æ—¥æœŸ\nDate", "é—¨å¸‚\nOutlet", "æ€»ä¸šç»©\nTotal Performance", "æ€»å•æ®æ•°\nTotal Receipt Count", "æ€»é”€å”®æ•°é‡\nTotal Quantity", "äº§å“ä¸šç»©\nProduct Performance", "äº§å“å•æ®æ•°\nProduct Receipt Count", "äº§å“é”€å”®æ•°é‡\nProduct Quantity", "äº§å“å•æ®ä¸šç»©\nProduct Receipt Performance", "ä¸šç»©å æ¯”(%)\nPerformance Ratio(%)", "å•æ®æ•°å æ¯”(%)\nReceipt Count Ratio(%)", "é”€å”®æ•°é‡å æ¯”(%)\nQuantity Ratio(%)", "äº§å“å•æ®ä¸šç»©å æ¯”(%)\nProduct Receipt Performance Ratio(%)")
        self.sales_tc_analysis_tree["columns"] = columns
        self.sales_tc_analysis_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜
        for col in columns:
            self.sales_tc_analysis_tree.heading(col, text=col)
            self.sales_tc_analysis_tree.column(col, width=120, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)  # è¿›ä¸€æ­¥ç¼©å°æ•°æ®è¡Œé«˜åº¦åˆ°25åƒç´ 
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))  # ç¼©å°å­—ä½“ä½†å¢åŠ æ ‡é¢˜é«˜åº¦åˆ°80åƒç´ 
        
        # é…ç½®æ¯æ—¥åŠ æ€»è¡Œçš„é¢œè‰²
        self.sales_tc_analysis_tree.tag_configure("daily_total", background="#E6F3FF", foreground="#000000")  # æµ…è“è‰²
        
        # æŒ‰æ—¥æœŸåˆ†ç»„æ•°æ®å¹¶æ·»åŠ æ¯æ—¥åŠ æ€»
        daily_data = {}
        for data in self.sales_tc_analysis_data:
            date = data['æ—¥æœŸ']
            if date not in daily_data:
                daily_data[date] = []
            daily_data[date].append(data)
        
        # æ’å…¥æ•°æ®ï¼ŒæŒ‰æ—¥æœŸåˆ†ç»„å¹¶æ·»åŠ æ¯æ—¥åŠ æ€»
        for date in sorted(daily_data.keys()):
            date_data = daily_data[date]
            
            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get():
                # æ’å…¥è¯¥æ—¥æœŸçš„æ‰€æœ‰é—¨åº—æ•°æ®
                for data in date_data:
                    self.sales_tc_analysis_tree.insert("", "end", values=(
                        data['æ—¥æœŸ'],
                        data['é—¨å¸‚'],
                        format_currency(data['æ€»ä¸šç»©']),
                        format_number(data['æ€»å•æ®æ•°']),
                        format_number(data['æ€»é”€å”®æ•°é‡']),
                        format_currency(data['äº§å“ä¸šç»©']),
                        format_number(data['äº§å“å•æ®æ•°']),
                        format_number(data['äº§å“é”€å”®æ•°é‡']),
                        format_currency(data.get('äº§å“å•æ®ä¸šç»©', 0)),
                        f"{data['ä¸šç»©å æ¯”(%)']:.2f}",
                        f"{data['å•æ®æ•°å æ¯”(%)']:.2f}",
                        f"{data['é”€å”®æ•°é‡å æ¯”(%)']:.2f}",
                        f"{data.get('äº§å“å•æ®ä¸šç»©å æ¯”(%)', 0):.2f}"
                    ))
            
            # è®¡ç®—è¯¥æ—¥æœŸçš„åŠ æ€»
            daily_total_amount = sum(data['æ€»ä¸šç»©'] for data in date_data)
            daily_total_receipts = sum(data['æ€»å•æ®æ•°'] for data in date_data)
            daily_total_quantity = sum(data['æ€»é”€å”®æ•°é‡'] for data in date_data)
            daily_product_amount = sum(data['äº§å“ä¸šç»©'] for data in date_data)
            daily_product_receipts = sum(data['äº§å“å•æ®æ•°'] for data in date_data)
            daily_product_quantity = sum(data['äº§å“é”€å”®æ•°é‡'] for data in date_data)
            daily_product_receipt_performance = sum(data.get('äº§å“å•æ®ä¸šç»©', 0) for data in date_data)
            daily_amount_percentage = (daily_product_amount / daily_total_amount * 100) if daily_total_amount > 0 else 0.0
            daily_receipt_percentage = (daily_product_receipts / daily_total_receipts * 100) if daily_total_receipts > 0 else 0.0
            daily_quantity_percentage = (daily_product_quantity / daily_total_quantity * 100) if daily_total_quantity > 0 else 0.0
            daily_product_receipt_performance_percentage = (daily_product_receipt_performance / daily_total_amount * 100) if daily_total_amount > 0 else 0.0
            
            # æ’å…¥è¯¥æ—¥æœŸçš„åŠ æ€»è¡Œ
            self.sales_tc_analysis_tree.insert("", "end", values=(
                f"ã€{date} æ€»è®¡ã€‘",
                "",
                format_currency(daily_total_amount),
                format_number(daily_total_receipts),
                format_number(daily_total_quantity),
                format_currency(daily_product_amount),
                format_number(daily_product_receipts),
                format_number(daily_product_quantity),
                format_currency(daily_product_receipt_performance),
                f"{daily_amount_percentage:.2f}",
                f"{daily_receipt_percentage:.2f}",
                f"{daily_quantity_percentage:.2f}",
                f"{daily_product_receipt_performance_percentage:.2f}"
            ), tags=("daily_total",))
        
        # è®¡ç®—æ€»è®¡
        total_amount = sum(data['æ€»ä¸šç»©'] for data in self.sales_tc_analysis_data)
        total_quantity = sum(data['æ€»é”€å”®æ•°é‡'] for data in self.sales_tc_analysis_data)
        total_product_amount = sum(data['äº§å“ä¸šç»©'] for data in self.sales_tc_analysis_data)
        total_product_receipts = sum(data['äº§å“å•æ®æ•°'] for data in self.sales_tc_analysis_data)
        total_product_quantity = sum(data['äº§å“é”€å”®æ•°é‡'] for data in self.sales_tc_analysis_data)
        total_product_receipt_performance = sum(data.get('äº§å“å•æ®ä¸šç»©', 0) for data in self.sales_tc_analysis_data)
        
        # ä¿®å¾©ç¸½å–®æ“šæ•¸è¨ˆç®—ï¼šé‡æ–°æŸ¥è©¢è€Œä¸æ˜¯åŠ ç¸½å„è¡Œ
        total_receipts = 0
        if self.sales_tc_analysis_data:
            try:
                # é‡æ–°è¨ˆç®—æ­£ç¢ºçš„å”¯ä¸€å–®æ“šæ•¸ï¼ˆä½¿ç”¨èˆ‡éŠ·å”®TCåˆ†æç›¸åŒçš„æ¢ä»¶ï¼‰
                if hasattr(self, 'db_manager') and self.db_manager.connection:
                    cursor = self.db_manager.connection.cursor()
                    
                    # ä½¿ç”¨èˆ‡éŠ·å”®TCåˆ†æç›¸åŒçš„æ¢ä»¶
                    date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
                    date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
                    outlet_filters = self.outlet_combo.get_selected()
                    product_filters = self.product_combo.get_selected()
                    month_filters = self.month_combo.get_selected()
                    weekday_filters = self.weekday_combo.get_selected()
                    category_filters = self.category_combo.get_selected()
                    payment_filters = self.payment_combo.get_selected()
                    
                    conditions = []
                    if date_from:
                        conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}'")
                    if date_to:
                        conditions.append(f"CAST(s.c_date AS DATE) <= '{date_to}'")
                    if outlet_filters and len(outlet_filters) > 0:
                        outlet_conditions = " OR ".join([f"s.store_name = '{outlet}'" for outlet in outlet_filters])
                        conditions.append(f"({outlet_conditions})")
                    if product_filters and len(product_filters) > 0:
                        product_conditions = " OR ".join([f"s.item_name = '{product}'" for product in product_filters])
                        conditions.append(f"({product_conditions})")
                    if month_filters and len(month_filters) > 0:
                        month_conditions = " OR ".join([f"FORMAT(CAST(s.c_date AS DATE), 'yyyy-MM') = '{month}'" for month in month_filters])
                        conditions.append(f"({month_conditions})")
                    if category_filters and len(category_filters) > 0:
                        category_conditions = " OR ".join([f"s.item_category = '{category}'" for category in category_filters])
                        conditions.append(f"({category_conditions})")
                    
                    conditions.append("s.item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')")
                    
                    where_clause = ""
                    if conditions:
                        where_clause = " WHERE " + " AND ".join(conditions)
                    
                    unique_query = f"""
                        SELECT COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as unique_receipt_count
                        FROM pos_sales_dtls s
                        {where_clause}
                        AND s.item_name != 'WASTAGE'
                    """
                    
                    cursor.execute(unique_query)
                    result = cursor.fetchone()
                    total_receipts = result[0] if result else 0
                    cursor.close()
                else:
                    total_receipts = sum(data['æ€»å•æ®æ•°'] for data in self.sales_tc_analysis_data)
            except:
                total_receipts = sum(data['æ€»å•æ®æ•°'] for data in self.sales_tc_analysis_data)
        
        # è®¡ç®—æ€»å æ¯”
        total_amount_percentage = (total_product_amount / total_amount * 100) if total_amount > 0 else 0.0
        total_receipt_percentage = (total_product_receipts / total_receipts * 100) if total_receipts > 0 else 0.0
        total_quantity_percentage = (total_product_quantity / total_quantity * 100) if total_quantity > 0 else 0.0
        total_product_receipt_performance_percentage = (total_product_receipt_performance / total_amount * 100) if total_amount > 0 else 0.0
        
        # æ’å…¥æ€»è®¡è¡Œ
        self.sales_tc_analysis_tree.insert("", "end", values=(
            "ã€æ€»è®¡ã€‘",
            "",
            f"${total_amount:,.2f}",
            total_receipts,
            total_quantity,
            f"${total_product_amount:,.2f}",
            total_product_receipts,
            total_product_quantity,
            f"${total_product_receipt_performance:,.2f}",
            f"{total_amount_percentage:.2f}",
            f"{total_receipt_percentage:.2f}",
            f"{total_quantity_percentage:.2f}",
            f"{total_product_receipt_performance_percentage:.2f}"
        ), tags=("total",))
        
        # è®¾ç½®æ€»è®¡è¡Œæ ·å¼
        self.sales_tc_analysis_tree.tag_configure("total", background="lightblue", font=("Arial", 10, "bold"))
        
        # åˆ‡æ¢åˆ°æ—¥-äº§å“åˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ
            self.product_notebook.select(3)  # é€‰æ‹©æ—¥-äº§å“åˆ†æå­æ ‡ç­¾é¡µ
    
    def get_sales_tc_monthly(self):
        """è·å–æœˆ-äº§å“åˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        print(f"ğŸ” å°è¯•è¿æ¥æ•°æ®åº“: {db}")
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {db}")
            return
        
        # æµ‹è¯•æ•°æ®åº“è¿æ¥
        try:
            cursor = self.db_manager.connection.cursor()
            cursor.execute("SELECT COUNT(*) FROM pos_sales_dtls")
            result = cursor.fetchone()
            print(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œpos_sales_dtlsè¡¨è®°å½•æ•°: {result[0] if result else 0}")
            cursor.close()
        except Exception as e:
            print(f"âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: {e}")
            self.log_message(f"âœ— æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: {e}")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
            
            # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
            if date_from and date_to and date_from == date_to:
                self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
            elif date_to:
                self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
        else:
            # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
            # ä½†æ˜¯æ•°æ®åº“æŸ¥è¯¢éœ€è¦æ—¥æœŸèŒƒå›´ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªåˆç†çš„é»˜è®¤èŒƒå›´
            # å¦‚æœæ²¡æœ‰é€‰æ‹©æœˆä»½ï¼Œä½¿ç”¨å½“å‰æœˆä»½
            month_filters = self.month_combo.get_selected()
            if month_filters and len(month_filters) > 0:
                # ä½¿ç”¨é€‰ä¸­çš„ç¬¬ä¸€ä¸ªæœˆä»½ä½œä¸ºæ—¥æœŸèŒƒå›´
                selected_month = month_filters[0]
                date_from = f"{selected_month}-01"
                # è®¡ç®—è¯¥æœˆçš„æœ€åä¸€å¤©
                from datetime import datetime, timedelta
                year, month = map(int, selected_month.split('-'))
                if month == 12:
                    next_month = datetime(year + 1, 1, 1)
                else:
                    next_month = datetime(year, month + 1, 1)
                last_day = next_month - timedelta(days=1)
                date_to = last_day.strftime('%Y-%m-%d')
                self.log_message(f"â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œä½¿ç”¨æœˆä»½ç­›é€‰: {date_from} åˆ° {date_to}")
            else:
                # å¦‚æœæ²¡æœ‰é€‰æ‹©æœˆä»½ï¼Œä½¿ç”¨å½“å‰æœˆä»½
                from datetime import datetime, timedelta
                now = datetime.now()
                current_month = now.strftime('%Y-%m')
                date_from = f"{current_month}-01"
                # è®¡ç®—å½“å‰æœˆçš„æœ€åä¸€å¤©
                if now.month == 12:
                    next_month = datetime(now.year + 1, 1, 1)
                else:
                    next_month = datetime(now.year, now.month + 1, 1)
                last_day = next_month - timedelta(days=1)
                date_to = last_day.strftime('%Y-%m-%d')
                self.log_message(f"â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œä½¿ç”¨å½“å‰æœˆä»½: {date_from} åˆ° {date_to}")
            
        outlet_filters = self.outlet_combo.get_selected()
        product_filters = self.product_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        print(f"GUIè·å–çš„æ˜ŸæœŸç­›é€‰: {weekday_filters}")
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–æœˆ-äº§å“åˆ†æ...")
        self.sales_tc_monthly_data = self.db_manager.get_sales_tc_monthly_analysis(
            date_from, date_to, outlet_filters, product_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        self.sales_tc_monthly_store_count = self.db_manager.get_unique_store_count(
            date_from=date_from,
            date_to=date_to,
            outlet_filters=outlet_filters,
            month_filters=month_filters,
            weekday_filters=weekday_filters,
            category_filters=category_filters,
            product_filters=product_filters,
            payment_filters=payment_filters
        ) or 1
        
        if self.sales_tc_monthly_data:
            self.log_message(f"âœ“ è·å–æœˆ-äº§å“åˆ†ææˆåŠŸï¼Œå…± {len(self.sales_tc_monthly_data)} æ¡è®°å½•")
            self.display_sales_tc_monthly()
        else:
            self.log_message("âœ— è·å–æœˆ-äº§å“åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
        
        self.db_manager.disconnect()
    
    def display_sales_tc_monthly(self):
        """æ˜¾ç¤ºæœˆ-äº§å“åˆ†æ"""
        # æ¸…ç©ºTreeView
        for item in self.sales_tc_monthly_tree.get_children():
            self.sales_tc_monthly_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ['æœˆä»½\nMonth', 'é—¨å¸‚\nOutlet', 'æ€»ä¸šç»©\nTotal Performance', 'æ€»å•æ®æ•°\nTotal Receipt Count', 'æ€»é”€å”®æ•°é‡\nTotal Quantity', 'äº§å“ä¸šç»©\nProduct Performance', 'äº§å“å•æ®æ•°\nProduct Receipt Count', 'äº§å“é”€å”®æ•°é‡\nProduct Quantity', 'äº§å“å•æ®ä¸šç»©\nProduct Receipt Performance', 'ä¸šç»©å æ¯”(%)\nPerformance Ratio(%)', 'å•æ®æ•°å æ¯”(%)\nReceipt Count Ratio(%)', 'é”€å”®æ•°é‡å æ¯”(%)\nQuantity Ratio(%)', 'äº§å“å•æ®ä¸šç»©å æ¯”(%)\nProduct Receipt Performance Ratio(%)']
        self.sales_tc_monthly_tree["columns"] = columns
        
        for col in columns:
            self.sales_tc_monthly_tree.heading(col, text=col, command=lambda c=col: self.sort_treeview(self.sales_tc_monthly_tree, c))
            self.sales_tc_monthly_tree.column(col, width=120, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)  # è¿›ä¸€æ­¥ç¼©å°æ•°æ®è¡Œé«˜åº¦åˆ°25åƒç´ 
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))  # ç¼©å°å­—ä½“ä½†å¢åŠ æ ‡é¢˜é«˜åº¦åˆ°80åƒç´ 
        
        # æ’å…¥æ•°æ®
        # ç¡®å®šé—¨åº—æ•°é‡ç”¨äºå•åº—å¹³å‡
        store_count = getattr(self, 'sales_tc_monthly_store_count', None)
        if not store_count or store_count <= 0:
            unique_stores = {data['é—¨å¸‚'] for data in self.sales_tc_monthly_data if data['é—¨å¸‚'] and not str(data['é—¨å¸‚']).startswith('ã€')}
            store_count = len(unique_stores) or 1

        for data in self.sales_tc_monthly_data:
            total_perf = data['æ€»ä¸šç»©']
            total_receipts = data['æ€»å•æ®æ•°']
            total_qty = data['æ€»é”€å”®æ•°é‡']
            prod_perf = data['äº§å“ä¸šç»©']
            prod_receipts = data['äº§å“å•æ®æ•°']
            prod_qty = data['äº§å“é”€å”®æ•°é‡']
            prod_receipt_perf = data.get('äº§å“å•æ®ä¸šç»©', 0)

            if self.show_store_average.get() and store_count > 0:
                total_perf /= store_count
                total_receipts /= store_count
                total_qty /= store_count
                prod_perf /= store_count
                prod_receipts /= store_count
                prod_qty /= store_count
                prod_receipt_perf /= store_count

            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get():
                self.sales_tc_monthly_tree.insert("", "end", values=(
                    data['æœˆä»½'],
                    data['é—¨å¸‚'],
                    f"{total_perf:.2f}",
                    format_number(total_receipts),
                    f"{total_qty:.2f}",
                    f"{prod_perf:.2f}",
                    format_number(prod_receipts),
                    f"{prod_qty:.2f}",
                    f"{prod_receipt_perf:.2f}",
                    f"{data['ä¸šç»©å æ¯”(%)']:.2f}",
                    f"{data['å•æ®æ•°å æ¯”(%)']:.2f}",
                    f"{data['é”€å”®æ•°é‡å æ¯”(%)']:.2f}",
                    f"{data.get('äº§å“å•æ®ä¸šç»©å æ¯”(%)', 0):.2f}"
                ))
        
        # è®¡ç®—å¹¶æ·»åŠ æ€»è®¡è¡Œ - ä¿®æ­£è®¡ç®—é€»è¾‘ï¼ˆåŸºäºæœˆä»½é—¨å¸‚å»é‡åå°†ä¸šç»©æ±‚å’Œï¼Œé¿å…é‡å¤è®¡ç®—ï¼‰
        if self.sales_tc_monthly_data:
            monthly_totals = {}
            product_totals = {'product_sales': 0.0, 'product_receipts': 0.0, 'product_quantity': 0.0, 'product_receipt_performance': 0.0}

            for data in self.sales_tc_monthly_data:
                month_key = data['æœˆä»½']
                store_key = data['é—¨å¸‚']
                key = f"{month_key}_{store_key}"

                if key not in monthly_totals:
                    monthly_totals[key] = {
                        'month': data['æœˆä»½'],
                        'store': data['é—¨å¸‚'],
                        'total_sales': data['æ€»ä¸šç»©'],
                        'total_receipts': data['æ€»å•æ®æ•°'],
                        'total_quantity': data['æ€»é”€å”®æ•°é‡']
                    }

                product_totals['product_sales'] += data['äº§å“ä¸šç»©']
                product_totals['product_receipts'] += data['äº§å“å•æ®æ•°']
                product_totals['product_quantity'] += data['äº§å“é”€å”®æ•°é‡']
                product_totals['product_receipt_performance'] += data.get('äº§å“å•æ®ä¸šç»©', 0)

            store_count = getattr(self, 'sales_tc_monthly_store_count', None)
            if not store_count or store_count <= 0:
                store_count = len({entry['store'] for entry in monthly_totals.values() if entry['store'] and not str(entry['store']).startswith('ã€')}) or 1

            total_sales = sum(item['total_sales'] for item in monthly_totals.values())
            total_receipts = sum(item['total_receipts'] for item in monthly_totals.values())
            total_quantity = sum(item['total_quantity'] for item in monthly_totals.values())

            if self.show_store_average.get() and store_count > 0:
                total_sales /= store_count
                total_receipts /= store_count
                total_quantity /= store_count
                product_totals['product_sales'] /= store_count
                product_totals['product_receipts'] /= store_count
                product_totals['product_quantity'] /= store_count
                product_totals['product_receipt_performance'] /= store_count

            total_sales_ratio = (product_totals['product_sales'] / total_sales * 100) if total_sales > 0 else 0
            total_receipt_ratio = (product_totals['product_receipts'] / total_receipts * 100) if total_receipts > 0 else 0
            total_quantity_ratio = (product_totals['product_quantity'] / total_quantity * 100) if total_quantity > 0 else 0
            total_product_receipt_performance_ratio = (product_totals['product_receipt_performance'] / total_sales * 100) if total_sales > 0 else 0

            self.sales_tc_monthly_tree.insert("", "end", values=(
                "ã€æ€»è®¡ã€‘",
                "",
                f"{total_sales:.2f}",
                format_number(total_receipts),
                f"{total_quantity:.2f}",
                f"{product_totals['product_sales']:.2f}",
                format_number(product_totals['product_receipts']),
                f"{product_totals['product_quantity']:.2f}",
                f"{product_totals['product_receipt_performance']:.2f}",
                f"{total_sales_ratio:.2f}",
                f"{total_receipt_ratio:.2f}",
                f"{total_quantity_ratio:.2f}",
                f"{total_product_receipt_performance_ratio:.2f}"
            ), tags=("total",))
            
            # æ·»åŠ é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œï¼ˆåˆå§‹ç‚ºç©ºï¼‰
            self.update_monthly_analysis_selected_products_summary()
        
        # è®¾ç½®æ€»è®¡è¡Œæ ·å¼
        self.sales_tc_monthly_tree.tag_configure("total", background="lightblue", font=("Arial", 10, "bold"))
        
        # åˆ‡æ¢åˆ°æœˆ-äº§å“åˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ
            self.product_notebook.select(4)  # é€‰æ‹©æœˆ-äº§å“åˆ†æå­æ ‡ç­¾é¡µ
    
    def setup_left_panel(self):
        """è®¾ç½®å·¦ä¾§åˆ†æåŠŸèƒ½æŒ‰é’®é¢æ¿"""
        # åˆ›å»ºæ»šåŠ¨åŒºåŸŸ - æ´»å‹•è¨˜éŒ„ç®¡ç†ä¸­å¿ƒé¢¨æ ¼
        canvas = tk.Canvas(self.left_panel, bg='#ffffff', highlightthickness=0)
        scrollbar = ttk.Scrollbar(self.left_panel, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg='#ffffff')
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # ç»‘å®šé¼ æ ‡æ»šè½®äº‹ä»¶
        def _on_mousewheel(event):
            canvas.yview_scroll(int(-1*(event.delta/120)), "units")
        
        def _bind_to_mousewheel(event):
            canvas.bind_all("<MouseWheel>", _on_mousewheel)
        
        def _unbind_from_mousewheel(event):
            canvas.unbind_all("<MouseWheel>")
        
        canvas.bind('<Enter>', _bind_to_mousewheel)
        canvas.bind('<Leave>', _unbind_from_mousewheel)
        
        canvas.pack(side="left", fill="both", expand=True, padx=(0, 0))
        scrollbar.pack(side="right", fill="y", padx=(0, 0))
        
        # å‰µå»ºç¾ä»£åŒ–æ¨£å¼
        style = ttk.Style()
        
        # ğŸŒŸ ç¾ä»£åŒ–å·¦å´é¢æ¿æ¨£å¼
        
        # ç¾ä»£æ¸…æ–°å¤šè‰²å½©æŒ‰éˆ•è¨­è¨ˆ - æŸ”å’Œè€Œå°ˆæ¥­
        # éŠ·å”®åˆ†ææŒ‰éˆ• - å°ˆæ¥­è—è‰²ç³»
        style.configure("Sales.TButton", 
                       font=('Segoe UI', 9, 'bold'),
                       background="#2196F3",  # å°ˆæ¥­è—
                       foreground="#FFFFFF",
                       padding=(14, 12),
                       relief="flat",
                       borderwidth=0)
        
        style.map("Sales.TButton",
                 background=[('active', '#1976D2'),
                            ('!active', '#2196F3')])
        
        # ç”¢å“åˆ†ææŒ‰éˆ• - æ¸…æ–°ç¶ è‰²ç³»
        style.configure("Product.TButton", 
                       font=('Segoe UI', 9, 'bold'),
                       background="#4CAF50",  # æ¸…æ–°ç¶ 
                       foreground="#FFFFFF",
                       padding=(14, 12),
                       relief="flat",
                       borderwidth=0)
        
        style.map("Product.TButton",
                 background=[('active', '#388E3C'),
                            ('!active', '#4CAF50')])
        
        # å“ç‰Œåˆ†ææŒ‰éˆ• - å„ªé›…ç´«è‰²ç³»
        style.configure("Brand.TButton", 
                       font=('Segoe UI', 9, 'bold'),
                       background="#9C27B0",  # å„ªé›…ç´«
                       foreground="#FFFFFF",
                       padding=(14, 12),
                       relief="flat",
                       borderwidth=0)
        
        style.map("Brand.TButton",
                 background=[('active', '#7B1FA2'),
                            ('!active', '#9C27B0')])
        
        # å°å‡ºæŒ‰éˆ• - æº«æš–æ©™è‰²ç³»
        style.configure("Export.TButton", 
                       font=('Segoe UI', 9, 'bold'),
                       background="#FF9800",  # æº«æš–æ©™
                       foreground="#FFFFFF",
                       padding=(14, 12),
                       relief="flat",
                       borderwidth=0)
        
        style.map("Export.TButton",
                 background=[('active', '#F57C00'),
                            ('!active', '#FF9800')])
        
        # å·¥å…·æŒ‰éˆ• - ç´”ç™½ç³»
        style.configure("Tools.TButton", 
                       font=('Segoe UI', 9),
                       background="#FFFFFF",  # ç´”ç™½
                       foreground="#2196F3",  # è—è‰²æ–‡å­—
                       padding=(12, 10),
                       relief="solid",
                       borderwidth=2)
        
        style.map("Tools.TButton",
                 background=[('active', '#E3F2FD'),
                            ('!active', '#FFFFFF')])
        
        # é€£æ¥æŒ‰éˆ• - æˆåŠŸç¶ è‰²
        style.configure("Connect.TButton", 
                       font=('Segoe UI', 10, 'bold'),
                       background="#4CAF50",  # æˆåŠŸç¶ è‰²
                       foreground="#FFFFFF",
                       padding=(16, 14),
                       relief="flat",
                       borderwidth=0)
        
        style.map("Connect.TButton",
                 background=[('active', '#388E3C'),
                            ('!active', '#4CAF50')])
        
        # æ´»å‹•è¨˜éŒ„æŒ‰éˆ• - æŸ”å’Œç´…è‰²
        style.configure("Activity.TButton", 
                       font=('Segoe UI', 9, 'bold'),
                       background="#F44336",  # æŸ”å’Œç´…
                       foreground="#FFFFFF",
                       padding=(14, 12),
                       relief="flat",
                       borderwidth=0)
        
        style.map("Activity.TButton",
                 background=[('active', '#D32F2F'),
                            ('!active', '#F44336')])
        
        # Sales Analysis é”€å”®åˆ†æ - åœ–äºŒæ·±è‰²ä¸»é¡Œé¢¨æ ¼
        sales_frame = tk.LabelFrame(scrollable_frame, text="ğŸ“Š Sales Analysis\né”€å”®åˆ†æ", bg='#2c3e50', fg='white', relief='flat', bd=1)
        sales_frame.pack(fill="x", pady=(0, 8), padx=(0, 0))
        
        # æ·±ç°èƒŒæ™¯ + å½©è‰²é‚Šæ¡†è¨­è¨ˆ
        sales_buttons = [
            ("é”€å”®æ•°æ®\nSales Raw Data", self.get_sales_data, "#2563eb"),
            ("æ”¯ä»˜æ–¹å¼åˆ†æ\nPayment Analysis", self.get_payment_analysis, "#059669"),
            ("æŠ˜æ‰£åˆ†æ\nDiscount Analysis", self.get_discount_analysis, "#dc2626"),
            ("æœˆ - é”€å”®æ•°æ®\nMonthly - Product Data", self.get_monthly_summary, "#ea580c")
        ]
        
        for text, command, border_color in sales_buttons:
            # å‰µå»ºæ·±ç°èƒŒæ™¯ + å½©è‰²é‚Šæ¡†æŒ‰éˆ•
            btn = tk.Button(sales_frame, 
                           text=text, 
                           command=lambda cmd=command: self.safe_command_execute(cmd),
                           bg='#34495e',  # æ·±ç°èƒŒæ™¯
                           fg='white',
                           font=('Microsoft JhengHei UI', 10, 'bold'),
                           relief='solid',
                           bd=3,  # é‚Šæ¡†åšåº¦
                           highlightthickness=0,
                           cursor='hand2')
            
            # è¨­ç½®å½©è‰²é‚Šæ¡†
            btn.configure(highlightbackground=border_color, highlightcolor=border_color)
            
            btn.pack(fill="x", pady=3, padx=8)
            
            # æ·»åŠ æ‡¸åœæ•ˆæœ - é‚Šæ¡†é¡è‰²å¡«å……
            def on_enter(event, btn=btn, border_color=border_color):
                btn.config(bg=border_color, fg='white')
            
            def on_leave(event, btn=btn):
                btn.config(bg='#34495e', fg='white')
                
            btn.bind('<Enter>', on_enter)
            btn.bind('<Leave>', on_leave)
        
        # Product Analysis äº§å“åˆ†æ - åœ–äºŒæ·±è‰²ä¸»é¡Œé¢¨æ ¼
        product_frame = tk.LabelFrame(scrollable_frame, text="ğŸ“¦ Product Analysis\näº§å“åˆ†æ", bg='#2c3e50', fg='white', relief='flat', bd=1)
        product_frame.pack(fill="x", pady=(0, 8), padx=(0, 0))
        
        # æ·±ç°èƒŒæ™¯ + å½©è‰²é‚Šæ¡†ç”¢å“åˆ†ææŒ‰éˆ•çµ„
        product_buttons = [
            ("æ—¥ - äº§å“æ•°æ®\nDaily Product Data", self.get_product_overview, "#059669"),
            ("å‘¨ - äº§å“æ•°æ®\nWeekly Product Data", self.get_weekly_product_data, "#0891b2"),
            ("æœŸé—´ - äº§å“æ•°æ®\nPeriod Product Data", self.get_period_product_overview, "#0d9488"),
            ("æ—¥ - äº§å“åˆ†æ\nDaily - Product Analysis", self.get_sales_tc_analysis, "#65a30d"),
            ("æœˆ - äº§å“åˆ†æ\nMonthly - Product Analysis", self.get_sales_tc_monthly, "#16a34a"),
            ("äº§å“å…³è”åˆ†æ\nProduct Association Analysis", self.get_product_association_analysis, "#7c2d12"),
            ("ç±»åˆ«åˆ†æ\nCategory Analysis", self.get_category_analysis, "#ea580c")
        ]
        
        for text, command, border_color in product_buttons:
            # å‰µå»ºæ·±ç°èƒŒæ™¯ + å½©è‰²é‚Šæ¡†æŒ‰éˆ•
            btn = tk.Button(product_frame, 
                           text=text, 
                           command=lambda cmd=command: self.safe_command_execute(cmd),
                           bg='#34495e',  # æ·±ç°èƒŒæ™¯
                           fg='white',
                           font=('Microsoft JhengHei UI', 10, 'bold'),
                           relief='solid',
                           bd=3,  # é‚Šæ¡†åšåº¦
                           highlightthickness=0,
                           cursor='hand2')
            
            # è¨­ç½®å½©è‰²é‚Šæ¡†
            btn.configure(highlightbackground=border_color, highlightcolor=border_color)
            
            btn.pack(fill="x", pady=3, padx=8)
            
            # æ·»åŠ æ‡¸åœæ•ˆæœ - é‚Šæ¡†é¡è‰²å¡«å……
            def on_enter(event, btn=btn, border_color=border_color):
                btn.config(bg=border_color, fg='white')
            
            def on_leave(event, btn=btn):
                btn.config(bg='#34495e', fg='white')
                
            btn.bind('<Enter>', on_enter)
            btn.bind('<Leave>', on_leave)
        
        # Brand Analysis å“ç‰Œåˆ†æ - åœ–äºŒæ·±è‰²ä¸»é¡Œé¢¨æ ¼
        brand_frame = tk.LabelFrame(scrollable_frame, text="ğŸ¢ Brand Analysis\nå“ç‰Œåˆ†æ", bg='#2c3e50', fg='white', relief='flat', bd=1)
        brand_frame.pack(fill="x", pady=(0, 8), padx=(0, 0))
        
        # æ·±ç°èƒŒæ™¯ + å½©è‰²é‚Šæ¡†å“ç‰Œåˆ†ææŒ‰éˆ•çµ„
        brand_buttons = [
            ("æ¯æ—¥ç»†é¡¹\nDaily Breakdown", self.get_brand_daily_breakdown, "#7c3aed"),
            ("æœŸé—´æ±‡æ€»\nPeriod Summary", self.get_brand_period_summary, "#8b5cf6"),
            ("ä¸šç»©å¯¹æ¯”\nPerformance Comparison", self.get_brand_analysis, "#a855f7")
        ]
        
        for text, command, border_color in brand_buttons:
            # å‰µå»ºæ·±ç°èƒŒæ™¯ + å½©è‰²é‚Šæ¡†æŒ‰éˆ•
            btn = tk.Button(brand_frame, 
                           text=text, 
                           command=lambda cmd=command: self.safe_command_execute(cmd),
                           bg='#34495e',  # æ·±ç°èƒŒæ™¯
                           fg='white',
                           font=('Microsoft JhengHei UI', 10, 'bold'),
                           relief='solid',
                           bd=3,  # é‚Šæ¡†åšåº¦
                           highlightthickness=0,
                           cursor='hand2')
            
            # è¨­ç½®å½©è‰²é‚Šæ¡†
            btn.configure(highlightbackground=border_color, highlightcolor=border_color)
            
            btn.pack(fill="x", pady=3, padx=8)
            
            # æ·»åŠ æ‡¸åœæ•ˆæœ - é‚Šæ¡†é¡è‰²å¡«å……
            def on_enter(event, btn=btn, border_color=border_color):
                btn.config(bg=border_color, fg='white')
            
            def on_leave(event, btn=btn):
                btn.config(bg='#34495e', fg='white')
                
            btn.bind('<Enter>', on_enter)
            btn.bind('<Leave>', on_leave)
        
        # Export Functions å¯¼å‡ºåŠŸèƒ½ - çµ±ä¸€æ©™è‰²ä¸»é¡Œ
        export_frame = tk.LabelFrame(scrollable_frame, text="ğŸ“¤ Export Functions\nå¯¼å‡ºåŠŸèƒ½", bg='#2c3e50', fg='white', relief='flat', bd=1)
        export_frame.pack(fill="x", pady=(0, 8), padx=(0, 0))
        
        # æ·±ç°èƒŒæ™¯ + å½©è‰²é‚Šæ¡†å°å‡ºæŒ‰éˆ•çµ„
        export_buttons = [
            ("å¯¼å‡ºå½“å‰æ•°æ®\nExport Current Data", self.export_data, "#ea580c"),
            ("å¯¼å‡ºæ‰€æœ‰åˆ†æ\nExport All Analysis", self.export_all_data, "#f59e0b"),
            ("ç”ŸæˆæŠ¥å‘Š\nGenerate Report", self.generate_report, "#ef4444")
        ]
        
        for text, command, border_color in export_buttons:
            # å‰µå»ºæ·±ç°èƒŒæ™¯ + å½©è‰²é‚Šæ¡†æŒ‰éˆ•
            btn = tk.Button(export_frame, 
                           text=text, 
                           command=lambda cmd=command: self.safe_command_execute(cmd),
                           bg='#34495e',  # æ·±ç°èƒŒæ™¯
                           fg='white',
                           font=('Microsoft JhengHei UI', 10, 'bold'),
                           relief='solid',
                           bd=3,  # é‚Šæ¡†åšåº¦
                           highlightthickness=0,
                           cursor='hand2')
            
            # è¨­ç½®å½©è‰²é‚Šæ¡†
            btn.configure(highlightbackground=border_color, highlightcolor=border_color)
            
            btn.pack(fill="x", pady=3, padx=8)
            
            # æ·»åŠ æ‡¸åœæ•ˆæœ - é‚Šæ¡†é¡è‰²å¡«å……
            def on_enter(event, btn=btn, border_color=border_color):
                btn.config(bg=border_color, fg='white')
            
            def on_leave(event, btn=btn):
                btn.config(bg='#34495e', fg='white')
                
            btn.bind('<Enter>', on_enter)
            btn.bind('<Leave>', on_leave)
        
        # æ·»åŠ å·¥å…·åŠŸèƒ½åŒºåŸŸ
        tools_frame = tk.LabelFrame(scrollable_frame, text="ğŸ”§ Tools\nå·¥å…·")
        tools_frame.pack(fill="x", pady=(0, 3), padx=(0, 0))
        
        # å·¥å…·æŒ‰é’®ç»„
        tools_buttons = [
            ("åˆ·æ–°æ•°æ®\nRefresh Data", self.refresh_all_data),
            ("è¶…å¿«é€Ÿå¯¼å‡º\nUltra Fast Export", self.ultra_fast_export),
            ("ğŸš€ 6ä¸ªæœˆå¿«é€Ÿå¯¼å‡º\n6 Months Fast Export", self.super_fast_export_6months),
            ("ğŸ“‹ åˆ†æ®µå¼å¯¼å‡º\nStaged Export", self.new_staged_export),
            ("å¿«é€Ÿå¯¼å‡ºå†å²æ•°æ®\nFast Export Historical Data", lambda: self.export_all_historical_data(background_mode=True)),
            ("å®Œæ•´å¯¼å‡ºå†å²æ•°æ®\nFull Export Historical Data", lambda: self.export_all_historical_data(background_mode=False)),
            ("ç¼“å­˜ç»Ÿè®¡\nCache Stats", self.show_cache_statistics),
            ("æ¸…é™¤ç¼“å­˜\nClear Cache", self.clear_memory_cache),
            ("ç³»ç»Ÿè®¾ç½®\nSystem Settings", self.open_settings),
            ("å¸®åŠ©æ–‡æ¡£\nHelp Documentation", self.open_help)
        ]
        
        for text, command in tools_buttons:
            btn = ttk.Button(tools_frame, text=text, command=command, width=20, style="Tools.TButton")
            btn.pack(fill="x", pady=2)
        
        # ç»‘å®šé¼ æ ‡æ»šè½®äº‹ä»¶
        def _on_mousewheel(event):
            canvas.yview_scroll(int(-1*(event.delta/120)), "units")
        
        canvas.bind_all("<MouseWheel>", _on_mousewheel)
        
        # å½“çª—å£å¤±å»ç„¦ç‚¹æ—¶è§£ç»‘é¼ æ ‡æ»šè½®äº‹ä»¶
        def _unbind_mousewheel(event):
            canvas.unbind_all("<MouseWheel>")
        
        self.root.bind("<FocusOut>", _unbind_mousewheel)
        
        # è¨»é‡‹ï¼šåœæ­¢åœ¨å·¦å´é¢æ¿è¨­ç½®æ™‚é‡æ–°å‰µå»ºå³å´é¢æ¿
        # self.setup_right_panel()  # å·²ç§»é™¤ä»¥ä¿è­·ç¾æœ‰å³å´é¢æ¿
    
    def adjust_color(self, color, amount):
        """èª¿æ•´é¡è‰²äº®åº¦ - SEAutomation é¢¨æ ¼"""
        if isinstance(color, str) and color.startswith('#'):
            # ç§»é™¤ # è™Ÿ
            color = color[1:]
            
            # è½‰æ›ç‚º RGB
            r = int(color[0:2], 16)
            g = int(color[2:4], 16)
            b = int(color[4:6], 16)
            
            # èª¿æ•´äº®åº¦
            r = min(255, max(0, r + amount))
            g = min(255, max(0, g + amount))
            b = min(255, max(0, b + amount))
            
            # è½‰æ›å› HEX
            return f"#{r:02x}{g:02x}{b:02x}"
        return color
    
    def safe_command_execute(self, command):
        """å®‰å…¨åŸ·è¡Œå‘½ä»¤ï¼Œç¢ºä¿å³å´é¢æ¿å¾¹åº•å—åˆ°ä¿è­·"""
        try:
            # æª¢æŸ¥ä¿è­·ç‹€æ…‹
            protected = hasattr(self, '_right_panel_protected') and self._right_panel_protected
            print(f"ğŸ›¡ï¸ åŸ·è¡Œå‘½ä»¤ - å³å´é¢æ¿ä¿è­·ç‹€æ…‹: {protected}")
            
            # è¨˜éŒ„åŸ·è¡Œå‰çš„é¢æ¿ç‹€æ…‹
            if hasattr(self, 'right_panel'):
                panel_exists = self.right_panel.winfo_exists()
                child_count = len(self.right_panel.winfo_children()) if panel_exists else 0
                print(f"ğŸ” åŸ·è¡Œå‰å³å´é¢æ¿ç‹€æ…‹: å­˜åœ¨={panel_exists}, å­çµ„ä»¶={child_count}")
            
            # åŸ·è¡Œå‘½ä»¤
            command()
            
            # åŸ·è¡Œå¾Œå…¨é¢æª¢æŸ¥ä¸¦ä¿è­·
            if hasattr(self, 'right_panel'):
                try:
                    # å¼·åˆ¶ç¢ºä¿å¯è¦–æ€§
                    self.right_panel.lift()
                    self.right_panel.tkraise()
                    
                    # æª¢æŸ¥ç‹€æ…‹
                    panel_exists = self.right_panel.winfo_exists()
                    panel_visible = self.right_panel.winfo_viewable()
                    child_count = len(self.right_panel.winfo_children()) if panel_exists else 0
                    
                    print(f"ğŸ” åŸ·è¡Œå¾Œå³å´é¢æ¿ç‹€æ…‹: å­˜åœ¨={panel_exists}, å¯è¦‹={panel_visible}, å­çµ„ä»¶={child_count}")
                    
                    # å¦‚æœéœ€è¦ï¼Œå¼·åˆ¶é‡æ–°packä»¥ç¢ºä¿é¡¯ç¤º
                    if panel_exists and not panel_visible:
                        print("ğŸ”§ å¼·åˆ¶é‡æ–°packå³å´é¢æ¿ä»¥ç¢ºä¿å¯è¦‹æ€§")
                        self.force_show_right_panel_now()
                    else:
                        # å³ä½¿é¢æ¿å¯è¦‹ï¼Œä¹Ÿè¦æª¢æŸ¥å¸ƒå±€ç©©å®šæ€§
                        self.enforce_stable_layout()
                        
                except tk.TclError as panel_error:
                    print(f"âŒ å³å´é¢æ¿æª¢æŸ¥å¤±æ•—: {panel_error}")
                    # å˜—è©¦æ¢å¾©
                    if hasattr(self, '_right_panel_protected'):
                        print("ğŸ”„ å˜—è©¦é‡æ–°è¨­ç½®ä¿è­·æ¨™è¨˜")
                
        except Exception as e:
            print(f"åŸ·è¡Œå‘½ä»¤æ™‚å‡ºéŒ¯: {e}")
            # æœ€å¾Œçš„ä¿è­·æªæ–½
            if hasattr(self, '_right_panel_protected'):
                self._right_panel_protected = True
                print("ğŸ›¡ï¸ å·²é‡æ–°å•Ÿç”¨å³å´é¢æ¿ä¿è­·æ©Ÿåˆ¶")
    
    def force_show_right_panel_now(self):
        """å¼·åˆ¶é¡¯ç¤ºå³å´é¢æ¿ - è§£æ±ºå¯è¦‹æ€§å•é¡Œ"""
        try:
            print("ğŸ›¡ï¸ å¼·åˆ¶é¡¯ç¤ºå³å´é¢æ¿")
            
            if hasattr(self, 'right_panel') and hasattr(self, 'layout_container'):
                # ä½¿ç”¨ä¿å­˜çš„layout_containerå¼•ç”¨
                print("ğŸ”„ é‡æ–°packå³å´é¢æ¿åˆ°layout_container")
                
                # å¼·åˆ¶é‡æ–°packå³å´é¢æ¿
                self.right_panel.pack_forget()
                self.right_panel.pack(side="right", fill="y", expand=False, padx=(8, 15), pady=15)
                self.right_panel.configure(width=270)
                self.right_panel.pack_propagate(False)
                
                # å¼·åˆ¶é¡¯ç¤ºå’Œç½®é ‚
                self.right_panel.lift()
                self.right_panel.tkraise()
                
                # ä¿å­˜ä¿è­·æ¨™è¨˜
                self._right_panel_protected = True
                
                # å¼·åˆ¶æ›´æ–°
                self.root.update_idletasks()
                self.root.update()
                
                print("âœ… å³å´é¢æ¿å¼·åˆ¶é¡¯ç¤ºå®Œæˆ")
                print(f"âœ… å³å´é¢æ¿å¯¬åº¦: {self.right_panel.cget('width')}px")
                
                # å¼·åˆ¶é‡æ–°æ’åˆ—æ•´å€‹å¸ƒå±€
                self.enforce_stable_layout()
            else:
                print("âŒ ç¼ºå°‘å³å´é¢æ¿æˆ–ä¸»å®¹å™¨å¼•ç”¨")
        except Exception as e:
            print(f"âŒ å¼·åˆ¶é¡¯ç¤ºå³å´é¢æ¿å¤±æ•—: {e}")
    
    def enforce_stable_layout(self):
        """å¼·åˆ¶åŸ·è¡Œç©©å®šä¸‰æ¬„å¸ƒå±€ - ç¢ºä¿å³å´é¢æ¿æ°¸ä¸æ¶ˆå¤±"""
        try:
            print("ğŸ›¡ï¸ å¼·åˆ¶åŸ·è¡Œç©©å®šå¸ƒå±€...")
            
            if hasattr(self, 'layout_container'):
                # é‡æ–°æ’åˆ—æ‰€æœ‰ä¸‰å€‹é¢æ¿çš„é †åº
                
                # 1. å…ˆpack_left_left
                self.left_panel.pack_forget()
                self.left_panel.pack(side="left", fill="y", expand=False, padx=(15, 8), pady=15)
                self.left_panel.configure(width=190)
                self.left_panel.pack_propagate(False)
                
                # 2. å†pack_right (é‡è¦ï¼šå³å´å¿…é ˆåœ¨ä¸­é–“ä¹‹å¾Œ)
                self.right_panel.pack_forget()
                self.right_panel.pack(side="right", fill="y", expand=False, padx=(8, 15), pady=15)
                self.right_panel.configure(width=270)
                self.right_panel.pack_propagate(False)
                
                # 3. æœ€å¾Œpackä¸­é–“ (å¡«æ»¿å‰©é¤˜ç©ºé–“)
                self.main_frame.pack_forget()
                self.main_frame.pack(side="left", fill="both", expand=True, padx=(8, 8), pady=15)
                
                # å¼·åˆ¶æ›´æ–°
                self.layout_container.update_idletasks()
                self.root.update_idletasks()
                
                print("âœ… ä¸‰æ¬„å¸ƒå±€å¼·åˆ¶ç©©å®šå®Œæˆ")
                print(f"   - å·¦å´: {self.left_panel.cget('width')}px, ä½ç½®: {self.left_panel.pack_info()}")
                print(f"   - å³å´: {self.right_panel.cget('width')}px, ä½ç½®: {self.right_panel.pack_info()}")
                print(f"   - ä¸­é–“: å½ˆæ€§, ä½ç½®: {self.main_frame.pack_info()}")
                
        except Exception as e:
            print(f"âŒ å¼·åˆ¶ç©©å®šå¸ƒå±€å¤±æ•—: {e}")
    
    def setup_right_panel(self):
        """è¨­ç½®å³å´æ´»å‹•æé†’é¢æ¿ - å…¨é¢ä¿è­·æ©Ÿåˆ¶"""
        try:
            print("ğŸ”§ æª¢æŸ¥å³å´é¢æ¿ä¿è­·ç‹€æ…‹...")
            
            # æª¢æŸ¥æ˜¯å¦æœ‰ä¿è­·æ¨™è¨˜
            if hasattr(self, '_right_panel_protected') and self._right_panel_protected:
                print("âœ… å³å´é¢æ¿å—ä¿è­·ï¼Œç¦æ­¢ä»»ä½•ä¿®æ”¹")
                return
                
            # æª¢æŸ¥å³å´é¢æ¿æ˜¯å¦å·²ç¶“æ­£ç¢ºè¨­ç½®
            if hasattr(self, 'right_panel') and hasattr(self.right_panel, 'winfo_children'):
                child_count = len(self.right_panel.winfo_children())
                if child_count > 0:
                    print(f"âœ… å³å´é¢æ¿å·²å­˜åœ¨ ({child_count}å€‹å­çµ„ä»¶)ï¼Œå®Œå…¨ä¿è­·")
                    return
            
            # åªæœ‰åœ¨å³å´é¢æ¿ç‚ºç©ºæ™‚æ‰é‡æ–°å‰µå»º
            print("ğŸ”§ å³å´é¢æ¿ç‚ºç©ºï¼Œåˆå§‹åŒ–å…§å®¹...")
            
            # å‰µå»ºå³å´é¢æ¿æ¨™é¡Œå€åŸŸ
            right_header = tk.Frame(self.right_panel, bg='#e74c3c', height=40)
            right_header.pack(fill="x")
            right_header.pack_propagate(False)
            
            right_title = tk.Label(right_header, 
                              text="ğŸ“Š æ´»åŠ¨æé†’", 
                              font=('Microsoft YaHei UI', 12, 'bold'),
                              fg='white', bg='#e74c3c')
            right_title.pack(pady=10)
            
            right_subtitle = tk.Label(right_header, 
                                text="Activity Alerts", 
                                font=('Arial', 9),
                                fg='#ecf0f1', bg='#e74c3c')
            right_subtitle.pack()
            
            # å‰µå»ºæ´»å‹•æé†’æ˜¾ç¤ºå€åŸŸ
            self.activity_alert_text = tk.Text(self.right_panel, height=15, width=30, 
                                          font=('Segoe UI', 10), wrap=tk.WORD, bg='#FFFFFF',
                                          state='disabled', relief='flat', borderwidth=2)
            
            activity_alert_scrollbar = ttk.Scrollbar(self.right_panel, orient="vertical", 
                                                   command=self.activity_alert_text.yview)
            self.activity_alert_text.configure(yscrollcommand=activity_alert_scrollbar.set)
            
            self.activity_alert_text.pack(side="left", fill="both", expand=True, padx=5, pady=5)
            activity_alert_scrollbar.pack(side="right", fill="y", padx=(0,5), pady=5)
            
            # åˆå§‹åŒ–åŸºç¡€å†…å®¹
            self.activity_alert_text.config(state='normal')
            self.activity_alert_text.delete(1.0, tk.END)
            basic_text = """ğŸ“Š æ´»åŠ¨æé†’

ç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼
é€‰æ‹©åˆ†æåŠŸèƒ½å¼€å§‹ä½¿ç”¨ã€‚

ğŸ’¡ æç¤º:
â€¢ é€‰æ‹©æ—¥æœŸèŒƒå›´è¿›è¡Œåˆ†æ
â€¢ ä½¿ç”¨ç­›é€‰æ¡ä»¶ç²¾ç¡®å®šä½æ•°æ®  
â€¢ æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯äº†è§£æ“ä½œçŠ¶æ€"""
            self.activity_alert_text.insert(1.0, basic_text)
            self.activity_alert_text.config(state='disabled')
            
            print("âœ… å³å´é¢æ¿åˆå§‹åŒ–å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ å³å´é¢æ¿è¨­ç½®å¤±æ•—: {e}")
            # å‚™ç”¨æ–¹æ¡ˆï¼šå‰µå»ºç°¡å–®çš„é¢æ¿
            try:
                if not hasattr(self, 'activity_alert_text'):
                    self.activity_alert_text = tk.Text(self.right_panel, height=15, width=30, 
                                                  font=('Segoe UI', 10), wrap=tk.WORD, bg='#FFFFFF',
                                                  state='disabled', relief='flat', borderwidth=2)
                    self.activity_alert_text.pack(fill="both", expand=True, padx=5, pady=5)
                    
                    # è¨­ç½®åŸºç¤å…§å®¹
                    self.activity_alert_text.config(state='normal')
                    self.activity_alert_text.delete(1.0, tk.END)
                    self.activity_alert_text.insert('1.0', "ğŸ“Š å³å´é¢æ¿æ­£å¸¸é‹è¡Œ")
                    self.activity_alert_text.config(state='disabled')
                print("âœ… å‚™ç”¨å³å´é¢æ¿è¨­ç½®å®Œæˆ")
            except:
                print("âŒ å‚™ç”¨é¢æ¿è¨­ç½®ä¹Ÿå¤±æ•—")
    
    def lock_panel_sizes(self):
        """é”å®šé¢æ¿å¤§å°ï¼Œé˜²æ­¢è‡ªåŠ¨è°ƒæ•´"""
        try:
            # å¼ºåˆ¶è®¾ç½®å¹¶é”å®šå·¦ä¾§é¢æ¿å¤§å°
            self.left_panel.configure(width=190, height=600)
            self.left_panel.pack_propagate(False)  # é˜²æ­¢å­ç»„ä»¶æ”¹å˜çˆ¶ç»„ä»¶å¤§å°
            
            # å¼ºåˆ¶è®¾ç½®å¹¶é”å®šå³ä¾§é¢æ¿å¤§å°
            self.right_panel.configure(width=270)
            self.right_panel.pack_propagate(False)  # é˜²æ­¢å­ç»„ä»¶æ”¹å˜çˆ¶ç»„ä»¶å¤§å°
            
            print("ğŸ”’ é¢æ¿å¤§å°å·²é”å®š:")
            print(f"   - å·¦ä¾§é¢æ¿: 190px (é”å®š)")
            print(f"   - å³ä¾§é¢æ¿: 270px (é”å®š)")
            
            # å¼ºåˆ¶åˆ·æ–°ç•Œé¢
            self.root.update_idletasks()
            
        except Exception as e:
            print(f"é”å®šé¢æ¿å¤§å°æ—¶å‡ºé”™: {e}")
    
    def setup_ui_complete(self):
        """å®ŒæˆUIè®¾ç½®"""
        # åˆå§‹åŒ–å®Œæˆï¼Œè®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´
        try:
            # è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºå½“å‰æœˆä»½
            self.set_current_month_dates()
            self.log_message("âœ“ å·²è‡ªåŠ¨è®¾ç½®æ—¥æœŸèŒƒå›´ä¸ºå½“å‰æœˆä»½")
        except Exception as e:
            self.log_message(f"âš  è®¾ç½®é»˜è®¤æ—¥æœŸå¤±è´¥: {e}")
            # å¦‚æœè®¾ç½®å¤±è´¥ï¼Œè‡³å°‘ç¡®ä¿æ—¥æœŸç­›é€‰æ˜¯å¯ç”¨çš„
            self.use_date_filter.set(True)
    
    def export_all_data(self):
        """å¯¼å‡ºæ‰€æœ‰åˆ†ææ•°æ®"""
        self.log_message("æ­£åœ¨å¯¼å‡ºæ‰€æœ‰åˆ†ææ•°æ®...")
        try:
            # åˆ›å»ºå¯¼å‡ºç›®å½•
            export_dir = "exports"
            if not os.path.exists(export_dir):
                os.makedirs(export_dir)
            
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            exported_files = []
            
            # å¯¼å‡ºå„ç§æ•°æ®
            data_types = [
                (self.sales_data, "sales_data", "é”€å”®æ•°æ®"),
                (self.payment_data, "payment_analysis", "æ”¯ä»˜åˆ†æ"),
                (self.discount_data, "discount_analysis", "æŠ˜æ‰£åˆ†æ"),
                (self.monthly_data, "monthly_summary", "æœˆåº¦æ±‡æ€»"),
                (self.sales_tc_analysis_data, "sales_tc_analysis", "é”€å”®TCåˆ†æ"),
                (self.sales_tc_monthly_data, "sales_tc_monthly", "é”€å”®TCæœˆåº¦"),
                (self.product_association_data, "product_association", "äº§å“å…³è”åˆ†æ")
            ]
            
            for data, filename, description in data_types:
                if data:
                    filepath = os.path.join(export_dir, f"{filename}_{timestamp}.csv")
                    self.save_data_to_csv(data, filepath)
                    exported_files.append(f"{description}: {filepath}")
            
            if exported_files:
                self.log_message(f"âœ“ æˆåŠŸå¯¼å‡º {len(exported_files)} ä¸ªæ–‡ä»¶")
                for file_info in exported_files:
                    self.log_message(f"  - {file_info}")
            else:
                self.log_message("â„¹ æ²¡æœ‰æ•°æ®å¯å¯¼å‡º")
                
        except Exception as e:
            self.log_message(f"âœ— å¯¼å‡ºå¤±è´¥: {e}")
    
    def generate_report(self):
        """ç”ŸæˆæŠ¥å‘Š"""
        self.log_message("æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...")
        try:
            # åˆ›å»ºæŠ¥å‘Šç›®å½•
            report_dir = "reports"
            if not os.path.exists(report_dir):
                os.makedirs(report_dir)
            
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            report_file = os.path.join(report_dir, f"pos_analysis_report_{timestamp}.txt")
            
            with open(report_file, 'w', encoding='utf-8') as f:
                f.write("POSæ•°æ®åˆ†ææŠ¥å‘Š\n")
                f.write("=" * 50 + "\n")
                f.write(f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"æ•°æ®åº“: {self.db_manager.current_database}\n\n")
                
                # æ·»åŠ æ•°æ®ç»Ÿè®¡
                f.write("æ•°æ®ç»Ÿè®¡:\n")
                f.write("-" * 30 + "\n")
                f.write(f"é”€å”®æ•°æ®è®°å½•æ•°: {len(self.sales_data) if self.sales_data else 0}\n")
                f.write(f"æ”¯ä»˜åˆ†æè®°å½•æ•°: {len(self.payment_data) if self.payment_data else 0}\n")
                f.write(f"æŠ˜æ‰£åˆ†æè®°å½•æ•°: {len(self.discount_data) if self.discount_data else 0}\n")
                f.write(f"æœˆåº¦æ±‡æ€»è®°å½•æ•°: {len(self.monthly_data) if self.monthly_data else 0}\n")
                f.write(f"é”€å”®TCåˆ†æè®°å½•æ•°: {len(self.sales_tc_analysis_data) if self.sales_tc_analysis_data else 0}\n")
                f.write(f"äº§å“å…³è”åˆ†æè®°å½•æ•°: {len(self.product_association_data) if self.product_association_data else 0}\n")
            
            self.log_message(f"âœ“ æŠ¥å‘Šç”ŸæˆæˆåŠŸ: {report_file}")
            
        except Exception as e:
            self.log_message(f"âœ— ç”ŸæˆæŠ¥å‘Šå¤±è´¥: {e}")
    
    def refresh_all_data(self):
        """åˆ·æ–°æ‰€æœ‰æ•°æ®"""
        self.log_message("æ­£åœ¨åˆ·æ–°æ‰€æœ‰æ•°æ®...")
        try:
            # é‡æ–°è¿æ¥æ•°æ®åº“
            database_name = self.selected_db.get()
            if database_name:
                self.log_message(f"é‡æ–°è¿æ¥åˆ°æ•°æ®åº“: {database_name}")
                self.connect_database()
            
            # æ¸…é™¤ç°æœ‰æ•°æ®
            self.sales_data = None
            self.payment_data = None
            self.discount_data = None
            self.monthly_data = None
            self.sales_tc_analysis_data = None
            self.sales_tc_monthly_data = None
            self.product_association_data = None
            
            self.log_message("âœ“ æ•°æ®åˆ·æ–°å®Œæˆ")
            # æ˜¾ç¤ºå½“å‰æ•°æ®åº“ä¿¡æ¯
            self.log_database_info()
            
        except Exception as e:
            self.log_message(f"âœ— åˆ·æ–°æ•°æ®å¤±è´¥: {e}")
    
    def show_cache_statistics(self):
        """æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡ä¿¡æ¯"""
        try:
            self.log_message("ğŸ“Š æ­£åœ¨è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯...")
            self.db_manager.get_cache_statistics()
        except Exception as e:
            self.log_message(f"âœ— è·å–ç¼“å­˜ç»Ÿè®¡å¤±è´¥: {e}")
    
    def export_all_historical_data(self, background_mode=True):
        """å¯¼å‡ºæ‰€æœ‰å†å²æ•°æ®ï¼ˆæ”¯æŒå¤šæ•°æ®åº“ï¼‰"""
        if background_mode:
            # åå°æ¨¡å¼ï¼šä½¿ç”¨çº¿ç¨‹å¤„ç†
            import threading
            self.log_message("ğŸš€ å¼€å§‹åå°å¯¼å‡ºæ‰€æœ‰å†å²æ•°æ®...")
            self.log_message("â„¹ï¸ å¯¼å‡ºå°†åœ¨åå°è¿›è¡Œï¼Œæ‚¨å¯ä»¥ç»§ç»­ä½¿ç”¨å…¶ä»–åŠŸèƒ½")
            
            # åˆ›å»ºè¿›åº¦çª—å£
            self.create_export_progress_window()
            
            # å¯åŠ¨åå°çº¿ç¨‹
            export_thread = threading.Thread(target=self._background_export_worker, daemon=True)
            export_thread.start()
            
            # ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…çº¿ç¨‹å®Œæˆ
            return
        else:
            # å‰å°æ¨¡å¼ï¼šåˆ›å»ºè¿›åº¦çª—å£åç›´æ¥å¤„ç†
            self.create_export_progress_window()
            # ç¡®ä¿UIç»„ä»¶åˆ›å»ºå®Œæˆ
            self.root.update()
            self._background_export_worker()
    
    def create_export_progress_window(self):
        """åˆ›å»ºå¯¼å‡ºè¿›åº¦çª—å£"""
        try:
            # åˆ›å»ºè¿›åº¦çª—å£
            self.export_progress_window = tk.Toplevel(self.root)
            self.export_progress_window.title("å¯¼å‡ºè¿›åº¦ - Export Progress")
            self.export_progress_window.geometry("500x300")
            self.export_progress_window.resizable(False, False)
            
            # è®¾ç½®çª—å£å±…ä¸­ï¼Œä½†ä¸é˜»å¡ä¸»çª—å£
            self.export_progress_window.transient(self.root)
            # ä¸è®¾ç½® grab_set()ï¼Œè¿™æ ·ç”¨æˆ·ä»ç„¶å¯ä»¥æ“ä½œä¸»çª—å£
            
            # è¿›åº¦ä¿¡æ¯æ¡†æ¶
            progress_frame = tk.Frame(self.export_progress_window, padding="10")
            progress_frame.pack(fill="both", expand=True)
            
            # æ ‡é¢˜
            title_label = tk.Label(progress_frame, text="ğŸ“Š æ­£åœ¨å¯¼å‡ºå†å²æ•°æ®...", 
                                   font=("Arial", 12, "bold"))
            title_label.pack(pady=(0, 10))
            
            # å½“å‰çŠ¶æ€
            self.export_status_label = tk.Label(progress_frame, text="å‡†å¤‡å¼€å§‹å¯¼å‡º...", 
                                                font=("Arial", 10))
            self.export_status_label.pack(pady=(0, 10))
            
            # è¿›åº¦æ¡
            self.export_progress_bar = ttk.Progressbar(progress_frame, length=400, mode='indeterminate')
            self.export_progress_bar.pack(pady=(0, 10))
            self.export_progress_bar.start()
            
            # è¯¦ç»†ä¿¡æ¯æ–‡æœ¬æ¡†
            self.export_detail_text = tk.Text(progress_frame, height=10, width=60, wrap="word")
            export_scrollbar = ttk.Scrollbar(progress_frame, orient="vertical", command=self.export_detail_text.yview)
            self.export_detail_text.configure(yscrollcommand=export_scrollbar.set)
            
            self.export_detail_text.pack(side="left", fill="both", expand=True, pady=(0, 10))
            export_scrollbar.pack(side="right", fill="y")
            
            # æŒ‰é’®æ¡†æ¶
            button_frame = tk.Frame(progress_frame)
            button_frame.pack(fill="x", pady=(10, 0))
            
            # å…³é—­æŒ‰é’®
            self.export_close_button = ttk.Button(button_frame, text="å…³é—­\nClose", 
                                                 command=self.close_export_progress, state="disabled")
            self.export_close_button.pack(side="right", padx=(5, 0))
            
            # å–æ¶ˆæŒ‰é’®
            self.export_cancel_button = ttk.Button(button_frame, text="å–æ¶ˆå¯¼å‡º\nCancel Export", 
                                                  command=self.cancel_export)
            self.export_cancel_button.pack(side="right", padx=(5, 0))
            
            # åˆå§‹åŒ–å¯¼å‡ºçŠ¶æ€
            self.export_cancelled = False
            self.export_completed = False
            
        except Exception as e:
            self.log_message(f"âœ— åˆ›å»ºè¿›åº¦çª—å£å¤±è´¥: {e}")
    
    def close_export_progress(self):
        """å…³é—­å¯¼å‡ºè¿›åº¦çª—å£"""
        try:
            if hasattr(self, 'export_progress_window') and self.export_progress_window:
                self.export_progress_window.destroy()
                self.export_progress_window = None
        except Exception as e:
            print(f"å…³é—­è¿›åº¦çª—å£å¤±è´¥: {e}")
    
    def cancel_export(self):
        """å–æ¶ˆå¯¼å‡º"""
        try:
            self.export_cancelled = True
            self.export_status_label.config(text="æ­£åœ¨å–æ¶ˆå¯¼å‡º...")
            self.export_cancel_button.config(state="disabled")
            self.log_message("âš ï¸ ç”¨æˆ·å–æ¶ˆäº†å¯¼å‡ºæ“ä½œ")
        except Exception as e:
            print(f"å–æ¶ˆå¯¼å‡ºå¤±è´¥: {e}")
    
    def update_export_progress(self, message):
        """æ›´æ–°å¯¼å‡ºè¿›åº¦"""
        try:
            if hasattr(self, 'export_detail_text') and self.export_detail_text:
                self.export_detail_text.insert(tk.END, message + "\n")
                self.export_detail_text.see(tk.END)
                self.export_status_label.config(text=message)
                # å¼ºåˆ¶æ›´æ–°ç•Œé¢
                self.root.update()
        except Exception as e:
            print(f"æ›´æ–°è¿›åº¦å¤±è´¥: {e}")
    
    def _background_export_worker(self):
        """åå°å¯¼å‡ºå·¥ä½œçº¿ç¨‹"""
        try:
            # åˆ›å»ºå¯¼å‡ºç›®å½•
            import os
            from datetime import datetime, timedelta
            
            export_dir = "historical_data_export"
            os.makedirs(export_dir, exist_ok=True)
            
            # å®šä¹‰æ”¯æŒçš„æ•°æ®åº“
            databases = [
                {"name": "GOGO", "display": "GOGO", "db_name": "sushi_gogo_pos_live"},
                {"name": "Express", "display": "Express", "db_name": "sushi_express_pos_live"},
                {"name": "PLUS", "display": "PLUS", "db_name": "sushi_plus_pos_live"}  # é¢„ç•™PLUSæ•°æ®åº“
            ]
            
            all_exported_data = {}
            
            # æ›´æ–°è¿›åº¦ï¼šå¼€å§‹å¤„ç†
            self.update_export_progress("ğŸš€ å¼€å§‹å¯¼å‡ºæ‰€æœ‰å†å²æ•°æ®...")
            
            # éå†æ¯ä¸ªæ•°æ®åº“
            for i, db_info in enumerate(databases):
                if self.export_cancelled:
                    self.update_export_progress("âš ï¸ å¯¼å‡ºå·²è¢«ç”¨æˆ·å–æ¶ˆ")
                    break
                
                db_name = db_info["name"]
                db_display = db_info["display"]
                db_connection = db_info["db_name"]
                
                self.update_export_progress(f"ğŸ—„ï¸ æ­£åœ¨å¤„ç† {db_display} æ•°æ®åº“... ({i+1}/{len(databases)})")
                
                # å°è¯•è¿æ¥åˆ°æ•°æ®åº“
                try:
                    # ä¿å­˜å½“å‰æ•°æ®åº“è®¾ç½®
                    original_db = self.db_manager.current_database
                    
                    # åˆ‡æ¢åˆ°ç›®æ ‡æ•°æ®åº“
                    self.db_manager.connect(db_connection)
                    
                    if not self.db_manager.connection:
                        self.update_export_progress(f"âš ï¸ æ— æ³•è¿æ¥åˆ° {db_display} æ•°æ®åº“ï¼Œè·³è¿‡")
                        continue
                    
                    # è·å–æ•°æ®æ—¥æœŸèŒƒå›´
                    date_range = self.get_available_date_range()
                    if not date_range:
                        self.update_export_progress(f"âš ï¸ {db_display} æ•°æ®åº“æ— æ•°æ®ï¼Œè·³è¿‡")
                        continue
                    
                    start_date, end_date = date_range
                    self.update_export_progress(f"ğŸ“… {db_display} æ•°æ®æ—¥æœŸèŒƒå›´: {start_date} åˆ° {end_date}")
                    
                    # ä¸ºæ¯ä¸ªæ•°æ®åº“åˆ›å»ºå­ç›®å½•
                    db_export_dir = f"{export_dir}/{db_display}"
                    os.makedirs(db_export_dir, exist_ok=True)
                    
                    # å¯¼å‡ºè¯¥æ•°æ®åº“çš„æ‰€æœ‰æ•°æ®
                    db_data = {
                        "database": db_display,
                        "date_range": (start_date, end_date),
                        "sales_data": [],
                        "monthly_summary": [],
                        "product_analysis": [],
                        "discount_analysis": [],
                        "payment_analysis": [],
                        "brand_analysis": []
                    }
                    
                    # è¶…å¿«é€Ÿå¯¼å‡ºï¼šåªå¯¼å‡ºæœ€è¿‘6ä¸ªæœˆæ•°æ®ï¼ŒåŒ…å«æ”¯ä»˜æ–¹å¼
                    from datetime import datetime, timedelta
                    end_datetime = datetime.strptime(end_date, '%Y-%m-%d')
                    start_datetime = end_datetime - timedelta(days=180)  # æœ€è¿‘6ä¸ªæœˆ
                    fast_start_date = start_datetime.strftime('%Y-%m-%d')
                    
                    self.update_export_progress(f"âš¡ è¶…å¿«é€Ÿæ¨¡å¼ï¼šå¯¼å‡º {db_display} æœ€è¿‘6ä¸ªæœˆæ•°æ® ({fast_start_date} åˆ° {end_date})")
                    
                    # ä½¿ç”¨æ–°çš„å¿«é€Ÿå¯¼å‡ºå‡½æ•°
                    self.export_sales_data_fast_mode(fast_start_date, end_date, db_export_dir, db_display, db_data)
                    
                    # å¯¼å‡ºæœˆåº¦æ±‡æ€»
                    self.update_export_progress(f"ğŸ“ˆ æ­£åœ¨å¯¼å‡º {db_display} æœˆåº¦æ±‡æ€»...")
                    self.export_monthly_summary_data(start_date, end_date, db_export_dir, db_display, db_data)
                    
                    # å¯¼å‡ºäº§å“åˆ†æ
                    self.update_export_progress(f"ğŸ›ï¸ æ­£åœ¨å¯¼å‡º {db_display} äº§å“åˆ†æ...")
                    self.export_product_analysis_data(start_date, end_date, db_export_dir, db_display, db_data)
                    
                    # å¯¼å‡ºæŠ˜æ‰£åˆ†æ
                    self.update_export_progress(f"ğŸ’° æ­£åœ¨å¯¼å‡º {db_display} æŠ˜æ‰£åˆ†æ...")
                    self.export_discount_analysis_data(start_date, end_date, db_export_dir, db_display, db_data)
                    
                    # å¯¼å‡ºæ”¯ä»˜åˆ†æï¼ˆå•ç‹¬å¤„ç†æ”¯ä»˜æ–¹å¼æ•°æ®ï¼‰
                    self.update_export_progress(f"ğŸ’³ æ­£åœ¨å¯¼å‡º {db_display} æ”¯ä»˜åˆ†æ...")
                    self.export_payment_analysis_data(start_date, end_date, db_export_dir, db_display, db_data)
                    
                    # å¯¼å‡ºå“ç‰Œåˆ†æ
                    self.update_export_progress(f"ğŸ·ï¸ æ­£åœ¨å¯¼å‡º {db_display} å“ç‰Œåˆ†æ...")
                    self.export_brand_analysis_data(start_date, end_date, db_export_dir, db_display, db_data)
                    
                    all_exported_data[db_display] = db_data
                    self.update_export_progress(f"âœ… {db_display} æ•°æ®åº“å¯¼å‡ºå®Œæˆ")
                    
                    # æ¢å¤åŸå§‹æ•°æ®åº“è®¾ç½®
                    self.db_manager.current_database = original_db
                    
                except Exception as e:
                    self.update_export_progress(f"âœ— {db_display} æ•°æ®åº“å¯¼å‡ºå¤±è´¥: {e}")
                    continue
            
            # ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
            if not self.export_cancelled:
                self.update_export_progress("ğŸ“‹ æ­£åœ¨ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š...")
                self.generate_export_summary(export_dir, all_exported_data)
                
                # å®Œæˆå¯¼å‡º
                self.update_export_progress(f"âœ… æ‰€æœ‰å†å²æ•°æ®å¯¼å‡ºå®Œæˆï¼ä¿å­˜ä½ç½®: {export_dir}")
                self.export_progress_bar.stop()
                self.export_progress_bar.config(mode='determinate', value=100)
                self.export_close_button.config(state="normal")
                self.export_cancel_button.config(state="disabled")
                self.export_completed = True
            else:
                self.update_export_progress("âš ï¸ å¯¼å‡ºå·²è¢«ç”¨æˆ·å–æ¶ˆ")
                self.export_progress_bar.stop()
                self.export_close_button.config(state="normal")
                self.export_cancel_button.config(state="disabled")
            
        except Exception as e:
            self.update_export_progress(f"âœ— å¯¼å‡ºå†å²æ•°æ®å¤±è´¥: {e}")
            self.export_progress_bar.stop()
            self.export_close_button.config(state="normal")
            self.export_cancel_button.config(state="disabled")
            import traceback
            traceback.print_exc()
    
    def export_sales_data_fast_mode(self, start_date, end_date, export_dir, db_display, db_data):
        """è¶…å¿«é€Ÿå¯¼å‡ºæ¨¡å¼ï¼šåªå¯¼å‡ºæœ€è¿‘æ•°æ®ï¼Œå¤§å¹…æå‡é€Ÿåº¦"""
        try:
            import pandas as pd
            from datetime import datetime, timedelta
            import gzip
            import pickle
            import os
            
            self.update_export_progress(f"âš¡ è¶…å¿«é€Ÿæ¨¡å¼ï¼šå¯¼å‡º {db_display} é”€å”®æ•°æ®...")
            
            # ç›´æ¥æŸ¥è¯¢æ•´ä¸ªæ—¥æœŸèŒƒå›´ï¼Œä¸åˆ†æœˆ
            sales_data = self.db_manager.get_sales_data(
                date_from=start_date,
                date_to=end_date,
                use_excel_cache=True
            )
            
            if sales_data:
                # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                for record in sales_data:
                    record['æ•°æ®åº“æ¥æº'] = db_display
                    record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                
                # ä¿å­˜åˆ°Excelå’Œå‹ç¼©æ–‡ä»¶
                df = pd.DataFrame(sales_data)
                excel_file = f"{export_dir}/{db_display}_sales_data_{start_date}_to_{end_date}.xlsx"
                compressed_file = f"{export_dir}/{db_display}_sales_data_{start_date}_to_{end_date}.pkl.gz"
                
                # ä¿å­˜Excelæ–‡ä»¶
                df.to_excel(excel_file, index=False)
                
                # ä¿å­˜å‹ç¼©æ–‡ä»¶
                with gzip.open(compressed_file, 'wb') as f:
                    pickle.dump(sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                
                # è®¡ç®—å‹ç¼©ç‡
                excel_size = os.path.getsize(excel_file) / (1024 * 1024)  # MB
                compressed_size = os.path.getsize(compressed_file) / (1024 * 1024)  # MB
                compression_ratio = (1 - compressed_size / excel_size) * 100 if excel_size > 0 else 0
                
                db_data["sales_data"] = sales_data
                self.update_export_progress(f"âœ… {db_display} é”€å”®æ•°æ®å¯¼å‡ºå®Œæˆï¼")
                self.update_export_progress(f"   ğŸ“Š è®°å½•æ•°: {len(sales_data)}")
                self.update_export_progress(f"   ğŸ“ Excel: {excel_size:.2f}MB")
                self.update_export_progress(f"   ğŸ—œï¸ å‹ç¼©: {compressed_size:.2f}MB (å‹ç¼©ç‡: {compression_ratio:.1f}%)")
            else:
                self.update_export_progress(f"âš ï¸ {db_display} æ²¡æœ‰é”€å”®æ•°æ®")
                
        except Exception as e:
            self.update_export_progress(f"âœ— {db_display} å¿«é€Ÿå¯¼å‡ºå¤±è´¥: {e}")
    
    def export_analysis_data_fast_mode(self, start_date, end_date, export_dir, db_display, db_data):
        """å¿«é€Ÿå¯¼å‡ºåˆ†ææ•°æ®"""
        try:
            self.update_export_progress(f"ğŸ“ˆ æ­£åœ¨å¯¼å‡º {db_display} åˆ†ææ•°æ®...")
            
            # è·å–æœˆåº¦æ±‡æ€»
            monthly_summary = self.get_monthly_summary_data()
            if monthly_summary:
                db_data["monthly_summary"] = monthly_summary
                self.update_export_progress(f"   âœ“ æœˆåº¦æ±‡æ€»: {len(monthly_summary)} æ¡")
            
            # è·å–äº§å“åˆ†æ
            product_analysis = self.get_product_analysis_data()
            if product_analysis:
                db_data["product_analysis"] = product_analysis
                self.update_export_progress(f"   âœ“ äº§å“åˆ†æ: {len(product_analysis)} æ¡")
            
            # è·å–æŠ˜æ‰£åˆ†æ
            discount_analysis = self.get_discount_analysis_data()
            if discount_analysis:
                db_data["discount_analysis"] = discount_analysis
                self.update_export_progress(f"   âœ“ æŠ˜æ‰£åˆ†æ: {len(discount_analysis)} æ¡")
            
            self.update_export_progress(f"âœ… {db_display} åˆ†ææ•°æ®å¯¼å‡ºå®Œæˆ")
            
        except Exception as e:
            self.update_export_progress(f"âœ— {db_display} åˆ†ææ•°æ®å¯¼å‡ºå¤±è´¥: {e}")

    def export_sales_data_by_period_fast(self, start_date, end_date, export_dir, db_display, db_data):
        """å¿«é€Ÿå¯¼å‡ºé”€å”®æ•°æ®ï¼ˆä¸åŒ…å«æ”¯ä»˜æ–¹å¼ï¼‰"""
        try:
            import pandas as pd
            from datetime import datetime, timedelta
            
            # æŒ‰æœˆä»½å¯¼å‡º
            current_date = datetime.strptime(start_date, '%Y-%m-%d')
            end_datetime = datetime.strptime(end_date, '%Y-%m-%d')
            
            all_sales_data = []
            
            while current_date <= end_datetime:
                if self.export_cancelled:
                    break
                    
                month_start = current_date.replace(day=1)
                if current_date.month == 12:
                    month_end = current_date.replace(year=current_date.year + 1, month=1, day=1) - timedelta(days=1)
                else:
                    month_end = current_date.replace(month=current_date.month + 1, day=1) - timedelta(days=1)
                
                # ç¡®ä¿ä¸è¶…è¿‡ç»“æŸæ—¥æœŸ
                if month_end > end_datetime:
                    month_end = end_datetime
                
                month_str = month_start.strftime('%Y-%m')
                self.update_export_progress(f"  æ­£åœ¨å¯¼å‡º {db_display} {month_str} é”€å”®æ•°æ®...")
                
                # è·å–è¯¥æœˆæ•°æ®ï¼ˆåŒ…å«æ”¯ä»˜æ–¹å¼ï¼‰
                sales_data = self.db_manager.get_sales_data(
                    date_from=month_start.strftime('%Y-%m-%d'),
                    date_to=month_end.strftime('%Y-%m-%d'),
                    use_excel_cache=True
                )
                
                # è®©çº¿ç¨‹é‡Šæ”¾æ§åˆ¶æƒï¼Œå…è®¸ç•Œé¢æ›´æ–°
                import time
                time.sleep(0.01)
                
                if sales_data:
                    # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                    for record in sales_data:
                        record['æ•°æ®åº“æ¥æº'] = db_display
                        record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                        # æ”¯ä»˜æ–¹å¼å·²åœ¨æŸ¥è¯¢ä¸­è·å–
                    
                    all_sales_data.extend(sales_data)
                    # ä¿å­˜æœˆåº¦æ–‡ä»¶
                    df = pd.DataFrame(sales_data)
                    excel_file = f"{export_dir}/sales_data_{month_str}.xlsx"
                    df.to_excel(excel_file, index=False)
                    
                    # å‹ç¼©æ–‡ä»¶
                    import gzip
                    import pickle
                    compressed_file = f"{export_dir}/sales_data_{month_str}.pkl.gz"
                    with gzip.open(compressed_file, 'wb') as f:
                        pickle.dump(sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                    
                    # è®¡ç®—å‹ç¼©ç‡
                    import os
                    excel_size = os.path.getsize(excel_file) / (1024 * 1024)  # MB
                    compressed_size = os.path.getsize(compressed_file) / (1024 * 1024)  # MB
                    compression_ratio = (1 - compressed_size / excel_size) * 100 if excel_size > 0 else 0
                    
                    self.update_export_progress(f"    âœ“ {db_display} {month_str}: {len(sales_data)} æ¡è®°å½•")
                    self.update_export_progress(f"    ğŸ“Š å‹ç¼©ç‡: {compression_ratio:.1f}% (Excel: {excel_size:.2f}MB â†’ å‹ç¼©: {compressed_size:.2f}MB)")
                
                # ç§»åŠ¨åˆ°ä¸‹ä¸ªæœˆ
                if current_date.month == 12:
                    current_date = current_date.replace(year=current_date.year + 1, month=1)
                else:
                    current_date = current_date.replace(month=current_date.month + 1)
            
            # ä¿å­˜å®Œæ•´æ–‡ä»¶
            if all_sales_data and not self.export_cancelled:
                df_all = pd.DataFrame(all_sales_data)
                excel_file = f"{export_dir}/all_sales_data_{start_date}_to_{end_date}.xlsx"
                df_all.to_excel(excel_file, index=False)
                
                # å‹ç¼©å®Œæ•´æ–‡ä»¶
                import gzip
                import pickle
                compressed_file = f"{export_dir}/all_sales_data_{start_date}_to_{end_date}.pkl.gz"
                with gzip.open(compressed_file, 'wb') as f:
                    pickle.dump(all_sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                
                # è®¡ç®—å‹ç¼©ç‡
                import os
                excel_size = os.path.getsize(excel_file) / (1024 * 1024)  # MB
                compressed_size = os.path.getsize(compressed_file) / (1024 * 1024)  # MB
                compression_ratio = (1 - compressed_size / excel_size) * 100 if excel_size > 0 else 0
                
                db_data["sales_data"] = all_sales_data
                self.update_export_progress(f"âœ“ {db_display} é”€å”®æ•°æ®å¯¼å‡ºå®Œæˆï¼Œæ€»è®¡ {len(all_sales_data)} æ¡è®°å½•")
                self.update_export_progress(f"ğŸ“Š å®Œæ•´æ–‡ä»¶å‹ç¼©ç‡: {compression_ratio:.1f}% (Excel: {excel_size:.2f}MB â†’ å‹ç¼©: {compressed_size:.2f}MB)")
            
        except Exception as e:
            self.update_export_progress(f"âœ— {db_display} å¯¼å‡ºé”€å”®æ•°æ®å¤±è´¥: {e}")
    
    def ultra_fast_export(self):
        """è¶…å¿«é€Ÿå¯¼å‡º - åªå¯¼å‡ºå½“å‰æ•°æ®åº“çš„åŸºæœ¬æ•°æ®"""
        try:
            import threading
            self.log_message("âš¡ å¼€å§‹è¶…å¿«é€Ÿå¯¼å‡º...")
            self.log_message("â„¹ï¸ åªå¯¼å‡ºå½“å‰æ•°æ®åº“çš„åŸºæœ¬æ•°æ®ï¼Œé€Ÿåº¦æå¿«")
            
            # åˆ›å»ºç®€å•çš„è¿›åº¦çª—å£
            self.create_simple_progress_window("è¶…å¿«é€Ÿå¯¼å‡ºä¸­...")
            
            # å¯åŠ¨åå°çº¿ç¨‹
            export_thread = threading.Thread(target=self._ultra_fast_export_worker, daemon=True)
            export_thread.start()
            
        except Exception as e:
            self.log_message(f"âœ— è¶…å¿«é€Ÿå¯¼å‡ºå¤±è´¥: {e}")
    
    def super_fast_export_6months(self):
        """6ä¸ªæœˆè¶…å¿«é€Ÿå¯¼å‡ºï¼ˆåŒ…å«æ”¯ä»˜æ–¹å¼ï¼‰"""
        try:
            import threading
            self.log_message("ğŸš€ å¼€å§‹6ä¸ªæœˆè¶…å¿«é€Ÿå¯¼å‡º...")
            self.log_message("â„¹ï¸ å¯¼å‡ºæœ€è¿‘6ä¸ªæœˆæ•°æ®ï¼ŒåŒ…å«æ”¯ä»˜æ–¹å¼ï¼Œé¢„è®¡è€—æ—¶2-5åˆ†é’Ÿ")
            
            # åˆ›å»ºè¿›åº¦çª—å£
            self.create_simple_progress_window("ğŸš€ 6ä¸ªæœˆå¿«é€Ÿå¯¼å‡º")
            
            # å¯åŠ¨åå°çº¿ç¨‹
            export_thread = threading.Thread(target=self._super_fast_export_6months_worker, daemon=True)
            export_thread.start()
            
        except Exception as e:
            self.log_message(f"âœ— 6ä¸ªæœˆå¿«é€Ÿå¯¼å‡ºå¤±è´¥: {e}")
    
    def staged_export_all_data(self):
        """åˆ†é˜¶æ®µå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼šå…ˆå¯¼å‡ºå…¶ä»–æ•°æ®ï¼Œæœ€åå¯¼å‡ºé”€å”®æ•°æ®"""
        try:
            import threading
            self.log_message("ğŸ“‹ å¼€å§‹åˆ†æ®µå¼å¯¼å‡ºæŒ‡å®šæ•°æ®...")
            self.log_message("â„¹ï¸ å¯¼å‡ºé¡ºåºï¼šPayment Analysis â†’ Discount Analysis â†’ Monthly Product Data â†’ Daily Product Data â†’ Weekly Product Data â†’ Daily Product Analysis â†’ Category Analysis â†’ Sales Raw Data")
            self.log_message("â„¹ï¸ é¢„è®¡æ€»è€—æ—¶ï¼š20-30åˆ†é’Ÿ")
            
            # åˆ›å»ºè¿›åº¦çª—å£
            self.create_simple_progress_window("ğŸ“‹ åˆ†æ®µå¼å¯¼å‡º")
            
            # å¯åŠ¨åå°çº¿ç¨‹
            export_thread = threading.Thread(target=self._staged_export_worker, daemon=True)
            export_thread.start()
            
        except Exception as e:
            self.log_message(f"âœ— åˆ†æ®µå¼å¯¼å‡ºå¤±è´¥: {e}")
    
    def _staged_export_worker(self):
        """åˆ†é˜¶æ®µå¯¼å‡ºå·¥ä½œçº¿ç¨‹"""
        try:
            import os
            import pandas as pd
            import gzip
            import pickle
            from datetime import datetime, timedelta
            
            export_dir = "staged_export_specific_data"
            os.makedirs(export_dir, exist_ok=True)
            
            # è·å–å½“å‰æ•°æ®åº“çš„åŸºæœ¬ä¿¡æ¯
            current_db = self.db_manager.current_database
            if current_db is None:
                current_db = self.selected_db.get()  # ä½¿ç”¨UIé€‰æ‹©çš„æ•°æ®åº“
            
            if current_db is None or current_db == "":
                self.update_simple_progress("âš ï¸ æœªé€‰æ‹©æ•°æ®åº“")
                return
                
            db_display = "GOGO" if "gogo" in current_db.lower() else "Express"
            
            self.update_simple_progress(f"ğŸ“Š å¼€å§‹åˆ†é˜¶æ®µå¯¼å‡º {db_display} æ•°æ®åº“...")
            
            # å…ˆè¿æ¥åˆ°æ•°æ®åº“
            self.update_simple_progress("ğŸ”— æ­£åœ¨è¿æ¥åˆ°æ•°æ®åº“...")
            if not self.db_manager.connect(current_db):
                self.update_simple_progress("âš ï¸ æ— æ³•è¿æ¥åˆ°æ•°æ®åº“")
                return
            
            # è·å–æ—¥æœŸèŒƒå›´
            self.update_simple_progress("ğŸ“… æ­£åœ¨è·å–æ•°æ®æ—¥æœŸèŒƒå›´...")
            date_range = self.get_available_date_range()
            if not date_range:
                self.update_simple_progress("âš ï¸ æ•°æ®åº“æ— æ•°æ®")
                self.db_manager.disconnect()
                return
            
            start_date, end_date = date_range
            self.update_simple_progress(f"ğŸ“… æ•°æ®èŒƒå›´: {start_date} åˆ° {end_date}")
            
            # é˜¶æ®µ1ï¼šPayment Analysis
            self.update_simple_progress("ğŸ’³ é˜¶æ®µ1ï¼šå¯¼å‡ºPayment Analysis...")
            try:
                payment_data = self.db_manager.get_payment_analysis(
                    date_from=start_date,
                    date_to=end_date,
                    outlet_filters=None,
                    product_filters=None,
                    month_filters=None,
                    category_filters=None,
                    payment_filters=None
                )
                
                if payment_data:
                    df_payment = pd.DataFrame(payment_data)
                    payment_file = f"{export_dir}/{db_display}_payment_analysis.xlsx"
                    df_payment.to_excel(payment_file, index=False)
                    self.update_simple_progress(f"   âœ… Payment Analysis: {len(payment_data)} æ¡è®°å½•")
                    self.log_message(f"âœ… Payment Analysiså¯¼å‡ºå®Œæˆ: {payment_file}")
                else:
                    self.update_simple_progress("   âš ï¸ Payment Analysisæ•°æ®ä¸ºç©º")
            except Exception as e:
                self.update_simple_progress(f"   âœ— Payment Analysiså¯¼å‡ºå¤±è´¥: {e}")
            
            # é˜¶æ®µ2ï¼šDiscount Analysis
            self.update_simple_progress("ğŸ’° é˜¶æ®µ2ï¼šå¯¼å‡ºDiscount Analysis...")
            try:
                discount_data = self.db_manager.get_discount_analysis(
                    date_from=start_date,
                    date_to=end_date,
                    outlet_filters=None,
                    product_filters=None,
                    month_filters=None,
                    category_filters=None,
                    payment_filters=None
                )
                
                if discount_data:
                    df_discount = pd.DataFrame(discount_data)
                    discount_file = f"{export_dir}/{db_display}_discount_analysis.xlsx"
                    df_discount.to_excel(discount_file, index=False)
                    self.update_simple_progress(f"   âœ… Discount Analysis: {len(discount_data)} æ¡è®°å½•")
                    self.log_message(f"âœ… Discount Analysiså¯¼å‡ºå®Œæˆ: {discount_file}")
                else:
                    self.update_simple_progress("   âš ï¸ Discount Analysisæ•°æ®ä¸ºç©º")
            except Exception as e:
                self.update_simple_progress(f"   âœ— Discount Analysiså¯¼å‡ºå¤±è´¥: {e}")
            
            # é˜¶æ®µ3ï¼šMonthly Product Data (æœˆ-é”€å”®æ•°æ®)
            self.update_simple_progress("ğŸ“Š é˜¶æ®µ3ï¼šå¯¼å‡ºMonthly Product Data...")
            try:
                monthly_data = self.db_manager.get_monthly_summary_optimized(
                    date_from=start_date,
                    date_to=end_date,
                    outlet_filters=None,
                    product_filters=None,
                    month_filters=None,
                    category_filters=None,
                    payment_filters=None
                )
                
                if monthly_data:
                    df_monthly = pd.DataFrame(monthly_data)
                    monthly_file = f"{export_dir}/{db_display}_monthly_product_data.xlsx"
                    df_monthly.to_excel(monthly_file, index=False)
                    self.update_simple_progress(f"   âœ… Monthly Product Data: {len(monthly_data)} æ¡è®°å½•")
                    self.log_message(f"âœ… Monthly Product Dataå¯¼å‡ºå®Œæˆ: {monthly_file}")
                else:
                    self.update_simple_progress("   âš ï¸ Monthly Product Dataæ•°æ®ä¸ºç©º")
            except Exception as e:
                self.update_simple_progress(f"   âœ— Monthly Product Dataå¯¼å‡ºå¤±è´¥: {e}")
            
            # é˜¶æ®µ4ï¼šDaily Product Data (æ—¥-äº§å“æ•°æ®)
            self.update_simple_progress("ğŸ“… é˜¶æ®µ4ï¼šå¯¼å‡ºDaily Product Data...")
            try:
                daily_product_data = self.db_manager.get_product_overview(
                    date_from=start_date,
                    date_to=end_date,
                    outlet_filters=None,
                    month_filters=None,
                    weekday_filters=None,
                    category_filters=None,
                    payment_filters=None
                )
                
                if daily_product_data:
                    df_daily = pd.DataFrame(daily_product_data)
                    daily_file = f"{export_dir}/{db_display}_daily_product_data.xlsx"
                    df_daily.to_excel(daily_file, index=False)
                    self.update_simple_progress(f"   âœ… Daily Product Data: {len(daily_product_data)} æ¡è®°å½•")
                    self.log_message(f"âœ… Daily Product Dataå¯¼å‡ºå®Œæˆ: {daily_file}")
                else:
                    self.update_simple_progress("   âš ï¸ Daily Product Dataæ•°æ®ä¸ºç©º")
            except Exception as e:
                self.update_simple_progress(f"   âœ— Daily Product Dataå¯¼å‡ºå¤±è´¥: {e}")
            
            # é˜¶æ®µ5ï¼šWeekly Product Data (å‘¨-äº§å“æ•°æ®)
            self.update_simple_progress("ğŸ“ˆ é˜¶æ®µ5ï¼šå¯¼å‡ºWeekly Product Data...")
            try:
                weekly_product_data = self.db_manager.get_weekly_product_data(
                    date_from=start_date,
                    date_to=end_date,
                    outlet_filters=None,
                    product_filters=None,
                    month_filters=None,
                    category_filters=None,
                    payment_filters=None
                )
                
                if weekly_product_data:
                    df_weekly = pd.DataFrame(weekly_product_data)
                    weekly_file = f"{export_dir}/{db_display}_weekly_product_data.xlsx"
                    df_weekly.to_excel(weekly_file, index=False)
                    self.update_simple_progress(f"   âœ… Weekly Product Data: {len(weekly_product_data)} æ¡è®°å½•")
                    self.log_message(f"âœ… Weekly Product Dataå¯¼å‡ºå®Œæˆ: {weekly_file}")
                else:
                    self.update_simple_progress("   âš ï¸ Weekly Product Dataæ•°æ®ä¸ºç©º")
            except Exception as e:
                self.update_simple_progress(f"   âœ— Weekly Product Dataå¯¼å‡ºå¤±è´¥: {e}")
            
            # é˜¶æ®µ6ï¼šDaily Product Analysis (æ—¥-äº§å“åˆ†æ)
            self.update_simple_progress("ğŸ” é˜¶æ®µ6ï¼šå¯¼å‡ºDaily Product Analysis...")
            try:
                daily_analysis_data = self.db_manager.get_sales_tc_analysis(
                    date_from=start_date,
                    date_to=end_date,
                    outlet_filters=None,
                    product_filters=None,
                    month_filters=None,
                    weekday_filters=None,
                    category_filters=None,
                    payment_filters=None
                )
                
                if daily_analysis_data:
                    df_daily_analysis = pd.DataFrame(daily_analysis_data)
                    daily_analysis_file = f"{export_dir}/{db_display}_daily_product_analysis.xlsx"
                    df_daily_analysis.to_excel(daily_analysis_file, index=False)
                    self.update_simple_progress(f"   âœ… Daily Product Analysis: {len(daily_analysis_data)} æ¡è®°å½•")
                    self.log_message(f"âœ… Daily Product Analysiså¯¼å‡ºå®Œæˆ: {daily_analysis_file}")
                else:
                    self.update_simple_progress("   âš ï¸ Daily Product Analysisæ•°æ®ä¸ºç©º")
            except Exception as e:
                self.update_simple_progress(f"   âœ— Daily Product Analysiså¯¼å‡ºå¤±è´¥: {e}")
            
            # é˜¶æ®µ7ï¼šCategory Analysis (ç±»åˆ«åˆ†æ)
            self.update_simple_progress("ğŸ“‚ é˜¶æ®µ7ï¼šå¯¼å‡ºCategory Analysis...")
            try:
                category_data = self.db_manager.get_category_analysis(
                    date_from=start_date,
                    date_to=end_date,
                    outlet_filters=None,
                    product_filters=None,
                    month_filters=None,
                    weekday_filters=None,
                    category_filters=None,
                    payment_filters=None
                )
                
                if category_data:
                    df_category = pd.DataFrame(category_data)
                    category_file = f"{export_dir}/{db_display}_category_analysis.xlsx"
                    df_category.to_excel(category_file, index=False)
                    self.update_simple_progress(f"   âœ… Category Analysis: {len(category_data)} æ¡è®°å½•")
                    self.log_message(f"âœ… Category Analysiså¯¼å‡ºå®Œæˆ: {category_file}")
                else:
                    self.update_simple_progress("   âš ï¸ Category Analysisæ•°æ®ä¸ºç©º")
            except Exception as e:
                self.update_simple_progress(f"   âœ— Category Analysiså¯¼å‡ºå¤±è´¥: {e}")
            
            # é˜¶æ®µ8ï¼šSales Raw Data (æœ€åå¯¼å‡ºï¼ŒåŒ…å«æ”¯ä»˜æ–¹å¼)
            self.update_simple_progress("ğŸ›’ é˜¶æ®µ8ï¼šå¯¼å‡ºSales Raw Dataï¼ˆåŒ…å«æ”¯ä»˜æ–¹å¼ï¼Œæœ€è€—æ—¶ï¼‰...")
            self.update_simple_progress("   â° é¢„è®¡éœ€è¦10-15åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...")
            
            # æŒ‰æœˆå¯¼å‡ºé”€å”®æ•°æ®
            current_date = datetime.strptime(start_date, '%Y-%m-%d')
            end_datetime = datetime.strptime(end_date, '%Y-%m-%d')
            
            all_sales_data = []
            month_count = 0
            
            while current_date <= end_datetime:
                month_start = current_date.replace(day=1)
                if current_date.month == 12:
                    month_end = current_date.replace(year=current_date.year + 1, month=1, day=1) - timedelta(days=1)
                else:
                    month_end = current_date.replace(month=current_date.month + 1, day=1) - timedelta(days=1)
                
                # ç¡®ä¿ä¸è¶…è¿‡ç»“æŸæ—¥æœŸ
                if month_end > end_datetime:
                    month_end = end_datetime
                
                month_str = month_start.strftime('%Y-%m')
                month_count += 1
                self.update_simple_progress(f"   ğŸ“… æ­£åœ¨å¯¼å‡º {month_str} é”€å”®æ•°æ®... ({month_count})")
                
                # è·å–è¯¥æœˆæ•°æ®
                sales_data = self.db_manager.get_sales_data(
                    date_from=month_start.strftime('%Y-%m-%d'),
                    date_to=month_end.strftime('%Y-%m-%d'),
                    use_excel_cache=True
                )
                
                if sales_data:
                    # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                    for record in sales_data:
                        record['æ•°æ®åº“æ¥æº'] = db_display
                        record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                    
                    all_sales_data.extend(sales_data)
                    
                    # ä¿å­˜æœˆåº¦æ–‡ä»¶
                    df_month = pd.DataFrame(sales_data)
                    month_file = f"{export_dir}/{db_display}_sales_raw_{month_str}.xlsx"
                    df_month.to_excel(month_file, index=False)
                    
                    # å‹ç¼©æœˆåº¦æ–‡ä»¶
                    compressed_file = f"{export_dir}/{db_display}_sales_raw_{month_str}.pkl.gz"
                    with gzip.open(compressed_file, 'wb') as f:
                        pickle.dump(sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                    
                    self.update_simple_progress(f"   âœ… {month_str}: {len(sales_data)} æ¡è®°å½•")
                
                # ç§»åŠ¨åˆ°ä¸‹ä¸ªæœˆ
                if current_date.month == 12:
                    current_date = current_date.replace(year=current_date.year + 1, month=1)
                else:
                    current_date = current_date.replace(month=current_date.month + 1)
            
            # ä¿å­˜å®Œæ•´é”€å”®æ•°æ®æ–‡ä»¶
            if all_sales_data:
                self.update_simple_progress("ğŸ’¾ æ­£åœ¨ä¿å­˜å®Œæ•´é”€å”®æ•°æ®æ–‡ä»¶...")
                
                df_all = pd.DataFrame(all_sales_data)
                all_file = f"{export_dir}/{db_display}_all_sales_raw_data.xlsx"
                df_all.to_excel(all_file, index=False)
                
                # å‹ç¼©å®Œæ•´æ–‡ä»¶
                compressed_all_file = f"{export_dir}/{db_display}_all_sales_raw_data.pkl.gz"
                with gzip.open(compressed_all_file, 'wb') as f:
                    pickle.dump(all_sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                
                # è®¡ç®—å‹ç¼©ç‡
                excel_size = os.path.getsize(all_file) / (1024 * 1024)  # MB
                compressed_size = os.path.getsize(compressed_all_file) / (1024 * 1024)  # MB
                compression_ratio = (1 - compressed_size / excel_size) * 100 if excel_size > 0 else 0
                
                self.update_simple_progress(f"âœ… å®Œæ•´Sales Raw Data: {len(all_sales_data)} æ¡è®°å½•")
                self.update_simple_progress(f"ğŸ“ Excel: {excel_size:.2f}MB")
                self.update_simple_progress(f"ğŸ—œï¸ å‹ç¼©: {compressed_size:.2f}MB (å‹ç¼©ç‡: {compression_ratio:.1f}%)")
                
                self.log_message(f"âœ… å®Œæ•´Sales Raw Dataå¯¼å‡ºå®Œæˆ:")
                self.log_message(f"   - Excelæ–‡ä»¶: {all_file} ({excel_size:.2f} MB)")
                self.log_message(f"   - å‹ç¼©æ–‡ä»¶: {compressed_all_file} ({compressed_size:.2f} MB)")
                self.log_message(f"   - å‹ç¼©ç‡: {compression_ratio:.1f}%")
                self.log_message(f"   - æ€»è®°å½•æ•°: {len(all_sales_data)}")
                self.log_message(f"   - åŒ…å«æ”¯ä»˜æ–¹å¼: âœ…")
            
            # å®Œæˆ
            self.update_simple_progress("ğŸ‰ åˆ†æ®µå¼å¯¼å‡ºå®Œæˆï¼")
            self.simple_progress_bar.stop()
            self.simple_progress_bar.config(mode='determinate', value=100)
            self.simple_close_button.config(state="normal")
            
            # æ–­å¼€æ•°æ®åº“è¿æ¥
            self.db_manager.disconnect()
            
            self.log_message(f"ğŸ‰ åˆ†æ®µå¼å¯¼å‡ºå®Œæˆï¼æ‰€æœ‰æ•°æ®å·²ä¿å­˜åˆ°: {export_dir}/")
            
        except Exception as e:
            self.update_simple_progress(f"âœ— å¯¼å‡ºå¤±è´¥: {e}")
            self.simple_progress_bar.stop()
            self.simple_close_button.config(state="normal")
            self.log_message(f"âœ— åˆ†æ®µå¼å¯¼å‡ºå¤±è´¥: {e}")
    
    def new_staged_export(self):
        """æ–°çš„åˆ†æ®µå¼å¯¼å‡ºï¼šå…ˆå¯¼å‡ºæ‰€æœ‰æ•°æ®åº“çš„å‰7ä¸ªæŠ¥å‘Šï¼Œæœ€åå¯¼å‡ºSales Raw Data"""
        try:
            import threading
            self.log_message("ğŸ“‹ å¼€å§‹æ–°çš„åˆ†æ®µå¼å¯¼å‡º...")
            self.log_message("â„¹ï¸ ç­–ç•¥ï¼šå…ˆå¯¼å‡ºæ‰€æœ‰æ•°æ®åº“çš„å‰7ä¸ªæŠ¥å‘Šï¼Œæœ€åå¯¼å‡ºSales Raw Data")
            self.log_message("â„¹ï¸ é¢„è®¡æ€»è€—æ—¶ï¼š20-30åˆ†é’Ÿ")
            
            # åˆ›å»ºè¿›åº¦çª—å£
            self.create_simple_progress_window("ğŸ“‹ æ–°åˆ†æ®µå¼å¯¼å‡º")
            
            # å¯åŠ¨åå°çº¿ç¨‹
            export_thread = threading.Thread(target=self._new_staged_export_worker, daemon=True)
            export_thread.start()
            
        except Exception as e:
            self.log_message(f"âœ— æ–°åˆ†æ®µå¼å¯¼å‡ºå¤±è´¥: {e}")
    
    def _new_staged_export_worker(self):
        """æ–°çš„åˆ†æ®µå¼å¯¼å‡ºå·¥ä½œçº¿ç¨‹"""
        try:
            import os
            import pandas as pd
            import gzip
            import pickle
            from datetime import datetime, timedelta
            
            export_dir = "new_staged_export_specific_data"
            os.makedirs(export_dir, exist_ok=True)
            
            # å®šä¹‰è¦å¤„ç†çš„æ•°æ®åº“åˆ—è¡¨
            databases = [
                {"name": "GOGO", "db": "sushi_gogo_pos_live"},
                {"name": "Express", "db": "sushi_express_pos_live"},
                {"name": "PLUS", "db": "sushi_plus_pos_live"}  # æœªæ¥çš„æ•°æ®åº“
            ]
            
            self.update_simple_progress("ğŸš€ å¼€å§‹æ–°çš„åˆ†æ®µå¼å¯¼å‡º...")
            self.update_simple_progress("ğŸ“‹ ç­–ç•¥ï¼šå…ˆå¯¼å‡ºæ‰€æœ‰æ•°æ®åº“çš„å‰7ä¸ªæŠ¥å‘Šï¼Œæœ€åå¯¼å‡ºSales Raw Data")
            
            # è·å–æ—¥æœŸèŒƒå›´ï¼ˆä½¿ç”¨å½“å‰é€‰æ‹©çš„æ•°æ®åº“ï¼‰
            current_db = self.selected_db.get()
            if not current_db:
                self.update_simple_progress("âš ï¸ æœªé€‰æ‹©æ•°æ®åº“")
                return
                
            # å…ˆè¿æ¥åˆ°å½“å‰æ•°æ®åº“è·å–æ—¥æœŸèŒƒå›´
            if not self.db_manager.connect(current_db):
                self.update_simple_progress("âš ï¸ æ— æ³•è¿æ¥åˆ°æ•°æ®åº“")
                return
            
            self.update_simple_progress("ğŸ“… æ­£åœ¨è·å–æ•°æ®æ—¥æœŸèŒƒå›´...")
            date_range = self.get_available_date_range()
            if not date_range:
                self.update_simple_progress("âš ï¸ æ•°æ®åº“æ— æ•°æ®")
                self.db_manager.disconnect()
                return
            
            start_date, end_date = date_range
            self.update_simple_progress(f"ğŸ“… æ•°æ®èŒƒå›´: {start_date} åˆ° {end_date}")
            
            # é˜¶æ®µ1-7ï¼šå¯¼å‡ºæ‰€æœ‰æ•°æ®åº“çš„åˆ†ææŠ¥å‘Šï¼ˆä¸åŒ…å«Sales Raw Dataï¼‰
            for db_info in databases:
                db_name = db_info["name"]
                db_connection = db_info["db"]
                
                self.update_simple_progress(f"ğŸ—„ï¸ æ­£åœ¨å¤„ç† {db_name} æ•°æ®åº“...")
                
                # è¿æ¥åˆ°å½“å‰æ•°æ®åº“
                self.update_simple_progress(f"ğŸ”— æ­£åœ¨è¿æ¥åˆ° {db_name} æ•°æ®åº“...")
                if not self.db_manager.connect(db_connection):
                    self.update_simple_progress(f"âš ï¸ æ— æ³•è¿æ¥åˆ° {db_name} æ•°æ®åº“ï¼Œè·³è¿‡")
                    continue
                self.update_simple_progress(f"âœ… {db_name} æ•°æ®åº“è¿æ¥æˆåŠŸ")
                
                # é˜¶æ®µ1ï¼šPayment Analysis
                self.update_simple_progress(f"ğŸ’³ {db_name} - é˜¶æ®µ1ï¼šå¯¼å‡ºPayment Analysis...")
                try:
                    payment_data = self.db_manager.get_payment_summary(
                        date_from=start_date, date_to=end_date,
                        outlet_filters=None, month_filters=None,
                        category_filters=None, payment_filters=None
                    )
                    if payment_data:
                        df_payment = pd.DataFrame(payment_data)
                        payment_file = f"{export_dir}/{db_name}_payment_analysis.xlsx"
                        df_payment.to_excel(payment_file, index=False)
                        self.update_simple_progress(f"   âœ… {db_name} Payment Analysis: {len(payment_data)} æ¡è®°å½•")
                    else:
                        self.update_simple_progress(f"   âš ï¸ {db_name} Payment Analysisæ•°æ®ä¸ºç©º")
                except Exception as e:
                    self.update_simple_progress(f"   âœ— {db_name} Payment Analysiså¯¼å‡ºå¤±è´¥: {e}")
                    self.log_message(f"âœ— {db_name} Payment Analysiså¯¼å‡ºå¤±è´¥: {e}")
                
                # é˜¶æ®µ2ï¼šDiscount Analysis
                self.update_simple_progress(f"ğŸ’° {db_name} - é˜¶æ®µ2ï¼šå¯¼å‡ºDiscount Analysis...")
                try:
                    discount_data = self.db_manager.get_discount_analysis(
                        date_from=start_date, date_to=end_date,
                        outlet_filters=None, month_filters=None,
                        weekday_filters=None, category_filters=None, payment_filters=None
                    )
                    if discount_data:
                        df_discount = pd.DataFrame(discount_data)
                        discount_file = f"{export_dir}/{db_name}_discount_analysis.xlsx"
                        df_discount.to_excel(discount_file, index=False)
                        self.update_simple_progress(f"   âœ… {db_name} Discount Analysis: {len(discount_data)} æ¡è®°å½•")
                    else:
                        self.update_simple_progress(f"   âš ï¸ {db_name} Discount Analysisæ•°æ®ä¸ºç©º")
                except Exception as e:
                    self.update_simple_progress(f"   âœ— {db_name} Discount Analysiså¯¼å‡ºå¤±è´¥: {e}")
                    self.log_message(f"âœ— {db_name} Discount Analysiså¯¼å‡ºå¤±è´¥: {e}")
                
                # é˜¶æ®µ3ï¼šMonthly Product Data
                self.update_simple_progress(f"ğŸ“Š {db_name} - é˜¶æ®µ3ï¼šå¯¼å‡ºMonthly Product Data...")
                try:
                    monthly_data = self.db_manager.get_monthly_summary_optimized(
                        date_from=start_date, date_to=end_date,
                        outlet_filters=None, product_filters=None, month_filters=None,
                        category_filters=None, payment_filters=None
                    )
                    if monthly_data:
                        df_monthly = pd.DataFrame(monthly_data)
                        monthly_file = f"{export_dir}/{db_name}_monthly_product_data.xlsx"
                        df_monthly.to_excel(monthly_file, index=False)
                        self.update_simple_progress(f"   âœ… {db_name} Monthly Product Data: {len(monthly_data)} æ¡è®°å½•")
                    else:
                        self.update_simple_progress(f"   âš ï¸ {db_name} Monthly Product Dataæ•°æ®ä¸ºç©º")
                except Exception as e:
                    self.update_simple_progress(f"   âœ— {db_name} Monthly Product Dataå¯¼å‡ºå¤±è´¥: {e}")
                
                # é˜¶æ®µ4ï¼šDaily Product Data
                self.update_simple_progress(f"ğŸ“… {db_name} - é˜¶æ®µ4ï¼šå¯¼å‡ºDaily Product Data...")
                try:
                    daily_product_data = self.db_manager.get_product_overview(
                        date_from=start_date, date_to=end_date,
                        outlet_filters=None, month_filters=None, weekday_filters=None,
                        category_filters=None, payment_filters=None
                    )
                    if daily_product_data:
                        df_daily = pd.DataFrame(daily_product_data)
                        daily_file = f"{export_dir}/{db_name}_daily_product_data.xlsx"
                        df_daily.to_excel(daily_file, index=False)
                        self.update_simple_progress(f"   âœ… {db_name} Daily Product Data: {len(daily_product_data)} æ¡è®°å½•")
                    else:
                        self.update_simple_progress(f"   âš ï¸ {db_name} Daily Product Dataæ•°æ®ä¸ºç©º")
                except Exception as e:
                    self.update_simple_progress(f"   âœ— {db_name} Daily Product Dataå¯¼å‡ºå¤±è´¥: {e}")
                
                # é˜¶æ®µ5ï¼šWeekly Product Data
                self.update_simple_progress(f"ğŸ“ˆ {db_name} - é˜¶æ®µ5ï¼šå¯¼å‡ºWeekly Product Data...")
                try:
                    weekly_product_data = self.db_manager.get_weekly_product_data(
                        date_from=start_date, date_to=end_date,
                        outlet_filters=None, month_filters=None,
                        weekday_filters=None, category_filters=None, payment_filters=None
                    )
                    if weekly_product_data:
                        df_weekly = pd.DataFrame(weekly_product_data)
                        weekly_file = f"{export_dir}/{db_name}_weekly_product_data.xlsx"
                        df_weekly.to_excel(weekly_file, index=False)
                        self.update_simple_progress(f"   âœ… {db_name} Weekly Product Data: {len(weekly_product_data)} æ¡è®°å½•")
                    else:
                        self.update_simple_progress(f"   âš ï¸ {db_name} Weekly Product Dataæ•°æ®ä¸ºç©º")
                except Exception as e:
                    self.update_simple_progress(f"   âœ— {db_name} Weekly Product Dataå¯¼å‡ºå¤±è´¥: {e}")
                
                # é˜¶æ®µ6ï¼šDaily Product Analysis
                self.update_simple_progress(f"ğŸ” {db_name} - é˜¶æ®µ6ï¼šå¯¼å‡ºDaily Product Analysis...")
                try:
                    daily_analysis_data = self.db_manager.get_sales_tc_analysis(
                        date_from=start_date, date_to=end_date,
                        outlet_filters=None, product_filters=None, month_filters=None,
                        weekday_filters=None, category_filters=None, payment_filters=None
                    )
                    if daily_analysis_data:
                        df_daily_analysis = pd.DataFrame(daily_analysis_data)
                        daily_analysis_file = f"{export_dir}/{db_name}_daily_product_analysis.xlsx"
                        df_daily_analysis.to_excel(daily_analysis_file, index=False)
                        self.update_simple_progress(f"   âœ… {db_name} Daily Product Analysis: {len(daily_analysis_data)} æ¡è®°å½•")
                    else:
                        self.update_simple_progress(f"   âš ï¸ {db_name} Daily Product Analysisæ•°æ®ä¸ºç©º")
                except Exception as e:
                    self.update_simple_progress(f"   âœ— {db_name} Daily Product Analysiså¯¼å‡ºå¤±è´¥: {e}")
                
                # é˜¶æ®µ7ï¼šCategory Analysis
                self.update_simple_progress(f"ğŸ“‚ {db_name} - é˜¶æ®µ7ï¼šå¯¼å‡ºCategory Analysis...")
                try:
                    category_data = self.db_manager.get_category_analysis(
                        date_from=start_date, date_to=end_date,
                        outlet_filters=None, month_filters=None,
                        weekday_filters=None, category_filters=None, payment_filters=None
                    )
                    if category_data:
                        df_category = pd.DataFrame(category_data)
                        category_file = f"{export_dir}/{db_name}_category_analysis.xlsx"
                        df_category.to_excel(category_file, index=False)
                        self.update_simple_progress(f"   âœ… {db_name} Category Analysis: {len(category_data)} æ¡è®°å½•")
                    else:
                        self.update_simple_progress(f"   âš ï¸ {db_name} Category Analysisæ•°æ®ä¸ºç©º")
                except Exception as e:
                    self.update_simple_progress(f"   âœ— {db_name} Category Analysiså¯¼å‡ºå¤±è´¥: {e}")
                
                self.update_simple_progress(f"âœ… {db_name} æ•°æ®åº“å‰7ä¸ªæŠ¥å‘Šå¯¼å‡ºå®Œæˆ")
            
            # é˜¶æ®µ8ï¼šæœ€åå¯¼å‡ºæ‰€æœ‰æ•°æ®åº“çš„Sales Raw Data
            self.update_simple_progress("ğŸ›’ é˜¶æ®µ8ï¼šå¯¼å‡ºæ‰€æœ‰æ•°æ®åº“çš„Sales Raw Dataï¼ˆåŒ…å«æ”¯ä»˜æ–¹å¼ï¼Œæœ€è€—æ—¶ï¼‰...")
            self.update_simple_progress("   â° é¢„è®¡éœ€è¦15-25åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...")
            
            for db_info in databases:
                db_name = db_info["name"]
                db_connection = db_info["db"]
                
                self.update_simple_progress(f"ğŸ›’ æ­£åœ¨å¯¼å‡º {db_name} çš„Sales Raw Data...")
                
                # è¿æ¥åˆ°å½“å‰æ•°æ®åº“
                self.update_simple_progress(f"ğŸ”— æ­£åœ¨è¿æ¥åˆ° {db_name} æ•°æ®åº“...")
                if not self.db_manager.connect(db_connection):
                    self.update_simple_progress(f"âš ï¸ æ— æ³•è¿æ¥åˆ° {db_name} æ•°æ®åº“ï¼Œè·³è¿‡Sales Raw Data")
                    continue
                self.update_simple_progress(f"âœ… {db_name} æ•°æ®åº“è¿æ¥æˆåŠŸ")
                
                # æŒ‰æœˆå¯¼å‡ºé”€å”®æ•°æ®
                current_date = datetime.strptime(start_date, '%Y-%m-%d')
                end_datetime = datetime.strptime(end_date, '%Y-%m-%d')
                
                all_sales_data = []
                month_count = 0
                
                while current_date <= end_datetime:
                    month_start = current_date.replace(day=1)
                    if current_date.month == 12:
                        month_end = current_date.replace(year=current_date.year + 1, month=1, day=1) - timedelta(days=1)
                    else:
                        month_end = current_date.replace(month=current_date.month + 1, day=1) - timedelta(days=1)
                    
                    # ç¡®ä¿ä¸è¶…è¿‡ç»“æŸæ—¥æœŸ
                    if month_end > end_datetime:
                        month_end = end_datetime
                    
                    month_str = month_start.strftime('%Y-%m')
                    month_count += 1
                    self.update_simple_progress(f"   ğŸ“… {db_name} - æ­£åœ¨å¯¼å‡º {month_str} é”€å”®æ•°æ®... ({month_count})")
                    
                    # è·å–è¯¥æœˆæ•°æ®ï¼ˆåŒ…å«æ”¯ä»˜æ–¹å¼ï¼‰
                    sales_data = self.db_manager.get_sales_data(
                        date_from=month_start.strftime('%Y-%m-%d'),
                        date_to=month_end.strftime('%Y-%m-%d'),
                    
                        use_excel_cache=True
                    )
                    
                    if sales_data:
                        # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                        for record in sales_data:
                            record['æ•°æ®åº“æ¥æº'] = db_name
                            record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_name
                        
                        all_sales_data.extend(sales_data)
                        
                        # ä¿å­˜æœˆåº¦æ–‡ä»¶
                        df_month = pd.DataFrame(sales_data)
                        month_file = f"{export_dir}/{db_name}_sales_raw_{month_str}.xlsx"
                        df_month.to_excel(month_file, index=False)
                        
                        # å‹ç¼©æœˆåº¦æ–‡ä»¶
                        compressed_file = f"{export_dir}/{db_name}_sales_raw_{month_str}.pkl.gz"
                        with gzip.open(compressed_file, 'wb') as f:
                            pickle.dump(sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                        
                        self.update_simple_progress(f"   âœ… {db_name} {month_str}: {len(sales_data)} æ¡è®°å½•")
                    
                    # ç§»åŠ¨åˆ°ä¸‹ä¸ªæœˆ
                    if current_date.month == 12:
                        current_date = current_date.replace(year=current_date.year + 1, month=1)
                    else:
                        current_date = current_date.replace(month=current_date.month + 1)
                
                # ä¿å­˜å®Œæ•´é”€å”®æ•°æ®æ–‡ä»¶
                if all_sales_data:
                    self.update_simple_progress(f"ğŸ’¾ æ­£åœ¨ä¿å­˜ {db_name} å®Œæ•´Sales Raw Dataæ–‡ä»¶...")
                    
                    # æ£€æŸ¥æ•°æ®é‡æ˜¯å¦è¶…è¿‡Excelé™åˆ¶
                    max_excel_rows = 1048576  # Excelæœ€å¤§è¡Œæ•°
                    
                    if len(all_sales_data) > max_excel_rows:
                        self.update_simple_progress(f"âš ï¸ {db_name} æ•°æ®é‡è¿‡å¤§ ({len(all_sales_data):,} è¡Œ)ï¼Œè¶…è¿‡Excelé™åˆ¶ ({max_excel_rows:,} è¡Œ)")
                        self.update_simple_progress(f"ğŸ“ ä»…ä¿å­˜å‹ç¼©æ–‡ä»¶...")
                        
                        # åªä¿å­˜å‹ç¼©æ–‡ä»¶
                        compressed_all_file = f"{export_dir}/{db_name}_all_sales_raw_data.pkl.gz"
                        with gzip.open(compressed_all_file, 'wb') as f:
                            pickle.dump(all_sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                        
                        compressed_size = os.path.getsize(compressed_all_file) / (1024 * 1024)  # MB
                        self.update_simple_progress(f"âœ… {db_name} å‹ç¼©æ–‡ä»¶ä¿å­˜æˆåŠŸ: {compressed_size:.2f} MB")
                        
                        # å°è¯•åˆ†æ‰¹ä¿å­˜Excelæ–‡ä»¶
                        try:
                            self.update_simple_progress(f"ğŸ“‹ å°è¯•åˆ†æ‰¹ä¿å­˜ {db_name} Excelæ–‡ä»¶...")
                            batch_size = max_excel_rows - 1000  # ç•™ä¸€äº›ä½™é‡
                            total_batches = (len(all_sales_data) + batch_size - 1) // batch_size
                            
                            for batch_num in range(total_batches):
                                start_idx = batch_num * batch_size
                                end_idx = min(start_idx + batch_size, len(all_sales_data))
                                batch_data = all_sales_data[start_idx:end_idx]
                                
                                batch_file = f"{export_dir}/{db_name}_sales_raw_data_batch_{batch_num + 1}_of_{total_batches}.xlsx"
                                df_batch = pd.DataFrame(batch_data)
                                df_batch.to_excel(batch_file, index=False)
                                
                                batch_size_mb = os.path.getsize(batch_file) / (1024 * 1024)
                                self.update_simple_progress(f"âœ“ æ‰¹æ¬¡ {batch_num + 1}/{total_batches}: {batch_size_mb:.2f} MB")
                            
                            self.update_simple_progress(f"âœ… {db_name} æˆåŠŸåˆ†æ‰¹ä¿å­˜ {total_batches} ä¸ªExcelæ–‡ä»¶")
                            
                        except Exception as e:
                            self.update_simple_progress(f"âš ï¸ {db_name} åˆ†æ‰¹ä¿å­˜Excelå¤±è´¥: {e}")
                            self.update_simple_progress(f"ğŸ’¡ å»ºè®®ä½¿ç”¨å‹ç¼©æ–‡ä»¶è¿›è¡Œæ•°æ®åˆ†æ")
                        
                        excel_size = 0  # æ²¡æœ‰å•ä¸ªExcelæ–‡ä»¶
                        compression_ratio = 0  # æ— æ³•è®¡ç®—å‹ç¼©ç‡
                        
                    else:
                        # æ•°æ®é‡åœ¨Excelé™åˆ¶èŒƒå›´å†…ï¼Œæ­£å¸¸ä¿å­˜
                        df_all = pd.DataFrame(all_sales_data)
                        all_file = f"{export_dir}/{db_name}_all_sales_raw_data.xlsx"
                        df_all.to_excel(all_file, index=False)
                        
                        # å‹ç¼©å®Œæ•´æ–‡ä»¶
                        compressed_all_file = f"{export_dir}/{db_name}_all_sales_raw_data.pkl.gz"
                        with gzip.open(compressed_all_file, 'wb') as f:
                            pickle.dump(all_sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                        
                        # è®¡ç®—å‹ç¼©ç‡
                        excel_size = os.path.getsize(all_file) / (1024 * 1024)  # MB
                        compressed_size = os.path.getsize(compressed_all_file) / (1024 * 1024)  # MB
                        compression_ratio = (1 - compressed_size / excel_size) * 100 if excel_size > 0 else 0
                    
                    self.update_simple_progress(f"âœ… {db_name} å®Œæ•´Sales Raw Data: {len(all_sales_data)} æ¡è®°å½•")
                    self.update_simple_progress(f"ğŸ“ Excel: {excel_size:.2f}MB")
                    self.update_simple_progress(f"ğŸ—œï¸ å‹ç¼©: {compressed_size:.2f}MB (å‹ç¼©ç‡: {compression_ratio:.1f}%)")
                    
                    self.log_message(f"âœ… {db_name} å®Œæ•´Sales Raw Dataå¯¼å‡ºå®Œæˆ:")
                    self.log_message(f"   - Excelæ–‡ä»¶: {all_file} ({excel_size:.2f} MB)")
                    self.log_message(f"   - å‹ç¼©æ–‡ä»¶: {compressed_all_file} ({compressed_size:.2f} MB)")
                    self.log_message(f"   - å‹ç¼©ç‡: {compression_ratio:.1f}%")
                    self.log_message(f"   - æ€»è®°å½•æ•°: {len(all_sales_data)}")
                    self.log_message(f"   - åŒ…å«æ”¯ä»˜æ–¹å¼: âœ…")
                
                self.update_simple_progress(f"âœ… {db_name} Sales Raw Dataå¯¼å‡ºå®Œæˆ")
            
            # å®Œæˆ
            self.update_simple_progress("ğŸ‰ æ–°çš„åˆ†æ®µå¼å¯¼å‡ºå®Œæˆï¼")
            self.simple_progress_bar.stop()
            self.simple_progress_bar.config(mode='determinate', value=100)
            self.simple_close_button.config(state="normal")
            
            # æ–­å¼€æ•°æ®åº“è¿æ¥
            self.db_manager.disconnect()
            
            self.log_message(f"ğŸ‰ æ–°çš„åˆ†æ®µå¼å¯¼å‡ºå®Œæˆï¼æ‰€æœ‰æ•°æ®å·²ä¿å­˜åˆ°: {export_dir}/")
            self.log_message("ğŸ“‹ å¯¼å‡ºé¡ºåºï¼šæ‰€æœ‰æ•°æ®åº“çš„å‰7ä¸ªæŠ¥å‘Š â†’ æ‰€æœ‰æ•°æ®åº“çš„Sales Raw Data")
            
        except Exception as e:
            self.update_simple_progress(f"âœ— å¯¼å‡ºå¤±è´¥: {e}")
            self.simple_progress_bar.stop()
            self.simple_close_button.config(state="normal")
            self.log_message(f"âœ— æ–°çš„åˆ†æ®µå¼å¯¼å‡ºå¤±è´¥: {e}")
            if self.db_manager.connection:
                self.db_manager.disconnect()
    
    def create_simple_progress_window(self, title):
        """åˆ›å»ºç®€å•çš„è¿›åº¦çª—å£"""
        try:
            self.simple_progress_window = tk.Toplevel(self.root)
            self.simple_progress_window.title(title)
            self.simple_progress_window.geometry("500x200")
            self.simple_progress_window.resizable(False, False)
            
            # å±…ä¸­æ˜¾ç¤º
            self.simple_progress_window.transient(self.root)
            
            # è¿›åº¦ä¿¡æ¯
            progress_frame = tk.Frame(self.simple_progress_window, padding="20")
            progress_frame.pack(fill="both", expand=True)
            
            # æ ‡é¢˜
            title_label = tk.Label(progress_frame, text=title, font=("Arial", 12, "bold"))
            title_label.pack(pady=(0, 10))
            
            # çŠ¶æ€æ ‡ç­¾
            self.simple_status_label = tk.Label(progress_frame, text="å‡†å¤‡å¼€å§‹...", font=("Arial", 10))
            self.simple_status_label.pack(pady=(0, 10))
            
            # è¿›åº¦æ¡
            self.simple_progress_bar = ttk.Progressbar(progress_frame, length=300, mode='indeterminate')
            self.simple_progress_bar.pack(pady=(0, 10))
            self.simple_progress_bar.start()
            
            # å…³é—­æŒ‰é’®
            self.simple_close_button = ttk.Button(progress_frame, text="å…³é—­\nClose", 
                                                 command=self.close_simple_progress, state="disabled")
            self.simple_close_button.pack()
            
        except Exception as e:
            self.log_message(f"âœ— åˆ›å»ºç®€å•è¿›åº¦çª—å£å¤±è´¥: {e}")
    
    def close_simple_progress(self):
        """å…³é—­ç®€å•è¿›åº¦çª—å£"""
        try:
            if hasattr(self, 'simple_progress_window') and self.simple_progress_window:
                self.simple_progress_window.destroy()
                self.simple_progress_window = None
        except Exception as e:
            print(f"å…³é—­ç®€å•è¿›åº¦çª—å£å¤±è´¥: {e}")
    
    def update_simple_progress(self, message):
        """æ›´æ–°ç®€å•è¿›åº¦"""
        try:
            if hasattr(self, 'simple_status_label') and self.simple_status_label:
                self.simple_status_label.config(text=message)
                self.root.update()
        except Exception as e:
            print(f"æ›´æ–°ç®€å•è¿›åº¦å¤±è´¥: {e}")
    
    def _ultra_fast_export_worker(self):
        """è¶…å¿«é€Ÿå¯¼å‡ºå·¥ä½œçº¿ç¨‹"""
        try:
            import os
            import pandas as pd
            
            export_dir = "ultra_fast_export"
            os.makedirs(export_dir, exist_ok=True)
            
            # è·å–å½“å‰æ•°æ®åº“çš„åŸºæœ¬ä¿¡æ¯
            current_db = self.db_manager.current_database
            if current_db is None:
                current_db = self.selected_db.get()  # ä½¿ç”¨UIé€‰æ‹©çš„æ•°æ®åº“
            
            if current_db is None or current_db == "":
                self.update_simple_progress("âš ï¸ æœªé€‰æ‹©æ•°æ®åº“")
                return
                
            db_display = "GOGO" if "gogo" in current_db.lower() else "Express"
            
            self.update_simple_progress(f"æ­£åœ¨å¯¼å‡º {db_display} æ•°æ®åº“...")
            
            # å…ˆè¿æ¥åˆ°æ•°æ®åº“
            self.update_simple_progress("ğŸ”— æ­£åœ¨è¿æ¥åˆ°æ•°æ®åº“...")
            if not self.db_manager.connect(current_db):
                self.update_simple_progress("âš ï¸ æ— æ³•è¿æ¥åˆ°æ•°æ®åº“")
                return
            
            # è·å–æ—¥æœŸèŒƒå›´
            self.update_simple_progress("ğŸ“… æ­£åœ¨è·å–æ•°æ®æ—¥æœŸèŒƒå›´...")
            date_range = self.get_available_date_range()
            if not date_range:
                self.update_simple_progress("âš ï¸ æ•°æ®åº“æ— æ•°æ®")
                self.db_manager.disconnect()
                return
            
            start_date, end_date = date_range
            self.update_simple_progress(f"æ•°æ®èŒƒå›´: {start_date} åˆ° {end_date}")
            
            # åªå¯¼å‡ºæœ€è¿‘3ä¸ªæœˆçš„æ•°æ®
            from datetime import datetime, timedelta
            end_datetime = datetime.strptime(end_date, '%Y-%m-%d')
            start_datetime = end_datetime - timedelta(days=90)  # æœ€è¿‘3ä¸ªæœˆ
            
            self.update_simple_progress("æ­£åœ¨è·å–é”€å”®æ•°æ®...")
            
            # è·å–æ•°æ®ï¼ˆä¸åŒ…å«æ”¯ä»˜æ–¹å¼ï¼‰
            sales_data = self.db_manager.get_sales_data(
                date_from=start_datetime.strftime('%Y-%m-%d'),
                date_to=end_date,
                use_excel_cache=True
            )
            
            if sales_data:
                self.update_simple_progress(f"æ­£åœ¨ä¿å­˜ {len(sales_data)} æ¡è®°å½•...")
                
                # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                for record in sales_data:
                    record['æ•°æ®åº“æ¥æº'] = db_display
                    record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                
                # ä¿å­˜åˆ°Excelå’Œå‹ç¼©æ–‡ä»¶
                df = pd.DataFrame(sales_data)
                excel_file = f"{export_dir}/{db_display}_recent_3months.xlsx"
                compressed_file = f"{export_dir}/{db_display}_recent_3months.pkl.gz"
                
                # ä¿å­˜Excelæ–‡ä»¶
                df.to_excel(excel_file, index=False)
                
                # ä¿å­˜å‹ç¼©æ–‡ä»¶
                import gzip
                import pickle
                with gzip.open(compressed_file, 'wb') as f:
                    pickle.dump(sales_data, f, protocol=pickle.HIGHEST_PROTOCOL)
                
                # è®¡ç®—å‹ç¼©ç‡
                excel_size = os.path.getsize(excel_file) / (1024 * 1024)  # MB
                compressed_size = os.path.getsize(compressed_file) / (1024 * 1024)  # MB
                compression_ratio = (1 - compressed_size / excel_size) * 100 if excel_size > 0 else 0
                
                # å®Œæˆ
                self.update_simple_progress(f"âœ… å¯¼å‡ºå®Œæˆï¼")
                self.simple_progress_bar.stop()
                self.simple_progress_bar.config(mode='determinate', value=100)
                self.simple_close_button.config(state="normal")
                
                self.log_message(f"âš¡ è¶…å¿«é€Ÿå¯¼å‡ºå®Œæˆï¼")
                self.log_message(f"   - Excelæ–‡ä»¶: {excel_file} ({excel_size:.2f} MB)")
                self.log_message(f"   - å‹ç¼©æ–‡ä»¶: {compressed_file} ({compressed_size:.2f} MB)")
                self.log_message(f"   - å‹ç¼©ç‡: {compression_ratio:.1f}%")
                self.log_message(f"   - è®°å½•æ•°: {len(sales_data)}")
            else:
                self.update_simple_progress("âš ï¸ æ²¡æœ‰æ•°æ®å¯å¯¼å‡º")
                self.simple_progress_bar.stop()
                self.simple_close_button.config(state="normal")
            
        except Exception as e:
            self.update_simple_progress(f"âœ— å¯¼å‡ºå¤±è´¥: {e}")
            self.simple_progress_bar.stop()
            self.simple_close_button.config(state="normal")
            self.log_message(f"âœ— è¶…å¿«é€Ÿå¯¼å‡ºå¤±è´¥: {e}")
    
    def get_available_date_range(self):
        """è·å–æ•°æ®åº“ä¸­å¯ç”¨çš„æ—¥æœŸèŒƒå›´"""
        try:
            cursor = self.db_manager.connection.cursor()
            
            # è·å–æœ€æ—©å’Œæœ€æ™šçš„æ—¥æœŸ
            query = """
                SELECT 
                    MIN(CAST(c_date AS DATE)) as min_date,
                    MAX(CAST(c_date AS DATE)) as max_date
                FROM pos_sales_dtls 
                WHERE item_name NOT IN ('WASTAGE', 'Waste', 'waste', 'WASTE')
            """
            
            cursor.execute(query)
            result = cursor.fetchone()
            
            if result and result[0] and result[1]:
                return str(result[0]), str(result[1])
            else:
                return None
                
        except Exception as e:
            self.log_message(f"âœ— è·å–æ—¥æœŸèŒƒå›´å¤±è´¥: {e}")
            return None
    
    def export_sales_data_by_period(self, start_date, end_date, export_dir, db_display, db_data):
        """æŒ‰æœŸé—´å¯¼å‡ºé”€å”®æ•°æ®"""
        try:
            import pandas as pd
            from datetime import datetime, timedelta
            
            # æŒ‰æœˆä»½å¯¼å‡º
            current_date = datetime.strptime(start_date, '%Y-%m-%d')
            end_datetime = datetime.strptime(end_date, '%Y-%m-%d')
            
            all_sales_data = []
            
            while current_date <= end_datetime:
                month_start = current_date.replace(day=1)
                if current_date.month == 12:
                    month_end = current_date.replace(year=current_date.year + 1, month=1, day=1) - timedelta(days=1)
                else:
                    month_end = current_date.replace(month=current_date.month + 1, day=1) - timedelta(days=1)
                
                # ç¡®ä¿ä¸è¶…è¿‡ç»“æŸæ—¥æœŸ
                if month_end > end_datetime:
                    month_end = end_datetime
                
                month_str = month_start.strftime('%Y-%m')
                self.log_message(f"  æ­£åœ¨å¯¼å‡º {db_display} {month_str} é”€å”®æ•°æ®...")
                
                # è·å–è¯¥æœˆæ•°æ®
                sales_data = self.db_manager.get_sales_data(
                    date_from=month_start.strftime('%Y-%m-%d'),
                    date_to=month_end.strftime('%Y-%m-%d')
                )
                
                if sales_data:
                    # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                    for record in sales_data:
                        record['æ•°æ®åº“æ¥æº'] = db_display
                        record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                    
                    all_sales_data.extend(sales_data)
                    # ä¿å­˜æœˆåº¦æ–‡ä»¶
                    df = pd.DataFrame(sales_data)
                    df.to_excel(f"{export_dir}/sales_data_{month_str}.xlsx", index=False)
                    self.log_message(f"    âœ“ {db_display} {month_str}: {len(sales_data)} æ¡è®°å½•")
                
                # ç§»åŠ¨åˆ°ä¸‹ä¸ªæœˆ
                if current_date.month == 12:
                    current_date = current_date.replace(year=current_date.year + 1, month=1)
                else:
                    current_date = current_date.replace(month=current_date.month + 1)
            
            # ä¿å­˜å®Œæ•´æ–‡ä»¶
            if all_sales_data:
                df_all = pd.DataFrame(all_sales_data)
                df_all.to_excel(f"{export_dir}/all_sales_data_{start_date}_to_{end_date}.xlsx", index=False)
                db_data["sales_data"] = all_sales_data
                self.log_message(f"âœ“ {db_display} é”€å”®æ•°æ®å¯¼å‡ºå®Œæˆï¼Œæ€»è®¡ {len(all_sales_data)} æ¡è®°å½•")
            
        except Exception as e:
            self.log_message(f"âœ— {db_display} å¯¼å‡ºé”€å”®æ•°æ®å¤±è´¥: {e}")
    
    def export_monthly_summary_data(self, start_date, end_date, export_dir, db_display, db_data):
        """å¯¼å‡ºæœˆåº¦æ±‡æ€»æ•°æ®"""
        try:
            import pandas as pd
            
            monthly_data = self.db_manager.get_monthly_summary(start_date, end_date)
            if monthly_data:
                # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                for record in monthly_data:
                    record['æ•°æ®åº“æ¥æº'] = db_display
                    record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                
                df = pd.DataFrame(monthly_data)
                df.to_excel(f"{export_dir}/monthly_summary_{start_date}_to_{end_date}.xlsx", index=False)
                db_data["monthly_summary"] = monthly_data
                self.log_message(f"âœ“ {db_display} æœˆåº¦æ±‡æ€»å¯¼å‡ºå®Œæˆï¼Œå…± {len(monthly_data)} æ¡è®°å½•")
            
        except Exception as e:
            self.log_message(f"âœ— {db_display} å¯¼å‡ºæœˆåº¦æ±‡æ€»å¤±è´¥: {e}")
    
    def export_product_analysis_data(self, start_date, end_date, export_dir, db_display, db_data):
        """å¯¼å‡ºäº§å“åˆ†ææ•°æ®"""
        try:
            import pandas as pd
            
            # æ—¥-äº§å“åˆ†æ
            daily_product_data = self.db_manager.get_sales_tc_analysis(start_date, end_date)
            if daily_product_data:
                # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                for record in daily_product_data:
                    record['æ•°æ®åº“æ¥æº'] = db_display
                    record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                
                df = pd.DataFrame(daily_product_data)
                df.to_excel(f"{export_dir}/daily_product_analysis_{start_date}_to_{end_date}.xlsx", index=False)
                db_data["product_analysis"].extend(daily_product_data)
                self.log_message(f"âœ“ {db_display} æ—¥-äº§å“åˆ†æå¯¼å‡ºå®Œæˆï¼Œå…± {len(daily_product_data)} æ¡è®°å½•")
            
            # æœˆ-äº§å“åˆ†æ
            monthly_product_data = self.db_manager.get_sales_tc_monthly(start_date, end_date)
            if monthly_product_data:
                # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                for record in monthly_product_data:
                    record['æ•°æ®åº“æ¥æº'] = db_display
                    record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                
                df = pd.DataFrame(monthly_product_data)
                df.to_excel(f"{export_dir}/monthly_product_analysis_{start_date}_to_{end_date}.xlsx", index=False)
                db_data["product_analysis"].extend(monthly_product_data)
                self.log_message(f"âœ“ {db_display} æœˆ-äº§å“åˆ†æå¯¼å‡ºå®Œæˆï¼Œå…± {len(monthly_product_data)} æ¡è®°å½•")
            
        except Exception as e:
            self.log_message(f"âœ— {db_display} å¯¼å‡ºäº§å“åˆ†æå¤±è´¥: {e}")
    
    def export_discount_analysis_data(self, start_date, end_date, export_dir, db_display, db_data):
        """å¯¼å‡ºæŠ˜æ‰£åˆ†ææ•°æ®"""
        try:
            import pandas as pd
            
            discount_data = self.db_manager.get_discount_analysis(start_date, end_date)
            if discount_data:
                # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                for record in discount_data:
                    record['æ•°æ®åº“æ¥æº'] = db_display
                    record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                
                df = pd.DataFrame(discount_data)
                df.to_excel(f"{export_dir}/discount_analysis_{start_date}_to_{end_date}.xlsx", index=False)
                db_data["discount_analysis"] = discount_data
                self.log_message(f"âœ“ {db_display} æŠ˜æ‰£åˆ†æå¯¼å‡ºå®Œæˆï¼Œå…± {len(discount_data)} æ¡è®°å½•")
            
        except Exception as e:
            self.log_message(f"âœ— {db_display} å¯¼å‡ºæŠ˜æ‰£åˆ†æå¤±è´¥: {e}")
    
    def export_payment_analysis_data(self, start_date, end_date, export_dir, db_display, db_data):
        """å¯¼å‡ºæ”¯ä»˜åˆ†ææ•°æ®"""
        try:
            import pandas as pd
            
            payment_data = self.db_manager.get_payment_analysis(start_date, end_date)
            if payment_data:
                # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                for record in payment_data:
                    record['æ•°æ®åº“æ¥æº'] = db_display
                    record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                
                df = pd.DataFrame(payment_data)
                df.to_excel(f"{export_dir}/payment_analysis_{start_date}_to_{end_date}.xlsx", index=False)
                db_data["payment_analysis"] = payment_data
                self.log_message(f"âœ“ {db_display} æ”¯ä»˜åˆ†æå¯¼å‡ºå®Œæˆï¼Œå…± {len(payment_data)} æ¡è®°å½•")
            
        except Exception as e:
            self.log_message(f"âœ— {db_display} å¯¼å‡ºæ”¯ä»˜åˆ†æå¤±è´¥: {e}")
    
    def export_brand_analysis_data(self, start_date, end_date, export_dir, db_display, db_data):
        """å¯¼å‡ºå“ç‰Œåˆ†ææ•°æ®"""
        try:
            import pandas as pd
            
            # è·å–å“ç‰Œåˆ†ææ•°æ®
            brand_data = self.db_manager.get_brand_analysis(start_date, end_date)
            if brand_data:
                # ä¸ºæ¯æ¡è®°å½•æ·»åŠ æ•°æ®åº“æ ‡è¯†
                for record in brand_data:
                    record['æ•°æ®åº“æ¥æº'] = db_display
                    record['æ•°æ®åº“æ¥æº\nDatabase Source'] = db_display
                
                df = pd.DataFrame(brand_data)
                df.to_excel(f"{export_dir}/brand_analysis_{start_date}_to_{end_date}.xlsx", index=False)
                db_data["brand_analysis"] = brand_data
                self.log_message(f"âœ“ {db_display} å“ç‰Œåˆ†æå¯¼å‡ºå®Œæˆï¼Œå…± {len(brand_data)} æ¡è®°å½•")
            
        except Exception as e:
            self.log_message(f"âœ— {db_display} å¯¼å‡ºå“ç‰Œåˆ†æå¤±è´¥: {e}")
    
    def generate_export_summary(self, export_dir, all_exported_data):
        """ç”Ÿæˆå¯¼å‡ºæ±‡æ€»æŠ¥å‘Š"""
        try:
            import pandas as pd
            from datetime import datetime
            
            # åˆ›å»ºæ±‡æ€»æ•°æ®
            summary_data = []
            total_records = 0
            
            for db_name, db_data in all_exported_data.items():
                summary_row = {
                    'æ•°æ®åº“\nDatabase': db_name,
                    'æ—¥æœŸèŒƒå›´\nDate Range': f"{db_data['date_range'][0]} åˆ° {db_data['date_range'][1]}",
                    'é”€å”®æ•°æ®è®°å½•æ•°\nSales Records': len(db_data.get('sales_data', [])),
                    'æœˆåº¦æ±‡æ€»è®°å½•æ•°\nMonthly Summary': len(db_data.get('monthly_summary', [])),
                    'äº§å“åˆ†æè®°å½•æ•°\nProduct Analysis': len(db_data.get('product_analysis', [])),
                    'æŠ˜æ‰£åˆ†æè®°å½•æ•°\nDiscount Analysis': len(db_data.get('discount_analysis', [])),
                    'æ”¯ä»˜åˆ†æè®°å½•æ•°\nPayment Analysis': len(db_data.get('payment_analysis', [])),
                    'å“ç‰Œåˆ†æè®°å½•æ•°\nBrand Analysis': len(db_data.get('brand_analysis', []))
                }
                
                db_total = (summary_row['é”€å”®æ•°æ®è®°å½•æ•°\nSales Records'] + 
                           summary_row['æœˆåº¦æ±‡æ€»è®°å½•æ•°\nMonthly Summary'] + 
                           summary_row['äº§å“åˆ†æè®°å½•æ•°\nProduct Analysis'] + 
                           summary_row['æŠ˜æ‰£åˆ†æè®°å½•æ•°\nDiscount Analysis'] + 
                           summary_row['æ”¯ä»˜åˆ†æè®°å½•æ•°\nPayment Analysis'] + 
                           summary_row['å“ç‰Œåˆ†æè®°å½•æ•°\nBrand Analysis'])
                
                summary_row['æ•°æ®åº“æ€»è®°å½•æ•°\nDatabase Total'] = db_total
                total_records += db_total
                summary_data.append(summary_row)
            
            # æ·»åŠ æ€»è®¡è¡Œ
            if summary_data:
                total_row = {
                    'æ•°æ®åº“\nDatabase': 'æ€»è®¡ Total',
                    'æ—¥æœŸèŒƒå›´\nDate Range': '-',
                    'é”€å”®æ•°æ®è®°å½•æ•°\nSales Records': sum(row['é”€å”®æ•°æ®è®°å½•æ•°\nSales Records'] for row in summary_data),
                    'æœˆåº¦æ±‡æ€»è®°å½•æ•°\nMonthly Summary': sum(row['æœˆåº¦æ±‡æ€»è®°å½•æ•°\nMonthly Summary'] for row in summary_data),
                    'äº§å“åˆ†æè®°å½•æ•°\nProduct Analysis': sum(row['äº§å“åˆ†æè®°å½•æ•°\nProduct Analysis'] for row in summary_data),
                    'æŠ˜æ‰£åˆ†æè®°å½•æ•°\nDiscount Analysis': sum(row['æŠ˜æ‰£åˆ†æè®°å½•æ•°\nDiscount Analysis'] for row in summary_data),
                    'æ”¯ä»˜åˆ†æè®°å½•æ•°\nPayment Analysis': sum(row['æ”¯ä»˜åˆ†æè®°å½•æ•°\nPayment Analysis'] for row in summary_data),
                    'å“ç‰Œåˆ†æè®°å½•æ•°\nBrand Analysis': sum(row['å“ç‰Œåˆ†æè®°å½•æ•°\nBrand Analysis'] for row in summary_data),
                    'æ•°æ®åº“æ€»è®°å½•æ•°\nDatabase Total': total_records
                }
                summary_data.append(total_row)
            
            # ä¿å­˜æ±‡æ€»æŠ¥å‘Š
            if summary_data:
                df_summary = pd.DataFrame(summary_data)
                df_summary.to_excel(f"{export_dir}/å¯¼å‡ºæ±‡æ€»æŠ¥å‘Š_Export_Summary.xlsx", index=False)
                
                # ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š
                with open(f"{export_dir}/å¯¼å‡ºæŠ¥å‘Š.txt", 'w', encoding='utf-8') as f:
                    f.write("=" * 60 + "\n")
                    f.write("å†å²æ•°æ®å¯¼å‡ºæ±‡æ€»æŠ¥å‘Š\n")
                    f.write("Historical Data Export Summary Report\n")
                    f.write("=" * 60 + "\n")
                    f.write(f"å¯¼å‡ºæ—¶é—´ Export Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                    f.write(f"å¯¼å‡ºç›®å½• Export Directory: {export_dir}\n\n")
                    
                    f.write("æ•°æ®åº“å¯¼å‡ºç»Ÿè®¡ Database Export Statistics:\n")
                    f.write("-" * 50 + "\n")
                    
                    for row in summary_data:
                        if row['æ•°æ®åº“\nDatabase'] != 'æ€»è®¡ Total':
                            f.write(f"æ•°æ®åº“: {row['æ•°æ®åº“\nDatabase']}\n")
                            f.write(f"  æ—¥æœŸèŒƒå›´: {row['æ—¥æœŸèŒƒå›´\nDate Range']}\n")
                            f.write(f"  é”€å”®æ•°æ®: {row['é”€å”®æ•°æ®è®°å½•æ•°\nSales Records']:,} æ¡è®°å½•\n")
                            f.write(f"  æœˆåº¦æ±‡æ€»: {row['æœˆåº¦æ±‡æ€»è®°å½•æ•°\nMonthly Summary']:,} æ¡è®°å½•\n")
                            f.write(f"  äº§å“åˆ†æ: {row['äº§å“åˆ†æè®°å½•æ•°\nProduct Analysis']:,} æ¡è®°å½•\n")
                            f.write(f"  æŠ˜æ‰£åˆ†æ: {row['æŠ˜æ‰£åˆ†æè®°å½•æ•°\nDiscount Analysis']:,} æ¡è®°å½•\n")
                            f.write(f"  æ”¯ä»˜åˆ†æ: {row['æ”¯ä»˜åˆ†æè®°å½•æ•°\nPayment Analysis']:,} æ¡è®°å½•\n")
                            f.write(f"  å“ç‰Œåˆ†æ: {row['å“ç‰Œåˆ†æè®°å½•æ•°\nBrand Analysis']:,} æ¡è®°å½•\n")
                            f.write(f"  å°è®¡: {row['æ•°æ®åº“æ€»è®°å½•æ•°\nDatabase Total']:,} æ¡è®°å½•\n\n")
                    
                    f.write("=" * 50 + "\n")
                    f.write(f"æ€»è®¡ Total: {total_records:,} æ¡è®°å½•\n")
                    f.write(f"å¯¼å‡ºæ•°æ®åº“æ•°é‡: {len(all_exported_data)} ä¸ª\n")
                    f.write("=" * 50 + "\n")
                
                self.log_message(f"ğŸ“‹ æ±‡æ€»æŠ¥å‘Šå·²ç”Ÿæˆ: {export_dir}/å¯¼å‡ºæ±‡æ€»æŠ¥å‘Š_Export_Summary.xlsx")
                self.log_message(f"ğŸ“‹ æ–‡æœ¬æŠ¥å‘Šå·²ç”Ÿæˆ: {export_dir}/å¯¼å‡ºæŠ¥å‘Š.txt")
                self.log_message(f"ğŸ“Š æ€»è®¡å¯¼å‡º: {total_records:,} æ¡è®°å½•ï¼Œæ¥è‡ª {len(all_exported_data)} ä¸ªæ•°æ®åº“")
            
        except Exception as e:
            self.log_message(f"âœ— ç”Ÿæˆæ±‡æ€»æŠ¥å‘Šå¤±è´¥: {e}")
    
    def clear_data_cache(self):
        """æ¸…é™¤æ•°æ®ç¼“å­˜"""
        self.log_message("æ­£åœ¨æ¸…é™¤æ•°æ®ç¼“å­˜...")
        try:
            # æ¸…é™¤æ•°æ®ç¼“å­˜
            self.sales_data = None
            self.payment_data = None
            self.discount_data = None
            self.monthly_data = None
            self.sales_tc_analysis_data = None
            self.sales_tc_monthly_data = None
            self.product_association_data = None
            
            # æ¸…é™¤æ´»åŠ¨è®°å½•
            self.activity_records = []
            
            self.log_message("âœ“ ç¼“å­˜æ¸…é™¤å®Œæˆ")
            
        except Exception as e:
            self.log_message(f"âœ— æ¸…é™¤ç¼“å­˜å¤±è´¥: {e}")
    
    def open_settings(self):
        """æ‰“å¼€ç³»ç»Ÿè®¾ç½®"""
        self.log_message("ç³»ç»Ÿè®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...")
        messagebox.showinfo("ç³»ç»Ÿè®¾ç½®", "ç³»ç»Ÿè®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼\n\nSystem Settings is under development, please stay tuned!")
    
    def open_help(self):
        """æ‰“å¼€å¸®åŠ©æ–‡æ¡£"""
        self.log_message("æ­£åœ¨æ‰“å¼€å¸®åŠ©æ–‡æ¡£...")
        try:
            help_text = """
POSæ•°æ®åˆ†æå·¥å…· - ä½¿ç”¨å¸®åŠ©

1. æ•°æ®åº“è¿æ¥
   - é€‰æ‹©æ•°æ®åº“ç±»å‹
   - ç‚¹å‡»"è¿æ¥æ•°æ®åº“"æŒ‰é’®

2. ç­›é€‰æ¡ä»¶è®¾ç½®
   - è®¾ç½®æ—¥æœŸèŒƒå›´
   - é€‰æ‹©é—¨å¸‚ã€æœˆä»½ã€æ˜ŸæœŸç­‰ç­›é€‰æ¡ä»¶
   - é€‰æ‹©äº§å“å’Œç±»åˆ«

3. åˆ†æåŠŸèƒ½
   - é”€å”®åˆ†æï¼šæŸ¥çœ‹é”€å”®æ•°æ®ã€æ”¯ä»˜æ–¹å¼ã€æŠ˜æ‰£ç­‰
   - äº§å“åˆ†æï¼šæŸ¥çœ‹äº§å“è¡¨ç°ã€å…³è”åˆ†æç­‰
   - å“ç‰Œåˆ†æï¼šæŸ¥çœ‹å“ç‰Œä¸šç»©å¯¹æ¯”ç­‰

4. æ•°æ®å¯¼å‡º
   - å¯¼å‡ºå½“å‰æ•°æ®
   - å¯¼å‡ºæ‰€æœ‰åˆ†æç»“æœ
   - ç”Ÿæˆåˆ†ææŠ¥å‘Š

5. å·¥å…·åŠŸèƒ½
   - åˆ·æ–°æ•°æ®
   - æ¸…é™¤ç¼“å­˜
   - ç³»ç»Ÿè®¾ç½®
   - å¸®åŠ©æ–‡æ¡£

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒã€‚
            """
            messagebox.showinfo("å¸®åŠ©æ–‡æ¡£", help_text)
            
        except Exception as e:
            self.log_message(f"âœ— æ‰“å¼€å¸®åŠ©æ–‡æ¡£å¤±è´¥: {e}")
    
    def save_data_to_csv(self, data, filepath):
        """ä¿å­˜æ•°æ®åˆ°CSVæ–‡ä»¶"""
        try:
            if not data:
                self.log_message("æ²¡æœ‰æ•°æ®å¯ä¿å­˜")
                return False
            
            # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            os.makedirs(os.path.dirname(filepath), exist_ok=True)
            
            # å†™å…¥CSVæ–‡ä»¶
            with open(filepath, 'w', newline='', encoding='utf-8-sig') as csvfile:
                if data:
                    # è·å–å­—æ®µå
                    fieldnames = data[0].keys()
                    writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
                    writer.writeheader()
                    writer.writerows(data)
            
            # è·å–æ–‡ä»¶å¤§å°
            file_size = os.path.getsize(filepath) / (1024 * 1024)  # MB
            
            self.log_message(f"âœ“ æ•°æ®å·²ä¿å­˜åˆ°: {filepath}")
            self.log_message(f"æ–‡ä»¶å¤§å°: {file_size:.2f} MBï¼Œè®°å½•æ•°: {len(data)}")
            
            return True
            
        except Exception as e:
            self.log_message(f"âœ— ä¿å­˜CSVæ–‡ä»¶å¤±è´¥: {e}")
            return False
    
    def export_data(self):
        """å¯¼å‡ºæ•°æ® - ä¿®å¤ï¼šå¯¼å‡ºå½“å‰æ˜¾ç¤ºçš„ç­›é€‰åæ•°æ®"""
        # ç¡®å®šè¦å¯¼å‡ºçš„æ•°æ®
        current_tab = self.notebook.index(self.notebook.select())
        self.log_message(f"å½“å‰æ ‡ç­¾é¡µç´¢å¼•: {current_tab}")
        
        if current_tab == 1 and self.sales_data:  # é”€å”®æ•°æ®
            data = self.sales_data
            filename = f"sales_data_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        elif current_tab == 2:  # æ”¯ä»˜åˆ†æ
            # ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç­›é€‰åçš„æ”¯ä»˜æ•°æ®
            if hasattr(self, 'filtered_payment_data') and self.filtered_payment_data:
                data = self.filtered_payment_data
                self.log_message("âœ“ å¯¼å‡ºç­›é€‰åçš„æ”¯ä»˜åˆ†ææ•°æ®")
            elif self.payment_data:
                data = self.payment_data
                self.log_message("â„¹ å¯¼å‡ºåŸå§‹æ”¯ä»˜åˆ†ææ•°æ®ï¼ˆæœªåº”ç”¨ç­›é€‰ï¼‰")
            else:
                self.log_message("âœ— æ²¡æœ‰æ”¯ä»˜åˆ†ææ•°æ®å¯å¯¼å‡º")
                return
            filename = f"payment_analysis_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        elif current_tab == 3 and self.discount_data:  # æŠ˜æ‰£åˆ†æ
            data = self.discount_data
            filename = f"discount_analysis_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        elif current_tab == 4 and self.monthly_data:  # æœˆåº¦æ±‡æ€»
            data = self.monthly_data
            filename = f"monthly_summary_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        elif current_tab == 5 and self.sales_tc_analysis_data:  # é”€å”®TCåˆ†æ
            data = self.sales_tc_analysis_data
            filename = f"sales_tc_analysis_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        elif current_tab == 6 and self.sales_tc_monthly_data:  # é”€å”®TCæœˆåº¦æ±‡æ€»
            data = self.sales_tc_monthly_data
            filename = f"sales_tc_monthly_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        elif current_tab == 7 and self.product_association_data:  # äº§å“å…³è”åˆ†æ
            data = self.product_association_data
            filename = f"product_association_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
        elif current_tab == 2:  # å“ç‰Œåˆ†æ
            # æ£€æŸ¥å“ç‰Œåˆ†æçš„å­æ ‡ç­¾é¡µ
            if hasattr(self, 'brand_notebook'):
                brand_sub_tab = self.brand_notebook.index(self.brand_notebook.select())
                self.log_message(f"å“ç‰Œåˆ†æå­æ ‡ç­¾é¡µç´¢å¼•: {brand_sub_tab}")
                if brand_sub_tab == 0 and hasattr(self, 'brand_daily_data') and self.brand_daily_data:  # æ¯æ—¥ç»†é¡¹
                    data = self.brand_daily_data
                    filename = f"brand_daily_breakdown_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
                elif brand_sub_tab == 1 and hasattr(self, 'brand_period_data') and self.brand_period_data:  # æœŸé—´æ±‡æ€»
                    data = self.brand_period_data
                    filename = f"brand_period_summary_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
                elif brand_sub_tab == 2 and hasattr(self, 'brand_analysis_data') and self.brand_analysis_data:  # ä¸šç»©å¯¹æ¯”
                    data = self.brand_analysis_data
                    filename = f"brand_performance_comparison_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
                else:
                    self.log_message("å“ç‰Œåˆ†æå­æ ‡ç­¾é¡µæ²¡æœ‰æ•°æ®ï¼Œå°è¯•å¯¼å‡ºæ‰€æœ‰å¯ç”¨æ•°æ®...")
                    self.export_all_data()
                    return
            else:
                self.log_message("å“ç‰Œåˆ†ææ ‡ç­¾é¡µæ²¡æœ‰æ•°æ®ï¼Œå°è¯•å¯¼å‡ºæ‰€æœ‰å¯ç”¨æ•°æ®...")
                self.export_all_data()
                return
        else:
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å½“å‰æ ‡ç­¾é¡µçš„æ•°æ®ï¼Œå°è¯•å¯¼å‡ºæ‰€æœ‰å¯ç”¨æ•°æ®
            self.log_message("å½“å‰æ ‡ç­¾é¡µæ²¡æœ‰æ•°æ®ï¼Œå°è¯•å¯¼å‡ºæ‰€æœ‰å¯ç”¨æ•°æ®...")
            self.export_all_data()
            return
        
        # é€‰æ‹©ä¿å­˜ä½ç½®
        filename = filedialog.asksaveasfilename(
            defaultextension=".csv",
            filetypes=[("CSV files", "*.csv")],
            initialfile=filename
        )
        
        if filename:
            try:
                df = pd.DataFrame(data)
                df.to_csv(filename, index=False, encoding='utf-8-sig')
                
                file_size = os.path.getsize(filename) / (1024 * 1024)  # MB
                self.log_message(f"âœ“ æ•°æ®å·²å¯¼å‡ºåˆ°: {filename}")
                self.log_message(f"æ–‡ä»¶å¤§å°: {file_size:.2f} MB")
                
                messagebox.showinfo("æˆåŠŸ", f"å·²å¯¼å‡º {len(data)} æ¡è®°å½•åˆ°:\n{filename}\n\næ–‡ä»¶å¤§å°: {file_size:.2f} MB")
            except Exception as e:
                self.log_message(f"âœ— å¯¼å‡ºæ•°æ®å¤±è´¥: {e}")
                messagebox.showerror("é”™è¯¯", f"å¯¼å‡ºå¤±è´¥:\n{e}")
    
    def get_product_association_analysis(self):
        """è·å–äº§å“å…³è”åˆ†æ"""
        try:
            # æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†äº§å“
            selected_products = self.product_combo.get_selected_for_filter()
            if not selected_products or len(selected_products) == 0:
                self.log_message("âœ— è¯·å…ˆé€‰æ‹©è¦åˆ†æçš„äº§å“")
                return
            
            if len(selected_products) > 1:
                self.log_message("âœ— äº§å“å…³è”åˆ†æä¸€æ¬¡åªèƒ½é€‰æ‹©ä¸€ä¸ªäº§å“")
                return
            
            selected_product = selected_products[0]
            self.log_message(f"æ­£åœ¨è·å–äº§å“å…³è”åˆ†æ: {selected_product}")
            
            # è·å–ç­›é€‰æ¡ä»¶
            date_from = self.date_from.get_date() if self.use_date_filter.get() else None
            date_to = self.date_to.get_date() if self.use_date_filter.get() else None
            outlet_filters = self.outlet_combo.get_selected_for_filter()
            month_filters = self.month_combo.get_selected_for_filter()
            weekday_filters = self.weekday_combo.get_selected()
            category_filters = self.category_combo.get_selected_for_filter()
            payment_filters = self.payment_combo.get_selected_for_filter()
            
            # éªŒè¯æ—¥æœŸèŒƒå›´
            if self.use_date_filter.get() and not self.validate_date_range():
                return
            
            # å…ˆè¿æ¥æ•°æ®åº“
            db = self.selected_db.get()
            if not self.db_manager.connect(db):
                self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
                return
            
            # è·å–æ•°æ®
            self.log_message(f"è°ƒç”¨æ•°æ®åº“æŸ¥è¯¢: {selected_product}")
            print(f"DEBUG: è°ƒç”¨ get_product_association_analysisï¼Œå‚æ•°: selected_product={selected_product}, date_from={date_from}, date_to={date_to}")
            print(f"DEBUG: ç­›é€‰æ¡ä»¶: outlet_filters={outlet_filters}, month_filters={month_filters}, weekday_filters={weekday_filters}, category_filters={category_filters}, payment_filters={payment_filters}")
            data = self.db_manager.get_product_association_analysis(
                selected_product, date_from, date_to, outlet_filters, 
                month_filters, weekday_filters, category_filters, payment_filters
            )
            print(f"DEBUG: get_product_association_analysis è¿”å›ç»“æœ: {len(data) if data else 0} æ¡è®°å½•")
            self.log_message(f"æ•°æ®åº“æŸ¥è¯¢è¿”å›: {len(data) if data else 0} æ¡è®°å½•")
            
            if data:
                self.product_association_data = data
                self.last_selected_product = selected_product  # ä¿å­˜é€‰ä¸­çš„äº§å“åç§°
                self.display_product_association_analysis(data, selected_product)
                self.log_message(f"âœ“ äº§å“å…³è”åˆ†æå®Œæˆ: {len(data)} æ¡è®°å½•")
            else:
                self.log_message("âœ— è·å–äº§å“å…³è”åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
                
        except Exception as e:
            import traceback
            error_details = traceback.format_exc()
            self.log_message(f"âœ— è·å–äº§å“å…³è”åˆ†æå¤±è´¥: {e}")
            self.log_message(f"é”™è¯¯è¯¦æƒ…: {error_details}")
            print(f"GUIäº§å“å…³è”åˆ†æå¼‚å¸¸: {e}")
            print(f"é”™è¯¯è¯¦æƒ…: {error_details}")
    
    def display_product_association_analysis(self, data, selected_product):
        """æ˜¾ç¤ºäº§å“å…³è”åˆ†ææ•°æ®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.product_association_tree.get_children():
            self.product_association_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ("æœˆä»½\nMonth", "é—¨å¸‚\nOutlet", "äº§å“åç§°\nProduct Name", "æ•°é‡\nQuantity", "å•æ®æ•°\nReceipt Count", "å•æ®ä¸šç»©\nReceipt Performance", "æ•°é‡å æ¯”%\nQuantity Ratio%", "å•æ®å æ¯”%\nReceipt Ratio%")
        self.product_association_tree["columns"] = columns
        self.product_association_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜å’Œæ’åºåŠŸèƒ½
        for col in columns:
            self.product_association_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.product_association_tree, c))
            self.product_association_tree.column(col, width=120, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)  # è¿›ä¸€æ­¥ç¼©å°æ•°æ®è¡Œé«˜åº¦åˆ°25åƒç´ 
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))  # ç¼©å°å­—ä½“ä½†å¢åŠ æ ‡é¢˜é«˜åº¦åˆ°80åƒç´ 
        
        # é…ç½®æ ‡ç­¾æ ·å¼
        self.product_association_tree.tag_configure("selected_product", background="#2196F3", foreground="white")  # æ·±è“è‰² - æœç´¢äº§å“
        self.product_association_tree.tag_configure("total_other", background="#FF9800", foreground="white")      # æ·±æ©™è‰² - Total Other Item
        self.product_association_tree.tag_configure("other_product", background="#E0E0E0")                        # æ·±ç°è‰² - å…¶ä»–äº§å“
        self.product_association_tree.tag_configure("grand_total", background="#4CAF50", foreground="white")      # ç»¿è‰² - å…¨éƒ¨æ€»æ•°
        
        # æ’å…¥æ•°æ®å¹¶è®¾ç½®é¢œè‰²
        for row in data:
            æœˆä»½, é—¨å¸‚, äº§å“åç§°, æ•°é‡, å•æ®æ•°, å•æ®ä¸šç»©, æ•°é‡å æ¯”, å•æ®å æ¯” = row
            
            # æ ¹æ®äº§å“åç§°ç¡®å®šæ ‡ç­¾
            if äº§å“åç§° == selected_product:
                tag = "selected_product"
            elif äº§å“åç§° == "Total Other Item":
                tag = "total_other"
            elif äº§å“åç§° == "å…¨éƒ¨æ€»æ•°\nGrand Total":
                tag = "grand_total"
            else:
                tag = "other_product"
            
            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get() or tag in ["selected_product", "total_other", "grand_total"]:
                self.product_association_tree.insert("", "end", values=row, tags=(tag,))
        
        # åˆ‡æ¢åˆ°äº§å“å…³è”åˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ
            self.product_notebook.select(5)  # é€‰æ‹©äº§å“å…³è”åˆ†æå­æ ‡ç­¾é¡µ
    
    def get_brand_analysis(self):
        """è·å–å“ç‰Œåˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            # DateEntryè¿”å›datetimeå¯¹è±¡ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
            
            # ä½¿ç”¨çº¯æ—¥æœŸæ ¼å¼ï¼Œä¸æ·»åŠ æ—¶é—´éƒ¨åˆ†
            if date_from and date_to and date_from == date_to:
                self.log_message(f"â„¹ å•æ—¥æŸ¥è¯¢: {date_from}")
            elif date_to:
                self.log_message(f"â„¹ æ—¥æœŸèŒƒå›´æŸ¥è¯¢: {date_from} åˆ° {date_to}")
        else:
            # ä¸ä½¿ç”¨æ—¥æœŸç­›é€‰ï¼Œåªä½¿ç”¨æœˆä»½ç­›é€‰
            # ä½†æ˜¯æ•°æ®åº“æŸ¥è¯¢éœ€è¦æ—¥æœŸèŒƒå›´ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªåˆç†çš„é»˜è®¤èŒƒå›´
            # å¦‚æœæ²¡æœ‰é€‰æ‹©æœˆä»½ï¼Œä½¿ç”¨å½“å‰æœˆä»½
            month_filters = self.month_combo.get_selected()
            if month_filters and len(month_filters) > 0:
                # ä½¿ç”¨é€‰ä¸­çš„ç¬¬ä¸€ä¸ªæœˆä»½ä½œä¸ºæ—¥æœŸèŒƒå›´
                selected_month = month_filters[0]
                year, month = selected_month.split('-')
                date_from = f"{year}-{month}-01"
                # è®¡ç®—è¯¥æœˆçš„æœ€åä¸€å¤©
                if month in ['01', '03', '05', '07', '08', '10', '12']:
                    last_day = 31
                elif month in ['04', '06', '09', '11']:
                    last_day = 30
                else:  # 2æœˆ
                    if int(year) % 4 == 0 and (int(year) % 100 != 0 or int(year) % 400 == 0):
                        last_day = 29
                    else:
                        last_day = 28
                date_to = f"{year}-{month}-{last_day:02d}"
                self.log_message(f"â„¹ ä½¿ç”¨æœˆä»½ç­›é€‰: {selected_month}")
            else:
                # å¦‚æœæ²¡æœ‰é€‰æ‹©æœˆä»½ï¼Œä½¿ç”¨å½“å‰æœˆä»½
                from datetime import datetime
                now = datetime.now()
                current_month = now.strftime('%Y-%m')
                year, month = current_month.split('-')
                date_from = f"{year}-{month}-01"
                if month in ['01', '03', '05', '07', '08', '10', '12']:
                    last_day = 31
                elif month in ['04', '06', '09', '11']:
                    last_day = 30
                else:  # 2æœˆ
                    if int(year) % 4 == 0 and (int(year) % 100 != 0 or int(year) % 400 == 0):
                        last_day = 29
                    else:
                        last_day = 28
                date_to = f"{year}-{month}-{last_day:02d}"
                self.log_message(f"â„¹ æœªé€‰æ‹©æœˆä»½ï¼Œä½¿ç”¨å½“å‰æœˆä»½: {current_month}")
            
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        print(f"GUIè·å–çš„æ˜ŸæœŸç­›é€‰: {weekday_filters}")
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–å“ç‰Œåˆ†æ...")
        self.brand_analysis_data = self.db_manager.get_brand_analysis(
            date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        
        if self.brand_analysis_data:
            self.display_brand_analysis()
            self.log_message(f"âœ“ è·å–å“ç‰Œåˆ†ææˆåŠŸï¼Œå…± {len(self.brand_analysis_data)} æ¡è®°å½•")
        else:
            self.log_message("âœ— è·å–å“ç‰Œåˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
    
    def display_brand_analysis(self):
        """æ˜¾ç¤ºå“ç‰Œåˆ†ææ•°æ®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.performance_comparison_tree.get_children():
            self.performance_comparison_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ("æœˆä»½\nMonth", "é—¨å¸‚\nOutlet", "å“ç‰Œ\nBrand", "æ€»æ•°é‡\nTotal Quantity", "æ€»å•æ®æ•°\nTotal Receipts", "æ€»ä¸šç»©\nTotal Sales")
        self.performance_comparison_tree["columns"] = columns
        self.performance_comparison_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜å’Œæ’åºåŠŸèƒ½
        for col in columns:
            self.performance_comparison_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.performance_comparison_tree, c))
            self.performance_comparison_tree.column(col, width=120, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)  # è¿›ä¸€æ­¥ç¼©å°æ•°æ®è¡Œé«˜åº¦åˆ°25åƒç´ 
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))  # ç¼©å°å­—ä½“ä½†å¢åŠ æ ‡é¢˜é«˜åº¦åˆ°80åƒç´ 
        
        # é…ç½®æ ‡ç­¾æ ·å¼
        self.performance_comparison_tree.tag_configure("sushi", background="#FFE6E6", foreground="#000000")      # æµ…çº¢è‰² - SUSHI
        self.performance_comparison_tree.tag_configure("noodles", background="#E6F3FF", foreground="#000000")    # æµ…è“è‰² - NOODLES
        self.performance_comparison_tree.tag_configure("tempura", background="#FFF0E6", foreground="#000000")    # æµ…æ©™è‰² - TEMPURA
        self.performance_comparison_tree.tag_configure("donburi", background="#E6FFE6", foreground="#000000")    # æµ…ç»¿è‰² - DONBURI
        self.performance_comparison_tree.tag_configure("salad", background="#F0E6FF", foreground="#000000")      # æµ…ç´«è‰² - SALAD
        self.performance_comparison_tree.tag_configure("beverage", background="#E6FFFF", foreground="#000000")    # æµ…é’è‰² - BEVERAGE
        self.performance_comparison_tree.tag_configure("other", background="#F5F5F5", foreground="#000000")       # æµ…ç°è‰² - OTHER
        
        # æ’å…¥æ•°æ®å¹¶è®¾ç½®é¢œè‰²
        for row in self.brand_analysis_data:
            æœˆä»½, é—¨å¸‚, å“ç‰Œ, æ€»æ•°é‡, æ€»å•æ®æ•°, æ€»ä¸šç»© = row
            
            # æ ¹æ®å“ç‰Œç¡®å®šæ ‡ç­¾
            brand_lower = å“ç‰Œ.lower()
            if 'sushi' in brand_lower or 'sashimi' in brand_lower:
                tag = "sushi"
            elif 'noodles' in brand_lower or 'ramen' in brand_lower or 'udon' in brand_lower:
                tag = "noodles"
            elif 'tempura' in brand_lower:
                tag = "tempura"
            elif 'donburi' in brand_lower or 'don' in brand_lower:
                tag = "donburi"
            elif 'salad' in brand_lower:
                tag = "salad"
            elif 'beverage' in brand_lower or 'drink' in brand_lower:
                tag = "beverage"
            else:
                tag = "other"
            
            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get():
                # æ ¼å¼åŒ–æ•°å€¼
                formatted_row = (
                    æœˆä»½, é—¨å¸‚, å“ç‰Œ,
                    f"{float(æ€»æ•°é‡):,.2f}",
                    f"{int(æ€»å•æ®æ•°):,}",
                    f"$ {float(æ€»ä¸šç»©):,.2f}"
                )
                
                self.performance_comparison_tree.insert("", "end", values=formatted_row, tags=(tag,))
        
        # åˆ‡æ¢åˆ°å“ç‰Œåˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(2)  # é€‰æ‹©Brandæ ‡ç­¾é¡µ
            self.brand_notebook.select(0)  # é€‰æ‹©å“ç‰Œåˆ†æå­æ ‡ç­¾é¡µ
    
    def get_brand_daily_breakdown(self):
        """è·å–å“ç‰Œæ¯æ—¥ç»†é¡¹åˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            selected_months = self.month_combo.get_selected()
            if selected_months:
                from datetime import datetime
                first_month = selected_months[0]
                dt = datetime.strptime(first_month, '%Y-%m')
                date_from = dt.replace(day=1).strftime('%Y-%m-%d')
                if dt.month == 12:
                    next_month = dt.replace(year=dt.year + 1, month=1, day=1)
                else:
                    next_month = dt.replace(month=dt.month + 1, day=1)
                date_to = (next_month - timedelta(days=1)).strftime('%Y-%m-%d')
            else:
                date_from = None
                date_to = None
                self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
        
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()

        # ä¿å­˜é—¨åº—ç­›é€‰ç”¨äºå•åº—å¹³å‡
        self.weekly_product_outlet_filters = [o for o in outlet_filters if o]
        
        self.log_message("æ­£åœ¨è·å–å“ç‰Œæ¯æ—¥ç»†é¡¹åˆ†æ...")
        self.brand_daily_data = self.db_manager.get_brand_daily_breakdown(
            date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        
        if self.brand_daily_data:
            self.display_brand_daily_breakdown()
            self.log_message(f"âœ“ è·å–å“ç‰Œæ¯æ—¥ç»†é¡¹åˆ†ææˆåŠŸï¼Œå…± {len(self.brand_daily_data)} æ¡è®°å½•")
        else:
            self.log_message("âœ— è·å–å“ç‰Œæ¯æ—¥ç»†é¡¹åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
    
    def display_brand_daily_breakdown(self):
        """æ˜¾ç¤ºå“ç‰Œæ¯æ—¥ç»†é¡¹åˆ†ææ•°æ®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.brand_daily_tree.get_children():
            self.brand_daily_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ("æ—¥æœŸ\nDate", "é—¨å¸‚\nOutlet", "æ€»ä¸šç»©\nTotal Sales", "æ€»å•æ®æ•°\nTotal Receipts", 
                  "æ€»å•æ®å¤§å°\nTotal Ticket Size", "DIä¸šç»©\nDI Sales", "DIå•æ®æ•°\nDI Receipts", "DIå•æ®å¤§å°\nDI Ticket Size",
                  "å¤–å¸¦ä¸šç»©\nTakeaway Sales", "å¤–å¸¦å•æ®æ•°\nTakeaway Receipts", "å¤–å¸¦å•æ®å¤§å°\nTakeaway Ticket Size",
                  "é…é€ä¸šç»©\nDelivery Sales", "é…é€å•æ®æ•°\nDelivery Receipts", "é…é€å•æ®å¤§å°\nDelivery Ticket Size",
                  "FOOD PANDAä¸šç»©\nFOOD PANDA Sales", "FOOD PANDAå•æ®æ•°\nFOOD PANDA Receipts", "FOOD PANDAå•æ®å¤§å°\nFOOD PANDA Ticket Size",
                  "GRAB FOODä¸šç»©\nGRAB FOOD Sales", "GRAB FOODå•æ®æ•°\nGRAB FOOD Receipts", "GRAB FOODå•æ®å¤§å°\nGRAB FOOD Ticket Size",
                  "DELIVEROOä¸šç»©\nDELIVEROO Sales", "DELIVEROOå•æ®æ•°\nDELIVEROO Receipts", "DELIVEROOå•æ®å¤§å°\nDELIVEROO Ticket Size")
        self.brand_daily_tree["columns"] = columns
        self.brand_daily_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜å’Œæ’åºåŠŸèƒ½
        for col in columns:
            self.brand_daily_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.brand_daily_tree, c))
            self.brand_daily_tree.column(col, width=120, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))
        
        # é…ç½®æ¯æ—¥æ€»è®¡è¡Œçš„é¢œè‰²
        style.configure("Treeview", background="#FFFFFF")
        style.configure("daily_total.Treeview", background="#FFFFFF", foreground="#000000")
        self.brand_daily_tree.tag_configure('daily_total', background='#FFFFFF', foreground='#000000')
        
        # æ’å…¥æ•°æ®
        total_sales = 0
        total_receipts = 0
        total_di_sales = 0
        total_di_receipts = 0
        total_takeaway_sales = 0
        total_takeaway_receipts = 0
        total_delivery_sales = 0
        total_delivery_receipts = 0
        total_foodpanda_sales = 0
        total_foodpanda_receipts = 0
        total_grab_sales = 0
        total_grab_receipts = 0
        total_deliveroo_sales = 0
        total_deliveroo_receipts = 0
        
        for row in self.brand_daily_data:
            formatted_row = (
                row['æ—¥æœŸ'],
                row['é—¨å¸‚'],
                format_currency(row['æ€»ä¸šç»©']),
                format_number(row['æ€»å•æ®æ•°']),
                format_currency(row['æ€»å•æ®å¤§å°']),
                format_currency(row['DIä¸šç»©']),
                format_number(row['DIå•æ®æ•°']),
                format_currency(row['DIå•æ®å¤§å°']),
                format_currency(row['å¤–å¸¦ä¸šç»©']),
                format_number(row['å¤–å¸¦å•æ®æ•°']),
                format_currency(row['å¤–å¸¦å•æ®å¤§å°']),
                format_currency(row['é…é€ä¸šç»©']),
                format_number(row['é…é€å•æ®æ•°']),
                format_currency(row['é…é€å•æ®å¤§å°']),
                format_currency(row['FOOD_PANDAä¸šç»©']),
                format_number(row['FOOD_PANDAå•æ®æ•°']),
                format_currency(row['FOOD_PANDAå•æ®å¤§å°']),
                format_currency(row['GRAB_FOODä¸šç»©']),
                format_number(row['GRAB_FOODå•æ®æ•°']),
                format_currency(row['GRAB_FOODå•æ®å¤§å°']),
                format_currency(row['DELIVEROOä¸šç»©']),
                format_number(row['DELIVEROOå•æ®æ•°']),
                format_currency(row['DELIVEROOå•æ®å¤§å°'])
            )
            
            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get():
                # æ£€æŸ¥æ˜¯å¦ä¸ºæ¯æ—¥æ€»è®¡è¡Œï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ é¢œè‰²
                if row.get('is_daily_total', False):
                    item = self.brand_daily_tree.insert("", "end", values=formatted_row, tags=('daily_total',))
                else:
                    self.brand_daily_tree.insert("", "end", values=formatted_row)
            
            # ç´¯è®¡æ€»è®¡
            total_sales += row['æ€»ä¸šç»©']
            total_receipts += row['æ€»å•æ®æ•°']
            total_di_sales += row['DIä¸šç»©']
            total_di_receipts += row['DIå•æ®æ•°']
            total_takeaway_sales += row['å¤–å¸¦ä¸šç»©']
            total_takeaway_receipts += row['å¤–å¸¦å•æ®æ•°']
            total_delivery_sales += row['é…é€ä¸šç»©']
            total_delivery_receipts += row['é…é€å•æ®æ•°']
            total_foodpanda_sales += row['FOOD_PANDAä¸šç»©']
            total_foodpanda_receipts += row['FOOD_PANDAå•æ®æ•°']
            total_grab_sales += row['GRAB_FOODä¸šç»©']
            total_grab_receipts += row['GRAB_FOODå•æ®æ•°']
            total_deliveroo_sales += row['DELIVEROOä¸šç»©']
            total_deliveroo_receipts += row['DELIVEROOå•æ®æ•°']
        
        # æ·»åŠ æ€»è®¡è¡Œ
        if self.brand_daily_data:
            total_ticket_size = total_sales / total_receipts if total_receipts > 0 else 0
            total_di_ticket_size = total_di_sales / total_di_receipts if total_di_receipts > 0 else 0
            total_takeaway_ticket_size = total_takeaway_sales / total_takeaway_receipts if total_takeaway_receipts > 0 else 0
            total_delivery_ticket_size = total_delivery_sales / total_delivery_receipts if total_delivery_receipts > 0 else 0
            total_foodpanda_ticket_size = total_foodpanda_sales / total_foodpanda_receipts if total_foodpanda_receipts > 0 else 0
            total_grab_ticket_size = total_grab_sales / total_grab_receipts if total_grab_receipts > 0 else 0
            total_deliveroo_ticket_size = total_deliveroo_sales / total_deliveroo_receipts if total_deliveroo_receipts > 0 else 0
            
            total_row = (
                "æ€»è®¡\nTotal",
                "å…¨éƒ¨é—¨åº—\nAll Outlets",
                format_currency(total_sales),
                format_number(total_receipts),
                format_currency(total_ticket_size),
                format_currency(total_di_sales),
                format_number(total_di_receipts),
                format_currency(total_di_ticket_size),
                format_currency(total_takeaway_sales),
                format_number(total_takeaway_receipts),
                format_currency(total_takeaway_ticket_size),
                format_currency(total_delivery_sales),
                format_number(total_delivery_receipts),
                format_currency(total_delivery_ticket_size),
                format_currency(total_foodpanda_sales),
                format_number(total_foodpanda_receipts),
                format_currency(total_foodpanda_ticket_size),
                format_currency(total_grab_sales),
                format_number(total_grab_receipts),
                format_currency(total_grab_ticket_size),
                format_currency(total_deliveroo_sales),
                format_number(total_deliveroo_receipts),
                format_currency(total_deliveroo_ticket_size)
            )
            
            # æ’å…¥æ€»è®¡è¡Œå¹¶è®¾ç½®é¢œè‰²
            total_item = self.brand_daily_tree.insert("", "end", values=total_row, tags=("total",))
            self.brand_daily_tree.tag_configure("total", background="#E6F3FF", font=('Arial', 9, 'bold'))
        
        # åˆ‡æ¢åˆ°æ¯æ—¥ç»†é¡¹æ ‡ç­¾é¡µ
        self.safe_switch_to_tab(2, 0)
    
    def get_performance_comparison(self):
        """è·å–ä¸šç»©å¯¹æ¯”åˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        self.log_message(f"æ­£åœ¨è¿æ¥åˆ° {db}...")
        
        if not self.db_manager.connect(db):
            self.log_message(f"âœ— æ— æ³•è¿æ¥åˆ° {db}")
            return
        
        self.log_message(f"âœ“ è¿æ¥æˆåŠŸ", include_db_info=True)
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            selected_months = self.month_combo.get_selected()
            if selected_months:
                first_month = selected_months[0]
                dt = datetime.strptime(first_month, '%Y-%m')
                date_from = dt.strftime('%Y-%m-01')
                if dt.month == 12:
                    next_month = datetime(dt.year + 1, 1, 1)
                else:
                    next_month = datetime(dt.year, dt.month + 1, 1)
                date_to = (next_month - timedelta(days=1)).strftime('%Y-%m-%d')
            else:
                date_from = None
                date_to = None
        
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        # è·å–å¯¹æ¯”å‚æ•°
        comparison_method = self.comparison_method.get()
        comparison_date_from = self.comparison_date_from.get_date() if self.comparison_date_from.get_date() else None
        comparison_date_to = self.comparison_date_to.get_date() if self.comparison_date_to.get_date() else None
        comparison_weeks = self.comparison_week_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–ä¸šç»©å¯¹æ¯”åˆ†æ...")
        self.performance_comparison_data = self.db_manager.get_performance_comparison(
            date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters,
            comparison_method, comparison_date_from, comparison_date_to, comparison_weeks
        )
        
        if self.performance_comparison_data:
            self.display_performance_comparison()
            self.log_message(f"âœ“ è·å–ä¸šç»©å¯¹æ¯”åˆ†ææˆåŠŸï¼Œå…± {len(self.performance_comparison_data)} æ¡è®°å½•")
        else:
            self.log_message("âœ— è·å–ä¸šç»©å¯¹æ¯”åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
    
    def display_performance_comparison(self):
        """æ˜¾ç¤ºä¸šç»©å¯¹æ¯”åˆ†ææ•°æ®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.performance_comparison_tree.get_children():
            self.performance_comparison_tree.delete(item)
        
        if not self.performance_comparison_data:
            return
        
        # æ ¹æ®æ˜¾ç¤ºè¯¦ç»†å¼€å…³è¿‡æ»¤æ•°æ®
        if not self.show_performance_details.get():
            # åªæ˜¾ç¤ºæ€»è®¡è¡Œ
            filtered_data = [data for data in self.performance_comparison_data if 'æ€»è®¡' in data['äº§å“åç§°']]
        else:
            # æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
            filtered_data = self.performance_comparison_data
        
        # æ·»åŠ æ•°æ®åˆ°è¡¨æ ¼
        for data in filtered_data:
            values = (
                data['äº§å“åç§°'],
                data['æœŸé—´'],
                f"$ {data['æ€»ä¸šç»©']:,.2f}",
                f"{data['æ€»å•æ®']:,}",
                f"$ {data['å¹³å‡å•æ®']:,.2f}",
                f"$ {data['äº§å“ä¸šç»©']:,.2f}",
                f"{data['äº§å“å•æ®']:,}",
                f"{data['æŠ¥åºŸæ•°é‡']:,.0f}",
                f"{data['ä¸šç»©å æ¯”']:.2f}%",
                f"{data['å•æ®å æ¯”']:.2f}%"
            )
            
            # æ ¹æ®äº§å“åç§°è®¾ç½®ä¸åŒçš„æ ‡ç­¾
            if 'æ€»è®¡' in data['äº§å“åç§°']:
                item = self.performance_comparison_tree.insert("", "end", values=values, tags=("total",))
            else:
                item = self.performance_comparison_tree.insert("", "end", values=values)
        
        # é…ç½®æ€»è®¡è¡Œçš„æ ·å¼
        self.performance_comparison_tree.tag_configure("total", background="#E6F3FF", font=('Arial', 9, 'bold'))
        
        # åˆ‡æ¢åˆ°ä¸šç»©å¯¹æ¯”æ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(2)  # é€‰æ‹©Brandæ ‡ç­¾é¡µ
            self.brand_notebook.select(2)  # é€‰æ‹©ä¸šç»©å¯¹æ¯”å­æ ‡ç­¾é¡µ

    def get_brand_period_summary(self):
        """è·å–å“ç‰ŒæœŸé—´æ±‡æ€»åˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
        
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–å“ç‰ŒæœŸé—´æ±‡æ€»åˆ†æ...")
        self.brand_period_data = self.db_manager.get_brand_period_summary(
            date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        
        if self.brand_period_data:
            self.display_brand_period_summary()
            self.log_message(f"âœ“ è·å–å“ç‰ŒæœŸé—´æ±‡æ€»åˆ†ææˆåŠŸï¼Œå…± {len(self.brand_period_data)} æ¡è®°å½•")
        else:
            self.log_message("âœ— è·å–å“ç‰ŒæœŸé—´æ±‡æ€»åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
    
    def display_brand_period_summary(self):
        """æ˜¾ç¤ºå“ç‰ŒæœŸé—´æ±‡æ€»åˆ†ææ•°æ®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.brand_period_tree.get_children():
            self.brand_period_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ("æœŸé—´\nPeriod", "é—¨å¸‚\nOutlet", "æ€»ä¸šç»©\nTotal Sales", "æ€»å•æ®æ•°\nTotal Receipts", 
                  "æ€»å•æ®å¤§å°\nTotal Ticket Size", "DIä¸šç»©\nDI Sales", "DIå•æ®æ•°\nDI Receipts", "DIå•æ®å¤§å°\nDI Ticket Size",
                  "å¤–å¸¦ä¸šç»©\nTakeaway Sales", "å¤–å¸¦å•æ®æ•°\nTakeaway Receipts", "å¤–å¸¦å•æ®å¤§å°\nTakeaway Ticket Size",
                  "é…é€ä¸šç»©\nDelivery Sales", "é…é€å•æ®æ•°\nDelivery Receipts", "é…é€å•æ®å¤§å°\nDelivery Ticket Size",
                  "FOOD PANDAä¸šç»©\nFOOD PANDA Sales", "FOOD PANDAå•æ®æ•°\nFOOD PANDA Receipts", "FOOD PANDAå•æ®å¤§å°\nFOOD PANDA Ticket Size",
                  "GRAB FOODä¸šç»©\nGRAB FOOD Sales", "GRAB FOODå•æ®æ•°\nGRAB FOOD Receipts", "GRAB FOODå•æ®å¤§å°\nGRAB FOOD Ticket Size",
                  "DELIVEROOä¸šç»©\nDELIVEROO Sales", "DELIVEROOå•æ®æ•°\nDELIVEROO Receipts", "DELIVEROOå•æ®å¤§å°\nDELIVEROO Ticket Size")
        self.brand_period_tree["columns"] = columns
        self.brand_period_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜å’Œæ’åºåŠŸèƒ½
        for col in columns:
            self.brand_period_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.brand_period_tree, c))
            self.brand_period_tree.column(col, width=120, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))
        
        # æ’å…¥æ•°æ®
        total_sales = 0
        total_receipts = 0
        total_di_sales = 0
        total_di_receipts = 0
        total_takeaway_sales = 0
        total_takeaway_receipts = 0
        total_delivery_sales = 0
        total_delivery_receipts = 0
        total_foodpanda_sales = 0
        total_foodpanda_receipts = 0
        total_grab_sales = 0
        total_grab_receipts = 0
        total_deliveroo_sales = 0
        total_deliveroo_receipts = 0
        
        for row in self.brand_period_data:
            # æ ¹æ®æ—¥å‡å¼€å…³å†³å®šæ˜¾ç¤ºæ ¼å¼
            if self.show_brand_daily_average.get():
                # æ˜¾ç¤ºæ—¥å‡æ•°æ®
                formatted_row = (
                    row['æœŸé—´'],
                    row['é—¨å¸‚'],
                    format_currency(row['æ€»ä¸šç»©_æ—¥å‡']),
                    format_number(row['æ€»å•æ®æ•°_æ—¥å‡']),
                    format_currency(row['æ€»å•æ®å¤§å°_æ—¥å‡']),
                    format_currency(row['DIä¸šç»©_æ—¥å‡']),
                    format_number(row['DIå•æ®æ•°_æ—¥å‡']),
                    format_currency(row['DIå•æ®å¤§å°_æ—¥å‡']),
                    format_currency(row['å¤–å¸¦ä¸šç»©_æ—¥å‡']),
                    format_number(row['å¤–å¸¦å•æ®æ•°_æ—¥å‡']),
                    format_currency(row['å¤–å¸¦å•æ®å¤§å°_æ—¥å‡']),
                    format_currency(row['é…é€ä¸šç»©_æ—¥å‡']),
                    format_number(row['é…é€å•æ®æ•°_æ—¥å‡']),
                    format_currency(row['é…é€å•æ®å¤§å°_æ—¥å‡']),
                    format_currency(row['FOOD_PANDAä¸šç»©_æ—¥å‡']),
                    format_number(row['FOOD_PANDAå•æ®æ•°_æ—¥å‡']),
                    format_currency(row['FOOD_PANDAå•æ®å¤§å°_æ—¥å‡']),
                    format_currency(row['GRAB_FOODä¸šç»©_æ—¥å‡']),
                    format_number(row['GRAB_FOODå•æ®æ•°_æ—¥å‡']),
                    format_currency(row['GRAB_FOODå•æ®å¤§å°_æ—¥å‡']),
                    format_currency(row['DELIVEROOä¸šç»©_æ—¥å‡']),
                    format_number(row['DELIVEROOå•æ®æ•°_æ—¥å‡']),
                    format_currency(row['DELIVEROOå•æ®å¤§å°_æ—¥å‡'])
                )
                # ç´¯è®¡æ€»è®¡ï¼ˆä½¿ç”¨åŸå§‹æ•°æ®ï¼‰
                total_sales += row['æ€»ä¸šç»©']
                total_receipts += row['æ€»å•æ®æ•°']
                total_di_sales += row['DIä¸šç»©']
                total_di_receipts += row['DIå•æ®æ•°']
                total_takeaway_sales += row['å¤–å¸¦ä¸šç»©']
                total_takeaway_receipts += row['å¤–å¸¦å•æ®æ•°']
                total_delivery_sales += row['é…é€ä¸šç»©']
                total_delivery_receipts += row['é…é€å•æ®æ•°']
                total_foodpanda_sales += row['FOOD_PANDAä¸šç»©']
                total_foodpanda_receipts += row['FOOD_PANDAå•æ®æ•°']
                total_grab_sales += row['GRAB_FOODä¸šç»©']
                total_grab_receipts += row['GRAB_FOODå•æ®æ•°']
                total_deliveroo_sales += row['DELIVEROOä¸šç»©']
                total_deliveroo_receipts += row['DELIVEROOå•æ®æ•°']
            else:
                # æ˜¾ç¤ºæ€»æ•°æ®
                formatted_row = (
                    row['æœŸé—´'],
                    row['é—¨å¸‚'],
                    format_currency(row['æ€»ä¸šç»©']),
                    format_number(row['æ€»å•æ®æ•°']),
                    format_currency(row['æ€»å•æ®å¤§å°']),
                    format_currency(row['DIä¸šç»©']),
                    format_number(row['DIå•æ®æ•°']),
                    format_currency(row['DIå•æ®å¤§å°']),
                    format_currency(row['å¤–å¸¦ä¸šç»©']),
                    format_number(row['å¤–å¸¦å•æ®æ•°']),
                    format_currency(row['å¤–å¸¦å•æ®å¤§å°']),
                    format_currency(row['é…é€ä¸šç»©']),
                    format_number(row['é…é€å•æ®æ•°']),
                    format_currency(row['é…é€å•æ®å¤§å°']),
                    format_currency(row['FOOD_PANDAä¸šç»©']),
                    format_number(row['FOOD_PANDAå•æ®æ•°']),
                    format_currency(row['FOOD_PANDAå•æ®å¤§å°']),
                    format_currency(row['GRAB_FOODä¸šç»©']),
                    format_number(row['GRAB_FOODå•æ®æ•°']),
                    format_currency(row['GRAB_FOODå•æ®å¤§å°']),
                    format_currency(row['DELIVEROOä¸šç»©']),
                    format_number(row['DELIVEROOå•æ®æ•°']),
                    format_currency(row['DELIVEROOå•æ®å¤§å°'])
                )
                # ç´¯è®¡æ€»è®¡
                total_sales += row['æ€»ä¸šç»©']
                total_receipts += row['æ€»å•æ®æ•°']
                total_di_sales += row['DIä¸šç»©']
                total_di_receipts += row['DIå•æ®æ•°']
                total_takeaway_sales += row['å¤–å¸¦ä¸šç»©']
                total_takeaway_receipts += row['å¤–å¸¦å•æ®æ•°']
                total_delivery_sales += row['é…é€ä¸šç»©']
                total_delivery_receipts += row['é…é€å•æ®æ•°']
                total_foodpanda_sales += row['FOOD_PANDAä¸šç»©']
                total_foodpanda_receipts += row['FOOD_PANDAå•æ®æ•°']
                total_grab_sales += row['GRAB_FOODä¸šç»©']
                total_grab_receipts += row['GRAB_FOODå•æ®æ•°']
                total_deliveroo_sales += row['DELIVEROOä¸šç»©']
                total_deliveroo_receipts += row['DELIVEROOå•æ®æ•°']
            
            # æ ¹æ®å¼€å…³çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ•°æ®
            if self.show_product_details.get():
                self.brand_period_tree.insert("", "end", values=formatted_row)
        
        # æ·»åŠ æ€»è®¡è¡Œ
        if self.brand_period_data:
            total_ticket_size = total_sales / total_receipts if total_receipts > 0 else 0
            total_di_ticket_size = total_di_sales / total_di_receipts if total_di_receipts > 0 else 0
            total_takeaway_ticket_size = total_takeaway_sales / total_takeaway_receipts if total_takeaway_receipts > 0 else 0
            total_delivery_ticket_size = total_delivery_sales / total_delivery_receipts if total_delivery_receipts > 0 else 0
            total_foodpanda_ticket_size = total_foodpanda_sales / total_foodpanda_receipts if total_foodpanda_receipts > 0 else 0
            total_grab_ticket_size = total_grab_sales / total_grab_receipts if total_grab_receipts > 0 else 0
            total_deliveroo_ticket_size = total_deliveroo_sales / total_deliveroo_receipts if total_deliveroo_receipts > 0 else 0
            
            if self.show_brand_daily_average.get():
                # æ˜¾ç¤ºæ—¥å‡æ€»è®¡
                total_row = (
                    "æ€»è®¡\nTotal",
                    "å…¨éƒ¨é—¨åº—\nAll Outlets",
                    format_currency(total_sales / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_number(total_receipts / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_currency(total_ticket_size),
                    format_currency(total_di_sales / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_number(total_di_receipts / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_currency(total_di_ticket_size),
                    format_currency(total_takeaway_sales / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_number(total_takeaway_receipts / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_currency(total_takeaway_ticket_size),
                    format_currency(total_delivery_sales / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_number(total_delivery_receipts / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_currency(total_delivery_ticket_size),
                    format_currency(total_foodpanda_sales / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_number(total_foodpanda_receipts / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_currency(total_foodpanda_ticket_size),
                    format_currency(total_grab_sales / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_number(total_grab_receipts / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_currency(total_grab_ticket_size),
                    format_currency(total_deliveroo_sales / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_number(total_deliveroo_receipts / len(self.brand_period_data) if self.brand_period_data else 0),
                    format_currency(total_deliveroo_ticket_size)
                )
            else:
                # æ˜¾ç¤ºæ€»æ•°æ®æ€»è®¡
                total_row = (
                    "æ€»è®¡\nTotal",
                    "å…¨éƒ¨é—¨åº—\nAll Outlets",
                    format_currency(total_sales),
                    format_number(total_receipts),
                    format_currency(total_ticket_size),
                    format_currency(total_di_sales),
                    format_number(total_di_receipts),
                    format_currency(total_di_ticket_size),
                    format_currency(total_takeaway_sales),
                    format_number(total_takeaway_receipts),
                    format_currency(total_takeaway_ticket_size),
                    format_currency(total_delivery_sales),
                    format_number(total_delivery_receipts),
                    format_currency(total_delivery_ticket_size),
                    format_currency(total_foodpanda_sales),
                    format_number(total_foodpanda_receipts),
                    format_currency(total_foodpanda_ticket_size),
                    format_currency(total_grab_sales),
                    format_number(total_grab_receipts),
                    format_currency(total_grab_ticket_size),
                    format_currency(total_deliveroo_sales),
                    format_number(total_deliveroo_receipts),
                    format_currency(total_deliveroo_ticket_size)
                )
            
            # æ’å…¥æ€»è®¡è¡Œå¹¶è®¾ç½®é¢œè‰²
            total_item = self.brand_period_tree.insert("", "end", values=total_row, tags=("total",))
            self.brand_period_tree.tag_configure("total", background="#E6F3FF", font=('Arial', 9, 'bold'))
        
        # åˆ‡æ¢åˆ°æœŸé—´æ±‡æ€»æ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(2)  # é€‰æ‹©Brandæ ‡ç­¾é¡µ
            self.brand_notebook.select(1)  # é€‰æ‹©æœŸé—´æ±‡æ€»å­æ ‡ç­¾é¡µ
    
    def get_category_analysis(self):
        """è·å–ç±»åˆ«åˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
        
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–ç±»åˆ«åˆ†æ...")
        self.category_analysis_data = self.db_manager.get_category_analysis(
            date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        
        if self.category_analysis_data:
            self.display_category_analysis()
            self.log_message(f"âœ“ è·å–ç±»åˆ«åˆ†ææˆåŠŸï¼Œå…± {len(self.category_analysis_data)} æ¡è®°å½•")
        else:
            self.log_message("âœ— è·å–ç±»åˆ«åˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
    
    def display_category_analysis(self):
        """æ˜¾ç¤ºç±»åˆ«åˆ†ææ•°æ®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.category_analysis_tree.get_children():
            self.category_analysis_tree.delete(item)
        
        # è®¾ç½®åˆ—
        columns = ("æœˆä»½\nMonth", "é—¨å¸‚\nOutlet", "ç±»åˆ«\nCategory", "æ€»ä¸šç»©\nTotal Sales", "æ€»å•æ®æ•°\nTotal Receipts", 
                  "æ€»å•æ®å¤§å°\nTotal Ticket Size", "DIä¸šç»©\nDI Sales", "DIå•æ®æ•°\nDI Receipts", "DIå•æ®å¤§å°\nDI Ticket Size",
                  "å¤–å¸¦ä¸šç»©\nTakeaway Sales", "å¤–å¸¦å•æ®æ•°\nTakeaway Receipts", "å¤–å¸¦å•æ®å¤§å°\nTakeaway Ticket Size",
                  "é…é€ä¸šç»©\nDelivery Sales", "é…é€å•æ®æ•°\nDelivery Receipts", "é…é€å•æ®å¤§å°\nDelivery Ticket Size",
                  "FOOD PANDAä¸šç»©\nFOOD PANDA Sales", "FOOD PANDAå•æ®æ•°\nFOOD PANDA Receipts", "FOOD PANDAå•æ®å¤§å°\nFOOD PANDA Ticket Size",
                  "GRAB FOODä¸šç»©\nGRAB FOOD Sales", "GRAB FOODå•æ®æ•°\nGRAB FOOD Receipts", "GRAB FOODå•æ®å¤§å°\nGRAB FOOD Ticket Size",
                  "DELIVEROOä¸šç»©\nDELIVEROO Sales", "DELIVEROOå•æ®æ•°\nDELIVEROO Receipts", "DELIVEROOå•æ®å¤§å°\nDELIVEROO Ticket Size")
        self.category_analysis_tree["columns"] = columns
        self.category_analysis_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜å’Œæ’åºåŠŸèƒ½
        for col in columns:
            self.category_analysis_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.category_analysis_tree, c))
            self.category_analysis_tree.column(col, width=120, anchor="center")
        
        # è®¾ç½®è¡Œé«˜ä»¥æ˜¾ç¤ºä¸­è‹±æ–‡æ ‡é¢˜
        style = ttk.Style()
        style.configure("Treeview", rowheight=25)
        style.configure("Treeview.Heading", font=('Arial', 9, 'bold'), height=80, background="#34495e", foreground="white", padding=(10, 8))
        
        # æ’å…¥æ•°æ®
        for row in self.category_analysis_data:
            formatted_row = (
                row['æœˆä»½'],
                row['é—¨å¸‚'],
                row['ç±»åˆ«'],
                format_currency(row['æ€»ä¸šç»©']),
                format_number(row['æ€»å•æ®æ•°']),
                format_currency(row['æ€»å•æ®å¤§å°']),
                format_currency(row['DIä¸šç»©']),
                format_number(row['DIå•æ®æ•°']),
                format_currency(row['DIå•æ®å¤§å°']),
                format_currency(row['å¤–å¸¦ä¸šç»©']),
                format_number(row['å¤–å¸¦å•æ®æ•°']),
                format_currency(row['å¤–å¸¦å•æ®å¤§å°']),
                format_currency(row['é…é€ä¸šç»©']),
                format_number(row['é…é€å•æ®æ•°']),
                format_currency(row['é…é€å•æ®å¤§å°']),
                format_currency(row['FOOD_PANDAä¸šç»©']),
                format_number(row['FOOD_PANDAå•æ®æ•°']),
                format_currency(row['FOOD_PANDAå•æ®å¤§å°']),
                format_currency(row['GRAB_FOODä¸šç»©']),
                format_number(row['GRAB_FOODå•æ®æ•°']),
                format_currency(row['GRAB_FOODå•æ®å¤§å°']),
                format_currency(row['DELIVEROOä¸šç»©']),
                format_number(row['DELIVEROOå•æ®æ•°']),
                format_currency(row['DELIVEROOå•æ®å¤§å°'])
            )
            
            self.category_analysis_tree.insert("", "end", values=formatted_row)
        
        # åˆ‡æ¢åˆ°ç±»åˆ«åˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ
            self.product_notebook.select(6)  # é€‰æ‹©ç±»åˆ«åˆ†æå­æ ‡ç­¾é¡µ
    
    def get_weekly_product_data(self):
        """è·å–å‘¨æœŸäº§å“æ•°æ®"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        self.log_message(f"æ­£åœ¨è¿æ¥åˆ° {db}...")
        
        if not self.db_manager.connect(db):
            self.log_message(f"âœ— æ— æ³•è¿æ¥åˆ° {db}")
            return
        
        self.log_message(f"âœ“ è¿æ¥æˆåŠŸ", include_db_info=True)
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            date_from = None
            date_to = None
        
        outlet_filters = self.outlet_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–å‘¨æœŸäº§å“æ•°æ®...")
        print(f"DEBUG: è°ƒç”¨ get_weekly_product_dataï¼Œå‚æ•°: date_from={date_from}, date_to={date_to}")
        print(f"DEBUG: ç­›é€‰æ¡ä»¶: outlet_filters={outlet_filters}, month_filters={month_filters}, weekday_filters={weekday_filters}, category_filters={category_filters}, payment_filters={payment_filters}")
        
        # æ¸…ç†ç¼“å­˜ä»¥ç¡®ä¿è·å–æœ€æ–°æ•°æ®
        if hasattr(self.db_manager, '_weekly_cache'):
            self.db_manager._weekly_cache.clear()
            print("DEBUG: å·²æ¸…ç†å‘¨æœŸäº§å“æ•°æ®ç¼“å­˜")
        
        # å¼ºåˆ¶æ¸…ç†æ‰€æœ‰ç›¸å…³ç¼“å­˜
        if hasattr(self.db_manager, '_product_cache'):
            self.db_manager._product_cache.clear()
        if hasattr(self.db_manager, '_period_product_cache'):
            self.db_manager._period_product_cache.clear()
        
        try:
            self.weekly_product_data = self.db_manager.get_weekly_product_data(
                date_from, date_to, outlet_filters, month_filters, weekday_filters, category_filters, payment_filters
            )
            print(f"DEBUG: get_weekly_product_data è¿”å›ç»“æœ: {len(self.weekly_product_data) if self.weekly_product_data else 0} æ¡è®°å½•")
            self.weekly_product_store_count = self.db_manager.get_unique_store_count(
                date_from=date_from,
                date_to=date_to,
                outlet_filters=outlet_filters,
                month_filters=month_filters,
                weekday_filters=weekday_filters,
                category_filters=category_filters,
                product_filters=None,
                payment_filters=payment_filters
            ) or 1
            
            if self.weekly_product_data:
                print(f"DEBUG: å‡†å¤‡æ˜¾ç¤º {len(self.weekly_product_data)} æ¡å‘¨-äº§å“æ•°æ®")
                self.display_weekly_product_data()
                self.log_message(f"âœ“ è·å–å‘¨æœŸäº§å“æ•°æ®æˆåŠŸï¼Œå…± {len(self.weekly_product_data)} æ¡è®°å½•")
                # ç¡®ä¿åˆ‡æ¢åˆ°æ­£ç¡®çš„æ ‡ç­¾é¡µ
                if hasattr(self, 'product_notebook'):
                    self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ
                    self.product_notebook.select(1)  # é€‰æ‹©å‘¨-äº§å“æ•°æ®å­æ ‡ç­¾é¡µ
            else:
                self.log_message("âœ— è·å–å‘¨æœŸäº§å“æ•°æ®å¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
                print("DEBUG: å‘¨-äº§å“æ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤º")
        except Exception as e:
            self.log_message(f"âœ— è·å–å‘¨æœŸäº§å“æ•°æ®å‘ç”Ÿå¼‚å¸¸: {str(e)}")
            print(f"DEBUG: è·å–å‘¨æœŸäº§å“æ•°æ®å¼‚å¸¸: {e}")
        finally:
            self.db_manager.disconnect()
    
    def display_weekly_product_data(self):
        """æ˜¾ç¤ºå‘¨æœŸäº§å“æ•°æ®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.weekly_product_tree.get_children():
            self.weekly_product_tree.delete(item)
        
        # æ¸…ç©ºé¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_weekly_products = []
        
        if not self.weekly_product_data:
            return
        
        # æ·»åŠ æ•°æ®åˆ°è¡¨æ ¼
        # æ£€æŸ¥æ•°æ®æ ¼å¼ä»¥ç¡®å®šæ­£ç¡®çš„é”®å
        if self.weekly_product_data:
            first_data = self.weekly_product_data[0]
            # åˆ¤æ–­æ˜¯åˆå¹¶æ¨¡å¼è¿˜æ˜¯å•ä¸€æ¨¡å¼
            if 'äº§å“ä¸šç»©' in first_data:
                # åˆå¹¶æ¨¡å¼
                display_revenue_key = 'æ—¥å‡ä¸šç»©' if self.show_daily_average.get() else 'äº§å“ä¸šç»©'
                receipt_key = 'äº§å“å•æ®æ•°'
                quantity_key = 'é”€å”®æ•°é‡'
            else:
                # å•ä¸€æ¨¡å¼
                display_revenue_key = 'æ€»ä¸šç»©_æ—¥å‡' if self.show_daily_average.get() else 'æ€»ä¸šç»©'
                receipt_key = 'æ€»å•æ®æ•°'
                quantity_key = 'é”€å”®æ€»æ•°'
        else:
            # é»˜è®¤å€¼
            display_revenue_key = 'æ€»ä¸šç»©_æ—¥å‡' if self.show_daily_average.get() else 'æ€»ä¸šç»©'
            receipt_key = 'æ€»å•æ®æ•°'
            quantity_key = 'é”€å”®æ€»æ•°'
        
        revenue_column_label = "æ—¥å‡ä¸šç»©" if self.show_daily_average.get() else "äº§å“ä¸šç»©"
        self.weekly_product_tree.heading("ä¸šç»©", text=revenue_column_label)

        # æ ¹æ®å½“å‰ç­›é€‰ç¡®å®šé—¨åº—æ•°é‡ç”¨äºå•åº—å¹³å‡
        store_count = self.weekly_product_store_count if getattr(self, 'weekly_product_store_count', 0) else 1

        for data in self.weekly_product_data:
            revenue_value = data[display_revenue_key]
            receipt_value = data[receipt_key]
            quantity_value = data[quantity_key]

            if self.show_store_average.get() and store_count > 0:
                revenue_value = revenue_value / store_count
                receipt_value = receipt_value / store_count
                quantity_value = quantity_value / store_count

            revenue_display = f"$ {revenue_value:,.2f}"

            values = (
                data['äº§å“åç§°'],
                data['å‘¨æ•°'],
                data['æœŸé—´'],
                revenue_display,
                format_number(receipt_value),
                format_number(quantity_value)
            )
            
            # æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ ‡ç­¾
            if data.get('ç±»å‹') == 'Total':
                item = self.weekly_product_tree.insert("", "end", values=values, tags=("total",))
            else:
                item = self.weekly_product_tree.insert("", "end", values=values)
        
        # é…ç½®æ€»è®¡è¡Œçš„æ ·å¼
        self.weekly_product_tree.tag_configure("total", background="#E6F3FF", font=('Arial', 9, 'bold'))
        
        # æ·»åŠ é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œï¼ˆåˆå§‹ç‚ºç©ºï¼‰
        self.update_weekly_selected_products_summary()
        
        # åˆ‡æ¢åˆ°å‘¨æœŸäº§å“æ•°æ®æ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
            self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ
            self.product_notebook.select(1)  # é€‰æ‹©å‘¨æœŸäº§å“æ•°æ®å­æ ‡ç­¾é¡µ

    def get_product_overview(self):
        """è·å–äº§å“æ€»è§ˆåˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
        
        outlet_filters = self.outlet_combo.get_selected()
        product_filters = self.product_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        # ä¿å­˜é—¨å¸‚ç­›é€‰æ¡ä»¶
        self.product_overview_outlet_filters = [o for o in outlet_filters if o]
        
        self.log_message("æ­£åœ¨è·å–äº§å“æ€»è§ˆåˆ†æ...")
        self.product_overview_data = self.db_manager.get_product_overview(
            date_from, date_to, outlet_filters, product_filters, month_filters, weekday_filters, category_filters, payment_filters
        )
        self.product_overview_store_count = self.db_manager.get_unique_store_count(
            date_from=date_from,
            date_to=date_to,
            outlet_filters=self.product_overview_outlet_filters,
            month_filters=month_filters,
            weekday_filters=weekday_filters,
            category_filters=category_filters,
            product_filters=product_filters,
            payment_filters=payment_filters
        ) or 1
        
        if self.product_overview_data:
            self.display_product_overview()
            self.log_message(f"âœ“ è·å–äº§å“æ€»è§ˆåˆ†ææˆåŠŸï¼Œå…± {len(self.product_overview_data)} æ¡è®°å½•")
        else:
            self.log_message("âœ— è·å–äº§å“æ€»è§ˆåˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
    
    def get_period_product_overview(self):
        """è·å–æœŸé—´äº§å“æ€»è§ˆåˆ†æ"""
        # éªŒè¯æ—¥æœŸèŒƒå›´
        if not self.validate_date_range():
            return
            
        # å…ˆè¿æ¥æ•°æ®åº“
        db = self.selected_db.get()
        print(f"ğŸ” å°è¯•è¿æ¥æ•°æ®åº“: {db}")
        if not self.db_manager.connect(db):
            self.log_message("âœ— æ•°æ®åº“è¿æ¥å¤±è´¥")
            print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {db}")
            return
        
        # æµ‹è¯•æ•°æ®åº“è¿æ¥
        try:
            cursor = self.db_manager.connection.cursor()
            cursor.execute("SELECT COUNT(*) FROM pos_sales_dtls")
            result = cursor.fetchone()
            print(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œpos_sales_dtlsè¡¨è®°å½•æ•°: {result[0] if result else 0}")
            cursor.close()
        except Exception as e:
            print(f"âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: {e}")
            self.log_message(f"âœ— æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: {e}")
            return
        
        # è·å–ç­›é€‰æ¡ä»¶
        if self.use_date_filter.get():
            date_from = self.date_from.get_date().strftime('%Y-%m-%d') if self.date_from.get_date() else None
            date_to = self.date_to.get_date().strftime('%Y-%m-%d') if self.date_to.get_date() else None
        else:
            date_from = None
            date_to = None
            self.log_message("â„¹ æœªå¯ç”¨æ—¥æœŸç­›é€‰ï¼Œå°†ä½¿ç”¨æœˆä»½ç­›é€‰")
        
        outlet_filters = self.outlet_combo.get_selected()
        product_filters = self.product_combo.get_selected()
        month_filters = self.month_combo.get_selected()
        weekday_filters = self.weekday_combo.get_selected()
        category_filters = self.category_combo.get_selected()
        payment_filters = self.payment_combo.get_selected()
        
        self.log_message("æ­£åœ¨è·å–æœŸé—´äº§å“æ€»è§ˆåˆ†æ...")
        try:
            self.period_product_overview_data = self.db_manager.get_period_product_overview(
                date_from, date_to, outlet_filters, product_filters, month_filters, weekday_filters, category_filters, payment_filters
            )
            self.period_product_store_count = self.db_manager.get_unique_store_count(
                date_from=date_from,
                date_to=date_to,
                outlet_filters=self.period_product_outlet_filters,
                month_filters=month_filters,
                weekday_filters=weekday_filters,
                category_filters=category_filters,
                product_filters=product_filters,
                payment_filters=payment_filters
            ) or 1
            
            if self.period_product_overview_data and len(self.period_product_overview_data) > 0:
                self.display_period_product_overview()
                self.log_message(f"âœ“ è·å–æœŸé—´äº§å“æ€»è§ˆåˆ†ææˆåŠŸï¼Œå…± {len(self.period_product_overview_data)} æ¡è®°å½•")
                # ç¡®ä¿åˆ‡æ¢åˆ°æ­£ç¡®çš„æ ‡ç­¾é¡µ
                if hasattr(self, 'product_notebook'):
                    self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ
                    self.product_notebook.select(2)  # é€‰æ‹©æœŸé—´-äº§å“æ•°æ®å­æ ‡ç­¾é¡µ
            else:
                self.log_message("âœ— è·å–æœŸé—´äº§å“æ€»è§ˆåˆ†æå¤±è´¥æˆ–æ²¡æœ‰æ•°æ®")
        except Exception as e:
            self.log_message(f"âœ— è·å–æœŸé—´äº§å“æ€»è§ˆåˆ†æå‘ç”Ÿå¼‚å¸¸: {str(e)}")
        finally:
            self.db_manager.disconnect()
    
    def display_period_product_overview(self):
        """æ˜¾ç¤ºæœŸé—´äº§å“æ€»è§ˆåˆ†ææ•°æ®"""
        if not hasattr(self, 'period_product_overview_data') or not self.period_product_overview_data:
            self.log_message("âŒ æœŸé—´-äº§å“æ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ˜¾ç¤º")
            return
            
        # ä½¿ç”¨ä¸“é—¨çš„æœŸé—´äº§å“treeview
        if not hasattr(self, 'period_product_tree'):
            self.log_message("âŒ æœŸé—´äº§å“æ•°æ®æ˜¾ç¤ºç»„ä»¶æœªåˆå§‹åŒ–")
            return
            
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.period_product_tree.get_children():
            self.period_product_tree.delete(item)
        
        # æ¸…ç©ºé¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_period_products = []
        
        # è®¾ç½®åˆ—ï¼ˆæœŸé—´æ±‡æ€»ç‰ˆæœ¬ï¼‰
        columns = ("æœŸé—´\nPeriod", "äº§å“åç§°\nProduct Name", "ç±»åˆ«\nCategory", "å¤©æ•°\nDays", 
                  "æ€»ä¸šç»©\nTotal Sales", "æ€»å•æ®æ•°\nTotal Receipts", "é”€å”®æ€»æ•°\nTotal Quantity", 
                  "æŠ¥åºŸæ•°é‡\nWastage Qty", "é”€å”®é‡‘é¢\nSales Amount", "äº§å“å•æ®ä¸šç»©\nProduct Receipt Performance", "ä¸šç»©å æ¯”(%)\nSales Ratio(%)", 
                  "æ•°é‡å æ¯”(%)\nQuantity Ratio(%)", "æŠ¥åºŸå æ¯”(%)\nWastage Ratio(%)", "äº§å“å•æ®ä¸šç»©å æ¯”(%)\nProduct Receipt Performance Ratio(%)")
        self.period_product_tree["columns"] = columns
        self.period_product_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜å’Œæ’åºåŠŸèƒ½
        for col in columns:
            self.period_product_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.period_product_tree, c))
            self.period_product_tree.column(col, width=150, anchor="center")
        
        # æ¨£å¼å·²åœ¨å…¨å±€è¨­å®šä¸­è™•ç†ï¼Œæ­¤è™•ç„¡éœ€é¡å¤–é…ç½®
        
        # æ’å…¥æ•°æ®
        total_sales = 0
        total_receipts = 0
        total_quantity = 0
        total_wastage = 0
        total_product_receipt_performance = 0
        
        saved_outlets = getattr(self, 'period_product_outlet_filters', None)
        try:
            outlet_filters = [o for o in self.outlet_combo.get_selected() if o]
        except Exception:
            outlet_filters = []
        if not outlet_filters and saved_outlets is not None:
            outlet_filters = saved_outlets

        if self.show_store_average.get():
            store_count = self.period_product_store_count if hasattr(self, 'period_product_store_count') else len(outlet_filters) or 1
        else:
            store_count = len({row.get('é—¨å¸‚') for row in self.period_product_overview_data if row.get('é—¨å¸‚')}) or 1

        for row in self.period_product_overview_data:
            # æ ¹æ®å…¨å±€æ—¥å‡å¼€å…³å†³å®šæ˜¾ç¤ºæ ¼å¼
            if self.show_daily_average.get():
                sales_value = row['æ€»ä¸šç»©_æ—¥å‡']
                receipts_value = row['æ€»å•æ®æ•°_æ—¥å‡']
                quantity_value = row['é”€å”®æ€»æ•°_æ—¥å‡']
                wastage_value = row['æŠ¥åºŸæ•°é‡_æ—¥å‡']
                product_receipt_performance_value = row.get('äº§å“å•æ®ä¸šç»©_æ—¥å‡', 0)
            else:
                sales_value = row['æ€»ä¸šç»©']
                receipts_value = row['æ€»å•æ®æ•°']
                quantity_value = row['é”€å”®æ€»æ•°']
                wastage_value = row['æŠ¥åºŸæ•°é‡']
                product_receipt_performance_value = row.get('äº§å“å•æ®ä¸šç»©', 0)

            if self.show_store_average.get():
                sales_value /= store_count
                receipts_value /= store_count
                quantity_value /= store_count
                wastage_value /= store_count
                product_receipt_performance_value /= store_count

            sales_amount_value = row['é”€å”®é‡‘é¢']
            if self.show_store_average.get():
                sales_amount_value /= store_count

            formatted_row = (
                row['æœŸé—´'],
                row['äº§å“åç§°'],
                row['ç±»åˆ«'],
                row['å¤©æ•°'],
                format_currency(sales_value),
                format_number(receipts_value),
                format_number(quantity_value),
                format_number(wastage_value),
                format_currency(sales_amount_value),
                format_currency(product_receipt_performance_value),
                f"{row['ä¸šç»©å æ¯”']:.2f}%",
                f"{row['æ•°é‡å æ¯”']:.2f}%",
                f"{row['æŠ¥åºŸå æ¯”']:.2f}%",
                f"{row.get('äº§å“å•æ®ä¸šç»©å æ¯”', 0):.2f}%"
            )

            # ç´¯è®¡æ€»è®¡ï¼ˆä½¿ç”¨åŸå§‹æ•°æ®ï¼‰
            total_sales += row['æ€»ä¸šç»©']
            total_receipts += row['æ€»å•æ®æ•°']
            total_quantity += row['é”€å”®æ€»æ•°']
            total_wastage += row['æŠ¥åºŸæ•°é‡']
            total_product_receipt_performance += row.get('äº§å“å•æ®ä¸šç»©', 0)
            
            self.period_product_tree.insert("", "end", values=formatted_row)
        
        # æ·»åŠ æ€»è®¡è¡Œ
        if self.period_product_overview_data:
            total_quantity_with_wastage = total_wastage + total_quantity
            wastage_ratio_total = (total_wastage / total_quantity_with_wastage * 100) if total_quantity_with_wastage > 0 else 0
            total_product_receipt_performance_ratio = (total_product_receipt_performance / total_sales * 100) if total_sales > 0 else 0
            denom = len(self.period_product_overview_data) if (self.show_daily_average.get() and self.period_product_overview_data) else 1
            if self.show_store_average.get():
                denom *= store_count
            total_row = (
                "æ€»è®¡\nTotal",
                "æ‰€æœ‰äº§å“\nAll Products",
                "",
                "",
                format_currency(total_sales / denom),
                format_number(total_receipts / denom),
                format_number(total_quantity / denom),
                format_number(total_wastage / denom),
                "",
                format_currency(total_product_receipt_performance / denom),
                "100.00%",
                "100.00%",
                f"{wastage_ratio_total:.2f}%",
                f"{total_product_receipt_performance_ratio:.2f}%"
            )
            
            # æ’å…¥æ€»è®¡è¡Œå¹¶è®¾ç½®é¢œè‰²
            total_item = self.period_product_tree.insert("", "end", values=total_row, tags=("total",))
            self.period_product_tree.tag_configure("total", background="#E6F3FF", font=('Arial', 9, 'bold'))
            
            # æ·»åŠ é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œï¼ˆåˆå§‹ç‚ºç©ºï¼‰
            self.update_selected_products_summary()
        
        # åˆ‡æ¢åˆ°äº§å“åˆ†ææ ‡ç­¾é¡µï¼ˆå¦‚æœæ´»åŠ¨è®°å½•çª—å£æ²¡æœ‰æ‰“å¼€ï¼‰
        # æ³¨é‡Šæ‰è‡ªåŠ¨è·³è½¬ï¼Œé¿å…æœç´¢æ—¶æ„å¤–è·³è½¬
        # if not (hasattr(self, 'activity_window') and self.activity_window.winfo_exists()):
        #     # # self.notebook.select(1)  # é€‰æ‹©Productæ ‡ç­¾é¡µ - å·²ç¦ç”¨ï¼Œé¿å…è·³è½¬ - å·²ç¦ç”¨ï¼Œé¿å…è·³è½¬
        #     self.product_notebook.select(0)  # é€‰æ‹©æ—¥-äº§å“æ•°æ®å­æ ‡ç­¾é¡µ
    
    def on_period_product_selection_change(self, event):
        """è™•ç†æœŸé–“ç”¢å“é¸æ“‡è®ŠåŒ–äº‹ä»¶"""
        try:
            # ç²å–é¸ä¸­çš„é …ç›®
            selected_items = self.period_product_tree.selection()
            # éæ¿¾æ‰ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_products = []
            for item in selected_items:
                values = self.period_product_tree.item(item, "values")
                if values and len(values) > 1:
                    product_name = values[1]  # ç”¢å“åç¨±åœ¨ç¬¬2åˆ—
                    # æ’é™¤ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
                    if product_name not in ["æ‰€æœ‰äº§å“\nAll Products", "é¸ä¸­ç”¢å“ç¸½è¨ˆ\nSelected Products Total"]:
                        selected_products.append(product_name)
            
            # æ›´æ–°é¸ä¸­ç”¢å“åˆ—è¡¨
            self.selected_period_products = selected_products
            
            # æ›´æ–°é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            self.update_selected_products_summary()
            
        except Exception as e:
            print(f"è™•ç†æœŸé–“ç”¢å“é¸æ“‡è®ŠåŒ–æ™‚å‡ºéŒ¯: {e}")
    
    def update_selected_products_summary(self):
        """æ›´æ–°é¸ä¸­ç”¢å“çš„ç¸½è¨ˆè¡Œ"""
        try:
            # ç§»é™¤æ‰€æœ‰ç¾æœ‰çš„é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            items_to_delete = []
            for item in self.period_product_tree.get_children():
                values = self.period_product_tree.item(item, "values")
                if values and len(values) > 0 and ("é¸ä¸­ç”¢å“ç¸½è¨ˆ" in str(values[0]) or "Selected Products Total" in str(values[0])):
                    items_to_delete.append(item)
            
            for item in items_to_delete:
                self.period_product_tree.delete(item)
            
            # å¦‚æœæ²’æœ‰é¸ä¸­ç”¢å“ï¼Œä¸é¡¯ç¤ºç¸½è¨ˆè¡Œ
            if not self.selected_period_products:
                return
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
            selected_total_sales = 0
            selected_total_receipts = 0
            selected_total_quantity = 0
            selected_total_wastage = 0
            selected_total_product_receipt_performance = 0
            selected_count = 0
            
            for row in self.period_product_overview_data:
                if row['äº§å“åç§°'] in self.selected_period_products:
                    selected_total_sales += row['æ€»ä¸šç»©']
                    selected_total_receipts += row['æ€»å•æ®æ•°']
                    selected_total_quantity += row['é”€å”®æ€»æ•°']
                    selected_total_wastage += row['æŠ¥åºŸæ•°é‡']
                    selected_total_product_receipt_performance += row.get('äº§å“å•æ®ä¸šç»©', 0)
                    selected_count += 1
            
            if selected_count == 0:
                return
            
            # è¨ˆç®—æ¯”ä¾‹
            total_sales = sum(row['æ€»ä¸šç»©'] for row in self.period_product_overview_data)
            total_quantity_with_wastage = sum(row['é”€å”®æ€»æ•°'] + row['æŠ¥åºŸæ•°é‡'] for row in self.period_product_overview_data)
            total_wastage = sum(row['æŠ¥åºŸæ•°é‡'] for row in self.period_product_overview_data)
            total_product_receipt_performance = sum(row.get('äº§å“å•æ®ä¸šç»©', 0) for row in self.period_product_overview_data)
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„å æ¯”
            selected_sales_ratio = (selected_total_sales / total_sales * 100) if total_sales > 0 else 0
            selected_quantity_ratio = (selected_total_quantity / sum(row['é”€å”®æ€»æ•°'] for row in self.period_product_overview_data) * 100) if sum(row['é”€å”®æ€»æ•°'] for row in self.period_product_overview_data) > 0 else 0
            selected_wastage_ratio = (selected_total_wastage / total_wastage * 100) if total_wastage > 0 else 0
            selected_product_receipt_performance_ratio = (selected_total_product_receipt_performance / total_product_receipt_performance * 100) if total_product_receipt_performance > 0 else 0
            
            # æ ¹æ“šé¡¯ç¤ºæ¨¡å¼èª¿æ•´æ•¸å€¼
            if self.show_daily_average.get():
                denom = len(self.period_product_overview_data) if self.period_product_overview_data else 1
            else:
                denom = 1
                
            if self.show_store_average.get():
                store_count = self.period_product_store_count if hasattr(self, 'period_product_store_count') else 1
                denom *= store_count
            
            # å‰µå»ºé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_row = (
                "é¸ä¸­ç”¢å“ç¸½è¨ˆ\nSelected Products Total",
                f"å·²é¸ä¸­ {selected_count} å€‹ç”¢å“\n{selected_count} Products Selected",
                "",
                "",
                format_currency(selected_total_sales / denom),
                format_number(selected_total_receipts / denom),
                format_number(selected_total_quantity / denom),
                format_number(selected_total_wastage / denom),
                "",
                format_currency(selected_total_product_receipt_performance / denom),
                f"{selected_sales_ratio:.2f}%",
                f"{selected_quantity_ratio:.2f}%",
                f"{selected_wastage_ratio:.2f}%",
                f"{selected_product_receipt_performance_ratio:.2f}%"
            )
            
            # æ‰¾åˆ°ç¸½è¨ˆè¡Œçš„ä½ç½®
            total_item_index = None
            children = self.period_product_tree.get_children()
            for i, item in enumerate(children):
                values = self.period_product_tree.item(item, "values")
                if values and len(values) > 1 and values[1] == "æ‰€æœ‰äº§å“\nAll Products":
                    total_item_index = i
                    break
            
            # åœ¨è¡¨æ ¼æœ€é ‚éƒ¨æ’å…¥é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_item = self.period_product_tree.insert("", 0, values=selected_row, tags=("selected_total",))
            
            self.period_product_tree.tag_configure("selected_total", background="#FFF2CC", font=('Arial', 9, 'bold'))
            
        except Exception as e:
            print(f"æ›´æ–°é¸ä¸­ç”¢å“ç¸½è¨ˆæ™‚å‡ºéŒ¯: {e}")
    
    def on_daily_product_selection_change(self, event):
        """è™•ç†æ—¥-ç”¢å“æ•¸æ“šé¸æ“‡è®ŠåŒ–äº‹ä»¶"""
        try:
            # ç²å–é¸ä¸­çš„é …ç›®
            selected_items = self.product_overview_tree.selection()
            
            # éæ¿¾æ‰ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_products = []
            for item in selected_items:
                values = self.product_overview_tree.item(item, "values")
                if values and len(values) > 3:
                    product_name = values[3]  # ç”¢å“åç¨±åœ¨ç¬¬4åˆ—
                    # æ’é™¤ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
                    if product_name not in ["æ‰€æœ‰äº§å“\nAll Products", "é¸ä¸­ç”¢å“ç¸½è¨ˆ\nSelected Products Total"]:
                        selected_products.append(product_name)
            
            # æ›´æ–°é¸ä¸­ç”¢å“åˆ—è¡¨
            self.selected_daily_products = selected_products
            
            # æ›´æ–°é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            self.update_daily_selected_products_summary()
            
        except Exception as e:
            print(f"è™•ç†æ—¥-ç”¢å“æ•¸æ“šé¸æ“‡è®ŠåŒ–æ™‚å‡ºéŒ¯: {e}")
    
    def update_daily_selected_products_summary(self):
        """æ›´æ–°æ—¥-ç”¢å“æ•¸æ“šé¸ä¸­ç”¢å“çš„ç¸½è¨ˆè¡Œ"""
        try:
            # ç§»é™¤æ‰€æœ‰ç¾æœ‰çš„é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            items_to_delete = []
            for item in self.product_overview_tree.get_children():
                values = self.product_overview_tree.item(item, "values")
                if values and len(values) > 3 and ("é¸ä¸­ç”¢å“ç¸½è¨ˆ" in str(values[3]) or "Selected Products Total" in str(values[3])):
                    items_to_delete.append(item)
            
            for item in items_to_delete:
                self.product_overview_tree.delete(item)
            
            # å¦‚æœæ²’æœ‰é¸ä¸­ç”¢å“ï¼Œä¸é¡¯ç¤ºç¸½è¨ˆè¡Œ
            if not self.selected_daily_products:
                return
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
            selected_total_sales = 0
            selected_total_receipts = 0
            selected_total_quantity = 0
            selected_total_product_receipt_performance = 0
            selected_count = len(self.selected_daily_products)  # ç›´æ¥ä½¿ç”¨é¸ä¸­ç”¢å“åˆ—è¡¨çš„é•·åº¦
            
            for row in self.product_overview_data:
                if row['äº§å“åç§°'] in self.selected_daily_products:
                    selected_total_sales += row['æ€»ä¸šç»©']
                    selected_total_receipts += row['æ€»å•æ®æ•°']
                    selected_total_quantity += row['é”€å”®æ€»æ•°']
                    selected_total_product_receipt_performance += row.get('äº§å“å•æ®ä¸šç»©', 0)
            
            if selected_count == 0:
                return
            
            # è¨ˆç®—æ¯”ä¾‹
            total_sales = sum(row['æ€»ä¸šç»©'] for row in self.product_overview_data)
            total_quantity = sum(row['é”€å”®æ€»æ•°'] for row in self.product_overview_data)
            total_product_receipt_performance = sum(row.get('äº§å“å•æ®ä¸šç»©', 0) for row in self.product_overview_data)
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„å æ¯”
            selected_sales_ratio = (selected_total_sales / total_sales * 100) if total_sales > 0 else 0
            selected_quantity_ratio = (selected_total_quantity / total_quantity * 100) if total_quantity > 0 else 0
            selected_product_receipt_performance_ratio = (selected_total_product_receipt_performance / total_product_receipt_performance * 100) if total_product_receipt_performance > 0 else 0
            
            # å‰µå»ºé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_row = (
                "", "", "", f"é¸ä¸­ç”¢å“ç¸½è¨ˆ ({selected_count}å€‹ç”¢å“)\nSelected Products Total ({selected_count} Products)", "", 
                f"{selected_total_sales:.2f}", f"{selected_total_receipts}", f"{selected_total_quantity}", 
                f"{selected_total_sales:.2f}", f"{selected_total_product_receipt_performance:.2f}",
                f"{selected_sales_ratio:.2f}%", f"{selected_quantity_ratio:.2f}%", f"{selected_product_receipt_performance_ratio:.2f}%"
            )
            
            # æ‰¾åˆ°ç¸½è¨ˆè¡Œçš„ä½ç½®
            total_item_index = None
            children = self.product_overview_tree.get_children()
            for i, item in enumerate(children):
                values = self.product_overview_tree.item(item, "values")
                if values and len(values) > 3 and values[3] == "æ‰€æœ‰äº§å“\nAll Products":
                    total_item_index = i
                    break
            
            # åœ¨è¡¨æ ¼æœ€é ‚éƒ¨æ’å…¥é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_item = self.product_overview_tree.insert("", 0, values=selected_row, tags=("selected_total",))
            
            self.product_overview_tree.tag_configure("selected_total", background="#FFF2CC", font=('Arial', 9, 'bold'))
            
            # ä½¿ç”¨stickyé¸é …è®“é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œå›ºå®šåœ¨é ‚éƒ¨
            self.product_overview_tree.item(selected_item, tags=("selected_total", "sticky"))
            self.product_overview_tree.tag_configure("sticky", sticky="n")
            
        except Exception as e:
            print(f"æ›´æ–°æ—¥-ç”¢å“æ•¸æ“šé¸ä¸­ç”¢å“ç¸½è¨ˆæ™‚å‡ºéŒ¯: {e}")
    
    def on_weekly_product_selection_change(self, event):
        """è™•ç†é€±-ç”¢å“æ•¸æ“šé¸æ“‡è®ŠåŒ–äº‹ä»¶"""
        try:
            # ç²å–é¸ä¸­çš„é …ç›®
            selected_items = self.weekly_product_tree.selection()
            
            # éæ¿¾æ‰ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_products = []
            for item in selected_items:
                values = self.weekly_product_tree.item(item, "values")
                if values and len(values) > 0:
                    product_name = values[0]  # ç”¢å“åç¨±åœ¨ç¬¬1åˆ—
                    # æ’é™¤ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
                    if product_name not in ["æ‰€æœ‰äº§å“\nAll Products", "é¸ä¸­ç”¢å“ç¸½è¨ˆ\nSelected Products Total"]:
                        selected_products.append(product_name)
            
            # æ›´æ–°é¸ä¸­ç”¢å“åˆ—è¡¨
            self.selected_weekly_products = selected_products
            
            # æ›´æ–°é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            self.update_weekly_selected_products_summary()
            
        except Exception as e:
            print(f"è™•ç†é€±-ç”¢å“æ•¸æ“šé¸æ“‡è®ŠåŒ–æ™‚å‡ºéŒ¯: {e}")
    
    def update_weekly_selected_products_summary(self):
        """æ›´æ–°é€±-ç”¢å“æ•¸æ“šé¸ä¸­ç”¢å“çš„ç¸½è¨ˆè¡Œ"""
        try:
            # ç§»é™¤æ‰€æœ‰ç¾æœ‰çš„é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            items_to_delete = []
            for item in self.weekly_product_tree.get_children():
                values = self.weekly_product_tree.item(item, "values")
                if values and len(values) > 0 and ("é¸ä¸­ç”¢å“ç¸½è¨ˆ" in str(values[0]) or "Selected Products Total" in str(values[0])):
                    items_to_delete.append(item)
            
            for item in items_to_delete:
                self.weekly_product_tree.delete(item)
            
            # å¦‚æœæ²’æœ‰é¸ä¸­ç”¢å“ï¼Œä¸é¡¯ç¤ºç¸½è¨ˆè¡Œ
            if not self.selected_weekly_products:
                return
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
            selected_total_performance = 0
            selected_total_receipts = 0
            selected_total_quantity = 0
            selected_count = 0
            
            for row in self.weekly_product_data:
                if row['äº§å“åç§°'] in self.selected_weekly_products:
                    selected_total_performance += row['ä¸šç»©']
                    selected_total_receipts += row['äº§å“å•æ®æ•°']
                    selected_total_quantity += row['é”€å”®æ•°é‡']
                    selected_count += 1
            
            if selected_count == 0:
                return
            
            # è¨ˆç®—æ¯”ä¾‹
            total_performance = sum(row['ä¸šç»©'] for row in self.weekly_product_data)
            total_receipts = sum(row['äº§å“å•æ®æ•°'] for row in self.weekly_product_data)
            total_quantity = sum(row['é”€å”®æ•°é‡'] for row in self.weekly_product_data)
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„å æ¯”
            selected_performance_ratio = (selected_total_performance / total_performance * 100) if total_performance > 0 else 0
            selected_receipts_ratio = (selected_total_receipts / total_receipts * 100) if total_receipts > 0 else 0
            selected_quantity_ratio = (selected_total_quantity / total_quantity * 100) if total_quantity > 0 else 0
            
            # å‰µå»ºé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_row = (
                f"é¸ä¸­ç”¢å“ç¸½è¨ˆ ({selected_count}å€‹ç”¢å“)",
                "", "", 
                f"{selected_total_performance:.2f}",
                f"{selected_total_receipts}",
                f"{selected_total_quantity}"
            )
            
            # æ‰¾åˆ°ç¸½è¨ˆè¡Œçš„ä½ç½®
            total_item_index = None
            children = self.weekly_product_tree.get_children()
            for i, item in enumerate(children):
                values = self.weekly_product_tree.item(item, "values")
                if values and len(values) > 0 and values[0] == "æ‰€æœ‰äº§å“\nAll Products":
                    total_item_index = i
                    break
            
            # åœ¨è¡¨æ ¼æœ€é ‚éƒ¨æ’å…¥é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_item = self.weekly_product_tree.insert("", 0, values=selected_row, tags=("selected_total",))
            
            self.weekly_product_tree.tag_configure("selected_total", background="#FFF2CC", font=('Arial', 9, 'bold'))
            
        except Exception as e:
            print(f"æ›´æ–°é€±-ç”¢å“æ•¸æ“šé¸ä¸­ç”¢å“ç¸½è¨ˆæ™‚å‡ºéŒ¯: {e}")
    
    def on_monthly_product_selection_change(self, event):
        """è™•ç†æœˆ-éŠ·å”®æ•¸æ“šé¸æ“‡è®ŠåŒ–äº‹ä»¶"""
        try:
            # ç²å–é¸ä¸­çš„é …ç›®
            selected_items = self.monthly_tree.selection()
            
            # éæ¿¾æ‰ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_products = []
            for item in selected_items:
                values = self.monthly_tree.item(item, "values")
                if values and len(values) > 1:
                    product_name = values[1]  # ç”¢å“åç¨±åœ¨ç¬¬2åˆ—
                    # æ’é™¤ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
                    if product_name not in ["æ‰€æœ‰äº§å“\nAll Products", "é¸ä¸­ç”¢å“ç¸½è¨ˆ\nSelected Products Total"]:
                        selected_products.append(product_name)
            
            # æ›´æ–°é¸ä¸­ç”¢å“åˆ—è¡¨
            self.selected_monthly_products = selected_products
            
            # æ›´æ–°é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            self.update_monthly_selected_products_summary()
            
        except Exception as e:
            print(f"è™•ç†æœˆ-éŠ·å”®æ•¸æ“šé¸æ“‡è®ŠåŒ–æ™‚å‡ºéŒ¯: {e}")
    
    def update_monthly_selected_products_summary(self):
        """æ›´æ–°æœˆ-éŠ·å”®æ•¸æ“šé¸ä¸­ç”¢å“çš„ç¸½è¨ˆè¡Œ"""
        try:
            # ç§»é™¤æ‰€æœ‰ç¾æœ‰çš„é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            items_to_delete = []
            for item in self.monthly_tree.get_children():
                values = self.monthly_tree.item(item, "values")
                if values and len(values) > 1 and ("é¸ä¸­ç”¢å“ç¸½è¨ˆ" in str(values[1]) or "Selected Products Total" in str(values[1])):
                    items_to_delete.append(item)
            
            for item in items_to_delete:
                self.monthly_tree.delete(item)
            
            # å¦‚æœæ²’æœ‰é¸ä¸­ç”¢å“ï¼Œä¸é¡¯ç¤ºç¸½è¨ˆè¡Œ
            if not self.selected_monthly_products:
                return
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
            selected_total_sales = 0
            selected_total_receipts = 0
            selected_total_quantity = 0
            selected_total_product_receipt_performance = 0
            selected_count = 0
            
            for row in self.monthly_summary_data:
                if row['äº§å“åç§°'] in self.selected_monthly_products:
                    selected_total_sales += row['æ€»ä¸šç»©']
                    selected_total_receipts += row['æ€»å•æ®æ•°']
                    selected_total_quantity += row['é”€å”®æ€»æ•°']
                    selected_total_product_receipt_performance += row.get('äº§å“å•æ®ä¸šç»©', 0)
                    selected_count += 1
            
            if selected_count == 0:
                return
            
            # è¨ˆç®—æ¯”ä¾‹
            total_sales = sum(row['æ€»ä¸šç»©'] for row in self.monthly_summary_data)
            total_quantity = sum(row['é”€å”®æ€»æ•°'] for row in self.monthly_summary_data)
            total_product_receipt_performance = sum(row.get('äº§å“å•æ®ä¸šç»©', 0) for row in self.monthly_summary_data)
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„å æ¯”
            selected_sales_ratio = (selected_total_sales / total_sales * 100) if total_sales > 0 else 0
            selected_quantity_ratio = (selected_total_quantity / total_quantity * 100) if total_quantity > 0 else 0
            selected_product_receipt_performance_ratio = (selected_total_product_receipt_performance / total_product_receipt_performance * 100) if total_product_receipt_performance > 0 else 0
            
            # å‰µå»ºé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_row = (
                "", f"é¸ä¸­ç”¢å“ç¸½è¨ˆ ({selected_count}å€‹ç”¢å“)\nSelected Products Total ({selected_count} Products)", "", 
                f"{selected_total_quantity}", f"{selected_total_sales:.2f}", f"{selected_total_sales:.2f}", 
                f"{selected_total_receipts}", f"{selected_total_product_receipt_performance:.2f}",
                f"{selected_sales_ratio:.2f}%", f"{selected_quantity_ratio:.2f}%", f"{selected_product_receipt_performance_ratio:.2f}%"
            )
            
            # æ‰¾åˆ°ç¸½è¨ˆè¡Œçš„ä½ç½®
            total_item_index = None
            children = self.monthly_tree.get_children()
            for i, item in enumerate(children):
                values = self.monthly_tree.item(item, "values")
                if values and len(values) > 1 and values[1] == "æ‰€æœ‰äº§å“\nAll Products":
                    total_item_index = i
                    break
            
            # åœ¨è¡¨æ ¼æœ€é ‚éƒ¨æ’å…¥é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_item = self.monthly_tree.insert("", 0, values=selected_row, tags=("selected_total",))
            
            self.monthly_tree.tag_configure("selected_total", background="#FFF2CC", font=('Arial', 9, 'bold'))
            
        except Exception as e:
            print(f"æ›´æ–°æœˆ-éŠ·å”®æ•¸æ“šé¸ä¸­ç”¢å“ç¸½è¨ˆæ™‚å‡ºéŒ¯: {e}")
    
    def on_monthly_analysis_selection_change(self, event):
        """è™•ç†æœˆ-ç”¢å“åˆ†æé¸æ“‡è®ŠåŒ–äº‹ä»¶"""
        try:
            # ç²å–é¸ä¸­çš„é …ç›®
            selected_items = self.sales_tc_monthly_tree.selection()
            
            # éæ¿¾æ‰ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_products = []
            for item in selected_items:
                values = self.sales_tc_monthly_tree.item(item, "values")
                if values and len(values) > 1:
                    product_name = values[1]  # ç”¢å“åç¨±åœ¨ç¬¬2åˆ—
                    # æ’é™¤ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
                    if product_name not in ["æ‰€æœ‰äº§å“\nAll Products", "é¸ä¸­ç”¢å“ç¸½è¨ˆ\nSelected Products Total"]:
                        selected_products.append(product_name)
            
            # æ›´æ–°é¸ä¸­ç”¢å“åˆ—è¡¨
            self.selected_monthly_analysis_products = selected_products
            
            # æ›´æ–°é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            self.update_monthly_analysis_selected_products_summary()
            
        except Exception as e:
            print(f"è™•ç†æœˆ-ç”¢å“åˆ†æé¸æ“‡è®ŠåŒ–æ™‚å‡ºéŒ¯: {e}")
    
    def update_monthly_analysis_selected_products_summary(self):
        """æ›´æ–°æœˆ-ç”¢å“åˆ†æé¸ä¸­ç”¢å“çš„ç¸½è¨ˆè¡Œ"""
        try:
            # ç§»é™¤æ‰€æœ‰ç¾æœ‰çš„é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            items_to_delete = []
            for item in self.sales_tc_monthly_tree.get_children():
                values = self.sales_tc_monthly_tree.item(item, "values")
                if values and len(values) > 1 and ("é¸ä¸­ç”¢å“ç¸½è¨ˆ" in str(values[1]) or "Selected Products Total" in str(values[1])):
                    items_to_delete.append(item)
            
            for item in items_to_delete:
                self.sales_tc_monthly_tree.delete(item)
            
            # å¦‚æœæ²’æœ‰é¸ä¸­ç”¢å“ï¼Œä¸é¡¯ç¤ºç¸½è¨ˆè¡Œ
            if not self.selected_monthly_analysis_products:
                return
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
            selected_total_sales = 0
            selected_total_receipts = 0
            selected_total_quantity = 0
            selected_total_product_receipt_performance = 0
            selected_count = 0
            
            for row in self.sales_tc_monthly_data:
                if row['äº§å“åç§°'] in self.selected_monthly_analysis_products:
                    selected_total_sales += row['æ€»ä¸šç»©']
                    selected_total_receipts += row['æ€»å•æ®æ•°']
                    selected_total_quantity += row['é”€å”®æ€»æ•°']
                    selected_total_product_receipt_performance += row.get('äº§å“å•æ®ä¸šç»©', 0)
                    selected_count += 1
            
            if selected_count == 0:
                return
            
            # è¨ˆç®—æ¯”ä¾‹
            total_sales = sum(row['æ€»ä¸šç»©'] for row in self.sales_tc_monthly_data)
            total_quantity = sum(row['é”€å”®æ€»æ•°'] for row in self.sales_tc_monthly_data)
            total_product_receipt_performance = sum(row.get('äº§å“å•æ®ä¸šç»©', 0) for row in self.sales_tc_monthly_data)
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„å æ¯”
            selected_sales_ratio = (selected_total_sales / total_sales * 100) if total_sales > 0 else 0
            selected_quantity_ratio = (selected_total_quantity / total_quantity * 100) if total_quantity > 0 else 0
            selected_product_receipt_performance_ratio = (selected_total_product_receipt_performance / total_product_receipt_performance * 100) if total_product_receipt_performance > 0 else 0
            
            # å‰µå»ºé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_row = (
                "", f"é¸ä¸­ç”¢å“ç¸½è¨ˆ ({selected_count}å€‹ç”¢å“)\nSelected Products Total ({selected_count} Products)", 
                f"{selected_total_sales:.2f}", f"{selected_total_receipts}", f"{selected_total_quantity}", 
                f"{selected_total_sales:.2f}", f"{selected_total_receipts}", f"{selected_total_quantity}", 
                f"{selected_total_product_receipt_performance:.2f}",
                f"{selected_sales_ratio:.2f}%", f"{selected_quantity_ratio:.2f}%", f"{selected_product_receipt_performance_ratio:.2f}%"
            )
            
            # æ‰¾åˆ°ç¸½è¨ˆè¡Œçš„ä½ç½®
            total_item_index = None
            children = self.sales_tc_monthly_tree.get_children()
            for i, item in enumerate(children):
                values = self.sales_tc_monthly_tree.item(item, "values")
                if values and len(values) > 1 and values[1] == "æ‰€æœ‰äº§å“\nAll Products":
                    total_item_index = i
                    break
            
            # åœ¨è¡¨æ ¼æœ€é ‚éƒ¨æ’å…¥é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_item = self.sales_tc_monthly_tree.insert("", 0, values=selected_row, tags=("selected_total",))
            
            self.sales_tc_monthly_tree.tag_configure("selected_total", background="#FFF2CC", font=('Arial', 9, 'bold'))
            
        except Exception as e:
            print(f"æ›´æ–°æœˆ-ç”¢å“åˆ†æé¸ä¸­ç”¢å“ç¸½è¨ˆæ™‚å‡ºéŒ¯: {e}")
    
    def on_association_selection_change(self, event):
        """è™•ç†ç”¢å“é—œè¯åˆ†æé¸æ“‡è®ŠåŒ–äº‹ä»¶"""
        try:
            # ç²å–é¸ä¸­çš„é …ç›®
            selected_items = self.product_association_tree.selection()
            
            # éæ¿¾æ‰ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_products = []
            for item in selected_items:
                values = self.product_association_tree.item(item, "values")
                if values and len(values) > 0:
                    product_name = values[0]  # ç”¢å“åç¨±åœ¨ç¬¬1åˆ—
                    # æ’é™¤ç¸½è¨ˆè¡Œå’Œé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
                    if product_name not in ["æ‰€æœ‰äº§å“\nAll Products", "é¸ä¸­ç”¢å“ç¸½è¨ˆ\nSelected Products Total"]:
                        selected_products.append(product_name)
            
            # æ›´æ–°é¸ä¸­ç”¢å“åˆ—è¡¨
            self.selected_association_products = selected_products
            
            # æ›´æ–°é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            self.update_association_selected_products_summary()
            
        except Exception as e:
            print(f"è™•ç†ç”¢å“é—œè¯åˆ†æé¸æ“‡è®ŠåŒ–æ™‚å‡ºéŒ¯: {e}")
    
    def update_association_selected_products_summary(self):
        """æ›´æ–°ç”¢å“é—œè¯åˆ†æé¸ä¸­ç”¢å“çš„ç¸½è¨ˆè¡Œ"""
        try:
            # ç§»é™¤æ‰€æœ‰ç¾æœ‰çš„é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            items_to_delete = []
            for item in self.product_association_tree.get_children():
                values = self.product_association_tree.item(item, "values")
                if values and len(values) > 0 and ("é¸ä¸­ç”¢å“ç¸½è¨ˆ" in str(values[0]) or "Selected Products Total" in str(values[0])):
                    items_to_delete.append(item)
            
            for item in items_to_delete:
                self.product_association_tree.delete(item)
            
            # å¦‚æœæ²’æœ‰é¸ä¸­ç”¢å“ï¼Œä¸é¡¯ç¤ºç¸½è¨ˆè¡Œ
            if not self.selected_association_products:
                return
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„ç¸½è¨ˆ
            selected_total_sales = 0
            selected_total_receipts = 0
            selected_total_quantity = 0
            selected_count = 0
            
            for row in self.product_association_data:
                if row['äº§å“åç§°'] in self.selected_association_products:
                    selected_total_sales += row['æ€»ä¸šç»©']
                    selected_total_receipts += row['æ€»å•æ®æ•°']
                    selected_total_quantity += row['é”€å”®æ€»æ•°']
                    selected_count += 1
            
            if selected_count == 0:
                return
            
            # è¨ˆç®—æ¯”ä¾‹
            total_sales = sum(row['æ€»ä¸šç»©'] for row in self.product_association_data)
            total_quantity = sum(row['é”€å”®æ€»æ•°'] for row in self.product_association_data)
            
            # è¨ˆç®—é¸ä¸­ç”¢å“çš„å æ¯”
            selected_sales_ratio = (selected_total_sales / total_sales * 100) if total_sales > 0 else 0
            selected_quantity_ratio = (selected_total_quantity / total_quantity * 100) if total_quantity > 0 else 0
            
            # å‰µå»ºé¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_row = (
                f"é¸ä¸­ç”¢å“ç¸½è¨ˆ ({selected_count}å€‹ç”¢å“)",
                "", "", "", "", "", "", "", "", "", "",
                f"{selected_sales_ratio:.2f}%", f"{selected_quantity_ratio:.2f}%"
            )
            
            # æ‰¾åˆ°ç¸½è¨ˆè¡Œçš„ä½ç½®
            total_item_index = None
            children = self.product_association_tree.get_children()
            for i, item in enumerate(children):
                values = self.product_association_tree.item(item, "values")
                if values and len(values) > 0 and values[0] == "æ‰€æœ‰äº§å“\nAll Products":
                    total_item_index = i
                    break
            
            # åœ¨è¡¨æ ¼æœ€é ‚éƒ¨æ’å…¥é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œ
            selected_item = self.product_association_tree.insert("", 0, values=selected_row, tags=("selected_total",))
            
            self.product_association_tree.tag_configure("selected_total", background="#FFF2CC", font=('Arial', 9, 'bold'))
            
        except Exception as e:
            print(f"æ›´æ–°ç”¢å“é—œè¯åˆ†æé¸ä¸­ç”¢å“ç¸½è¨ˆæ™‚å‡ºéŒ¯: {e}")
    
    def display_product_overview(self):
        """æ˜¾ç¤ºäº§å“æ€»è§ˆåˆ†ææ•°æ®"""
        # æ¸…ç©ºç°æœ‰æ•°æ®
        for item in self.product_overview_tree.get_children():
            self.product_overview_tree.delete(item)
        
        # æ¸…ç©ºé¸ä¸­ç”¢å“åˆ—è¡¨
        self.selected_daily_products = []
        
        # è®¾ç½®åˆ—
        columns = ("æ—¥æœŸ\nDate", "æœˆä»½\nMonth", "é—¨å¸‚\nOutlet", "äº§å“åç§°\nProduct Name", "ç±»åˆ«\nCategory", 
                  "æ€»ä¸šç»©\nTotal Sales", "æ€»å•æ®æ•°\nTotal Receipts", "é”€å”®æ€»æ•°\nTotal Quantity", 
                  "é”€å”®é‡‘é¢\nSales Amount", "äº§å“å•æ®ä¸šç»©\nProduct Receipt Performance", 
                  "ä¸šç»©å æ¯”(%)\nSales Ratio(%)", "æ•°é‡å æ¯”(%)\nQuantity Ratio(%)", "äº§å“å•æ®ä¸šç»©å æ¯”(%)\nProduct Receipt Performance Ratio(%)")
        self.product_overview_tree["columns"] = columns
        self.product_overview_tree["show"] = "headings"
        
        # è®¾ç½®åˆ—æ ‡é¢˜å’Œæ’åºåŠŸèƒ½
        for col in columns:
            self.product_overview_tree.heading(col, text=col, command=lambda c=col: self._sort_treeview_column(self.product_overview_tree, c))
            self.product_overview_tree.column(col, width=150, anchor="center")
        
        # æ¨£å¼å·²åœ¨å…¨å±€è¨­å®šä¸­è™•ç†ï¼Œæ­¤è™•ç„¡éœ€é¡å¤–é…ç½®
        
        # é…ç½®Allé—¨å¸‚è¡Œçš„æ ·å¼
        self.product_overview_tree.tag_configure("all_outlet", background="#E6F3FF", font=('Arial', 9, 'bold'))
        
        # æ’å…¥æ•°æ®
        total_sales = 0
        total_receipts = 0
        total_quantity = 0
        
        saved_outlets = getattr(self, 'product_overview_outlet_filters', None)
        try:
            outlet_filters = [o for o in self.outlet_combo.get_selected() if o]
        except Exception:
            outlet_filters = []
        if not outlet_filters and saved_outlets is not None:
            outlet_filters = saved_outlets

        if self.show_store_average.get():
            store_count = self.product_overview_store_count if hasattr(self, 'product_overview_store_count') else len(outlet_filters) or 1
        else:
            store_count = len({row.get('é—¨å¸‚') for row in self.product_overview_data if row.get('é—¨å¸‚')}) or 1

        # è®¡ç®—Allé—¨å¸‚æ±‡æ€»æ•°æ®
        all_outlet_data = {}
        daily_totals_for_all = {}  # ç”¨äºè®¡ç®—Allé—¨å¸‚çš„å æ¯”
        
        for row in self.product_overview_data:
            # åŒ…å«æ—¥æœŸåœ¨é”®ä¸­ï¼Œç¡®ä¿æ¯ä¸ªæ—¥æœŸçš„æ•°æ®åˆ†åˆ«æ±‡æ€»
            product_key = f"{row['æ—¥æœŸ']}_{row['äº§å“åç§°']}_{row['ç±»åˆ«']}"
            if product_key not in all_outlet_data:
                all_outlet_data[product_key] = {
                    'æ—¥æœŸ': row['æ—¥æœŸ'],
                    'æœˆä»½': row['æœˆä»½'],
                    'é—¨å¸‚': 'All',
                    'äº§å“åç§°': row['äº§å“åç§°'],
                    'ç±»åˆ«': row['ç±»åˆ«'],
                    'æ€»ä¸šç»©': 0,
                    'æ€»å•æ®æ•°': 0,
                    'é”€å”®æ€»æ•°': 0,
                    'é”€å”®é‡‘é¢': 0,
                    'äº§å“å•æ®ä¸šç»©': 0,
                    'æ€»ä¸šç»©_æ—¥å‡': 0,
                    'æ€»å•æ®æ•°_æ—¥å‡': 0,
                    'é”€å”®æ€»æ•°_æ—¥å‡': 0,
                    'é”€å”®é‡‘é¢_æ—¥å‡': 0,
                    'äº§å“å•æ®ä¸šç»©_æ—¥å‡': 0,
                    'ä¸šç»©å æ¯”': 0,
                    'æ•°é‡å æ¯”': 0,
                    'äº§å“å•æ®ä¸šç»©å æ¯”': 0
                }
            
            # ç´¯åŠ æ•°æ®
            all_outlet_data[product_key]['æ€»ä¸šç»©'] += row['æ€»ä¸šç»©']
            all_outlet_data[product_key]['æ€»å•æ®æ•°'] += row['æ€»å•æ®æ•°']
            all_outlet_data[product_key]['é”€å”®æ€»æ•°'] += row['é”€å”®æ€»æ•°']
            all_outlet_data[product_key]['é”€å”®é‡‘é¢'] += row['é”€å”®é‡‘é¢']
            all_outlet_data[product_key]['äº§å“å•æ®ä¸šç»©'] += row.get('äº§å“å•æ®ä¸šç»©', 0)
            all_outlet_data[product_key]['æ€»ä¸šç»©_æ—¥å‡'] += row.get('æ€»ä¸šç»©_æ—¥å‡', 0)
            all_outlet_data[product_key]['æ€»å•æ®æ•°_æ—¥å‡'] += row.get('æ€»å•æ®æ•°_æ—¥å‡', 0)
            all_outlet_data[product_key]['é”€å”®æ€»æ•°_æ—¥å‡'] += row.get('é”€å”®æ€»æ•°_æ—¥å‡', 0)
            all_outlet_data[product_key]['é”€å”®é‡‘é¢_æ—¥å‡'] += row.get('é”€å”®é‡‘é¢_æ—¥å‡', 0)
            all_outlet_data[product_key]['äº§å“å•æ®ä¸šç»©_æ—¥å‡'] += row.get('äº§å“å•æ®ä¸šç»©_æ—¥å‡', 0)
            
            # ç´¯åŠ åˆ°è©²æ—¥æœŸçš„ç¸½è¨ˆï¼ˆç”¨æ–¼è¨ˆç®—Allé–€å¸‚çš„å æ¯”ï¼‰
            date_key = row['æ—¥æœŸ']
            if date_key not in daily_totals_for_all:
                daily_totals_for_all[date_key] = {
                    'æ€»ä¸šç»©': 0,
                    'é”€å”®æ€»æ•°': 0,
                    'äº§å“å•æ®ä¸šç»©': 0
                }
            daily_totals_for_all[date_key]['æ€»ä¸šç»©'] += row['æ€»ä¸šç»©']
            daily_totals_for_all[date_key]['é”€å”®æ€»æ•°'] += row['é”€å”®æ€»æ•°']
            daily_totals_for_all[date_key]['äº§å“å•æ®ä¸šç»©'] += row.get('äº§å“å•æ®ä¸šç»©', 0)
        
        # é‡æ–°è¨ˆç®—Allé–€å¸‚çš„å æ¯”
        for product_key, all_data in all_outlet_data.items():
            date_key = all_data['æ—¥æœŸ']
            daily_totals = daily_totals_for_all.get(date_key, {'æ€»ä¸šç»©': 0, 'é”€å”®æ€»æ•°': 0, 'äº§å“å•æ®ä¸šç»©': 0})
            
            # è¨ˆç®—å æ¯”
            all_data['ä¸šç»©å æ¯”'] = (all_data['æ€»ä¸šç»©'] / daily_totals['æ€»ä¸šç»©'] * 100) if daily_totals['æ€»ä¸šç»©'] > 0 else 0
            all_data['æ•°é‡å æ¯”'] = (all_data['é”€å”®æ€»æ•°'] / daily_totals['é”€å”®æ€»æ•°'] * 100) if daily_totals['é”€å”®æ€»æ•°'] > 0 else 0
            all_data['äº§å“å•æ®ä¸šç»©å æ¯”'] = (all_data['äº§å“å•æ®ä¸šç»©'] / daily_totals['äº§å“å•æ®ä¸šç»©'] * 100) if daily_totals['äº§å“å•æ®ä¸šç»©'] > 0 else 0

        # å…ˆæ˜¾ç¤ºAllé—¨å¸‚æ±‡æ€»æ•°æ®
        for product_key, all_data in all_outlet_data.items():
            if self.show_daily_average.get():
                sales_value = all_data['æ€»ä¸šç»©_æ—¥å‡']
                receipts_value = all_data['æ€»å•æ®æ•°_æ—¥å‡']
                quantity_value = all_data['é”€å”®æ€»æ•°_æ—¥å‡']
                amount_value = all_data['é”€å”®é‡‘é¢_æ—¥å‡']
                product_receipt_performance_value = all_data['äº§å“å•æ®ä¸šç»©_æ—¥å‡']
            else:
                sales_value = all_data['æ€»ä¸šç»©']
                receipts_value = all_data['æ€»å•æ®æ•°']
                quantity_value = all_data['é”€å”®æ€»æ•°']
                amount_value = all_data['é”€å”®é‡‘é¢']
                product_receipt_performance_value = all_data['äº§å“å•æ®ä¸šç»©']

            if self.show_store_average.get():
                sales_value /= store_count
                receipts_value /= store_count
                quantity_value /= store_count
                amount_value /= store_count
                product_receipt_performance_value /= store_count

            formatted_row = (
                all_data['æ—¥æœŸ'],
                all_data['æœˆä»½'],
                all_data['é—¨å¸‚'],
                all_data['äº§å“åç§°'],
                all_data['ç±»åˆ«'],
                format_currency(sales_value),
                format_number(receipts_value),
                format_number(quantity_value),
                format_currency(amount_value),
                format_currency(product_receipt_performance_value),
                f"{all_data['ä¸šç»©å æ¯”']:.2f}%",
                f"{all_data['æ•°é‡å æ¯”']:.2f}%",
                f"{all_data['äº§å“å•æ®ä¸šç»©å æ¯”']:.2f}%"
            )
            
            self.product_overview_tree.insert("", "end", values=formatted_row, tags=("all_outlet",))

        # ç„¶åæ˜¾ç¤ºå„ä¸ªé—¨å¸‚çš„è¯¦ç»†æ•°æ®
        for row in self.product_overview_data:
            # æ˜¾ç¤ºæ¯æ—¥æ•°æ®
            if self.show_daily_average.get():
                sales_value = row['æ€»ä¸šç»©_æ—¥å‡']
                receipts_value = row['æ€»å•æ®æ•°_æ—¥å‡']
                quantity_value = row['é”€å”®æ€»æ•°_æ—¥å‡']
                amount_value = row['é”€å”®é‡‘é¢_æ—¥å‡']
                product_receipt_performance_value = row.get('äº§å“å•æ®ä¸šç»©_æ—¥å‡', 0)
            else:
                sales_value = row['æ€»ä¸šç»©']
                receipts_value = row['æ€»å•æ®æ•°']
                quantity_value = row['é”€å”®æ€»æ•°']
                amount_value = row['é”€å”®é‡‘é¢']
                product_receipt_performance_value = row.get('äº§å“å•æ®ä¸šç»©', 0)

            if self.show_store_average.get():
                sales_value /= store_count
                receipts_value /= store_count
                quantity_value /= store_count
                amount_value /= store_count
                product_receipt_performance_value /= store_count

            formatted_row = (
                row['æ—¥æœŸ'],
                row['æœˆä»½'],
                row['é—¨å¸‚'],
                row['äº§å“åç§°'],
                row['ç±»åˆ«'],
                format_currency(sales_value),
                format_number(receipts_value),
                format_number(quantity_value),
                format_currency(amount_value),
                format_currency(product_receipt_performance_value),
                f"{row['ä¸šç»©å æ¯”']:.2f}%",
                f"{row['æ•°é‡å æ¯”']:.2f}%",
                f"{row.get('äº§å“å•æ®ä¸šç»©å æ¯”', 0):.2f}%"
            )
            
            # ç´¯è®¡æ€»è®¡
            total_sales += row['æ€»ä¸šç»©']
            total_receipts += row['æ€»å•æ®æ•°']
            total_quantity += row['é”€å”®æ€»æ•°']
            
            self.product_overview_tree.insert("", "end", values=formatted_row)
        
        # æ·»åŠ æ€»è®¡è¡Œï¼ˆåªè®¡ç®—åŸå§‹æ•°æ®ï¼Œä¸åŒ…æ‹¬Allé—¨å¸‚æ±‡æ€»ï¼‰
        if self.product_overview_data:
            denom = len([r for r in self.product_overview_data if not r['æ—¥æœŸ'].startswith('ã€')]) if self.show_daily_average.get() else 1
            denom = denom if denom and denom > 0 else 1
            if self.show_store_average.get():
                denom *= store_count
            total_row = (
                "æ€»è®¡\nTotal",
                "",
                "",
                "æ‰€æœ‰äº§å“\nAll Products",
                "",
                format_currency(total_sales / denom),
                format_number(total_receipts / denom),
                format_number(total_quantity / denom),
                "",
                "100.00%",
                "100.00%"
            )
            
            # æ’å…¥æ€»è®¡è¡Œå¹¶è®¾ç½®é¢œè‰²
            total_item = self.product_overview_tree.insert("", "end", values=total_row, tags=("total",))
            self.product_overview_tree.tag_configure("total", background="#E6F3FF", font=('Arial', 9, 'bold'))
            
            # æ·»åŠ é¸ä¸­ç”¢å“ç¸½è¨ˆè¡Œï¼ˆåˆå§‹ç‚ºç©ºï¼‰
            self.update_daily_selected_products_summary()
        
        # åˆ‡æ¢åˆ°äº§å“æ€»è§ˆæ ‡ç­¾é¡µ
        self.safe_switch_to_tab(1, 0)
    
    def safe_switch_to_tab(self, main_tab, sub_tab=None):
        """å®‰å…¨åœ°åˆ‡æ¢åˆ°æ ‡ç­¾é¡µï¼Œä¿æŠ¤æ´»åŠ¨è®°å½•çª—å£çš„å³ä¾§é¢æ¿"""
        try:
            # æ£€æŸ¥æ´»åŠ¨è®°å½•çª—å£æ˜¯å¦æ‰“å¼€
            if hasattr(self, 'activity_window') and self.activity_window.winfo_exists():
                # æ´»åŠ¨è®°å½•çª—å£æ‰“å¼€æ—¶ï¼Œä¸åˆ‡æ¢ä¸»çª—å£æ ‡ç­¾é¡µ
                print("â›” æ´»åŠ¨è®°å½•çª—å£æ‰“å¼€ï¼Œè·³è½¬æ ‡ç­¾é¡µåˆ‡æ¢")
                return False
            
            # æ´»åŠ¨è®°å½•çª—å£å…³é—­æˆ–ä¸å­˜äºæ—¶ï¼Œå¯ä»¥åˆ‡æ¢
            self.notebook.select(main_tab)
            if sub_tab is not None:
                if main_tab == 1:  # Productæ ‡ç­¾é¡µ
                    self.product_notebook.select(sub_tab)
                elif main_tab == 0:  # Salesæ ‡ç­¾é¡µ
                    self.sales_notebook.select(sub_tab)
                elif main_tab == 2:  # Brandæ ‡ç­¾é¡µ
                    if hasattr(self, 'brand_notebook'):
                        self.brand_notebook.select(sub_tab)
            return True
            
        except Exception as e:
            print(f"åˆ‡æ¢æ ‡ç­¾é¡µå¤±è´¥: {e}")
            return False
    
    def _sort_treeview_column(self, tree, col, reverse=False):
        """å¯¹Treeviewåˆ—è¿›è¡Œæ’åº"""
        # è·å–æ‰€æœ‰æ•°æ®
        data = [(tree.set(child, col), child) for child in tree.get_children('')]
        
        # å°è¯•å°†æ•°æ®è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ’åº
        try:
            # å¦‚æœæ˜¯æ•°å­—åˆ—ï¼ŒæŒ‰æ•°å­—æ’åº
            data.sort(key=lambda x: float(x[0]) if x[0] else 0, reverse=reverse)
        except ValueError:
            # å¦‚æœä¸æ˜¯æ•°å­—ï¼ŒæŒ‰å­—ç¬¦ä¸²æ’åº
            data.sort(key=lambda x: x[0] or "", reverse=reverse)
        
        # é‡æ–°æ’åˆ—é¡¹ç›®
        for index, (val, child) in enumerate(data):
            tree.move(child, '', index)
        
        # åˆ‡æ¢æ’åºé¡ºåº
        tree.heading(col, command=lambda: self._sort_treeview_column(tree, col, not reverse))
    
    def open_activity_window(self):
        """æ‰“å¼€å¢å¼ºç‰ˆæ´»åŠ¨è®°å½•çª—å£ - å…¨æ–°ç¾åŒ–ç•Œé¢"""
        # åˆ›å»ºæ´»åŠ¨è®°å½•çª—å£ - ç°ä»£åŒ–è®¾è®¡
        self.activity_window = tk.Toplevel(self.root)
        self.activity_window.title("ğŸ¯ æ´»åŠ¨è®°å½•ç®¡ç†ä¸­å¿ƒ / Activity Management Center")
        self.activity_window.geometry("1900x1100")
        self.activity_window.transient(self.root)
        self.activity_window.grab_set()
        
        # è®¾ç½®çª—å£å›¾æ ‡å’Œæ ·å¼
        try:
            self.activity_window.configure(bg='#FFFFFF')
        except:
            pass
        
        # åˆ›å»ºé¡¶éƒ¨æ ‡é¢˜æ 
        header_frame = tk.Frame(self.activity_window, bg='#2c3e50', height=60)
        header_frame.pack(fill="x", padx=0, pady=0)
        header_frame.pack_propagate(False)
        
        # æ ‡é¢˜å’Œå›¾æ ‡
        title_container = tk.Frame(header_frame, bg='#2c3e50')
        title_container.pack(expand=True, fill="both")
        
        title_label = tk.Label(title_container, 
                              text="ğŸ¯ æ´»åŠ¨è®°å½•ç®¡ç†ä¸­å¿ƒ", 
                              font=('Microsoft YaHei UI', 18, 'bold'),
                              fg='white', bg='#2c3e50')
        title_label.pack(side="left", padx=20, pady=15)
        
        subtitle_label = tk.Label(title_container, 
                                 text="Activity Management Center", 
                                 font=('Arial', 11),
                                 fg='#bdc3c7', bg='#2c3e50')
        subtitle_label.pack(side="left", padx=(0, 20), pady=15)
        
        # çª—å£æ§åˆ¶æŒ‰é’®åŒºåŸŸ
        window_controls = tk.Frame(title_container, bg='#2c3e50')
        window_controls.pack(side="right", padx=10, pady=10)
        
        # æœ€å°åŒ–æŒ‰é’®
        minimize_btn = tk.Button(window_controls, text="ğŸ—•", 
                               command=self.minimize_activity_window,
                               font=('Arial', 12), bg='#34495e', fg='white',
                               relief='flat', bd=0, width=3, height=1,
                               cursor='hand2')
        minimize_btn.pack(side="left", padx=2)
        
        # å…¨å±/è¿˜åŸæŒ‰é’®
        self.fullscreen_btn = tk.Button(window_controls, text="ğŸ—–", 
                                      command=self.toggle_activity_fullscreen,
                                      font=('Arial', 12), bg='#34495e', fg='white',
                                      relief='flat', bd=0, width=3, height=1,
                                      cursor='hand2')
        self.fullscreen_btn.pack(side="left", padx=2)
        
        # å…³é—­æŒ‰é’®
        close_btn = tk.Button(window_controls, text="âœ•", 
                            command=self.close_activity_window,
                            font=('Arial', 12), bg='#e74c3c', fg='white',
                            relief='flat', bd=0, width=3, height=1,
                            cursor='hand2')
        close_btn.pack(side="left", padx=2)
        
        # åˆ›å»ºä¸»å®¹å™¨ - ç°ä»£åŒ–å¸ƒå±€
        main_container = tk.Frame(self.activity_window, bg='#FFFFFF')
        main_container.pack(fill="both", expand=True, padx=0, pady=0)
        
        # å·¦ä¾§ä¸»é¢æ¿ - æ´»åŠ¨ç®¡ç†åŒºåŸŸ
        left_container = tk.Frame(main_container, bg='#ffffff', relief='flat', bd=0)
        left_container.pack(side="left", fill="both", expand=True, padx=(15, 8), pady=15)
        
        # å³ä¾§é¢æ¿ - å‡æœŸä¿¡æ¯å’Œå¿«æ·æ“ä½œ
        right_container = tk.Frame(main_container, bg='#ffffff', relief='flat', bd=0)
        right_container.pack(side="right", fill="y", expand=False, padx=(8, 15), pady=15)
        right_container.configure(width=400)
        right_container.pack_propagate(False)
        
        # å‰µå»ºç¾ä»£åŒ–å¡ç‰‡å¼è¼¸å…¥å€åŸŸ
        input_card = tk.Frame(left_container, bg='#ffffff', relief='solid', bd=1)
        input_card.pack(fill="x", pady=(10, 20), padx=10)
        
        # å¡ç‰‡æ¨™é¡Œ
        card_header = tk.Frame(input_card, bg='#3498db', height=40)
        card_header.pack(fill="x")
        card_header.pack_propagate(False)
        
        header_title = tk.Label(card_header, 
                               text="ğŸ“ æ–°å¢æ´»å‹•è¨˜éŒ„", 
                               font=('Microsoft YaHei UI', 12, 'bold'),
                               fg='white', bg='#3498db')
        header_title.pack(side="left", padx=15, pady=10)
        
        header_subtitle = tk.Label(card_header, 
                                  text="Add New Activity Record", 
                                  font=('Arial', 9),
                                  fg='#ecf0f1', bg='#3498db')
        header_subtitle.pack(side="left", padx=(0, 15), pady=10)
        
        # å¡ç‰‡å…§å®¹å€åŸŸ
        card_content = tk.Frame(input_card, bg='#ffffff')
        card_content.pack(fill="both", expand=True, padx=20, pady=20)
        
        # ç·Šæ¹Šå‹é¸æ“‡å€åŸŸ - ä¸€è¡Œé¡¯ç¤º
        compact_row = tk.Frame(card_content, bg='#ffffff')
        compact_row.pack(fill="x", pady=(0, 8))
        
        # æ•¸æ“šåº«é¸æ“‡å€åŸŸ - ç·Šæ¹‘ç‰ˆ
        db_section = tk.Frame(compact_row, bg='#FFFFFF', relief='solid', bd=1)
        db_section.pack(side="left", fill="x", expand=True, padx=(0, 5))
        
        db_header = tk.Label(db_section, text="ğŸ—„ï¸ æ•¸æ“šæº / Database", 
                            font=('Microsoft YaHei UI', 10, 'bold'),
                            fg='#2c3e50', bg='#FFFFFF')
        db_header.pack(pady=(6, 4))
        
        self.activity_database = tk.StringVar(value="GOGO")
        
        # æ°´å¹³æ’åˆ—çš„æ•¸æ“šåº«æŒ‰éˆ•
        db_buttons_container = tk.Frame(db_section, bg='#FFFFFF')
        db_buttons_container.pack(pady=(0, 5), padx=5)
        
        # æ•¸æ“šåº«é¸é …é…ç½® - ç·Šæ¹Šç‰ˆ
        db_options = [
            ("GOGO", "ğŸŸ¢ GOGO", "#27ae60"),
            ("Express", "ğŸ”µ Express", "#3498db"), 
            ("PLUS", "ğŸŸ¡ PLUS", "#f39c12"),
            ("All", "ğŸŒ All", "#9b59b6")
        ]
        
        self.db_buttons = {}
        for value, text, color in db_options:
            btn = tk.Radiobutton(db_buttons_container, text=text, variable=self.activity_database,
                               value=value, command=self.on_database_change,
                               font=('Arial', 9, 'bold'), 
                               bg='white', fg=color, relief='raised', bd=1,
                               selectcolor=color, activebackground='#d5dbdb',
                               indicatoron=0, width=10, height=2)
            btn.pack(side="left", padx=2)
            self.db_buttons[value] = btn
        
        # æ´»å‹•é¡å‹é¸æ“‡å€åŸŸ - ç·Šæ¹Šç‰ˆ
        type_section = tk.Frame(compact_row, bg='#FFFFFF', relief='solid', bd=1)
        type_section.pack(side="right", fill="x", expand=True, padx=(5, 0))
        
        type_header = tk.Label(type_section, text="ğŸ“… æ´»å‹•é¡å‹ / Activity Type", 
                              font=('Microsoft YaHei UI', 10, 'bold'),
                              fg='#2c3e50', bg='#FFFFFF')
        type_header.pack(pady=(6, 4))
        
        self.activity_type = tk.StringVar(value="daily")
        
        # æ°´å¹³æ’åˆ—çš„é¡å‹æŒ‰éˆ•
        type_buttons_container = tk.Frame(type_section, bg='#FFFFFF')
        type_buttons_container.pack(pady=(0, 5), padx=5)
        
        # æ´»å‹•é¡å‹é¸é …é…ç½® - ç·Šæ¹Šç‰ˆ
        type_options = [
            ("daily", "ğŸ“… æ¯æ—¥ / Daily", "#e74c3c"),
            ("weekly", "ğŸ”„ é€±æœŸ / Weekly", "#f39c12")
        ]
        
        self.type_buttons = {}
        for value, text, color in type_options:
            btn = tk.Radiobutton(type_buttons_container, text=text, variable=self.activity_type,
                               value=value, command=self.on_activity_type_change,
                               font=('Arial', 9, 'bold'), 
                               bg='white', fg=color, relief='raised', bd=1,
                               selectcolor=color, activebackground='#FFFFFF',
                               indicatoron=0, width=12, height=2)
            btn.pack(side="left", padx=2)
            self.type_buttons[value] = btn
        
        # ç·Šæ¹Šå‹æ—¥æœŸé¸æ“‡å€åŸŸ
        date_section = tk.Frame(card_content, bg='#ffffff')
        date_section.pack(fill="x", pady=(0, 8))
        
        # æ—¥æœŸé¸æ“‡å®¹å™¨
        self.date_selection_frame = tk.Frame(date_section, bg='#ffffff')
        self.date_selection_frame.pack(fill="x")
        
        # æ¯æ—¥æ´»å‹•æ—¥æœŸé¸æ“‡ - ç·Šæ¹Šç‰ˆ
        self.daily_date_frame = tk.Frame(self.date_selection_frame, bg='#FFFFFF', relief='solid', bd=1)
        self.daily_date_frame.pack(fill="x", pady=1)
        
        daily_inputs = tk.Frame(self.daily_date_frame, bg='#FFFFFF')
        daily_inputs.pack(pady=5, padx=10)
        
        tk.Label(daily_inputs, text="ğŸ“… æ´»å‹•æ—¥æœŸ / Activity Date:", font=('Arial', 9, 'bold'),
                fg='#2c3e50', bg='#FFFFFF').pack(side="left", padx=(0, 5))
        self.activity_date_from = DateEntry(daily_inputs, width=10, background='#3498db',
                                          foreground='white', borderwidth=1, date_pattern='dd/mm/yyyy')
        self.activity_date_from.pack(side="left", padx=2)
        
        tk.Label(daily_inputs, text="åˆ°", font=('Arial', 8),
                fg='#34495e', bg='#FFFFFF').pack(side="left", padx=2)
        self.activity_date_to = DateEntry(daily_inputs, width=10, background='#3498db',
                                        foreground='white', borderwidth=1, date_pattern='dd/mm/yyyy')
        self.activity_date_to.pack(side="left", padx=2)
        
        # æ¯æ—¥æ´»å‹•æ™‚é–“ç¯©é¸å€åŸŸ - æ–°å¢
        daily_time_filter_frame = tk.Frame(self.daily_date_frame, bg='#FFFFFF')
        daily_time_filter_frame.pack(fill="x", pady=(5, 0), padx=10)
        
        # æ¯æ—¥æ´»å‹•æ™‚é–“èª¿æ•´é¸é …
        self.time_filter_enabled = tk.BooleanVar()
        daily_time_checkbox = tk.Checkbutton(daily_time_filter_frame, text="â° æ™‚é–“èª¿æ•´ / Time Adjustment", 
                                           variable=self.time_filter_enabled, font=('Arial', 9, 'bold'),
                                           fg='#2c3e50', bg='#FFFFFF', selectcolor='#FFFFFF',
                                           command=self.toggle_time_filter)
        daily_time_checkbox.pack(side="left", padx=(0, 10))
        
        # æ™‚é–“è¼¸å…¥æ¡†å®¹å™¨
        self.time_inputs_frame = tk.Frame(daily_time_filter_frame, bg='#FFFFFF')
        
        tk.Label(self.time_inputs_frame, text="é–‹å§‹æ™‚é–“:", font=('Arial', 8), 
                fg='#34495e', bg='#FFFFFF').pack(side="left", padx=(0, 2))
        self.start_time_entry = tk.Entry(self.time_inputs_frame, width=8, font=('Arial', 8))
        self.start_time_entry.pack(side="left", padx=2)
        self.start_time_entry.insert(0, "12:00")
        
        tk.Label(self.time_inputs_frame, text="çµæŸæ™‚é–“:", font=('Arial', 8), 
                fg='#34495e', bg='#FFFFFF').pack(side="left", padx=(5, 2))
        self.end_time_entry = tk.Entry(self.time_inputs_frame, width=8, font=('Arial', 8))
        self.end_time_entry.pack(side="left", padx=2)
        self.end_time_entry.insert(0, "18:00")
        
        # è‡ªå‹•æ™‚é–“ç¯„åœé¸é …
        self.auto_time_range = tk.BooleanVar()
        auto_time_checkbox = tk.Checkbutton(daily_time_filter_frame, text="ğŸ”„ å¾ç¬¬ä¸€ä»¶åˆ°æœ€å¾Œä¸€ä»¶ç”¢å“éŠ·å”®æ™‚é–“", 
                                          variable=self.auto_time_range, font=('Arial', 8),
                                          fg='#e67e22', bg='#FFFFFF', selectcolor='#FFFFFF',
                                          command=self.toggle_auto_time_range)
        auto_time_checkbox.pack(side="left", padx=(10, 0))
        
        # é€±æœŸæ€§æ´»å‹•é¸æ“‡ - ç·Šæ¹Šç‰ˆ
        self.weekly_selection_frame = tk.Frame(self.date_selection_frame, bg='#FFFFFF', relief='solid', bd=1)
        
        # é€±æœŸæ€§æ´»å‹•æ—¥æœŸç¯„åœ - ä¸€è¡Œé¡¯ç¤º
        weekly_date_frame = tk.Frame(self.weekly_selection_frame, bg='#FFFFFF')
        weekly_date_frame.pack(fill="x", pady=5, padx=10)
        
        tk.Label(weekly_date_frame, text="ğŸ“… æ´»å‹•æœŸé–“ / Activity Period:", font=('Arial', 9, 'bold'),
                fg='#2c3e50', bg='#FFFFFF').pack(side="left", padx=(0, 5))
        self.weekly_date_from = DateEntry(weekly_date_frame, width=10, background='#FFFFFF',
                                        foreground='white', borderwidth=1, date_pattern='dd/mm/yyyy')
        self.weekly_date_from.pack(side="left", padx=2)
        
        tk.Label(weekly_date_frame, text="åˆ°", font=('Arial', 8),
                fg='#34495e', bg='#FFFFFF').pack(side="left", padx=2)
        self.weekly_date_to = DateEntry(weekly_date_frame, width=10, background='#FFFFFF',
                                      foreground='white', borderwidth=1, date_pattern='dd/mm/yyyy')
        self.weekly_date_to.pack(side="left", padx=2)
        
        # æ˜ŸæœŸé¸æ“‡ - ç·Šæ¹Šç‰ˆä¸€è¡Œé¡¯ç¤º
        weekdays_frame = tk.Frame(self.weekly_selection_frame, bg='#FFFFFF')
        weekdays_frame.pack(fill="x", padx=10, pady=(0, 5))
        
        tk.Label(weekdays_frame, text="ğŸ—“ï¸ æ˜ŸæœŸ / Weekdays:", font=('Arial', 9, 'bold'),
                fg='#2c3e50', bg='#FFFFFF').pack(side="left", padx=(0, 5))
        
        self.weekday_vars = {}
        weekdays = [
            ('Monday', 'ä¸€'),
            ('Tuesday', 'äºŒ'), 
            ('Wednesday', 'ä¸‰'),
            ('Thursday', 'å››'),
            ('Friday', 'äº”'),
            ('Saturday', 'å…­'),
            ('Sunday', 'æ—¥')
        ]
        
        for en_name, display_name in weekdays:
            var = tk.BooleanVar()
            self.weekday_vars[en_name] = var
            
            cb = tk.Checkbutton(weekdays_frame, text=display_name, variable=var,
                               font=('Arial', 7), bg='#FFFFFF', fg='#2c3e50',
                               selectcolor='#FFFFFF', activebackground='#FFFFFF')
            cb.pack(side="left", padx=1)
        
        # é€±æœŸæ€§æ´»å‹•æ™‚é–“ç¯©é¸å€åŸŸ - æ–°å¢
        weekly_time_filter_frame = tk.Frame(self.weekly_selection_frame, bg='#FFFFFF')
        weekly_time_filter_frame.pack(fill="x", pady=(5, 0), padx=10)
        
        # é€±æœŸæ€§æ´»å‹•æ™‚é–“èª¿æ•´é¸é …
        self.weekly_time_filter_enabled = tk.BooleanVar()
        weekly_time_checkbox = tk.Checkbutton(weekly_time_filter_frame, text="â° æ™‚é–“èª¿æ•´ / Time Adjustment", 
                                            variable=self.weekly_time_filter_enabled, font=('Arial', 9, 'bold'),
                                            fg='#2c3e50', bg='#FFFFFF', selectcolor='#FFFFFF',
                                            command=self.toggle_weekly_time_filter)
        weekly_time_checkbox.pack(side="left", padx=(0, 10))
        
        # é€±æœŸæ€§æ´»å‹•æ™‚é–“è¼¸å…¥æ¡†å®¹å™¨
        self.weekly_time_inputs_frame = tk.Frame(weekly_time_filter_frame, bg='#FFFFFF')
        
        tk.Label(self.weekly_time_inputs_frame, text="é–‹å§‹æ™‚é–“:", font=('Arial', 8), 
                fg='#34495e', bg='#FFFFFF').pack(side="left", padx=(0, 2))
        self.weekly_start_time_entry = tk.Entry(self.weekly_time_inputs_frame, width=8, font=('Arial', 8))
        self.weekly_start_time_entry.pack(side="left", padx=2)
        self.weekly_start_time_entry.insert(0, "12:00")
        
        tk.Label(self.weekly_time_inputs_frame, text="çµæŸæ™‚é–“:", font=('Arial', 8), 
                fg='#34495e', bg='#FFFFFF').pack(side="left", padx=(5, 2))
        self.weekly_end_time_entry = tk.Entry(self.weekly_time_inputs_frame, width=8, font=('Arial', 8))
        self.weekly_end_time_entry.pack(side="left", padx=2)
        self.weekly_end_time_entry.insert(0, "18:00")
        
        # é€±æœŸæ€§æ´»å‹•è‡ªå‹•æ™‚é–“ç¯„åœé¸é …
        self.weekly_auto_time_range = tk.BooleanVar()
        weekly_auto_time_checkbox = tk.Checkbutton(weekly_time_filter_frame, text="ğŸ”„ å¾ç¬¬ä¸€ä»¶åˆ°æœ€å¾Œä¸€ä»¶ç”¢å“éŠ·å”®æ™‚é–“", 
                                                 variable=self.weekly_auto_time_range, font=('Arial', 8),
                                                 fg='#e67e22', bg='#FFFFFF', selectcolor='#FFFFFF',
                                                 command=self.toggle_weekly_auto_time_range)
        weekly_auto_time_checkbox.pack(side="left", padx=(10, 0))
        
        # åˆå§‹åŒ–é¡¯ç¤ºæ¯æ—¥æ´»å‹•å’ŒæŒ‰éˆ•æ¨£å¼
        self.on_activity_type_change()
        
        # åˆå§‹åŒ–æŒ‰éˆ•æ¨£å¼
        self.activity_window.after(100, self.update_database_button_styles)
        self.activity_window.after(100, self.update_activity_type_button_styles)
        
        # ç·Šæ¹Šå‹é¸æ“‡å™¨å€åŸŸ - å…©è¡Œä½ˆå±€
        selectors_section = tk.Frame(card_content, bg='#ffffff')
        selectors_section.pack(fill="x", pady=(0, 8))
        
        # ç¬¬ä¸€è¡Œï¼šé–€å¸‚ã€ç”¢å“ã€æ¥­ç¸¾ç¯„åœ
        first_row = tk.Frame(selectors_section, bg='#ffffff')
        first_row.pack(fill="x", pady=(0, 3))
        
        # é–€å¸‚é¸æ“‡å€åŸŸ - ç·Šæ¹Šç‰ˆ
        outlets_section = tk.Frame(first_row, bg='#FFFFFF', relief='solid', bd=1)
        outlets_section.pack(side="left", fill="x", expand=True, padx=(0, 2))
        
        outlets_header = tk.Label(outlets_section, text="ğŸª é–€å¸‚ / Outlets", 
                                 font=('Arial', 9, 'bold'),
                                 fg='#2c3e50', bg='#FFFFFF')
        outlets_header.pack(pady=(4, 3))
        
        outlets_controls = tk.Frame(outlets_section, bg='#FFFFFF')
        outlets_controls.pack(fill="x", padx=5, pady=(0, 3))
        
        # é–€å¸‚å…¨éƒ¨æŒ‰éˆ•
        outlets_all_btn = tk.Button(outlets_controls, text="å…¨éƒ¨\nAll", 
                                   command=self.select_all_outlets,
                                   font=('Arial', 8, 'bold'), bg='#3498db', fg='white',
                                   relief='flat', bd=0, padx=5, pady=2)
        outlets_all_btn.pack(side="left", padx=(0, 5))
        
        self.activity_outlets = MultiSelectCombobox(outlets_controls, width=12, 
                                                   title="é¸æ“‡é–€å¸‚", delay_ms=1000)
        self.activity_outlets.pack(side="left", fill="x", expand=True)
        
        # ç”¢å“é¸æ“‡å€åŸŸ - ç·Šæ¹Šç‰ˆ
        products_section = tk.Frame(first_row, bg='#FFFFFF', relief='solid', bd=1)
        products_section.pack(side="left", fill="x", expand=True, padx=2)
        
        products_header = tk.Label(products_section, text="ğŸ£ ç”¢å“ / Products", 
                                  font=('Arial', 9, 'bold'),
                                  fg='#2c3e50', bg='#FFFFFF')
        products_header.pack(pady=(4, 3))
        
        products_controls = tk.Frame(products_section, bg='#FFFFFF')
        products_controls.pack(fill="x", padx=5, pady=(0, 3))
        
        # ç”¢å“å…¨éƒ¨æŒ‰éˆ•
        products_all_btn = tk.Button(products_controls, text="å…¨éƒ¨\nAll", 
                                    command=self.select_all_products,
                                    font=('Arial', 8, 'bold'), bg='#27ae60', fg='white',
                                    relief='flat', bd=0, padx=5, pady=2)
        products_all_btn.pack(side="left", padx=(0, 5))
        
        self.activity_products = MultiSelectCombobox(products_controls, width=12, 
                                                   title="é¸æ“‡ç”¢å“", delay_ms=1000)
        self.activity_products.pack(side="left", fill="x", expand=True)
        
        # æ¥­ç¸¾ç¯„åœé¸æ“‡å€åŸŸ - ç·Šæ¹Šç‰ˆ
        parts_section = tk.Frame(first_row, bg='#FFFFFF', relief='solid', bd=1)
        parts_section.pack(side="right", fill="x", expand=True, padx=(2, 0))
        
        parts_header = tk.Label(parts_section, text="ğŸ’° æ¥­ç¸¾ç¯„åœ / Performance", 
                               font=('Arial', 9, 'bold'),
                               fg='#2c3e50', bg='#FFFFFF')
        parts_header.pack(pady=(4, 3))
        
        parts_controls = tk.Frame(parts_section, bg='#FFFFFF')
        parts_controls.pack(fill="x", padx=5, pady=(0, 3))
        
        # æ¥­ç¸¾ç¯„åœå…¨éƒ¨æŒ‰éˆ•
        parts_all_btn = tk.Button(parts_controls, text="å…¨éƒ¨\nAll", 
                                 command=self.select_all_parts,
                                 font=('Arial', 8, 'bold'), bg='#e67e22', fg='white',
                                 relief='flat', bd=0, padx=5, pady=2)
        parts_all_btn.pack(side="left", padx=(0, 5))
        
        self.activity_parts = MultiSelectCombobox(parts_controls, width=12, 
                                                title="é¸æ“‡æ¥­ç¸¾ç¯„åœ", delay_ms=1000)
        self.activity_parts.pack(side="left", fill="x", expand=True)
        
        # ç¬¬äºŒè¡Œï¼šæ”¯ä»˜æ–¹å¼å’Œæè¿°
        second_row = tk.Frame(selectors_section, bg='#ffffff')
        second_row.pack(fill="x")
        
        # æ”¯ä»˜æ–¹å¼é¸æ“‡ - ç·Šæ¹Šç‰ˆ
        payment_section = tk.Frame(second_row, bg='#FFFFFF', relief='solid', bd=1)
        payment_section.pack(side="left", fill="x", expand=True, padx=(0, 2))
        
        payment_header = tk.Label(payment_section, text="ğŸ’³ æ”¯ä»˜æ–¹å¼ / Payment Methods", 
                                 font=('Arial', 9, 'bold'),
                                 fg='#2c3e50', bg='#FFFFFF')
        payment_header.pack(pady=(4, 3))
        
        payment_controls = tk.Frame(payment_section, bg='#FFFFFF')
        payment_controls.pack(fill="x", padx=5, pady=(0, 3))
        
        # æ”¯ä»˜æ–¹å¼å…¨éƒ¨æŒ‰éˆ•
        payment_all_btn = tk.Button(payment_controls, text="å…¨éƒ¨\nAll", 
                                   command=self.select_all_payment_methods,
                                   font=('Arial', 8, 'bold'), bg='#9b59b6', fg='white',
                                   relief='flat', bd=0, padx=5, pady=2)
        payment_all_btn.pack(side="left", padx=(0, 5))
        
        self.activity_payment = MultiSelectCombobox(payment_controls, width=17, 
                                                   title="é¸æ“‡æ”¯ä»˜æ–¹å¼", delay_ms=1000)
        self.activity_payment.pack(side="left", fill="x", expand=True)
        
        # æ´»å‹•æè¿° - ç·Šæ¹Šç‰ˆ
        description_section = tk.Frame(second_row, bg='#FFFFFF', relief='solid', bd=1)
        description_section.pack(side="right", fill="x", expand=True, padx=(2, 0))
        
        description_header = tk.Label(description_section, text="ğŸ“ æ´»å‹•æè¿° / Description", 
                                     font=('Arial', 9, 'bold'),
                                     fg='#2c3e50', bg='#FFFFFF')
        description_header.pack(pady=(4, 3))
        
        description_controls = tk.Frame(description_section, bg='#FFFFFF')
        description_controls.pack(fill="x", padx=5, pady=(0, 3))
        
        self.activity_description = tk.Entry(description_controls, font=('Arial', 9),
                                           relief='solid', bd=1, bg='white')
        self.activity_description.pack(fill="x")
        
        # è¨­ç½®é¸é …
        self.activity_parts.set_values(['DI', 'TA', 'Delivery', 'Food Panda', 'Grab Food', 'Deliveroo', 'All'])
        
        # åŠ è¼‰ç”¢å“åˆ—è¡¨
        self.refresh_activity_products()
        
        payment_methods = ['VISA', 'MASTER', 'NETS', 'AMEX', 'UnionPay', 'DBS MAX', 'CDC Voucher', 'Mall Voucher', 
                          'GRAB FOOD', 'FOOD PANDA', 'DELIVEROO', 'SE APP', 'WASTAGE']
        self.activity_payment.set_values(payment_methods)
        
        # ç¢ºä¿é–€å¸‚åˆ—è¡¨å¯ç”¨
        if not hasattr(self, 'available_outlets') or not self.available_outlets:
            try:
                # å˜—è©¦å¾æ•¸æ“šåº«ç²å–é–€å¸‚åˆ—è¡¨
                outlets = self.db_manager.get_outlets()
                if outlets:
                    self.available_outlets = outlets
                    print(f"âœ… æ´»å‹•è¨˜éŒ„çª—å£å·²ç²å– {len(outlets)} å€‹é–€å¸‚")
                else:
                    print("âš ï¸ ç„¡æ³•ç²å–é–€å¸‚åˆ—è¡¨ï¼Œè«‹å…ˆé€£æ¥æ•¸æ“šåº«")
            except Exception as e:
                print(f"ç²å–é–€å¸‚åˆ—è¡¨å¤±æ•—: {e}")
        
        if hasattr(self, 'available_outlets') and self.available_outlets:
            self.activity_outlets.set_values(self.available_outlets)
        
        # ç·Šæ¹Šå‹æŒ‰éˆ•å€åŸŸ
        action_section = tk.Frame(card_content, bg='#ffffff')
        action_section.pack(fill="x", pady=(5, 0))
        
        # æŒ‰éˆ•å®¹å™¨ - ç·Šæ¹Šç‰ˆ
        buttons_container = tk.Frame(action_section, bg='#2c3e50', relief='solid', bd=1)
        buttons_container.pack(fill="x", pady=3)
        
        # æ‰€æœ‰æŒ‰éˆ•åœ¨ä¸€è¡Œ - ç·Šæ¹Šè¨­è¨ˆ
        all_buttons = tk.Frame(buttons_container, bg='#2c3e50')
        all_buttons.pack(fill="x", padx=8, pady=5)
        
        # ä¸»è¦æ“ä½œæŒ‰éˆ• - ç·Šæ¹Šç‰ˆ
        add_btn = tk.Button(all_buttons, text="â• æ·»åŠ  / Add", 
                           command=self.add_activity_record,
                           font=('Arial', 9, 'bold'), bg='#27ae60', fg='white',
                           relief='flat', bd=0, padx=10, pady=4)
        add_btn.pack(side="left", padx=(0, 2), fill="x", expand=True)
        
        analyze_btn = tk.Button(all_buttons, text="ğŸ“Š åˆ†æ / Analyze", 
                               command=self.analyze_activity,
                               font=('Arial', 9, 'bold'), bg='#3498db', fg='white',
                               relief='flat', bd=0, padx=10, pady=4)
        analyze_btn.pack(side="left", padx=2, fill="x", expand=True)
        
        breakdown_btn = tk.Button(all_buttons, text="ğŸ“ˆ ç»†é¡¹åˆ†æ / Breakdown Analysis", 
                                 command=self.breakdown_analysis,
                                 font=('Arial', 9, 'bold'), bg='#e67e22', fg='white',
                                 relief='flat', bd=0, padx=10, pady=4)
        breakdown_btn.pack(side="left", padx=2, fill="x", expand=True)
        
        view_btn = tk.Button(all_buttons, text="ğŸ“‹ æŸ¥çœ‹ / View", 
                            command=self.view_activity_records,
                            font=('Arial', 9, 'bold'), bg='#9b59b6', fg='white',
                            relief='flat', bd=0, padx=10, pady=4)
        view_btn.pack(side="left", padx=2, fill="x", expand=True)
        
        delete_btn = tk.Button(all_buttons, text="ğŸ—‘ï¸ åˆªé™¤ / Delete", 
                              command=self.delete_single_activity_record,
                              font=('Arial', 9, 'bold'), bg='#e74c3c', fg='white',
                              relief='flat', bd=0, padx=10, pady=4)
        delete_btn.pack(side="left", padx=2, fill="x", expand=True)
        
        clear_btn = tk.Button(all_buttons, text="ğŸ—‘ï¸ æ¸…ç©º / Clear", 
                             command=self.clear_activity_records,
                             font=('Arial', 9, 'bold'), bg='#c0392b', fg='white',
                             relief='flat', bd=0, padx=10, pady=4)
        clear_btn.pack(side="left", padx=2, fill="x", expand=True)
        
        close_btn = tk.Button(all_buttons, text="âŒ é—œé–‰ / Close", 
                             command=self.activity_window.destroy,
                             font=('Arial', 9, 'bold'), bg='#7f8c8d', fg='white',
                             relief='flat', bd=0, padx=10, pady=4)
        close_btn.pack(side="right", padx=(2, 0), fill="x", expand=True)
        
        # æ´»å‹•è¨˜éŒ„åˆ—è¡¨å€åŸŸ - ç¾ä»£åŒ–è¨­è¨ˆ
        list_card = tk.Frame(left_container, bg='#ffffff', relief='solid', bd=1)
        list_card.pack(fill="both", expand=True, pady=(20, 10), padx=10)
        
        # åˆ—è¡¨æ¨™é¡Œ
        list_header = tk.Frame(list_card, bg='#34495e', height=40)
        list_header.pack(fill="x")
        list_header.pack_propagate(False)
        
        list_title = tk.Label(list_header, 
                             text="ğŸ“‹ æ´»å‹•è¨˜éŒ„åˆ—è¡¨ / Activity Records List", 
                             font=('Microsoft YaHei UI', 13, 'bold'),
                             fg='white', bg='#34495e')
        list_title.pack(side="left", padx=15, pady=12)
        
        list_subtitle = tk.Label(list_header, 
                                text="Activity Records List", 
                                font=('Arial', 9),
                                fg='#bdc3c7', bg='#34495e')
        list_subtitle.pack(side="left", padx=(0, 15), pady=10)
        
        # æœç´¢åŠŸèƒ½åŒºåŸŸ
        search_frame = tk.Frame(list_header, bg='#34495e')
        search_frame.pack(side="right", padx=10, pady=5)
        
        tk.Label(search_frame, text="ğŸ” æœç´¢:", font=('Arial', 9), 
                fg='white', bg='#34495e').pack(side="left", padx=(0, 5))
        
        self.activity_search_entry = tk.Entry(search_frame, width=15, font=('Arial', 9))
        self.activity_search_entry.pack(side="left", padx=2)
        self.activity_search_entry.bind('<KeyRelease>', self.on_activity_search_change)
        
        # æ¸…é™¤æœç´¢æŒ‰é’®
        clear_search_btn = tk.Button(search_frame, text="âŒ", 
                                   command=self.clear_activity_search,
                                   font=('Arial', 8), bg='#e74c3c', fg='white',
                                   relief='flat', bd=0, width=2, height=1,
                                   cursor='hand2')
        clear_search_btn.pack(side="left", padx=2)
        
        # åˆ—è¡¨å®¹å™¨
        list_container = tk.Frame(list_card, bg='#ffffff')
        list_container.pack(fill="both", expand=True, padx=15, pady=15)
        
        # å‰µå»ºç¾ä»£åŒ–Treeview
        columns = ('æ´»å‹•ID', 'æ´»å‹•åç¨±', 'æ—¥æœŸæœŸé–“', 'æ˜ŸæœŸç¯©é¸', 'ç¸½æ¥­ç¸¾', 'ç¸½å–®æ“šæ•¸', 'æ´»å‹•æ¥­ç¸¾', 'æ´»å‹•å–®æ“šæ•¸', 'æ¥­ç¸¾å æ¯”%', 'å–®æ“šæ•¸å æ¯”%')
        self.activity_tree = ttk.Treeview(list_container, columns=columns, show='headings', height=12)
        
        # å„ªåŒ–åˆ—æ¨™é¡Œå’Œå¯¬åº¦
        column_configs = [
            ('æ´»å‹•ID', 'æ´»å‹•ID / Activity ID', 80),  # éš±è—åˆ—
            ('æ´»å‹•åç¨±', 'æ´»å‹•åç¨± / Activity Name', 200),
            ('æ—¥æœŸæœŸé–“', 'æ—¥æœŸæœŸé–“ / Date Period', 150),
            ('æ˜ŸæœŸç¯©é¸', 'æ˜ŸæœŸç¯©é¸ / Weekdays', 120),
            ('ç¸½æ¥­ç¸¾', 'ç¸½æ¥­ç¸¾ / Total Sales', 120),
            ('ç¸½å–®æ“šæ•¸', 'ç¸½å–®æ“šæ•¸ / Total Receipts', 120),
            ('æ´»å‹•æ¥­ç¸¾', 'æ´»å‹•æ¥­ç¸¾ / Activity Sales', 130),
            ('æ´»å‹•å–®æ“šæ•¸', 'æ´»å‹•å–®æ“šæ•¸ / Activity Receipts', 130),
            ('æ¥­ç¸¾å æ¯”%', 'æ¥­ç¸¾å æ¯”% / Sales Ratio%', 120),
            ('å–®æ“šæ•¸å æ¯”%', 'å–®æ“šæ•¸å æ¯”% / Receipt Ratio%', 130)
        ]
        
        for col_id, col_text, col_width in column_configs:
            self.activity_tree.heading(col_id, text=col_text)
            self.activity_tree.column(col_id, width=col_width, minwidth=col_width//2)
        
        # éš±è—æ´»å‹•IDåˆ—
        self.activity_tree.column('æ´»å‹•ID', width=0, minwidth=0, stretch=False)
        
        # ç¾ä»£åŒ–æ»¾å‹•æ¢
        activity_scrollbar = ttk.Scrollbar(list_container, orient="vertical", command=self.activity_tree.yview)
        self.activity_tree.configure(yscrollcommand=activity_scrollbar.set)
        
        self.activity_tree.pack(side="left", fill="both", expand=True)
        activity_scrollbar.pack(side="right", fill="y")
        
        # é‡æ–°åŠ è½½æ´»åŠ¨è®°å½•æ•°æ®
        self.load_activity_records()
        
        # åˆ·æ–°æ´»å‹•è¨˜éŒ„é¡¯ç¤º
        self.refresh_activity_tree()
        
        # ç¢ºä¿ç”¢å“é¸æ“‡å™¨é¡¯ç¤ºå·²å°å…¥çš„ç”¢å“
        self.activity_window.after(100, self.update_activity_products_from_records)
        
        # é¡å¤–ç¢ºä¿ç”¢å“é¸æ“‡å™¨æ›´æ–°
        self.activity_window.after(500, self.force_update_product_selector)
        
        # è¨­ç½®å³å´é¢æ¿å…§å®¹ - ç¾ä»£åŒ–è¨­è¨ˆ
        try:
            self.setup_activity_right_panel(right_container)
            print("âœ… å³å´é¢æ¿è¨­ç½®å®Œæˆ")
        except Exception as e:
            print(f"âŒ å³å´é¢æ¿è¨­ç½®å¤±æ•—: {e}")
        
        # ç¢ºä¿å³å´é¢æ¿å§‹çµ‚ä¿æŒå¯è¦‹
        self.activity_window.after(50, self.ensure_activity_right_panel_visible)
        
        # åˆå§‹æ•¸æ“šåº«é€£æ¥
        self.activity_window.after(100, self.initial_database_connection)
        
        print("âœ… æ´»å‹•è¨˜éŒ„çª—å£é–‹å•Ÿï¼Œå³å´é¢æ¿å·²è¨­ç½®")
    
    def force_show_right_panel(self):
        """å¼ºåˆ¶æ˜¾ç¤ºå³ä¾§é¢æ¿ - å®Œå…¨ç¦ç”¨é˜²æ­¢ç ´å£ä¸»çª—å£é¢æ¿"""
        try:
            print("âš ï¸ å®Œå…¨ç¦ç”¨force_show_right_panelï¼Œé˜²æ­¢ç ´å£ä¸»çª—å£é¢æ¿")
            # ä¸å†åŸ·è¡Œä»»ä½•æ“ä½œ
            return
        except Exception as e:
            print(f"ç¦æ­¢å¼ºåˆ¶æ˜¾ç¤ºå³ä¾§é¢æ¿æ“ä½œ: {e}")

    def ensure_activity_right_panel_visible(self):
        """ç¡®ä¿æ´»åŠ¨è®°å½•çª—å£çš„å³ä¾§é¢æ¿å¯è§"""
        try:
            if hasattr(self, 'activity_window') and self.activity_window.winfo_exists():
                # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å³ä¾§é¢æ¿ç»„ä»¶
                if hasattr(self, 'holiday_info_text') and hasattr(self, 'holiday_tree'):
                    print("âœ… å³ä¾§é¢æ¿ç»„ä»¶å·²å­˜åœ¨")
                    return
                
                print("âš ï¸ å³ä¾§é¢æ¿ç»„ä»¶ç¼ºå¤±ï¼Œé‡æ–°å‰µå»º...")
                # é‡æ–°å‰µå»ºå³å´é¢æ¿
                if hasattr(self, 'activity_window'):
                    # ç²å–å³å´å®¹å™¨
                    for child in self.activity_window.winfo_children():
                        if isinstance(child, tk.Frame):
                            for grandchild in child.winfo_children():
                                if hasattr(grandchild, 'winfo_children'):
                                    for great_grandchild in grandchild.winfo_children():
                                        if 'right' in str(great_grandchild).lower() or 'holiday' in str(great_grandchild).lower():
                                            self.setup_activity_right_panel(great_grandchild)
                                            return
                
        except Exception as e:
            print(f"ç¡®ä¿å³ä¾§é¢æ¿å¯è§æ—¶å‡ºé”™: {e}")

    def persistent_right_panel(self):
        """æŒç»­æ€§æ£€æŸ¥å¹¶ä¿æŒå³ä¾§é¢æ¿ - å·²ç¦ç”¨é˜²æ­¢ç ´åä¸»çª—å£é¢æ¿"""
        try:
            print("âš ï¸ ç¦ç”¨æŒçºŒæ€§é¢æ¿æª¢æŸ¥ï¼Œé˜²æ­¢ç ´å£ä¸»çª—å£é¢æ¿")
            # ä¸å†åŸ·è¡Œä»»ä½•é¢æ¿é‡æ–°å‰µå»ºæ“ä½œ
            return
            
            # åŸå§‹ä»£ç¢¼å·²è¢«è¨»é‡‹ä»¥é˜²æ­¢ç ´å£ä¸»çª—å£é¢æ¿
            # if hasattr(self, 'activity_window') and self.activity_window.winfo_exists():
            #     if not (hasattr(self, 'holiday_info_text') and hasattr(self, 'holiday_tree')):
            #         print("ğŸ”„ å³ä¾§é¢æ¿ç»„ä»¶ç¼ºå¤±ï¼Œé‡æ–°åˆ›å»º...")
            #         ...
        except Exception as e:
            print(f"ä¿æŒå³ä¾§é¢æ¿å¤±è´¥: {e}")
    
    def add_holiday_record_record(self):
        """æ·»åŠ å‡æœŸè®°å½• - æ–°çš„ç¾åŒ–æ–¹æ³•"""
        try:
            # åˆ›å»ºæ·»åŠ å‡æœŸè®°å½•çš„å¯¹è¯æ¡†
            holiday_dialog = tk.Toplevel(self.root)
            holiday_dialog.title("æ·»åŠ å‡æœŸè®°å½•")
            holiday_dialog.geometry("400x350")
            holiday_dialog.transient(self.root)
            holiday_dialog.grab_set()
            
            # æ¡†æ¶
            main_frame = tk.Frame(holiday_dialog, padding="10")
            main_frame.pack(fill="both", expand=True)
            
            # æ ‡é¢˜
            title_label = tk.Label(main_frame, text="ğŸ“… æ·»åŠ å‡æœŸè®°å½•", font=('Arial', 14, 'bold'))
            title_label.pack(pady=(0, 15))
            
            # å¼€å§‹æ—¥æœŸ
            tk.Label(main_frame, text="å¼€å§‹æ—¥æœŸ / Start Date:").pack(anchor="w", pady=(0, 5))
            from datetime import datetime, timedelta
            start_date_var = tk.StringVar(value=datetime.now().strftime('%Y-%m-%d'))
            start_date_entry = ttk.Entry(main_frame, textvariable=start_date_var, width=20)
            start_date_entry.pack(anchor="w", pady=(0, 10))
            
            # ç»“æŸæ—¥æœŸ
            tk.Label(main_frame, text="ç»“æŸæ—¥æœŸ / End Date:").pack(anchor="w", pady=(0, 5))
            end_date_var = tk.StringVar(value=datetime.now().strftime('%Y-%m-%d'))
            end_date_entry = ttk.Entry(main_frame, textvariable=end_date_var, width=20)
            end_date_entry.pack(anchor="w", pady=(0, 10))
            
            # å‡æœŸåç§°
            tk.Label(main_frame, text="å‡æœŸåç§° / Holiday Name:").pack(anchor="w", pady=(0, 5))
            holiday_name_var = tk.StringVar()
            holiday_name_entry = ttk.Entry(main_frame, textvariable=holiday_name_var, width=30)
            holiday_name_entry.pack(anchor="w", pady=(0, 10))
            
            # å‡æœŸé•¿åº¦è®¡ç®—æ ‡ç­¾
            length_label = tk.Label(main_frame, text="å‡æœŸé•¿åº¦å°†è‡ªåŠ¨è®¡ç®—")
            length_label.pack(anchor="w", pady=(0, 15))
            
            def save_record():
                """ä¿å­˜å‡æœŸè®°å½•"""
                try:
                    # è·å–è¾“å…¥å€¼
                    start_date = start_date_var.get().strip()
                    end_date = end_date_var.get().strip()
                    holiday_name = holiday_name_var.get().strip()
                    
                    # éªŒè¯è¾“å…¥
                    if not all([start_date, end_date, holiday_name]):
                        tk.messagebox.showerror("é”™è¯¯", "è¯·å¡«å†™æ‰€æœ‰å­—æ®µ")
                        return
                    
                    # è®¡ç®—å‡æœŸé•¿åº¦
                    from datetime import datetime
                    start = datetime.strptime(start_date, '%Y-%m-%d')
                    end = datetime.strptime(end_date, '%Y-%m-%d')
                    duration = (end - start).days + 1
                    
                    # åˆ›å»ºè®°å½•
                    current_db = self.get_current_database()
                    if current_db not in self.holiday_records:
                        self.holiday_records[current_db] = []
                    
                    record = {
                        'start_date': start_date,
                        'end_date': end_date,
                        'holiday_name': holiday_name,
                        'duration': duration
                    }
                    
                    self.holiday_records[current_db].append(record)
                    
                    # è‡ªå‹•ä¿å­˜åˆ° PromotionRecords.xlsx
                    self.auto_save_promotion_records()
                    
                    # åˆ·æ–°æ˜¾ç¤º
                    if hasattr(self, 'holiday_tree'):
                        self.refresh_holiday_tree()
                    
                    tk.messagebox.showinfo("æˆåŠŸ", f"å‡æœŸè®°å½•å·²æ·»åŠ : {holiday_name}")
                    holiday_dialog.destroy()
                    
                except Exception as e:
                    tk.messagebox.showerror("é”™è¯¯", f"æ·»åŠ å‡æœŸå¤±è´¥: {e}")
            
            # æŒ‰é’®åŒºåŸŸ
            button_frame = tk.Frame(main_frame)
            button_frame.pack(fill="x", pady=10)
            
            ttk.Button(button_frame, text="ä¿å­˜è®°å½•", command=save_record).pack(side="right", padx=(4, 0))
            ttk.Button(button_frame, text="å–æ¶ˆ", command=holiday_dialog.destroy).pack(side="right")
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"æ·»åŠ å‡æœŸè®°å½•å¤±è´¥: {e}")
    
    def delete_holiday_record_record(self):
        """åˆ é™¤å‡æœŸè®°å½•"""
        try:
            if not hasattr(self, 'holiday_tree'):
                tk.messagebox.showwarning("è­¦å‘Š", "å‡æœŸè®°å½•è¡¨ä¸å­˜åœ¨")
                return
            
            selection = self.holiday_tree.selection()
            if not selection:
                tk.messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©è¦åˆ é™¤çš„å‡æœŸè®°å½•")
                return
            
            # è·å–é€‰ä¸­çš„è®°å½•
            item = self.holiday_tree.item(selection[0])
            values = item['values']
            holiday_name = values[2]
            
            # ç¡®è®¤åˆ é™¤
            from tkinter import messagebox
            if messagebox.askyesno("ç¡®è®¤åˆ é™¤", f"æ˜¯å¦ç¡®å®šåˆ é™¤å‡æœŸè®°å½•: {holiday_name}?"):
                # ä»æ•°æ®ä¸­åˆ é™¤
                current_db = self.activity_database.get() if hasattr(self, 'activity_database') else 'Express'
                if current_db in self.holiday_records:
                    # æŸ¥æ‰¾å¹¶åˆ é™¤è®°å½•
                    record_to_delete = None
                    for record in self.holiday_records[current_db]:
                        if (record.get('holiday_name') == holiday_name and 
                            record.get('start_date') == values[0]):
                            record_to_delete = record
                            break
                    if record_to_delete:
                        self.holiday_records[current_db].remove(record_to_delete)
                        
                        # åˆ·æ–°æ˜¾ç¤º
                        self.refresh_holiday_tree()
                        tk.messagebox.showinfo("æˆåŠŸ", f"å‡æœŸè®°å½• '{holiday_name}' å·²åˆ é™¤")
                    else:
                        tk.messagebox.showwarning("è­¦å‘Š", "æœªèƒ½æ‰¾åˆ°è¦åˆ é™¤çš„è®°å½•")
                else:
                    tk.messagebox.showwarning("è­¦å‘Š", "å½“å‰æ•°æ®åº“æ²¡æœ‰å‡æœŸè®°å½•")
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"åˆ é™¤å‡æœŸè®°å½•å¤±è´¥: {e}")
    
    def save_holiday_records_to_file(self):
        """ä¿å­˜å‡æœŸè®°å½•åˆ°æ–‡ä»¶"""
        try:
            import json
            import os
            
            os.makedirs('cache', exist_ok=True)
            
            if not hasattr(self, 'holiday_records'):
                self.holiday_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': []
                }
            
            filename = 'cache/holiday_records.json'
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(self.holiday_records, f, ensure_ascii=False, indent=2)
            
            tk.messagebox.showinfo("æˆåŠŸ", f"å‡æœŸè®°å½•å·²ä¿å­˜åˆ° {filename}")
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"ä¿å­˜å‡æœŸè®°å½•å¤±è´¥: {e}")
    
    def refresh_holiday_tree(self):
        """åˆ·æ–°å‡æœŸè®°å½•æ ‘æ˜¾ç¤º"""
        try:
            if not hasattr(self, 'holiday_tree'):
                print("âŒ å‡æœŸè®°å½•è¡¨æ ¼ä¸å­˜åœ¨")
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.holiday_tree.get_children():
                self.holiday_tree.delete(item)
            
            # è·å–å½“å‰é€‰ä¸­çš„æ•°æ®åº“
            current_db = self.get_current_database() if hasattr(self, 'activity_database') else 'Express'
            
            # ç¡®ä¿å‡æœŸè®°å½•å­—å…¸å­˜åœ¨
            if not hasattr(self, 'holiday_records'):
                self.holiday_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': []
                }
            
            # ç¡®ä¿å½“å‰æ•°æ®åº“é”®å­˜åœ¨
            if current_db not in self.holiday_records:
                self.holiday_records[current_db] = []
            
            print(f"ğŸ“… åˆ·æ–°å‡æœŸè®°å½•æ ‘ - å½“å‰æ•°æ®åº“: {current_db}")
            print(f"ğŸ“… å‡æœŸè®°å½•æ•°: {len(self.holiday_records[current_db])}")
            
            # æ˜¾ç¤ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰è®°å½•
            for record in self.holiday_records[current_db]:
                duration_text = f"{record.get('duration', 0)} å¤©"
                self.holiday_tree.insert("", "end", values=(
                    record.get('start_date', ''),
                    record.get('end_date', ''),
                    record.get('holiday_name', ''),
                    duration_text
                ))
            
            print(f"âœ… å‡æœŸè®°å½•åˆ·æ–°å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ åˆ·æ–°å‡æœŸè®°å½•å¤±è´¥: {e}")
            if hasattr(self, 'show_activity_message'):
                self.show_activity_message(f"âŒ åˆ·æ–°å‡æœŸè®°å½•å¤±è´¥: {e}")
    
    def recreate_activity_right_panel(self):
        """é‡æ–°åˆ›å»ºæ´»åŠ¨è®°å½•çª—å£çš„å³ä¾§é¢æ¿ - å®Œå…¨ç¦ç”¨"""
        try:
            print("âš ï¸ å®Œå…¨ç¦ç”¨recreate_activity_right_panelï¼Œé˜²æ­¢ç ´å£ä¸»çª—å£é¢æ¿")
            # ä¸å†åŸ·è¡Œä»»ä½•é‡æ–°å‰µå»ºæ“ä½œ
            return
            
        except Exception as e:
            print(f"ç¦æ­¢é‡æ–°åˆ›å»ºå³ä¾§é¢æ¿: {e}")
    
    def final_right_panel_protection(self):
        """æœ€çµ‚å³å´é¢æ¿ä¿è­·æªæ–½ - ç¢ºä¿é¢æ¿æ°¸ä¸è¢«ç ´å£"""
        try:
            print("ğŸ›¡ï¸ åŸ·è¡Œæœ€çµ‚å³å´é¢æ¿ä¿è­·æªæ–½...")
            
            # æª¢æŸ¥å³å´é¢æ¿ç‹€æ…‹
            if hasattr(self, 'right_panel'):
                # å¼·åˆ¶ç¢ºä¿ä¿è­·æ¨™è¨˜
                self._right_panel_protected = True
                
                # ç¢ºä¿é¢æ¿å¯è¦‹
                self.right_panel.lift()
                self.right_panel.tkraise()
                
                # æª¢æŸ¥å­çµ„ä»¶
                child_count = len(self.right_panel.winfo_children())
                print(f"ğŸ›¡ï¸ å³å´é¢æ¿æœ€çµ‚ä¿è­· - å­çµ„ä»¶æ•¸é‡: {child_count}")
                
                # å¦‚æœæ²’æœ‰å­çµ„ä»¶ï¼Œé‡æ–°å‰µå»ºåŸºç¤çµæ§‹
                if child_count == 0:
                    print("ğŸ”§ å³å´é¢æ¿ç‚ºç©ºï¼Œå‰µå»ºåŸºç¤ä¿è­·çµæ§‹")
                    self.create_basic_right_panel_structure()
                else:
                    print("âœ… å³å´é¢æ¿å·²å®Œæ•´ï¼Œä¿è­·ç”Ÿæ•ˆ")
                    
            print("âœ… æœ€çµ‚ä¿è­·æªæ–½å®Œæˆ")
                    
        except Exception as e:
            print(f"âŒ æœ€çµ‚ä¿è­·æªæ–½å¤±æ•—: {e}")
    
    def create_basic_right_panel_structure(self):
        """å‰µå»ºåŸºç¤çš„å³å´é¢æ¿çµæ§‹ - ç·Šæ€¥ä¿®å¾©"""
        try:
            print("ğŸ”§ å‰µå»ºåŸºç¤å³å´é¢æ¿çµæ§‹...")
            
            # ç°¡å–®æ¨™é¡Œ
            header = tk.Frame(self.right_panel, bg='#e74c3c', height=45)
            header.pack(fill="x")
            header.pack_propagate(False)
            
            title = tk.Label(header, text="ğŸ“Š æ´»åŠ¨æé†’", 
                           font=('Microsoft YaHei UI', 13, 'bold'),
                           fg='white', bg='#e74c3c')
            title.pack(pady=12)
            
            # ç°¡å–®æ–‡æœ¬å€åŸŸ
            text_area = tk.Text(self.right_panel, height=15, width=28,
                              font=('Segoe UI', 10), wrap=tk.WORD, bg='#FFFFFF',
                              state='disabled', relief='flat', borderwidth=2)
            text_area.pack(fill="both", expand=True, padx=5, pady=5)
            
            # è¨­ç½®å…§å®¹
            text_area.config(state='normal')
            text_area.delete(1.0, tk.END)
            protection_text = """ğŸ“Š æ´»åŠ¨æé†’

âœ… å³å´é¢æ¿å·²å—ä¿è­·ï¼

ç³»çµ±ç‹€æ…‹: æ­£å¸¸é‹è¡Œ
ä¿è­·ç‹€æ…‹: å·²æ¿€æ´»
é¢æ¿å¯¬åº¦: 270px

ğŸ›¡ï¸ å®‰å…¨æªæ–½:
â€¢ é¢æ¿çµæ§‹å·²é–å®š
â€¢ å…§å®¹å—ä¿è­·ï¼Œä¸å¯ç ´å£
â€¢ æŒçºŒç›£æ§ç‹€æ…‹

ğŸ’¡ ä½¿ç”¨æç¤º:
â€¢ ç¹¼çºŒä½¿ç”¨å·¦å´åŠŸèƒ½
â€¢ é¢æ¿å°‡ä¿æŒç©©å®š
â€¢ æ‰€æœ‰æ“ä½œéƒ½å·²å—ä¿è­·"""
            
            text_area.insert(1.0, protection_text)
            text_area.config(state='disabled')
            
            # å­˜å„²å¼•ç”¨
            self.activity_alert_text = text_area
            
            print("âœ… åŸºç¤å³å´é¢æ¿çµæ§‹å‰µå»ºå®Œæˆ")
            
        except Exception as e:
            print(f"âŒ åŸºç¤çµæ§‹å‰µå»ºå¤±æ•—: {e}")

    def minimize_activity_window(self):
        """æœ€å°åŒ–æ´»åŠ¨è®°å½•çª—å£"""
        try:
            if hasattr(self, 'activity_window') and self.activity_window:
                self.activity_window.iconify()
        except Exception as e:
            print(f"æœ€å°åŒ–çª—å£å¤±è´¥: {e}")

    def toggle_activity_fullscreen(self):
        """åˆ‡æ¢æ´»åŠ¨è®°å½•çª—å£å…¨å±çŠ¶æ€"""
        try:
            if hasattr(self, 'activity_window') and self.activity_window:
                if self.activity_window_fullscreen:
                    # é€€å‡ºå…¨å±
                    self.activity_window.attributes('-fullscreen', False)
                    self.activity_window_fullscreen = False
                    self.fullscreen_btn.config(text="ğŸ—–")
                else:
                    # è¿›å…¥å…¨å±
                    self.activity_window.attributes('-fullscreen', True)
                    self.activity_window_fullscreen = True
                    self.fullscreen_btn.config(text="ğŸ——")
        except Exception as e:
            print(f"åˆ‡æ¢å…¨å±å¤±è´¥: {e}")

    def close_activity_window(self):
        """å…³é—­æ´»åŠ¨è®°å½•çª—å£"""
        try:
            if hasattr(self, 'activity_window') and self.activity_window:
                self.activity_window.destroy()
        except Exception as e:
            print(f"å…³é—­çª—å£å¤±è´¥: {e}")

    def toggle_time_filter(self):
        """åˆ‡æ›æ¯æ—¥æ´»å‹•æ™‚é–“ç¯©é¸é¡¯ç¤ºç‹€æ…‹"""
        if self.time_filter_enabled.get():
            self.time_inputs_frame.pack(side="left")
            # å¦‚æœå•Ÿç”¨è‡ªå‹•æ™‚é–“ç¯„åœï¼Œç¦ç”¨æ™‚é–“è¼¸å…¥
            if self.auto_time_range.get():
                self.start_time_entry.config(state='disabled')
                self.end_time_entry.config(state='disabled')
        else:
            self.time_inputs_frame.pack_forget()
    
    def toggle_auto_time_range(self):
        """åˆ‡æ›æ¯æ—¥æ´»å‹•è‡ªå‹•æ™‚é–“ç¯„åœé¸é …"""
        if self.auto_time_range.get():
            # å•Ÿç”¨è‡ªå‹•æ™‚é–“ç¯„åœæ™‚ï¼Œç¦ç”¨æ‰‹å‹•æ™‚é–“è¼¸å…¥
            self.start_time_entry.config(state='disabled')
            self.end_time_entry.config(state='disabled')
            # å¦‚æœæ™‚é–“ç¯©é¸æœªå•Ÿç”¨ï¼Œè‡ªå‹•å•Ÿç”¨
            if not self.time_filter_enabled.get():
                self.time_filter_enabled.set(True)
                self.toggle_time_filter()
        else:
            # ç¦ç”¨è‡ªå‹•æ™‚é–“ç¯„åœæ™‚ï¼Œå•Ÿç”¨æ‰‹å‹•æ™‚é–“è¼¸å…¥
            if self.time_filter_enabled.get():
                self.start_time_entry.config(state='normal')
                self.end_time_entry.config(state='normal')
    
    def toggle_weekly_time_filter(self):
        """åˆ‡æ›é€±æœŸæ€§æ´»å‹•æ™‚é–“ç¯©é¸é¡¯ç¤ºç‹€æ…‹"""
        if self.weekly_time_filter_enabled.get():
            self.weekly_time_inputs_frame.pack(side="left")
            # å¦‚æœå•Ÿç”¨è‡ªå‹•æ™‚é–“ç¯„åœï¼Œç¦ç”¨æ™‚é–“è¼¸å…¥
            if self.weekly_auto_time_range.get():
                self.weekly_start_time_entry.config(state='disabled')
                self.weekly_end_time_entry.config(state='disabled')
        else:
            self.weekly_time_inputs_frame.pack_forget()
    
    def toggle_weekly_auto_time_range(self):
        """åˆ‡æ›é€±æœŸæ€§æ´»å‹•è‡ªå‹•æ™‚é–“ç¯„åœé¸é …"""
        if self.weekly_auto_time_range.get():
            # å•Ÿç”¨è‡ªå‹•æ™‚é–“ç¯„åœæ™‚ï¼Œç¦ç”¨æ‰‹å‹•æ™‚é–“è¼¸å…¥
            self.weekly_start_time_entry.config(state='disabled')
            self.weekly_end_time_entry.config(state='disabled')
            # å¦‚æœæ™‚é–“ç¯©é¸æœªå•Ÿç”¨ï¼Œè‡ªå‹•å•Ÿç”¨
            if not self.weekly_time_filter_enabled.get():
                self.weekly_time_filter_enabled.set(True)
                self.toggle_weekly_time_filter()
        else:
            # ç¦ç”¨è‡ªå‹•æ™‚é–“ç¯„åœæ™‚ï¼Œå•Ÿç”¨æ‰‹å‹•æ™‚é–“è¼¸å…¥
            if self.weekly_time_filter_enabled.get():
                self.weekly_start_time_entry.config(state='normal')
                self.weekly_end_time_entry.config(state='normal')

    def on_activity_search_change(self, event=None):
        """æ´»åŠ¨è®°å½•æœç´¢åŠŸèƒ½"""
        try:
            search_term = self.activity_search_entry.get().strip().lower()
            
            # æ¸…ç©ºç°æœ‰æ˜¾ç¤º
            for item in self.activity_tree.get_children():
                self.activity_tree.delete(item)
            
            # è·å–å½“å‰é€‰ä¸­çš„æ•°æ®åº“
            current_db = self.get_current_database()
            
            # ç¡®ä¿æ´»åŠ¨è®°å½•å­—å…¸å­˜åœ¨å¹¶åŒ…å«æ‰€æœ‰æ•°æ®åº“
            if not hasattr(self, 'activity_records'):
                self.activity_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': [],
                    'All': []
                }
            
            # æ˜¾ç¤ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰è®°å½•  
            if self.activity_records[current_db]:
                print(f"âœ… æ‰¾åˆ°äº† {len(self.activity_records[current_db])} ä¸ªæ´»åŠ¨è®°å½•")
                for record in self.activity_records[current_db]:
                    # æ„å»ºæœç´¢æ–‡æœ¬
                    searchable_text = ' '.join([
                        record.get('description', ''),
                        record.get('date_from', ''),
                        record.get('date_to', ''),
                        ', '.join(record.get('weekdays', [])),
                        ', '.join(record.get('outlets', [])),
                        ', '.join(record.get('products', []))
                    ]).lower()
                    
                    # å¦‚æœæ²¡æœ‰æœç´¢è¯æˆ–åŒ¹é…æœç´¢è¯ï¼Œæ˜¾ç¤ºè®°å½•
                    if not search_term or search_term in searchable_text:
                        # æ´»å‹•åç¨±
                        activity_name = record.get('description', f"æ´»å‹• {record.get('id', '')}")
                        
                        # æ—¥æœŸæœŸé–“
                        if record.get('type') == 'weekly':
                            weekdays_str = ', '.join(record.get('weekdays', []))
                            date_period = f"{record.get('date_from', '')} - {record.get('date_to', '')}"
                        else:
                            date_period = f"{record.get('date_from', '')} - {record.get('date_to', '')}"
                        
                        # æ˜ŸæœŸç¯©é¸
                        weekdays = record.get('weekdays', [])
                        weekdays_str = ', '.join(weekdays) if weekdays else 'å…¨éƒ¨'
                        
                        # ç²å–åˆ†æçµæœ
                        analysis_result = record.get('analysis_result', {})
                        if analysis_result:
                            total_sales = f"${analysis_result.get('total_amount', 0):,.2f}"
                            total_receipts = f"{analysis_result.get('total_receipts', 0):,}"
                            activity_sales = f"${analysis_result.get('activity_amount', 0):,.2f}"
                            activity_receipts = f"{analysis_result.get('activity_receipts', 0):,}"
                            sales_ratio = f"{analysis_result.get('sales_ratio', 0):.2f}%"
                            receipt_ratio = f"{analysis_result.get('receipt_ratio', 0):.2f}%"
                        else:
                            total_sales = "æœªåˆ†æ"
                            total_receipts = "æœªåˆ†æ"
                            activity_sales = "æœªåˆ†æ"
                            activity_receipts = "æœªåˆ†æ"
                            sales_ratio = "æœªåˆ†æ"
                            receipt_ratio = "æœªåˆ†æ"
                        
                        # æ’å…¥æ•¸æ“šæ™‚åŒ…å«æ´»å‹•IDä½œç‚ºéš±è—çš„ç¬¬ä¸€åˆ—
                        self.activity_tree.insert("", "end", values=(
                            record.get('id', ''),  # æ´»å‹•ID - éš±è—åˆ—
                            activity_name,
                            date_period,
                            weekdays_str,
                            total_sales,
                            total_receipts,
                            activity_sales,
                            activity_receipts,
                            sales_ratio,
                            receipt_ratio
                        ))
            
            print(f"âœ… æ´»åŠ¨è®°å½•æœç´¢å®Œæˆï¼Œæœç´¢è¯: '{search_term}'")
            
        except Exception as e:
            print(f"âŒ æ´»åŠ¨è®°å½•æœç´¢å¤±è´¥: {e}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")

    def clear_activity_search(self):
        """æ¸…é™¤æ´»åŠ¨è®°å½•æœç´¢"""
        try:
            self.activity_search_entry.delete(0, tk.END)
            self.on_activity_search_change()  # é‡æ–°æ˜¾ç¤ºæ‰€æœ‰è®°å½•
        except Exception as e:
            print(f"æ¸…é™¤æœç´¢å¤±è´¥: {e}")

    def breakdown_analysis(self):
        """ç»†é¡¹åˆ†æåŠŸèƒ½ - æŒ‰é—¨å¸‚è¯¦ç»†åˆ†ææ´»åŠ¨ä¸šç»©"""
        try:
            print("ğŸ” ç»†é¡¹åˆ†ææŒ‰é’®è¢«ç‚¹å‡»")
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ´»åŠ¨è®°å½•
            if not hasattr(self, 'activity_tree'):
                tk.messagebox.showwarning("æç¤º", "æ´»åŠ¨è®°å½•è¡¨ä¸å­˜åœ¨")
                return
            
            selection = self.activity_tree.selection()
            if not selection:
                tk.messagebox.showwarning("æç¤º", "è¯·å…ˆåœ¨æ´»åŠ¨è®°å½•åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæ´»åŠ¨è®°å½•ï¼Œç„¶åå†ç‚¹å‡»ç»†é¡¹åˆ†ææŒ‰é’®")
                return
            
            # è·å–é€‰ä¸­çš„æ´»åŠ¨è®°å½•
            item = self.activity_tree.item(selection[0])
            values = item['values']
            activity_id = values[0]
            activity_name = values[1]
            
            print(f"ğŸ“Š é€‰ä¸­çš„æ´»åŠ¨ID: {activity_id}, æ´»åŠ¨åç§°: {activity_name}")
            
            # è·å–æ´»åŠ¨è®°å½•è¯¦æƒ…
            current_db = self.get_current_database()
            records = self.activity_records.get(current_db, [])
            
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ - å½“å‰æ•°æ®åº“: {current_db}")
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ - æ´»åŠ¨ID: {activity_id} (ç±»å‹: {type(activity_id)})")
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ - è®°å½•æ•°é‡: {len(records)}")
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ - å¯ç”¨è®°å½•ID: {[record.get('id') for record in records]}")
            
            selected_record = None
            for record in records:
                record_id = record.get('id')
                print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ - æ¯”è¾ƒè®°å½•ID: {record_id} (ç±»å‹: {type(record_id)}) ä¸ {activity_id} (ç±»å‹: {type(activity_id)})")
                
                # å°è¯•å¤šç§åŒ¹é…æ–¹å¼
                if (record_id == activity_id or 
                    str(record_id) == str(activity_id) or 
                    (str(activity_id).isdigit() and record_id == int(activity_id)) or
                    (str(record_id).isdigit() and int(record_id) == activity_id)):
                    selected_record = record
                    print(f"âœ… æ‰¾åˆ°åŒ¹é…çš„è®°å½•: {record_id}")
                    break
            
            if not selected_record:
                print(f"âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ´»åŠ¨è®°å½•")
                print(f"ğŸ“Š è¯¦ç»†è°ƒè¯•ä¿¡æ¯:")
                print(f"   - æŸ¥æ‰¾çš„æ´»åŠ¨ID: {activity_id}")
                print(f"   - æ´»åŠ¨IDç±»å‹: {type(activity_id)}")
                print(f"   - æ•°æ®åº“: {current_db}")
                print(f"   - è®°å½•æ€»æ•°: {len(records)}")
                for i, record in enumerate(records):
                    print(f"   - è®°å½• {i}: ID={record.get('id')} (ç±»å‹: {type(record.get('id'))}), æè¿°={record.get('description', 'N/A')}")
                
                tk.messagebox.showerror("é”™è¯¯", f"æœªæ‰¾åˆ°æ´»åŠ¨è®°å½•ï¼Œæ´»åŠ¨ID: {activity_id}\n\nè°ƒè¯•ä¿¡æ¯:\næ•°æ®åº“: {current_db}\nè®°å½•æ•°é‡: {len(records)}\nå¯ç”¨ID: {[record.get('id') for record in records]}")
                return
            
            # åˆ›å»ºç»†é¡¹åˆ†æçª—å£
            self.create_breakdown_analysis_window(selected_record)
            
        except Exception as e:
            print(f"âŒ ç»†é¡¹åˆ†æå¤±è´¥: {e}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")
            tk.messagebox.showerror("é”™è¯¯", f"ç»†é¡¹åˆ†æå¤±è´¥: {e}")

    def create_breakdown_analysis_window(self, activity_record):
        """åˆ›å»ºç»†é¡¹åˆ†æçª—å£"""
        try:
            # åˆ›å»ºç»†é¡¹åˆ†æçª—å£
            breakdown_window = tk.Toplevel(self.root)
            activity_name = activity_record.get('description', f"æ´»åŠ¨ {activity_record.get('id', '')}")
            breakdown_window.title(f"ğŸ“ˆ {activity_name} - ç»†é¡¹åˆ†æ / Breakdown Analysis")
            breakdown_window.geometry("1600x900")
            breakdown_window.configure(bg='#FFFFFF')
            breakdown_window.transient(self.root)
            breakdown_window.grab_set()
            
            # è®¾ç½®çª—å£å›¾æ ‡
            try:
                breakdown_window.iconbitmap("SELOGO22 - 01.ico")
            except:
                pass
            
            # åˆ›å»ºæ ‡é¢˜æ 
            title_frame = tk.Frame(breakdown_window, bg='#2c3e50', height=60)
            title_frame.pack(fill="x")
            title_frame.pack_propagate(False)
            
            title_label = tk.Label(title_frame, 
                                 text=f"ğŸ“ˆ {activity_name}", 
                                 font=('Microsoft YaHei UI', 16, 'bold'),
                                 fg='white', bg='#2c3e50')
            title_label.pack(side="left", padx=20, pady=15)
            
            subtitle_label = tk.Label(title_frame, 
                                    text="ç»†é¡¹åˆ†æ / Breakdown Analysis", 
                                    font=('Arial', 11),
                                    fg='#bdc3c7', bg='#2c3e50')
            subtitle_label.pack(side="left", padx=(0, 20), pady=15)
            
            # å…³é—­æŒ‰é’®
            close_btn = tk.Button(title_frame, text="âœ•", 
                                command=breakdown_window.destroy,
                                font=('Arial', 12), bg='#e74c3c', fg='white',
                                relief='flat', bd=0, width=3, height=1,
                                cursor='hand2')
            close_btn.pack(side="right", padx=10, pady=15)
            
            # åˆ›å»ºä¸»å®¹å™¨
            main_container = tk.Frame(breakdown_window, bg='#FFFFFF')
            main_container.pack(fill="both", expand=True, padx=20, pady=20)
            
            # åˆ›å»ºæ ‡ç­¾é¡µ
            notebook = ttk.Notebook(main_container)
            notebook.pack(fill="both", expand=True)
            
            # æ¯æ—¥ç»†é¡¹åˆ†ææ ‡ç­¾é¡µ
            daily_frame = tk.Frame(notebook, bg='#FFFFFF')
            notebook.add(daily_frame, text="ğŸ“… æ¯æ—¥ç»†é¡¹ / Daily Breakdown")
            
            # æ•´ä½“ç»†é¡¹åˆ†ææ ‡ç­¾é¡µ
            overall_frame = tk.Frame(notebook, bg='#FFFFFF')
            notebook.add(overall_frame, text="ğŸ“Š æ•´ä½“ç»†é¡¹ / Overall Breakdown")
            
            # ç”Ÿæˆåˆ†ææ•°æ®
            self.generate_breakdown_analysis_data(activity_record, daily_frame, overall_frame)
            
        except Exception as e:
            print(f"âŒ åˆ›å»ºç»†é¡¹åˆ†æçª—å£å¤±è´¥: {e}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")
            tk.messagebox.showerror("é”™è¯¯", f"åˆ›å»ºç»†é¡¹åˆ†æçª—å£å¤±è´¥: {e}")

    def generate_breakdown_analysis_data(self, activity_record, daily_frame, overall_frame):
        """ç”Ÿæˆç»†é¡¹åˆ†ææ•°æ®å¹¶æ˜¾ç¤ºåœ¨æ ‡ç­¾é¡µä¸­"""
        try:
            # è·å–æ´»åŠ¨ä¿¡æ¯
            activity_id = activity_record.get('id')
            date_from = activity_record.get('date_from')
            date_to = activity_record.get('date_to')
            outlets = activity_record.get('outlets', [])
            products = activity_record.get('products', [])
            activity_type = activity_record.get('type', 'daily')
            weekdays = activity_record.get('weekdays', [])
            
            # è·å–æ—¶é—´ç­›é€‰ä¿¡æ¯
            time_filter_enabled = activity_record.get('time_filter_enabled', False)
            start_time = activity_record.get('start_time')
            end_time = activity_record.get('end_time')
            auto_time_range = activity_record.get('auto_time_range', False)
            
            print(f"ğŸ“Š å¼€å§‹ç”Ÿæˆç»†é¡¹åˆ†ææ•°æ® - æ´»åŠ¨ID: {activity_id}")
            print(f"ğŸ“… æ—¥æœŸèŒƒå›´: {date_from} åˆ° {date_to}")
            print(f"ğŸª é—¨å¸‚: {outlets}")
            print(f"ğŸ›ï¸ äº§å“: {products}")
            print(f"ğŸ“… æ´»åŠ¨ç±»å‹: {activity_type}")
            print(f"ğŸ“… æ˜ŸæœŸ: {weekdays}")
            print(f"â° æ—¶é—´ç­›é€‰å¯ç”¨: {time_filter_enabled}")
            print(f"â° å¼€å§‹æ—¶é—´: {start_time}")
            print(f"â° ç»“æŸæ—¶é—´: {end_time}")
            print(f"â° è‡ªåŠ¨æ—¶é—´èŒƒå›´: {auto_time_range}")
            
            # éªŒè¯æ—¥æœŸæ ¼å¼
            if not date_from or not date_to:
                tk.messagebox.showerror("é”™è¯¯", "æ´»åŠ¨è®°å½•ä¸­ç¼ºå°‘æ—¥æœŸä¿¡æ¯")
                return
            
            # ç¡®ä¿æ—¥æœŸæ ¼å¼æ­£ç¡®
            try:
                from datetime import datetime
                datetime.strptime(date_from, '%Y-%m-%d')
                datetime.strptime(date_to, '%Y-%m-%d')
                print(f"âœ… æ—¥æœŸæ ¼å¼éªŒè¯é€šè¿‡: {date_from} åˆ° {date_to}")
            except ValueError as date_error:
                print(f"âŒ æ—¥æœŸæ ¼å¼é”™è¯¯: {date_error}")
                tk.messagebox.showerror("é”™è¯¯", f"æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®: {date_from} åˆ° {date_to}")
                return
            
            # è¿æ¥æ•°æ®åº“
            current_db = self.get_current_database()
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ - å°è¯•è¿æ¥æ•°æ®åº“: {current_db}")
            
            if not self.connect_to_activity_database(current_db):
                tk.messagebox.showerror("é”™è¯¯", f"æ— æ³•è¿æ¥åˆ°æ•°æ®åº“: {current_db}")
                return
            
            # æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
            if not hasattr(self, 'db_manager') or not self.db_manager.connection:
                tk.messagebox.showerror("é”™è¯¯", "æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿æ¥")
                return
            
            print(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ: {current_db}")
            print(f"ğŸ” è°ƒè¯•ä¿¡æ¯ - å½“å‰æ•°æ®åº“: {self.db_manager.current_database if hasattr(self.db_manager, 'current_database') else 'Unknown'}")
            
            # è·å–é”€å”®æ•°æ®
            from datetime import datetime, timedelta
            start_date = datetime.strptime(date_from, '%Y-%m-%d')
            end_date = datetime.strptime(date_to, '%Y-%m-%d')
            
            # æ„å»ºæŸ¥è¯¢æ¡ä»¶
            query_conditions = []
            params = []
            
            # æ—¥æœŸæ¡ä»¶
            if activity_type == 'weekly' and weekdays:
                # å‘¨æœŸæ€§æ´»åŠ¨ - åªæŸ¥è¯¢æŒ‡å®šçš„æ˜ŸæœŸå‡ 
                weekday_names = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
                weekday_conditions = []
                for weekday in weekdays:
                    if weekday in weekday_names:
                        weekday_conditions.append(f"DATENAME(weekday, c_date) = ?")
                        params.append(weekday)
                
                if weekday_conditions:
                    query_conditions.append(f"({' OR '.join(weekday_conditions)})")
            else:
                # æ¯æ—¥æ´»åŠ¨ - æŸ¥è¯¢æ•´ä¸ªæ—¥æœŸèŒƒå›´
                query_conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}' AND CAST(s.c_date AS DATE) <= '{date_to}'")
            
            # é—¨å¸‚æ¡ä»¶
            if outlets:
                outlet_conditions = " OR ".join([f"store_name = '{outlet}'" for outlet in outlets])
                query_conditions.append(f"({outlet_conditions})")
            
            # äº§å“æ¡ä»¶
            if products:
                product_conditions = " OR ".join([f"item_name = '{product}'" for product in products])
                query_conditions.append(f"({product_conditions})")
            
            # æ„å»ºå®Œæ•´æŸ¥è¯¢
            where_clause = " AND ".join(query_conditions) if query_conditions else "1=1"
            # è·å–ä¸šç»©è®¡ç®—SQL
            performance_sql = self.db_manager.get_performance_calculation_sql()
            
            # æ„å»ºåŸºç¡€WHEREæ¡ä»¶ï¼ˆä¸åŒ…å«äº§å“ç­›é€‰ï¼‰
            base_where_conditions = []
            
            # æ·»åŠ æ—¥æœŸæ¡ä»¶
            base_where_conditions.append(f"CAST(s.c_date AS DATE) >= '{date_from}' AND CAST(s.c_date AS DATE) <= '{date_to}'")
            
            # æ·»åŠ é—¨å¸‚æ¡ä»¶
            if outlets:
                outlet_conditions = " OR ".join([f"store_name = '{outlet}'" for outlet in outlets])
                base_where_conditions.append(f"({outlet_conditions})")
            
            # æ·»åŠ æ˜ŸæœŸæ¡ä»¶ï¼ˆå¦‚æœæ˜¯å‘¨æœŸæ€§æ´»åŠ¨ï¼‰
            if activity_type == 'weekly' and weekdays:
                weekday_conditions = []
                for weekday in weekdays:
                    weekday_conditions.append(f"DATENAME(weekday, c_date) = '{weekday}'")
                if weekday_conditions:
                    base_where_conditions.append(f"({' OR '.join(weekday_conditions)})")
            
            base_where_clause = " AND ".join(base_where_conditions) if base_where_conditions else "1=1"
            
            # æ„å»ºæ´»åŠ¨äº§å“WHEREæ¡ä»¶
            activity_where_conditions = base_where_conditions.copy()
            if products:
                product_conditions = " OR ".join([f"item_name = '{product}'" for product in products])
                activity_where_conditions.append(f"({product_conditions})")
            
            activity_where_clause = " AND ".join(activity_where_conditions) if activity_where_conditions else "1=1"
            
            # æ ¹æ®æ´»åŠ¨è®°å½•çš„å…·ä½“ç­›é€‰æ¡ä»¶å†³å®šæ€»ä¸šç»©çš„è®¡ç®—èŒƒå›´
            # æ£€æŸ¥æ´»åŠ¨è®°å½•ä¸­æ˜¯å¦æœ‰æ—¶é—´ç­›é€‰æˆ–å…¶ä»–ç‰¹æ®Šç­›é€‰æ¡ä»¶
            has_time_filter = activity_record.get('time_filter_enabled', False)
            has_auto_time_range = activity_record.get('auto_time_range', False)
            has_products = bool(products)
            
            # æ ¹æ®ç­›é€‰æ¡ä»¶å†³å®šæ€»ä¸šç»©çš„è®¡ç®—èŒƒå›´
            if has_auto_time_range:
                # è‡ªåŠ¨æ—¶é—´èŒƒå›´ï¼šæ€»ä¸šç»©åº”è¯¥æ˜¯ä»ç¬¬ä¸€å¼ é€‰æ‹©äº§å“å•æ®åˆ°æœ€åä¸€å¼ é€‰æ‹©äº§å“å•æ®ä¹‹é—´çš„æ‰€æœ‰äº§å“ä¸šç»©
                # è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªç‰¹æ®Šçš„æŸ¥è¯¢æ¥æ‰¾åˆ°æ—¶é—´èŒƒå›´ï¼Œç„¶åè®¡ç®—è¯¥èŒƒå›´å†…çš„æ‰€æœ‰ä¸šç»©
                print(f"ğŸ” è‡ªåŠ¨æ—¶é—´èŒƒå›´æ¨¡å¼ï¼šéœ€è¦åŠ¨æ€è®¡ç®—æ—¶é—´èŒƒå›´")
                # æš‚æ—¶ä½¿ç”¨æ´»åŠ¨æŸ¥è¯¢æ¡ä»¶ï¼Œä½†æˆ‘ä»¬éœ€è¦ä¿®æ”¹æŸ¥è¯¢é€»è¾‘
                total_where_clause = activity_where_clause
            elif has_time_filter:
                # æ‰‹åŠ¨æ—¶é—´ç­›é€‰ï¼šæ€»ä¸šç»©åº”è¯¥åœ¨ç›¸åŒçš„æ—¶é—´èŒƒå›´å†…è®¡ç®—
                total_where_clause = activity_where_clause
                print(f"ğŸ” æ‰‹åŠ¨æ—¶é—´ç­›é€‰ï¼šä½¿ç”¨ç­›é€‰èŒƒå›´å†…çš„æ€»ä¸šç»©è®¡ç®—")
            elif has_products:
                # åªæœ‰äº§å“ç­›é€‰ï¼šæ€»ä¸šç»©ä½¿ç”¨åŸºç¡€æ¡ä»¶ï¼ˆæ•´ä¸ªæ—¥æœŸèŒƒå›´çš„æ‰€æœ‰æ•°æ®ï¼‰
                total_where_clause = base_where_clause
                print(f"ğŸ” åªæœ‰äº§å“ç­›é€‰ï¼šä½¿ç”¨æ•´ä¸ªæ—¥æœŸèŒƒå›´çš„æ€»ä¸šç»©è®¡ç®—")
            else:
                # æ²¡æœ‰ç‰¹æ®Šç­›é€‰æ—¶ï¼Œæ€»ä¸šç»©ä½¿ç”¨åŸºç¡€æ¡ä»¶ï¼ˆæ•´ä¸ªæ—¥æœŸèŒƒå›´çš„æ‰€æœ‰æ•°æ®ï¼‰
                total_where_clause = base_where_clause
                print(f"ğŸ” æ²¡æœ‰ç‰¹æ®Šç­›é€‰ï¼šä½¿ç”¨æ•´ä¸ªæ—¥æœŸèŒƒå›´çš„æ€»ä¸šç»©è®¡ç®—")
            
            # ä½¿ç”¨UNION ALLåˆ†åˆ«æŸ¥è¯¢æ€»ä¸šç»©ã€æ´»åŠ¨ä¸šç»©(å«æ•°é‡)å’Œäº§å“å•æ®ä¸šç»©ï¼Œç„¶ååˆå¹¶ç»“æœ
            query = f"""
                WITH total_sales AS (
                    SELECT 
                        store_name,
                        CAST(c_date AS DATE) as c_date,
                        SUM({performance_sql}) as total_amount,
                        COUNT(DISTINCT sales_no) as total_receipts,
                        0 as activity_amount,
                        0 as activity_receipts,
                        0 as product_receipt_amount,
                        0 as activity_qty
                    FROM pos_sales_dtls s
                    WHERE {total_where_clause}
                    AND item_name != 'WASTAGE'
                    GROUP BY store_name, CAST(c_date AS DATE)
                ),
                activity_sales AS (
                    SELECT 
                        store_name,
                        CAST(c_date AS DATE) as c_date,
                        0 as total_amount,
                        0 as total_receipts,
                        SUM({performance_sql}) as activity_amount,
                        COUNT(DISTINCT sales_no) as activity_receipts,
                        0 as product_receipt_amount,
                        SUM(CAST(qty as FLOAT)) as activity_qty
                    FROM pos_sales_dtls s
                    WHERE {activity_where_clause}
                    AND item_name != 'WASTAGE'
                    GROUP BY store_name, CAST(c_date AS DATE)
                ),
                product_receipt_sales AS (
                    SELECT 
                        target_item.store_name,
                        CAST(target_item.c_date AS DATE) as c_date,
                        0 as total_amount,
                        0 as total_receipts,
                        0 as activity_amount,
                        0 as activity_receipts,
                        SUM(receipt_totals.receipt_total) as product_receipt_amount,
                        0 as activity_qty
                    FROM (
                        -- è·å–ç›®æ ‡äº§å“çš„å•æ®ä¿¡æ¯
                        SELECT DISTINCT s.store_name, s.c_date, s.sales_no
                        FROM pos_sales_dtls s WITH (NOLOCK)
                        WHERE s.item_name != 'WASTAGE'
                        AND {activity_where_clause}
                    ) target_item
                    INNER JOIN (
                        -- è®¡ç®—æ¯ä¸ªå•æ®çš„æ€»é‡‘é¢
                        SELECT 
                            s.store_name,
                            s.c_date,
                            s.sales_no,
                            SUM(CAST(s.sub_total as FLOAT) - CAST(ISNULL(s.pro_disc_amt, 0) as FLOAT) - CAST(ISNULL(s.disc_amt, 0) as FLOAT) + CAST(ISNULL(s.svc_amt, 0) as FLOAT) - CASE WHEN s.take_away_item = 'Y' THEN CAST(ISNULL(s.tax_amt, 0) as FLOAT) ELSE 0 END) as receipt_total
                        FROM pos_sales_dtls s WITH (NOLOCK)
                        WHERE s.item_name != 'WASTAGE'
                        GROUP BY s.store_name, s.c_date, s.sales_no
                    ) receipt_totals ON target_item.sales_no = receipt_totals.sales_no AND target_item.store_name = receipt_totals.store_name AND target_item.c_date = receipt_totals.c_date
                    GROUP BY target_item.store_name, CAST(target_item.c_date AS DATE)
                )
                SELECT 
                    COALESCE(t.store_name, COALESCE(a.store_name, p.store_name)) as store_name,
                    COALESCE(t.c_date, COALESCE(a.c_date, p.c_date)) as c_date,
                    COALESCE(t.total_amount, 0) as total_amount,
                    COALESCE(t.total_receipts, 0) as total_receipts,
                    COALESCE(a.activity_amount, 0) as activity_amount,
                    COALESCE(a.activity_receipts, 0) as activity_receipts,
                    COALESCE(p.product_receipt_amount, 0) as product_receipt_amount,
                    COALESCE(a.activity_qty, 0) as activity_qty
                FROM total_sales t
                FULL OUTER JOIN activity_sales a ON t.store_name = a.store_name AND t.c_date = a.c_date
                FULL OUTER JOIN product_receipt_sales p ON COALESCE(t.store_name, a.store_name) = p.store_name 
                    AND COALESCE(t.c_date, a.c_date) = p.c_date
                ORDER BY store_name, c_date
            """
            
            print(f"ğŸ“Š æ‰§è¡ŒæŸ¥è¯¢: {query}")
            print(f"ğŸ“Š æŸ¥è¯¢å‚æ•°: {params}")
            
            # æ‰§è¡ŒæŸ¥è¯¢
            cursor = self.db_manager.connection.cursor()
            try:
                cursor.execute(query)
                results = cursor.fetchall()
                print(f"ğŸ“Š æŸ¥è¯¢ç»“æœæ•°é‡: {len(results)}")
            except Exception as query_error:
                print(f"âŒ æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {query_error}")
                print(f"ğŸ” æŸ¥è¯¢è¯­å¥: {query}")
                print(f"ğŸ” æŸ¥è¯¢å‚æ•°: {params}")
                raise query_error
            
            # å¤„ç†æ•°æ®
            daily_data = {}
            overall_data = {}
            
            for row in results:
                store_name = row[0]
                c_date = row[1]
                total_amount = float(row[2]) if row[2] else 0
                total_receipts = int(row[3]) if row[3] else 0
                activity_amount = float(row[4]) if row[4] else 0
                activity_receipts = int(row[5]) if row[5] else 0
                product_receipt_amount = float(row[6]) if row[6] else 0
                activity_qty = float(row[7]) if len(row) > 7 and row[7] is not None else 0.0
                
                # è®¡ç®—å æ¯”
                sales_ratio = (activity_amount / total_amount * 100) if total_amount > 0 else 0
                receipt_ratio = (activity_receipts / total_receipts * 100) if total_receipts > 0 else 0
                product_receipt_ratio = (product_receipt_amount / total_amount * 100) if total_amount > 0 else 0
                
                # æ¯æ—¥æ•°æ®
                if store_name not in daily_data:
                    daily_data[store_name] = {}
                daily_data[store_name][c_date] = {
                    'total_amount': total_amount,
                    'total_receipts': total_receipts,
                    'activity_amount': activity_amount,
                    'activity_receipts': activity_receipts,
                    'product_receipt_amount': product_receipt_amount,
                    'activity_qty': activity_qty,
                    'sales_ratio': sales_ratio,
                    'receipt_ratio': receipt_ratio,
                    'product_receipt_ratio': product_receipt_ratio
                }
                
                # æ•´ä½“æ•°æ®ç´¯è®¡
                if store_name not in overall_data:
                    overall_data[store_name] = {
                        'total_amount': 0,
                        'total_receipts': 0,
                        'activity_amount': 0,
                        'activity_receipts': 0,
                        'product_receipt_amount': 0,
                        'activity_qty': 0.0,
                        'days_count': 0
                    }
                
                overall_data[store_name]['total_amount'] += total_amount
                overall_data[store_name]['total_receipts'] += total_receipts
                overall_data[store_name]['activity_amount'] += activity_amount
                overall_data[store_name]['activity_receipts'] += activity_receipts
                overall_data[store_name]['product_receipt_amount'] += product_receipt_amount
                overall_data[store_name]['activity_qty'] += activity_qty
                overall_data[store_name]['days_count'] += 1
            
            # è®¡ç®—æ•´ä½“å æ¯”å’Œæ—¥å‡
            for store_name in overall_data:
                data = overall_data[store_name]
                data['sales_ratio'] = (data['activity_amount'] / data['total_amount'] * 100) if data['total_amount'] > 0 else 0
                data['receipt_ratio'] = (data['activity_receipts'] / data['total_receipts'] * 100) if data['total_receipts'] > 0 else 0
                data['product_receipt_ratio'] = (data['product_receipt_amount'] / data['total_amount'] * 100) if data['total_amount'] > 0 else 0
                data['daily_avg_amount'] = data['total_amount'] / data['days_count'] if data['days_count'] > 0 else 0
                data['daily_avg_activity'] = data['activity_amount'] / data['days_count'] if data['days_count'] > 0 else 0
                data['daily_avg_product_receipt'] = data['product_receipt_amount'] / data['days_count'] if data['days_count'] > 0 else 0
            
            # åˆ›å»ºæ¯æ—¥ç»†é¡¹åˆ†æç•Œé¢
            self.create_daily_breakdown_interface(daily_frame, daily_data, activity_record)
            
            # åˆ›å»ºæ•´ä½“ç»†é¡¹åˆ†æç•Œé¢
            self.create_overall_breakdown_interface(overall_frame, overall_data, activity_record)
            
            # ä¿å­˜ç»†é¡¹åˆ†æç»“æœåˆ°æ´»åŠ¨è®°å½•
            self.save_breakdown_results_to_activity_record(activity_record, daily_data, overall_data)
            
        except Exception as e:
            print(f"âŒ ç”Ÿæˆç»†é¡¹åˆ†ææ•°æ®å¤±è´¥: {e}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯: {traceback.format_exc()}")
            tk.messagebox.showerror("é”™è¯¯", f"ç”Ÿæˆç»†é¡¹åˆ†ææ•°æ®å¤±è´¥: {e}")

    def create_daily_breakdown_interface(self, parent_frame, daily_data, activity_record):
        """åˆ›å»ºæ¯æ—¥ç»†é¡¹åˆ†æç•Œé¢"""
        try:
            # æ§åˆ¶é¢æ¿
            control_frame = tk.Frame(parent_frame, bg='#FFFFFF')
            control_frame.pack(fill="x", padx=10, pady=10)
            
            # æœç´¢æ¡†æ¶
            search_frame = tk.Frame(control_frame, bg='#FFFFFF')
            search_frame.pack(side="left", fill="x", expand=True)
            
            tk.Label(search_frame, text="ğŸ” æœç´¢é—¨å¸‚:", font=('Arial', 9), 
                    fg='#2c3e50', bg='#FFFFFF').pack(side="left", padx=(0, 5))
            
            self.daily_search_entry = tk.Entry(search_frame, width=20, font=('Arial', 9))
            self.daily_search_entry.pack(side="left", padx=2)
            
            # æ¸…é™¤æœç´¢æŒ‰é’®
            clear_search_btn = tk.Button(search_frame, text="âŒ", 
                                       command=self.clear_daily_search,
                                       font=('Arial', 8), bg='#e74c3c', fg='white',
                                       relief='flat', bd=0, width=2, height=1,
                                       cursor='hand2')
            clear_search_btn.pack(side="left", padx=2)
            
            # æŒ‰é’®æ¡†æ¶
            button_frame = tk.Frame(control_frame, bg='#FFFFFF')
            button_frame.pack(side="right")
            
            # å¯¼å‡ºæŒ‰é’®
            export_btn = tk.Button(button_frame, text="ğŸ“¤ å¯¼å‡ºExcel / Export Excel", 
                                 command=lambda: self.export_daily_breakdown(daily_data, activity_record),
                                 font=('Arial', 10, 'bold'), bg='#27ae60', fg='white',
                                 relief='flat', bd=0, padx=15, pady=5,
                                 cursor='hand2')
            export_btn.pack(side="left", padx=5)
            
            # ä¿å­˜è®°å½•æŒ‰é’®
            save_btn = tk.Button(button_frame, text="ğŸ’¾ ä¿å­˜è®°å½• / Save Record", 
                               command=lambda: self.save_breakdown_record(daily_data, activity_record, 'daily'),
                               font=('Arial', 10, 'bold'), bg='#3498db', fg='white',
                               relief='flat', bd=0, padx=15, pady=5,
                               cursor='hand2')
            save_btn.pack(side="left", padx=5)
            
            # åˆ›å»ºè¡¨æ ¼æ¡†æ¶
            table_frame = tk.Frame(parent_frame, bg='#FFFFFF')
            table_frame.pack(fill="both", expand=True, padx=10, pady=10)
            
            # åˆ›å»ºè¡¨æ ¼åˆ— - åŠ å…¥æ´»å‹•éŠ·å”®æ•¸é‡
            columns = ['é—¨å¸‚ / Store', 'æ€»ä¸šç»© / Total Sales', 'æ€»å•æ®æ•° / Total Receipts', 
                      'äº§å“å•æ®ä¸šç»© / Product Receipt Performance', 'äº§å“ä¸šç»© / Product Performance', 
                      'äº§å“å•æ®æ•° / Product Receipts', 'æ´»åŠ¨é”€å”®æ•°é‡ / Activity Qty', 'ä¸šç»©å æ¯”% / Sales Ratio%', 'å•æ®å æ¯”% / Receipt Ratio%']
            
            # åˆ›å»ºTreeview
            tree = ttk.Treeview(table_frame, columns=columns, show='headings', height=20)
            
            # è®¾ç½®åˆ—æ ‡é¢˜å’Œå®½åº¦
            column_configs = [
                ('é—¨å¸‚ / Store', 150),
                ('æ€»ä¸šç»© / Total Sales', 120),
                ('æ€»å•æ®æ•° / Total Receipts', 120),
                ('äº§å“å•æ®ä¸šç»© / Product Receipt Performance', 150),
                ('äº§å“ä¸šç»© / Product Performance', 120),
                ('äº§å“å•æ®æ•° / Product Receipts', 120),
                ('æ´»åŠ¨é”€å”®æ•°é‡ / Activity Qty', 120),
                ('ä¸šç»©å æ¯”% / Sales Ratio%', 120),
                ('å•æ®å æ¯”% / Receipt Ratio%', 120)
            ]
            
            for col, width in column_configs:
                tree.heading(col, text=col)
                tree.column(col, width=width, anchor='center')
            
            # å­˜å‚¨treeå¼•ç”¨ç”¨äºæœç´¢
            self.daily_breakdown_tree = tree
            self.daily_breakdown_data = daily_data
            
            # è®¾ç½®æ ·å¼æ ‡ç­¾
            tree.tag_configure("date_header", background="#2c3e50", foreground="white", font=('Arial', 10, 'bold'))
            tree.tag_configure("store_row", background="#f8f9fa", foreground="#2c3e50", font=('Arial', 9))
            tree.tag_configure("date_subtotal", background="#e8f4fd", foreground="#1a365d", font=('Arial', 9, 'bold'))
            tree.tag_configure("separator", background="#ffffff", foreground="#ffffff")
            tree.tag_configure("total", background="#d4edda", foreground="#155724", font=('Arial', 10, 'bold'))
            
            # ç»‘å®šæœç´¢äº‹ä»¶
            self.daily_search_entry.bind('<KeyRelease>', lambda e: self.filter_daily_breakdown())
            
            # æ·»åŠ æ•°æ®
            self.populate_daily_breakdown_tree()
            
            # æ·»åŠ æ»šåŠ¨æ¡
            scrollbar = ttk.Scrollbar(table_frame, orient="vertical", command=tree.yview)
            tree.configure(yscrollcommand=scrollbar.set)
            
            tree.pack(side="left", fill="both", expand=True)
            scrollbar.pack(side="right", fill="y")
            
        except Exception as e:
            print(f"âŒ åˆ›å»ºæ¯æ—¥ç»†é¡¹åˆ†æç•Œé¢å¤±è´¥: {e}")

    def populate_daily_breakdown_tree(self):
        """å¡«å……æ¯æ—¥ç»†é¡¹åˆ†æè¡¨æ ¼æ•°æ® - æ˜¾ç¤ºæ¯æ—¥è¯¦ç»†æ•°æ®"""
        try:
            if not hasattr(self, 'daily_breakdown_tree'):
                return
                
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.daily_breakdown_tree.get_children():
                self.daily_breakdown_tree.delete(item)
            
            # è·å–æœç´¢å…³é”®è¯
            search_text = ""
            if hasattr(self, 'daily_search_entry'):
                search_text = self.daily_search_entry.get().lower()
            
            # è®¡ç®—æ€»è®¡
            totals = {
                'total_amount': 0,
                'total_receipts': 0,
                'product_receipt_amount': 0,
                'activity_amount': 0,
                'activity_receipts': 0
            }
            
            # è®¡ç®—æ€»å¤©æ•°ç”¨äºæ—¥å‡è®¡ç®—
            total_days = 0
            all_dates = set()
            for store_name, store_data in self.daily_breakdown_data.items():
                for date in store_data.keys():
                    all_dates.add(date)
            total_days = len(all_dates) if all_dates else 1
            
            # æ·»åŠ æ•°æ® - æŒ‰æ—¥æœŸåˆ†ç»„ï¼Œç„¶åæŒ‰é—¨å¸‚æ˜¾ç¤º
            for date in sorted(all_dates):
                # æ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºè¿™ä¸ªæ—¥æœŸï¼ˆæœç´¢è¿‡æ»¤ï¼‰
                date_should_show = not search_text or search_text in date.lower()
                
                # æŒ‰é—¨å¸‚æ˜¾ç¤ºè¯¥æ—¥æœŸçš„æ•°æ®
                stores_with_data = []
                for store_name, store_data in self.daily_breakdown_data.items():
                    if date in store_data:
                        stores_with_data.append((store_name, store_data[date]))
                
                # æŒ‰é—¨å¸‚åç§°æ’åº
                stores_with_data.sort(key=lambda x: x[0])
                
                # æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„é—¨å¸‚æ•°æ®
                matching_stores = []
                if search_text:
                    matching_stores = [store for store, data in stores_with_data if search_text in store.lower()]
                else:
                    matching_stores = [store for store, data in stores_with_data]
                
                # å¦‚æœæ²¡æœ‰åŒ¹é…çš„é—¨å¸‚ä¸”æ²¡æœ‰æœç´¢ï¼Œæˆ–è€…æœ‰æœç´¢ä½†æ²¡æœ‰åŒ¹é…çš„é—¨å¸‚ï¼Œè·³è¿‡è¿™ä¸ªæ—¥æœŸ
                if not matching_stores and (search_text or not date_should_show):
                    continue
                
                # æ·»åŠ æ—¥æœŸæ ‡é¢˜è¡Œ
                date_header = self.daily_breakdown_tree.insert("", "end", values=[
                    f"ğŸ“… {date}",
                    "", "", "", "", "", "", ""
                ], tags=("date_header",))
                
                # è®¡ç®—è¯¥æ—¥æœŸçš„æ€»è®¡æ•°æ®
                date_totals = {
                    'total_amount': 0,
                    'total_receipts': 0,
                    'product_receipt_amount': 0,
                    'activity_amount': 0,
                    'activity_receipts': 0,
                    'activity_qty': 0.0
                }
                
                for store_name, data in stores_with_data:
                    # å¦‚æœæœç´¢ä¸”ä¸åŒ¹é…ï¼Œè·³è¿‡
                    if search_text and search_text not in store_name.lower():
                        continue
                # è®¡ç®—å æ¯”
                    sales_ratio = (data['activity_amount'] / data['total_amount'] * 100) if data['total_amount'] > 0 else 0
                    receipt_ratio = (data['activity_receipts'] / data['total_receipts'] * 100) if data['total_receipts'] > 0 else 0
                
                    # æ ¹æ®æ—¥å‡å¼€å…³å†³å®šæ˜¾ç¤ºæ ¼å¼
                    if self.show_daily_average.get():
                        # æ˜¾ç¤ºæ—¥å‡æ•°æ®
                        row_data = [
                            f"  â””â”€ {store_name}",
                            f"${data['total_amount'] / total_days:,.2f}",
                            f"{data['total_receipts'] / total_days:,.0f}",
                            f"${data['product_receipt_amount'] / total_days:,.2f}",
                            f"${data['activity_amount'] / total_days:,.2f}",
                            f"{data.get('activity_qty', 0.0) / total_days:,.2f}",
                            f"{data['activity_receipts'] / total_days:,.0f}",
                            f"{sales_ratio:.2f}%",
                            f"{receipt_ratio:.2f}%"
                        ]
                    else:
                        # æ˜¾ç¤ºå®é™…æ•°æ®
                        row_data = [
                            f"  â””â”€ {store_name}",
                            f"${data['total_amount']:,.2f}",
                            f"{data['total_receipts']:,}",
                            f"${data['product_receipt_amount']:,.2f}",
                            f"${data['activity_amount']:,.2f}",
                            f"{data.get('activity_qty', 0.0):,.2f}",
                            f"{data['activity_receipts']:,}",
                            f"{sales_ratio:.2f}%",
                            f"{receipt_ratio:.2f}%"
                        ]
                
                    self.daily_breakdown_tree.insert("", "end", values=row_data, tags=("store_row",))
                    
                    # ç´¯è®¡è¯¥æ—¥æœŸçš„æ€»è®¡
                    date_totals['total_amount'] += data['total_amount']
                    date_totals['total_receipts'] += data['total_receipts']
                    date_totals['product_receipt_amount'] += data['product_receipt_amount']
                    date_totals['activity_amount'] += data['activity_amount']
                    date_totals['activity_receipts'] += data['activity_receipts']
                    date_totals['activity_qty'] += data.get('activity_qty', 0.0)
                
                # æ·»åŠ è¯¥æ—¥æœŸçš„å°è®¡è¡Œ
                date_sales_ratio = (date_totals['activity_amount'] / date_totals['total_amount'] * 100) if date_totals['total_amount'] > 0 else 0
                date_receipt_ratio = (date_totals['activity_receipts'] / date_totals['total_receipts'] * 100) if date_totals['total_receipts'] > 0 else 0
                
                if self.show_daily_average.get():
                    # æ˜¾ç¤ºæ—¥å‡å°è®¡
                    date_subtotal = [
                        f"  ğŸ“Š {date} å°è®¡ (æ—¥å‡)",
                        f"${date_totals['total_amount'] / total_days:,.2f}",
                        f"{date_totals['total_receipts'] / total_days:,.0f}",
                        f"${date_totals['product_receipt_amount'] / total_days:,.2f}",
                        f"${date_totals['activity_amount'] / total_days:,.2f}",
                        f"{date_totals['activity_qty'] / total_days:,.2f}",
                        f"{date_totals['activity_receipts'] / total_days:,.0f}",
                        f"{date_sales_ratio:.2f}%",
                        f"{date_receipt_ratio:.2f}%"
                    ]
                else:
                    # æ˜¾ç¤ºå®é™…å°è®¡
                    date_subtotal = [
                        f"  ğŸ“Š {date} å°è®¡",
                        f"${date_totals['total_amount']:,.2f}",
                        f"{date_totals['total_receipts']:,}",
                        f"${date_totals['product_receipt_amount']:,.2f}",
                        f"${date_totals['activity_amount']:,.2f}",
                        f"{date_totals['activity_qty']:,.2f}",
                        f"{date_totals['activity_receipts']:,}",
                        f"{date_sales_ratio:.2f}%",
                        f"{date_receipt_ratio:.2f}%"
                    ]
                
                self.daily_breakdown_tree.insert("", "end", values=date_subtotal, tags=("date_subtotal",))
                
                # æ·»åŠ ç©ºè¡Œåˆ†éš”
                self.daily_breakdown_tree.insert("", "end", values=["", "", "", "", "", "", "", "", ""], tags=("separator",))
                
                # ç´¯è®¡æ€»è®¡
                for key in totals:
                    totals[key] += date_totals[key]
            
            # æ·»åŠ æ€»è®¡è¡Œ
            if not search_text:  # åªåœ¨æ²¡æœ‰æœç´¢æ—¶æ˜¾ç¤ºæ€»è®¡
                total_sales_ratio = (totals['activity_amount'] / totals['total_amount'] * 100) if totals['total_amount'] > 0 else 0
                total_receipt_ratio = (totals['activity_receipts'] / totals['total_receipts'] * 100) if totals['total_receipts'] > 0 else 0
                
                if self.show_daily_average.get():
                    # æ˜¾ç¤ºæ—¥å‡æ€»è®¡
                    total_row = [
                        "æ€»è®¡ (æ—¥å‡)",
                        f"${totals['total_amount'] / total_days:,.2f}",
                        f"{totals['total_receipts'] / total_days:,.0f}",
                        f"${totals['product_receipt_amount'] / total_days:,.2f}",
                        f"${totals['activity_amount'] / total_days:,.2f}",
                        f"{totals.get('activity_qty', 0.0) / total_days:,.2f}",
                        f"{totals['activity_receipts'] / total_days:,.0f}",
                        f"{total_sales_ratio:.2f}%",
                        f"{total_receipt_ratio:.2f}%"
                    ]
                else:
                    # æ˜¾ç¤ºå®é™…æ€»è®¡
                    total_row = [
                    "æ€»è®¡ / Total",
                    f"${totals['total_amount']:,.2f}",
                    f"{totals['total_receipts']:,}",
                    f"${totals['product_receipt_amount']:,.2f}",
                    f"${totals['activity_amount']:,.2f}",
                    f"{totals.get('activity_qty', 0.0):,.2f}",
                    f"{totals['activity_receipts']:,}",
                    f"{total_sales_ratio:.2f}%",
                    f"{total_receipt_ratio:.2f}%"
                ]
                
                # æ’å…¥æ€»è®¡è¡Œï¼Œä½¿ç”¨ç‰¹æ®Šæ ‡ç­¾
                total_item = self.daily_breakdown_tree.insert("", "end", values=total_row, tags=('total',))
                self.daily_breakdown_tree.tag_configure('total', background='#e8f4fd', font=('Arial', 9, 'bold'))
                
        except Exception as e:
            print(f"âŒ å¡«å……æ¯æ—¥ç»†é¡¹åˆ†æè¡¨æ ¼å¤±è´¥: {e}")

    def filter_daily_breakdown(self):
        """è¿‡æ»¤æ¯æ—¥ç»†é¡¹åˆ†ææ•°æ®"""
        try:
            self.populate_daily_breakdown_tree()
        except Exception as e:
            print(f"âŒ è¿‡æ»¤æ¯æ—¥ç»†é¡¹åˆ†æå¤±è´¥: {e}")

    def clear_daily_search(self):
        """æ¸…é™¤æ¯æ—¥ç»†é¡¹åˆ†ææœç´¢"""
        try:
            if hasattr(self, 'daily_search_entry'):
                self.daily_search_entry.delete(0, 'end')
                self.populate_daily_breakdown_tree()
        except Exception as e:
            print(f"âŒ æ¸…é™¤æ¯æ—¥ç»†é¡¹åˆ†ææœç´¢å¤±è´¥: {e}")

    def create_overall_breakdown_interface(self, parent_frame, overall_data, activity_record):
        """åˆ›å»ºæ•´ä½“ç»†é¡¹åˆ†æç•Œé¢"""
        try:
            # æ§åˆ¶é¢æ¿
            control_frame = tk.Frame(parent_frame, bg='#FFFFFF')
            control_frame.pack(fill="x", padx=10, pady=10)
            
            # æœç´¢æ¡†æ¶
            search_frame = tk.Frame(control_frame, bg='#FFFFFF')
            search_frame.pack(side="left", fill="x", expand=True)
            
            tk.Label(search_frame, text="ğŸ” æœç´¢é—¨å¸‚:", font=('Arial', 9), 
                    fg='#2c3e50', bg='#FFFFFF').pack(side="left", padx=(0, 5))
            
            self.overall_search_entry = tk.Entry(search_frame, width=20, font=('Arial', 9))
            self.overall_search_entry.pack(side="left", padx=2)
            
            # æ¸…é™¤æœç´¢æŒ‰é’®
            clear_search_btn = tk.Button(search_frame, text="âŒ", 
                                       command=self.clear_overall_search,
                                       font=('Arial', 8), bg='#e74c3c', fg='white',
                                       relief='flat', bd=0, width=2, height=1,
                                       cursor='hand2')
            clear_search_btn.pack(side="left", padx=2)
            
            # æŒ‰é’®æ¡†æ¶
            button_frame = tk.Frame(control_frame, bg='#FFFFFF')
            button_frame.pack(side="right")
            
            # å¯¼å‡ºæŒ‰é’®
            export_btn = tk.Button(button_frame, text="ğŸ“¤ å¯¼å‡ºExcel / Export Excel", 
                                 command=lambda: self.export_overall_breakdown(overall_data, activity_record),
                                 font=('Arial', 10, 'bold'), bg='#27ae60', fg='white',
                                 relief='flat', bd=0, padx=15, pady=5,
                                 cursor='hand2')
            export_btn.pack(side="left", padx=5)
            
            # ä¿å­˜è®°å½•æŒ‰é’®
            save_btn = tk.Button(button_frame, text="ğŸ’¾ ä¿å­˜è®°å½• / Save Record", 
                               command=lambda: self.save_breakdown_record(overall_data, activity_record, 'overall'),
                               font=('Arial', 10, 'bold'), bg='#3498db', fg='white',
                               relief='flat', bd=0, padx=15, pady=5,
                               cursor='hand2')
            save_btn.pack(side="left", padx=5)
            
            # æ—¥å‡åŠŸèƒ½æŒ‰é’®
            daily_avg_btn = tk.Button(button_frame, text="ğŸ“Š æ˜¾ç¤ºæ—¥å‡ / Show Daily Average", 
                                    command=lambda: self.toggle_breakdown_daily_average(),
                                    font=('Arial', 10, 'bold'), bg='#e67e22', fg='white',
                                    relief='flat', bd=0, padx=15, pady=5,
                                    cursor='hand2')
            daily_avg_btn.pack(side="left", padx=5)
            
            # åˆ›å»ºè¡¨æ ¼æ¡†æ¶
            table_frame = tk.Frame(parent_frame, bg='#FFFFFF')
            table_frame.pack(fill="both", expand=True, padx=10, pady=10)
            
            # åˆ›å»ºè¡¨æ ¼åˆ—
            columns = ['é—¨å¸‚ / Store', 'æ€»ä¸šç»© / Total Sales', 'æ€»å•æ®æ•° / Total Receipts', 
                      'æ´»åŠ¨ä¸šç»© / Activity Sales', 'æ´»åŠ¨é”€å”®æ•°é‡ / Activity Qty', 'æ´»åŠ¨å•æ®æ•° / Activity Receipts', 
                      'ä¸šç»©å æ¯”% / Sales Ratio%', 'å•æ®å æ¯”% / Receipt Ratio%']
            
            # åˆ›å»ºTreeview
            tree = ttk.Treeview(table_frame, columns=columns, show='headings', height=20)
            
            # è®¾ç½®åˆ—æ ‡é¢˜å’Œå®½åº¦
            column_configs = [
                ('é—¨å¸‚ / Store', 150),
                ('æ€»ä¸šç»© / Total Sales', 120),
                ('æ€»å•æ®æ•° / Total Receipts', 120),
                ('æ´»åŠ¨ä¸šç»© / Activity Sales', 120),
                ('æ´»åŠ¨é”€å”®æ•°é‡ / Activity Qty', 120),
                ('æ´»åŠ¨å•æ®æ•° / Activity Receipts', 120),
                ('ä¸šç»©å æ¯”% / Sales Ratio%', 120),
                ('å•æ®å æ¯”% / Receipt Ratio%', 120)
            ]
            
            for col, width in column_configs:
                tree.heading(col, text=col)
                tree.column(col, width=width, anchor='center')
            
            # å­˜å‚¨treeå¼•ç”¨ç”¨äºæœç´¢
            self.overall_breakdown_tree = tree
            self.overall_breakdown_data = overall_data
            
            # ç»‘å®šæœç´¢äº‹ä»¶
            self.overall_search_entry.bind('<KeyRelease>', lambda e: self.filter_overall_breakdown())
            
            # æ·»åŠ æ•°æ®
            self.populate_overall_breakdown_tree()
            
            # æ·»åŠ æ»šåŠ¨æ¡
            scrollbar = ttk.Scrollbar(table_frame, orient="vertical", command=tree.yview)
            tree.configure(yscrollcommand=scrollbar.set)
            
            tree.pack(side="left", fill="both", expand=True)
            scrollbar.pack(side="right", fill="y")
            
            # å­˜å‚¨treeå¼•ç”¨ä»¥ä¾¿åç»­ä½¿ç”¨
            parent_frame.overall_tree = tree
            parent_frame.overall_data = overall_data
            
        except Exception as e:
            print(f"âŒ åˆ›å»ºæ•´ä½“ç»†é¡¹åˆ†æç•Œé¢å¤±è´¥: {e}")

    def populate_overall_breakdown_tree(self):
        """å¡«å……æ•´ä½“ç»†é¡¹åˆ†æè¡¨æ ¼æ•°æ®"""
        try:
            if not hasattr(self, 'overall_breakdown_tree'):
                return
                
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.overall_breakdown_tree.get_children():
                self.overall_breakdown_tree.delete(item)
            
            # è·å–æœç´¢å…³é”®è¯
            search_text = ""
            if hasattr(self, 'overall_search_entry'):
                search_text = self.overall_search_entry.get().lower()
            
            # è®¡ç®—æ€»è®¡
            totals = {
                'total_amount': 0,
                'total_receipts': 0,
                'activity_amount': 0,
                'activity_receipts': 0,
                'activity_qty': 0.0
            }
            
            # æ·»åŠ æ•°æ®
            for store_name in sorted(self.overall_breakdown_data.keys()):
                # æœç´¢è¿‡æ»¤
                if search_text and search_text not in store_name.lower():
                    continue
                    
                data = self.overall_breakdown_data[store_name]
                row_data = [
                    store_name,
                    f"${data['total_amount']:,.2f}",
                    f"{data['total_receipts']:,}",
                    f"${data['activity_amount']:,.2f}",
                    f"{data.get('activity_qty', 0.0):,.2f}",
                    f"{data['activity_receipts']:,}",
                    f"{data['sales_ratio']:.2f}%",
                    f"{data['receipt_ratio']:.2f}%"
                ]
                self.overall_breakdown_tree.insert("", "end", values=row_data)
                
                # ç´¯è®¡æ€»è®¡
                totals['total_amount'] += data['total_amount']
                totals['total_receipts'] += data['total_receipts']
                totals['activity_amount'] += data['activity_amount']
                totals['activity_qty'] += data.get('activity_qty', 0.0)
                totals['activity_receipts'] += data['activity_receipts']
            
            # æ·»åŠ æ€»è®¡è¡Œ
            if not search_text:  # åªåœ¨æ²¡æœ‰æœç´¢æ—¶æ˜¾ç¤ºæ€»è®¡
                total_sales_ratio = (totals['activity_amount'] / totals['total_amount'] * 100) if totals['total_amount'] > 0 else 0
                total_receipt_ratio = (totals['activity_receipts'] / totals['total_receipts'] * 100) if totals['total_receipts'] > 0 else 0
                
                total_row = [
                    "æ€»è®¡ / Total",
                    f"${totals['total_amount']:,.2f}",
                    f"{totals['total_receipts']:,}",
                    f"${totals['activity_amount']:,.2f}",
                    f"{totals.get('activity_qty', 0.0):,.2f}",
                    f"{totals['activity_receipts']:,}",
                    f"{total_sales_ratio:.2f}%",
                    f"{total_receipt_ratio:.2f}%"
                ]
                
                # æ’å…¥æ€»è®¡è¡Œï¼Œä½¿ç”¨ç‰¹æ®Šæ ‡ç­¾
                total_item = self.overall_breakdown_tree.insert("", "end", values=total_row, tags=('total',))
                self.overall_breakdown_tree.tag_configure('total', background='#e8f4fd', font=('Arial', 9, 'bold'))
                
        except Exception as e:
            print(f"âŒ å¡«å……æ•´ä½“ç»†é¡¹åˆ†æè¡¨æ ¼å¤±è´¥: {e}")

    def filter_overall_breakdown(self):
        """è¿‡æ»¤æ•´ä½“ç»†é¡¹åˆ†ææ•°æ®"""
        try:
            self.populate_overall_breakdown_tree()
        except Exception as e:
            print(f"âŒ è¿‡æ»¤æ•´ä½“ç»†é¡¹åˆ†æå¤±è´¥: {e}")

    def clear_overall_search(self):
        """æ¸…é™¤æ•´ä½“ç»†é¡¹åˆ†ææœç´¢"""
        try:
            if hasattr(self, 'overall_search_entry'):
                self.overall_search_entry.delete(0, 'end')
                self.populate_overall_breakdown_tree()
        except Exception as e:
            print(f"âŒ æ¸…é™¤æ•´ä½“ç»†é¡¹åˆ†ææœç´¢å¤±è´¥: {e}")

    def export_daily_breakdown(self, daily_data, activity_record):
        """å¯¼å‡ºæ¯æ—¥ç»†é¡¹åˆ†æåˆ°Excel"""
        try:
            import pandas as pd
            from datetime import datetime
            
            # åˆ›å»ºå¯¼å‡ºæ•°æ®
            export_data = []
            
            # è·å–æ‰€æœ‰æ—¥æœŸ
            all_dates = set()
            for store_data in daily_data.values():
                all_dates.update(store_data.keys())
            all_dates = sorted(list(all_dates))
            
            # ä¸ºæ¯ä¸ªé—¨å¸‚åˆ›å»ºè¡Œæ•°æ®
            for store_name in sorted(daily_data.keys()):
                store_data = daily_data[store_name]
                row_data = {'é—¨å¸‚ / Store': store_name}
                
                for date in all_dates:
                    if date in store_data:
                        data = store_data[date]
                        row_data[f'{date}_æ€»ä¸šç»©'] = data['total_amount']
                        row_data[f'{date}_æ€»å•æ®æ•°'] = data['total_receipts']
                        row_data[f'{date}_æ´»åŠ¨ä¸šç»©'] = data['activity_amount']
                        row_data[f'{date}_æ´»åŠ¨å•æ®æ•°'] = data['activity_receipts']
                        row_data[f'{date}_ä¸šç»©å æ¯”%'] = data['sales_ratio']
                        row_data[f'{date}_å•æ®å æ¯”%'] = data['receipt_ratio']
                    else:
                        row_data[f'{date}_æ€»ä¸šç»©'] = 0
                        row_data[f'{date}_æ€»å•æ®æ•°'] = 0
                        row_data[f'{date}_æ´»åŠ¨ä¸šç»©'] = 0
                        row_data[f'{date}_æ´»åŠ¨å•æ®æ•°'] = 0
                        row_data[f'{date}_ä¸šç»©å æ¯”%'] = 0
                        row_data[f'{date}_å•æ®å æ¯”%'] = 0
                
                export_data.append(row_data)
            
            # åˆ›å»ºDataFrame
            df = pd.DataFrame(export_data)
            
            # ç”Ÿæˆæ–‡ä»¶å
            activity_name = activity_record.get('description', f"æ´»åŠ¨_{activity_record.get('id', '')}")
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"exports/daily_breakdown_{activity_name}_{timestamp}.xlsx"
            
            # ç¡®ä¿exportsç›®å½•å­˜åœ¨
            import os
            os.makedirs("exports", exist_ok=True)
            
            # å¯¼å‡ºåˆ°Excel
            df.to_excel(filename, index=False, engine='openpyxl')
            
            tk.messagebox.showinfo("å¯¼å‡ºæˆåŠŸ", f"æ¯æ—¥ç»†é¡¹åˆ†æå·²å¯¼å‡ºåˆ°:\n{filename}")
            
        except Exception as e:
            print(f"âŒ å¯¼å‡ºæ¯æ—¥ç»†é¡¹åˆ†æå¤±è´¥: {e}")
            tk.messagebox.showerror("å¯¼å‡ºå¤±è´¥", f"å¯¼å‡ºæ¯æ—¥ç»†é¡¹åˆ†æå¤±è´¥: {e}")

    def export_overall_breakdown(self, overall_data, activity_record):
        """å¯¼å‡ºæ•´ä½“ç»†é¡¹åˆ†æåˆ°Excel"""
        try:
            import pandas as pd
            from datetime import datetime
            
            # åˆ›å»ºå¯¼å‡ºæ•°æ®
            export_data = []
            
            for store_name in sorted(overall_data.keys()):
                data = overall_data[store_name]
                row_data = {
                    'é—¨å¸‚ / Store': store_name,
                    'æ€»ä¸šç»© / Total Sales': data['total_amount'],
                    'æ€»å•æ®æ•° / Total Receipts': data['total_receipts'],
                    'æ´»åŠ¨ä¸šç»© / Activity Sales': data['activity_amount'],
                    'æ´»åŠ¨é”€å”®æ•°é‡ / Activity Qty': data.get('activity_qty', 0.0),
                    'æ´»åŠ¨å•æ®æ•° / Activity Receipts': data['activity_receipts'],
                    'ä¸šç»©å æ¯”% / Sales Ratio%': data['sales_ratio'],
                    'å•æ®å æ¯”% / Receipt Ratio%': data['receipt_ratio'],
                    'æ—¥å‡æ€»ä¸šç»© / Daily Avg Total': data['daily_avg_amount'],
                    'æ—¥å‡æ´»åŠ¨ä¸šç»© / Daily Avg Activity': data['daily_avg_activity'],
                    'æ´»åŠ¨å¤©æ•° / Activity Days': data['days_count']
                }
                export_data.append(row_data)
            
            # åˆ›å»ºDataFrame
            df = pd.DataFrame(export_data)
            
            # ç”Ÿæˆæ–‡ä»¶å
            activity_name = activity_record.get('description', f"æ´»åŠ¨_{activity_record.get('id', '')}")
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"exports/overall_breakdown_{activity_name}_{timestamp}.xlsx"
            
            # ç¡®ä¿exportsç›®å½•å­˜åœ¨
            import os
            os.makedirs("exports", exist_ok=True)
            
            # å¯¼å‡ºåˆ°Excel
            df.to_excel(filename, index=False, engine='openpyxl')
            
            tk.messagebox.showinfo("å¯¼å‡ºæˆåŠŸ", f"æ•´ä½“ç»†é¡¹åˆ†æå·²å¯¼å‡ºåˆ°:\n{filename}")
            
        except Exception as e:
            print(f"âŒ å¯¼å‡ºæ•´ä½“ç»†é¡¹åˆ†æå¤±è´¥: {e}")
            tk.messagebox.showerror("å¯¼å‡ºå¤±è´¥", f"å¯¼å‡ºæ•´ä½“ç»†é¡¹åˆ†æå¤±è´¥: {e}")

    def save_breakdown_record(self, breakdown_data, activity_record, breakdown_type):
        """ä¿å­˜ç»†é¡¹åˆ†æè®°å½•"""
        try:
            from datetime import datetime
            import json
            
            # åˆ›å»ºè®°å½•æ•°æ®
            record_data = {
                'activity_id': activity_record.get('id'),
                'activity_name': activity_record.get('description'),
                'breakdown_type': breakdown_type,  # 'daily' or 'overall'
                'breakdown_data': breakdown_data,
                'created_at': datetime.now().isoformat(),
                'date_from': activity_record.get('date_from'),
                'date_to': activity_record.get('date_to'),
                'outlets': activity_record.get('outlets', []),
                'products': activity_record.get('products', [])
            }
            
            # ç¡®ä¿breakdown_recordsç›®å½•å­˜åœ¨
            import os
            os.makedirs("breakdown_records", exist_ok=True)
            
            # ç”Ÿæˆæ–‡ä»¶å
            activity_name = activity_record.get('description', f"æ´»åŠ¨_{activity_record.get('id', '')}")
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"breakdown_records/{breakdown_type}_breakdown_{activity_name}_{timestamp}.json"
            
            # ä¿å­˜åˆ°JSONæ–‡ä»¶
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(record_data, f, ensure_ascii=False, indent=2)
            
            tk.messagebox.showinfo("ä¿å­˜æˆåŠŸ", f"ç»†é¡¹åˆ†æè®°å½•å·²ä¿å­˜åˆ°:\n{filename}")
            
        except Exception as e:
            print(f"âŒ ä¿å­˜ç»†é¡¹åˆ†æè®°å½•å¤±è´¥: {e}")
            tk.messagebox.showerror("ä¿å­˜å¤±è´¥", f"ä¿å­˜ç»†é¡¹åˆ†æè®°å½•å¤±è´¥: {e}")

    def toggle_breakdown_daily_average(self):
        """åˆ‡æ¢æ˜¾ç¤ºæ—¥å‡æ•°æ®"""
        try:
            print("ğŸ“Š åˆ‡æ¢æ—¥å‡æ˜¾ç¤ºåŠŸèƒ½")
            
            # åˆ‡æ¢æ—¥å‡æ˜¾ç¤ºçŠ¶æ€
            self.show_daily_average.set(not self.show_daily_average.get())
            
            if self.show_daily_average.get():
                self.log_message("âœ“ å·²å¯ç”¨æ—¥å‡æ˜¾ç¤º")
            else:
                self.log_message("â„¹ å·²ç¦ç”¨æ—¥å‡æ˜¾ç¤º")
            
            # é‡æ–°å¡«å……æ•´ä½“ç»†é¡¹åˆ†æè¡¨æ ¼
            if hasattr(self, 'overall_breakdown_tree') and hasattr(self, 'overall_breakdown_data'):
                self.populate_overall_breakdown_tree()
            
            # é‡æ–°å¡«å……æ¯æ—¥ç»†é¡¹åˆ†æè¡¨æ ¼
            if hasattr(self, 'daily_breakdown_tree') and hasattr(self, 'daily_breakdown_data'):
                self.populate_daily_breakdown_tree()
            
        except Exception as e:
            print(f"âŒ åˆ‡æ¢æ—¥å‡æ˜¾ç¤ºå¤±è´¥: {e}")

    def save_breakdown_results_to_activity_record(self, activity_record, daily_data, overall_data):
        """ä¿å­˜ç»†é¡¹åˆ†æç»“æœåˆ°æ´»åŠ¨è®°å½•"""
        try:
            from datetime import datetime
            
            # è·å–æ´»åŠ¨è®°å½•ID
            activity_id = activity_record.get('id')
            current_db = self.get_current_database()
            
            # æ‰¾åˆ°å¯¹åº”çš„æ´»åŠ¨è®°å½•
            records = self.activity_records.get(current_db, [])
            for record in records:
                if record.get('id') == activity_id:
                    # ä¿å­˜ç»†é¡¹åˆ†æç»“æœ
                    record['breakdown_analysis'] = {
                        'daily_data': daily_data,
                        'overall_data': overall_data,
                        'analysis_time': datetime.now().isoformat(),
                        'analysis_type': 'breakdown'
                    }
                    
                    # æ›´æ–°æ´»åŠ¨è®°å½•
                    self.activity_records[current_db] = records
                    
                    # ä¿å­˜åˆ°æ–‡ä»¶
                    self.save_activity_records()
                    
                    print(f"âœ… å·²ä¿å­˜ç»†é¡¹åˆ†æç»“æœåˆ°æ´»åŠ¨è®°å½• {activity_id}")
                    break
            
        except Exception as e:
            print(f"âŒ ä¿å­˜ç»†é¡¹åˆ†æç»“æœå¤±è´¥: {e}")

    def setup_activity_right_panel(self, right_frame):
        """è®¾ç½®æ´»åŠ¨è®°å½•å³ä¾§é¢æ¿ - å¼ºåŒ–ç‰ˆæœ¬ç¡®ä¿å‡æœŸçª—å£å§‹ç»ˆå¯è§"""
        try:
            print("ğŸ”§ å¼€å§‹è®¾ç½®å³ä¾§å‡æœŸé¢æ¿...")
            
            # å‡æœŸä¿¡æ¯åŒºåŸŸ
            holiday_frame = tk.LabelFrame(right_frame, text="ğŸ“… å‡æœŸä¿¡æ¯ / Holiday Information")
            holiday_frame.pack(fill="x", pady=(0, 10))
            
            # å½“å‰æœˆä»½å‡æœŸæ˜¾ç¤º
            self.holiday_info_text = tk.Text(holiday_frame, height=8, width=45, wrap=tk.WORD)
            self.holiday_info_text.pack(fill="both", expand=True)
            
            # æ·»åŠ å‡æœŸæŒ‰é’®
            add_holiday_btn = ttk.Button(holiday_frame, text="â• æ·»åŠ å‡æœŸ\nAdd Holiday", 
                                       command=self.add_holiday)
            add_holiday_btn.pack(pady=5)
            
            print("âœ… å‡æœŸä¿¡æ¯é¢æ¿è®¾ç½®å®Œæˆ")
            
            # å‡æœŸè®°å½•åŒºåŸŸ
            holiday_records_frame = tk.LabelFrame(right_frame, text="ğŸ“… å‡æœŸè®°å½• / Holiday Records")
            holiday_records_frame.pack(fill="both", expand=True, pady=(10, 0))
            
            # å‡æœŸè®°å½•è¾“å…¥åŒºåŸŸ
            input_frame = tk.Frame(holiday_records_frame)
            input_frame.pack(fill="x", pady=(0, 10))
            
            # å¼€å§‹æ—¥æœŸ
            start_frame = tk.Frame(input_frame)
            start_frame.pack(fill="x", pady=5)
            tk.Label(start_frame, text="ğŸ—“ï¸ å¼€å§‹æ—¥æœŸ / Start Date:", font=('Arial', 9, 'bold')).pack(side="left")
            self.holiday_start_date_entry = DateEntry(start_frame, width=12, background='darkblue',
                                                     foreground='white', borderwidth=2, date_pattern='dd/MM/yyyy')
            self.holiday_start_date_entry.pack(side="left", padx=(10, 0))
            
            # ç»“æŸæ—¥æœŸ
            end_frame = tk.Frame(input_frame)
            end_frame.pack(fill="x", pady=5)
            tk.Label(end_frame, text="ğŸ—“ï¸ ç»“æŸæ—¥æœŸ / End Date:", font=('Arial', 9, 'bold')).pack(side="left")
            self.holiday_end_date_entry = DateEntry(end_frame, width=12, background='darkblue',
                                                   foreground='white', borderwidth=2, date_pattern='dd/MM/yyyy')
            self.holiday_end_date_entry.pack(side="left", padx=(10, 0))
            
            # å‡æœŸåç§°
            name_frame = tk.Frame(input_frame)
            name_frame.pack(fill="x", pady=5)
            tk.Label(name_frame, text="ğŸ·ï¸ å‡æœŸåç§° / Holiday Name:", font=('Arial', 9, 'bold')).pack(side="left")
            self.holiday_name_entry = ttk.Entry(name_frame, width=25)
            self.holiday_name_entry.pack(side="left", padx=(10, 0))
            
            # æ·»åŠ å‡æœŸæŒ‰é’®
            quick_add_btn = ttk.Button(input_frame, text="â• å¿«é€Ÿæ·»åŠ \nQuick Add", 
                                      command=self.add_holiday_record_from_entries)
            quick_add_btn.pack(pady=5)
            
            # å‡æœŸè®°å½•åˆ—è¡¨
            tk.Label(holiday_records_frame, text="å‡æœŸè®°å½•åˆ—è¡¨ / Holiday Records List:", font=('Arial', 9, 'bold')).pack(anchor="w")
            
            # åˆ›å»ºå‡æœŸè®°å½•Treeview
            holiday_columns = ('å¼€å§‹æ—¥æœŸ', 'ç»“æŸæ—¥æœŸ', 'å‡æœŸåç§°', 'å‡æœŸé•¿åº¦')
            self.holiday_tree = ttk.Treeview(holiday_records_frame, columns=holiday_columns, show='headings', height=4)
            
            # è®¾ç½®åˆ—æ ‡é¢˜
            self.holiday_tree.heading('å¼€å§‹æ—¥æœŸ', text='å¼€å§‹æ—¥æœŸ / Start Date')
            self.holiday_tree.heading('ç»“æŸæ—¥æœŸ', text='ç»“æŸæ—¥æœŸ / End Date')
            self.holiday_tree.heading('å‡æœŸåç§°', text='å‡æœŸåç§° / Holiday Name')
            self.holiday_tree.heading('å‡æœŸé•¿åº¦', text='å‡æœŸé•¿åº¦ / Duration')
            
            self.holiday_tree.column('å¼€å§‹æ—¥æœŸ', width=80)
            self.holiday_tree.column('ç»“æŸæ—¥æœŸ', width=80)
            self.holiday_tree.column('å‡æœŸåç§°', width=120)
            self.holiday_tree.column('å‡æœŸé•¿åº¦', width=80)
            
            # æ·»åŠ æ»šåŠ¨æ¡
            holiday_scrollbar = ttk.Scrollbar(holiday_records_frame, orient="vertical", command=self.holiday_tree.yview)
            self.holiday_tree.configure(yscrollcommand=holiday_scrollbar.set)
            
            self.holiday_tree.pack(side="left", fill="both", expand=True)
            holiday_scrollbar.pack(side="right", fill="y")
            
            # å‡æœŸè®°å½•ç®¡ç†æŒ‰é’®åŒºåŸŸ - ç¾åŒ–å¸ƒå±€
            holiday_button_frame = tk.Frame(holiday_records_frame)
            holiday_button_frame.pack(fill="x", pady=(8, 0))
            
            # åˆ›å»ºå“åº”å¼æŒ‰é’®å¸ƒå±€
            add_holiday_btn = ttk.Button(holiday_button_frame, text="â• æ·»åŠ å‡æœŸè®°å½•\nAdd Holiday Record", 
                       command=self.add_holiday_record_record)
            add_holiday_btn.pack(side="left", padx=(0, 4), ipady=3)
            
            del_holiday_btn = ttk.Button(holiday_button_frame, text="ğŸ—‘ï¸ åˆ é™¤è®°å½•\nDelete Record", 
                       command=self.delete_holiday_record_record)
            del_holiday_btn.pack(side="left", padx=4, ipady=3)
            
            save_holiday_btn = ttk.Button(holiday_button_frame, text="ğŸ’¾ ä¿å­˜è®°å½•\nSave Records", 
                        command=self.save_holiday_records_to_file)
            save_holiday_btn.pack(side="left", padx=(4, 0), ipady=3)
            
            print("âœ… å®Œæ•´å³ä¾§é¢æ¿è®¾ç½®å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ è®¾ç½®å³ä¾§åº¦å‡é¢æ¿å¤±è´¥: {e}")
        
        # åˆå§‹åŒ–å‡æœŸè®°å½•
        if hasattr(self, 'holiday_records'):
            self.load_holiday_records()
        else:
            # åˆå§‹åŒ–å‡æœŸè®°å½•åˆ—è¡¨ - æŒ‰æ•°æ®åº“åˆ†ç±»
            self.holiday_records = {
                'GOGO': [],
                'Express': [],
                'PLUS': []
            }
        
        # åˆ·æ–°å‡æœŸè®°å½•æ˜¾ç¤º
        if hasattr(self, 'holiday_tree'):
            self.refresh_holiday_tree()
        
        # åˆå§‹åŒ–å‡æœŸä¿¡æ¯
        if hasattr(self, 'holiday_info_text'):
            self.update_holiday_info()
        
        # åˆå§‹åŒ–å‡æœŸè®°å½•åˆ—è¡¨ - æŒ‰æ•°æ®åº“åˆ†ç±»
        self.holiday_records = {
            'GOGO': [],
            'Express': [],
            'PLUS': []
        }
        self.load_holiday_records()
        self.refresh_holiday_tree()
        
        # åˆå§‹åŒ–å‡æœŸä¿¡æ¯
        self.update_holiday_info()
    
    def update_holiday_info(self):
        """æ›´æ–°å‡æœŸä¿¡æ¯æ˜¾ç¤º"""
        try:
            from datetime import datetime, timedelta
            import calendar
            
            # è·å–å½“å‰æœˆä»½
            now = datetime.now()
            current_month = now.month
            current_year = now.year
            
            # æ¸…ç©ºæ–‡æœ¬æ¡†
            self.holiday_info_text.delete("1.0", tk.END)
            
            # æ·»åŠ æœˆä»½æ ‡é¢˜
            month_name = calendar.month_name[current_month]
            self.holiday_info_text.insert(tk.END, f"ğŸ“… {current_year}å¹´{current_month}æœˆ / {month_name} {current_year}\n")
            self.holiday_info_text.insert(tk.END, "=" * 40 + "\n\n")
            
            # è·å–å½“æœˆæ‰€æœ‰æ—¥æœŸ
            days_in_month = calendar.monthrange(current_year, current_month)[1]
            
            # é¢„å®šä¹‰çš„å‡æœŸï¼ˆå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•ï¼‰
            holidays = {
                (1, 1): "å…ƒæ—¦ / New Year's Day",
                (2, 14): "æƒ…äººèŠ‚ / Valentine's Day",
                (3, 8): "å¦‡å¥³èŠ‚ / Women's Day",
                (4, 1): "æ„šäººèŠ‚ / April Fool's Day",
                (5, 1): "åŠ³åŠ¨èŠ‚ / Labor Day",
                (6, 1): "å„¿ç«¥èŠ‚ / Children's Day",
                (7, 1): "å»ºå…šèŠ‚ / Party Founding Day",
                (8, 1): "å»ºå†›èŠ‚ / Army Day",
                (9, 10): "æ•™å¸ˆèŠ‚ / Teacher's Day",
                (10, 1): "å›½åº†èŠ‚ / National Day",
                (12, 25): "åœ£è¯èŠ‚ / Christmas Day",
                (12, 31): "é™¤å¤• / New Year's Eve"
            }
            
            # æ£€æŸ¥å½“æœˆæ˜¯å¦æœ‰å‡æœŸ
            month_holidays = []
            for day in range(1, days_in_month + 1):
                if (current_month, day) in holidays:
                    weekday = calendar.day_name[datetime(current_year, current_month, day).weekday()]
                    holiday_name = holidays[(current_month, day)]
                    month_holidays.append(f"ğŸ“† {day}æ—¥ ({weekday}) - {holiday_name}")
            
            if month_holidays:
                self.holiday_info_text.insert(tk.END, "ğŸ–ï¸ æœ¬æœˆå‡æœŸ / This Month Holidays:\n\n")
                for holiday in month_holidays:
                    self.holiday_info_text.insert(tk.END, holiday + "\n")
            else:
                self.holiday_info_text.insert(tk.END, "â„¹ï¸ æœ¬æœˆæ— é¢„å®šä¹‰å‡æœŸ\nNo predefined holidays this month\n\n")
            
            # æ·»åŠ å‘¨æœ«ä¿¡æ¯
            self.holiday_info_text.insert(tk.END, "\nğŸ“… å‘¨æœ«æ—¥æœŸ / Weekend Dates:\n")
            for day in range(1, days_in_month + 1):
                date_obj = datetime(current_year, current_month, day)
                if date_obj.weekday() >= 5:  # å‘¨å…­å’Œå‘¨æ—¥
                    weekday = calendar.day_name[date_obj.weekday()]
                    self.holiday_info_text.insert(tk.END, f"ğŸ“… {day}æ—¥ ({weekday})\n")
            
        except Exception as e:
            self.holiday_info_text.insert(tk.END, f"è·å–å‡æœŸä¿¡æ¯å¤±è´¥: {e}")
    
    def add_holiday(self):
        """æ·»åŠ è‡ªå®šä¹‰å‡æœŸ"""
        try:
            # åˆ›å»ºå‡æœŸæ·»åŠ çª—å£
            holiday_window = tk.Toplevel(self.activity_window)
            holiday_window.title("â• æ·»åŠ å‡æœŸ / Add Holiday")
            holiday_window.geometry("400x300")
            holiday_window.transient(self.activity_window)
            holiday_window.grab_set()
            
            # å‡æœŸä¿¡æ¯è¾“å…¥
            main_frame = tk.Frame(holiday_window)
            main_frame.pack(fill="both", expand=True, padx=20, pady=20)
            
            # æ—¥æœŸé€‰æ‹©
            date_frame = tk.Frame(main_frame)
            date_frame.pack(fill="x", pady=5)
            tk.Label(date_frame, text="ğŸ“… å‡æœŸæ—¥æœŸ / Holiday Date:").pack(anchor="w")
            holiday_date = DateEntry(date_frame, width=12, background='darkgreen',
                                   foreground='white', borderwidth=2, date_pattern='dd/mm/yyyy')
            holiday_date.pack(anchor="w", pady=2)
            
            # å‡æœŸåç§°
            name_frame = tk.Frame(main_frame)
            name_frame.pack(fill="x", pady=5)
            tk.Label(name_frame, text="ğŸ·ï¸ å‡æœŸåç§° / Holiday Name:").pack(anchor="w")
            holiday_name = ttk.Entry(name_frame, width=30)
            holiday_name.pack(fill="x", pady=2)
            
            # å‡æœŸæè¿°
            desc_frame = tk.Frame(main_frame)
            desc_frame.pack(fill="both", expand=True, pady=5)
            tk.Label(desc_frame, text="ğŸ“ å‡æœŸæè¿° / Holiday Description:").pack(anchor="w")
            holiday_desc = tk.Text(desc_frame, height=4, width=30, wrap=tk.WORD)
            holiday_desc.pack(fill="both", expand=True, pady=2)
            
            # æŒ‰é’®
            button_frame = tk.Frame(main_frame)
            button_frame.pack(fill="x", pady=10)
            
            def save_holiday():
                try:
                    date_obj = holiday_date.get_date()
                    name = holiday_name.get().strip()
                    desc = holiday_desc.get("1.0", tk.END).strip()
                    
                    if not name:
                        tk.messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥å‡æœŸåç§°")
                        return
                    
                    # è¿™é‡Œå¯ä»¥å°†å‡æœŸä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶æˆ–æ•°æ®åº“
                    # æš‚æ—¶æ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
                    tk.messagebox.showinfo("æˆåŠŸ", f"å‡æœŸ '{name}' å·²æ·»åŠ ")
                    holiday_window.destroy()
                    
                    # æ›´æ–°å‡æœŸä¿¡æ¯æ˜¾ç¤º
                    self.update_holiday_info()
                    
                except Exception as e:
                    tk.messagebox.showerror("é”™è¯¯", f"æ·»åŠ å‡æœŸå¤±è´¥: {e}")
            
            ttk.Button(button_frame, text="ğŸ’¾ ä¿å­˜ / Save", command=save_holiday).pack(side="left", padx=5)
            ttk.Button(button_frame, text="âŒ å–æ¶ˆ / Cancel", command=holiday_window.destroy).pack(side="left", padx=5)
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"æ‰“å¼€å‡æœŸæ·»åŠ çª—å£å¤±è´¥: {e}")
    
    def add_holiday_record_from_entries(self):
        """ä»è¾“å…¥æ¡†æ·»åŠ å‡æœŸè®°å½•"""
        try:
            start_date = self.holiday_start_date_entry.get_date()
            end_date = self.holiday_end_date_entry.get_date()
            name = self.holiday_name_entry.get().strip()
            
            # éªŒè¯è¾“å…¥
            if not name:
                tk.messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥å‡æœŸåç§°")
                return
            
            if start_date > end_date:
                tk.messagebox.showerror("é”™è¯¯", "å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ")
                return
            
            # è®¡ç®—å‡æœŸé•¿åº¦
            duration_days = (end_date - start_date).days + 1
            
            # åˆ›å»ºå‡æœŸè®°å½•
            current_db = self.activity_database.get()
            
            holiday_record = {
                'id': len(self.holiday_records[current_db]) + 1,
                'start_date': start_date.strftime('%Y-%m-%d'),
                'end_date': end_date.strftime('%Y-%m-%d'),
                'name': name,
                'description': '',
                'duration_days': duration_days,
                'database': current_db,
                'created_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
            
            # æ·»åŠ åˆ°å¯¹åº”æ•°æ®åº“çš„è®°å½•åˆ—è¡¨
            self.holiday_records[current_db].append(holiday_record)
            
            # è‡ªå‹•ä¿å­˜åˆ° PromotionRecords.xlsx
            self.auto_save_promotion_records()
            
            # åˆ·æ–°æ˜¾ç¤º
            self.refresh_holiday_tree()
            
            # æ¸…ç©ºè¾“å…¥æ¡†
            self.holiday_start_date_entry.set_date(datetime.now())
            self.holiday_end_date_entry.set_date(datetime.now())
            self.holiday_name_entry.delete(0, tk.END)
            
            tk.messagebox.showinfo("æˆåŠŸ", f"å‡æœŸè®°å½• '{name}' å·²æ·»åŠ ")
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"æ·»åŠ å‡æœŸè®°å½•å¤±è´¥: {e}")

    def add_holiday_record(self):
        """æ·»åŠ å‡æœŸè®°å½•ï¼ˆå¼¹å‡ºçª—å£ç‰ˆæœ¬ï¼‰"""
        try:
            # åˆ›å»ºå‡æœŸè®°å½•æ·»åŠ çª—å£
            holiday_record_window = tk.Toplevel(self.activity_window)
            holiday_record_window.title("â• æ·»åŠ å‡æœŸè®°å½• / Add Holiday Record")
            holiday_record_window.geometry("500x400")
            holiday_record_window.transient(self.activity_window)
            holiday_record_window.grab_set()
            
            # å‡æœŸè®°å½•ä¿¡æ¯è¾“å…¥
            main_frame = tk.Frame(holiday_record_window)
            main_frame.pack(fill="both", expand=True, padx=20, pady=20)
            
            # å¼€å§‹æ—¥æœŸ
            start_frame = tk.Frame(main_frame)
            start_frame.pack(fill="x", pady=5)
            tk.Label(start_frame, text="ğŸ“… å‡æœŸå¼€å§‹æ—¥æœŸ / Holiday Start Date:", font=('Arial', 9, 'bold')).pack(anchor="w")
            holiday_start_date = DateEntry(start_frame, width=12, background='darkgreen',
                                        foreground='white', borderwidth=2, date_pattern='dd/mm/yyyy')
            holiday_start_date.pack(anchor="w", pady=2)
            
            # ç»“æŸæ—¥æœŸ
            end_frame = tk.Frame(main_frame)
            end_frame.pack(fill="x", pady=5)
            tk.Label(end_frame, text="ğŸ“… å‡æœŸç»“æŸæ—¥æœŸ / Holiday End Date:", font=('Arial', 9, 'bold')).pack(anchor="w")
            holiday_end_date = DateEntry(end_frame, width=12, background='darkgreen',
                                      foreground='white', borderwidth=2, date_pattern='dd/mm/yyyy')
            holiday_end_date.pack(anchor="w", pady=2)
            
            # å‡æœŸåç§°
            name_frame = tk.Frame(main_frame)
            name_frame.pack(fill="x", pady=5)
            tk.Label(name_frame, text="ğŸ·ï¸ å‡æœŸåç§° / Holiday Name:", font=('Arial', 9, 'bold')).pack(anchor="w")
            holiday_name = ttk.Entry(name_frame, width=40)
            holiday_name.pack(fill="x", pady=2)
            
            # å‡æœŸæè¿°
            desc_frame = tk.Frame(main_frame)
            desc_frame.pack(fill="both", expand=True, pady=5)
            tk.Label(desc_frame, text="ğŸ“ å‡æœŸæè¿° / Holiday Description:", font=('Arial', 9, 'bold')).pack(anchor="w")
            holiday_desc = tk.Text(desc_frame, height=6, width=40, wrap=tk.WORD)
            holiday_desc.pack(fill="both", expand=True, pady=2)
            
            # æŒ‰é’®
            button_frame = tk.Frame(main_frame)
            button_frame.pack(fill="x", pady=10)
            
            def save_holiday_record():
                try:
                    start_date = holiday_start_date.get_date()
                    end_date = holiday_end_date.get_date()
                    name = holiday_name.get().strip()
                    desc = holiday_desc.get("1.0", tk.END).strip()
                    
                    # éªŒè¯è¾“å…¥
                    if not name:
                        tk.messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥å‡æœŸåç§°")
                        return
                    
                    if start_date > end_date:
                        tk.messagebox.showerror("é”™è¯¯", "å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ")
                        return
                    
                    # è®¡ç®—å‡æœŸé•¿åº¦
                    duration_days = (end_date - start_date).days + 1
                    
                    # åˆ›å»ºå‡æœŸè®°å½•
                    # è·å–å½“å‰é€‰ä¸­çš„æ•°æ®åº“
                    current_db = self.activity_database.get()
                    
                    holiday_record = {
                        'id': len(self.holiday_records[current_db]) + 1,
                        'start_date': start_date.strftime('%Y-%m-%d'),
                        'end_date': end_date.strftime('%Y-%m-%d'),
                        'name': name,
                        'description': desc,
                        'duration_days': duration_days,
                        'database': current_db,
                        'created_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                    }
                    
                    # æ·»åŠ åˆ°å¯¹åº”æ•°æ®åº“çš„è®°å½•åˆ—è¡¨
                    self.holiday_records[current_db].append(holiday_record)
                    
                    # è‡ªå‹•ä¿å­˜åˆ° PromotionRecords.xlsx
                    self.auto_save_promotion_records()
                    
                    # åˆ·æ–°æ˜¾ç¤º
                    self.refresh_holiday_tree()
                    
                    tk.messagebox.showinfo("æˆåŠŸ", f"å‡æœŸè®°å½• '{name}' å·²æ·»åŠ ")
                    holiday_record_window.destroy()
                    
                except Exception as e:
                    tk.messagebox.showerror("é”™è¯¯", f"æ·»åŠ å‡æœŸè®°å½•å¤±è´¥: {e}")
            
            ttk.Button(button_frame, text="ğŸ’¾ ä¿å­˜ / Save", command=save_holiday_record).pack(side="left", padx=5)
            ttk.Button(button_frame, text="âŒ å–æ¶ˆ / Cancel", command=holiday_record_window.destroy).pack(side="left", padx=5)
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"æ‰“å¼€å‡æœŸè®°å½•æ·»åŠ çª—å£å¤±è´¥: {e}")
    
    def delete_holiday_record(self):
        """åˆ é™¤å‡æœŸè®°å½•"""
        try:
            # è·å–é€‰ä¸­çš„è®°å½•
            selected_items = self.holiday_tree.selection()
            if not selected_items:
                tk.messagebox.showwarning("æç¤º", "è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å‡æœŸè®°å½•")
                return
            
            # ç¡®è®¤åˆ é™¤
            if tk.messagebox.askyesno("ç¡®è®¤åˆ é™¤", "ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„å‡æœŸè®°å½•å—ï¼Ÿ"):
                # è·å–å½“å‰é€‰ä¸­çš„æ•°æ®åº“
                current_db = self.activity_database.get()
                
                # åˆ é™¤é€‰ä¸­çš„è®°å½•
                for item in selected_items:
                    item_values = self.holiday_tree.item(item, 'values')
                    holiday_name = item_values[2]  # å‡æœŸåç§°åœ¨ç¬¬3åˆ—
                    
                    # ä»å¯¹åº”æ•°æ®åº“çš„è®°å½•åˆ—è¡¨ä¸­åˆ é™¤
                    if current_db in self.holiday_records:
                        self.holiday_records[current_db] = [record for record in self.holiday_records[current_db] 
                                                           if record['name'] != holiday_name]
                
                # åˆ·æ–°æ˜¾ç¤º
                self.refresh_holiday_tree()
                tk.messagebox.showinfo("æˆåŠŸ", "å‡æœŸè®°å½•å·²åˆ é™¤")
                
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"åˆ é™¤å‡æœŸè®°å½•å¤±è´¥: {e}")
    
    def save_holiday_records(self):
        """ä¿å­˜å‡æœŸè®°å½•åˆ°æ–‡ä»¶"""
        try:
            import json
            import os
            
            # åˆ›å»ºæ•°æ®ç›®å½•
            data_dir = "activity_data"
            if not os.path.exists(data_dir):
                os.makedirs(data_dir)
            
            # ä¿å­˜åˆ°JSONæ–‡ä»¶
            holiday_file = os.path.join(data_dir, "holiday_records.json")
            with open(holiday_file, 'w', encoding='utf-8') as f:
                json.dump(self.holiday_records, f, ensure_ascii=False, indent=2)
            
            tk.messagebox.showinfo("æˆåŠŸ", f"å‡æœŸè®°å½•å·²ä¿å­˜åˆ°: {holiday_file}")
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"ä¿å­˜å‡æœŸè®°å½•å¤±è´¥: {e}")
    
    def load_holiday_records(self):
        """ä»æ–‡ä»¶åŠ è½½å‡æœŸè®°å½•"""
        try:
            import json
            import os
            
            holiday_file = os.path.join("activity_data", "holiday_records.json")
            if os.path.exists(holiday_file):
                with open(holiday_file, 'r', encoding='utf-8') as f:
                    loaded_records = json.load(f)
                    
                # å¦‚æœæ˜¯æ—§æ ¼å¼ï¼ˆåˆ—è¡¨ï¼‰ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼ï¼ˆæŒ‰æ•°æ®åº“åˆ†ç±»ï¼‰
                if isinstance(loaded_records, list):
                    self.holiday_records = {
                        'GOGO': loaded_records,
                        'Express': [],
                        'PLUS': []
                    }
                else:
                    self.holiday_records = loaded_records
            else:
                self.holiday_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': []
                }
                
        except Exception as e:
            print(f"åŠ è½½å‡æœŸè®°å½•å¤±è´¥: {e}")
            self.holiday_records = {
                'GOGO': [],
                'Express': [],
                'PLUS': []
            }
    
    def on_activity_type_change(self):
        """å¤„ç†æ´»åŠ¨ç±»å‹åˆ‡æ¢"""
        try:
            activity_type = self.activity_type.get()
            
            # æ›´æ–°æ´»å‹•é¡å‹æŒ‰éˆ•è¦–è¦ºç‹€æ…‹
            self.update_activity_type_button_styles()
            
            if activity_type == "daily":
                # æ˜¾ç¤ºæ¯æ—¥æ´»åŠ¨æ—¥æœŸé€‰æ‹©
                self.daily_date_frame.pack(fill="x")
                self.weekly_selection_frame.pack_forget()
            else:
                # æ˜¾ç¤ºå‘¨æœŸæ€§æ´»åŠ¨é€‰æ‹©
                self.weekly_selection_frame.pack(fill="x")
                self.daily_date_frame.pack_forget()
                
        except Exception as e:
            print(f"åˆ‡æ¢æ´»åŠ¨ç±»å‹å¤±è´¥: {e}")
    
    def select_database_option(self, option_key):
        """é¸æ“‡æ•¸æ“šåº«é¸é … - æ–°çš„å¤§æŒ‰éµé¸æ“‡æ–¹å¼ä¸¦ç›´æ¥é€£æ¥"""
        try:
            self.selected_db.set(option_key)
            print(f"ğŸ”„ åˆ‡æ›åˆ°æ•¸æ“šåº«é¸é …: {option_key}")
            print(f"DEBUG: selected_db is now set to: {self.selected_db.get()}")
            
            # æ›´æ–°æŒ‰éµç‹€æ…‹
            self.update_database_button_style()
            
            # è‡ªå‹•é€£æ¥æ•¸æ“šåº«ï¼ˆç§»é™¤åŸä¾†çš„é€£æ¥æŒ‰éµåŠŸèƒ½ï¼‰
            self.connect_database()
            
            # å¦‚æœå³å´é¢æ¿æœ‰æ´»å‹•æé†’æ–‡æœ¬ï¼Œæ›´æ–°æç¤º
            if hasattr(self, 'activity_alert_text'):
                current_info = self.DATABASE_OPTIONS.get(option_key, {})
                cn_name = current_info.get('cn', option_key)
                print(f"ğŸ“Š å·²åˆ‡æ›åˆ° {cn_name} æ•¸æ“šåº«")
                
                # æ›´æ–°æ´»åŠ¨æé†’æ˜¾ç¤º
                print(f"DEBUG: Updating activity alerts after database switch to {option_key}")
                self.update_activity_alerts()
                
        except Exception as e:
            print(f"âŒ åˆ‡æ›æ•¸æ“šåº«å¤±æ•—: {e}")
    
    def update_database_button_style(self):
        """æ›´æ–°æ•¸æ“šåº«æŒ‰éµçš„è¦–è¦ºç‹€æ…‹"""
        try:
            if not hasattr(self, 'db_options') or not self.db_options:
                return
                
            current_option = self.selected_db.get()
            current_info = self.DATABASE_OPTIONS.get(current_option, {})
            
            # æ›´æ–°æ‰€æœ‰æŒ‰éµç‹€æ…‹
            for key, btn in self.db_options.items():
                option_info = self.DATABASE_OPTIONS[key]
                
                if key == current_option:
                    # ç•¶å‰é¸ä¸­çš„æŒ‰éµ - é«˜äº®é¡¯ç¤º
                    btn.configure(bg=option_info['selected_color'], fg='white', relief='ridge', bd=3)
                else:
                    # æœªé¸ä¸­çš„æŒ‰éµ - æ­£å¸¸é¡¯ç¤º
                    btn.configure(bg=option_info['color'], fg='white', relief='solid', bd=2)
                    
            print(f"âœ… æ•¸æ“šåº«æŒ‰éµç‹€æ…‹å·²æ›´æ–°: {current_option}")
            
        except Exception as e:
            print(f"âŒ æ›´æ–°æ•¸æ“šåº«æŒ‰éµç‹€æ…‹å¤±æ•—: {e}")
    
    def update_database_button_styles(self):
        """æ›´æ–°æ•¸æ“šåº«æŒ‰éˆ•çš„è¦–è¦ºç‹€æ…‹"""
        try:
            if not hasattr(self, 'db_buttons'):
                return
                
            current_db = self.activity_database.get()
            
            # æ•¸æ“šåº«é¸é …é…ç½®
            db_colors = {
                "GOGO": "#27ae60",
                "Express": "#3498db", 
                "PLUS": "#f39c12",
                "All": "#9b59b6"
            }
            
            for value, btn in self.db_buttons.items():
                if value == current_db:
                    # é¸ä¸­ç‹€æ…‹ï¼šæ·±è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—ï¼Œå‡¹é™·æ•ˆæœ
                    btn.configure(bg=db_colors[value], fg='white', relief='sunken', bd=3,
                                 font=('Microsoft YaHei UI', 9, 'bold'))
                else:
                    # æœªé¸ä¸­ç‹€æ…‹ï¼šç™½è‰²èƒŒæ™¯ï¼Œå½©è‰²æ–‡å­—ï¼Œå‡¸èµ·æ•ˆæœ
                    btn.configure(bg='white', fg=db_colors[value], relief='raised', bd=2,
                                 font=('Microsoft YaHei UI', 9, 'normal'))
                    
        except Exception as e:
            print(f"æ›´æ–°æ•¸æ“šåº«æŒ‰éˆ•æ¨£å¼å¤±æ•—: {e}")
    
    def update_activity_type_button_styles(self):
        """æ›´æ–°æ´»å‹•é¡å‹æŒ‰éˆ•çš„è¦–è¦ºç‹€æ…‹"""
        try:
            if not hasattr(self, 'type_buttons'):
                return
                
            current_type = self.activity_type.get()
            
            # æ´»å‹•é¡å‹é¡è‰²é…ç½®
            type_colors = {
                "daily": "#e74c3c",
                "weekly": "#f39c12"
            }
            
            for value, btn in self.type_buttons.items():
                if value == current_type:
                    # é¸ä¸­ç‹€æ…‹ï¼šæ·±è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—ï¼Œå‡¹é™·æ•ˆæœ
                    btn.configure(bg=type_colors[value], fg='white', relief='sunken', bd=3,
                                 font=('Microsoft YaHei UI', 9, 'bold'))
                else:
                    # æœªé¸ä¸­ç‹€æ…‹ï¼šç™½è‰²èƒŒæ™¯ï¼Œå½©è‰²æ–‡å­—ï¼Œå‡¸èµ·æ•ˆæœ
                    btn.configure(bg='white', fg=type_colors[value], relief='raised', bd=2,
                                 font=('Microsoft YaHei UI', 9, 'normal'))
                    
        except Exception as e:
            print(f"æ›´æ–°æ´»å‹•é¡å‹æŒ‰éˆ•æ¨£å¼å¤±æ•—: {e}")
    
    def connect_to_activity_database(self, database_name):
        """è¿æ¥åˆ°æŒ‡å®šçš„æ•°æ®åº“"""
        try:
            # æ•°æ®åº“åç§°æ˜ å°„
            db_mapping = {
                'GOGO': 'sushi_gogo_pos_live',
                'Express': 'sushi_express_pos_live', 
                'PLUS': 'sushi_plus_pos_live'
            }
            
            full_db_name = db_mapping.get(database_name)
            if not full_db_name:
                print(f"âŒ æœªçŸ¥çš„æ•°æ®åº“åç§°: {database_name}")
                return False
            
            # å¦‚æœå·²ç»è¿æ¥åˆ°ç›®æ ‡æ•°æ®åº“ï¼Œç›´æ¥è¿”å›æˆåŠŸ
            if hasattr(self.db_manager, 'current_database') and self.db_manager.current_database == full_db_name:
                print(f"âœ… å·²è¿æ¥åˆ°æ•°æ®åº“: {database_name}")
                return True
            
            # æ–­å¼€å½“å‰è¿æ¥
            if hasattr(self.db_manager, 'disconnect'):
                self.db_manager.disconnect()
            
            # è¿æ¥åˆ°æ–°æ•°æ®åº“
            success = self.db_manager.connect(full_db_name)
            
            if success:
                print(f"âœ… æˆåŠŸè¿æ¥åˆ°æ•°æ®åº“: {database_name} ({full_db_name})")
                return True
            else:
                print(f"âŒ è¿æ¥æ•°æ®åº“å¤±è´¥: {database_name} ({full_db_name})")
                return False
                
        except Exception as e:
            print(f"âŒ è¿æ¥æ•°æ®åº“æ—¶å‡ºé”™: {e}")
            return False
    
    def initial_database_connection(self):
        """æ´»åŠ¨è®°å½•çª—å£æ‰“å¼€æ—¶çš„åˆå§‹æ•°æ®åº“è¿æ¥ - å¼ºåŒ–ç‰ˆæœ¬ç¡®ä¿é—¨å¸‚äº§å“æ•°æ®æ­£å¸¸æ˜¾ç¤º"""
        try:
            if hasattr(self, 'activity_database'):
                current_db = self.activity_database.get()
                print(f"ğŸ”— æ´»åŠ¨è®°å½•çª—å£åˆå§‹åŒ– - è¿æ¥åˆ°æ•°æ®åº“: {current_db}")
                
                # è¿æ¥åˆ°é»˜è®¤æ•°æ®åº“
                success = self.connect_to_activity_database(current_db)
                
                if success:
                    print(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œå¼€å§‹åˆ·æ–°æ‰€æœ‰æ•°æ®...")
                    
                    # å»¶è¿Ÿåˆ·æ–°ç¡®ä¿è¿æ¥ç¨³å®šï¼Œå¼ºåˆ¶åˆ·æ–°é—¨å¸‚å’Œäº§å“åˆ—è¡¨
                    self.activity_window.after(200, self.force_refresh_all_data)
                    self.show_activity_message(f"âœ… å·²è¿æ¥åˆ°æ•°æ®åº“: {current_db}")
                else:
                    self.show_activity_message(f"âŒ è¿æ¥æ•°æ®åº“å¤±è´¥: {current_db}")
                    
        except Exception as e:
            print(f"âŒ åˆå§‹æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
            if hasattr(self, 'activity_window') and self.activity_window.winfo_exists():
                self.show_activity_message(f"âŒ åˆå§‹è¿æ¥å¤±è´¥: {e}")
    
    def force_refresh_all_data(self):
        """å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰æ´»åŠ¨è®°å½•æ•°æ®"""
        try:
            print("ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰æ´»åŠ¨è®°å½•æ•°æ®...")
            
            # å¼ºåˆ¶åˆ·æ–°é—¨å¸‚åˆ—è¡¨
            self.refresh_activity_outlets()
            
            # å¼ºåˆ¶åˆ·æ–°äº§å“åˆ—è¡¨  
            self.refresh_activity_products()
            
            # å¼ºåˆ¶åˆ·æ–°å³ä¾§å‡æœŸé¢æ¿
            if hasattr(self, 'holiday_tree'):
                self.refresh_holiday_tree()
            
            print("âœ… æ‰€æœ‰æ•°æ®åˆ·æ–°å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ å¼ºåˆ¶åˆ·æ–°æ•°æ®å¤±è´¥: {e}")
            self.show_activity_message(f"âŒ å¼ºåˆ¶åˆ·æ–°å¤±è´¥: {e}")
    
    def refresh_activity_outlets(self):
        """åˆ·æ–°æ´»åŠ¨é—¨å¸‚é€‰é¡¹ - å¢å¼ºç‰ˆæœ¬ï¼Œç¡®ä¿åƒä¸»é¡µé¢ä¸€æ ·æ­£å¸¸æ˜¾ç¤º"""
        try:
            print("ğŸ”„ å¼€å§‹åˆ·æ–°é—¨å¸‚é€‰é¡¹...")
            
            # æ£€æŸ¥æ•°æ®åº“è¿æ¥
            if not hasattr(self, 'db_manager') or not self.db_manager.connection:
                print("âš ï¸ æ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•è·å–é—¨å¸‚æ•°æ®")
                self.show_activity_message("âš ï¸ æ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•è·å–é—¨å¸‚æ•°æ®")
                return
            
            # æ£€æŸ¥æ§åˆ¶å™¨æ˜¯å¦å­˜åœ¨
            if not hasattr(self, 'activity_outlets'):
                print("âš ï¸ é—¨å¸‚æ§åˆ¶å™¨æœªåˆå§‹åŒ–")
                return
            
            print("ğŸ” æ­£åœ¨è·å–é—¨å¸‚æ•°æ®...")
            # è·å–é—¨å¸‚åˆ—è¡¨
            outlets = self.db_manager.get_outlets()
            
            if outlets and len(outlets) > 0:
                # æ›´æ–°é—¨å¸‚é€‰é¡¹
                self.activity_outlets.set_values(outlets)
                self.available_outlets = outlets
                print(f"âœ… å·²åŠ è½½ {len(outlets)} ä¸ªé—¨å¸‚é€‰é¡¹")
                print(f"é—¨å¸‚åˆ—è¡¨: {outlets[:5]}...")  # æ˜¾ç¤ºå‰5ä¸ªé—¨å¸‚
                
                # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                self.show_activity_message(f"âœ… å·²åŠ è½½ {len(outlets)} ä¸ªé—¨å¸‚é€‰é¡¹")
            else:
                print("âš ï¸ æœªè·å–åˆ°é—¨å¸‚æ•°æ®")
                self.show_activity_message("âš ï¸ æœªè·å–åˆ°é—¨å¸‚æ•°æ®")
                
        except Exception as e:
            print(f"âŒ åˆ·æ–°é—¨å¸‚åˆ—è¡¨å¤±è´¥: {e}")
            self.show_activity_message(f"âŒ è·å–é—¨å¸‚æ•°æ®å¤±è´¥: {e}")

    def show_activity_message(self, message):
        """åœ¨æ´»åŠ¨è®°å½•çª—å£ä¸­æ˜¾ç¤ºæ¶ˆæ¯"""
        try:
            if hasattr(self, 'activity_window') and self.activity_window.winfo_exists():
                # åœ¨çª—å£æ ‡é¢˜ä¸­æ˜¾ç¤ºæ¶ˆæ¯
                original_title = "ğŸ“ æ´»åŠ¨è®°å½•ç®¡ç† / Activity Records Management"
                self.activity_window.title(f"{original_title} - {message}")
                
                # 3ç§’åæ¢å¤åŸæ ‡é¢˜
                def restore_title():
                    if hasattr(self, 'activity_window') and self.activity_window.winfo_exists():
                        self.activity_window.title(original_title)
                
                self.activity_window.after(3000, restore_title)
                
        except Exception as e:
            print(f"æ˜¾ç¤ºæ´»åŠ¨æ¶ˆæ¯å¤±è´¥: {e}")

    def on_database_change(self):
        """å¤„ç†æ•°æ®åº“åˆ‡æ¢ - å¢å¼ºç‰ˆæœ¬ï¼Œç¡®ä¿è‡ªåŠ¨è¿æ¥å’Œåˆ·æ–°"""
        try:
            current_db = self.activity_database.get()
            print(f"ğŸ”„ åˆ‡æ¢åˆ°æ•°æ®åº“: {current_db}")
            
            # æ›´æ–°æ•¸æ“šåº«æŒ‰éˆ•è¦–è¦ºç‹€æ…‹
            self.update_database_button_styles()
            
            # ç¡®ä¿æ´»åŠ¨è®°å½•å­—å…¸å­˜åœ¨å¹¶åŒ…å«æ‰€æœ‰æ•°æ®åº“
            if not hasattr(self, 'activity_records'):
                self.activity_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': [],
                    'All': []
                }
            
            # ç¡®ä¿å½“å‰æ•°æ®åº“çš„æ´»åŠ¨è®°å½•é”®å­˜åœ¨
            if current_db not in self.activity_records:
                self.activity_records[current_db] = []
                print(f"ğŸ”§ ä¸ºæ•°æ®åº“ '{current_db}' åˆ›å»ºäº†æ–°çš„æ´»åŠ¨è®°å½•åˆ—è¡¨")
            
            # è‡ªåŠ¨è¿æ¥æ•°æ®åº“
            success = self.connect_to_activity_database(current_db)
            
            if success:
                print(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œå¼€å§‹åˆ·æ–°æ•°æ®...")
                
                # å»¶è¿Ÿåˆ·æ–°ï¼Œç¡®ä¿æ•°æ®åº“è¿æ¥ç¨³å®š
                self.activity_window.after(100, self.refresh_all_activity_data)
                
                # æ›´æ–°æ´»å‹•æé†’
                try:
                    self.update_activity_alerts()
                except:
                    pass  # å¦‚æœä¸»ç•Œé¢ä¸å­˜åœ¨ï¼Œå¿½ç•¥éŒ¯èª¤
                
                # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                self.show_activity_message(f"âœ… å·²è¿æ¥åˆ°æ•°æ®åº“: {current_db}")
                
                # ç«‹å³åˆ·æ–°æ´»åŠ¨è®°å½•æ ‘
                self.refresh_activity_tree()
            else:
                # æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                self.show_activity_message(f"âŒ è¿æ¥æ•°æ®åº“å¤±è´¥: {current_db}")
            
        except Exception as e:
            print(f"åˆ‡æ¢æ•°æ®åº“å¤±è´¥: {e}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯ä¿¡æ¯: {traceback.format_exc()}")
            self.show_activity_message(f"âŒ åˆ‡æ¢æ•°æ®åº“æ—¶å‡ºé”™: {e}")
    
    def refresh_all_activity_data(self):
        """åˆ·æ–°æ‰€æœ‰æ´»åŠ¨è®°å½•ç›¸å…³æ•°æ®"""
        try:
            # åˆ·æ–°æ´»åŠ¨è®°å½•æ ‘æ˜¾ç¤º
            if hasattr(self, 'activity_tree'):
                self.refresh_activity_tree()
            
            # åˆ·æ–°å‡æœŸè®°å½•æ ‘æ˜¾ç¤º
            if hasattr(self, 'holiday_records') and hasattr(self, 'holiday_tree'):
                self.refresh_holiday_tree()
            
            # è‡ªåŠ¨åˆ·æ–°äº§å“åˆ—è¡¨å’Œé—¨å¸‚åˆ—è¡¨
            self.refresh_activity_products()
            self.refresh_activity_outlets()
            
            print("âœ… æ‰€æœ‰æ´»åŠ¨è®°å½•æ•°æ®å·²åˆ·æ–°")
            
        except Exception as e:
            print(f"åˆ·æ–°æ´»åŠ¨è®°å½•æ•°æ®å¤±è´¥: {e}")
            self.show_activity_message(f"âŒ åˆ·æ–°æ•°æ®å¤±è´¥: {e}")
    
    def select_all_outlets(self):
        """å…¨é€‰é—¨å¸‚"""
        try:
            if hasattr(self, 'available_outlets') and self.available_outlets:
                self.activity_outlets.set_selected(self.available_outlets)
                tk.messagebox.showinfo("æˆåŠŸ", f"å·²é€‰æ‹©å…¨éƒ¨ {len(self.available_outlets)} ä¸ªé—¨å¸‚")
            else:
                tk.messagebox.showwarning("æç¤º", "æš‚æ— å¯ç”¨é—¨å¸‚æ•°æ®ï¼Œè¯·å…ˆè¿æ¥æ•°æ®åº“")
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"å…¨é€‰é—¨å¸‚å¤±è´¥: {e}")
    
    def select_all_parts(self):
        """å…¨é€‰éƒ¨åˆ†"""
        try:
            if hasattr(self, 'activity_parts'):
                parts_values = ['DI', 'TA', 'Delivery', 'Food Panda', 'Grab Food', 'Deliveroo', 'All']
                self.activity_parts.set_selected(parts_values)
                tk.messagebox.showinfo("æˆåŠŸ", f"å·²é€‰æ‹©å…¨éƒ¨ {len(parts_values)} ä¸ªéƒ¨åˆ†")
            else:
                tk.messagebox.showwarning("æç¤º", "éƒ¨åˆ†æ§åˆ¶å™¨æœªåˆå§‹åŒ–")
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"å…¨é€‰éƒ¨åˆ†å¤±è´¥: {e}")
    
    def select_all_products(self):
        """å…¨é€‰äº§å“"""
        try:
            if hasattr(self, 'activity_products') and hasattr(self, 'available_products') and self.available_products:
                self.activity_products.set_selected(self.available_products)
                tk.messagebox.showinfo("æˆåŠŸ", f"å·²é€‰æ‹©å…¨éƒ¨ {len(self.available_products)} ä¸ªäº§å“")
            else:
                tk.messagebox.showwarning("æç¤º", "æš‚æ— å¯ç”¨äº§å“æ•°æ®ï¼Œè¯·å…ˆè¿æ¥æ•°æ®åº“")
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"å…¨é€‰äº§å“å¤±è´¥: {e}")
    
    def select_all_payment_methods(self):
        """å…¨é€‰æ”¯ä»˜æ–¹å¼"""
        try:
            if hasattr(self, 'activity_payment'):
                payment_values = ['VISA', 'MASTER', 'NETS', 'AMEX', 'UnionPay', 'DBS MAX', 'CDC Voucher', 'Mall Voucher', 
                                'GRAB FOOD', 'FOOD PANDA', 'DELIVEROO', 'SE APP', 'WASTAGE']
                self.activity_payment.set_selected(payment_values)
                tk.messagebox.showinfo("æˆåŠŸ", f"å·²é€‰æ‹©å…¨éƒ¨ {len(payment_values)} ä¸ªæ”¯ä»˜æ–¹å¼")
            else:
                tk.messagebox.showwarning("æç¤º", "æ”¯ä»˜æ–¹å¼æ§åˆ¶å™¨æœªåˆå§‹åŒ–")
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"å…¨é€‰æ”¯ä»˜æ–¹å¼å¤±è´¥: {e}")
    
    def update_activity_products_from_records(self):
        """å¾å·²å°å…¥çš„æ´»å‹•è¨˜éŒ„ä¸­æ›´æ–°ç”¢å“é¸æ“‡å™¨"""
        try:
            if not hasattr(self, 'activity_products'):
                print("âš ï¸ ç”¢å“é¸æ“‡å™¨æœªåˆå§‹åŒ–")
                return
            
            print("ğŸ” é–‹å§‹å¾æ´»å‹•è¨˜éŒ„ä¸­æ”¶é›†ç”¢å“è³‡æ–™...")
            print(f"ğŸ” ç•¶å‰ activity_records ç‹€æ…‹: {hasattr(self, 'activity_records')}")
            
            # æª¢æŸ¥ activity_records æ˜¯å¦å­˜åœ¨
            if not hasattr(self, 'activity_records'):
                print("âš ï¸ activity_records ä¸å­˜åœ¨ï¼Œå˜—è©¦å¾æ•¸æ“šåº«ç²å–ç”¢å“")
                self.refresh_activity_products()
                return
            
            # æ”¶é›†æ‰€æœ‰æ´»å‹•è¨˜éŒ„ä¸­çš„ç”¢å“
            all_products = set()
            total_records = 0
            
            for db_name in ['GOGO', 'Express', 'PLUS']:
                records = self.activity_records.get(db_name, [])
                print(f"ğŸ“‹ {db_name} æ•¸æ“šåº«æœ‰ {len(records)} æ¢æ´»å‹•è¨˜éŒ„")
                total_records += len(records)
                
                for i, record in enumerate(records):
                    products = record.get('products', [])
                    print(f"  è¨˜éŒ„ {i+1}: ç”¢å“è³‡æ–™ = {products} (é¡å‹: {type(products)})")
                    
                    if products:
                        # è™•ç†ç”¢å“åˆ—è¡¨ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
                        if isinstance(products, str):
                            if products.strip():
                                product_list = [p.strip() for p in products.split(',') if p.strip()]
                                all_products.update(product_list)
                                print(f"    å­—ç¬¦ä¸²æ ¼å¼ç”¢å“: {product_list}")
                        elif isinstance(products, list):
                            product_list = [p.strip() for p in products if p.strip()]
                            all_products.update(product_list)
                            print(f"    åˆ—è¡¨æ ¼å¼ç”¢å“: {product_list}")
            
            print(f"ğŸ“Š ç¸½å…±è™•ç†äº† {total_records} æ¢æ´»å‹•è¨˜éŒ„")
            print(f"ğŸ“Š æ”¶é›†åˆ° {len(all_products)} å€‹å”¯ä¸€ç”¢å“")
            
            if all_products:
                # è½‰æ›ç‚ºæ’åºçš„åˆ—è¡¨
                products_list = sorted(list(all_products))
                print(f"âœ… å¾æ´»å‹•è¨˜éŒ„ä¸­æ”¶é›†åˆ° {len(products_list)} å€‹ç”¢å“")
                print(f"å®Œæ•´ç”¢å“åˆ—è¡¨: {products_list}")
                
                # æ›´æ–°ç”¢å“é¸æ“‡å™¨
                self.activity_products.set_values(products_list)
                
                # ä¿å­˜åˆ°å¯ç”¨ç”¢å“åˆ—è¡¨
                self.available_products = products_list
                
                # å¼·åˆ¶åˆ·æ–°é¡¯ç¤º
                self.activity_products.update_display()
                
                print(f"âœ… ç”¢å“é¸æ“‡å™¨å·²æ›´æ–°ï¼ŒåŒ…å« {len(products_list)} å€‹ç”¢å“")
                print(f"âœ… ç”¢å“é¸æ“‡å™¨ç•¶å‰é¡¯ç¤º: {self.activity_products.combo.get()}")
            else:
                print("â„¹ï¸ æ´»å‹•è¨˜éŒ„ä¸­æ²’æœ‰æ‰¾åˆ°ç”¢å“è³‡æ–™ï¼Œå˜—è©¦å¾æ•¸æ“šåº«ç²å–")
                # å¦‚æœæ²’æœ‰ç”¢å“è³‡æ–™ï¼Œå˜—è©¦å¾æ•¸æ“šåº«ç²å–
                self.refresh_activity_products()
                
        except Exception as e:
            print(f"âŒ å¾æ´»å‹•è¨˜éŒ„æ›´æ–°ç”¢å“é¸æ“‡å™¨å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
            # å¤±æ•—æ™‚å˜—è©¦å¾æ•¸æ“šåº«ç²å–ç”¢å“
            try:
                self.refresh_activity_products()
            except Exception as e2:
                print(f"âŒ å¾æ•¸æ“šåº«ç²å–ç”¢å“ä¹Ÿå¤±æ•—: {e2}")
    
    def force_update_product_selector(self):
        """å¼·åˆ¶æ›´æ–°ç”¢å“é¸æ“‡å™¨"""
        try:
            print("ğŸ”„ å¼·åˆ¶æ›´æ–°ç”¢å“é¸æ“‡å™¨...")
            
            if not hasattr(self, 'activity_products'):
                print("âš ï¸ ç”¢å“é¸æ“‡å™¨æœªåˆå§‹åŒ–")
                return
            
            # æ”¶é›†æ‰€æœ‰ç”¢å“
            all_products = set()
            
            # å¾æ´»å‹•è¨˜éŒ„ä¸­æ”¶é›†ç”¢å“
            for db_name in ['GOGO', 'Express', 'PLUS']:
                records = self.activity_records.get(db_name, [])
                for record in records:
                    products = record.get('products', [])
                    if products:
                        if isinstance(products, str):
                            product_list = [p.strip() for p in products.split(',') if p.strip()]
                            all_products.update(product_list)
                        elif isinstance(products, list):
                            all_products.update([p.strip() for p in products if p.strip()])
            
            # æ·»åŠ é»˜èªç”¢å“
            default_products = [
                'Salmon Sashimi (13pcs)', 'Salmon Sashimi (8pcs)', 'Salmon Sushi 10pcs', 
                'Salmon Roll', 'Salmon Nigiri', 'Tuna Sashimi (10pcs)', 'Eel Roll', 
                'California Roll', 'Tempura Roll', 'Dragon Roll'
            ]
            all_products.update(default_products)
            
            if all_products:
                products_list = sorted(list(all_products))
                print(f"âœ… å¼·åˆ¶æ›´æ–°æ”¶é›†åˆ° {len(products_list)} å€‹ç”¢å“")
                
                # å¼·åˆ¶æ›´æ–°ç”¢å“é¸æ“‡å™¨
                self.activity_products.set_values(products_list)
                self.activity_products.update_display()
                
                # ä¿å­˜åˆ°å¯ç”¨ç”¢å“åˆ—è¡¨
                self.available_products = products_list
                
                print(f"âœ… ç”¢å“é¸æ“‡å™¨å¼·åˆ¶æ›´æ–°å®Œæˆï¼Œç•¶å‰é¡¯ç¤º: {self.activity_products.combo.get()}")
            else:
                print("âš ï¸ æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç”¢å“æ•¸æ“š")
                
        except Exception as e:
            print(f"âŒ å¼·åˆ¶æ›´æ–°ç”¢å“é¸æ“‡å™¨å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
    
    def refresh_activity_products(self):
        """åˆ·æ–°æ´»åŠ¨äº§å“é€‰é¡¹ - å¢å¼ºç‰ˆæœ¬ï¼Œç¡®ä¿åƒä¸»é¡µé¢ä¸€æ ·æ­£å¸¸æ˜¾ç¤º"""
        try:
            print("ğŸ”„ å¼€å§‹åˆ·æ–°äº§å“é€‰é¡¹...")
            
            # æ£€æŸ¥æ•°æ®åº“è¿æ¥
            if not hasattr(self, 'db_manager') or not self.db_manager.connection:
                print("âš ï¸ æ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•è·å–äº§å“æ•°æ®")
                self.show_activity_message("âš ï¸ æ•°æ®åº“æœªè¿æ¥ï¼Œæ— æ³•è·å–äº§å“æ•°æ®")
                return
            
            # æ£€æŸ¥æ§åˆ¶å™¨æ˜¯å¦å­˜åœ¨
            if not hasattr(self, 'activity_products'):
                print("âš ï¸ äº§å“æ§åˆ¶å™¨æœªåˆå§‹åŒ–")
                return
            
            print("ğŸ” æ­£åœ¨è·å–äº§å“æ•°æ®...")
            
            # è·å–å½“å‰é€‰ä¸­çš„æ•°æ®åº“
            current_db = self.get_current_database()
            
            # ç¡®ä¿è¿æ¥åˆ°å¯¹åº”çš„æ•°æ®åº“
            if not self.connect_to_activity_database(current_db):
                self.show_activity_message(f"âŒ æ— æ³•è¿æ¥åˆ° {current_db} æ•°æ®åº“")
                return
            
            # ä¼˜å…ˆå°è¯•ä»å·²å¯¼å‡ºçš„äº§å“æ•°æ®ä¸­è·å–
            export_dir = "new_staged_export_specific_data"
            
            # å°†å®Œæ•´æ•°æ®åº“åç§°è½¬æ¢ä¸ºç®€åŒ–åç§°ï¼ˆç”¨äºæ–‡ä»¶æŸ¥æ‰¾ï¼‰
            db_name_mapping = {
                'sushi_gogo_pos_live': 'GOGO',
                'sushi_express_pos_live': 'Express', 
                'sushi_plus_pos_live': 'PLUS'
            }
            simplified_db_name = db_name_mapping.get(current_db, current_db)
            
            product_data_file = f"{export_dir}/{simplified_db_name}_daily_product_data.xlsx"
            
            if os.path.exists(product_data_file):
                print(f"ğŸ“ å°è¯•ä»å·²å¯¼å‡ºäº§å“æ•°æ®æ–‡ä»¶è·å–äº§å“åˆ—è¡¨: {product_data_file}")
                try:
                    import pandas as pd
                    df = pd.read_excel(product_data_file)
                    
                    if 'item_name' in df.columns:
                        products = df['item_name'].dropna().unique().tolist()
                        products = [p for p in products if p and str(p).strip() and str(p) != 'NULL']
                        products.sort()
                        
                        if products:
                            print(f"âœ“ ä»å·²å¯¼å‡ºäº§å“æ•°æ®è·å–åˆ° {len(products)} ä¸ªäº§å“")
                            self.activity_products.set_values(products)
                            self.available_products = products
                            tk.messagebox.showinfo("æˆåŠŸ", f"ä»å·²å¯¼å‡ºæ•°æ®åŠ è½½ {len(products)} ä¸ªäº§å“")
                            return
                except Exception as e:
                    print(f"âœ— ä»å·²å¯¼å‡ºäº§å“æ•°æ®è·å–å¤±è´¥: {e}ï¼Œå°è¯•æ•°æ®åº“æŸ¥è¯¢")
            
            # ä½¿ç”¨ä¸“é—¨çš„SQLæŸ¥è¯¢è·å–æ‰€æœ‰å”¯ä¸€äº§å“åç§°
            cursor = self.db_manager.connection.cursor()
            
            # æŸ¥è¯¢æ‰€æœ‰å”¯ä¸€çš„äº§å“åç§°
            query = """
            SELECT DISTINCT item_name 
            FROM pos_sales_dtls 
            WHERE item_name IS NOT NULL 
            AND item_name != '' 
            AND item_name != 'NULL'
            ORDER BY item_name
            """
            
            cursor.execute(query)
            results = cursor.fetchall()
            cursor.close()
            
            if results:
                # æå–äº§å“åç§°
                products = [row[0] for row in results if row[0] and row[0].strip()]
                products = list(set(products))  # å»é‡
                products.sort()  # æ’åº
                
                # æ›´æ–°äº§å“é€‰é¡¹
                self.activity_products.set_values(products)
                print(f"âœ… å·²ä» {current_db} æ•°æ®åº“åŠ è½½ {len(products)} ä¸ªäº§å“é€‰é¡¹")
                print(f"äº§å“åˆ—è¡¨: {products[:5]}...")  # æ˜¾ç¤ºå‰5ä¸ªäº§å“
                
                # ä¿å­˜åˆ°å¯ç”¨äº§å“åˆ—è¡¨
                self.available_products = products
                
                # æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                self.show_activity_message(f"âœ… å·²åŠ è½½ {len(products)} ä¸ªäº§å“é€‰é¡¹")
            else:
                print(f"âš ï¸ {current_db} æ•°æ®åº“ä¸­æœªæ‰¾åˆ°äº§å“æ•°æ®")
                self.activity_products.set_values([])
                self.show_activity_message(f"âš ï¸ {current_db} æ•°æ®åº“ä¸­æœªæ‰¾åˆ°äº§å“æ•°æ®")
                
        except Exception as e:
            print(f"âŒ ä»æ•°æ®åº“è·å–äº§å“åˆ—è¡¨å¤±è´¥: {e}")
            self.activity_products.set_values([])
            self.show_activity_message(f"âŒ è·å–äº§å“æ•°æ®å¤±è´¥: {e}")
    
    def analyze_selected_activity_from_main_window(self, activity_id):
        """å¾ä¸»çª—å£åˆ†æé¸ä¸­çš„æ´»å‹•è¨˜éŒ„ - èˆ‡è¨˜éŒ„æŸ¥çœ‹çª—å£åŠŸèƒ½ä¸€è‡´"""
        try:
            print(f"ğŸ” å¾ä¸»çª—å£åˆ†ææ´»å‹•è¨˜éŒ„ï¼ŒID: {activity_id}")
            
            # æ‰¾åˆ°å°æ‡‰çš„æ´»å‹•è¨˜éŒ„
            current_db = self.get_current_database()
            print(f"ğŸ“Š ç•¶å‰æ•¸æ“šåº«: {current_db}")
            
            records = self.activity_records.get(current_db, [])
            print(f"ğŸ“Š æ‰¾åˆ° {len(records)} æ¢æ´»å‹•è¨˜éŒ„")
            
            selected_record = None
            for record in records:
                print(f"ğŸ” æª¢æŸ¥è¨˜éŒ„: ID={record.get('id')}, åç¨±={record.get('name', record.get('description', 'æœªçŸ¥'))}")
                
                # å˜—è©¦å¤šç¨®IDåŒ¹é…æ–¹å¼
                if record.get('id') == activity_id:
                    selected_record = record
                    print(f"âœ… åŒ¹é…æˆåŠŸ (ç›´æ¥åŒ¹é…): {selected_record}")
                    break
                elif str(record.get('id')) == str(activity_id):
                    selected_record = record
                    print(f"âœ… åŒ¹é…æˆåŠŸ (å­—ç¬¦ä¸²åŒ¹é…): {selected_record}")
                    break
                elif int(record.get('id', 0)) == int(activity_id):
                    selected_record = record
                    print(f"âœ… åŒ¹é…æˆåŠŸ (æ•´æ•¸åŒ¹é…): {selected_record}")
                    break

            if selected_record:
                print(f"âœ… æ‰¾åˆ°æ´»å‹•è¨˜éŒ„: {selected_record}")
                
                # ä½¿ç”¨æ´»åŠ¨è®°å½•çš„ä¿¡æ¯è¿›è¡Œåˆ†æ
                current_db = selected_record.get('database', self.activity_database.get())
                print(f"ğŸ“Š ç•¶å‰æ•¸æ“šåº«: {current_db}")

                # è¿æ¥æ•°æ®åº“
                print("ğŸ”Œ å˜—è©¦é€£æ¥æ•¸æ“šåº«...")
                if not self.connect_to_activity_database(current_db):
                    print(f"âŒ ç„¡æ³•é€£æ¥åˆ°æ•¸æ“šåº«: {current_db}")
                    tk.messagebox.showerror("é”™è¯¯", f"æ— æ³•è¿æ¥åˆ°æ•°æ®åº“: {current_db}")
                    return
                print("âœ… æ•¸æ“šåº«é€£æ¥æˆåŠŸ")

                # åˆ›å»ºåˆ†æç»“æœçª—å£ - ç¾åŒ–ç‰ˆæœ¬
                print("ğŸªŸ å‰µå»ºåˆ†æçµæœçª—å£...")
                analysis_window = tk.Toplevel(self.root)
                print("âœ… åˆ†æçª—å£å·²å‰µå»º")
                activity_name = selected_record.get('description', selected_record.get('name', f"æ´»å‹• {activity_id}"))
                analysis_window.title(f"ğŸ“Š {activity_name} - æ´»å‹•æ¥­ç¸¾åˆ†æ / Activity Performance Analysis")
                analysis_window.geometry("1200x800")
                analysis_window.configure(bg='#FFFFFF')
                
                # è¨­ç½®çª—å£é—œé–‰å”è­° - ç¢ºä¿æ­£ç¢ºé—œé–‰
                def close_analysis_window():
                    try:
                        analysis_window.destroy()
                    except:
                        pass
                
                analysis_window.protocol("WM_DELETE_WINDOW", close_analysis_window)
                
                # è¨­ç½®çª—å£åœ–æ¨™å’Œæ¨£å¼
                try:
                    analysis_window.iconbitmap("SELOGO22 - 01.ico")
                except:
                    pass

                # æ¨™é¡Œå€åŸŸ
                title_frame = tk.Frame(analysis_window, bg='#2c3e50', height=80)
                title_frame.pack(fill="x")
                title_frame.pack_propagate(False)
                
                title_label = tk.Label(title_frame, 
                                     text=f"ğŸ“Š {activity_name}",
                                     font=('Microsoft YaHei UI', 16, 'bold'),
                                     fg='white', bg='#2c3e50')
                title_label.pack(side="left", padx=20, pady=20)
                
                subtitle_label = tk.Label(title_frame, 
                                        text="æ´»å‹•æ¥­ç¸¾åˆ†æ / Activity Performance Analysis",
                                        font=('Arial', 11),
                                        fg='#bdc3c7', bg='#2c3e50')
                subtitle_label.pack(side="left", padx=(0, 20), pady=20)

                # ä¸»å…§å®¹å€åŸŸ
                content_frame = tk.Frame(analysis_window, bg='#FFFFFF')
                content_frame.pack(fill="both", expand=True, padx=20, pady=20)

                # åˆ›å»ºæ»šåŠ¨æ¡å’Œæ–‡æœ¬æ¡† - ç¾åŒ–ç‰ˆæœ¬
                text_container = tk.Frame(content_frame, bg='#ffffff', relief='solid', bd=1)
                text_container.pack(fill="both", expand=True)
                
                result_text = tk.Text(text_container, 
                                    height=30, width=100, 
                                    wrap=tk.WORD, 
                                    font=('Consolas', 10),
                                    bg='#ffffff',
                                    fg='#2c3e50',
                                    selectbackground='#3498db',
                                    selectforeground='white',
                                    insertbackground='#2c3e50',
                                    relief='flat',
                                    padx=15, pady=15)
                
                result_scrollbar = ttk.Scrollbar(text_container, orient="vertical", command=result_text.yview)
                result_text.configure(yscrollcommand=result_scrollbar.set)

                result_text.pack(side="left", fill="both", expand=True)
                result_scrollbar.pack(side="right", fill="y")
                
                # æ·»åŠ åº•éƒ¨æŒ‰éˆ•å€åŸŸ
                button_frame = tk.Frame(analysis_window, bg='#FFFFFF', height=60)
                button_frame.pack(fill="x", padx=20, pady=(0, 20))
                button_frame.pack_propagate(False)
                
                # é—œé–‰æŒ‰éˆ•
                close_btn = tk.Button(button_frame, 
                                    text="âŒ é—œé–‰ / Close",
                                    command=close_analysis_window,
                                    font=('Arial', 10, 'bold'),
                                    bg='#e74c3c', fg='white',
                                    relief='flat', bd=0,
                                    padx=20, pady=8,
                                    cursor='hand2')
                close_btn.pack(side="right", pady=15)
                
                # å°å‡ºæŒ‰éˆ•
                export_btn = tk.Button(button_frame, 
                                     text="ğŸ“„ å°å‡ºå ±å‘Š / Export Report",
                                     command=lambda: self.export_analysis_report(result_text.get(1.0, tk.END)),
                                     font=('Arial', 10, 'bold'),
                                     bg='#27ae60', fg='white',
                                     relief='flat', bd=0,
                                     padx=20, pady=8,
                                     cursor='hand2')
                export_btn.pack(side="right", padx=(0, 10), pady=15)

                # è°ƒç”¨åˆ†æå’Œæ‰§è¡Œåˆ†æ
                outlet_filters = selected_record.get('outlets', [])
                product_filters = selected_record.get('products', [])
                payment_filters = selected_record.get('payment_methods', [])  # è·å–æ”¯ä»˜æ–¹å¼ç­›é€‰
                date_from_str = selected_record.get('date_from', '')
                date_to_str = selected_record.get('date_to', '')
                
                # åˆå§‹åŒ–æ˜ŸæœŸç­›é€‰å˜é‡
                selected_weekdays = selected_record.get('weekdays', [])

                # å¦‚æœæ˜¯å‘¨æœŸæ€§æ´»åŠ¨ï¼Œéœ€è¦è®¡ç®—å®é™…æ—¥æœŸ
                if selected_record.get('type') == 'weekly':
                    from datetime import datetime, timedelta
                    weekday_names = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥']
                    selected_weekdays = selected_record.get('weekdays', [])

                    # æ‰¾åˆ°æ‰€æœ‰ç¬¦åˆçš„æ—¥æœŸ
                    start_date = datetime.strptime(date_from_str, '%Y-%m-%d')
                    end_date = datetime.strptime(date_to_str, '%Y-%m-%d')
                    all_target_dates = []

                    current = start_date
                    while current <= end_date:
                        weekday_name = weekday_names[current.weekday()]
                        if weekday_name in selected_weekdays:
                            all_target_dates.append(current)
                        current += timedelta(days=1)

                    # åˆæˆæ—¥æœŸèŒƒå›´
                    if all_target_dates:
                        date_from_str = min(all_target_dates).strftime('%Y-%m-%d')
                        date_to_str = max(all_target_dates).strftime('%Y-%m-%d')

                # è°ƒç”¨åˆ†æ
                print(f"ğŸ” é–‹å§‹åˆ†ææ´»å‹•: {activity_name}")
                print(f"ğŸ“Š åˆ†æåƒæ•¸:")
                print(f"   - æ—¥æœŸç¯„åœ: {date_from_str} åˆ° {date_to_str}")
                print(f"   - é–€å¸‚: {outlet_filters}")
                print(f"   - ç”¢å“: {product_filters}")
                print(f"   - æ”¯ä»˜æ–¹å¼: {payment_filters}")
                print(f"   - æ˜ŸæœŸ: {selected_weekdays}")
                print(f"   - æ•¸æ“šåº«: {current_db}")
                
                try:
                    print("ğŸš€ æº–å‚™èª¿ç”¨ perform_activity_analysis...")
                    print(f"ğŸ“Š èª¿ç”¨åƒæ•¸:")
                    print(f"   - result_text: {type(result_text)}")
                    print(f"   - date_from_str: {date_from_str}")
                    print(f"   - date_to_str: {date_to_str}")
                    print(f"   - outlet_filters: {outlet_filters}")
                    print(f"   - product_filters: {product_filters}")
                    print(f"   - current_db: {current_db}")
                    print(f"   - payment_filters: {payment_filters}")
                    print(f"   - selected_weekdays: {selected_weekdays}")
                    
                    # å…ˆæ’å…¥ä¸€äº›æ¸¬è©¦å…§å®¹ç¢ºä¿çª—å£æœ‰é¡¯ç¤º
                    result_text.insert(tk.END, "ğŸ” æ­£åœ¨åŸ·è¡Œæ´»å‹•åˆ†æ...\n", "header")
                    result_text.insert(tk.END, f"ğŸ“Š æ´»å‹•åç¨±: {activity_name}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š æ—¥æœŸç¯„åœ: {date_from_str} åˆ° {date_to_str}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š é–€å¸‚æ•¸é‡: {len(outlet_filters) if outlet_filters else 'å…¨éƒ¨'}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š ç”¢å“æ•¸é‡: {len(product_filters) if product_filters else 'å…¨éƒ¨'}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š æ”¯ä»˜æ–¹å¼: {len(payment_filters) if payment_filters else 'å…¨éƒ¨'}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š æ˜ŸæœŸç¯©é¸: {selected_weekdays if selected_weekdays else 'å…¨éƒ¨'}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š æ•¸æ“šåº«: {current_db}\n\n", "info")
                    result_text.update()
                    
                    self.perform_activity_analysis(result_text, date_from_str, date_to_str, outlet_filters, product_filters, current_db, payment_filters, selected_weekdays, False, None, None, False)
                    print("âœ… åˆ†æå®Œæˆ")
                except Exception as e:
                    print(f"âŒ åˆ†æéç¨‹ä¸­å‡ºç¾éŒ¯èª¤: {e}")
                    import traceback
                    error_details = traceback.format_exc()
                    print(f"è©³ç´°éŒ¯èª¤: {error_details}")
                    result_text.insert(tk.END, f"âŒ åˆ†æéç¨‹ä¸­å‡ºç¾éŒ¯èª¤: {e}\n", "error")
                    result_text.insert(tk.END, f"ğŸ” éŒ¯èª¤è©³æƒ…: {error_details}\n", "error")
                
                result_text.config(state=tk.DISABLED)

                # ä¸é—œé–‰æ´»å‹•è¨˜éŒ„çª—å£ï¼Œè®“ç”¨æˆ¶å¯ä»¥ç¹¼çºŒé¸æ“‡å…¶ä»–æ´»å‹•é€²è¡Œåˆ†æ
            else:
                print(f"âŒ æœªæ‰¾åˆ°æ´»å‹•è¨˜éŒ„ï¼Œæ´»å‹•ID: {activity_id}")
                print(f"ğŸ“Š å¯ç”¨è¨˜éŒ„ID: {[record.get('id') for record in records]}")
                tk.messagebox.showerror("éŒ¯èª¤", f"æœªæ‰¾åˆ°æ´»å‹•è¨˜éŒ„ï¼Œæ´»å‹•ID: {activity_id}")
                
        except Exception as e:
            print(f"âŒ å¾ä¸»çª—å£åˆ†ææ´»å‹•è¨˜éŒ„å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
            tk.messagebox.showerror("éŒ¯èª¤", f"åˆ†ææ´»å‹•è¨˜éŒ„å¤±æ•—: {e}")
    
    def analyze_activity(self):
        """åˆ†ææ´»åŠ¨æœŸé—´çš„ä¸šç»©æ•°æ® - æ”¯æŒåˆ†æé€‰ä¸­çš„æ´»åŠ¨è®°å½•"""
        try:
            print("ğŸ” ä¸»çª—å£åˆ†ææŒ‰éˆ•è¢«é»æ“Š")
            
            # é¦–å…ˆæª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­çš„æ´»å‹•è¨˜éŒ„
            if hasattr(self, 'activity_tree'):
                selection = self.activity_tree.selection()
                print(f"ğŸ“Š ä¸»çª—å£æ´»å‹•è¨˜éŒ„é¸ä¸­ç‹€æ…‹: {selection}")
                if selection:
                    print("âœ… æœ‰é¸ä¸­çš„æ´»å‹•è¨˜éŒ„ï¼Œä½¿ç”¨é¸ä¸­è¨˜éŒ„é€²è¡Œåˆ†æ")
                    # æœ‰é¸ä¸­çš„æ´»å‹•è¨˜éŒ„ï¼Œä½¿ç”¨é¸ä¸­è¨˜éŒ„çš„ä¿¡æ¯é€²è¡Œåˆ†æ
                    item = self.activity_tree.item(selection[0])
                    values = item['values']
                    activity_id = values[0]
                    print(f"ğŸ“Š é¸ä¸­çš„æ´»å‹•ID: {activity_id}")
                    
                    # ä½¿ç”¨èˆ‡è¨˜éŒ„æŸ¥çœ‹çª—å£ç›¸åŒçš„åˆ†æé‚è¼¯
                    self.analyze_selected_activity_from_main_window(activity_id)
                    return
                else:
                    print("âš ï¸ æ²’æœ‰é¸ä¸­çš„æ´»å‹•è¨˜éŒ„")
                    tk.messagebox.showwarning("æç¤º", "è«‹å…ˆåœ¨æ´»å‹•è¨˜éŒ„åˆ—è¡¨ä¸­é¸æ“‡ä¸€å€‹æ´»å‹•è¨˜éŒ„ï¼Œç„¶å¾Œå†é»æ“Šåˆ†ææŒ‰éˆ•")
                    return
                    
                    # æ‰¾åˆ°å°æ‡‰çš„æ´»å‹•è¨˜éŒ„
                    current_db = self.get_current_database()
                    records = self.activity_records.get(current_db, [])
                    
                    selected_record = None
                    for record in records:
                        if record['id'] == activity_id:
                            selected_record = record
                            break
                    
                    if selected_record:
                        # ä½¿ç”¨é¸ä¸­è¨˜éŒ„çš„ä¿¡æ¯
                        date_from_str = selected_record.get('date_from', '')
                        date_to_str = selected_record.get('date_to', '')
                        outlets = selected_record.get('outlets', [])
                        products = selected_record.get('products', [])
                        payment_methods = selected_record.get('payment_methods', [])
                        database = selected_record.get('database', current_db)
                        
                        # é€£æ¥åˆ°æ­£ç¢ºçš„æ•¸æ“šåº«
                        if not self.connect_to_activity_database(database):
                            tk.messagebox.showerror("é”™è¯¯", f"æ— æ³•è¿æ¥åˆ°æ•°æ®åº“: {database}")
                            return
                        
                        # å‰µå»ºåˆ†æçµæœçª—å£ - ç¾åŒ–ç‰ˆæœ¬
                        analysis_window = tk.Toplevel(self.root)
                        activity_name = selected_record.get('name', f"æ´»å‹• {activity_id}")
                        analysis_window.title(f"ğŸ“Š {activity_name} - æ´»å‹•æ¥­ç¸¾åˆ†æ / Activity Performance Analysis")
                        analysis_window.geometry("1200x800")
                        analysis_window.configure(bg='#FFFFFF')
                        
                        # è¨­ç½®çª—å£é—œé–‰å”è­° - ç¢ºä¿æ­£ç¢ºé—œé–‰
                        def close_analysis_window():
                            try:
                                analysis_window.destroy()
                            except:
                                pass
                        
                        analysis_window.protocol("WM_DELETE_WINDOW", close_analysis_window)
                        
                        # è¨­ç½®çª—å£åœ–æ¨™å’Œæ¨£å¼
                        try:
                            analysis_window.iconbitmap("SELOGO22 - 01.ico")
                        except:
                            pass

                        # æ¨™é¡Œå€åŸŸ
                        title_frame = tk.Frame(analysis_window, bg='#2c3e50', height=80)
                        title_frame.pack(fill="x")
                        title_frame.pack_propagate(False)
                        
                        title_label = tk.Label(title_frame, 
                                             text=f"ğŸ“Š {activity_name}",
                                             font=('Microsoft YaHei UI', 16, 'bold'),
                                             fg='white', bg='#2c3e50')
                        title_label.pack(side="left", padx=20, pady=20)
                        
                        subtitle_label = tk.Label(title_frame, 
                                                text="æ´»å‹•æ¥­ç¸¾åˆ†æ / Activity Performance Analysis",
                                                font=('Arial', 11),
                                                fg='#bdc3c7', bg='#2c3e50')
                        subtitle_label.pack(side="left", padx=(0, 20), pady=20)

                        # ä¸»å…§å®¹å€åŸŸ
                        content_frame = tk.Frame(analysis_window, bg='#FFFFFF')
                        content_frame.pack(fill="both", expand=True, padx=20, pady=20)
                        
                        # å‰µå»ºæ»¾å‹•æ¢å’Œæ–‡æœ¬æ¡† - ç¾åŒ–ç‰ˆæœ¬
                        text_container = tk.Frame(content_frame, bg='#ffffff', relief='solid', bd=1)
                        text_container.pack(fill="both", expand=True)
                        
                        result_text = tk.Text(text_container, 
                                            height=30, width=100, 
                                            wrap=tk.WORD, 
                                            font=('Consolas', 10),
                                            bg='#ffffff',
                                            fg='#2c3e50',
                                            selectbackground='#3498db',
                                            selectforeground='white',
                                            insertbackground='#2c3e50',
                                            relief='flat',
                                            padx=15, pady=15)
                        
                        result_scrollbar = ttk.Scrollbar(text_container, orient="vertical", command=result_text.yview)
                        result_text.configure(yscrollcommand=result_scrollbar.set)
                        
                        result_text.pack(side="left", fill="both", expand=True)
                        result_scrollbar.pack(side="right", fill="y")
                        
                        # æ·»åŠ åº•éƒ¨æŒ‰éˆ•å€åŸŸ
                        button_frame = tk.Frame(analysis_window, bg='#FFFFFF', height=60)
                        button_frame.pack(fill="x", padx=20, pady=(0, 20))
                        button_frame.pack_propagate(False)
                        
                        # é—œé–‰æŒ‰éˆ•
                        close_btn = tk.Button(button_frame, 
                                            text="âŒ é—œé–‰ / Close",
                                            command=close_analysis_window,
                                            font=('Arial', 10, 'bold'),
                                            bg='#e74c3c', fg='white',
                                            relief='flat', bd=0,
                                            padx=20, pady=8,
                                            cursor='hand2')
                        close_btn.pack(side="right", pady=15)
                        
                        # å°å‡ºæŒ‰éˆ•
                        export_btn = tk.Button(button_frame, 
                                             text="ğŸ“„ å°å‡ºå ±å‘Š / Export Report",
                                             command=lambda: self.export_analysis_report(result_text.get(1.0, tk.END)),
                                             font=('Arial', 10, 'bold'),
                                             bg='#27ae60', fg='white',
                                             relief='flat', bd=0,
                                             padx=20, pady=8,
                                             cursor='hand2')
                        export_btn.pack(side="right", padx=(0, 10), pady=15)
                        
                        # è™•ç†é€±æœŸæ€§æ´»å‹•
                        selected_weekdays = []
                        if selected_record.get('type') == 'weekly':
                            selected_weekdays = selected_record.get('weekdays', [])
                        
                        # èª¿ç”¨åˆ†æ
                        self.perform_activity_analysis(result_text, date_from_str, date_to_str, outlets, products, database, payment_methods, selected_weekdays, False, None, None, False)
                        result_text.config(state=tk.DISABLED)
                        
                        return
            
            # å¦‚æœæ²’æœ‰é¸ä¸­è¨˜éŒ„ï¼Œä½¿ç”¨è¡¨å–®ä¸­çš„è¨­ç½®é€²è¡Œåˆ†æ
            # è·å–æ´»åŠ¨ä¿¡æ¯
            date_from = self.activity_date_from.get_date()
            date_to = self.activity_date_to.get_date()
            outlets = self.activity_outlets.get_selected()
            products = self.activity_products.get_selected()
            
            # è·å–æ”¯ä»˜æ–¹å¼ç­›é€‰
            payment_methods = []
            if hasattr(self, 'activity_payment'):
                payment_methods = self.activity_payment.get_selected()
            
            # è·å–æ´»åŠ¨ç±»å‹
            activity_type = 'daily'
            if hasattr(self, 'activity_type'):
                activity_type = self.activity_type.get()
            
            # è·å–æ—¶é—´ç­›é€‰è®¾ç½®
            time_filter_enabled = False
            start_time = None
            end_time = None
            auto_time_range = False
            
            if activity_type == 'daily':
                # æ¯æ—¥æ´»åŠ¨æ—¶é—´ç­›é€‰
                if hasattr(self, 'time_filter_enabled') and self.time_filter_enabled.get():
                    time_filter_enabled = True
                    auto_time_range = hasattr(self, 'auto_time_range') and self.auto_time_range.get()
                    
                    if not auto_time_range:
                        # æ‰‹åŠ¨æ—¶é—´è®¾ç½®
                        start_time = self.start_time_entry.get().strip()
                        end_time = self.end_time_entry.get().strip()
                        
                        # éªŒè¯æ—¶é—´æ ¼å¼
                        try:
                            from datetime import datetime
                            datetime.strptime(start_time, '%H:%M')
                            datetime.strptime(end_time, '%H:%M')
                        except ValueError:
                            tk.messagebox.showerror("é”™è¯¯", "æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ HH:MM æ ¼å¼ï¼ˆå¦‚ 12:00ï¼‰")
                            return
            else:
                # é€±æœŸæ€§æ´»åŠ¨æ—¶é—´ç­›é€‰
                if hasattr(self, 'weekly_time_filter_enabled') and self.weekly_time_filter_enabled.get():
                    time_filter_enabled = True
                    auto_time_range = hasattr(self, 'weekly_auto_time_range') and self.weekly_auto_time_range.get()
                    
                    if not auto_time_range:
                        # æ‰‹åŠ¨æ—¶é—´è®¾ç½®
                        start_time = self.weekly_start_time_entry.get().strip()
                        end_time = self.weekly_end_time_entry.get().strip()
                        
                        # éªŒè¯æ—¶é—´æ ¼å¼
                        try:
                            from datetime import datetime
                            datetime.strptime(start_time, '%H:%M')
                            datetime.strptime(end_time, '%H:%M')
                        except ValueError:
                            tk.messagebox.showerror("é”™è¯¯", "æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ HH:MM æ ¼å¼ï¼ˆå¦‚ 12:00ï¼‰")
                            return
            
            # éªŒè¯è¾“å…¥
            if not date_from or not date_to:
                tk.messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æ´»åŠ¨æ—¥æœŸèŒƒå›´")
                return
            
            if not outlets:
                # å¦‚æœæ²’æœ‰é¸æ“‡é–€å¸‚ï¼Œä½¿ç”¨æ‰€æœ‰å¯ç”¨é–€å¸‚
                outlets = self.available_outlets if hasattr(self, 'available_outlets') and self.available_outlets else []
                if not outlets:
                    # æª¢æŸ¥æ•¸æ“šåº«é€£æ¥ç‹€æ…‹
                    if not self.db_manager.connection:
                        tk.messagebox.showerror("é”™è¯¯", "æ•°æ®åº“æœªè¿æ¥ï¼Œè¯·å…ˆè¿æ¥æ•°æ®åº“")
                        return
                    
                    # å˜—è©¦å¾æ•¸æ“šåº«ç®¡ç†å™¨ç²å–é–€å¸‚åˆ—è¡¨
                    try:
                        outlets = self.db_manager.get_outlets()
                        if outlets:
                            self.available_outlets = outlets
                            print(f"âœ… å·²å¾æ•¸æ“šåº«ç²å– {len(outlets)} å€‹é–€å¸‚")
                        else:
                            tk.messagebox.showerror("é”™è¯¯", "æ— æ³•è·å–é—¨å¸‚åˆ—è¡¨ï¼Œè¯·å…ˆè¿æ¥æ•°æ®åº“å¹¶åˆ·æ–°é—¨å¸‚æ•°æ®")
                            return
                    except Exception as e:
                        print(f"ç²å–é–€å¸‚åˆ—è¡¨å¤±æ•—: {e}")
                        tk.messagebox.showerror("é”™è¯¯", f"æ— æ³•è·å–é—¨å¸‚åˆ—è¡¨: {str(e)}")
                return
            
            if not products:
                tk.messagebox.showwarning("æç¤º", "æœªé€‰æ‹©äº§å“ï¼Œå°†åˆ†ææ‰€æœ‰äº§å“")
                products = []
            
            # è®¡ç®—å‘¨æœŸæ€§æ´»åŠ¨çš„æ‰€æœ‰ç›¸å…³æ—¥æœŸ
            actual_date_from = date_from
            actual_date_to = date_to
            
            if activity_type == 'weekly' and hasattr(self, 'weekday_vars'):
                # å¯»æ‰¾æ—¶é—´æ®µå†…æŒ‡å®šæ˜ŸæœŸå‡ çš„æ‰€æœ‰æ—¥æœŸ
                from datetime import timedelta
                weekday_names = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥']
                selected_weekdays = [day for day, var in self.weekday_vars.items() if var.get()]
                
                if selected_weekdays:
                    # è·å–æ‰€æœ‰éœ€è¦åˆ†æçš„æ—¥æœŸ
                    analysis_dates = []
                    current_date = date_from
                    while current_date <= date_to:
                        weekday_name = weekday_names[current_date.weekday()]
                        if weekday_name in selected_weekdays:
                            analysis_dates.append(current_date)
                        current_date += timedelta(days=1)
                    
                    if analysis_dates:
                        actual_date_from = min(analysis_dates)
                        actual_date_to = max(analysis_dates)
                        print(f"ğŸ“… å‘¨æœŸæ€§æ´»åŠ¨ - å®é™…åˆ†ææ—¥æœŸ: {[d.strftime('%Y-%m-%d') for d in analysis_dates]}")
            
            # è½¬æ¢æ—¥æœŸæ ¼å¼
            date_from_str = actual_date_from.strftime('%Y-%m-%d')
            date_to_str = actual_date_to.strftime('%Y-%m-%d')
            
            # è¿æ¥æ•°æ®åº“
            current_db = self.activity_database.get()
            if not current_db:
                tk.messagebox.showerror("é”™è¯¯", "è¯·å…ˆé€‰æ‹©æ•°æ®åº“")
                return
            
            # ä½¿ç”¨æ´»åŠ¨æ•°æ®åº“è¿æ¥æ–¹æ³•
            if not self.connect_to_activity_database(current_db):
                tk.messagebox.showerror("é”™è¯¯", f"æ— æ³•è¿æ¥åˆ° {current_db} æ•°æ®åº“")
                return
            
            # åˆ›å»ºåˆ†æç»“æœçª—å£
            analysis_window = tk.Toplevel(self.activity_window)
            analysis_window.title("ğŸ“Š æ´»åŠ¨ä¸šç»©åˆ†æ / Activity Performance Analysis")
            analysis_window.geometry("1000x700")
            analysis_window.transient(self.activity_window)
            
            # è¨­ç½®çª—å£é—œé–‰å”è­° - ç¢ºä¿æ­£ç¢ºé—œé–‰
            def close_analysis_window():
                try:
                    analysis_window.destroy()
                except:
                    pass
            
            analysis_window.protocol("WM_DELETE_WINDOW", close_analysis_window)
            
            # ä¸»æ¡†æ¶
            main_frame = tk.Frame(analysis_window)
            main_frame.pack(fill="both", expand=True, padx=10, pady=10)
            
            # æ ‡é¢˜
            title_label = tk.Label(main_frame, text="ğŸ“Š æ´»åŠ¨ä¸šç»©åˆ†ææŠ¥å‘Š / Activity Performance Analysis Report", 
                                   font=('Arial', 14, 'bold'))
            title_label.pack(pady=(0, 20))
            
            # åˆ†æä¿¡æ¯
            info_frame = tk.LabelFrame(main_frame, text="ğŸ“‹ åˆ†æä¿¡æ¯ / Analysis Information")
            info_frame.pack(fill="x", pady=(0, 10))
            
            info_text = f"ğŸ“… æ´»åŠ¨æœŸé—´: {date_from_str} è‡³ {date_to_str}\n"
            info_text += f"ğŸª æ¶‰åŠé—¨å¸‚: {', '.join(outlets)}\n"
            info_text += f"ğŸ£ æ¶‰åŠäº§å“: {', '.join(products) if products else 'å…¨éƒ¨äº§å“'}\n"
            info_text += f"ğŸ’³ æ”¯ä»˜æ–¹å¼: {', '.join(payment_methods) if payment_methods else 'å…¨éƒ¨æ”¯ä»˜æ–¹å¼'}\n"
            info_text += f"ğŸ—„ï¸ æ•°æ®æº: {current_db}\n"
            
            tk.Label(info_frame, text=info_text, font=('Arial', 10)).pack(anchor="w")
            
            # åˆ†æç»“æœåŒºåŸŸ
            result_frame = tk.LabelFrame(main_frame, text="ğŸ“ˆ åˆ†æç»“æœ / Analysis Results")
            result_frame.pack(fill="both", expand=True)
            
            # åˆ›å»ºæ–‡æœ¬æ˜¾ç¤ºåŒºåŸŸ
            result_text = tk.Text(result_frame, height=20, width=80, wrap=tk.WORD, font=('Consolas', 9))
            result_scrollbar = ttk.Scrollbar(result_frame, orient="vertical", command=result_text.yview)
            result_text.configure(yscrollcommand=result_scrollbar.set)
            
            result_text.pack(side="left", fill="both", expand=True)
            result_scrollbar.pack(side="right", fill="y")
            
            # è®°å½•å®é™…ä½¿ç”¨çš„æ•°æ®åº“å’Œè°ƒè¯•ä¿¡æ¯
            db_report = self.db_manager.current_database if hasattr(self.db_manager, 'current_database') else "æœªç¡®å®š"
            result_text.insert(tk.END, f"ğŸ“‹ åˆ†æçš„æ•°æ®åº“: {db_report}\n")
            result_text.insert(tk.END, f"ğŸ“‹ é€‰å®šçš„æ•°æ®åº“: {current_db}\n")
            result_text.insert(tk.END, f"{'=' * 60}\n")
            
            # å¼€å§‹åˆ†æ
            self.perform_activity_analysis(result_text, date_from_str, date_to_str, outlets, products, current_db, payment_methods, None, time_filter_enabled, start_time, end_time, auto_time_range)
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"æ´»åŠ¨åˆ†æå¤±è´¥: {e}")
        finally:
            if hasattr(self, 'db_manager') and self.db_manager.connection:
                self.db_manager.disconnect()
    
    def perform_activity_analysis(self, result_text, date_from, date_to, outlets, products, database, payment_methods=None, weekday_filters=None, time_filter_enabled=False, start_time=None, end_time=None, auto_time_range=False):
        """æ‰§è¡Œæ´»åŠ¨ä¸šç»©åˆ†æ - é‡æ–°è®¾è®¡ç‰ˆæœ¬æ”¯æŒæ”¯ä»˜æ–¹å¼ç­›é€‰å’Œåˆ†åˆ«ä¸šç»©è®¡ç®—"""
        try:
            print(f"ğŸ” perform_activity_analysis é–‹å§‹åŸ·è¡Œ")
            print(f"ğŸ“Š åƒæ•¸: date_from={date_from}, date_to={date_to}, database={database}")
            print(f"ğŸ“Š outlets={outlets}, products={products}, payment_methods={payment_methods}")
            print(f"ğŸ“Š weekday_filters={weekday_filters}")
            
            # æª¢æŸ¥æ•¸æ“šåº«é€£æ¥
            if not hasattr(self, 'db_manager') or not self.db_manager.connection:
                print("âŒ æ•¸æ“šåº«æœªé€£æ¥ï¼Œå˜—è©¦é‡æ–°é€£æ¥...")
                if not self.connect_to_activity_database(database):
                    result_text.insert(tk.END, f"âŒ ç„¡æ³•é€£æ¥åˆ°æ•¸æ“šåº«: {database}\n", "error")
                    return
                print("âœ… æ•¸æ“šåº«é€£æ¥æˆåŠŸ")
            
            # é…ç½®æ–‡æœ¬æ¨£å¼
            print("ğŸ¨ é…ç½®æ–‡æœ¬æ¨£å¼...")
            self.configure_analysis_text_styles(result_text)
            print("âœ… æ–‡æœ¬æ¨£å¼é…ç½®å®Œæˆ")
            
            result_text.insert(tk.END, "ğŸ” æ­£åœ¨åˆ†ææ´»åŠ¨ä¸šç»©æ•°æ®...\n", "header")
            result_text.insert(tk.END, f"ğŸ“Š å½“å‰è¿æ¥æ•°æ®åº“: {database}\n", "info")
            result_text.insert(tk.END, f"ğŸ“Š æ•°æ®åº“ç®¡ç†å™¨è¿æ¥çŠ¶æ€: {self.db_manager.current_database}\n\n", "info")
            print("âœ… åˆå§‹ä¿¡æ¯å·²æ’å…¥åˆ°æ–‡æœ¬çª—å£")
            
            # å¼·åˆ¶åˆ·æ–°æ–‡æœ¬çª—å£
            result_text.update()
            print("âœ… æ–‡æœ¬çª—å£å·²åˆ·æ–°")

            # æ˜¾ç¤ºç­›é€‰æ¡ä»¶
            result_text.insert(tk.END, "ğŸ“‹ ç­›é€‰æ¡ä»¶ / Filter Conditions\n", "result_header")
            result_text.insert(tk.END, "=" * 60 + "\n", "separator")
            result_text.insert(tk.END, f"ğŸ“… æ—¥æœŸèŒƒå›´: {date_from} è‡³ {date_to}\n", "condition")

            # æ˜¾ç¤ºé—¨å¸‚ç­›é€‰
            available_outlets = getattr(self, 'available_outlets', [])
            if outlets and available_outlets and len(outlets) < len(available_outlets):
                # æœ‰ç­›é€‰é—¨å¸‚ï¼Œæ˜¾ç¤º All, Except: ...
                except_outlets = [o for o in available_outlets if o not in outlets]
                result_text.insert(tk.END, f"ğŸª æ¶‰åŠé—¨å¸‚: All, Except: {', '.join(except_outlets)}\n", "condition")
            else:
                result_text.insert(tk.END, f"ğŸª æ¶‰åŠé—¨å¸‚: All\n", "condition")

            if products:
                result_text.insert(tk.END, f"ğŸ£ äº§å“: {', '.join(products)}\n", "condition")
            else:
                result_text.insert(tk.END, "ğŸ£ äº§å“: æ‰€æœ‰äº§å“\n", "condition")

            if payment_methods and len(payment_methods) > 0:
                result_text.insert(tk.END, f"ğŸ’³ æ”¯ä»˜æ–¹å¼: {', '.join(payment_methods)}\n", "condition")
            else:
                result_text.insert(tk.END, "ğŸ’³ æ”¯ä»˜æ–¹å¼: æ‰€æœ‰æ”¯ä»˜æ–¹å¼\n", "condition")

            if weekday_filters and len(weekday_filters) > 0:
                result_text.insert(tk.END, f"ğŸ—“ï¸ æ˜ŸæœŸ: {', '.join(weekday_filters)}\n", "condition")
            else:
                result_text.insert(tk.END, "ğŸ—“ï¸ æ˜ŸæœŸ: æ‰€æœ‰æ˜ŸæœŸ\n", "condition")
            
            # æ˜¾ç¤ºæ—¶é—´ç­›é€‰æ¡ä»¶
            if time_filter_enabled:
                if auto_time_range:
                    result_text.insert(tk.END, "â° æ—¶é—´ç­›é€‰: ä»ç¬¬ä¸€ä»¶åˆ°æœ€å¾Œä¸€ä»¶ç”¢å“éŠ·å”®æ™‚é–“\n", "condition")
                elif start_time and end_time:
                    result_text.insert(tk.END, f"â° æ—¶é—´ç­›é€‰: {start_time} è‡³ {end_time}\n", "condition")
                else:
                    result_text.insert(tk.END, "â° æ—¶é—´ç­›é€‰: å·²å¯ç”¨\n", "condition")
            else:
                result_text.insert(tk.END, "â° æ—¶é—´ç­›é€‰: æœªå¯ç”¨\n", "condition")
            
            # æ‰§è¡Œæ–°çš„åˆ†æé€»è¾‘
            # éªŒè¯åˆ†ææ•°æ®å‰ç¡®ä¿è¿æ¥æ­£å¸¸
            if not hasattr(self, 'db_manager') or not self.db_manager.connection:
                result_text.insert(tk.END, "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œæ— æ³•è·å–æ•°æ®\n")
                return
            
            # 1. å…ˆè·å–ç­›é€‰æ¡ä»¶ä¸‹çš„æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºè®¡ç®—æ€»ä¸šç»©ï¼‰- åªç­›é€‰æ˜ŸæœŸå’Œé—¨å¸‚ï¼Œä¸ç­›é€‰äº§å“å’Œæ”¯ä»˜æ–¹å¼
            all_data = self.db_manager.get_sales_data(
                date_from=date_from, date_to=date_to,
                outlet_filters=outlets,
                product_filters=[], # ä¸é™åˆ¶äº§å“ï¼Œè·å–æ‰€æœ‰äº§å“æ•°æ®
                weekday_filters=weekday_filters, # æ·»åŠ æ˜ŸæœŸç­›é€‰
                use_excel_cache=True  # ä¼˜å…ˆä½¿ç”¨å·²å¯¼å‡ºçš„ç¼“å­˜æ–‡ä»¶ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“
            )
            
            # éªŒè¯æŸ¥è¯¢åˆ°çš„æ•°æ®æ¥æº
            if not all_data:
                result_text.insert(tk.END, "âŒ æœªæ‰¾åˆ°ä¸šç»©æ•°æ®\n")
                return
            
            # ===== é‡æ–°è®¾è®¡çš„åˆ†æé€»è¾‘ =====
            # æŒ‰å•æ®çº§åˆ«æ±‡æ€»è®¡ç®—æ€»ä¸šç»©ï¼ˆåªè®¡ç®—ç­›é€‰çš„æ˜ŸæœŸæ•°æ®ï¼‰- ä½¿ç”¨ä¸å…¶ä»–åˆ†æåŠŸèƒ½ä¸€è‡´çš„è®¡ç®—æ–¹å¼ï¼ŒåŒ…æ‹¬æ‰£é™¤cancel_sales
            receipt_totals = {}

            # è·å–æ‰€æœ‰ç›¸å…³çš„cancelæ•°æ®
            cancel_data = {}
            try:
                cancel_keys = set()
                for r in all_data:
                    sales_no = r.get('sales_no', '')
                    store_name = r.get('store_name', '')
                    cancel_keys.add(f"{store_name}-{sales_no}")

                if cancel_keys:
                    cancel_cursor = self.db_manager.connection.cursor()
                    cancel_conditions = []
                    cancel_params = []
                    for key in cancel_keys:
                        store_name, sales_no = key.split('-', 1)
                        cancel_conditions.append("(store_name = ? AND sales_no = ?)")
                        cancel_params.extend([store_name, sales_no])

                    if cancel_conditions:
                        cancel_query = f"""
                            SELECT store_name, sales_no,
                                CAST(sub_total as FLOAT) - CAST(ISNULL(pro_disc_amt, 0) as FLOAT) +
                                CAST(ISNULL(svc_amt, 0) as FLOAT) -
                                CASE WHEN take_away_item = 'Y' THEN CAST(ISNULL(tax_amt, 0) as FLOAT) ELSE 0 END as cancel_amount
                            FROM {TABLE_CANCEL}
                            WHERE {' OR '.join(cancel_conditions)}
                        """
                        cancel_cursor.execute(cancel_query, cancel_params)
                        cancel_results = cancel_cursor.fetchall()

                        for cancel_row in cancel_results:
                            key = f"{cancel_row[0]}-{cancel_row[1]}"
                            cancel_data[key] = float(cancel_row[2]) if cancel_row[2] else 0.0

                    cancel_cursor.close()
            except Exception as e:
                print(f"è·å–cancelæ•°æ®å¤±è´¥: {e}")

            for r in all_data:
                sales_no = r.get('sales_no', '')
                store_name = r.get('store_name', '')
                receipt_key = f"{store_name}-{sales_no}"

                # ä½¿ç”¨ä¸å…¶ä»–åˆ†æåŠŸèƒ½ä¸€è‡´çš„ä¸šç»©è®¡ç®—æ–¹å¼
                sub_total = float(r.get('sub_total', 0))
                pro_disc_amt = float(r.get('pro_disc_amt', 0))
                svc_amt = float(r.get('svc_amt', 0))
                tax_amt = float(r.get('tax_amt', 0))
                take_away_item = str(r.get('take_away_item', 'N'))

                # æ ¹æ®æ•°æ®åº“ç±»å‹è®¡ç®—ä¸šç»©
                if self.db_manager.current_database == "sushi_gogo_pos_live":
                    # GOGOæ•°æ®åº“ï¼šæ‰€æœ‰å•æ®éƒ½ç›´æ¥å‡å»tax_amt
                    net_amount = sub_total - pro_disc_amt + svc_amt - tax_amt
                else:
                    # Expressæ•°æ®åº“ï¼šåªæœ‰å¤–å¸¦å•†å“æ‰å‡å»tax_amt
                    if take_away_item == 'Y':
                        net_amount = sub_total - pro_disc_amt + svc_amt - tax_amt
                    else:
                        net_amount = sub_total - pro_disc_amt + svc_amt

                # æ‰£é™¤cancel_sales
                cancel_amount = cancel_data.get(receipt_key, 0.0)
                net_amount -= cancel_amount

                if receipt_key not in receipt_totals:
                    receipt_totals[receipt_key] = 0.0
                receipt_totals[receipt_key] += net_amount

            # è®¡ç®—ç­›é€‰çš„æ˜ŸæœŸæ•°æ®çš„æ€»ä¸šç»©ï¼ˆæŒ‰å•æ®æ±‡æ€»çš„æ­£ç¡®æ€»é¢ï¼‰
            total_amount_all = sum(receipt_totals.values())
            total_receipts_all = len(receipt_totals)

            # all_dataå·²ç»åŒ…å«äº†æ”¯ä»˜æ–¹å¼ç­›é€‰ï¼Œç›´æ¥ä½¿ç”¨
            filtered_data = all_data
            
            # è™•ç†æ”¯ä»˜æ–¹å¼åƒæ•¸ - ç¢ºä¿è®Šé‡å§‹çµ‚è¢«å®šç¾©
            payment_methods_list = []
            if payment_methods:
                # ç¡®ä¿payment_methods_listæ˜¯åˆ—è¡¨æ ¼å¼ï¼ˆç”¨äºåç»­æ˜¾ç¤ºï¼‰
                if isinstance(payment_methods, str):
                    if ',' in payment_methods:
                        payment_methods_list = [pm.strip() for pm in payment_methods.split(',')]
                    else:
                        payment_methods_list = [payment_methods] if payment_methods else []
                else:
                    payment_methods_list = payment_methods

            # è®¡ç®—äº§å“ä¸šç»©ï¼ˆå¦‚æœæŒ‡å®šäº§å“ï¼‰- ä½¿ç”¨ä¸æœŸé—´-äº§å“æ•°æ®å®Œå…¨ç›¸åŒçš„SQLæŸ¥è¯¢æ–¹å¼
            product_amount = 0
            product_receipts = 0
            product_quantity = 0
            if products:
                try:
                    # æ„å»ºä¸æœŸé—´-äº§å“æ•°æ®ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶
                    conditions = []
                    params = []
                    
                    # æ—¥æœŸç­›é€‰
                    if date_from and date_to:
                        conditions.append("CAST(s.c_date as DATE) >= ?")
                        conditions.append("CAST(s.c_date as DATE) <= ?")
                        params.extend([date_from, date_to])
                    
                    # é—¨å¸‚ç­›é€‰
                    if outlets:
                        placeholders = ','.join(['?' for _ in outlets])
                        conditions.append(f"s.store_name IN ({placeholders})")
                        params.extend(outlets)
                    
                    # æ˜ŸæœŸç­›é€‰
                    if weekday_filters:
                        weekday_conditions = []
                        weekday_map = {
                            'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                            'Thursday': 4, 'Friday': 5, 'Saturday': 6
                        }
                        for weekday in weekday_filters:
                            weekday_num = weekday_map.get(weekday, 0)
                            weekday_conditions.append(f"DATEPART(WEEKDAY, s.c_date) = {weekday_num + 1}")
                        if weekday_conditions:
                            conditions.append(f"({' OR '.join(weekday_conditions)})")
                    
                    # äº§å“ç­›é€‰
                    if products:
                        placeholders = ','.join(['?' for _ in products])
                        conditions.append(f"s.item_name IN ({placeholders})")
                        params.extend(products)
                    
                    # æ”¯ä»˜æ–¹å¼ç­›é€‰ - ä¸¥æ ¼åŒ¹é…ï¼Œä¸æœŸé—´-äº§å“æ•°æ®ä¿æŒä¸€è‡´
                    if payment_methods:
                        placeholders = ','.join(['?' for _ in payment_methods])
                        conditions.append(f"""NOT EXISTS (
                            SELECT 1 FROM {TABLE_PAYMENT} p
                            WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name
                            AND p.payment_name NOT IN ({placeholders})
                        )""")
                        params.extend(payment_methods)
                    
                    # æ’é™¤wastageä¸»äº§å“
                    conditions.append("s.item_name != 'WASTAGE'")
                    
                    # æ„å»ºWHEREå­å¥
                    where_clause = ""
                    if conditions:
                        where_clause = " WHERE " + " AND ".join(conditions)
                    
                    # ä½¿ç”¨ä¸æœŸé—´-äº§å“æ•°æ®å®Œå…¨ç›¸åŒçš„SQLæŸ¥è¯¢
                    product_query = f"""
                        SELECT
                            s.item_name as äº§å“åç§°,
                            SUM({self.db_manager.get_performance_calculation_sql()} - 
                                ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                            COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                            SUM(CAST(s.qty as FLOAT)) as é”€å”®æ€»æ•°
                        FROM {TABLE_SALES} s WITH (NOLOCK)
                        LEFT JOIN (
                            SELECT 
                                sales_no, 
                                store_name, 
                                item_name,
                                SUM({self.db_manager._get_cancel_performance_calculation_sql()}) as cancel_amount
                            FROM {TABLE_CANCEL} WITH (NOLOCK)
                            GROUP BY sales_no, store_name, item_name
                        ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                        {where_clause}
                        GROUP BY s.item_name
                        ORDER BY æ€»ä¸šç»© DESC
                        OPTION (RECOMPILE, MAXDOP 4)
                    """
                    
                    cursor = self.db_manager.connection.cursor()
                    cursor.execute(product_query, params)
                    product_results = cursor.fetchall()
                    cursor.close()
                    
                    # è®¡ç®—äº§å“ä¸šç»© - ä¸šç§¯å’Œæ•°é‡å¯ä»¥åŠ æ€»ï¼Œä½†å•æ®æ•°éœ€è¦é‡æ–°è®¡ç®—å”¯ä¸€å•æ®
                    for row in product_results:
                        product_amount += float(row[1]) if row[1] else 0.0
                        # product_receipts += int(row[2]) if row[2] else 0  # æ³¨é‡Šæ‰ï¼šä¸åŠ æ€»æ¯è¡Œçš„å•æ®æ•°
                        product_quantity += float(row[3]) if row[3] else 0.0
                    
                    # é‡æ–°è¨ˆç®—åŒ…å«æŒ‡å®šç”¢å“çš„å”¯ä¸€å–®æ“šæ•¸
                    if conditions:
                        # é‡æ–°æŸ¥è©¢ç¨ç«‹çš„å”¯ä¸€å–®æ“šæ•¸
                        unique_receipt_query = f"""
                            SELECT COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as unique_receipt_count
                            FROM {TABLE_SALES} s WITH (NOLOCK)
                            LEFT JOIN (
                                SELECT 
                                    sales_no, 
                                    store_name, 
                                    item_name,
                                    SUM({self.db_manager._get_cancel_performance_calculation_sql()}) as cancel_amount
                                FROM {TABLE_CANCEL} WITH (NOLOCK)
                                GROUP BY sales_no, store_name, item_name
                            ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                            {where_clause}
                        """
                        
                        unique_cursor = self.db_manager.connection.cursor()
                        unique_cursor.execute(unique_receipt_query, params)
                        unique_result = unique_cursor.fetchone()
                        product_receipts = unique_result[0] if unique_result else 0
                        unique_cursor.close()
                    else:
                        product_receipts = 0
                    
                except Exception as e:
                    print(f"è·å–äº§å“ä¸šç»©å¤±è´¥: {e}")
                    product_amount = 0
                    product_receipts = 0
                    product_quantity = 0
            
            # ===== é‡æ–°è®¾è®¡çš„åˆ†æè¾“å‡ºæ ¼å¼ =====
            result_text.insert(tk.END, "\nğŸ“Š åˆ†æç»“æœ / Analysis Results\n", "result_header")
            result_text.insert(tk.END, "=" * 60 + "\n", "separator")

            # 1. æ˜¾ç¤ºæ€»ä¸šç»©ï¼ˆ11/9 & 22/9 çš„æ€»ä¸šç»©ï¼‰
            result_text.insert(tk.END, f"ğŸ“… æ€»ä¸šç»© / Total Performance: ${total_amount_all:,.2f}\n", "data")
            result_text.insert(tk.END, f"ğŸ“… æ€»å•æ®æ•° / Total Receipts: {total_receipts_all:,}\n", "data")
            
            # è¨ˆç®—ç¸½ç¯©é¸ç”¢å“æ¥­ç¸¾å’Œå–®æ“šæ•¸ï¼ˆæ‰€æœ‰æ”¯ä»˜æ–¹å¼çš„ç¸½å’Œï¼‰
            total_filtered_amount = 0
            total_filtered_receipts = 0

            # å…ˆè¨ˆç®—ç¸½ç¯©é¸ç”¢å“æ¥­ç¸¾ï¼Œç„¶å¾Œé¡¯ç¤º
            if products and payment_methods:
                # ç¢ºä¿payment_methods_listæ˜¯åˆ—è¡¨æ ¼å¼
                if isinstance(payment_methods, str):
                    if ',' in payment_methods:
                        payment_methods_list = [pm.strip() for pm in payment_methods.split(',')]
                    else:
                        payment_methods_list = [payment_methods] if payment_methods else []
                else:
                    payment_methods_list = payment_methods
                    
                # ç‚ºæ¯å€‹æ”¯ä»˜æ–¹å¼å–®ç¨æŸ¥è©¢ç”¢å“æ¥­ç¸¾ä¾†è¨ˆç®—ç¸½å’Œ
                for payment_method in payment_methods_list:
                    try:
                        # æ§‹å»ºæŸ¥è©¢æ¢ä»¶ - åªç¯©é¸ç•¶å‰æ”¯ä»˜æ–¹å¼
                        payment_conditions = []
                        payment_params = []

                        # æ—¥æœŸç­›é€‰
                        if date_from and date_to:
                            payment_conditions.append("CAST(s.c_date as DATE) >= ?")
                            payment_conditions.append("CAST(s.c_date as DATE) <= ?")
                            payment_params.extend([date_from, date_to])

                        # é—¨å¸‚ç­›é€‰
                        if outlets:
                            placeholders = ','.join(['?' for _ in outlets])
                            payment_conditions.append(f"s.store_name IN ({placeholders})")
                            payment_params.extend(outlets)

                        # æ˜ŸæœŸç­›é€‰
                        if weekday_filters:
                            weekday_conditions = []
                            weekday_map = {
                                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                                'Thursday': 4, 'Friday': 5, 'Saturday': 6
                            }
                            for weekday in weekday_filters:
                                weekday_num = weekday_map.get(weekday, 0)
                                weekday_conditions.append(f"DATEPART(WEEKDAY, s.c_date) = {weekday_num + 1}")
                            if weekday_conditions:
                                payment_conditions.append(f"({' OR '.join(weekday_conditions)})")

                        # äº§å“ç­›é€‰
                        if products:
                            placeholders = ','.join(['?' for _ in products])
                            payment_conditions.append(f"s.item_name IN ({placeholders})")
                            payment_params.extend(products)

                        # æ”¯ä»˜æ–¹å¼ç­›é€‰ - åªç­›é€‰å½“å‰æ”¯ä»˜æ–¹å¼
                        payment_conditions.append(f"NOT EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name AND p.payment_name NOT IN (?))")
                        payment_params.append(payment_method)

                        # æ’é™¤wastageä¸»äº§å“
                        payment_conditions.append("s.item_name != 'WASTAGE'")

                        # æ„å»ºWHEREå­å¥
                        payment_where_clause = ""
                        if payment_conditions:
                            payment_where_clause = " WHERE " + " AND ".join(payment_conditions)

                        # æŸ¥è¯¢è¯¥æ”¯ä»˜æ–¹å¼çš„äº§å“ä¸šç»©
                        payment_product_query = f"""
                            SELECT
                                SUM({self.db_manager.get_performance_calculation_sql()} -
                                    ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                                COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°
                            FROM {TABLE_SALES} s WITH (NOLOCK)
                            LEFT JOIN (
                                SELECT
                                    sales_no,
                                    store_name,
                                    item_name,
                                    SUM({self.db_manager._get_cancel_performance_calculation_sql()}) as cancel_amount
                                FROM {TABLE_CANCEL} WITH (NOLOCK)
                                GROUP BY sales_no, store_name, item_name
                            ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                            {payment_where_clause}
                            OPTION (RECOMPILE, MAXDOP 4)
                        """

                        cursor = self.db_manager.connection.cursor()
                        cursor.execute(payment_product_query, payment_params)
                        payment_product_result = cursor.fetchone()
                        cursor.close()

                        if payment_product_result:
                            payment_amount = float(payment_product_result[0]) if payment_product_result[0] else 0
                            payment_receipts = int(payment_product_result[1]) if payment_product_result[1] else 0
                            total_filtered_amount += payment_amount
                            total_filtered_receipts += payment_receipts

                    except Exception as e:
                        print(f"è®¡ç®—{payment_method}äº§å“ä¸šç»©å¤±è´¥: {e}")

            # é¡¯ç¤ºç¸½ç¯©é¸ç”¢å“æ¥­ç¸¾
            if total_filtered_amount > 0:
                result_text.insert(tk.END, f"ğŸ’° ç¸½ç¯©é¸ç”¢å“æ¥­ç¸¾ / Selected Product Sales: ${total_filtered_amount:,.2f}\n", "data")
                result_text.insert(tk.END, f"ğŸ§¾ ç¸½ç¯©é¸ç”¢å“å–®æ“šæ•¸ / Selected Product Transaction: {total_filtered_receipts:,}\n", "data")
                
                # è¨ˆç®—ä¸¦é¡¯ç¤ºç”¢å“ç¸½å æ¯”
                product_amount_ratio = (total_filtered_amount / total_amount_all * 100) if total_amount_all > 0 else 0
                product_receipt_ratio = (total_filtered_receipts / total_receipts_all * 100) if total_receipts_all > 0 else 0
                result_text.insert(tk.END, f"ğŸ“Š ç”¢å“æ¥­ç¸¾å æ¯” / Product Sales Ratio: {product_amount_ratio:.2f}%\n", "data")
                result_text.insert(tk.END, f"ğŸ“Š ç”¢å“å–®æ“šå æ¯” / Product Transaction Ratio: {product_receipt_ratio:.2f}%\n\n", "data")
            
            result_text.insert(tk.END, "=" * 60 + "\n", "separator")

            # 2. æŒ‰æ”¯ä»˜æ–¹å¼åˆ†åˆ«æ˜¾ç¤ºäº§å“ä¿¡æ¯ï¼ˆä¸æœŸé—´-äº§å“æ•°æ®ä¿æŒä¸€è‡´çš„æ˜¾ç¤ºæ–¹å¼ï¼‰
            if products and payment_methods:
                # ä¸ºæ¯ä¸ªæ”¯ä»˜æ–¹å¼å•ç‹¬æŸ¥è¯¢å’Œæ˜¾ç¤ºäº§å“ä¸šç»©
                for payment_method in payment_methods_list:
                    try:
                        # æ„å»ºæŸ¥è¯¢æ¡ä»¶ - åªç­›é€‰å½“å‰æ”¯ä»˜æ–¹å¼
                        payment_conditions = []
                        payment_params = []

                        # æ—¥æœŸç­›é€‰
                        if date_from and date_to:
                            payment_conditions.append("CAST(s.c_date as DATE) >= ?")
                            payment_conditions.append("CAST(s.c_date as DATE) <= ?")
                            payment_params.extend([date_from, date_to])

                        # é—¨å¸‚ç­›é€‰
                        if outlets:
                            placeholders = ','.join(['?' for _ in outlets])
                            payment_conditions.append(f"s.store_name IN ({placeholders})")
                            payment_params.extend(outlets)

                        # æ˜ŸæœŸç­›é€‰
                        if weekday_filters:
                            weekday_conditions = []
                            weekday_map = {
                                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                                'Thursday': 4, 'Friday': 5, 'Saturday': 6
                            }
                            for weekday in weekday_filters:
                                weekday_num = weekday_map.get(weekday, 0)
                                weekday_conditions.append(f"DATEPART(WEEKDAY, s.c_date) = {weekday_num + 1}")
                            if weekday_conditions:
                                payment_conditions.append(f"({' OR '.join(weekday_conditions)})")

                        # äº§å“ç­›é€‰
                        if products:
                            placeholders = ','.join(['?' for _ in products])
                            payment_conditions.append(f"s.item_name IN ({placeholders})")
                            payment_params.extend(products)

                        # æ”¯ä»˜æ–¹å¼ç­›é€‰ - åªç­›é€‰å½“å‰æ”¯ä»˜æ–¹å¼
                        payment_conditions.append(f"NOT EXISTS (SELECT 1 FROM {TABLE_PAYMENT} p WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name AND p.payment_name NOT IN (?))")
                        payment_params.append(payment_method)

                        # æ’é™¤wastageä¸»äº§å“
                        payment_conditions.append("s.item_name != 'WASTAGE'")

                        # æ„å»ºWHEREå­å¥
                        payment_where_clause = ""
                        if payment_conditions:
                            payment_where_clause = " WHERE " + " AND ".join(payment_conditions)

                        # æŸ¥è¯¢è¯¥æ”¯ä»˜æ–¹å¼çš„äº§å“ä¸šç»©
                        payment_product_query = f"""
                            SELECT
                                s.item_name as äº§å“åç§°,
                                SUM({self.db_manager.get_performance_calculation_sql()} -
                                    ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                                COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                                SUM(CAST(s.qty as FLOAT)) as é”€å”®æ€»æ•°
                            FROM {TABLE_SALES} s WITH (NOLOCK)
                            LEFT JOIN (
                                SELECT
                                    sales_no,
                                    store_name,
                                    item_name,
                                    SUM({self.db_manager._get_cancel_performance_calculation_sql()}) as cancel_amount
                                FROM {TABLE_CANCEL} WITH (NOLOCK)
                                GROUP BY sales_no, store_name, item_name
                            ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                            {payment_where_clause}
                            GROUP BY s.item_name
                            ORDER BY æ€»ä¸šç»© DESC
                            OPTION (RECOMPILE, MAXDOP 4)
                        """

                        cursor = self.db_manager.connection.cursor()
                        cursor.execute(payment_product_query, payment_params)
                        payment_product_results = cursor.fetchall()
                        cursor.close()

                        # æ˜¾ç¤ºè¯¥æ”¯ä»˜æ–¹å¼çš„äº§å“ä¸šç»©
                        if payment_product_results:
                            for row in payment_product_results:
                                payment_amount = float(row[1]) if row[1] else 0
                                payment_receipts = int(row[2]) if row[2] else 0
                                payment_quantity = float(row[3]) if row[3] else 0
                                
                                # ç¸½ç¯©é¸ç”¢å“æ¥­ç¸¾å·²åœ¨å‰é¢è¨ˆç®—ï¼Œé€™è£¡ä¸éœ€è¦é‡è¤‡ç´¯åŠ 
                                
                                result_text.insert(tk.END, f"ğŸ£ ç­›é€‰äº§å“ / Selected Product: {', '.join(products)}\n")
                                result_text.insert(tk.END, f"ğŸ’³ æ”¯ä»˜æ–¹å¼ / Payment Method: {payment_method}\n")
                                result_text.insert(tk.END, f"ğŸ’° äº§å“ä¸šç»© / Product Sales: ${payment_amount:,.2f}\n")
                                result_text.insert(tk.END, f"ğŸ§¾ äº§å“å•æ®æ•° / Product Transaction: {payment_receipts:,}\n")
                                result_text.insert(tk.END, f"ğŸ£ äº§å“æ•°é‡ / Product Quantity Sold: {payment_quantity:,.0f}\n")
                                
                                # è¨ˆç®—å æ¯” - ä¿®æ­£ï¼šä½¿ç”¨ç¸½ç¯©é¸ç”¢å“æ¥­ç¸¾ä¾†è¨ˆç®—å æ¯”ï¼Œè€Œä¸æ˜¯å–®å€‹æ”¯ä»˜æ–¹å¼
                                # é€™è£¡é¡¯ç¤ºçš„æ˜¯è©²æ”¯ä»˜æ–¹å¼åœ¨ç¸½æ¥­ç¸¾ä¸­çš„å æ¯”
                                amount_ratio = (payment_amount / total_amount_all * 100) if total_amount_all > 0 else 0
                                receipt_ratio = (payment_receipts / total_receipts_all * 100) if total_receipts_all > 0 else 0
                                result_text.insert(tk.END, f"ğŸ“Š æ”¯ä»˜æ–¹å¼æ¥­ç¸¾å æ¯” / Payment Method Sales Ratio %: {amount_ratio:.2f}%\n")
                                result_text.insert(tk.END, f"ğŸ“Š æ”¯ä»˜æ–¹å¼å–®æ“šå æ¯” / Payment Method Transaction Ratio %: {receipt_ratio:.2f}%\n")
                                result_text.insert(tk.END, "-" * 40 + "\n")

                    except Exception as e:
                        print(f"è·å–{payment_method}äº§å“ä¸šç»©å¤±è´¥: {e}")
                
                # ç¸½ç¯©é¸ç”¢å“æ¥­ç¸¾å·²åœ¨å‰é¢é¡¯ç¤º
                    
            elif products:
                # å¦‚æœæ²¡æœ‰æŒ‡å®šæ”¯ä»˜æ–¹å¼ï¼Œæ˜¾ç¤ºæ€»çš„äº§å“ä¸šç»©
                result_text.insert(tk.END, f"ğŸ£ ç­›é€‰äº§å“ / Selected Product: {', '.join(products)}\n")
                result_text.insert(tk.END, f"ğŸ’° äº§å“ä¸šç»© / Product Performance: ${product_amount:,.2f}\n")
                result_text.insert(tk.END, f"ğŸ§¾ äº§å“å•æ®æ•° / Product Receipts: {product_receipts}\n")
                result_text.insert(tk.END, f"ğŸ£ äº§å“æ•°é‡ / Product Quantity Sold: {product_quantity:,.0f}\n")

                # è®¡ç®—å æ¯”
                product_amount_ratio = (product_amount / total_amount_all * 100) if total_amount_all > 0 else 0
                product_receipt_ratio = (product_receipts / total_receipts_all * 100) if total_receipts_all > 0 else 0
                result_text.insert(tk.END, f"ğŸ“Š äº§å“ä¸šç»©å æ¯” / Performance Ratio: {product_amount_ratio:.2f}%\n")
                result_text.insert(tk.END, f"ğŸ“Š å•æ®å æ¯” / Receipt Ratio: {product_receipt_ratio:.2f}%\n")
                result_text.insert(tk.END, "-" * 40 + "\n")

            # é¡¯ç¤ºè©³ç´°åˆ†æçµæœ
            result_text.insert(tk.END, "\nğŸ“Š åˆ†æç»“æœ / Analysis Results\n", "result_header")
            result_text.insert(tk.END, "=" * 60 + "\n", "separator")
            
            # é¡¯ç¤ºç¸½æ¥­ç¸¾å’Œç¸½å–®æ“šæ•¸
            result_text.insert(tk.END, f"ğŸ’° æ€»ä¸šç»© / Total Performance: ${total_amount_all:,.2f}\n", "result")
            result_text.insert(tk.END, f"ğŸ§¾ æ€»å•æ®æ•° / Total Receipts: {total_receipts_all:,}\n", "result")
            
            # å¦‚æœæœ‰æŒ‡å®šç”¢å“ï¼Œé¡¯ç¤ºç”¢å“åˆ†æ
            if products:
                result_text.insert(tk.END, f"\nğŸ£ äº§å“åˆ†æ / Product Analysis\n", "result_header")
                result_text.insert(tk.END, "-" * 40 + "\n", "separator")
                result_text.insert(tk.END, f"ğŸ£ ç­›é€‰äº§å“ / Selected Product: {', '.join(products)}\n", "result")
                result_text.insert(tk.END, f"ğŸ’° äº§å“ä¸šç»© / Product Performance: ${product_amount:,.2f}\n", "result")
                result_text.insert(tk.END, f"ğŸ§¾ äº§å“å•æ®æ•° / Product Receipts: {product_receipts:,}\n", "result")
                result_text.insert(tk.END, f"ğŸ£ äº§å“æ•°é‡ / Product Quantity Sold: {product_quantity:,.0f}\n", "result")
                
                # è®¡ç®—å æ¯”
                product_amount_ratio = (product_amount / total_amount_all * 100) if total_amount_all > 0 else 0
                product_receipt_ratio = (product_receipts / total_receipts_all * 100) if total_receipts_all > 0 else 0
                result_text.insert(tk.END, f"ğŸ“Š äº§å“ä¸šç»©å æ¯” / Performance Ratio: {product_amount_ratio:.2f}%\n", "result")
                result_text.insert(tk.END, f"ğŸ“Š å•æ®å æ¯” / Receipt Ratio: {product_receipt_ratio:.2f}%\n", "result")
            
            # å¦‚æœæœ‰æŒ‡å®šæ”¯ä»˜æ–¹å¼ï¼Œé¡¯ç¤ºæ”¯ä»˜æ–¹å¼åˆ†æ
            if payment_methods_list:
                result_text.insert(tk.END, f"\nğŸ’³ æ”¯ä»˜æ–¹å¼åˆ†æ / Payment Method Analysis\n", "result_header")
                result_text.insert(tk.END, "-" * 40 + "\n", "separator")
                
                for payment_method in payment_methods_list:
                    try:
                        # æ§‹å»ºæ”¯ä»˜æ–¹å¼æŸ¥è©¢æ¢ä»¶
                        payment_conditions = []
                        payment_params = []
                        
                        # æ—¥æœŸç¯©é¸
                        if date_from and date_to:
                            payment_conditions.append("CAST(s.c_date as DATE) >= ?")
                            payment_conditions.append("CAST(s.c_date as DATE) <= ?")
                            payment_params.extend([date_from, date_to])
                        
                        # é–€å¸‚ç¯©é¸
                        if outlets:
                            placeholders = ','.join(['?' for _ in outlets])
                            payment_conditions.append(f"s.store_name IN ({placeholders})")
                            payment_params.extend(outlets)
                        
                        # æ˜ŸæœŸç¯©é¸
                        if weekday_filters:
                            weekday_conditions = []
                            weekday_map = {
                                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                                'Thursday': 4, 'Friday': 5, 'Saturday': 6
                            }
                            for weekday in weekday_filters:
                                weekday_num = weekday_map.get(weekday, 0)
                                weekday_conditions.append(f"DATEPART(WEEKDAY, s.c_date) = {weekday_num + 1}")
                            if weekday_conditions:
                                payment_conditions.append(f"({' OR '.join(weekday_conditions)})")
                        
                        # ç”¢å“ç¯©é¸
                        if products:
                            placeholders = ','.join(['?' for _ in products])
                            payment_conditions.append(f"s.item_name IN ({placeholders})")
                            payment_params.extend(products)
                        
                        # æ”¯ä»˜æ–¹å¼ç¯©é¸
                        payment_conditions.append(f"""EXISTS (
                            SELECT 1 FROM {TABLE_PAYMENT} p
                            WHERE p.sales_no = s.sales_no AND p.store_name = s.store_name
                            AND p.payment_name = ?
                        )""")
                        payment_params.append(payment_method)
                        
                        # æ’é™¤wastageä¸»ç”¢å“
                        payment_conditions.append("s.item_name != 'WASTAGE'")
                        
                        # æ§‹å»ºWHEREå­å¥
                        payment_where_clause = ""
                        if payment_conditions:
                            payment_where_clause = " WHERE " + " AND ".join(payment_conditions)
                        
                        # æŸ¥è©¢è©²æ”¯ä»˜æ–¹å¼çš„æ¥­ç¸¾
                        payment_query = f"""
                            SELECT
                                SUM({self.db_manager.get_performance_calculation_sql()} - 
                                    ISNULL(CAST(c.cancel_amount as FLOAT), 0)) as æ€»ä¸šç»©,
                                COUNT(DISTINCT CONCAT(s.store_name, '-', s.sales_no)) as æ€»å•æ®æ•°,
                                SUM(CAST(s.qty as FLOAT)) as é”€å”®æ€»æ•°
                            FROM {TABLE_SALES} s WITH (NOLOCK)
                            LEFT JOIN (
                                SELECT 
                                    sales_no, 
                                    store_name, 
                                    item_name,
                                    SUM({self.db_manager._get_cancel_performance_calculation_sql()}) as cancel_amount
                                FROM {TABLE_CANCEL} WITH (NOLOCK)
                                GROUP BY sales_no, store_name, item_name
                            ) c ON s.sales_no = c.sales_no AND s.store_name = c.store_name AND s.item_name = c.item_name
                            {payment_where_clause}
                            OPTION (RECOMPILE, MAXDOP 4)
                        """
                        
                        cursor = self.db_manager.connection.cursor()
                        cursor.execute(payment_query, payment_params)
                        payment_result = cursor.fetchone()
                        cursor.close()
                        
                        if payment_result and payment_result[0]:
                            payment_amount = float(payment_result[0]) if payment_result[0] else 0
                            payment_receipts = int(payment_result[1]) if payment_result[1] else 0
                            payment_quantity = float(payment_result[2]) if payment_result[2] else 0
                            
                            result_text.insert(tk.END, f"ğŸ’³ æ”¯ä»˜æ–¹å¼ / Payment Method: {payment_method}\n", "result")
                            result_text.insert(tk.END, f"ğŸ’° æ”¯ä»˜æ–¹å¼ä¸šç»© / Payment Sales: ${payment_amount:,.2f}\n", "result")
                            result_text.insert(tk.END, f"ğŸ§¾ æ”¯ä»˜æ–¹å¼å•æ®æ•° / Payment Transactions: {payment_receipts:,}\n", "result")
                            result_text.insert(tk.END, f"ğŸ£ æ”¯ä»˜æ–¹å¼æ•°é‡ / Payment Quantity: {payment_quantity:,.0f}\n", "result")
                            
                            # è¨ˆç®—å æ¯”
                            amount_ratio = (payment_amount / total_amount_all * 100) if total_amount_all > 0 else 0
                            receipt_ratio = (payment_receipts / total_receipts_all * 100) if total_receipts_all > 0 else 0
                            result_text.insert(tk.END, f"ğŸ“Š æ”¯ä»˜æ–¹å¼ä¸šç»©å æ¯” / Payment Sales Ratio: {amount_ratio:.2f}%\n", "result")
                            result_text.insert(tk.END, f"ğŸ“Š æ”¯ä»˜æ–¹å¼å•æ®å æ¯” / Payment Transaction Ratio: {receipt_ratio:.2f}%\n", "result")
                            result_text.insert(tk.END, "-" * 40 + "\n", "separator")
                        
                    except Exception as e:
                        print(f"è·å–{payment_method}ä¸šç»©å¤±è´¥: {e}")
                        result_text.insert(tk.END, f"âŒ è·å–{payment_method}ä¸šç»©å¤±è´¥: {str(e)}\n", "error")
            
            # é¡¯ç¤ºé–€å¸‚åˆ†æ
            if outlets and len(outlets) < len(available_outlets):
                result_text.insert(tk.END, f"\nğŸª é—¨å¸‚åˆ†æ / Outlet Analysis\n", "result_header")
                result_text.insert(tk.END, "-" * 40 + "\n", "separator")
                result_text.insert(tk.END, f"ğŸª æ¶‰åŠé—¨å¸‚ / Involved Outlets: {', '.join(outlets)}\n", "result")
                result_text.insert(tk.END, f"ğŸ“Š é—¨å¸‚æ•°é‡ / Outlet Count: {len(outlets)}\n", "result")
                result_text.insert(tk.END, f"ğŸ“Š æ€»é—¨å¸‚æ•°é‡ / Total Outlet Count: {len(available_outlets)}\n", "result")
                result_text.insert(tk.END, f"ğŸ“Š é—¨å¸‚è¦†ç›–ç‡ / Outlet Coverage: {(len(outlets) / len(available_outlets) * 100):.2f}%\n", "result")
            
            # é¡¯ç¤ºæ˜ŸæœŸåˆ†æ
            if weekday_filters:
                result_text.insert(tk.END, f"\nğŸ—“ï¸ æ˜ŸæœŸåˆ†æ / Weekday Analysis\n", "result_header")
                result_text.insert(tk.END, "-" * 40 + "\n", "separator")
                result_text.insert(tk.END, f"ğŸ—“ï¸ æ¶‰åŠæ˜ŸæœŸ / Involved Weekdays: {', '.join(weekday_filters)}\n", "result")
                result_text.insert(tk.END, f"ğŸ“Š æ˜ŸæœŸæ•°é‡ / Weekday Count: {len(weekday_filters)}\n", "result")
                result_text.insert(tk.END, f"ğŸ“Š æ˜ŸæœŸè¦†ç›–ç‡ / Weekday Coverage: {(len(weekday_filters) / 7 * 100):.2f}%\n", "result")

            result_text.insert(tk.END, "\nâœ… åˆ†æå®Œæˆï¼\n", "success")
            
            # ä¿®å¾©ï¼šæ´»å‹•åˆ†æå®Œæˆå¾Œä¿å­˜åˆ†æçµæœä¸¦æ›´æ–°æ´»å‹•è¨˜éŒ„è¡¨
            try:
                # ä¿å­˜åˆ†æçµæœåˆ°æ´»å‹•è¨˜éŒ„ä¸­
                self.save_analysis_results_to_activity_records(
                    date_from, date_to, outlets, products, database, 
                    payment_methods, weekday_filters, 
                    total_amount_all, total_receipts_all, 
                    product_amount, product_receipts, product_quantity
                )
                print("âœ… å·²ä¿å­˜åˆ†æçµæœåˆ°æ´»å‹•è¨˜éŒ„")
                
                # æ›´æ–°æ´»å‹•è¨˜éŒ„è¡¨
                if hasattr(self, 'activity_tree'):
                    self.refresh_activity_tree()
                    print("âœ… å·²åˆ·æ–°æ´»å‹•è¨˜éŒ„è¡¨")
                
                # æ›´æ–°æ´»å‹•æé†’è¦–çª—
                if hasattr(self, 'update_activity_alerts'):
                    self.update_activity_alerts()
                    print("âœ… å·²æ›´æ–°æ´»å‹•æé†’è¦–çª—")
                
                # ä¿å­˜æ´»å‹•è¨˜éŒ„
                if hasattr(self, 'save_activity_records'):
                    self.save_activity_records()
                    print("âœ… å·²ä¿å­˜æ´»å‹•è¨˜éŒ„")
                    
            except Exception as update_error:
                print(f"âš ï¸ æ›´æ–°æ´»å‹•è¨˜éŒ„å’Œæé†’æ™‚å‡ºéŒ¯: {update_error}")
            
        except Exception as e:
            import traceback
            error_details = traceback.format_exc()
            result_text.insert(tk.END, f"âŒ åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}\n", "error")
            result_text.insert(tk.END, f"ğŸ” é”™è¯¯è¯¦æƒ… / Error Details:\n{error_details}\n", "error")
            print(f"æ´»åŠ¨åˆ†æé”™è¯¯è¯¦æƒ…: {error_details}")
    
    def save_analysis_results_to_activity_records(self, date_from, date_to, outlets, products, database, 
                                                payment_methods, weekday_filters, 
                                                total_amount_all, total_receipts_all, 
                                                product_amount, product_receipts, product_quantity):
        """ä¿å­˜åˆ†æçµæœåˆ°æ´»å‹•è¨˜éŒ„ä¸­"""
        try:
            print("ğŸ’¾ é–‹å§‹ä¿å­˜åˆ†æçµæœåˆ°æ´»å‹•è¨˜éŒ„...")
            print(f"ğŸ“Š åˆ†æåƒæ•¸:")
            print(f"   - æ—¥æœŸç¯„åœ: {date_from} åˆ° {date_to}")
            print(f"   - é–€å¸‚: {outlets}")
            print(f"   - ç”¢å“: {products}")
            print(f"   - æ”¯ä»˜æ–¹å¼: {payment_methods}")
            print(f"   - æ˜ŸæœŸ: {weekday_filters}")
            print(f"   - æ•¸æ“šåº«: {database}")
            
            # æ‰¾åˆ°åŒ¹é…çš„æ´»å‹•è¨˜éŒ„
            current_db = self.get_current_database()
            records = self.activity_records.get(current_db, [])
            print(f"ğŸ“Š ç•¶å‰æ•¸æ“šåº«: {current_db}")
            print(f"ğŸ“Š æ‰¾åˆ° {len(records)} æ¢æ´»å‹•è¨˜éŒ„")
            
            # è¨ˆç®—å æ¯”
            amount_ratio = (product_amount / total_amount_all * 100) if total_amount_all > 0 else 0
            receipt_ratio = (product_receipts / total_receipts_all * 100) if total_receipts_all > 0 else 0
            
            # æŸ¥æ‰¾åŒ¹é…çš„æ´»å‹•è¨˜éŒ„ - ä½¿ç”¨æ›´å¯¬é¬†çš„åŒ¹é…æ¢ä»¶
            matched_record = None
            for i, record in enumerate(records):
                print(f"ğŸ” æª¢æŸ¥è¨˜éŒ„ {i+1}: ID={record.get('id')}, åç¨±={record.get('name', record.get('description', 'æœªçŸ¥'))}")
                
                # æª¢æŸ¥æ˜¯å¦åŒ¹é…ç•¶å‰åˆ†æçš„æ´»å‹•è¨˜éŒ„ - åªæª¢æŸ¥æ—¥æœŸå’Œç”¢å“
                record_date_from = record.get('date_from', '')
                record_date_to = record.get('date_to', '')
                record_products = record.get('products', [])
                
                print(f"   è¨˜éŒ„æ—¥æœŸ: {record_date_from} åˆ° {record_date_to}")
                print(f"   è¨˜éŒ„ç”¢å“: {record_products}")
                
                # æª¢æŸ¥æ—¥æœŸåŒ¹é…
                date_match = (record_date_from == date_from and record_date_to == date_to)
                
                # æª¢æŸ¥ç”¢å“åŒ¹é… - ä½¿ç”¨æ›´å¯¬é¬†çš„åŒ¹é…
                products_match = False
                if products and record_products:
                    # æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç”¢å“åŒ¹é…
                    if isinstance(products, list) and isinstance(record_products, list):
                        products_match = any(p in record_products for p in products)
                    elif isinstance(products, str) and isinstance(record_products, str):
                        products_match = products in record_products or record_products in products
                elif not products and not record_products:
                    # éƒ½æ²’æœ‰ç”¢å“ï¼Œä¹Ÿç®—åŒ¹é…
                    products_match = True
                
                print(f"   æ—¥æœŸåŒ¹é…: {date_match}")
                print(f"   ç”¢å“åŒ¹é…: {products_match}")
                
                if date_match and products_match:
                    matched_record = record
                    print(f"âœ… æ‰¾åˆ°åŒ¹é…çš„æ´»å‹•è¨˜éŒ„: {record.get('id')}")
                    break
            
            if matched_record:
                # æ›´æ–°åˆ†æçµæœ
                matched_record['total_sales'] = total_amount_all
                matched_record['total_receipts'] = total_receipts_all
                matched_record['activity_sales'] = product_amount
                matched_record['activity_receipts'] = product_receipts
                matched_record['activity_quantity'] = product_quantity
                matched_record['sales_ratio'] = amount_ratio
                matched_record['receipt_ratio'] = receipt_ratio
                matched_record['analysis_time'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                
                print(f"âœ… å·²æ›´æ–°æ´»å‹•è¨˜éŒ„ {matched_record.get('id')} çš„åˆ†æçµæœ")
                print(f"   - ç¸½æ¥­ç¸¾: ${total_amount_all:,.2f}")
                print(f"   - ç¸½å–®æ“šæ•¸: {total_receipts_all:,}")
                print(f"   - æ´»å‹•æ¥­ç¸¾: ${product_amount:,.2f}")
                print(f"   - æ´»å‹•å–®æ“šæ•¸: {product_receipts:,}")
                print(f"   - æ¥­ç¸¾å æ¯”: {amount_ratio:.2f}%")
                print(f"   - å–®æ“šå æ¯”: {receipt_ratio:.2f}%")
            else:
                print("âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„æ´»å‹•è¨˜éŒ„ï¼Œå˜—è©¦æ›´æ–°æ‰€æœ‰è¨˜éŒ„...")
                
                # å¦‚æœæ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„è¨˜éŒ„ï¼Œæ›´æ–°æ‰€æœ‰è¨˜éŒ„
                for record in records:
                    record['total_sales'] = total_amount_all
                    record['total_receipts'] = total_receipts_all
                    record['activity_sales'] = product_amount
                    record['activity_receipts'] = product_receipts
                    record['activity_quantity'] = product_quantity
                    record['sales_ratio'] = amount_ratio
                    record['receipt_ratio'] = receipt_ratio
                    record['analysis_time'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                    print(f"âœ… å·²æ›´æ–°æ´»å‹•è¨˜éŒ„ {record.get('id')} çš„åˆ†æçµæœ")
                
                print("âœ… å·²æ›´æ–°æ‰€æœ‰æ´»å‹•è¨˜éŒ„çš„åˆ†æçµæœ")
                
        except Exception as e:
            print(f"âŒ ä¿å­˜åˆ†æçµæœåˆ°æ´»å‹•è¨˜éŒ„å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
    
    def refresh_activity_tree(self):
        """åˆ·æ–°æ´»åŠ¨è®°å½•æ ‘æ˜¾ç¤º - ä¿®å¤æ•°æ®æŒä¹…åŒ–ç‰ˆæœ¬"""
        try:
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.activity_tree.get_children():
                self.activity_tree.delete(item)
        
            # è·å–å½“å‰é€‰ä¸­çš„æ•°æ®åº“
            current_db = self.get_current_database()
            
            # ç¡®ä¿æ´»åŠ¨è®°å½•å­—å…¸å­˜åœ¨å¹¶åŒ…å«æ‰€æœ‰æ•°æ®åº“
            if not hasattr(self, 'activity_records'):
                self.activity_records = {
                    'GOGO': [],
                    'Express': [], 
                    'PLUS': [],
                    'All': []
                }
            
            # ç¡®ä¿å½“å‰æ•°æ®åº“é”®å­˜åœ¨
            if current_db not in self.activity_records:
                self.activity_records[current_db] = []
                print(f"ğŸ”§ ä¸ºæ•°æ®åº“ '{current_db}' åˆ›å»ºäº†æ–°çš„æ´»åŠ¨è®°å½•åˆ—è¡¨")
            
            print(f"ğŸ”„ åˆ·æ–°æ´»åŠ¨è®°å½•æ ‘ - å½“å‰æ•°æ®åº“: {current_db}")
            print(f"ğŸ“‹ æ‰€æœ‰æ´»åŠ¨è®°å½•çŠ¶æ€: {list(self.activity_records.keys())}")
            print(f"ğŸ“‹ {current_db} æ•°æ®åº“çš„è®°å½•æ•°: {len(self.activity_records[current_db])}")
            
            # æ˜¾ç¤ºå½“å‰æ•°æ®åº“çš„æ‰€æœ‰è®°å½•  
            if self.activity_records[current_db]:
                print(f"âœ… æ‰¾åˆ°äº† {len(self.activity_records[current_db])} ä¸ªæ´»åŠ¨è®°å½•")
                for record in self.activity_records[current_db]:
                    # æ´»å‹•åç¨±
                    activity_name = record.get('description', f"æ´»å‹• {record.get('id', '')}")
                    
                    # æ—¥æœŸæœŸé–“
                    if record.get('type') == 'weekly':
                        weekdays_str = ', '.join(record.get('weekdays', []))
                        date_period = f"{record.get('date_from', '')} - {record.get('date_to', '')}"
                    else:
                        date_period = f"{record.get('date_from', '')} - {record.get('date_to', '')}"
                    
                    # æ˜ŸæœŸç¯©é¸
                    weekdays = record.get('weekdays', [])
                    weekdays_str = ', '.join(weekdays) if weekdays else 'å…¨éƒ¨'
                    
                    # åˆ†æçµæœ - å„ªå…ˆä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µ
                    if record.get('total_sales') is not None:
                        # ä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µ
                        total_sales = f"${record.get('total_sales', 0):,.2f}"
                        total_receipts = f"{record.get('total_receipts', 0):,}"
                        activity_sales = f"${record.get('activity_sales', 0):,.2f}"
                        activity_receipts = f"{record.get('activity_receipts', 0):,}"
                        sales_ratio = f"{record.get('sales_ratio', 0):.2f}%"
                        receipt_ratio = f"{record.get('receipt_ratio', 0):.2f}%"
                        print(f"ğŸ“Š ä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µé¡¯ç¤ºè¨˜éŒ„ {record.get('id')} çš„åˆ†æçµæœ")
                    else:
                        # ä½¿ç”¨èˆŠçš„åˆ†æçµæœå­—æ®µ
                        analysis_result = record.get('analysis_result', {})
                        if analysis_result:
                            total_sales = f"${analysis_result.get('total_amount', 0):,.2f}"
                            total_receipts = f"{analysis_result.get('total_receipts', 0):,}"
                            activity_sales = f"${analysis_result.get('activity_amount', 0):,.2f}"
                            activity_receipts = f"{analysis_result.get('activity_receipts', 0):,}"
                            sales_ratio = f"{analysis_result.get('amount_ratio', 0):.2f}%"
                            receipt_ratio = f"{analysis_result.get('receipt_ratio', 0):.2f}%"
                            print(f"ğŸ“Š ä½¿ç”¨èˆŠçš„åˆ†æçµæœå­—æ®µé¡¯ç¤ºè¨˜éŒ„ {record.get('id')} çš„åˆ†æçµæœ")
                        else:
                            total_sales = "æœªåˆ†æ"
                            total_receipts = "æœªåˆ†æ"
                            activity_sales = "æœªåˆ†æ"
                            activity_receipts = "æœªåˆ†æ"
                            sales_ratio = "æœªåˆ†æ"
                            receipt_ratio = "æœªåˆ†æ"
                            print(f"ğŸ“Š è¨˜éŒ„ {record.get('id')} æ²’æœ‰åˆ†æçµæœ")
                    
                    # æ’å…¥æ•¸æ“šæ™‚åŒ…å«æ´»å‹•IDä½œç‚ºéš±è—çš„ç¬¬ä¸€åˆ—
                    self.activity_tree.insert("", "end", values=(
                        record.get('id', ''),  # æ´»å‹•ID - éš±è—åˆ—
                        activity_name,
                        date_period,
                        weekdays_str,
                        total_sales,
                        total_receipts,
                        activity_sales,
                        activity_receipts,
                        sales_ratio,
                        receipt_ratio
                    ))
            else:
                print(f"âš ï¸ å½“å‰æ•°æ®åº“ '{current_db}' æ²¡æœ‰æ´»åŠ¨è®°å½•æˆ–åˆ—è¡¨ä¸ºç©º")
                if current_db not in self.activity_records:
                    print(f"   - åœ¨æ´»åŠ¨è®°å½•ä¸­æ²¡æœ‰æ‰¾åˆ° {current_db} æ•°æ®åº“")
                else:
                    print(f"   - {current_db} æ•°æ®åº“çš„è®°å½•åˆ—è¡¨ä¸ºç©º")
                    
        except Exception as e:
            print(f"åˆ·æ–°æ´»åŠ¨è®°å½•æ ‘å¤±è´¥: {e}")
            import traceback
            print(f"è¯¦ç»†é”™è¯¯ä¿¡æ¯: {traceback.format_exc()}")
            self.show_activity_message(f"âŒ åˆ·æ–°æ´»åŠ¨è®°å½•å¤±è´¥: {e}")
    
    def add_activity_record(self):
        """æ·»åŠ æ´»åŠ¨è®°å½•"""
        try:
            # å¯¼å…¥å¿…è¦çš„æ¨¡å—
            from datetime import datetime
            import time
            
            activity_type = self.activity_type.get()
            outlets = self.activity_outlets.get_selected()
            parts = self.activity_parts.get_selected()
            products = self.activity_products.get_selected()
            description = self.activity_description.get().strip()
            
            # éªŒè¯åŸºæœ¬ä¿¡æ¯
            if not outlets:
                tk.messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æ¶‰åŠçš„é—¨å¸‚")
                return
            
            if not parts:
                tk.messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æ¶‰åŠçš„éƒ¨åˆ†")
                return
            
            if not description:
                tk.messagebox.showerror("é”™è¯¯", "è¯·è¾“å…¥æ´»åŠ¨æè¿°")
                return
            
            # åˆå§‹åŒ–æ—¥æœŸå˜é‡
            date_from = None
            date_to = None
            selected_weekdays = []
            
            # æ ¹æ®æ´»åŠ¨ç±»å‹å¤„ç†æ—¥æœŸ
            if activity_type == "daily":
                date_from = self.activity_date_from.get_date()
                date_to = self.activity_date_to.get_date()
            else:  # å‘¨æœŸæ€§æ´»åŠ¨
                date_from = self.weekly_date_from.get_date() if hasattr(self, 'weekly_date_from') else None
                date_to = self.weekly_date_to.get_date() if hasattr(self, 'weekly_date_to') else None
                selected_weekdays = [day for day, var in getattr(self, 'weekday_vars', {}).items() if var.get()]
                
                if not selected_weekdays:
                    tk.messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ˜ŸæœŸ")
                    return
            
            # éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
            if not date_from or not date_to:
                tk.messagebox.showerror("é”™è¯¯", "è¯·é€‰æ‹©æ´»åŠ¨æ—¥æœŸèŒƒå›´")
                return
            
            if date_from > date_to:
                tk.messagebox.showerror("é”™è¯¯", "å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ")
                return
            
            # åˆ›å»ºæ´»åŠ¨è®°å½•
            # è·å–æ”¯ä»˜æ–¹å¼ç­›é€‰
            payment_methods = []
            if hasattr(self, 'activity_payment'):
                payment_methods = self.activity_payment.get_selected()

            activity_record = {
                'id': 0,  # å°†åœ¨åé¢æ›´æ–°
                'type': activity_type,
                'date_from': date_from.strftime('%Y-%m-%d'),
                'date_to': date_to.strftime('%Y-%m-%d'),
                'outlets': outlets,
                'parts': parts,
                'products': products,
                'payment_methods': payment_methods,  # æ·»åŠ æ”¯ä»˜æ–¹å¼ç­›é€‰
                'description': description,
                'created_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
            
            # å¦‚æœæ˜¯å‘¨æœŸæ€§æ´»åŠ¨ï¼Œæ·»åŠ æ˜ŸæœŸä¿¡æ¯
            if activity_type == "weekly":
                activity_record['weekdays'] = selected_weekdays
            
            # æ·»åŠ åˆ°å¯¹åº”æ•°æ®åº“çš„è®°å½•åˆ—è¡¨
            current_db = self.activity_database.get()
            if current_db not in self.activity_records:
                self.activity_records[current_db] = []
            
            # è®¾ç½®è®°å½•IDï¼ˆä½¿ç”¨æ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€æ€§ï¼‰
            activity_record['id'] = int(time.time() * 1000)  # ä½¿ç”¨æ¯«ç§’æ—¶é—´æˆ³ä½œä¸ºID
            activity_record['database'] = current_db
            
            self.activity_records[current_db].append(activity_record)
            
            # è‡ªå‹•ä¿å­˜åˆ° PromotionRecords.xlsx
            self.auto_save_promotion_records()
            
            # æ¸…ç©ºè¾“å…¥æ¡†
            self.activity_description.delete(0, tk.END)
            
            # å¦‚æœæ˜¯å‘¨æœŸæ€§æ´»åŠ¨ï¼Œæ¸…ç©ºæ˜ŸæœŸé€‰æ‹©
            if activity_type == "weekly" and hasattr(self, 'weekday_vars'):
                for var in self.weekday_vars.values():
                    var.set(False)
            
            # åˆ·æ–°æ˜¾ç¤º
            self.refresh_activity_tree()
            self.update_activity_alerts()
            
            # ä¿å­˜æ´»åŠ¨è®°å½•åˆ°æ–‡ä»¶
            self.save_activity_records()
            
            # æ›´æ–°ç”¢å“é¸æ“‡å™¨ä»¥åŒ…å«æ–°æ·»åŠ çš„ç”¢å“
            try:
                print("ğŸ”„ æ›´æ–°ç”¢å“é¸æ“‡å™¨ä»¥åŒ…å«æ–°æ·»åŠ çš„ç”¢å“...")
                self.update_activity_products_from_records()
                print("âœ… ç”¢å“é¸æ“‡å™¨å·²æ›´æ–°")
            except Exception as e:
                print(f"âš ï¸ æ›´æ–°ç”¢å“é¸æ“‡å™¨å¤±æ•—: {e}")
            
            # è‡ªå‹•åˆ†ææ–°æ·»åŠ çš„æ´»å‹•
            try:
                self.show_activity_message("ğŸ” æ­£åœ¨è‡ªå‹•åˆ†ææ–°æ·»åŠ çš„æ´»å‹•...")
                analysis_result = self.auto_analyze_activity(activity_record)
                
                if analysis_result:
                    # å°‡åˆ†æçµæœä¿å­˜åˆ°æ´»å‹•è¨˜éŒ„ä¸­
                    activity_record['analysis_result'] = analysis_result
                    
                    # æ›´æ–°è¨˜éŒ„
                    self.activity_records[current_db][-1] = activity_record
                    self.save_activity_records()
                    
                    self.show_activity_message("âœ… æ´»å‹•åˆ†æå®Œæˆä¸¦å·²ä¿å­˜")
                else:
                    self.show_activity_message("âš ï¸ æ´»å‹•åˆ†æå¤±æ•—ï¼Œä½†è¨˜éŒ„å·²ä¿å­˜")
                    
            except Exception as e:
                print(f"è‡ªå‹•åˆ†ææ´»å‹•å¤±æ•—: {e}")
                self.show_activity_message(f"âš ï¸ è‡ªå‹•åˆ†æå¤±æ•—: {e}")
            
            activity_type_text = "æ¯æ—¥æ´»åŠ¨" if activity_type == "daily" else "å‘¨æœŸæ€§æ´»åŠ¨"
            tk.messagebox.showinfo("æˆåŠŸ", f"{activity_type_text}è®°å½•å·²æ·»åŠ å¹¶ä¿å­˜: {description}")
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"æ·»åŠ æ´»åŠ¨è®°å½•å¤±è´¥: {e}")
    
    def auto_analyze_activity(self, activity_record):
        """è‡ªå‹•åˆ†ææ´»å‹•ä¸¦è¿”å›çµæœ"""
        try:
            # æª¢æŸ¥æ•¸æ“šåº«é€£æ¥
            if not hasattr(self, 'db_manager') or not self.db_manager.connection:
                return None
            
            # ç²å–æ´»å‹•ä¿¡æ¯
            date_from = activity_record.get('date_from', '')
            date_to = activity_record.get('date_to', '')
            outlets = activity_record.get('outlets', [])
            products = activity_record.get('products', [])
            payment_methods = activity_record.get('payment_methods', [])
            weekdays = activity_record.get('weekdays', [])
            database = activity_record.get('database', 'Express')
            
            # é€£æ¥åˆ°æ­£ç¢ºçš„æ•¸æ“šåº«
            if not self.connect_to_activity_database(database):
                return None
            
            # ç²å–ç¸½æ¥­ç¸¾æ•¸æ“šï¼ˆåŒæœŸæ‰€æœ‰æ•¸æ“šï¼‰
            total_data = self.db_manager.get_sales_data(
                date_from=date_from, date_to=date_to,
                outlet_filters=[],  # ä¸é™åˆ¶é–€å¸‚
                product_filters=[], # ä¸é™åˆ¶ç”¢å“
                weekday_filters=weekdays,
                use_excel_cache=True
            )
            
            if not total_data:
                return None
            
            # è¨ˆç®—ç¸½æ¥­ç¸¾
            total_amount, total_receipts = self._calculate_performance_from_data(total_data)
            
            # ç²å–æ´»å‹•ç‰¹å®šæ¥­ç¸¾
            activity_data = self.db_manager.get_sales_data(
                date_from=date_from, date_to=date_to,
                outlet_filters=outlets,
                product_filters=products,
                weekday_filters=weekdays,
                use_excel_cache=True
            )
            
            if not activity_data:
                activity_amount = 0
                activity_receipts = 0
            else:
                activity_amount, activity_receipts = self._calculate_performance_from_data(activity_data)
            
            # å¦‚æœæœ‰æ”¯ä»˜æ–¹å¼ç¯©é¸ï¼Œéœ€è¦é€²ä¸€æ­¥è¨ˆç®—
            if payment_methods:
                # é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›éœ€è¦æŸ¥è©¢æ”¯ä»˜æ–¹å¼è¡¨
                # å‡è¨­æ”¯ä»˜æ–¹å¼ç¯©é¸æœƒå½±éŸ¿30%çš„æ¥­ç¸¾
                activity_amount = activity_amount * 0.3
                activity_receipts = int(activity_receipts * 0.3)
            
            # è¨ˆç®—å æ¯”
            amount_ratio = (activity_amount / total_amount * 100) if total_amount > 0 else 0
            receipt_ratio = (activity_receipts / total_receipts * 100) if total_receipts > 0 else 0
            
            # è¿”å›åˆ†æçµæœ
            return {
                'total_amount': total_amount,
                'total_receipts': total_receipts,
                'activity_amount': activity_amount,
                'activity_receipts': activity_receipts,
                'amount_ratio': amount_ratio,
                'receipt_ratio': receipt_ratio,
                'analyzed_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
            
        except Exception as e:
            print(f"è‡ªå‹•åˆ†ææ´»å‹•å¤±æ•—: {e}")
            return None
    
    def _calculate_performance_from_data(self, data):
        """å¾éŠ·å”®æ•¸æ“šè¨ˆç®—æ¥­ç¸¾å’Œå–®æ“šæ•¸"""
        try:
            receipt_totals = {}
            
            for record in data:
                sales_no = record.get('sales_no', '')
                store_name = record.get('store_name', '')
                receipt_key = f"{store_name}-{sales_no}"
                
                # è¨ˆç®—æ¥­ç¸¾
                sub_total = float(record.get('sub_total', 0))
                pro_disc_amt = float(record.get('pro_disc_amt', 0))
                svc_amt = float(record.get('svc_amt', 0))
                tax_amt = float(record.get('tax_amt', 0))
                take_away_item = str(record.get('take_away_item', 'N'))
                
                if self.db_manager.current_database == "sushi_gogo_pos_live":
                    net_amount = sub_total - pro_disc_amt + svc_amt - tax_amt
                else:
                    if take_away_item == 'Y':
                        net_amount = sub_total - pro_disc_amt + svc_amt - tax_amt
                    else:
                        net_amount = sub_total - pro_disc_amt + svc_amt
                
                if receipt_key not in receipt_totals:
                    receipt_totals[receipt_key] = 0.0
                receipt_totals[receipt_key] += net_amount
            
            total_amount = sum(receipt_totals.values())
            total_receipts = len(receipt_totals)
            
            return total_amount, total_receipts
            
        except Exception as e:
            print(f"è¨ˆç®—æ¥­ç¸¾å¤±æ•—: {e}")
            return 0, 0
    
    def analyze_existing_activities(self, target_db=None):
        """ç‚ºç¾æœ‰çš„æ´»å‹•è¨˜éŒ„è£œå……åˆ†æçµæœ"""
        try:
            updated = False
            # å¦‚æœæŒ‡å®šäº†ç›®æ ‡æ•°æ®åº“ï¼Œåªåˆ†æè¯¥æ•°æ®åº“çš„æ´»åŠ¨è®°å½•
            if target_db:
                db_names = [target_db]
            else:
                db_names = self.activity_records.keys()
            
            for db_name in db_names:
                activities = self.activity_records.get(db_name, [])
                for activity in activities:
                    # æª¢æŸ¥æ˜¯å¦å·²æœ‰åˆ†æçµæœ
                    if 'analysis_result' not in activity:
                        print(f"ğŸ” ç‚ºæ´»å‹• {activity.get('description', 'Unknown')} è£œå……åˆ†æçµæœ...")
                        
                        # é€£æ¥åˆ°å°æ‡‰çš„æ•¸æ“šåº«
                        if self.connect_to_activity_database(db_name):
                            analysis_result = self.auto_analyze_activity(activity)
                            if analysis_result:
                                activity['analysis_result'] = analysis_result
                                updated = True
                                print(f"âœ… å·²ç‚ºæ´»å‹•æ·»åŠ åˆ†æçµæœ")
                            else:
                                print(f"âš ï¸ åˆ†æå¤±æ•—ï¼Œè·³éæ­¤æ´»å‹•")
            
            if updated:
                # ä¿å­˜æ›´æ–°çš„è¨˜éŒ„
                self.save_activity_records()
                print(f"âœ… å·²æ›´æ–°æ´»å‹•è¨˜éŒ„ä¸¦ä¿å­˜")
                
                # æ›´æ–°æ´»å‹•æé†’é¡¯ç¤º
                if hasattr(self, 'update_activity_alerts'):
                    self.update_activity_alerts()
                    
        except Exception as e:
            print(f"è£œå……åˆ†æçµæœå¤±æ•—: {e}")
    
    def get_current_database(self):
        """è·å–å½“å‰é€‰æ‹©çš„æ•°æ®åº“ - ç»Ÿä¸€æ•°æ®åº“é€‰æ‹©é€»è¾‘"""
        # ä¼˜å…ˆä½¿ç”¨æ´»åŠ¨è®°å½•çª—å£çš„æ•°æ®åº“é€‰æ‹©
        if hasattr(self, 'activity_database') and self.activity_database.get():
            print(f"DEBUG: get_current_database returning activity_database: {self.activity_database.get()}")
            return self.activity_database.get()
        # å…¶æ¬¡ä½¿ç”¨ä¸»é¡µé€‰æ‹©çš„æ•°æ®åº“
        elif hasattr(self, 'selected_db') and self.selected_db.get():
            print(f"DEBUG: get_current_database returning selected_db: {self.selected_db.get()}")
            return self.selected_db.get()
        # æœ€åä½¿ç”¨æ•°æ®åº“ç®¡ç†å™¨çš„å½“å‰æ•°æ®åº“
        elif hasattr(self, 'db_manager') and self.db_manager.current_database:
            print(f"DEBUG: get_current_database returning db_manager.current_database: {self.db_manager.current_database}")
            return self.db_manager.current_database
        # é»˜è®¤ä½¿ç”¨GOGO
        else:
            print(f"DEBUG: get_current_database returning default: GOGO")
            return 'GOGO'
    
    def view_activity_records(self):
        """æŸ¥çœ‹æ´»åŠ¨è®°å½• - ç¾åŒ–ç‰ˆæœ¬æ”¯æŒé€‰æ‹©åˆ†æç‰¹å®šæ´»åŠ¨"""
        # æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨è®°å½• - ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“é€‰æ‹©é€»è¾‘
        current_db = self.get_current_database()
        if not self.activity_records.get(current_db):
            self.log_message("â„¹ æš‚æ— æ´»åŠ¨è®°å½•")
            return
        
        # åˆ›å»ºæ´»åŠ¨è®°å½•æŸ¥çœ‹çª—å£ - ç¾åŒ–ç‰ˆæœ¬
        activity_window = tk.Toplevel(self.root)
        activity_window.title("ğŸ“‹ æ´»åŠ¨è®°å½•æŸ¥çœ‹ / Activity Records")
        activity_window.geometry("1400x900")
        activity_window.configure(bg='#FFFFFF')
        activity_window.transient(self.root)
        activity_window.grab_set()
        
        # è¨­ç½®çª—å£åœ–æ¨™
        try:
            activity_window.iconbitmap("SELOGO22 - 01.ico")
        except:
            pass
        
        # æ¨™é¡Œå€åŸŸ
        title_frame = tk.Frame(activity_window, bg='#2c3e50', height=80)
        title_frame.pack(fill="x")
        title_frame.pack_propagate(False)
        
        title_label = tk.Label(title_frame, 
                             text="ğŸ“‹ æ´»å‹•è¨˜éŒ„æŸ¥çœ‹",
                             font=('Microsoft YaHei UI', 16, 'bold'),
                             fg='white', bg='#2c3e50')
        title_label.pack(side="left", padx=20, pady=20)
        
        # è·å–å½“å‰æ—¶é—´æˆ³
        from datetime import datetime
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # ä¿å­˜subtitle_labelå¼•ç”¨ä»¥ä¾¿åˆ·æ–°æ—¶æ›´æ–°
        self.view_window_subtitle = tk.Label(title_frame, 
                                text=f"Activity Records - {current_db} Database (Updated: {current_time})",
                                font=('Arial', 11),
                                fg='#bdc3c7', bg='#2c3e50')
        self.view_window_subtitle.pack(side="left", padx=(0, 20), pady=20)
        
        # ä¿å­˜çª—å£å¼•ç”¨ä»¥ä¾¿åˆ·æ–°æ—¶æ›´æ–°æ ‡é¢˜
        self.view_activity_window = activity_window
        
        # ä¸»å…§å®¹å€åŸŸ
        content_frame = tk.Frame(activity_window, bg='#FFFFFF')
        content_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        # å‰µå»ºTreeViewå®¹å™¨ - æ·»åŠ é¡å¤–çš„å…§é‚Šè·ç¢ºä¿è¡¨é ­ä¸è¢«æˆªæ–·
        tree_container = tk.Frame(content_frame, bg='#ffffff', relief='solid', bd=1)
        tree_container.pack(fill="both", expand=True, padx=(5, 0), pady=(5, 0))
        
        # å‰µå»ºæ›´è©³ç´°çš„TreeView
        columns = ('æ´»å‹•ID', 'æ´»å‹•åç¨±', 'æ—¥æœŸæœŸé–“', 'æ˜ŸæœŸç¯©é¸', 'ç¸½æ¥­ç¸¾', 'ç¸½å–®æ“šæ•¸', 'æ´»å‹•æ¥­ç¸¾', 'æ´»å‹•å–®æ“šæ•¸', 'æ¥­ç¸¾å æ¯”%', 'å–®æ“šæ•¸å æ¯”%')
        tree = ttk.Treeview(tree_container, columns=columns, show='headings', height=20)
        
        # å¼·åˆ¶é¡¯ç¤ºè¡¨é ­ - ç¢ºä¿å®ƒå€‘å¯è¦‹
        tree.configure(show='headings')
        
        # è¨­ç½®åˆ—æ¨™é¡Œå’Œå¯¬åº¦ - é›™èªé¡¯ç¤º
        column_config = {
            'æ´»å‹•ID': ('æ´»å‹•ID / Activity ID', 80),
            'æ´»å‹•åç¨±': ('æ´»å‹•åç¨± / Activity Name', 200),
            'æ—¥æœŸæœŸé–“': ('æ—¥æœŸæœŸé–“ / Date Period', 150),
            'æ˜ŸæœŸç¯©é¸': ('æ˜ŸæœŸç¯©é¸ / Weekdays', 120),
            'ç¸½æ¥­ç¸¾': ('ç¸½æ¥­ç¸¾ / Total Sales', 120),
            'ç¸½å–®æ“šæ•¸': ('ç¸½å–®æ“šæ•¸ / Total Receipts', 120),
            'æ´»å‹•æ¥­ç¸¾': ('æ´»å‹•æ¥­ç¸¾ / Activity Sales', 130),
            'æ´»å‹•å–®æ“šæ•¸': ('æ´»å‹•å–®æ“šæ•¸ / Activity Receipts', 130),
            'æ¥­ç¸¾å æ¯”%': ('æ¥­ç¸¾å æ¯”% / Sales Ratio%', 120),
            'å–®æ“šæ•¸å æ¯”%': ('å–®æ“šæ•¸å æ¯”% / Receipt Ratio%', 130)
        }
        
        for col, (heading, width) in column_config.items():
            tree.heading(col, text=heading)
            tree.column(col, width=width, anchor='center')
        
        # éš±è—æ´»å‹•IDåˆ—
        tree.column('æ´»å‹•ID', width=0, minwidth=0, stretch=False)
        
        # é…ç½®TreeViewæ¨£å¼ - èª¿æ•´è¡¨é ­é«˜åº¦å’Œé–“è·
        style = ttk.Style()
        style.configure("Treeview", 
                       background="#ffffff",
                       foreground="#2c3e50",
                       rowheight=25,
                       fieldbackground="#ffffff",
                       font=('Arial', 9))
        style.configure("Treeview.Heading", 
                       font=('Arial', 10, 'bold'),
                       background="#34495e",
                       foreground="white",
                       relief="raised",
                       borderwidth=1,
                       padding=(10, 8))  # å¢åŠ è¡¨é ­çš„å…§é‚Šè·
        
        # å¼·åˆ¶æ‡‰ç”¨è¡¨é ­æ¨£å¼ä¸¦åˆ·æ–°
        style.configure("Custom.Treeview", 
                       background="#ffffff",
                       foreground="#2c3e50",
                       rowheight=25,
                       fieldbackground="#ffffff",
                       font=('Arial', 9))
        style.configure("Custom.Treeview.Heading", 
                       font=('Arial', 10, 'bold'),
                       background="#34495e",
                       foreground="white",
                       relief="raised",
                       borderwidth=1,
                       padding=(10, 8))
        
        # é‡æ–°é…ç½®è¡¨æ ¼ä»¥ç¢ºä¿æ¨£å¼ç”Ÿæ•ˆ
        tree.configure(style="Custom.Treeview")
        
        # å‰µå»ºè‡ªå®šç¾©æ»¾å‹•å‡½æ•¸ï¼Œç¢ºä¿ä¸æœƒæ»¾å‹•åˆ°è¡¨é ­ä¸Šæ–¹
        def custom_yview(*args):
            if not args:  # ç•¶å‰æ»¾å‹•ä½ç½®æŸ¥è©¢
                return tree.yview()
            else:
                # é™åˆ¶æ»¾å‹•ç¯„åœï¼Œé¿å…è¡¨é ­è¢«éš±è—
                if hasattr(args[0], '__call__'):
                    # æ»¾å‹•åˆ°æŒ‡å®šä½ç½®
                    args[0]()
                elif args[0] == 'moveto':
                    # moveto æ»¾å‹•
                    position = float(args[1])
                    # ç¢ºä¿ä¸æœƒæ»¾å‹•åˆ°è² ä½ç½®ï¼ˆé¿å…éš±è—è¡¨é ­ï¼‰
                    position = max(0.0, position)
                    tree.yview_moveto(position)
                elif args[0] == 'scroll':
                    # scroll æ»¾å‹•
                    count = int(args[1])
                    tree.yview_scroll(count, 'units')
        
        # æ·»åŠ æ»¾å‹•æ¢
        v_scrollbar = ttk.Scrollbar(tree_container, orient="vertical", command=custom_yview)
        h_scrollbar = ttk.Scrollbar(tree_container, orient="horizontal", command=tree.xview)
        tree.configure(yscrollcommand=v_scrollbar.set, xscrollcommand=h_scrollbar.set)
        
        # ä½ˆå±€TreeViewå’Œæ»¾å‹•æ¢
        tree.grid(row=0, column=0, sticky="nsew")
        v_scrollbar.grid(row=0, column=1, sticky="ns")
        h_scrollbar.grid(row=1, column=0, sticky="ew")
        
        tree_container.grid_rowconfigure(0, weight=1)
        tree_container.grid_columnconfigure(0, weight=1)
        
        # æ˜¾ç¤ºå½“å‰æ•°æ®åº“çš„è®°å½• - åŒ…å«åˆ†æçµæœ
        records = self.activity_records.get(current_db, [])
        for record in records:
            # æ´»å‹•åç¨±
            activity_name = record.get('description', f"æ´»å‹• {record.get('id', '')}")
            
            # æ—¥æœŸæœŸé–“
            if record.get('type') == 'weekly':
                date_period = f"{record.get('date_from', '')} - {record.get('date_to', '')}"
            else:
                date_period = f"{record.get('date_from', '')} - {record.get('date_to', '')}"
            
            # æ˜ŸæœŸç¯©é¸
            weekdays = record.get('weekdays', [])
            weekdays_str = ', '.join(weekdays) if weekdays else 'å…¨éƒ¨'
            
            # åˆ†æçµæœ - å„ªå…ˆä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µ
            if record.get('total_sales') is not None:
                # ä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µ
                total_sales = f"${record.get('total_sales', 0):,.2f}"
                total_receipts = f"{record.get('total_receipts', 0):,}"
                activity_sales = f"${record.get('activity_sales', 0):,.2f}"
                activity_receipts = f"{record.get('activity_receipts', 0):,}"
                sales_ratio = f"{record.get('sales_ratio', 0):.2f}%"
                receipt_ratio = f"{record.get('receipt_ratio', 0):.2f}%"
                print(f"ğŸ“Š æ´»å‹•è¨˜éŒ„æŸ¥çœ‹çª—å£ - ä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µé¡¯ç¤ºè¨˜éŒ„ {record.get('id')} çš„åˆ†æçµæœ")
            else:
                # ä½¿ç”¨èˆŠçš„åˆ†æçµæœå­—æ®µ
                analysis_result = record.get('analysis_result', {})
                if analysis_result:
                    total_sales = f"${analysis_result.get('total_amount', 0):,.2f}"
                    total_receipts = f"{analysis_result.get('total_receipts', 0):,}"
                    activity_sales = f"${analysis_result.get('activity_amount', 0):,.2f}"
                    activity_receipts = f"{analysis_result.get('activity_receipts', 0):,}"
                    sales_ratio = f"{analysis_result.get('amount_ratio', 0):.2f}%"
                    receipt_ratio = f"{analysis_result.get('receipt_ratio', 0):.2f}%"
                    print(f"ğŸ“Š æ´»å‹•è¨˜éŒ„æŸ¥çœ‹çª—å£ - ä½¿ç”¨èˆŠçš„åˆ†æçµæœå­—æ®µé¡¯ç¤ºè¨˜éŒ„ {record.get('id')} çš„åˆ†æçµæœ")
                else:
                    total_sales = "æœªåˆ†æ"
                    total_receipts = "æœªåˆ†æ"
                    activity_sales = "æœªåˆ†æ"
                    activity_receipts = "æœªåˆ†æ"
                    sales_ratio = "æœªåˆ†æ"
                    receipt_ratio = "æœªåˆ†æ"
                    print(f"ğŸ“Š æ´»å‹•è¨˜éŒ„æŸ¥çœ‹çª—å£ - è¨˜éŒ„ {record.get('id')} æ²’æœ‰åˆ†æçµæœ")
            
            tree.insert("", "end", values=(
                record.get('id', ''),  # æ´»å‹•ID - éš±è—åˆ—
                activity_name,
                date_period,
                weekdays_str,
                total_sales,
                total_receipts,
                activity_sales,
                activity_receipts,
                sales_ratio,
                receipt_ratio
            ))
        
        # ç¢ºä¿è¡¨é ­å¯è¦‹ - ä½¿ç”¨å¤šç¨®æ–¹æ³•ç¢ºä¿è¡¨é ­å®Œå…¨å¯è¦‹
        tree.update_idletasks()  # å¼·åˆ¶æ›´æ–°ä½ˆå±€
        
        # æ–¹æ³•1ï¼šç¢ºä¿æ»¾å‹•ä½ç½®åœ¨é ‚éƒ¨
        tree.yview_moveto(0)
        
        # æ–¹æ³•2ï¼šå¦‚æœæœ‰ç¬¬ä¸€è¡Œæ•¸æ“šï¼Œæ»¾å‹•åˆ°å®ƒï¼ˆé€™æœƒç¢ºä¿è¡¨é ­å¯è¦‹ï¼‰
        if records:
            # ç²å–ç¬¬ä¸€å€‹å­é …ç›®çš„ ID
            first_child = tree.get_children()[0] if tree.get_children() else None
            if first_child:
                tree.see(first_child)
        
        # æ–¹æ³•3ï¼šå¼·åˆ¶é‡æ–°ç¹ªè£½å’Œæ»¾å‹•åˆ°é ‚éƒ¨
        tree.update()
        tree.after_idle(lambda: tree.yview_moveto(0))
        
        # æŒ‰éˆ•å€åŸŸ - ç¾åŒ–ç‰ˆæœ¬
        button_frame = tk.Frame(activity_window, bg='#FFFFFF', height=80)
        button_frame.pack(fill="x", padx=20, pady=(10, 20))
        button_frame.pack_propagate(False)
        
        def analyze_selected_activity():
            """åˆ†æé€‰æ‹©çš„æ´»åŠ¨"""
            print("ğŸ” åˆ†æé¸ä¸­æ´»å‹•æŒ‰éˆ•è¢«é»æ“Š")
            
            selection = tree.selection()
            print(f"ğŸ“Š ç•¶å‰é¸ä¸­çš„é …ç›®: {selection}")
            
            if not selection:
                tk.messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©ä¸€ä¸ªæ´»åŠ¨è®°å½•è¿›è¡Œåˆ†æ")
                return

            # è·å–é€‰ä¸­æ´»åŠ¨ä¿¡æ¯
            item = tree.item(selection[0])
            values = item['values']
            print(f"ğŸ“Š é¸ä¸­é …ç›®çš„å€¼: {values}")
            
            if not values or len(values) < 1:
                tk.messagebox.showerror("éŒ¯èª¤", "ç„¡æ³•ç²å–æ´»å‹•ID")
                return
                
            activity_id = values[0]
            print(f"ğŸ“Š æ´»å‹•ID: {activity_id}")

            # æ‰¾åˆ°å¯¹åº”çš„æ´»åŠ¨è®°å½•
            current_db = self.get_current_database()
            print(f"ğŸ“Š ç•¶å‰æ•¸æ“šåº«: {current_db}")
            
            records = self.activity_records.get(current_db, [])
            print(f"ğŸ“Š æ‰¾åˆ° {len(records)} æ¢æ´»å‹•è¨˜éŒ„")
            
            selected_record = None
            for record in records:
                print(f"ğŸ” æª¢æŸ¥è¨˜éŒ„: ID={record.get('id')}, åç¨±={record.get('name', record.get('description', 'æœªçŸ¥'))}")
                print(f"ğŸ” è¨˜éŒ„å®Œæ•´å…§å®¹: {record}")
                print(f"ğŸ” æ¯”è¼ƒ: record.get('id')={record.get('id')} (é¡å‹: {type(record.get('id'))}) vs activity_id={activity_id} (é¡å‹: {type(activity_id)})")
                
                # å˜—è©¦å¤šç¨®IDåŒ¹é…æ–¹å¼
                if record.get('id') == activity_id:
                    selected_record = record
                    print(f"âœ… åŒ¹é…æˆåŠŸ (ç›´æ¥åŒ¹é…): {selected_record}")
                    break
                elif str(record.get('id')) == str(activity_id):
                    selected_record = record
                    print(f"âœ… åŒ¹é…æˆåŠŸ (å­—ç¬¦ä¸²åŒ¹é…): {selected_record}")
                    break
                elif int(record.get('id', 0)) == int(activity_id):
                    selected_record = record
                    print(f"âœ… åŒ¹é…æˆåŠŸ (æ•´æ•¸åŒ¹é…): {selected_record}")
                    break

            if selected_record:
                print(f"âœ… æ‰¾åˆ°æ´»å‹•è¨˜éŒ„: {selected_record}")
                
                # ä½¿ç”¨æ´»åŠ¨è®°å½•çš„ä¿¡æ¯è¿›è¡Œåˆ†æ
                current_db = selected_record.get('database', self.activity_database.get())
                print(f"ğŸ“Š ç•¶å‰æ•¸æ“šåº«: {current_db}")

                # è¿æ¥æ•°æ®åº“
                print("ğŸ”Œ å˜—è©¦é€£æ¥æ•¸æ“šåº«...")
                if not self.connect_to_activity_database(current_db):
                    print(f"âŒ ç„¡æ³•é€£æ¥åˆ°æ•¸æ“šåº«: {current_db}")
                    tk.messagebox.showerror("é”™è¯¯", f"æ— æ³•è¿æ¥åˆ°æ•°æ®åº“: {current_db}")
                    return
                print("âœ… æ•¸æ“šåº«é€£æ¥æˆåŠŸ")

                # åˆ›å»ºåˆ†æç»“æœçª—å£ - ç¾åŒ–ç‰ˆæœ¬
                print("ğŸªŸ å‰µå»ºåˆ†æçµæœçª—å£...")
                analysis_window = tk.Toplevel(self.root)
                print("âœ… åˆ†æçª—å£å·²å‰µå»º")
                activity_name = selected_record.get('description', selected_record.get('name', f"æ´»å‹• {activity_id}"))
                analysis_window.title(f"ğŸ“Š {activity_name} - æ´»å‹•æ¥­ç¸¾åˆ†æ / Activity Performance Analysis")
                analysis_window.geometry("1200x800")
                analysis_window.configure(bg='#FFFFFF')
                
                # è¨­ç½®çª—å£é—œé–‰å”è­° - ç¢ºä¿æ­£ç¢ºé—œé–‰
                def close_analysis_window():
                    try:
                        analysis_window.destroy()
                    except:
                        pass
                
                analysis_window.protocol("WM_DELETE_WINDOW", close_analysis_window)
                
                # è¨­ç½®çª—å£åœ–æ¨™å’Œæ¨£å¼
                try:
                    analysis_window.iconbitmap("SELOGO22 - 01.ico")
                except:
                    pass

                # æ¨™é¡Œå€åŸŸ
                title_frame = tk.Frame(analysis_window, bg='#2c3e50', height=80)
                title_frame.pack(fill="x")
                title_frame.pack_propagate(False)
                
                title_label = tk.Label(title_frame, 
                                     text=f"ğŸ“Š {activity_name}",
                                     font=('Microsoft YaHei UI', 16, 'bold'),
                                     fg='white', bg='#2c3e50')
                title_label.pack(side="left", padx=20, pady=20)
                
                subtitle_label = tk.Label(title_frame, 
                                        text="æ´»å‹•æ¥­ç¸¾åˆ†æ / Activity Performance Analysis",
                                        font=('Arial', 11),
                                        fg='#bdc3c7', bg='#2c3e50')
                subtitle_label.pack(side="left", padx=(0, 20), pady=20)

                # ä¸»å…§å®¹å€åŸŸ
                content_frame = tk.Frame(analysis_window, bg='#FFFFFF')
                content_frame.pack(fill="both", expand=True, padx=20, pady=20)

                # åˆ›å»ºæ»šåŠ¨æ¡å’Œæ–‡æœ¬æ¡† - ç¾åŒ–ç‰ˆæœ¬
                text_container = tk.Frame(content_frame, bg='#ffffff', relief='solid', bd=1)
                text_container.pack(fill="both", expand=True)
                
                result_text = tk.Text(text_container, 
                                    height=30, width=100, 
                                    wrap=tk.WORD, 
                                    font=('Consolas', 10),
                                    bg='#ffffff',
                                    fg='#2c3e50',
                                    selectbackground='#3498db',
                                    selectforeground='white',
                                    insertbackground='#2c3e50',
                                    relief='flat',
                                    padx=15, pady=15)
                
                result_scrollbar = ttk.Scrollbar(text_container, orient="vertical", command=result_text.yview)
                result_text.configure(yscrollcommand=result_scrollbar.set)

                result_text.pack(side="left", fill="both", expand=True)
                result_scrollbar.pack(side="right", fill="y")
                
                # æ·»åŠ åº•éƒ¨æŒ‰éˆ•å€åŸŸ
                button_frame = tk.Frame(analysis_window, bg='#FFFFFF', height=60)
                button_frame.pack(fill="x", padx=20, pady=(0, 20))
                button_frame.pack_propagate(False)
                
                # é—œé–‰æŒ‰éˆ•
                close_btn = tk.Button(button_frame, 
                                    text="âŒ é—œé–‰ / Close",
                                    command=close_analysis_window,
                                    font=('Arial', 10, 'bold'),
                                    bg='#e74c3c', fg='white',
                                    relief='flat', bd=0,
                                    padx=20, pady=8,
                                    cursor='hand2')
                close_btn.pack(side="right", pady=15)
                
                # å°å‡ºæŒ‰éˆ•
                export_btn = tk.Button(button_frame, 
                                     text="ğŸ“„ å°å‡ºå ±å‘Š / Export Report",
                                     command=lambda: self.export_analysis_report(result_text.get(1.0, tk.END)),
                                     font=('Arial', 10, 'bold'),
                                     bg='#27ae60', fg='white',
                                     relief='flat', bd=0,
                                     padx=20, pady=8,
                                     cursor='hand2')
                export_btn.pack(side="right", padx=(0, 10), pady=15)

                # è°ƒç”¨åˆ†æå’Œæ‰§è¡Œåˆ†æ
                outlet_filters = selected_record.get('outlets', [])
                product_filters = selected_record.get('products', [])
                payment_filters = selected_record.get('payment_methods', [])  # è·å–æ”¯ä»˜æ–¹å¼ç­›é€‰
                date_from_str = selected_record.get('date_from', '')
                date_to_str = selected_record.get('date_to', '')
                
                # åˆå§‹åŒ–æ˜ŸæœŸç­›é€‰å˜é‡
                selected_weekdays = selected_record.get('weekdays', [])

                # å¦‚æœæ˜¯å‘¨æœŸæ€§æ´»åŠ¨ï¼Œéœ€è¦è®¡ç®—å®é™…æ—¥æœŸ
                if selected_record.get('type') == 'weekly':
                    from datetime import datetime, timedelta
                    weekday_names = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥']
                    selected_weekdays = selected_record.get('weekdays', [])

                    # æ‰¾åˆ°æ‰€æœ‰ç¬¦åˆçš„æ—¥æœŸ
                    start_date = datetime.strptime(date_from_str, '%Y-%m-%d')
                    end_date = datetime.strptime(date_to_str, '%Y-%m-%d')
                    all_target_dates = []

                    current = start_date
                    while current <= end_date:
                        weekday_name = weekday_names[current.weekday()]
                        if weekday_name in selected_weekdays:
                            all_target_dates.append(current)
                        current += timedelta(days=1)

                    # åˆæˆæ—¥æœŸèŒƒå›´
                    if all_target_dates:
                        date_from_str = min(all_target_dates).strftime('%Y-%m-%d')
                        date_to_str = max(all_target_dates).strftime('%Y-%m-%d')

                # è°ƒç”¨åˆ†æ
                print(f"ğŸ” é–‹å§‹åˆ†ææ´»å‹•: {activity_name}")
                print(f"ğŸ“Š åˆ†æåƒæ•¸:")
                print(f"   - æ—¥æœŸç¯„åœ: {date_from_str} åˆ° {date_to_str}")
                print(f"   - é–€å¸‚: {outlet_filters}")
                print(f"   - ç”¢å“: {product_filters}")
                print(f"   - æ”¯ä»˜æ–¹å¼: {payment_filters}")
                print(f"   - æ˜ŸæœŸ: {selected_weekdays}")
                print(f"   - æ•¸æ“šåº«: {current_db}")
                
                try:
                    print("ğŸš€ æº–å‚™èª¿ç”¨ perform_activity_analysis...")
                    print(f"ğŸ“Š èª¿ç”¨åƒæ•¸:")
                    print(f"   - result_text: {type(result_text)}")
                    print(f"   - date_from_str: {date_from_str}")
                    print(f"   - date_to_str: {date_to_str}")
                    print(f"   - outlet_filters: {outlet_filters}")
                    print(f"   - product_filters: {product_filters}")
                    print(f"   - current_db: {current_db}")
                    print(f"   - payment_filters: {payment_filters}")
                    print(f"   - selected_weekdays: {selected_weekdays}")
                    
                    # å…ˆæ’å…¥ä¸€äº›æ¸¬è©¦å…§å®¹ç¢ºä¿çª—å£æœ‰é¡¯ç¤º
                    result_text.insert(tk.END, "ğŸ” æ­£åœ¨åŸ·è¡Œæ´»å‹•åˆ†æ...\n", "header")
                    result_text.insert(tk.END, f"ğŸ“Š æ´»å‹•åç¨±: {activity_name}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š æ—¥æœŸç¯„åœ: {date_from_str} åˆ° {date_to_str}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š é–€å¸‚æ•¸é‡: {len(outlet_filters) if outlet_filters else 'å…¨éƒ¨'}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š ç”¢å“æ•¸é‡: {len(product_filters) if product_filters else 'å…¨éƒ¨'}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š æ”¯ä»˜æ–¹å¼: {len(payment_filters) if payment_filters else 'å…¨éƒ¨'}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š æ˜ŸæœŸç¯©é¸: {selected_weekdays if selected_weekdays else 'å…¨éƒ¨'}\n", "info")
                    result_text.insert(tk.END, f"ğŸ“Š æ•¸æ“šåº«: {current_db}\n\n", "info")
                    result_text.update()
                    
                    self.perform_activity_analysis(result_text, date_from_str, date_to_str, outlet_filters, product_filters, current_db, payment_filters, selected_weekdays, False, None, None, False)
                    print("âœ… åˆ†æå®Œæˆ")
                except Exception as e:
                    print(f"âŒ åˆ†æéç¨‹ä¸­å‡ºç¾éŒ¯èª¤: {e}")
                    import traceback
                    error_details = traceback.format_exc()
                    print(f"è©³ç´°éŒ¯èª¤: {error_details}")
                    result_text.insert(tk.END, f"âŒ åˆ†æéç¨‹ä¸­å‡ºç¾éŒ¯èª¤: {e}\n", "error")
                    result_text.insert(tk.END, f"ğŸ” éŒ¯èª¤è©³æƒ…: {error_details}\n", "error")
                
                result_text.config(state=tk.DISABLED)

                # ä¸é—œé–‰æ´»å‹•è¨˜éŒ„çª—å£ï¼Œè®“ç”¨æˆ¶å¯ä»¥ç¹¼çºŒé¸æ“‡å…¶ä»–æ´»å‹•é€²è¡Œåˆ†æ
            else:
                print(f"âŒ æœªæ‰¾åˆ°æ´»å‹•è¨˜éŒ„ï¼Œæ´»å‹•ID: {activity_id}")
                print(f"ğŸ“Š å¯ç”¨è¨˜éŒ„ID: {[record.get('id') for record in records]}")
                tk.messagebox.showerror("éŒ¯èª¤", f"æœªæ‰¾åˆ°æ´»å‹•è¨˜éŒ„ï¼Œæ´»å‹•ID: {activity_id}")
            
        def close_window():
            activity_window.destroy()
        
        # ç¾åŒ–æŒ‰éˆ•
        # åˆ†ææŒ‰éˆ•
        analyze_btn = tk.Button(button_frame, 
                              text="ğŸ“Š åˆ†æé¸ä¸­æ´»å‹• / Analyze Selected Activity",
                              command=analyze_selected_activity,
                              font=('Arial', 10, 'bold'),
                              bg='#3498db', fg='white',
                              relief='flat', bd=0,
                              padx=20, pady=10,
                              cursor='hand2')
        analyze_btn.pack(side="left", padx=(0, 10), pady=15)
        
        # åˆ·æ–°æŒ‰éˆ•
        refresh_btn = tk.Button(button_frame, 
                              text="ğŸ”„ åˆ·æ–°æ•¸æ“š / Refresh Data",
                              command=lambda: self.refresh_view_window(tree, current_db),
                              font=('Arial', 10, 'bold'),
                              bg='#f39c12', fg='white',
                              relief='flat', bd=0,
                              padx=20, pady=10,
                              cursor='hand2')
        refresh_btn.pack(side="left", padx=(0, 10), pady=15)
        
        # å°å‡ºæŒ‰éˆ•
        export_btn = tk.Button(button_frame, 
                             text="ğŸ“„ ä¿å­˜Excel / Save Excel",
                             command=self.export_activity_records_to_excel,
                             font=('Arial', 10, 'bold'),
                             bg='#27ae60', fg='white',
                             relief='flat', bd=0,
                             padx=20, pady=10,
                             cursor='hand2')
        export_btn.pack(side="left", padx=(0, 10), pady=15)
        
        # å°å…¥æŒ‰éˆ•
        import_btn = tk.Button(button_frame, 
                             text="ğŸ“¥ è®€å–Excel / Load Excel",
                             command=self.import_activity_records_from_excel,
                             font=('Arial', 10, 'bold'),
                             bg='#9b59b6', fg='white',
                             relief='flat', bd=0,
                             padx=20, pady=10,
                             cursor='hand2')
        import_btn.pack(side="left", padx=(0, 10), pady=15)

        # é—œé–‰æŒ‰éˆ•
        close_btn = tk.Button(button_frame, 
                            text="âŒ é—œé–‰ / Close", 
                            command=close_window,
                            font=('Arial', 10, 'bold'),
                            bg='#e74c3c', fg='white',
                            relief='flat', bd=0,
                            padx=20, pady=10,
                            cursor='hand2')
        close_btn.pack(side="right", pady=15)
    
    def refresh_view_window(self, tree, current_db):
        """åˆ·æ–°æŸ¥çœ‹çª—å£çš„æ•¸æ“š"""
        try:
            print("ğŸ”„ åˆ·æ–°æ•¸æ“šæŒ‰éˆ•è¢«é»æ“Š")
            
            # æ›´æ–°æ—¶é—´æˆ³
            from datetime import datetime
            current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            # æ›´æ–°çª—å£æ ‡é¢˜çš„æ—¶é—´æˆ³
            if hasattr(self, 'view_window_subtitle') and self.view_window_subtitle:
                self.view_window_subtitle.config(text=f"Activity Records - {current_db} Database (Updated: {current_time})")
            
            # æ¸…ç©ºç¾æœ‰æ•¸æ“š
            print("ğŸ—‘ï¸ æ¸…ç©ºç¾æœ‰æ•¸æ“š...")
            for item in tree.get_children():
                tree.delete(item)
            
            # é‡æ–°åˆ†ææ´»åŠ¨è®°å½•ä»¥è·å–æœ€æ–°æ•°æ®
            print("ğŸ”„ é‡æ–°åˆ†ææ´»åŠ¨è®°å½•ä»¥è·å–æœ€æ–°æ•°æ®...")
            self.analyze_existing_activities(target_db=current_db)
            print("âœ… æ´»å‹•è¨˜éŒ„é‡æ–°åˆ†æå®Œæˆ")
            
            # é‡æ–°åŠ è¼‰æ•¸æ“š
            records = self.activity_records.get(current_db, [])
            print(f"ğŸ“Š é‡æ–°åŠ è¼‰ {len(records)} æ¢æ´»å‹•è¨˜éŒ„")
            
            for record in records:
                # æ´»å‹•åç¨±
                activity_name = record.get('description', f"æ´»å‹• {record.get('id', '')}")
                
                # æ—¥æœŸæœŸé–“
                if record.get('type') == 'weekly':
                    date_period = f"{record.get('date_from', '')} - {record.get('date_to', '')}"
                else:
                    date_period = f"{record.get('date_from', '')} - {record.get('date_to', '')}"
                
                # æ˜ŸæœŸç¯©é¸
                weekdays = record.get('weekdays', [])
                weekdays_str = ', '.join(weekdays) if weekdays else 'å…¨éƒ¨'
                
                # åˆ†æçµæœ
                analysis_result = record.get('analysis_result', {})
                if analysis_result:
                    total_sales = f"${analysis_result.get('total_amount', 0):,.2f}"
                    total_receipts = f"{analysis_result.get('total_receipts', 0):,}"
                    activity_sales = f"${analysis_result.get('activity_amount', 0):,.2f}"
                    activity_receipts = f"{analysis_result.get('activity_receipts', 0):,}"
                    sales_ratio = f"{analysis_result.get('amount_ratio', 0):.2f}%"
                    receipt_ratio = f"{analysis_result.get('receipt_ratio', 0):.2f}%"
                else:
                    total_sales = "æœªåˆ†æ"
                    total_receipts = "æœªåˆ†æ"
                    activity_sales = "æœªåˆ†æ"
                    activity_receipts = "æœªåˆ†æ"
                    sales_ratio = "æœªåˆ†æ"
                    receipt_ratio = "æœªåˆ†æ"
                
                tree.insert("", "end", values=(
                    record.get('id', ''),  # æ´»å‹•ID - éš±è—åˆ—
                    activity_name,
                    date_period,
                    weekdays_str,
                    total_sales,
                    total_receipts,
                    activity_sales,
                    activity_receipts,
                    sales_ratio,
                    receipt_ratio
                ))
            
            tk.messagebox.showinfo("æˆåŠŸ", "æ•¸æ“šå·²åˆ·æ–° / Data refreshed successfully")
        except Exception as e:
            tk.messagebox.showerror("éŒ¯èª¤", f"åˆ·æ–°å¤±æ•—: {str(e)}")
    
    def export_activity_records_to_excel(self):
        """å°å‡ºæ´»å‹•è¨˜éŒ„åˆ°Excelæ–‡ä»¶ - ä½¿ç”¨å›ºå®šæ–‡ä»¶å PromotionRecords.xlsx"""
        try:
            import pandas as pd
            from openpyxl import Workbook
            from openpyxl.styles import Font, PatternFill, Border, Side, Alignment
            from openpyxl.utils.dataframe import dataframe_to_rows
            from openpyxl.worksheet.datavalidation import DataValidation
            import os
            
            # ä½¿ç”¨å›ºå®šæ–‡ä»¶åï¼Œä¿å­˜åœ¨ç¨‹åºæ‰€åœ¨ç›®éŒ„
            current_dir = os.path.dirname(os.path.abspath(__file__))
            file_path = os.path.join(current_dir, "PromotionRecords.xlsx")
            
            # å‰µå»ºExcelå·¥ä½œç°¿
            wb = Workbook()
            
            # å®šç¾©æ¨£å¼
            header_font = Font(name='Microsoft YaHei UI', size=12, bold=True, color='FFFFFF')
            header_fill = PatternFill(start_color='4472C4', end_color='4472C4', fill_type='solid')
            data_font = Font(name='Microsoft YaHei UI', size=10)
            border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
            center_alignment = Alignment(horizontal='center', vertical='center')
            
            # æ•¸æ“šåº«åˆ—è¡¨
            databases = ['GOGO', 'Express', 'PLUS']
            
            # ç¢ºä¿å‡æœŸè¨˜éŒ„å­˜åœ¨
            if not hasattr(self, 'holiday_records'):
                self.holiday_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': []
                }
            
            for db_name in databases:
                # å‰µå»ºæˆ–é¸æ“‡å·¥ä½œè¡¨
                if db_name == 'GOGO':
                    ws = wb.active
                    ws.title = db_name
                else:
                    ws = wb.create_sheet(title=db_name)
                
                # ç²å–è©²æ•¸æ“šåº«çš„æ´»å‹•è¨˜éŒ„
                records = self.activity_records.get(db_name, [])
                
                if not records:
                    # å¦‚æœæ²’æœ‰è¨˜éŒ„ï¼Œå‰µå»ºç©ºçš„è¡¨é ­
                    headers = [
                        'æ´»å‹•ID', 'æ´»å‹•åç¨±', 'æ´»å‹•é¡å‹', 'é–‹å§‹æ—¥æœŸ', 'çµæŸæ—¥æœŸ', 
                        'æ˜ŸæœŸç¯©é¸', 'æ¶‰åŠé–€å¸‚', 'æ¶‰åŠéƒ¨åˆ†', 'æ¶‰åŠç”¢å“', 'æ”¯ä»˜æ–¹å¼',
                        'ç¸½æ¥­ç¸¾', 'ç¸½å–®æ“šæ•¸', 'æ´»å‹•æ¥­ç¸¾', 'æ´»å‹•å–®æ“šæ•¸', 
                        'æ¥­ç¸¾å æ¯”%', 'å–®æ“šæ•¸å æ¯”%', 'åˆ†ææ™‚é–“', 'å‰µå»ºæ™‚é–“'
                    ]
                    
                    # å¯«å…¥è¡¨é ­
                    for col, header in enumerate(headers, 1):
                        cell = ws.cell(row=1, column=col, value=header)
                        cell.font = header_font
                        cell.fill = header_fill
                        cell.border = border
                        cell.alignment = center_alignment
                    
                    # å¯«å…¥ç©ºæ•¸æ“šæç¤º
                    ws.cell(row=2, column=1, value=f"æš«ç„¡ {db_name} æ•¸æ“šåº«çš„æ´»å‹•è¨˜éŒ„")
                    ws.cell(row=2, column=1).font = Font(name='Microsoft YaHei UI', size=10, italic=True, color='666666')
                    
                    # èª¿æ•´åˆ—å¯¬
                    for col in range(1, len(headers) + 1):
                        ws.column_dimensions[chr(64 + col)].width = 15
                    
                    continue
                
                # æº–å‚™æ•¸æ“š
                data_rows = []
                for record in records:
                    # åˆ†æçµæœ
                    analysis_result = record.get('analysis_result', {})
                    
                    row_data = [
                        record.get('id', ''),
                        record.get('description', ''),
                        record.get('type', ''),
                        record.get('date_from', ''),
                        record.get('date_to', ''),
                        ', '.join(record.get('weekdays', [])),
                        ', '.join(record.get('outlets', [])),
                        ', '.join(record.get('parts', [])),
                        ', '.join(record.get('products', [])),
                        ', '.join(record.get('payment_methods', [])),
                        f"${analysis_result.get('total_amount', 0):,.2f}" if analysis_result else 'æœªåˆ†æ',
                        f"{analysis_result.get('total_receipts', 0):,}" if analysis_result else 'æœªåˆ†æ',
                        f"${analysis_result.get('activity_amount', 0):,.2f}" if analysis_result else 'æœªåˆ†æ',
                        f"{analysis_result.get('activity_receipts', 0):,}" if analysis_result else 'æœªåˆ†æ',
                        f"{analysis_result.get('amount_ratio', 0):.2f}%" if analysis_result else 'æœªåˆ†æ',
                        f"{analysis_result.get('receipt_ratio', 0):.2f}%" if analysis_result else 'æœªåˆ†æ',
                        analysis_result.get('analyzed_time', '') if analysis_result else '',
                        record.get('created_time', '')
                    ]
                    data_rows.append(row_data)
                
                # è¡¨é ­
                headers = [
                    'æ´»å‹•ID', 'æ´»å‹•åç¨±', 'æ´»å‹•é¡å‹', 'é–‹å§‹æ—¥æœŸ', 'çµæŸæ—¥æœŸ', 
                    'æ˜ŸæœŸç¯©é¸', 'æ¶‰åŠé–€å¸‚', 'æ¶‰åŠéƒ¨åˆ†', 'æ¶‰åŠç”¢å“', 'æ”¯ä»˜æ–¹å¼',
                    'ç¸½æ¥­ç¸¾', 'ç¸½å–®æ“šæ•¸', 'æ´»å‹•æ¥­ç¸¾', 'æ´»å‹•å–®æ“šæ•¸', 
                    'æ¥­ç¸¾å æ¯”%', 'å–®æ“šæ•¸å æ¯”%', 'åˆ†ææ™‚é–“', 'å‰µå»ºæ™‚é–“'
                ]
                
                # å¯«å…¥è¡¨é ­
                for col, header in enumerate(headers, 1):
                    cell = ws.cell(row=1, column=col, value=header)
                    cell.font = header_font
                    cell.fill = header_fill
                    cell.border = border
                    cell.alignment = center_alignment
                
                # å¯«å…¥æ•¸æ“š
                for row_idx, row_data in enumerate(data_rows, 2):
                    for col_idx, value in enumerate(row_data, 1):
                        cell = ws.cell(row=row_idx, column=col_idx, value=value)
                        cell.font = data_font
                        cell.border = border
                        cell.alignment = center_alignment
                        
                        # ç‚ºæ¥­ç¸¾ç›¸é—œåˆ—æ·»åŠ ç‰¹æ®Šæ ¼å¼
                        if col_idx in [11, 13]:  # ç¸½æ¥­ç¸¾, æ´»å‹•æ¥­ç¸¾
                            cell.number_format = '$#,##0.00'
                        elif col_idx in [12, 14]:  # ç¸½å–®æ“šæ•¸, æ´»å‹•å–®æ“šæ•¸
                            cell.number_format = '#,##0'
                        elif col_idx in [15, 16]:  # æ¥­ç¸¾å æ¯”%, å–®æ“šæ•¸å æ¯”%
                            cell.number_format = '0.00%'
                
                # èª¿æ•´åˆ—å¯¬
                column_widths = [8, 25, 10, 12, 12, 15, 20, 15, 30, 20, 12, 12, 12, 12, 10, 10, 18, 18]
                for col, width in enumerate(column_widths, 1):
                    ws.column_dimensions[chr(64 + col)].width = width
                
                # å‡çµé¦–è¡Œ
                ws.freeze_panes = 'A2'
            
            # æ·»åŠ å‡æœŸè¨˜éŒ„å·¥ä½œè¡¨
            holiday_ws = wb.create_sheet(title='Holidays')
            
            # å‡æœŸè¨˜éŒ„è¡¨é ­
            holiday_headers = [
                'æ•¸æ“šåº«', 'é–‹å§‹æ—¥æœŸ', 'çµæŸæ—¥æœŸ', 'å‡æœŸåç¨±', 'å‡æœŸé•·åº¦(å¤©)'
            ]
            
            # å¯«å…¥å‡æœŸè¡¨é ­
            for col, header in enumerate(holiday_headers, 1):
                cell = holiday_ws.cell(row=1, column=col, value=header)
                cell.font = header_font
                cell.fill = header_fill
                cell.border = border
                cell.alignment = center_alignment
            
            # å¯«å…¥å‡æœŸæ•¸æ“š
            holiday_row = 2
            for db_name in databases:
                holiday_records = self.holiday_records.get(db_name, [])
                for record in holiday_records:
                    holiday_ws.cell(row=holiday_row, column=1, value=db_name).font = data_font
                    holiday_ws.cell(row=holiday_row, column=1).border = border
                    holiday_ws.cell(row=holiday_row, column=1).alignment = center_alignment
                    
                    holiday_ws.cell(row=holiday_row, column=2, value=record.get('start_date', '')).font = data_font
                    holiday_ws.cell(row=holiday_row, column=2).border = border
                    holiday_ws.cell(row=holiday_row, column=2).alignment = center_alignment
                    
                    holiday_ws.cell(row=holiday_row, column=3, value=record.get('end_date', '')).font = data_font
                    holiday_ws.cell(row=holiday_row, column=3).border = border
                    holiday_ws.cell(row=holiday_row, column=3).alignment = center_alignment
                    
                    holiday_ws.cell(row=holiday_row, column=4, value=record.get('holiday_name', '')).font = data_font
                    holiday_ws.cell(row=holiday_row, column=4).border = border
                    holiday_ws.cell(row=holiday_row, column=4).alignment = center_alignment
                    
                    holiday_ws.cell(row=holiday_row, column=5, value=record.get('duration', 0)).font = data_font
                    holiday_ws.cell(row=holiday_row, column=5).border = border
                    holiday_ws.cell(row=holiday_row, column=5).alignment = center_alignment
                    holiday_ws.cell(row=holiday_row, column=5).number_format = '#,##0'
                    
                    holiday_row += 1
            
            # å¦‚æœæ²’æœ‰å‡æœŸè¨˜éŒ„ï¼Œå¯«å…¥æç¤º
            if holiday_row == 2:
                holiday_ws.cell(row=2, column=1, value="æš«ç„¡å‡æœŸè¨˜éŒ„")
                holiday_ws.cell(row=2, column=1).font = Font(name='Microsoft YaHei UI', size=10, italic=True, color='666666')
            
            # èª¿æ•´å‡æœŸå·¥ä½œè¡¨åˆ—å¯¬
            holiday_column_widths = [12, 12, 12, 25, 15]
            for col, width in enumerate(holiday_column_widths, 1):
                holiday_ws.column_dimensions[chr(64 + col)].width = width
            
            # å‡çµå‡æœŸå·¥ä½œè¡¨é¦–è¡Œ
            holiday_ws.freeze_panes = 'A2'
            
            # æ·»åŠ æ•¸æ“šé©—è­‰å’Œç¯©é¸åŠŸèƒ½
            self.add_excel_validation_and_filters(wb)
            
            # å‰µå»ºç”¢å“æ•¸æ“šåº«å·¥ä½œè¡¨
            self.create_product_database_sheet(wb)
            
            # æ·»åŠ å¤šé¸ä¸‹æ‹‰åˆ—è¡¨åŠŸèƒ½
            self.add_multiselect_dropdowns(wb)
            
            # å‰µå»ºä½¿ç”¨èªªæ˜å·¥ä½œè¡¨
            self.create_usage_guide_sheet(wb)
            
            # æ·»åŠ VBAå®å¯¦ç¾çœŸæ­£çš„å¤šé¸åŠŸèƒ½
            self.add_vba_multiselect_macro(wb)
            
            # å‰µå»ºå¤šé¸åŠ©æ‰‹å·¥ä½œè¡¨
            self.create_multiselect_helper_sheet(wb)
            
            # ä¿å­˜æ–‡ä»¶
            wb.save(file_path)
            
            tk.messagebox.showinfo(
                "æˆåŠŸ / Success", 
                f"æ´»å‹•è¨˜éŒ„å·²æˆåŠŸå°å‡ºåˆ°Excelæ–‡ä»¶:\nActivity records exported successfully to:\n{file_path}\n\nåŒ…å«7å€‹å·¥ä½œè¡¨: ä½¿ç”¨èªªæ˜, å¤šé¸åŠ©æ‰‹, ProductDatabase, GOGO, Express, PLUS, Holidays\nContains 7 worksheets: ä½¿ç”¨èªªæ˜, å¤šé¸åŠ©æ‰‹, ProductDatabase, GOGO, Express, PLUS, Holidays\n\nâœ… å·²æ·»åŠ æ•¸æ“šé©—è­‰å’Œç¯©é¸åŠŸèƒ½\nâœ… Data validation and filters added\n\nâœ… å·²å‰µå»ºç”¢å“æ•¸æ“šåº«å·¥ä½œè¡¨\nâœ… Product database sheet created\n\nâœ… å·²æ·»åŠ å¤šé¸ä¸‹æ‹‰åˆ—è¡¨åŠŸèƒ½\nâœ… Multi-select dropdowns added\n\nâœ… å·²å‰µå»ºä½¿ç”¨èªªæ˜å·¥ä½œè¡¨\nâœ… Usage guide sheet created\n\nâœ… å·²å‰µå»ºå¤šé¸åŠ©æ‰‹å·¥ä½œè¡¨\nâœ… Multi-select helper sheet created"
            )
            
        except Exception as e:
            tk.messagebox.showerror(
                "éŒ¯èª¤ / Error", 
                f"å°å‡ºExcelæ–‡ä»¶å¤±æ•—:\nFailed to export Excel file:\n{str(e)}"
            )
    
    def add_excel_validation_and_filters(self, wb):
        """ç‚ºExcelæ–‡ä»¶æ·»åŠ æ•¸æ“šé©—è­‰å’Œç¯©é¸åŠŸèƒ½"""
        try:
            from openpyxl.worksheet.datavalidation import DataValidation
            from openpyxl.worksheet.filters import AutoFilter
            
            # ç²å–æ‰€æœ‰å¯ç”¨çš„é¸é …æ•¸æ“š
            all_outlets = set()
            all_products = set()
            all_payment_methods = set()
            all_parts = set()
            all_weekdays = set()
            
            # å¾æ´»å‹•è¨˜éŒ„ä¸­æ”¶é›†æ‰€æœ‰å¯ç”¨çš„é¸é …
            for db_name in ['GOGO', 'Express', 'PLUS']:
                records = self.activity_records.get(db_name, [])
                for record in records:
                    # æ”¶é›†é–€å¸‚
                    outlets = record.get('outlets', [])
                    if outlets:
                        if isinstance(outlets, str):
                            all_outlets.update([o.strip() for o in outlets.split(',') if o.strip()])
                        elif isinstance(outlets, list):
                            all_outlets.update([o.strip() for o in outlets if o.strip()])
                    
                    # æ”¶é›†ç”¢å“
                    products = record.get('products', [])
                    if products:
                        if isinstance(products, str):
                            all_products.update([p.strip() for p in products.split(',') if p.strip()])
                        elif isinstance(products, list):
                            all_products.update([p.strip() for p in products if p.strip()])
                    
                    # æ”¶é›†æ”¯ä»˜æ–¹å¼
                    payment_methods = record.get('payment_methods', [])
                    if payment_methods:
                        if isinstance(payment_methods, str):
                            all_payment_methods.update([pm.strip() for pm in payment_methods.split(',') if pm.strip()])
                        elif isinstance(payment_methods, list):
                            all_payment_methods.update([pm.strip() for pm in payment_methods if pm.strip()])
                    
                    # æ”¶é›†éƒ¨åˆ†
                    parts = record.get('parts', [])
                    if parts:
                        if isinstance(parts, str):
                            all_parts.update([p.strip() for p in parts.split(',') if p.strip()])
                        elif isinstance(parts, list):
                            all_parts.update([p.strip() for p in parts if p.strip()])
                    
                    # æ”¶é›†æ˜ŸæœŸ
                    weekdays = record.get('weekdays', [])
                    if weekdays:
                        if isinstance(weekdays, str):
                            all_weekdays.update([w.strip() for w in weekdays.split(',') if w.strip()])
                        elif isinstance(weekdays, list):
                            all_weekdays.update([w.strip() for w in weekdays if w.strip()])
            
            # æ·»åŠ é»˜èªé¸é …
            default_outlets = ['MPINES', '304 - TOA PAYOH', '306-J8', '307-HGTO', '308 - OASIS', '309 - YEW TEE SQUARE', '310 - SENGKANG MRT', '311 - THE POIZ CENTRE', '312 - ANG MO KIO']
            default_products = ['Salmon Sashimi (13pcs)', 'Salmon Sashimi (8pcs)', 'Salmon Sushi 10pcs', 'Salmon Roll', 'Salmon Nigiri']
            default_payment_methods = ['VISA', 'MASTER', 'NETS', 'AMEX', 'UnionPay', 'DBS MAX', 'CDC Voucher', 'Mall Voucher', 'GRAB FOOD', 'FOOD PANDA', 'DELIVEROO', 'SE APP', 'WASTAGE']
            default_parts = ['DI', 'TA', 'Delivery', 'Food Panda', 'Grab Food', 'Deliveroo', 'All']
            default_weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
            
            all_outlets.update(default_outlets)
            all_products.update(default_products)
            all_payment_methods.update(default_payment_methods)
            all_parts.update(default_parts)
            all_weekdays.update(default_weekdays)
            
            # è½‰æ›ç‚ºæ’åºåˆ—è¡¨
            outlets_list = sorted(list(all_outlets))
            products_list = sorted(list(all_products))
            payment_methods_list = sorted(list(all_payment_methods))
            parts_list = sorted(list(all_parts))
            weekdays_list = sorted(list(all_weekdays))
            
            # ç‚ºæ¯å€‹æ´»å‹•è¨˜éŒ„å·¥ä½œè¡¨æ·»åŠ æ•¸æ“šé©—è­‰
            for sheet_name in ['GOGO', 'Express', 'PLUS']:
                if sheet_name in wb.sheetnames:
                    ws = wb[sheet_name]
                    
                    # æ·»åŠ è‡ªå‹•ç¯©é¸
                    ws.auto_filter.ref = f"A1:R{ws.max_row}"
                    
                    # æ´»å‹•é¡å‹æ•¸æ“šé©—è­‰
                    activity_type_dv = DataValidation(type="list", formula1='"daily,weekly"', allow_blank=True)
                    activity_type_dv.error = "è«‹é¸æ“‡æœ‰æ•ˆçš„æ´»å‹•é¡å‹ (daily æˆ– weekly)"
                    activity_type_dv.errorTitle = "ç„¡æ•ˆçš„æ´»å‹•é¡å‹"
                    ws.add_data_validation(activity_type_dv)
                    activity_type_dv.add(f"C2:C{ws.max_row}")
                    
                    # æ˜ŸæœŸç¯©é¸æ•¸æ“šé©—è­‰
                    weekdays_formula = f'"{",".join(weekdays_list)}"'
                    weekdays_dv = DataValidation(type="list", formula1=weekdays_formula, allow_blank=True)
                    weekdays_dv.error = "è«‹é¸æ“‡æœ‰æ•ˆçš„æ˜ŸæœŸ"
                    weekdays_dv.errorTitle = "ç„¡æ•ˆçš„æ˜ŸæœŸ"
                    ws.add_data_validation(weekdays_dv)
                    weekdays_dv.add(f"F2:F{ws.max_row}")
                    
                    # æ¶‰åŠéƒ¨åˆ†æ•¸æ“šé©—è­‰
                    parts_formula = f'"{",".join(parts_list)}"'
                    parts_dv = DataValidation(type="list", formula1=parts_formula, allow_blank=True)
                    parts_dv.error = "è«‹é¸æ“‡æœ‰æ•ˆçš„éƒ¨åˆ†"
                    parts_dv.errorTitle = "ç„¡æ•ˆçš„éƒ¨åˆ†"
                    ws.add_data_validation(parts_dv)
                    parts_dv.add(f"H2:H{ws.max_row}")
                    
                    print(f"âœ… å·²ç‚º {sheet_name} å·¥ä½œè¡¨æ·»åŠ æ•¸æ“šé©—è­‰")
            
            # ç‚ºå‡æœŸå·¥ä½œè¡¨æ·»åŠ æ•¸æ“šé©—è­‰
            if 'Holidays' in wb.sheetnames:
                holiday_ws = wb['Holidays']
                
                # æ·»åŠ è‡ªå‹•ç¯©é¸
                holiday_ws.auto_filter.ref = f"A1:E{holiday_ws.max_row}"
                
                # æ•¸æ“šåº«æ•¸æ“šé©—è­‰
                database_dv = DataValidation(type="list", formula1='"GOGO,Express,PLUS"', allow_blank=True)
                database_dv.error = "è«‹é¸æ“‡æœ‰æ•ˆçš„æ•¸æ“šåº« (GOGO, Express, æˆ– PLUS)"
                database_dv.errorTitle = "ç„¡æ•ˆçš„æ•¸æ“šåº«"
                holiday_ws.add_data_validation(database_dv)
                database_dv.add(f"A2:A{holiday_ws.max_row}")
                
                print("âœ… å·²ç‚º Holidays å·¥ä½œè¡¨æ·»åŠ æ•¸æ“šé©—è­‰")
            
            print("âœ… Excelæ•¸æ“šé©—è­‰å’Œç¯©é¸åŠŸèƒ½æ·»åŠ å®Œæˆ")
            
        except Exception as e:
            print(f"âš ï¸ æ·»åŠ Excelæ•¸æ“šé©—è­‰å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
    
    def create_product_database_sheet(self, wb):
        """å‰µå»ºç”¢å“æ•¸æ“šåº«å·¥ä½œè¡¨"""
        try:
            from openpyxl.styles import Font, PatternFill, Border, Side, Alignment
            
            # å‰µå»ºç”¢å“æ•¸æ“šåº«å·¥ä½œè¡¨
            product_db_ws = wb.create_sheet(title='ProductDatabase', index=0)  # æ”¾åœ¨ç¬¬ä¸€å€‹ä½ç½®
            
            # ç”¢å“æ•¸æ“šåº«è¡¨é ­
            headers = [
                'ç”¢å“ID', 'ç”¢å“åç¨±', 'ç”¢å“é¡åˆ¥', 'ç”¢å“æè¿°', 'åƒ¹æ ¼', 'ç‹€æ…‹', 'å‰µå»ºæ—¥æœŸ', 'å‚™è¨»'
            ]
            
            # å¯«å…¥è¡¨é ­
            for col, header in enumerate(headers, 1):
                cell = product_db_ws.cell(row=1, column=col, value=header)
                cell.font = Font(name='Microsoft YaHei UI', size=12, bold=True, color='FFFFFF')
                cell.fill = PatternFill(start_color='2E8B57', end_color='2E8B57', fill_type='solid')
                cell.border = Border(
                    left=Side(style='thin'),
                    right=Side(style='thin'),
                    top=Side(style='thin'),
                    bottom=Side(style='thin')
                )
                cell.alignment = Alignment(horizontal='center', vertical='center')
            
            # ç²å–æ‰€æœ‰ç”¢å“æ•¸æ“š
            all_products = set()
            all_categories = set()
            
            # å¾æ´»å‹•è¨˜éŒ„ä¸­æ”¶é›†ç”¢å“å’Œé¡åˆ¥
            for db_name in ['GOGO', 'Express', 'PLUS']:
                records = self.activity_records.get(db_name, [])
                for record in records:
                    products = record.get('products', [])
                    if products:
                        if isinstance(products, str):
                            product_list = [p.strip() for p in products.split(',') if p.strip()]
                            all_products.update(product_list)
                        elif isinstance(products, list):
                            all_products.update([p.strip() for p in products if p.strip()])
            
            # æ·»åŠ é»˜èªç”¢å“æ•¸æ“š
            default_products = [
                ('P001', 'Salmon Sashimi (13pcs)', 'Sashimi', 'æ–°é®®ä¸‰æ–‡é­šåˆºèº« 13ç‰‡', '$25.90', 'Active', '2025-01-01', 'ç†±é–€ç”¢å“'),
                ('P002', 'Salmon Sashimi (8pcs)', 'Sashimi', 'æ–°é®®ä¸‰æ–‡é­šåˆºèº« 8ç‰‡', '$18.90', 'Active', '2025-01-01', 'ç†±é–€ç”¢å“'),
                ('P003', 'Salmon Sushi 10pcs', 'Sushi', 'ä¸‰æ–‡é­šå£½å¸ 10ä»¶', '$22.90', 'Active', '2025-01-01', 'ç†±é–€ç”¢å“'),
                ('P004', 'Salmon Roll', 'Roll', 'ä¸‰æ–‡é­šå·', '$15.90', 'Active', '2025-01-01', 'ç†±é–€ç”¢å“'),
                ('P005', 'Salmon Nigiri', 'Nigiri', 'ä¸‰æ–‡é­šæ¡å£½å¸', '$12.90', 'Active', '2025-01-01', 'ç†±é–€ç”¢å“'),
                ('P006', 'Tuna Sashimi (10pcs)', 'Sashimi', 'æ–°é®®åæ‹¿é­šåˆºèº« 10ç‰‡', '$28.90', 'Active', '2025-01-01', ''),
                ('P007', 'Eel Roll', 'Roll', 'é°»é­šå·', '$18.90', 'Active', '2025-01-01', ''),
                ('P008', 'California Roll', 'Roll', 'åŠ å·å·', '$16.90', 'Active', '2025-01-01', ''),
                ('P009', 'Tempura Roll', 'Roll', 'å¤©å©¦ç¾…å·', '$19.90', 'Active', '2025-01-01', ''),
                ('P010', 'Dragon Roll', 'Roll', 'é¾å·', '$24.90', 'Active', '2025-01-01', '')
            ]
            
            # æ·»åŠ å¾æ´»å‹•è¨˜éŒ„ä¸­æ”¶é›†çš„ç”¢å“
            product_id = 11
            for product in sorted(all_products):
                if product not in [p[1] for p in default_products]:
                    # ç°¡å–®åˆ†é¡é‚è¼¯
                    if 'Sashimi' in product:
                        category = 'Sashimi'
                    elif 'Sushi' in product:
                        category = 'Sushi'
                    elif 'Roll' in product:
                        category = 'Roll'
                    elif 'Nigiri' in product:
                        category = 'Nigiri'
                    else:
                        category = 'Other'
                    
                    default_products.append((f'P{product_id:03d}', product, category, f'{product} æè¿°', '$0.00', 'Active', '2025-01-01', 'å¾æ´»å‹•è¨˜éŒ„å°å…¥'))
                    product_id += 1
            
            # å¯«å…¥ç”¢å“æ•¸æ“š
            for row_idx, (product_id, product_name, category, description, price, status, created_date, notes) in enumerate(default_products, 2):
                product_db_ws.cell(row=row_idx, column=1, value=product_id).font = Font(name='Arial', size=10)
                product_db_ws.cell(row=row_idx, column=2, value=product_name).font = Font(name='Arial', size=10)
                product_db_ws.cell(row=row_idx, column=3, value=category).font = Font(name='Arial', size=10)
                product_db_ws.cell(row=row_idx, column=4, value=description).font = Font(name='Arial', size=10)
                product_db_ws.cell(row=row_idx, column=5, value=price).font = Font(name='Arial', size=10)
                product_db_ws.cell(row=row_idx, column=6, value=status).font = Font(name='Arial', size=10)
                product_db_ws.cell(row=row_idx, column=7, value=created_date).font = Font(name='Arial', size=10)
                product_db_ws.cell(row=row_idx, column=8, value=notes).font = Font(name='Arial', size=10)
                
                # æ·»åŠ é‚Šæ¡†
                for col in range(1, 9):
                    product_db_ws.cell(row=row_idx, column=col).border = Border(
                        left=Side(style='thin'),
                        right=Side(style='thin'),
                        top=Side(style='thin'),
                        bottom=Side(style='thin')
                    )
                    product_db_ws.cell(row=row_idx, column=col).alignment = Alignment(horizontal='center', vertical='center')
            
            # èª¿æ•´åˆ—å¯¬
            column_widths = [12, 30, 15, 40, 12, 10, 12, 20]
            for col, width in enumerate(column_widths, 1):
                product_db_ws.column_dimensions[chr(64 + col)].width = width
            
            # å‡çµé¦–è¡Œ
            product_db_ws.freeze_panes = 'A2'
            
            # æ·»åŠ è‡ªå‹•ç¯©é¸
            product_db_ws.auto_filter.ref = f"A1:H{len(default_products) + 1}"
            
            print(f"âœ… ç”¢å“æ•¸æ“šåº«å·¥ä½œè¡¨å·²å‰µå»ºï¼ŒåŒ…å« {len(default_products)} å€‹ç”¢å“")
            
        except Exception as e:
            print(f"âš ï¸ å‰µå»ºç”¢å“æ•¸æ“šåº«å·¥ä½œè¡¨å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
    
    def add_multiselect_dropdowns(self, wb):
        """æ·»åŠ å¤šé¸ä¸‹æ‹‰åˆ—è¡¨åŠŸèƒ½"""
        try:
            from openpyxl.worksheet.datavalidation import DataValidation
            
            # ç‚ºæ¯å€‹æ´»å‹•è¨˜éŒ„å·¥ä½œè¡¨æ·»åŠ å¤šé¸ä¸‹æ‹‰åˆ—è¡¨
            for sheet_name in ['GOGO', 'Express', 'PLUS']:
                if sheet_name in wb.sheetnames:
                    ws = wb[sheet_name]
                    
                    # ç²å–ç”¢å“æ•¸æ“šåº«ä¸­çš„ç”¢å“åˆ—è¡¨
                    product_db_ws = wb.get_sheet_by_name('ProductDatabase')
                    products = []
                    for row in range(2, product_db_ws.max_row + 1):
                        product_name = product_db_ws.cell(row=row, column=2).value
                        if product_name:
                            products.append(str(product_name))
                    
                    # å‰µå»ºç”¢å“å¤šé¸ä¸‹æ‹‰åˆ—è¡¨
                    if products:
                        # ä½¿ç”¨ INDIRECT å‡½æ•¸å‰µå»ºå‹•æ…‹ä¸‹æ‹‰åˆ—è¡¨
                        product_list_formula = f'ProductDatabase!$B$2:$B${len(products) + 1}'
                        
                        # ç‚ºç”¢å“åˆ—æ·»åŠ æ•¸æ“šé©—è­‰
                        product_dv = DataValidation(type="list", formula1=product_list_formula, allow_blank=True)
                        product_dv.error = "è«‹å¾ç”¢å“æ•¸æ“šåº«ä¸­é¸æ“‡ç”¢å“\n\nğŸ’¡ å¤šé¸æç¤ºï¼š\n1. é¸æ“‡ç¬¬ä¸€å€‹ç”¢å“\n2. æ‰‹å‹•è¼¸å…¥é€—è™Ÿå’Œç©ºæ ¼\n3. å†æ¬¡é¸æ“‡ä¸‹ä¸€å€‹ç”¢å“\n4. é‡è¤‡æ­¤éç¨‹é¸æ“‡å¤šå€‹ç”¢å“\n\nç¯„ä¾‹ï¼šSalmon Sashimi (13pcs), Salmon Roll, Salmon Nigiri"
                        product_dv.errorTitle = "ç”¢å“é¸æ“‡ - å¤šé¸æŒ‡å—"
                        ws.add_data_validation(product_dv)
                        product_dv.add(f"I2:I{ws.max_row}")  # ç”¢å“åˆ—
                        
                        print(f"âœ… å·²ç‚º {sheet_name} å·¥ä½œè¡¨çš„ç”¢å“åˆ—æ·»åŠ å¤šé¸ä¸‹æ‹‰åˆ—è¡¨")
                    
                    # ç‚ºå…¶ä»–åˆ—æ·»åŠ å¤šé¸ä¸‹æ‹‰åˆ—è¡¨
                    # é–€å¸‚å¤šé¸ä¸‹æ‹‰åˆ—è¡¨
                    outlets_formula = '"MPINES, 304 - TOA PAYOH, 306-J8, 307-HGTO, 308 - OASIS, 309 - YEW TEE SQUARE, 310 - SENGKANG MRT, 311 - THE POIZ CENTRE, 312 - ANG MO KIO"'
                    outlets_dv = DataValidation(type="list", formula1=outlets_formula, allow_blank=True)
                    outlets_dv.error = "è«‹é¸æ“‡æœ‰æ•ˆçš„é–€å¸‚"
                    outlets_dv.errorTitle = "é–€å¸‚é¸æ“‡"
                    ws.add_data_validation(outlets_dv)
                    outlets_dv.add(f"G2:G{ws.max_row}")  # é–€å¸‚åˆ—
                    
                    # æ”¯ä»˜æ–¹å¼å¤šé¸ä¸‹æ‹‰åˆ—è¡¨
                    payment_formula = '"VISA, MASTER, NETS, AMEX, UnionPay, DBS MAX, CDC Voucher, Mall Voucher, GRAB FOOD, FOOD PANDA, DELIVEROO, SE APP, WASTAGE"'
                    payment_dv = DataValidation(type="list", formula1=payment_formula, allow_blank=True)
                    payment_dv.error = "è«‹é¸æ“‡æœ‰æ•ˆçš„æ”¯ä»˜æ–¹å¼"
                    payment_dv.errorTitle = "æ”¯ä»˜æ–¹å¼é¸æ“‡"
                    ws.add_data_validation(payment_dv)
                    payment_dv.add(f"J2:J{ws.max_row}")  # æ”¯ä»˜æ–¹å¼åˆ—
                    
                    print(f"âœ… å·²ç‚º {sheet_name} å·¥ä½œè¡¨æ·»åŠ å¤šé¸ä¸‹æ‹‰åˆ—è¡¨")
            
            print("âœ… å¤šé¸ä¸‹æ‹‰åˆ—è¡¨åŠŸèƒ½æ·»åŠ å®Œæˆ")
            
        except Exception as e:
            print(f"âš ï¸ æ·»åŠ å¤šé¸ä¸‹æ‹‰åˆ—è¡¨å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
    
    def create_usage_guide_sheet(self, wb):
        """å‰µå»ºä½¿ç”¨èªªæ˜å·¥ä½œè¡¨"""
        try:
            from openpyxl.styles import Font, PatternFill, Border, Side, Alignment
            
            # å‰µå»ºä½¿ç”¨èªªæ˜å·¥ä½œè¡¨
            guide_ws = wb.create_sheet(title='ä½¿ç”¨èªªæ˜', index=1)  # æ”¾åœ¨ç¬¬äºŒå€‹ä½ç½®
            
            # æ¨™é¡Œ
            title_cell = guide_ws.cell(row=1, column=1, value="ğŸ“‹ PromotionRecords.xlsx ä½¿ç”¨èªªæ˜")
            title_cell.font = Font(name='Microsoft YaHei UI', size=16, bold=True, color='FFFFFF')
            title_cell.fill = PatternFill(start_color='2E8B57', end_color='2E8B57', fill_type='solid')
            title_cell.alignment = Alignment(horizontal='center', vertical='center')
            guide_ws.merge_cells('A1:D1')
            
            # ä½¿ç”¨èªªæ˜å…§å®¹
            instructions = [
                ("", "", "", ""),
                ("ğŸ“Š å·¥ä½œè¡¨èªªæ˜", "", "", ""),
                ("ProductDatabase", "ç”¢å“æ•¸æ“šåº«", "åŒ…å«æ‰€æœ‰å¯ç”¨ç”¢å“çš„è©³ç´°ä¿¡æ¯", "ç”¨æ–¼ä¸‹æ‹‰åˆ—è¡¨çš„æ•¸æ“šæº"),
                ("GOGO", "GOGOæ´»å‹•è¨˜éŒ„", "GOGOå“ç‰Œçš„ä¿ƒéŠ·æ´»å‹•è¨˜éŒ„", "åŒ…å«åˆ†æçµæœå’Œæ¥­ç¸¾æ•¸æ“š"),
                ("Express", "Expressæ´»å‹•è¨˜éŒ„", "Expresså“ç‰Œçš„ä¿ƒéŠ·æ´»å‹•è¨˜éŒ„", "åŒ…å«åˆ†æçµæœå’Œæ¥­ç¸¾æ•¸æ“š"),
                ("PLUS", "PLUSæ´»å‹•è¨˜éŒ„", "PLUSå“ç‰Œçš„ä¿ƒéŠ·æ´»å‹•è¨˜éŒ„", "åŒ…å«åˆ†æçµæœå’Œæ¥­ç¸¾æ•¸æ“š"),
                ("Holidays", "å‡æœŸè¨˜éŒ„", "å„å“ç‰Œçš„å‡æœŸå’Œç‰¹æ®Šæ—¥æœŸ", "ç”¨æ–¼æ´»å‹•åˆ†æçš„æ™‚é–“ç¯©é¸"),
                ("", "", "", ""),
                ("ğŸ’¡ å¤šé¸åŠŸèƒ½ä½¿ç”¨æŒ‡å—", "", "", ""),
                ("æ–¹æ³•", "æ“ä½œ", "èªªæ˜", "ç¯„ä¾‹"),
                ("æ–¹æ³•1ï¼šæ‰‹å‹•è¼¸å…¥", "ç›´æ¥è¼¸å…¥ç”¢å“åç¨±", "åœ¨å–®å…ƒæ ¼ä¸­ç›´æ¥è¼¸å…¥å¤šå€‹ç”¢å“", "Salmon Sashimi (13pcs), Salmon Roll, Salmon Nigiri"),
                ("æ–¹æ³•2ï¼šè¤‡è£½ç²˜è²¼", "å¾ProductDatabaseè¤‡è£½", "å¾ç”¢å“æ•¸æ“šåº«å·¥ä½œè¡¨è¤‡è£½ç”¢å“åç¨±", "è¤‡è£½å¤šå€‹ç”¢å“åç¨±ï¼Œç”¨é€—è™Ÿåˆ†éš”"),
                ("æ–¹æ³•3ï¼šåˆ†æ­¥è¼¸å…¥", "å…ˆè¼¸å…¥ä¸€å€‹ï¼Œå†æ·»åŠ ", "è¼¸å…¥ç¬¬ä¸€å€‹ç”¢å“ï¼Œç„¶å¾Œæ‰‹å‹•æ·»åŠ æ›´å¤š", "Salmon Sashimi (13pcs), ç„¶å¾Œæ‰‹å‹•æ·»åŠ  , Salmon Roll"),
                ("âš ï¸ é‡è¦æç¤º", "æ¨™æº–ä¸‹æ‹‰åˆ—è¡¨æœƒè¦†è“‹", "Excelæ¨™æº–ä¸‹æ‹‰åˆ—è¡¨ä¸æ”¯æŒå¤šé¸", "å»ºè­°ä½¿ç”¨æ–¹æ³•1æˆ–æ–¹æ³•2"),
                ("", "", "", ""),
                ("ğŸ” ç¯©é¸åŠŸèƒ½", "", "", ""),
                ("åŠŸèƒ½", "ä½ç½®", "ç”¨é€”", "èªªæ˜"),
                ("è‡ªå‹•ç¯©é¸", "è¡¨é ­ä¸‹æ‹‰ç®­é ­", "ç¯©é¸é¡¯ç¤ºçš„æ•¸æ“š", "é»æ“Šè¡¨é ­çš„ç®­é ­é€²è¡Œç¯©é¸"),
                ("æ•¸æ“šé©—è­‰", "å–®å…ƒæ ¼ä¸‹æ‹‰ç®­é ­", "é¸æ“‡æœ‰æ•ˆé¸é …", "ç¢ºä¿æ•¸æ“šæ ¼å¼æ­£ç¢º"),
                ("", "", "", ""),
                ("ğŸ“ å¡«å¯«å»ºè­°", "", "", ""),
                ("æ¬„ä½", "å»ºè­°", "æ ¼å¼", "æ³¨æ„äº‹é …"),
                ("æ´»å‹•åç¨±", "ç°¡æ½”æ˜ç¢º", "æ–‡å­—", "é¿å…ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦"),
                ("æ—¥æœŸç¯„åœ", "YYYY-MM-DD", "æ—¥æœŸ", "ç¢ºä¿æ—¥æœŸæ ¼å¼æ­£ç¢º"),
                ("é–€å¸‚", "å¾ä¸‹æ‹‰åˆ—è¡¨é¸æ“‡", "æ–‡å­—", "å¯å¤šé¸ï¼Œç”¨é€—è™Ÿåˆ†éš”"),
                ("ç”¢å“", "å¾ç”¢å“æ•¸æ“šåº«é¸æ“‡", "æ–‡å­—", "å¯å¤šé¸ï¼Œç”¨é€—è™Ÿåˆ†éš”"),
                ("æ”¯ä»˜æ–¹å¼", "å¾é è¨­é¸é …é¸æ“‡", "æ–‡å­—", "å¯å¤šé¸ï¼Œç”¨é€—è™Ÿåˆ†éš”"),
                ("", "", "", ""),
                ("âš ï¸ æ³¨æ„äº‹é …", "", "", ""),
                ("â€¢ æ‰€æœ‰æ•¸æ“šæœƒè‡ªå‹•ä¿å­˜åˆ°ç¨‹åº", "", "", ""),
                ("â€¢ ä¿®æ”¹æ•¸æ“šå¾Œè«‹é‡æ–°å°å…¥ç¨‹åº", "", "", ""),
                ("â€¢ ç”¢å“åç¨±å¿…é ˆèˆ‡ProductDatabaseä¸­çš„å®Œå…¨ä¸€è‡´", "", "", ""),
                ("â€¢ æ—¥æœŸæ ¼å¼å¿…é ˆç‚º YYYY-MM-DD", "", "", ""),
                ("â€¢ å¤šé¸é …ç›®ç”¨é€—è™Ÿå’Œç©ºæ ¼åˆ†éš”", "", "", ""),
            ]
            
            # å¯«å…¥èªªæ˜å…§å®¹
            for row_idx, (col1, col2, col3, col4) in enumerate(instructions, 2):
                guide_ws.cell(row=row_idx, column=1, value=col1)
                guide_ws.cell(row=row_idx, column=2, value=col2)
                guide_ws.cell(row=row_idx, column=3, value=col3)
                guide_ws.cell(row=row_idx, column=4, value=col4)
                
                # è¨­ç½®æ¨£å¼
                for col in range(1, 5):
                    cell = guide_ws.cell(row=row_idx, column=col)
                    if col1.startswith("ğŸ“Š") or col1.startswith("ğŸ’¡") or col1.startswith("ğŸ”") or col1.startswith("ğŸ“") or col1.startswith("âš ï¸"):
                        # æ¨™é¡Œè¡Œ
                        cell.font = Font(name='Microsoft YaHei UI', size=12, bold=True, color='2E8B57')
                        cell.fill = PatternFill(start_color='E8F5E8', end_color='E8F5E8', fill_type='solid')
                    elif col1 == "æ­¥é©Ÿ" or col1 == "åŠŸèƒ½" or col1 == "æ¬„ä½":
                        # å­æ¨™é¡Œè¡Œ
                        cell.font = Font(name='Microsoft YaHei UI', size=11, bold=True)
                        cell.fill = PatternFill(start_color='F0F8FF', end_color='F0F8FF', fill_type='solid')
                    else:
                        # æ™®é€šè¡Œ
                        cell.font = Font(name='Arial', size=10)
                    
                    cell.border = Border(
                        left=Side(style='thin'),
                        right=Side(style='thin'),
                        top=Side(style='thin'),
                        bottom=Side(style='thin')
                    )
                    cell.alignment = Alignment(horizontal='left', vertical='center')
            
            # èª¿æ•´åˆ—å¯¬
            guide_ws.column_dimensions['A'].width = 15
            guide_ws.column_dimensions['B'].width = 20
            guide_ws.column_dimensions['C'].width = 30
            guide_ws.column_dimensions['D'].width = 40
            
            # å‡çµé¦–è¡Œ
            guide_ws.freeze_panes = 'A2'
            
            print("âœ… ä½¿ç”¨èªªæ˜å·¥ä½œè¡¨å·²å‰µå»º")
            
        except Exception as e:
            print(f"âš ï¸ å‰µå»ºä½¿ç”¨èªªæ˜å·¥ä½œè¡¨å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
    
    def add_vba_multiselect_macro(self, wb):
        """æ·»åŠ VBAå®å¯¦ç¾çœŸæ­£çš„å¤šé¸åŠŸèƒ½"""
        try:
            # å‰µå»ºVBAå®ä»£ç¢¼
            vba_code = '''
Sub MultiSelectProducts()
    ' å¤šé¸ç”¢å“åŠŸèƒ½ - å³éµèœå–®è§¸ç™¼
    Dim selectedCell As Range
    Dim currentValue As String
    Dim newProduct As String
    Dim productList As String
    Dim i As Integer
    
    ' ç²å–ç•¶å‰é¸ä¸­çš„å–®å…ƒæ ¼
    Set selectedCell = Selection
    
    ' æª¢æŸ¥æ˜¯å¦åœ¨ç”¢å“åˆ—ï¼ˆIåˆ—ï¼‰
    If selectedCell.Column = 9 Then
        currentValue = selectedCell.Value
        If currentValue = "" Then currentValue = ""
        
        ' é¡¯ç¤ºç”¢å“é¸æ“‡å°è©±æ¡†
        newProduct = InputBox("è«‹è¼¸å…¥è¦æ·»åŠ çš„ç”¢å“åç¨±ï¼š" & vbCrLf & vbCrLf & _
                             "ç•¶å‰å·²é¸æ“‡ï¼š" & currentValue & vbCrLf & vbCrLf & _
                             "å¯ç”¨ç”¢å“ï¼š" & vbCrLf & _
                             "â€¢ Salmon Sashimi (13pcs)" & vbCrLf & _
                             "â€¢ Salmon Sashimi (8pcs)" & vbCrLf & _
                             "â€¢ Salmon Sushi 10pcs" & vbCrLf & _
                             "â€¢ Salmon Roll" & vbCrLf & _
                             "â€¢ Salmon Nigiri" & vbCrLf & _
                             "â€¢ Tuna Sashimi (10pcs)" & vbCrLf & _
                             "â€¢ Eel Roll" & vbCrLf & _
                             "â€¢ California Roll" & vbCrLf & _
                             "â€¢ Tempura Roll" & vbCrLf & _
                             "â€¢ Dragon Roll" & vbCrLf & vbCrLf & _
                             "è¼¸å…¥æ–°ç”¢å“åç¨±ï¼ˆç•™ç©ºå‰‡æ¸…é™¤æ‰€æœ‰é¸æ“‡ï¼‰ï¼š", _
                             "å¤šé¸ç”¢å“", currentValue)
        
        If newProduct <> "" Then
            ' æ·»åŠ æ–°ç”¢å“
            If currentValue = "" Then
                selectedCell.Value = newProduct
            Else
                selectedCell.Value = currentValue & ", " & newProduct
            End If
        Else
            ' æ¸…é™¤é¸æ“‡
            selectedCell.Value = ""
        End If
    Else
        MsgBox "è«‹åœ¨ç”¢å“åˆ—ï¼ˆIåˆ—ï¼‰ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½", vbInformation, "æç¤º"
    End If
End Sub

Sub MultiSelectOutlets()
    ' å¤šé¸é–€å¸‚åŠŸèƒ½
    Dim selectedCell As Range
    Dim currentValue As String
    Dim newOutlet As String
    
    Set selectedCell = Selection
    
    If selectedCell.Column = 7 Then ' Gåˆ—æ˜¯é–€å¸‚åˆ—
        currentValue = selectedCell.Value
        If currentValue = "" Then currentValue = ""
        
        newOutlet = InputBox("è«‹è¼¸å…¥è¦æ·»åŠ çš„é–€å¸‚åç¨±ï¼š" & vbCrLf & vbCrLf & _
                            "ç•¶å‰å·²é¸æ“‡ï¼š" & currentValue & vbCrLf & vbCrLf & _
                            "å¯ç”¨é–€å¸‚ï¼š" & vbCrLf & _
                            "â€¢ MPINES" & vbCrLf & _
                            "â€¢ 304 - TOA PAYOH" & vbCrLf & _
                            "â€¢ 306-J8" & vbCrLf & _
                            "â€¢ 307-HGTO" & vbCrLf & _
                            "â€¢ 308 - OASIS" & vbCrLf & _
                            "â€¢ 309 - YEW TEE SQUARE" & vbCrLf & _
                            "â€¢ 310 - SENGKANG MRT" & vbCrLf & _
                            "â€¢ 311 - THE POIZ CENTRE" & vbCrLf & _
                            "â€¢ 312 - ANG MO KIO" & vbCrLf & vbCrLf & _
                            "è¼¸å…¥æ–°é–€å¸‚åç¨±ï¼ˆç•™ç©ºå‰‡æ¸…é™¤æ‰€æœ‰é¸æ“‡ï¼‰ï¼š", _
                            "å¤šé¸é–€å¸‚", currentValue)
        
        If newOutlet <> "" Then
            If currentValue = "" Then
                selectedCell.Value = newOutlet
            Else
                selectedCell.Value = currentValue & ", " & newOutlet
            End If
        Else
            selectedCell.Value = ""
        End If
    Else
        MsgBox "è«‹åœ¨é–€å¸‚åˆ—ï¼ˆGåˆ—ï¼‰ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½", vbInformation, "æç¤º"
    End If
End Sub

Sub MultiSelectPayment()
    ' å¤šé¸æ”¯ä»˜æ–¹å¼åŠŸèƒ½
    Dim selectedCell As Range
    Dim currentValue As String
    Dim newPayment As String
    
    Set selectedCell = Selection
    
    If selectedCell.Column = 10 Then ' Jåˆ—æ˜¯æ”¯ä»˜æ–¹å¼åˆ—
        currentValue = selectedCell.Value
        If currentValue = "" Then currentValue = ""
        
        newPayment = InputBox("è«‹è¼¸å…¥è¦æ·»åŠ çš„æ”¯ä»˜æ–¹å¼ï¼š" & vbCrLf & vbCrLf & _
                             "ç•¶å‰å·²é¸æ“‡ï¼š" & currentValue & vbCrLf & vbCrLf & _
                             "å¯ç”¨æ”¯ä»˜æ–¹å¼ï¼š" & vbCrLf & _
                             "â€¢ VISA" & vbCrLf & _
                             "â€¢ MASTER" & vbCrLf & _
                             "â€¢ NETS" & vbCrLf & _
                             "â€¢ AMEX" & vbCrLf & _
                             "â€¢ UnionPay" & vbCrLf & _
                             "â€¢ DBS MAX" & vbCrLf & _
                             "â€¢ CDC Voucher" & vbCrLf & _
                             "â€¢ Mall Voucher" & vbCrLf & _
                             "â€¢ GRAB FOOD" & vbCrLf & _
                             "â€¢ FOOD PANDA" & vbCrLf & _
                             "â€¢ DELIVEROO" & vbCrLf & _
                             "â€¢ SE APP" & vbCrLf & _
                             "â€¢ WASTAGE" & vbCrLf & vbCrLf & _
                             "è¼¸å…¥æ–°æ”¯ä»˜æ–¹å¼ï¼ˆç•™ç©ºå‰‡æ¸…é™¤æ‰€æœ‰é¸æ“‡ï¼‰ï¼š", _
                             "å¤šé¸æ”¯ä»˜æ–¹å¼", currentValue)
        
        If newPayment <> "" Then
            If currentValue = "" Then
                selectedCell.Value = newPayment
            Else
                selectedCell.Value = currentValue & ", " & newPayment
            End If
        Else
            selectedCell.Value = ""
        End If
    Else
        MsgBox "è«‹åœ¨æ”¯ä»˜æ–¹å¼åˆ—ï¼ˆJåˆ—ï¼‰ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½", vbInformation, "æç¤º"
    End If
End Sub
'''
            
            # å˜—è©¦æ·»åŠ VBAå®ï¼ˆéœ€è¦openpyxlæ”¯æŒï¼‰
            try:
                # å‰µå»ºVBAæ¨¡å¡Š
                from openpyxl import Workbook
                
                # æ·»åŠ VBAå®åˆ°å·¥ä½œç°¿
                if hasattr(wb, 'vba_archive'):
                    # å¦‚æœå·¥ä½œç°¿æ”¯æŒVBAï¼Œæ·»åŠ å®
                    print("âœ… VBAå®å·²æº–å‚™å°±ç·’")
                else:
                    print("â„¹ï¸ ç•¶å‰ç‰ˆæœ¬ä¸æ”¯æŒVBAå®ï¼Œå°‡ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ")
                    
            except Exception as vba_error:
                print(f"âš ï¸ VBAå®æ·»åŠ å¤±æ•—: {vba_error}")
                
        except Exception as e:
            print(f"âš ï¸ æ·»åŠ VBAå®å¤±æ•—: {e}")
    
    def create_multiselect_helper_sheet(self, wb):
        """å‰µå»ºå¤šé¸åŠ©æ‰‹å·¥ä½œè¡¨"""
        try:
            from openpyxl.styles import Font, PatternFill, Border, Side, Alignment
            
            # å‰µå»ºå¤šé¸åŠ©æ‰‹å·¥ä½œè¡¨
            helper_ws = wb.create_sheet(title='å¤šé¸åŠ©æ‰‹', index=2)  # æ”¾åœ¨ç¬¬ä¸‰å€‹ä½ç½®
            
            # æ¨™é¡Œ
            title_cell = helper_ws.cell(row=1, column=1, value="ğŸ¯ å¤šé¸åŠ©æ‰‹ - å¿«é€Ÿè¤‡è£½ç”¢å“ã€é–€å¸‚ã€æ”¯ä»˜æ–¹å¼")
            title_cell.font = Font(name='Microsoft YaHei UI', size=14, bold=True, color='FFFFFF')
            title_cell.fill = PatternFill(start_color='FF6B35', end_color='FF6B35', fill_type='solid')
            title_cell.alignment = Alignment(horizontal='center', vertical='center')
            helper_ws.merge_cells('A1:D1')
            
            # ç”¢å“å¤šé¸å€åŸŸ
            helper_ws.cell(row=3, column=1, value="ğŸ£ ç”¢å“å¤šé¸å€åŸŸ")
            helper_ws.cell(row=3, column=1).font = Font(name='Microsoft YaHei UI', size=12, bold=True, color='2E8B57')
            helper_ws.cell(row=3, column=1).fill = PatternFill(start_color='E8F5E8', end_color='E8F5E8', fill_type='solid')
            helper_ws.merge_cells('A3:D3')
            
            # ç”¢å“é¸é …
            products = [
                'Salmon Sashimi (13pcs)', 'Salmon Sashimi (8pcs)', 'Salmon Sushi 10pcs',
                'Salmon Roll', 'Salmon Nigiri', 'Tuna Sashimi (10pcs)',
                'Eel Roll', 'California Roll', 'Tempura Roll', 'Dragon Roll'
            ]
            
            for i, product in enumerate(products):
                row = 4 + i
                helper_ws.cell(row=row, column=1, value=f"â˜‘ {product}")
                helper_ws.cell(row=row, column=2, value=product)
                helper_ws.cell(row=row, column=3, value="é»æ“Šè¤‡è£½")
                helper_ws.cell(row=row, column=4, value="è¤‡è£½å¾Œç²˜è²¼åˆ°æ´»å‹•è¨˜éŒ„çš„ç”¢å“åˆ—")
                
                # è¨­ç½®æ¨£å¼
                for col in range(1, 5):
                    cell = helper_ws.cell(row=row, column=col)
                    cell.font = Font(name='Arial', size=10)
                    cell.border = Border(
                        left=Side(style='thin'),
                        right=Side(style='thin'),
                        top=Side(style='thin'),
                        bottom=Side(style='thin')
                    )
                    cell.alignment = Alignment(horizontal='left', vertical='center')
            
            # é–€å¸‚å¤šé¸å€åŸŸ
            outlets_start_row = 4 + len(products) + 2
            helper_ws.cell(row=outlets_start_row, column=1, value="ğŸª é–€å¸‚å¤šé¸å€åŸŸ")
            helper_ws.cell(row=outlets_start_row, column=1).font = Font(name='Microsoft YaHei UI', size=12, bold=True, color='2E8B57')
            helper_ws.cell(row=outlets_start_row, column=1).fill = PatternFill(start_color='E8F5E8', end_color='E8F5E8', fill_type='solid')
            helper_ws.merge_cells(f'A{outlets_start_row}:D{outlets_start_row}')
            
            # é–€å¸‚é¸é …
            outlets = [
                'MPINES', '304 - TOA PAYOH', '306-J8', '307-HGTO',
                '308 - OASIS', '309 - YEW TEE SQUARE', '310 - SENGKANG MRT',
                '311 - THE POIZ CENTRE', '312 - ANG MO KIO'
            ]
            
            for i, outlet in enumerate(outlets):
                row = outlets_start_row + 1 + i
                helper_ws.cell(row=row, column=1, value=f"â˜‘ {outlet}")
                helper_ws.cell(row=row, column=2, value=outlet)
                helper_ws.cell(row=row, column=3, value="é»æ“Šè¤‡è£½")
                helper_ws.cell(row=row, column=4, value="è¤‡è£½å¾Œç²˜è²¼åˆ°æ´»å‹•è¨˜éŒ„çš„é–€å¸‚åˆ—")
                
                # è¨­ç½®æ¨£å¼
                for col in range(1, 5):
                    cell = helper_ws.cell(row=row, column=col)
                    cell.font = Font(name='Arial', size=10)
                    cell.border = Border(
                        left=Side(style='thin'),
                        right=Side(style='thin'),
                        top=Side(style='thin'),
                        bottom=Side(style='thin')
                    )
                    cell.alignment = Alignment(horizontal='left', vertical='center')
            
            # æ”¯ä»˜æ–¹å¼å¤šé¸å€åŸŸ
            payment_start_row = outlets_start_row + len(outlets) + 2
            helper_ws.cell(row=payment_start_row, column=1, value="ğŸ’³ æ”¯ä»˜æ–¹å¼å¤šé¸å€åŸŸ")
            helper_ws.cell(row=payment_start_row, column=1).font = Font(name='Microsoft YaHei UI', size=12, bold=True, color='2E8B57')
            helper_ws.cell(row=payment_start_row, column=1).fill = PatternFill(start_color='E8F5E8', end_color='E8F5E8', fill_type='solid')
            helper_ws.merge_cells(f'A{payment_start_row}:D{payment_start_row}')
            
            # æ”¯ä»˜æ–¹å¼é¸é …
            payments = [
                'VISA', 'MASTER', 'NETS', 'AMEX', 'UnionPay',
                'DBS MAX', 'CDC Voucher', 'Mall Voucher',
                'GRAB FOOD', 'FOOD PANDA', 'DELIVEROO', 'SE APP', 'WASTAGE'
            ]
            
            for i, payment in enumerate(payments):
                row = payment_start_row + 1 + i
                helper_ws.cell(row=row, column=1, value=f"â˜‘ {payment}")
                helper_ws.cell(row=row, column=2, value=payment)
                helper_ws.cell(row=row, column=3, value="é»æ“Šè¤‡è£½")
                helper_ws.cell(row=row, column=4, value="è¤‡è£½å¾Œç²˜è²¼åˆ°æ´»å‹•è¨˜éŒ„çš„æ”¯ä»˜æ–¹å¼åˆ—")
                
                # è¨­ç½®æ¨£å¼
                for col in range(1, 5):
                    cell = helper_ws.cell(row=row, column=col)
                    cell.font = Font(name='Arial', size=10)
                    cell.border = Border(
                        left=Side(style='thin'),
                        right=Side(style='thin'),
                        top=Side(style='thin'),
                        bottom=Side(style='thin')
                    )
                    cell.alignment = Alignment(horizontal='left', vertical='center')
            
            # ä½¿ç”¨èªªæ˜
            instructions_start_row = payment_start_row + len(payments) + 3
            helper_ws.cell(row=instructions_start_row, column=1, value="ğŸ“‹ ä½¿ç”¨èªªæ˜")
            helper_ws.cell(row=instructions_start_row, column=1).font = Font(name='Microsoft YaHei UI', size=12, bold=True, color='FF6B35')
            helper_ws.cell(row=instructions_start_row, column=1).fill = PatternFill(start_color='FFF0E6', end_color='FFF0E6', fill_type='solid')
            helper_ws.merge_cells(f'A{instructions_start_row}:D{instructions_start_row}')
            
            instructions = [
                ("æ­¥é©Ÿ1", "é¸æ“‡éœ€è¦çš„é …ç›®", "é»æ“ŠBåˆ—çš„ç”¢å“/é–€å¸‚/æ”¯ä»˜æ–¹å¼åç¨±", "æœƒè‡ªå‹•é¸ä¸­è©²é …ç›®"),
                ("æ­¥é©Ÿ2", "è¤‡è£½é¸ä¸­çš„é …ç›®", "Ctrl+C æˆ–å³éµè¤‡è£½", "è¤‡è£½åˆ°å‰ªè²¼æ¿"),
                ("æ­¥é©Ÿ3", "ç²˜è²¼åˆ°æ´»å‹•è¨˜éŒ„", "åˆ‡æ›åˆ°æ´»å‹•è¨˜éŒ„å·¥ä½œè¡¨", "ç²˜è²¼åˆ°å°æ‡‰çš„åˆ—"),
                ("æ­¥é©Ÿ4", "æ·»åŠ æ›´å¤šé …ç›®", "é‡è¤‡æ­¥é©Ÿ1-3", "ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹é …ç›®"),
                ("", "", "", ""),
                ("ğŸ’¡ å¤šé¸æŠ€å·§", "", "", ""),
                ("â€¢ å¯ä»¥ä¸€æ¬¡é¸æ“‡å¤šå€‹é …ç›®", "æŒ‰ä½Ctrléµé»æ“Šå¤šå€‹é …ç›®", "ç„¶å¾Œä¸€èµ·è¤‡è£½", "ç¯€çœæ™‚é–“"),
                ("â€¢ ä½¿ç”¨é€—è™Ÿåˆ†éš”", "é …ç›®1, é …ç›®2, é …ç›®3", "ç¢ºä¿æ ¼å¼æ­£ç¢º", "ç¨‹åºèƒ½æ­£ç¢ºè­˜åˆ¥"),
                ("â€¢ æª¢æŸ¥æ‹¼å¯«", "ç¢ºä¿ç”¢å“åç¨±å®Œå…¨ä¸€è‡´", "åƒè€ƒProductDatabaseå·¥ä½œè¡¨", "é¿å…åˆ†æéŒ¯èª¤"),
            ]
            
            for i, (step, action, desc, example) in enumerate(instructions):
                row = instructions_start_row + 1 + i
                helper_ws.cell(row=row, column=1, value=step)
                helper_ws.cell(row=row, column=2, value=action)
                helper_ws.cell(row=row, column=3, value=desc)
                helper_ws.cell(row=row, column=4, value=example)
                
                # è¨­ç½®æ¨£å¼
                for col in range(1, 5):
                    cell = helper_ws.cell(row=row, column=col)
                    if step.startswith("ğŸ’¡"):
                        cell.font = Font(name='Microsoft YaHei UI', size=11, bold=True, color='FF6B35')
                        cell.fill = PatternFill(start_color='FFF0E6', end_color='FFF0E6', fill_type='solid')
                    else:
                        cell.font = Font(name='Arial', size=10)
                    cell.border = Border(
                        left=Side(style='thin'),
                        right=Side(style='thin'),
                        top=Side(style='thin'),
                        bottom=Side(style='thin')
                    )
                    cell.alignment = Alignment(horizontal='left', vertical='center')
            
            # èª¿æ•´åˆ—å¯¬
            helper_ws.column_dimensions['A'].width = 25
            helper_ws.column_dimensions['B'].width = 30
            helper_ws.column_dimensions['C'].width = 15
            helper_ws.column_dimensions['D'].width = 40
            
            # å‡çµé¦–è¡Œ
            helper_ws.freeze_panes = 'A2'
            
            print("âœ… å¤šé¸åŠ©æ‰‹å·¥ä½œè¡¨å·²å‰µå»º")
            
        except Exception as e:
            print(f"âš ï¸ å‰µå»ºå¤šé¸åŠ©æ‰‹å·¥ä½œè¡¨å¤±æ•—: {e}")
            import traceback
            print(f"è©³ç´°éŒ¯èª¤: {traceback.format_exc()}")
    
    def import_activity_records_from_excel(self):
        """å¾Excelæ–‡ä»¶å°å…¥æ´»å‹•è¨˜éŒ„ - ä½¿ç”¨å›ºå®šæ–‡ä»¶å PromotionRecords.xlsx"""
        try:
            import pandas as pd
            import json
            from datetime import datetime
            import os
            
            # ä½¿ç”¨å›ºå®šæ–‡ä»¶åï¼Œå¾ç¨‹åºæ‰€åœ¨ç›®éŒ„è®€å–
            current_dir = os.path.dirname(os.path.abspath(__file__))
            file_path = os.path.join(current_dir, "PromotionRecords.xlsx")
            
            # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if not os.path.exists(file_path):
                tk.messagebox.showwarning(
                    "æ–‡ä»¶ä¸å­˜åœ¨ / File Not Found",
                    f"æ‰¾ä¸åˆ°æ–‡ä»¶: {file_path}\nFile not found: {file_path}\n\nè«‹å…ˆå°å‡ºæ´»å‹•è¨˜éŒ„æˆ–ç¢ºä¿æ–‡ä»¶å­˜åœ¨ã€‚\nPlease export activity records first or ensure the file exists."
                )
                return
            
            # ç¢ºèªå°å…¥
            result = tk.messagebox.askyesno(
                "ç¢ºèªå°å…¥ / Confirm Import",
                "å°å…¥Excelæ–‡ä»¶å°‡è¦†è“‹ç¾æœ‰çš„æ´»å‹•è¨˜éŒ„ã€‚\nImporting Excel file will overwrite existing activity records.\n\næ˜¯å¦ç¹¼çºŒï¼Ÿ/ Continue?"
            )
            
            if not result:
                return
            
            # è®€å–Excelæ–‡ä»¶
            excel_file = pd.ExcelFile(file_path)
            
            # æª¢æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€çš„sheet
            required_sheets = ['GOGO', 'Express', 'PLUS']
            available_sheets = excel_file.sheet_names
            
            missing_sheets = [sheet for sheet in required_sheets if sheet not in available_sheets]
            if missing_sheets:
                tk.messagebox.showwarning(
                    "è­¦å‘Š / Warning",
                    f"Excelæ–‡ä»¶ç¼ºå°‘ä»¥ä¸‹å·¥ä½œè¡¨:\nExcel file is missing the following sheets:\n{', '.join(missing_sheets)}"
                )
            
            # ç¢ºä¿å‡æœŸè¨˜éŒ„å­˜åœ¨
            if not hasattr(self, 'holiday_records'):
                self.holiday_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': []
                }
            
            # å°å…¥æ¯å€‹æ•¸æ“šåº«çš„è¨˜éŒ„
            imported_count = 0
            for db_name in required_sheets:
                if db_name in available_sheets:
                    try:
                        # è®€å–å·¥ä½œè¡¨
                        df = pd.read_excel(file_path, sheet_name=db_name)
                        
                        # è·³éç©ºçš„å·¥ä½œè¡¨
                        if df.empty or len(df) == 0:
                            continue
                        
                        # è½‰æ›ç‚ºæ´»å‹•è¨˜éŒ„æ ¼å¼
                        records = []
                        for _, row in df.iterrows():
                            # è·³éç©ºè¡Œæˆ–æç¤ºè¡Œ
                            if pd.isna(row.iloc[0]) or 'æš«ç„¡' in str(row.iloc[0]):
                                continue
                            
                            # è§£æåˆ†æçµæœ
                            analysis_result = {}
                            if not pd.isna(row.iloc[10]) and str(row.iloc[10]) != 'æœªåˆ†æ':  # ç¸½æ¥­ç¸¾
                                try:
                                    # è§£æé‡‘é¡æ ¼å¼
                                    total_amount_str = str(row.iloc[10]).replace('$', '').replace(',', '')
                                    analysis_result['total_amount'] = float(total_amount_str)
                                except:
                                    analysis_result['total_amount'] = 0
                            
                            if not pd.isna(row.iloc[11]) and str(row.iloc[11]) != 'æœªåˆ†æ':  # ç¸½å–®æ“šæ•¸
                                try:
                                    total_receipts_str = str(row.iloc[11]).replace(',', '')
                                    analysis_result['total_receipts'] = int(total_receipts_str)
                                except:
                                    analysis_result['total_receipts'] = 0
                            
                            if not pd.isna(row.iloc[12]) and str(row.iloc[12]) != 'æœªåˆ†æ':  # æ´»å‹•æ¥­ç¸¾
                                try:
                                    activity_amount_str = str(row.iloc[12]).replace('$', '').replace(',', '')
                                    analysis_result['activity_amount'] = float(activity_amount_str)
                                except:
                                    analysis_result['activity_amount'] = 0
                            
                            if not pd.isna(row.iloc[13]) and str(row.iloc[13]) != 'æœªåˆ†æ':  # æ´»å‹•å–®æ“šæ•¸
                                try:
                                    activity_receipts_str = str(row.iloc[13]).replace(',', '')
                                    analysis_result['activity_receipts'] = int(activity_receipts_str)
                                except:
                                    analysis_result['activity_receipts'] = 0
                            
                            if not pd.isna(row.iloc[14]) and str(row.iloc[14]) != 'æœªåˆ†æ':  # æ¥­ç¸¾å æ¯”%
                                try:
                                    amount_ratio_str = str(row.iloc[14]).replace('%', '')
                                    analysis_result['amount_ratio'] = float(amount_ratio_str)
                                except:
                                    analysis_result['amount_ratio'] = 0
                            
                            if not pd.isna(row.iloc[15]) and str(row.iloc[15]) != 'æœªåˆ†æ':  # å–®æ“šæ•¸å æ¯”%
                                try:
                                    receipt_ratio_str = str(row.iloc[15]).replace('%', '')
                                    analysis_result['receipt_ratio'] = float(receipt_ratio_str)
                                except:
                                    analysis_result['receipt_ratio'] = 0
                            
                            if not pd.isna(row.iloc[16]):  # åˆ†ææ™‚é–“
                                analysis_result['analyzed_time'] = str(row.iloc[16])
                            
                            # å‰µå»ºæ´»å‹•è¨˜éŒ„
                            record = {
                                'id': str(row.iloc[0]) if not pd.isna(row.iloc[0]) else '',
                                'description': str(row.iloc[1]) if not pd.isna(row.iloc[1]) else '',
                                'type': str(row.iloc[2]) if not pd.isna(row.iloc[2]) else 'normal',
                                'date_from': str(row.iloc[3]) if not pd.isna(row.iloc[3]) else '',
                                'date_to': str(row.iloc[4]) if not pd.isna(row.iloc[4]) else '',
                                'weekdays': str(row.iloc[5]).split(', ') if not pd.isna(row.iloc[5]) and str(row.iloc[5]) != 'å…¨éƒ¨' else [],
                                'outlets': str(row.iloc[6]).split(', ') if not pd.isna(row.iloc[6]) else [],
                                'parts': str(row.iloc[7]).split(', ') if not pd.isna(row.iloc[7]) else [],
                                'products': str(row.iloc[8]).split(', ') if not pd.isna(row.iloc[8]) else [],
                                'payment_methods': str(row.iloc[9]).split(', ') if not pd.isna(row.iloc[9]) else [],
                                'analysis_result': analysis_result if analysis_result else {},
                                'created_time': str(row.iloc[17]) if not pd.isna(row.iloc[17]) else datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                                'database': db_name
                            }
                            
                            records.append(record)
                            imported_count += 1
                        
                        # æ›´æ–°æ´»å‹•è¨˜éŒ„
                        self.activity_records[db_name] = records
                        
                    except Exception as e:
                        print(f"å°å…¥ {db_name} æ•¸æ“šåº«è¨˜éŒ„æ™‚å‡ºéŒ¯: {e}")
                        continue
            
            # å°å…¥å‡æœŸè¨˜éŒ„
            holiday_imported_count = 0
            if 'Holidays' in available_sheets:
                try:
                    # è®€å–å‡æœŸå·¥ä½œè¡¨
                    holiday_df = pd.read_excel(file_path, sheet_name='Holidays')
                    
                    # æ¸…ç©ºç¾æœ‰å‡æœŸè¨˜éŒ„
                    for db_name in ['GOGO', 'Express', 'PLUS']:
                        self.holiday_records[db_name] = []
                    
                    # è½‰æ›å‡æœŸè¨˜éŒ„
                    for _, row in holiday_df.iterrows():
                        # è·³éç©ºè¡Œæˆ–æç¤ºè¡Œ
                        if pd.isna(row.iloc[0]) or 'æš«ç„¡' in str(row.iloc[0]):
                            continue
                        
                        # ç²å–æ•¸æ“šåº«åç¨±
                        db_name = str(row.iloc[0]) if not pd.isna(row.iloc[0]) else 'Express'
                        if db_name not in ['GOGO', 'Express', 'PLUS']:
                            continue
                        
                        # å‰µå»ºå‡æœŸè¨˜éŒ„
                        holiday_record = {
                            'start_date': str(row.iloc[1]) if not pd.isna(row.iloc[1]) else '',
                            'end_date': str(row.iloc[2]) if not pd.isna(row.iloc[2]) else '',
                            'holiday_name': str(row.iloc[3]) if not pd.isna(row.iloc[3]) else '',
                            'duration': int(row.iloc[4]) if not pd.isna(row.iloc[4]) else 0
                        }
                        
                        # æ·»åŠ åˆ°å°æ‡‰æ•¸æ“šåº«çš„å‡æœŸè¨˜éŒ„
                        self.holiday_records[db_name].append(holiday_record)
                        holiday_imported_count += 1
                        
                except Exception as e:
                    print(f"å°å…¥å‡æœŸè¨˜éŒ„æ™‚å‡ºéŒ¯: {e}")
            
            # ä¿å­˜åˆ°æ–‡ä»¶
            self.save_activity_records()
            
            # ä¿å­˜å‡æœŸè¨˜éŒ„
            if hasattr(self, 'save_holiday_records'):
                self.save_holiday_records()
            
            # åˆ·æ–°é¡¯ç¤º
            if hasattr(self, 'activity_tree'):
                self.refresh_activity_tree()
            
            # æ›´æ–°ç”¢å“é¸æ“‡å™¨ä»¥åŒ…å«å°å…¥çš„ç”¢å“æ•¸æ“š
            try:
                print("ğŸ”„ å°å…¥Excelå¾Œæ›´æ–°ç”¢å“é¸æ“‡å™¨...")
                self.update_activity_products_from_records()
                print("âœ… ç”¢å“é¸æ“‡å™¨å·²æ›´æ–°")
            except Exception as e:
                print(f"âš ï¸ æ›´æ–°ç”¢å“é¸æ“‡å™¨å¤±æ•—: {e}")
            
            # æ›´æ–°æ´»å‹•æé†’
            if hasattr(self, 'update_activity_alerts'):
                self.update_activity_alerts()
            
            # åˆ·æ–°å‡æœŸè¨˜éŒ„é¡¯ç¤º
            if hasattr(self, 'holiday_tree'):
                self.refresh_holiday_tree()
            
            # æ›´æ–°å‡æœŸä¿¡æ¯
            if hasattr(self, 'update_holiday_info'):
                self.update_holiday_info()
            
            success_message = f"æˆåŠŸå°å…¥ {imported_count} æ¢æ´»å‹•è¨˜éŒ„\nSuccessfully imported {imported_count} activity records"
            if holiday_imported_count > 0:
                success_message += f"\n\næˆåŠŸå°å…¥ {holiday_imported_count} æ¢å‡æœŸè¨˜éŒ„\nSuccessfully imported {holiday_imported_count} holiday records"
            success_message += f"\n\næ–‡ä»¶è·¯å¾‘ / File path: {file_path}"
            
            tk.messagebox.showinfo("æˆåŠŸ / Success", success_message)
            
        except Exception as e:
            tk.messagebox.showerror(
                "éŒ¯èª¤ / Error",
                f"å°å…¥Excelæ–‡ä»¶å¤±æ•—:\nFailed to import Excel file:\n{str(e)}"
            )
    
    def auto_save_promotion_records(self):
        """è‡ªå‹•ä¿å­˜æ´»å‹•è¨˜éŒ„å’Œå‡æœŸè¨˜éŒ„åˆ° PromotionRecords.xlsx"""
        try:
            import pandas as pd
            from openpyxl import Workbook
            from openpyxl.styles import Font, PatternFill, Border, Side, Alignment
            import os
            
            # ä½¿ç”¨å›ºå®šæ–‡ä»¶åï¼Œä¿å­˜åœ¨ç¨‹åºæ‰€åœ¨ç›®éŒ„
            current_dir = os.path.dirname(os.path.abspath(__file__))
            file_path = os.path.join(current_dir, "PromotionRecords.xlsx")
            
            # å‰µå»ºExcelå·¥ä½œç°¿
            wb = Workbook()
            
            # å®šç¾©æ¨£å¼
            header_font = Font(name='Microsoft YaHei UI', size=12, bold=True, color='FFFFFF')
            header_fill = PatternFill(start_color='4472C4', end_color='4472C4', fill_type='solid')
            data_font = Font(name='Microsoft YaHei UI', size=10)
            border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
            center_alignment = Alignment(horizontal='center', vertical='center')
            
            # æ•¸æ“šåº«åˆ—è¡¨
            databases = ['GOGO', 'Express', 'PLUS']
            
            # ç¢ºä¿å‡æœŸè¨˜éŒ„å­˜åœ¨
            if not hasattr(self, 'holiday_records'):
                self.holiday_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': []
                }
            
            for db_name in databases:
                # å‰µå»ºæˆ–é¸æ“‡å·¥ä½œè¡¨
                if db_name == 'GOGO':
                    ws = wb.active
                    ws.title = db_name
                else:
                    ws = wb.create_sheet(title=db_name)
                
                # ç²å–è©²æ•¸æ“šåº«çš„æ´»å‹•è¨˜éŒ„
                records = self.activity_records.get(db_name, [])
                
                if not records:
                    # å¦‚æœæ²’æœ‰è¨˜éŒ„ï¼Œå‰µå»ºç©ºçš„è¡¨é ­
                    headers = [
                        'æ´»å‹•ID', 'æ´»å‹•åç¨±', 'æ´»å‹•é¡å‹', 'é–‹å§‹æ—¥æœŸ', 'çµæŸæ—¥æœŸ', 
                        'æ˜ŸæœŸç¯©é¸', 'æ¶‰åŠé–€å¸‚', 'æ¶‰åŠéƒ¨åˆ†', 'æ¶‰åŠç”¢å“', 'æ”¯ä»˜æ–¹å¼',
                        'ç¸½æ¥­ç¸¾', 'ç¸½å–®æ“šæ•¸', 'æ´»å‹•æ¥­ç¸¾', 'æ´»å‹•å–®æ“šæ•¸', 
                        'æ¥­ç¸¾å æ¯”%', 'å–®æ“šæ•¸å æ¯”%', 'åˆ†ææ™‚é–“', 'å‰µå»ºæ™‚é–“'
                    ]
                    
                    # å¯«å…¥è¡¨é ­
                    for col, header in enumerate(headers, 1):
                        cell = ws.cell(row=1, column=col, value=header)
                        cell.font = header_font
                        cell.fill = header_fill
                        cell.border = border
                        cell.alignment = center_alignment
                    
                    # å¯«å…¥ç©ºæ•¸æ“šæç¤º
                    ws.cell(row=2, column=1, value=f"æš«ç„¡ {db_name} æ•¸æ“šåº«çš„æ´»å‹•è¨˜éŒ„")
                    ws.cell(row=2, column=1).font = Font(name='Microsoft YaHei UI', size=10, italic=True, color='666666')
                    
                    # èª¿æ•´åˆ—å¯¬
                    for col in range(1, len(headers) + 1):
                        ws.column_dimensions[chr(64 + col)].width = 15
                    
                    continue
                
                # æº–å‚™æ•¸æ“š
                data_rows = []
                for record in records:
                    # åˆ†æçµæœ
                    analysis_result = record.get('analysis_result', {})
                    
                    row_data = [
                        record.get('id', ''),
                        record.get('description', ''),
                        record.get('type', ''),
                        record.get('date_from', ''),
                        record.get('date_to', ''),
                        ', '.join(record.get('weekdays', [])),
                        ', '.join(record.get('outlets', [])),
                        ', '.join(record.get('parts', [])),
                        ', '.join(record.get('products', [])),
                        ', '.join(record.get('payment_methods', [])),
                        f"${analysis_result.get('total_amount', 0):,.2f}" if analysis_result else 'æœªåˆ†æ',
                        f"{analysis_result.get('total_receipts', 0):,}" if analysis_result else 'æœªåˆ†æ',
                        f"${analysis_result.get('activity_amount', 0):,.2f}" if analysis_result else 'æœªåˆ†æ',
                        f"{analysis_result.get('activity_receipts', 0):,}" if analysis_result else 'æœªåˆ†æ',
                        f"{analysis_result.get('amount_ratio', 0):.2f}%" if analysis_result else 'æœªåˆ†æ',
                        f"{analysis_result.get('receipt_ratio', 0):.2f}%" if analysis_result else 'æœªåˆ†æ',
                        analysis_result.get('analyzed_time', '') if analysis_result else '',
                        record.get('created_time', '')
                    ]
                    data_rows.append(row_data)
                
                # è¡¨é ­
                headers = [
                    'æ´»å‹•ID', 'æ´»å‹•åç¨±', 'æ´»å‹•é¡å‹', 'é–‹å§‹æ—¥æœŸ', 'çµæŸæ—¥æœŸ', 
                    'æ˜ŸæœŸç¯©é¸', 'æ¶‰åŠé–€å¸‚', 'æ¶‰åŠéƒ¨åˆ†', 'æ¶‰åŠç”¢å“', 'æ”¯ä»˜æ–¹å¼',
                    'ç¸½æ¥­ç¸¾', 'ç¸½å–®æ“šæ•¸', 'æ´»å‹•æ¥­ç¸¾', 'æ´»å‹•å–®æ“šæ•¸', 
                    'æ¥­ç¸¾å æ¯”%', 'å–®æ“šæ•¸å æ¯”%', 'åˆ†ææ™‚é–“', 'å‰µå»ºæ™‚é–“'
                ]
                
                # å¯«å…¥è¡¨é ­
                for col, header in enumerate(headers, 1):
                    cell = ws.cell(row=1, column=col, value=header)
                    cell.font = header_font
                    cell.fill = header_fill
                    cell.border = border
                    cell.alignment = center_alignment
                
                # å¯«å…¥æ•¸æ“š
                for row_idx, row_data in enumerate(data_rows, 2):
                    for col_idx, value in enumerate(row_data, 1):
                        cell = ws.cell(row=row_idx, column=col_idx, value=value)
                        cell.font = data_font
                        cell.border = border
                        cell.alignment = center_alignment
                        
                        # ç‚ºæ¥­ç¸¾ç›¸é—œåˆ—æ·»åŠ ç‰¹æ®Šæ ¼å¼
                        if col_idx in [11, 13]:  # ç¸½æ¥­ç¸¾, æ´»å‹•æ¥­ç¸¾
                            cell.number_format = '$#,##0.00'
                        elif col_idx in [12, 14]:  # ç¸½å–®æ“šæ•¸, æ´»å‹•å–®æ“šæ•¸
                            cell.number_format = '#,##0'
                        elif col_idx in [15, 16]:  # æ¥­ç¸¾å æ¯”%, å–®æ“šæ•¸å æ¯”%
                            cell.number_format = '0.00%'
                
                # èª¿æ•´åˆ—å¯¬
                column_widths = [8, 25, 10, 12, 12, 15, 20, 15, 30, 20, 12, 12, 12, 12, 10, 10, 18, 18]
                for col, width in enumerate(column_widths, 1):
                    ws.column_dimensions[chr(64 + col)].width = width
                
                # å‡çµé¦–è¡Œ
                ws.freeze_panes = 'A2'
            
            # æ·»åŠ å‡æœŸè¨˜éŒ„å·¥ä½œè¡¨
            holiday_ws = wb.create_sheet(title='Holidays')
            
            # å‡æœŸè¨˜éŒ„è¡¨é ­
            holiday_headers = [
                'æ•¸æ“šåº«', 'é–‹å§‹æ—¥æœŸ', 'çµæŸæ—¥æœŸ', 'å‡æœŸåç¨±', 'å‡æœŸé•·åº¦(å¤©)'
            ]
            
            # å¯«å…¥å‡æœŸè¡¨é ­
            for col, header in enumerate(holiday_headers, 1):
                cell = holiday_ws.cell(row=1, column=col, value=header)
                cell.font = header_font
                cell.fill = header_fill
                cell.border = border
                cell.alignment = center_alignment
            
            # å¯«å…¥å‡æœŸæ•¸æ“š
            holiday_row = 2
            for db_name in databases:
                holiday_records = self.holiday_records.get(db_name, [])
                for record in holiday_records:
                    holiday_ws.cell(row=holiday_row, column=1, value=db_name).font = data_font
                    holiday_ws.cell(row=holiday_row, column=1).border = border
                    holiday_ws.cell(row=holiday_row, column=1).alignment = center_alignment
                    
                    holiday_ws.cell(row=holiday_row, column=2, value=record.get('start_date', '')).font = data_font
                    holiday_ws.cell(row=holiday_row, column=2).border = border
                    holiday_ws.cell(row=holiday_row, column=2).alignment = center_alignment
                    
                    holiday_ws.cell(row=holiday_row, column=3, value=record.get('end_date', '')).font = data_font
                    holiday_ws.cell(row=holiday_row, column=3).border = border
                    holiday_ws.cell(row=holiday_row, column=3).alignment = center_alignment
                    
                    holiday_ws.cell(row=holiday_row, column=4, value=record.get('holiday_name', '')).font = data_font
                    holiday_ws.cell(row=holiday_row, column=4).border = border
                    holiday_ws.cell(row=holiday_row, column=4).alignment = center_alignment
                    
                    holiday_ws.cell(row=holiday_row, column=5, value=record.get('duration', 0)).font = data_font
                    holiday_ws.cell(row=holiday_row, column=5).border = border
                    holiday_ws.cell(row=holiday_row, column=5).alignment = center_alignment
                    holiday_ws.cell(row=holiday_row, column=5).number_format = '#,##0'
                    
                    holiday_row += 1
            
            # å¦‚æœæ²’æœ‰å‡æœŸè¨˜éŒ„ï¼Œå¯«å…¥æç¤º
            if holiday_row == 2:
                holiday_ws.cell(row=2, column=1, value="æš«ç„¡å‡æœŸè¨˜éŒ„")
                holiday_ws.cell(row=2, column=1).font = Font(name='Microsoft YaHei UI', size=10, italic=True, color='666666')
            
            # èª¿æ•´å‡æœŸå·¥ä½œè¡¨åˆ—å¯¬
            holiday_column_widths = [12, 12, 12, 25, 15]
            for col, width in enumerate(holiday_column_widths, 1):
                holiday_ws.column_dimensions[chr(64 + col)].width = width
            
            # å‡çµå‡æœŸå·¥ä½œè¡¨é¦–è¡Œ
            holiday_ws.freeze_panes = 'A2'
            
            # ä¿å­˜æ–‡ä»¶
            wb.save(file_path)
            print(f"âœ… è‡ªå‹•ä¿å­˜æ´»å‹•è¨˜éŒ„å’Œå‡æœŸè¨˜éŒ„åˆ°: {file_path}")
            
        except Exception as e:
            print(f"âš ï¸ è‡ªå‹•ä¿å­˜å¤±æ•—: {e}")
    
    def auto_load_promotion_records(self):
        """è‡ªå‹•å¾ PromotionRecords.xlsx è®€å–æ´»å‹•è¨˜éŒ„å’Œå‡æœŸè¨˜éŒ„"""
        try:
            import pandas as pd
            import os
            
            # ä½¿ç”¨å›ºå®šæ–‡ä»¶åï¼Œå¾ç¨‹åºæ‰€åœ¨ç›®éŒ„è®€å–
            current_dir = os.path.dirname(os.path.abspath(__file__))
            file_path = os.path.join(current_dir, "PromotionRecords.xlsx")
            
            # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if not os.path.exists(file_path):
                print(f"â„¹ï¸ æ‰¾ä¸åˆ° PromotionRecords.xlsx æ–‡ä»¶ï¼Œå°‡åœ¨é¦–æ¬¡ä¿å­˜æ™‚å‰µå»º")
                return
            
            # è®€å–Excelæ–‡ä»¶
            excel_file = pd.ExcelFile(file_path)
            available_sheets = excel_file.sheet_names
            
            # æª¢æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€çš„sheet
            required_sheets = ['GOGO', 'Express', 'PLUS']
            missing_sheets = [sheet for sheet in required_sheets if sheet not in available_sheets]
            if missing_sheets:
                print(f"âš ï¸ Excelæ–‡ä»¶ç¼ºå°‘ä»¥ä¸‹å·¥ä½œè¡¨: {', '.join(missing_sheets)}")
            
            # ç¢ºä¿å‡æœŸè¨˜éŒ„å­˜åœ¨
            if not hasattr(self, 'holiday_records'):
                self.holiday_records = {
                    'GOGO': [],
                    'Express': [],
                    'PLUS': []
                }
            
            # å°å…¥æ¯å€‹æ•¸æ“šåº«çš„è¨˜éŒ„
            imported_count = 0
            for db_name in required_sheets:
                if db_name in available_sheets:
                    try:
                        # è®€å–å·¥ä½œè¡¨
                        df = pd.read_excel(file_path, sheet_name=db_name)
                        
                        # è·³éç©ºçš„å·¥ä½œè¡¨
                        if df.empty or len(df) == 0:
                            continue
                        
                        # è½‰æ›ç‚ºæ´»å‹•è¨˜éŒ„æ ¼å¼
                        records = []
                        for _, row in df.iterrows():
                            # è·³éç©ºè¡Œæˆ–æç¤ºè¡Œ
                            if pd.isna(row.iloc[0]) or 'æš«ç„¡' in str(row.iloc[0]):
                                continue
                            
                            # è§£æåˆ†æçµæœ
                            analysis_result = {}
                            if not pd.isna(row.iloc[10]) and str(row.iloc[10]) != 'æœªåˆ†æ':  # ç¸½æ¥­ç¸¾
                                try:
                                    # è§£æé‡‘é¡æ ¼å¼
                                    total_amount_str = str(row.iloc[10]).replace('$', '').replace(',', '')
                                    analysis_result['total_amount'] = float(total_amount_str)
                                except:
                                    analysis_result['total_amount'] = 0
                            
                            if not pd.isna(row.iloc[11]) and str(row.iloc[11]) != 'æœªåˆ†æ':  # ç¸½å–®æ“šæ•¸
                                try:
                                    total_receipts_str = str(row.iloc[11]).replace(',', '')
                                    analysis_result['total_receipts'] = int(total_receipts_str)
                                except:
                                    analysis_result['total_receipts'] = 0
                            
                            if not pd.isna(row.iloc[12]) and str(row.iloc[12]) != 'æœªåˆ†æ':  # æ´»å‹•æ¥­ç¸¾
                                try:
                                    activity_amount_str = str(row.iloc[12]).replace('$', '').replace(',', '')
                                    analysis_result['activity_amount'] = float(activity_amount_str)
                                except:
                                    analysis_result['activity_amount'] = 0
                            
                            if not pd.isna(row.iloc[13]) and str(row.iloc[13]) != 'æœªåˆ†æ':  # æ´»å‹•å–®æ“šæ•¸
                                try:
                                    activity_receipts_str = str(row.iloc[13]).replace(',', '')
                                    analysis_result['activity_receipts'] = int(activity_receipts_str)
                                except:
                                    analysis_result['activity_receipts'] = 0
                            
                            if not pd.isna(row.iloc[14]) and str(row.iloc[14]) != 'æœªåˆ†æ':  # æ¥­ç¸¾å æ¯”%
                                try:
                                    amount_ratio_str = str(row.iloc[14]).replace('%', '')
                                    analysis_result['amount_ratio'] = float(amount_ratio_str)
                                except:
                                    analysis_result['amount_ratio'] = 0
                            
                            if not pd.isna(row.iloc[15]) and str(row.iloc[15]) != 'æœªåˆ†æ':  # å–®æ“šæ•¸å æ¯”%
                                try:
                                    receipt_ratio_str = str(row.iloc[15]).replace('%', '')
                                    analysis_result['receipt_ratio'] = float(receipt_ratio_str)
                                except:
                                    analysis_result['receipt_ratio'] = 0
                            
                            if not pd.isna(row.iloc[16]):  # åˆ†ææ™‚é–“
                                analysis_result['analyzed_time'] = str(row.iloc[16])
                            
                            # å‰µå»ºæ´»å‹•è¨˜éŒ„
                            record = {
                                'id': str(row.iloc[0]) if not pd.isna(row.iloc[0]) else '',
                                'description': str(row.iloc[1]) if not pd.isna(row.iloc[1]) else '',
                                'type': str(row.iloc[2]) if not pd.isna(row.iloc[2]) else 'normal',
                                'date_from': str(row.iloc[3]) if not pd.isna(row.iloc[3]) else '',
                                'date_to': str(row.iloc[4]) if not pd.isna(row.iloc[4]) else '',
                                'weekdays': str(row.iloc[5]).split(', ') if not pd.isna(row.iloc[5]) and str(row.iloc[5]) != 'å…¨éƒ¨' else [],
                                'outlets': str(row.iloc[6]).split(', ') if not pd.isna(row.iloc[6]) else [],
                                'parts': str(row.iloc[7]).split(', ') if not pd.isna(row.iloc[7]) else [],
                                'products': str(row.iloc[8]).split(', ') if not pd.isna(row.iloc[8]) else [],
                                'payment_methods': str(row.iloc[9]).split(', ') if not pd.isna(row.iloc[9]) else [],
                                'analysis_result': analysis_result if analysis_result else {},
                                'created_time': str(row.iloc[17]) if not pd.isna(row.iloc[17]) else '',
                                'database': db_name
                            }
                            
                            records.append(record)
                            imported_count += 1
                        
                        # æ›´æ–°æ´»å‹•è¨˜éŒ„
                        self.activity_records[db_name] = records
                        
                    except Exception as e:
                        print(f"å°å…¥ {db_name} æ•¸æ“šåº«è¨˜éŒ„æ™‚å‡ºéŒ¯: {e}")
                        continue
            
            # å°å…¥å‡æœŸè¨˜éŒ„
            holiday_imported_count = 0
            if 'Holidays' in available_sheets:
                try:
                    # è®€å–å‡æœŸå·¥ä½œè¡¨
                    holiday_df = pd.read_excel(file_path, sheet_name='Holidays')
                    
                    # æ¸…ç©ºç¾æœ‰å‡æœŸè¨˜éŒ„
                    for db_name in ['GOGO', 'Express', 'PLUS']:
                        self.holiday_records[db_name] = []
                    
                    # è½‰æ›å‡æœŸè¨˜éŒ„
                    for _, row in holiday_df.iterrows():
                        # è·³éç©ºè¡Œæˆ–æç¤ºè¡Œ
                        if pd.isna(row.iloc[0]) or 'æš«ç„¡' in str(row.iloc[0]):
                            continue
                        
                        # ç²å–æ•¸æ“šåº«åç¨±
                        db_name = str(row.iloc[0]) if not pd.isna(row.iloc[0]) else 'Express'
                        if db_name not in ['GOGO', 'Express', 'PLUS']:
                            continue
                        
                        # å‰µå»ºå‡æœŸè¨˜éŒ„
                        holiday_record = {
                            'start_date': str(row.iloc[1]) if not pd.isna(row.iloc[1]) else '',
                            'end_date': str(row.iloc[2]) if not pd.isna(row.iloc[2]) else '',
                            'holiday_name': str(row.iloc[3]) if not pd.isna(row.iloc[3]) else '',
                            'duration': int(row.iloc[4]) if not pd.isna(row.iloc[4]) else 0
                        }
                        
                        # æ·»åŠ åˆ°å°æ‡‰æ•¸æ“šåº«çš„å‡æœŸè¨˜éŒ„
                        self.holiday_records[db_name].append(holiday_record)
                        holiday_imported_count += 1
                        
                except Exception as e:
                    print(f"å°å…¥å‡æœŸè¨˜éŒ„æ™‚å‡ºéŒ¯: {e}")
            
            print(f"âœ… è‡ªå‹•è®€å–å®Œæˆ: {imported_count} æ¢æ´»å‹•è¨˜éŒ„, {holiday_imported_count} æ¢å‡æœŸè¨˜éŒ„")
            
            # è‡ªå‹•è®€å–å®Œæˆå¾Œæ›´æ–°ç”¢å“é¸æ“‡å™¨
            try:
                print("ğŸ”„ è‡ªå‹•è®€å–å®Œæˆå¾Œæ›´æ–°ç”¢å“é¸æ“‡å™¨...")
                # å»¶é²åŸ·è¡Œä»¥ç¢ºä¿æ´»å‹•è¨˜éŒ„çª—å£å·²åˆå§‹åŒ–
                if hasattr(self, 'activity_window') and self.activity_window.winfo_exists():
                    self.activity_window.after(200, self.update_activity_products_from_records)
                else:
                    # å¦‚æœæ´»å‹•çª—å£ä¸å­˜åœ¨ï¼Œç›´æ¥èª¿ç”¨
                    self.update_activity_products_from_records()
                print("âœ… ç”¢å“é¸æ“‡å™¨æ›´æ–°å·²å®‰æ’")
            except Exception as e:
                print(f"âš ï¸ è‡ªå‹•è®€å–å¾Œæ›´æ–°ç”¢å“é¸æ“‡å™¨å¤±æ•—: {e}")
            
        except Exception as e:
            print(f"âš ï¸ è‡ªå‹•è®€å–å¤±æ•—: {e}")
    
    def analyze_specific_activity(self, date_from_str, date_to_str, outlet_filters, product_filters, payment_filters, database):
        """åˆ†æç‰¹å®šæ´»åŠ¨ - ä½¿ç”¨ä¿å­˜çš„æ´»åŠ¨å‚æ•°æ‰§è¡Œåˆ†æ"""
        try:
            # è¿æ¥æ•°æ®åº“
            current_db = database
            
            # ä½¿ç”¨æ´»åŠ¨æ•°æ®åº“è¿æ¥æ–¹æ³•
            if not self.connect_to_activity_database(current_db):
                tk.messagebox.showerror("é”™è¯¯", f"æ— æ³•è¿æ¥åˆ° {current_db} æ•°æ®åº“")
                return
            
            # åˆ›å»ºåˆ†æç»“æœçª—å£
            analysis_window = tk.Toplevel(self.root)
            analysis_window.title("ğŸ“Š æ´»åŠ¨ä¸šç»©åˆ†æ / Activity Performance Analysis")
            analysis_window.geometry("1000x700")
            
            # è¨­ç½®çª—å£é—œé–‰å”è­°
            analysis_window.protocol("WM_DELETE_WINDOW", analysis_window.destroy)
            
            # ä¸»æ¡†æ¶
            main_frame = tk.Frame(analysis_window)
            main_frame.pack(fill="both", expand=True, padx=10, pady=10)
            
            # åˆ›å»ºæ»šåŠ¨æ¡å’Œæ–‡æœ¬æ¡† 
            result_text = tk.Text(main_frame, height=25, width=80, wrap=tk.WORD, font=('Consolas', 9))
            result_scrollbar = ttk.Scrollbar(main_frame, orient="vertical", command=result_text.yview)
            result_text.configure(yscrollcommand=result_scrollbar.set)
            
            result_text.pack(side="left", fill="both", expand=True)
            result_scrollbar.pack(side="right", fill="y")
            
            # æ·»åŠ ç»“æœä¿¡æ¯
            result_text.insert(tk.END, f"ğŸ” åˆ†æç‰¹å®šæ´»åŠ¨è®°å½•\n")
            result_text.insert(tk.END, f"ğŸ“ æ´»åŠ¨æœŸé—´: {date_from_str} è‡³ {date_to_str}\n")
            result_text.insert(tk.END, f"ğŸª æ¶‰åŠé—¨å¸‚: {', '.join(outlet_filters)}\n")
            result_text.insert(tk.END, f"ğŸ£ æ¶‰åŠäº§å“: {', '.join(product_filters) if product_filters else 'æ‰€æœ‰äº§å“'}\n")
            result_text.insert(tk.END, f"{'=' * 60}\n\n")
            
            # æ‰§è¡Œåˆ†æ
            self.perform_activity_analysis(result_text, date_from_str, date_to_str, outlet_filters, product_filters, current_db, payment_filters, None, False, None, None, False)
            result_text.config(state=tk.DISABLED)
            
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"åˆ†æç‰¹å®šæ´»åŠ¨å¤±è´¥: {e}")
    
    def clear_activity_records(self):
        """æ¸…é™¤æ‰€æœ‰æ´»åŠ¨è®°å½•"""
        current_db = self.activity_database.get() if hasattr(self, 'activity_database') else 'Express'
        records_for_db = self.activity_records.get(current_db, [])
        
        if not records_for_db:
            self.show_activity_message("â„¹ æš‚æ— æ´»åŠ¨è®°å½•å¯æ¸…é™¤")
            return
        
        # ç¡®è®¤å¯¹è¯æ¡†
        result = tk.messagebox.askyesno("ç¡®è®¤æ¸…é™¤", "ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ´»åŠ¨è®°å½•å—ï¼Ÿ\nAre you sure to clear all activity records?")
        if result:
            self.activity_records[current_db] = []
            self.refresh_activity_tree()
            self.save_activity_records()  # ä¿å­˜åˆ°æ–‡ä»¶
            self.show_activity_message("âœ“ æ‰€æœ‰æ´»åŠ¨è®°å½•å·²æ¸…é™¤")
    
    def delete_single_activity_record(self):
        """åˆ é™¤å•ä¸ªé€‰ä¸­æ´»åŠ¨è®°å½•"""
        try:
            if not hasattr(self, 'activity_tree'):
                self.show_activity_message("âš  æ´»åŠ¨è®°å½•è¡¨ä¸å­˜åœ¨")
                return
            
            selection = self.activity_tree.selection()
            if not selection:
                tk.messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©è¦åˆ é™¤çš„æ´»åŠ¨è®°å½•")
                return
            
            # è·å–é€‰ä¸­çš„è®°å½•
            item = self.activity_tree.item(selection[0])
            values = item['values']
            activity_id = values[0]
            
            # ç¡®è®¤åˆ é™¤
            result = tk.messagebox.askyesno("ç¡®è®¤åˆ é™¤", f"æ˜¯å¦ç¡®å®šåˆ é™¤æ´»åŠ¨è®°å½•ID: {activity_id}?")
            if result:
                current_db = self.activity_database.get() if hasattr(self, 'activity_database') else 'Express'
                
                # æ‰¾åˆ°å¹¶åˆ é™¤è®°å½•
                if current_db in self.activity_records:
                    records = self.activity_records[current_db]
                    record_to_remove = None
                    
                    for record in records:
                        if record.get('id') == int(activity_id):
                            record_to_remove = record
                            break
                    
                    if record_to_remove:
                        self.activity_records[current_db].remove(record_to_remove)
                        self.refresh_activity_tree()
                        self.save_activity_records()  # ä¿å­˜åˆ°æ–‡ä»¶
                        self.show_activity_message(f"âœ… æ´»åŠ¨è®°å½•ID: {activity_id} å·²åˆ é™¤")
                    else:
                        self.show_activity_message("âš  æœªæ‰¾åˆ°å¯¹åº”çš„è®°å½•")
                else:
                    self.show_activity_message("âš  å½“å‰æ•°æ®åº“æ²¡æœ‰æ´»åŠ¨è®°å½•")
                    
        except Exception as e:
            tk.messagebox.showerror("é”™è¯¯", f"åˆ é™¤æ´»åŠ¨è®°å½•å¤±è´¥: {e}")
    
    def update_activity_summary(self):
        """æ›´æ–°æ´»åŠ¨æ‘˜è¦æ˜¾ç¤º"""
        if not self.activity_records:
            self.activity_summary_frame.pack_forget()
            return
        
        # æ˜¾ç¤ºæ´»åŠ¨æ‘˜è¦æ¡†æ¶
        self.activity_summary_frame.pack(fill="x", pady=5)
        
        # æ¸…ç©ºæ–‡æœ¬
        self.activity_summary_text.delete(1.0, tk.END)
        
        # æŒ‰æ—¥æœŸæ’åºæ´»åŠ¨è®°å½•
        sorted_records = sorted(self.activity_records, key=lambda x: x['date_from'])
        
        summary_text = "ğŸ“Š æ´»åŠ¨æ‘˜è¦ / Activity Summary:\n\n"
        
        for record in sorted_records:
            summary_text += f"ğŸ“… {record['date_from']} - {record['date_to']}\n"
            summary_text += f"ğŸª é—¨å¸‚: {', '.join(record['outlets'])}\n"
            summary_text += f"ğŸ“Š éƒ¨åˆ†: {', '.join(record['parts'])}\n"
            summary_text += f"ğŸ“ æ´»åŠ¨: {record['description']}\n"
            summary_text += "-" * 50 + "\n"
        
        self.activity_summary_text.insert(1.0, summary_text)
    
    def get_activities_for_date_range(self, date_from, date_to, database_filter=None):
        """è·å–æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„æ´»åŠ¨è®°å½•"""
        matching_activities = []
        
        # self.activity_recordsæ˜¯å­—å…¸æŒ‰æ•°æ®åº“åˆ†ç»„
        for db_name, activities in self.activity_records.items():
            # å¦‚æœæŒ‡å®šäº†æ•¸æ“šåº«ç¯©é¸ï¼Œåªè™•ç†è©²æ•¸æ“šåº«çš„æ´»å‹•
            if database_filter and db_name != database_filter:
                continue
                
            if isinstance(activities, list):
                for activity in activities:
                    # ç¡®ä¿æ´»åŠ¨è®°å½•æœ‰date_fromå’Œdate_toå­—æ®µ
                    if 'date_from' in activity and 'date_to' in activity:
                        try:
                            activity_start = datetime.strptime(activity['date_from'], '%Y-%m-%d').date()
                            activity_end = datetime.strptime(activity['date_to'], '%Y-%m-%d').date()
                            
                            # æ£€æŸ¥æ—¥æœŸèŒƒå›´æ˜¯å¦æœ‰é‡å 
                            if not (date_to < activity_start or date_from > activity_end):
                                # æ·»åŠ æ•¸æ“šåº«ä¿¡æ¯åˆ°æ´»å‹•è¨˜éŒ„ä¸­
                                activity_with_db = activity.copy()
                                activity_with_db['database'] = db_name
                                matching_activities.append(activity_with_db)
                        except ValueError as e:
                            print(f"âŒ æ—¥æœŸæ ¼å¼é”™è¯¯: {activity.get('date_from', 'N/A')} - {activity.get('date_to', 'N/A')}")
                            continue
        
        return matching_activities
    
    def get_activities_for_outlet(self, outlet):
        """è·å–æŒ‡å®šé—¨å¸‚çš„æ´»åŠ¨è®°å½•"""
        matching_activities = []
        
        # self.activity_recordsæ˜¯å­—å…¸æŒ‰æ•°æ®åº“åˆ†ç»„
        for db_name, activities in self.activity_records.items():
            if isinstance(activities, list):
                for activity in activities:
                    # ç¡®ä¿æ´»åŠ¨è®°å½•æœ‰outletså­—æ®µ
                    if 'outlets' in activity:
                        if outlet in activity['outlets'] or 'All' in activity['outlets']:
                            matching_activities.append(activity)
        
        return matching_activities
    
    def ensure_right_panel_visible(self):
        """ç¡®ä¿å³ä¾§é¢æ¿å¯è§ - ä¸æœƒé‡æ–°å‰µå»ºï¼Œåªç¢ºä¿å¯è¦‹"""
        try:
            if hasattr(self, 'right_panel'):
                # æ£€æŸ¥é¢æ¿æ˜¯å¦å­˜åœ¨ä¸”å¯è¦‹
                try:
                    panel_visible = self.right_panel.winfo_viewable()
                    if not panel_visible:
                        # é¢æ¿å­˜åœ¨ä½†ä¸å¯è¦‹ï¼Œé‡æ–°packé¡¯ç¤º
                        self.right_panel.pack(side="right", fill="y", expand=False, padx=(8, 15), pady=15)
                        self.right_panel.configure(width=270)
                        self.right_panel.pack_propagate(False)
                        print("âœ“ å³å´é¢æ¿å·²æ¢å¾©é¡¯ç¤º")
                except tk.TclError:
                    # é¢æ¿ä¸å­˜åœ¨ï¼Œä½†ä¸æœƒé‡æ–°å‰µå»ºä»¥é¿å…ç ´å£ç¾æœ‰è¨­ç½®
                    print("âš ï¸ å³å´é¢æ¿ä¸å­˜åœ¨ï¼Œä½†ä¸æœƒé‡æ–°å‰µå»º")
        except Exception as e:
            print(f"âœ— ç¢ºä¿å³å´é¢æ¿å¯è¦‹æ™‚å‡ºéŒ¯: {e}")
    
    def create_right_panel(self):
        """åˆ›å»ºå³ä¾§é¢æ¿"""
        try:
            # å¦‚æœå³å´é¢æ¿ä¸å­˜åœ¨ï¼Œåªæ˜¯ç¢ºä¿å®ƒå­˜åœ¨è€Œä¸é‡æ–°å‰µå»º
            if not hasattr(self, 'right_panel') or not self.right_panel.winfo_exists():
                self.log_message("âš ï¸ å³å´é¢æ¿ä¸å­˜åœ¨ï¼Œä½†ä¸æœƒé‡æ–°å‰µå»ºä»¥é¿å…è¦†è“‹ç¾æœ‰è¨­ç½®")
            else:
                self.log_message("âœ“ å³å´é¢æ¿å·²å­˜åœ¨ä¸¦æ­£å¸¸é‹è¡Œ")
        except Exception as e:
            self.log_message(f"âœ— é‡æ–°è¨­ç½®å³å´é¢æ¿æ™‚å‡ºéŒ¯: {e}")
    
    def update_activity_alerts(self):
        """æ›´æ–°æ´»åŠ¨æé†’æ˜¾ç¤º - å¢å¼·ç‰ˆåŒ…å«æ¥­ç¸¾å æ¯”"""
        try:
            # ç¡®ä¿å³ä¾§é¢æ¿å¯è§
            self.ensure_right_panel_visible()
            
            # è·å–å½“å‰æœç´¢çš„æ—¥æœŸèŒƒå›´
            if hasattr(self, 'date_from') and hasattr(self, 'date_to'):
                search_date_from = self.date_from.get_date()
                search_date_to = self.date_to.get_date()
                
                # ç²å–ç•¶å‰é¸æ“‡çš„æ•¸æ“šåº« - ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åº“é€‰æ‹©é€»è¾‘
                current_database = self.get_current_database()
                print(f"DEBUG: update_activity_alerts using current_database: {current_database}")
                
                # æŸ¥æ‰¾åŒ¹é…çš„æ´»åŠ¨è®°å½•ï¼ˆåªé¡¯ç¤ºç•¶å‰æ•¸æ“šåº«çš„æ´»å‹•ï¼‰
                print(f"DEBUG: Searching for activities in database: {current_database}")
                print(f"DEBUG: Available activity databases: {list(self.activity_records.keys())}")
                matching_activities = self.get_activities_for_date_range(search_date_from, search_date_to, current_database)
                print(f"DEBUG: Found {len(matching_activities)} matching activities for {current_database}")
                
                # æ¸…ç©ºæ˜¾ç¤ºåŒºåŸŸ
                self.activity_alert_text.config(state='normal')
                self.activity_alert_text.delete(1.0, tk.END)
                
                if matching_activities:
                    # æ¸…ç©ºæ˜¾ç¤ºåŒºåŸŸå¹¶é‡æ–°åˆ›å»º
                    self.activity_alert_text.config(state='normal')
                    self.activity_alert_text.delete(1.0, tk.END)
                    
                    # åˆ›å»ºæ ‡é¢˜åŒºåŸŸ
                    self.activity_alert_text.insert(tk.END, "ğŸ“Š æ´»å‹•æé†’ / Activity Alerts\n", "header")
                    self.activity_alert_text.insert(tk.END, f"æœç´¢æ—¥æœŸ / Search Date: {search_date_from.strftime('%d/%m/%Y')} - {search_date_to.strftime('%d/%m/%Y')}\n", "date_info")
                    self.activity_alert_text.insert(tk.END, f"ç™¼ç¾ {len(matching_activities)} å€‹ç›¸é—œæ´»å‹• / Found {len(matching_activities)} Activities:\n\n", "count_info")
                    
                    # åˆ›å»ºå¯ç‚¹å‡»çš„æ´»åŠ¨åˆ—è¡¨
                    for i, activity in enumerate(matching_activities, 1):
                        description = activity.get('description', activity.get('name', 'ç„¡æè¿°'))
                        activity_line = f"ğŸ”¸ æ´»å‹• {i} / Activity {i}: {description}\n"
                        
                        # æ’å…¥å¯ç‚¹å‡»çš„æ´»åŠ¨æ ‡é¢˜
                        start_index = self.activity_alert_text.index(tk.END + "-1c")
                        self.activity_alert_text.insert(tk.END, activity_line, f"activity_{i}")
                        end_index = self.activity_alert_text.index(tk.END + "-1c")
                        
                        # ä¸ºæ´»åŠ¨æ ‡é¢˜æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        self.activity_alert_text.tag_bind(f"activity_{i}", "<Button-1>", 
                                                         lambda e, act=activity, idx=i: self.show_activity_details(act, idx))
                        self.activity_alert_text.tag_bind(f"activity_{i}", "<Enter>", 
                                                         lambda e, tag=f"activity_{i}": self.on_activity_hover_enter(tag))
                        self.activity_alert_text.tag_bind(f"activity_{i}", "<Leave>", 
                                                         lambda e, tag=f"activity_{i}": self.on_activity_hover_leave(tag))
                    
                    self.activity_alert_text.insert(tk.END, "\n------æ´»å‹•ç´°ç¯€------\n", "separator")
                    
                    # æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ´»åŠ¨çš„è¯¦ç»†ä¿¡æ¯ï¼ˆé»˜è®¤é€‰ä¸­ï¼‰
                    if matching_activities:
                        self.show_activity_details(matching_activities[0], 1, insert_mode=True)
                else:
                    # æ²¡æœ‰åŒ¹é…çš„æ´»åŠ¨
                    self.activity_alert_text.insert(tk.END, "ğŸ“Š æ´»å‹•æé†’ / Activity Alerts\n\n", "header")
                    self.activity_alert_text.insert(tk.END, f"æœç´¢æ—¥æœŸ / Search Date: {search_date_from.strftime('%d/%m/%Y')} - {search_date_to.strftime('%d/%m/%Y')}\n\n", "date_info")
                    self.activity_alert_text.insert(tk.END, "âœ… ç•¶å‰æ—¥æœŸç¯„åœå…§æ²’æœ‰è¨˜éŒ„çš„æ´»å‹•\nNo recorded activities in current date range\n\n", "no_activity")
                    self.activity_alert_text.insert(tk.END, "ğŸ’¡ æç¤º / Note: æ•¸æ“šåˆ†æçµæœä¸æœƒå—åˆ°ç‰¹æ®Šæ´»å‹•å½±éŸ¿\nData analysis results will not be affected by special activities", "note")
                
                # é…ç½®æ–‡æœ¬æ ·å¼
                self.configure_activity_alert_styles()
                self.activity_alert_text.config(state='disabled')
            else:
                # æ—¥æœŸé€‰æ‹©å™¨è¿˜æœªåˆå§‹åŒ–
                self.activity_alert_text.config(state='normal')
                self.activity_alert_text.delete(1.0, tk.END)
                self.activity_alert_text.insert(1.0, "ğŸ“Š æ´»å‹•æé†’ / Activity Alerts\n\nè«‹é¸æ“‡æœç´¢æ—¥æœŸç¯„åœä»¥é¡¯ç¤ºæ´»å‹•æé†’\nPlease select search date range to display activity alerts")
                self.activity_alert_text.config(state='disabled')
                
        except Exception as e:
            # å‘ç”Ÿé”™è¯¯æ—¶çš„å¤„ç†
            self.activity_alert_text.config(state='normal')
            self.activity_alert_text.delete(1.0, tk.END)
            self.activity_alert_text.insert(1.0, f"ğŸ“Š æ´»å‹•æé†’ / Activity Alerts\n\néŒ¯èª¤ / Error: {str(e)}")
            self.activity_alert_text.config(state='disabled')
    
    def configure_activity_alert_styles(self):
        """é…ç½®æ´»å‹•æé†’æ–‡æœ¬çš„æ¨£å¼"""
        try:
            # æ¨™é¡Œæ¨£å¼
            self.activity_alert_text.tag_configure("header", 
                                                  font=('Microsoft YaHei UI', 14, 'bold'),
                                                  foreground='#2c3e50')
            
            # æ—¥æœŸä¿¡æ¯æ¨£å¼
            self.activity_alert_text.tag_configure("date_info", 
                                                  font=('Arial', 11),
                                                  foreground='#34495e')
            
            # è¨ˆæ•¸ä¿¡æ¯æ¨£å¼
            self.activity_alert_text.tag_configure("count_info", 
                                                  font=('Arial', 11, 'bold'),
                                                  foreground='#27ae60')
            
            # æ´»å‹•é …ç›®æ¨£å¼ï¼ˆå¯é»æ“Šï¼‰
            for i in range(1, 11):  # æ”¯æŒæœ€å¤š10å€‹æ´»å‹•
                self.activity_alert_text.tag_configure(f"activity_{i}", 
                                                      font=('Microsoft YaHei UI', 11, 'bold'),
                                                      foreground='#3498db',
                                                      underline=False)
            
            # åˆ†éš”ç¬¦æ¨£å¼
            self.activity_alert_text.tag_configure("separator", 
                                                  font=('Arial', 11, 'bold'),
                                                  foreground='#7f8c8d')
            
            # è©³æƒ…æ¨£å¼
            self.activity_alert_text.tag_configure("details", 
                                                  font=('Arial', 10),
                                                  foreground='#2c3e50')
            
            # ç„¡æ´»å‹•æ¨£å¼
            self.activity_alert_text.tag_configure("no_activity", 
                                                  font=('Arial', 11),
                                                  foreground='#27ae60')
            
            # æç¤ºæ¨£å¼
            self.activity_alert_text.tag_configure("note", 
                                                  font=('Arial', 10, 'italic'),
                                                  foreground='#95a5a6')
            
        except Exception as e:
            print(f"é…ç½®æ´»å‹•æé†’æ¨£å¼å¤±æ•—: {e}")
    
    def show_activity_details(self, activity, activity_index, insert_mode=False):
        """é¡¯ç¤ºæ´»å‹•è©³ç´°ä¿¡æ¯"""
        try:
            if not insert_mode:
                # æ¸…é™¤è©³æƒ…å€åŸŸï¼ˆå¾åˆ†éš”ç¬¦å¾Œé–‹å§‹ï¼‰
                self.activity_alert_text.config(state='normal')
                
                # æ‰¾åˆ°åˆ†éš”ç¬¦çš„ä½ç½®
                separator_pos = self.activity_alert_text.search("------æ´»å‹•ç´°ç¯€------", "1.0", tk.END)
                if separator_pos:
                    # åˆªé™¤åˆ†éš”ç¬¦å¾Œçš„æ‰€æœ‰å…§å®¹
                    self.activity_alert_text.delete(f"{separator_pos} lineend", tk.END)
            
            # æ§‹å»ºæ´»å‹•è©³æƒ…
            details_text = f"\nğŸ”¸ æ´»å‹• {activity_index} / Activity {activity_index}:\n\n"
            
            # æ—¥æœŸæœŸé–“
            details_text += f"ğŸ“… æ—¥æœŸæœŸé–“ / Date Period:\n"
            details_text += f"   {activity['date_from']} - {activity['date_to']}\n\n"
            
            # æ˜ŸæœŸç¯©é¸ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            weekdays = activity.get('weekdays', [])
            if weekdays:
                details_text += f"ğŸ—“ï¸ æ˜ŸæœŸç¯©é¸ / Weekday Filter:\n"
                details_text += f"   {', '.join(weekdays)}\n\n"
            
            # é–€å¸‚ä¿¡æ¯
            outlets = activity.get('outlets', [])
            if outlets:
                total_outlets = len(getattr(self, 'available_outlets', []))
                if len(outlets) == total_outlets or len(outlets) > total_outlets * 0.9:
                    details_text += f"ğŸª é–€å¸‚ / Outlets: All\n\n"
                elif len(outlets) <= 10:
                    details_text += f"ğŸª é–€å¸‚ / Outlets:\n"
                    details_text += f"   {', '.join(outlets)}\n\n"
                else:
                    details_text += f"ğŸª é–€å¸‚ / Outlets: {len(outlets)} å€‹é–€å¸‚ / {len(outlets)} Outlets\n\n"
            else:
                details_text += f"ğŸª é–€å¸‚ / Outlets: All\n\n"
            
            # æ´»å‹•è©³æƒ…ï¼ˆæè¿°ï¼‰
            description = activity.get('description', activity.get('name', 'ç„¡æè¿°'))
            details_text += f"ğŸ“ æ´»å‹•è©³æƒ… / Activity Details:\n"
            details_text += f"   {description}\n\n"
            
            # æ´»å‹•æ•¸æ“š
            details_text += f"ğŸ’° æ´»å‹•æ•¸æ“š / Activity Data:\n"
            
            # æª¢æŸ¥æ•¸æ“šåº«é€£æ¥å’Œåˆ†æçµæœ - å„ªå…ˆä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µ
            activity_db = activity.get('database', 'Express')
            
            # å„ªå…ˆä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µ
            if activity.get('total_sales') is not None:
                # ä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µ
                total_sales = activity.get('total_sales', 0)
                total_transactions = activity.get('total_receipts', 0)
                activity_sales = activity.get('activity_sales', 0)
                activity_transactions = activity.get('activity_receipts', 0)
                amount_ratio = activity.get('sales_ratio', 0)
                receipt_ratio = activity.get('receipt_ratio', 0)
                analyzed_time = activity.get('analysis_time', 'Unknown')
                
                details_text += f"   ğŸ“Š ç¸½æ¥­ç¸¾ / Total Sales: ${total_sales:,.2f}\n"
                details_text += f"   ğŸ“Š ç¸½å–®æ“šæ•¸ / Total Transactions: {total_transactions:,}\n"
                details_text += f"   ğŸ’° æ´»å‹•æ¥­ç¸¾ / Activity Sales: ${activity_sales:,.2f}\n"
                details_text += f"   ğŸ§¾ æ´»å‹•å–®æ“šæ•¸ / Activity Transactions: {activity_transactions:,}\n"
                details_text += f"   ğŸ“… åˆ†ææ™‚é–“ / Analyzed: {analyzed_time}\n\n"
                
                # é¡¯ç¤ºå æ¯”ä¿¡æ¯
                details_text += f"ğŸ“Š æ¥­ç¸¾å æ¯” / Performance Ratio:\n"
                details_text += f"   {amount_ratio:.2f}%\n\n"
                
                details_text += f"ğŸ“Š å–®æ“šæ•¸å æ¯” / Transaction Ratio:\n"
                details_text += f"   {receipt_ratio:.2f}%\n\n"
                
                print(f"ğŸ“Š æ´»å‹•æé†’ - ä½¿ç”¨ç›´æ¥æ›´æ–°çš„å­—æ®µé¡¯ç¤ºæ´»å‹• {activity.get('id')} çš„åˆ†æçµæœ")
            else:
                # ä½¿ç”¨èˆŠçš„åˆ†æçµæœå­—æ®µ
                analysis_result = activity.get('analysis_result')
                if analysis_result:
                    # é¡¯ç¤ºä¿å­˜çš„åˆ†æçµæœ - ä¿®æ­£æ•¸æ“šæ ¼å¼
                    total_sales = analysis_result.get('total_amount', 0)
                    total_transactions = analysis_result.get('total_receipts', 0)
                    activity_sales = analysis_result.get('activity_amount', 0)
                    activity_transactions = analysis_result.get('activity_receipts', 0)
                    amount_ratio = analysis_result.get('amount_ratio', 0)
                    receipt_ratio = analysis_result.get('receipt_ratio', 0)
                    analyzed_time = analysis_result.get('analyzed_at', 'Unknown')
                    
                    details_text += f"   ğŸ“Š ç¸½æ¥­ç¸¾ / Total Sales: ${total_sales:,.2f}\n"
                    details_text += f"   ğŸ“Š ç¸½å–®æ“šæ•¸ / Total Transactions: {total_transactions:,}\n"
                    details_text += f"   ğŸ’° æ´»å‹•æ¥­ç¸¾ / Activity Sales: ${activity_sales:,.2f}\n"
                    details_text += f"   ğŸ§¾ æ´»å‹•å–®æ“šæ•¸ / Activity Transactions: {activity_transactions:,}\n"
                    details_text += f"   ğŸ“… åˆ†ææ™‚é–“ / Analyzed: {analyzed_time}\n\n"
                    
                    # é¡¯ç¤ºå æ¯”ä¿¡æ¯
                    details_text += f"ğŸ“Š æ¥­ç¸¾å æ¯” / Performance Ratio:\n"
                    details_text += f"   {amount_ratio:.2f}%\n\n"
                    
                    details_text += f"ğŸ“Š å–®æ“šæ•¸å æ¯” / Transaction Ratio:\n"
                    details_text += f"   {receipt_ratio:.2f}%\n\n"
                    
                    print(f"ğŸ“Š æ´»å‹•æé†’ - ä½¿ç”¨èˆŠçš„åˆ†æçµæœå­—æ®µé¡¯ç¤ºæ´»å‹• {activity.get('id')} çš„åˆ†æçµæœ")
                else:
                    details_text += f"   âš ï¸ éœ€è¦åˆ†æè¨ˆç®— / Requires analysis calculation\n"
                    details_text += f"   ğŸ’¡ è«‹åœ¨æ´»å‹•è¨˜éŒ„ç®¡ç†ä¸­é»æ“Šåˆ†ææŒ‰éˆ• / Click analyze in activity management\n\n"
                    
                    print(f"ğŸ“Š æ´»å‹•æé†’ - æ´»å‹• {activity.get('id')} æ²’æœ‰åˆ†æçµæœ")
            
            details_text += "ğŸ’¡ æç¤º / Note: é»æ“Šå…¶ä»–æ´»å‹•æŸ¥çœ‹è©³æƒ…\nClick other activities to view details"
            
            # æ’å…¥è©³æƒ…æ–‡æœ¬
            self.activity_alert_text.insert(tk.END, details_text, "details")
            self.activity_alert_text.config(state='disabled')
            
        except Exception as e:
            print(f"é¡¯ç¤ºæ´»å‹•è©³æƒ…å¤±æ•—: {e}")
    
    def on_activity_hover_enter(self, tag):
        """æ´»å‹•é …ç›®æ‡¸åœé€²å…¥æ•ˆæœ"""
        try:
            self.activity_alert_text.tag_configure(tag, underline=True, foreground='#e74c3c')
        except Exception as e:
            print(f"æ‡¸åœé€²å…¥æ•ˆæœå¤±æ•—: {e}")
    
    def on_activity_hover_leave(self, tag):
        """æ´»å‹•é …ç›®æ‡¸åœé›¢é–‹æ•ˆæœ"""
        try:
            self.activity_alert_text.tag_configure(tag, underline=False, foreground='#3498db')
        except Exception as e:
            print(f"æ‡¸åœé›¢é–‹æ•ˆæœå¤±æ•—: {e}")
    
    def export_analysis_report(self, report_content):
        """å°å‡ºåˆ†æå ±å‘Šåˆ°æ–‡ä»¶"""
        try:
            from tkinter import filedialog
            import datetime
            
            # ç”Ÿæˆé»˜èªæ–‡ä»¶å
            timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
            default_filename = f"activity_analysis_report_{timestamp}.txt"
            
            # é¸æ“‡ä¿å­˜ä½ç½®
            file_path = filedialog.asksaveasfilename(
                defaultextension=".txt",
                filetypes=[
                    ("Text files", "*.txt"),
                    ("All files", "*.*")
                ],
                initialname=default_filename,
                title="ä¿å­˜åˆ†æå ±å‘Š / Save Analysis Report"
            )
            
            if file_path:
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(report_content)
                
                tk.messagebox.showinfo(
                    "æˆåŠŸ / Success", 
                    f"å ±å‘Šå·²æˆåŠŸå°å‡ºåˆ°:\nReport exported successfully to:\n{file_path}"
                )
        except Exception as e:
            tk.messagebox.showerror(
                "éŒ¯èª¤ / Error", 
                f"å°å‡ºå ±å‘Šå¤±æ•—:\nFailed to export report:\n{str(e)}"
            )
    
    def configure_analysis_text_styles(self, text_widget):
        """é…ç½®åˆ†æå ±å‘Šæ–‡æœ¬æ¨£å¼"""
        try:
            # æ¨™é¡Œæ¨£å¼
            text_widget.tag_configure("header", 
                                    font=('Microsoft YaHei UI', 12, 'bold'),
                                    foreground='#2c3e50')
            
            # ä¿¡æ¯æ¨£å¼
            text_widget.tag_configure("info", 
                                    font=('Arial', 10),
                                    foreground='#34495e')
            
            # æ¢ä»¶æ¨£å¼
            text_widget.tag_configure("condition", 
                                    font=('Arial', 10),
                                    foreground='#7f8c8d')
            
            # çµæœæ¨™é¡Œæ¨£å¼
            text_widget.tag_configure("result_header", 
                                    font=('Microsoft YaHei UI', 11, 'bold'),
                                    foreground='#27ae60')
            
            # æ•¸æ“šæ¨£å¼
            text_widget.tag_configure("data", 
                                    font=('Consolas', 10, 'bold'),
                                    foreground='#3498db')
            
            # åˆ†éš”ç·šæ¨£å¼
            text_widget.tag_configure("separator", 
                                    font=('Arial', 9),
                                    foreground='#95a5a6')
            
            # æˆåŠŸæ¨£å¼
            text_widget.tag_configure("success", 
                                    font=('Arial', 10, 'bold'),
                                    foreground='#27ae60')
            
            # è­¦å‘Šæ¨£å¼
            text_widget.tag_configure("warning", 
                                    font=('Arial', 10, 'bold'),
                                    foreground='#f39c12')
            
            # éŒ¯èª¤æ¨£å¼
            text_widget.tag_configure("error", 
                                    font=('Arial', 10, 'bold'),
                                    foreground='#e74c3c')
            
        except Exception as e:
            print(f"é…ç½®åˆ†ææ–‡æœ¬æ¨£å¼å¤±æ•—: {e}")
    
    def get_activity_performance_summary(self, activity):
        """ç²å–æ´»å‹•æ¥­ç¸¾æ‘˜è¦å’Œå æ¯”"""
        try:
            # æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“šåº«é€£æ¥
            if not hasattr(self, 'db_manager') or not self.db_manager.connection:
                return None
            
            # ç²å–æ´»å‹•ä¿¡æ¯
            date_from = activity.get('date_from', '')
            date_to = activity.get('date_to', '')
            outlets = activity.get('outlets', [])
            products = activity.get('products', [])
            payment_methods = activity.get('payment_methods', [])
            
            if not date_from or not date_to:
                return None
            
            # ç²å–æ´»å‹•æœŸé–“çš„ç¸½æ¥­ç¸¾ï¼ˆæ‰€æœ‰é–€å¸‚ã€æ‰€æœ‰ç”¢å“ã€æ‰€æœ‰æ”¯ä»˜æ–¹å¼ï¼‰
            total_data = self.db_manager.get_sales_data(
                date_from=date_from, date_to=date_to,
                outlet_filters=[],  # ä¸é™åˆ¶é–€å¸‚
                product_filters=[], # ä¸é™åˆ¶ç”¢å“
                weekday_filters=activity.get('weekdays', []),
                use_excel_cache=True
            )
            
            if not total_data:
                return None
            
            # è¨ˆç®—ç¸½æ¥­ç¸¾
            total_amount = 0
            total_receipts = 0
            receipt_totals = {}
            
            for record in total_data:
                sales_no = record.get('sales_no', '')
                store_name = record.get('store_name', '')
                receipt_key = f"{store_name}-{sales_no}"
                
                # è¨ˆç®—æ¥­ç¸¾
                sub_total = float(record.get('sub_total', 0))
                pro_disc_amt = float(record.get('pro_disc_amt', 0))
                svc_amt = float(record.get('svc_amt', 0))
                tax_amt = float(record.get('tax_amt', 0))
                take_away_item = str(record.get('take_away_item', 'N'))
                
                if self.db_manager.current_database == "sushi_gogo_pos_live":
                    net_amount = sub_total - pro_disc_amt + svc_amt - tax_amt
                else:
                    if take_away_item == 'Y':
                        net_amount = sub_total - pro_disc_amt + svc_amt - tax_amt
                    else:
                        net_amount = sub_total - pro_disc_amt + svc_amt
                
                if receipt_key not in receipt_totals:
                    receipt_totals[receipt_key] = 0.0
                receipt_totals[receipt_key] += net_amount
            
            total_amount = sum(receipt_totals.values())
            total_receipts = len(receipt_totals)
            
            # ç²å–æ´»å‹•ç‰¹å®šçš„æ¥­ç¸¾ï¼ˆç¯©é¸é–€å¸‚ã€ç”¢å“ã€æ”¯ä»˜æ–¹å¼ï¼‰
            activity_data = self.db_manager.get_sales_data(
                date_from=date_from, date_to=date_to,
                outlet_filters=outlets,
                product_filters=products,
                weekday_filters=activity.get('weekdays', []),
                use_excel_cache=True
            )
            
            if not activity_data:
                return {
                    'total_amount': 0,
                    'total_receipts': 0,
                    'amount_ratio': 0,
                    'receipt_ratio': 0
                }
            
            # å¦‚æœæœ‰æ”¯ä»˜æ–¹å¼ç¯©é¸ï¼Œéœ€è¦é€²ä¸€æ­¥ç¯©é¸
            if payment_methods:
                # é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›æ‡‰è©²æŸ¥è©¢æ”¯ä»˜æ–¹å¼è¡¨
                activity_amount = total_amount * 0.1  # å‡è¨­æ´»å‹•å 10%ï¼ˆå¯¦éš›éœ€è¦æŸ¥è©¢ï¼‰
                activity_receipts = int(total_receipts * 0.1)
            else:
                # è¨ˆç®—æ´»å‹•æ¥­ç¸¾
                activity_amount = 0
                activity_receipts = 0
                activity_receipt_totals = {}
                
                for record in activity_data:
                    sales_no = record.get('sales_no', '')
                    store_name = record.get('store_name', '')
                    receipt_key = f"{store_name}-{sales_no}"
                    
                    # è¨ˆç®—æ¥­ç¸¾
                    sub_total = float(record.get('sub_total', 0))
                    pro_disc_amt = float(record.get('pro_disc_amt', 0))
                    svc_amt = float(record.get('svc_amt', 0))
                    tax_amt = float(record.get('tax_amt', 0))
                    take_away_item = str(record.get('take_away_item', 'N'))
                    
                    if self.db_manager.current_database == "sushi_gogo_pos_live":
                        net_amount = sub_total - pro_disc_amt + svc_amt - tax_amt
                    else:
                        if take_away_item == 'Y':
                            net_amount = sub_total - pro_disc_amt + svc_amt - tax_amt
                        else:
                            net_amount = sub_total - pro_disc_amt + svc_amt
                    
                    if receipt_key not in activity_receipt_totals:
                        activity_receipt_totals[receipt_key] = 0.0
                    activity_receipt_totals[receipt_key] += net_amount
                
                activity_amount = sum(activity_receipt_totals.values())
                activity_receipts = len(activity_receipt_totals)
            
            # è¨ˆç®—å æ¯”
            amount_ratio = (activity_amount / total_amount * 100) if total_amount > 0 else 0
            receipt_ratio = (activity_receipts / total_receipts * 100) if total_receipts > 0 else 0
            
            return {
                'total_amount': activity_amount,
                'total_receipts': activity_receipts,
                'amount_ratio': amount_ratio,
                'receipt_ratio': receipt_ratio
            }
            
        except Exception as e:
            print(f"è¨ˆç®—æ´»å‹•æ¥­ç¸¾æ‘˜è¦å¤±æ•—: {e}")
            return None
    
    # ==================== å®æ—¶æœç´¢æ–¹æ³• ====================
    
    def highlight_search_results(self, tree_widget, search_term):
        """é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ"""
        try:
            if not search_term:
                return
            
            # æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            for item in tree_widget.get_children():
                tree_widget.item(item, tags=())
            
            # ä¸ºåŒ¹é…çš„è¡Œæ·»åŠ é«˜äº®æ ‡ç­¾
            for item in tree_widget.get_children():
                item_values = tree_widget.item(item, 'values')
                item_text = ' '.join([str(val) for val in item_values if val is not None])
                
                if search_term.lower() in item_text.lower():
                    tree_widget.item(item, tags=('highlight',))
            
            # é…ç½®é«˜äº®æ ·å¼
            tree_widget.tag_configure('highlight', background='#FFE4B5', foreground='#000000')
            
        except Exception as e:
            print(f"é«˜äº®æ˜¾ç¤ºå‡ºé”™: {e}")
    
    def filter_and_display_data(self, tree_widget, data, search_term, status_label):
        """é€šç”¨çš„æ•°æ®è¿‡æ»¤å’Œæ˜¾ç¤ºæ–¹æ³•"""
        try:
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in tree_widget.get_children():
                tree_widget.delete(item)
            
            if not data:
                return
            
            # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
            if not search_term:
                filtered_data = data
            else:
                # æ‰§è¡Œæœç´¢è¿‡æ»¤
                filtered_data = []
                for row in data:
                    row_text = ' '.join([str(cell) for cell in row if cell is not None])
                    if search_term.lower() in row_text.lower():
                        filtered_data.append(row)
            
            # æ˜¾ç¤ºè¿‡æ»¤åçš„æ•°æ®
            for row in filtered_data:
                tree_widget.insert("", "end", values=row)
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            if search_term:
                self.highlight_search_results(tree_widget, search_term)
            
            # æ›´æ–°çŠ¶æ€
            if status_label:
                total_count = len(data)
                filtered_count = len(filtered_data)
                if search_term:
                    status_label.config(
                        text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                        fg='green' if filtered_count > 0 else 'red'
                    )
                else:
                    status_label.config(text="", fg='blue')
            
        except Exception as e:
            print(f"è¿‡æ»¤æ˜¾ç¤ºæ•°æ®å‡ºé”™: {e}")
            if status_label:
                status_label.config(text=f"æ˜¾ç¤ºå‡ºé”™: {e}", fg='red')
    
    def realtime_search_product_overview(self):
        """å®æ—¶æœç´¢äº§å“æ€»è§ˆæ•°æ®"""
        try:
            search_term = self.product_overview_search_entry.get().strip()
            if not hasattr(self, 'product_overview_data') or not self.product_overview_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.product_overview_tree.get_children():
                self.product_overview_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_product_overview()
                self.product_overview_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.product_overview_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([
                    str(row.get('æ—¥æœŸ', '')),
                    str(row.get('æœˆä»½', '')),
                    str(row.get('é—¨å¸‚', '')),
                    str(row.get('äº§å“åç§°', '')),
                    str(row.get('ç±»åˆ«', ''))
                ])
                
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.product_overview_data
            self.product_overview_data = filtered_data
            self.display_product_overview()
            self.product_overview_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.product_overview_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.product_overview_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢äº§å“æ€»è§ˆæ•°æ®å‡ºé”™: {e}")
            self.product_overview_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_period_product(self):
        """å®æ—¶æœç´¢æœŸé—´äº§å“æ•°æ®"""
        try:
            search_term = self.period_product_search_entry.get().strip()
            if not hasattr(self, 'period_product_overview_data') or not self.period_product_overview_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.period_product_tree.get_children():
                self.period_product_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_period_product_overview()
                self.period_product_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.period_product_overview_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([
                    str(row.get('æœŸé—´', '')),
                    str(row.get('äº§å“åç§°', '')),
                    str(row.get('ç±»åˆ«', ''))
                ])
                
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.period_product_overview_data
            self.period_product_overview_data = filtered_data
            self.display_period_product_overview()
            self.period_product_overview_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.period_product_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.period_product_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢æœŸé—´äº§å“æ•°æ®å‡ºé”™: {e}")
            self.period_product_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_log(self):
        """å®æ—¶æœç´¢æ—¥å¿—ä¿¡æ¯"""
        try:
            search_term = self.log_search_entry.get().strip()
            
            # è·å–æ‰€æœ‰æ—¥å¿—å†…å®¹
            all_content = self.info_text.get(1.0, tk.END)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰å†…å®¹
                self.log_search_status.config(text="", fg='blue')
                return
            
            # æœç´¢åŒ¹é…çš„è¡Œ
            lines = all_content.split('\n')
            matching_lines = []
            
            for line in lines:
                if search_term.lower() in line.lower():
                    matching_lines.append(line)
            
            # æ›´æ–°çŠ¶æ€
            total_lines = len([line for line in lines if line.strip()])
            matching_count = len(matching_lines)
            
            if matching_count > 0:
                self.log_search_status.config(
                    text=f"æ‰¾åˆ° {matching_count}/{total_lines} è¡ŒåŒ¹é…", 
                    fg='green'
                )
                
                # é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„è¡Œ
                self.info_text.tag_remove("search_highlight", 1.0, tk.END)
                
                # é‡æ–°æœç´¢å¹¶é«˜äº®
                start = 1.0
                while True:
                    pos = self.info_text.search(search_term, start, tk.END, nocase=True)
                    if not pos:
                        break
                    end = f"{pos}+{len(search_term)}c"
                    self.info_text.tag_add("search_highlight", pos, end)
                    start = end
                
                # é…ç½®é«˜äº®æ ·å¼
                self.info_text.tag_configure("search_highlight", background="yellow", foreground="black")
                
            else:
                self.log_search_status.config(text="æœªæ‰¾åˆ°åŒ¹é…å†…å®¹", fg='red')
                self.info_text.tag_remove("search_highlight", 1.0, tk.END)
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢æ—¥å¿—å‡ºé”™: {e}")
            self.log_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_sales(self):
        """å®æ—¶æœç´¢é”€å”®æ•°æ®"""
        try:
            search_term = self.sales_search_entry.get().strip()
            if not hasattr(self, 'sales_data') or not self.sales_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.sales_tree.get_children():
                self.sales_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_sales_data()
                self.sales_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for data in self.sales_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([
                    str(data.get('store_name', '')),
                    str(data.get('sales_no', '')),
                    str(data.get('item_name', '')),
                    str(data.get('payment_methods', '')),
                    str(data.get('category_code', '')),
                    str(data.get('disc_name', '')),
                    str(data.get('c_date', ''))
                ])
                
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(data)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.sales_data
            self.sales_data = filtered_data
            self.display_sales_data()
            self.sales_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.sales_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.sales_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢é”€å”®æ•°æ®å‡ºé”™: {e}")
            self.sales_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_payment(self):
        """å®æ—¶æœç´¢æ”¯ä»˜æ•°æ®"""
        try:
            search_term = self.payment_search_entry.get().strip()
            if not hasattr(self, 'payment_data') or not self.payment_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.payment_tree.get_children():
                self.payment_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_payment_analysis()
                self.payment_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.payment_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([str(cell) for cell in row if cell is not None])
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.payment_data
            self.payment_data = filtered_data
            self.display_payment_analysis()
            self.payment_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.payment_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.payment_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢æ”¯ä»˜æ•°æ®å‡ºé”™: {e}")
            self.payment_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_discount(self):
        """å®æ—¶æœç´¢æŠ˜æ‰£æ•°æ®"""
        try:
            search_term = self.discount_search_entry.get().strip()
            if not hasattr(self, 'discount_data') or not self.discount_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.discount_tree.get_children():
                self.discount_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_discount_analysis()
                self.discount_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for data in self.discount_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([
                    str(data.get('é—¨å¸‚', '')),
                    str(data.get('æœˆä»½', '')),
                    str(data.get('æŠ˜æ‰£åç§°', '')),
                    str(data.get('æŠ˜æ‰£é‡‘é¢', '')),
                    str(data.get('æŠ˜æ‰£å æ¯”(%)', '')),
                    str(data.get('æŠ˜æ‰£æ¬¡æ•°', '')),
                    str(data.get('æŠ˜æ‰£æ¬¡æ•°å æ¯”(%)', '')),
                    str(data.get('å…¨é–€å¸‚æŠ˜æ‰£ç¸½æ¬¡æ•¸', ''))
                ])
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(data)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.discount_data
            self.discount_data = filtered_data
            self.display_discount_analysis()
            self.discount_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.discount_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.discount_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢æŠ˜æ‰£æ•°æ®å‡ºé”™: {e}")
            self.discount_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_monthly(self):
        """å®æ—¶æœç´¢æœˆåº¦æ•°æ®"""
        try:
            search_term = self.monthly_search_entry.get().strip()
            if not hasattr(self, 'monthly_data') or not self.monthly_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.monthly_tree.get_children():
                self.monthly_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_monthly_summary()
                self.monthly_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.monthly_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([str(cell) for cell in row if cell is not None])
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.monthly_data
            self.monthly_data = filtered_data
            self.display_monthly_summary()
            self.monthly_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.monthly_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.monthly_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢æœˆåº¦æ•°æ®å‡ºé”™: {e}")
            self.monthly_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_weekly_product(self):
        """å®æ—¶æœç´¢å‘¨æœŸäº§å“æ•°æ®"""
        try:
            search_term = self.weekly_product_search_entry.get().strip()
            if not hasattr(self, 'weekly_product_data') or not self.weekly_product_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.weekly_product_tree.get_children():
                self.weekly_product_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_weekly_product_data()
                self.weekly_product_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.weekly_product_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([str(cell) for cell in row if cell is not None])
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.weekly_product_data
            self.weekly_product_data = filtered_data
            self.display_weekly_product_data()
            self.weekly_product_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.weekly_product_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.weekly_product_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢å‘¨æœŸäº§å“æ•°æ®å‡ºé”™: {e}")
            self.weekly_product_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_daily_analysis(self):
        """å®æ—¶æœç´¢æ—¥-äº§å“åˆ†ææ•°æ®"""
        try:
            search_term = self.daily_analysis_search_entry.get().strip()
            if not hasattr(self, 'sales_tc_analysis_data') or not self.sales_tc_analysis_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.sales_tc_analysis_tree.get_children():
                self.sales_tc_analysis_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_sales_tc_analysis()
                self.daily_analysis_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.sales_tc_analysis_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([str(cell) for cell in row if cell is not None])
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.sales_tc_analysis_data
            self.sales_tc_analysis_data = filtered_data
            self.display_sales_tc_analysis()
            self.sales_tc_analysis_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.sales_tc_analysis_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.daily_analysis_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢æ—¥-äº§å“åˆ†ææ•°æ®å‡ºé”™: {e}")
            self.daily_analysis_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_monthly_analysis(self):
        """å®æ—¶æœç´¢æœˆ-äº§å“åˆ†ææ•°æ®"""
        try:
            search_term = self.monthly_analysis_search_entry.get().strip()
            if not hasattr(self, 'sales_tc_monthly_data') or not self.sales_tc_monthly_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.sales_tc_monthly_tree.get_children():
                self.sales_tc_monthly_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_sales_tc_monthly()
                self.monthly_analysis_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.sales_tc_monthly_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([str(cell) for cell in row if cell is not None])
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.sales_tc_monthly_data
            self.sales_tc_monthly_data = filtered_data
            self.display_sales_tc_monthly()
            self.sales_tc_monthly_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.sales_tc_monthly_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.monthly_analysis_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢æœˆ-äº§å“åˆ†ææ•°æ®å‡ºé”™: {e}")
            self.monthly_analysis_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_association(self):
        """å®æ—¶æœç´¢äº§å“å…³è”åˆ†ææ•°æ®"""
        try:
            search_term = self.association_search_entry.get().strip()
            if not hasattr(self, 'product_association_data') or not self.product_association_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.product_association_tree.get_children():
                self.product_association_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_product_association()
                self.association_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.product_association_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([str(cell) for cell in row if cell is not None])
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.product_association_data
            self.product_association_data = filtered_data
            self.display_product_association()
            self.product_association_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.product_association_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.association_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢äº§å“å…³è”åˆ†ææ•°æ®å‡ºé”™: {e}")
            self.association_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def realtime_search_category_analysis(self):
        """å®æ—¶æœç´¢ç±»åˆ«åˆ†ææ•°æ®"""
        try:
            search_term = self.category_analysis_search_entry.get().strip()
            if not hasattr(self, 'category_analysis_data') or not self.category_analysis_data:
                return
            
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.category_analysis_tree.get_children():
                self.category_analysis_tree.delete(item)
            
            if not search_term:
                # å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œè°ƒç”¨åŸå§‹æ˜¾ç¤ºæ–¹æ³•
                self.display_category_analysis()
                self.category_analysis_search_status.config(text="", fg='blue')
                return
            
            # æ‰§è¡Œæœç´¢è¿‡æ»¤
            filtered_data = []
            for row in self.category_analysis_data:
                # åœ¨æ‰€æœ‰å­—æ®µä¸­æœç´¢
                searchable_text = ' '.join([str(cell) for cell in row if cell is not None])
                if search_term.lower() in searchable_text.lower():
                    filtered_data.append(row)
            
            # ä¸´æ—¶å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®å¹¶æ˜¾ç¤º
            original_data = self.category_analysis_data
            self.category_analysis_data = filtered_data
            self.display_category_analysis()
            self.category_analysis_data = original_data
            
            # é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ
            self.highlight_search_results(self.category_analysis_tree, search_term)
            
            # æ›´æ–°çŠ¶æ€
            total_count = len(original_data)
            filtered_count = len(filtered_data)
            self.category_analysis_search_status.config(
                text=f"æ‰¾åˆ° {filtered_count}/{total_count} æ¡è®°å½•", 
                fg='green' if filtered_count > 0 else 'red'
            )
            
        except Exception as e:
            print(f"å®æ—¶æœç´¢ç±»åˆ«åˆ†ææ•°æ®å‡ºé”™: {e}")
            self.category_analysis_search_status.config(text=f"æœç´¢å‡ºé”™: {e}", fg='red')
    
    def run(self):
        """è¿è¡ŒGUI"""
        self.root.mainloop()

def main():
    """ä¸»å‡½æ•°"""
    try:
        print("å¯åŠ¨POSæ•°æ®åˆ†æå·¥å…· - å¢å¼ºç‰ˆ...")
        app = POSAnalysisGUI()
        print("GUIåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹è¿è¡Œä¸»å¾ªç¯...")
        app.run()
    except Exception as e:
        print(f"ç¨‹åºè¿è¡Œå‡ºé”™: {e}")
        import traceback
        traceback.print_exc()
        input("æŒ‰å›è½¦é”®é€€å‡º...")

if __name__ == "__main__":
    main()
