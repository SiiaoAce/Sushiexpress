import os
import sys
import threading
import time
import re
import copy
import csv
import traceback
from datetime import datetime, timedelta
from collections import defaultdict
from dateutil.parser import parse
import customtkinter as ctk
from tkinter import filedialog, messagebox, simpledialog
from openpyxl import load_workbook, Workbook
from openpyxl.utils import get_column_letter
import codecs
import pandas as pd
from PIL import Image, ImageDraw, ImageFont
from openpyxl.cell.cell import MergedCell
import glob
import xlwings as xw
import tkinter.ttk as ttk
import tempfile
import uuid
import win32com.client
import base64
import pywintypes
import openpyxl
from openpyxl.styles import Alignment, Font, PatternFill, Border, Side
from calendar import monthcalendar

def normalize_supplier_name(name):
    return name.lower().replace(" ", "").replace("(", "").replace(")", "").replace(".", "").replace("_", "")

def get_week_of_month(dt):
    """è¨ˆç®—æ—¥æœŸåœ¨ç•¶æœˆæ˜¯ç¬¬å¹¾é€±ï¼ˆå¾1é–‹å§‹ï¼‰"""
    # ä½¿ç”¨æ›´ç°¡å–®çš„é‚è¼¯ï¼šç›´æ¥è¨ˆç®—æ—¥æœŸåœ¨ç•¶æœˆæ˜¯ç¬¬å¹¾é€±
    # 1-7æ—¥ç‚ºç¬¬1é€±ï¼Œ8-14æ—¥ç‚ºç¬¬2é€±ï¼Œä»¥æ­¤é¡æ¨
    week_number = (dt.day - 1) // 7 + 1
    return week_number

def find_supplier_file(supplier_name, files):
    norm_supplier = normalize_supplier_name(supplier_name)
    candidates = []
    for f in files:
        # åªè¦æª”åæœ‰ä¾›æ‡‰å•†åç¨±å°±ç®—
        norm_f = normalize_supplier_name(os.path.splitext(f)[0])
        if norm_supplier in norm_f:
            candidates.append(f)
    if len(candidates) == 1:
        return candidates[0]
    elif len(candidates) > 1:
        for f in candidates:
            if f.startswith(supplier_name):
                return f
        return candidates[0]
    return None

# ======== èµ„æºè·¯å¾„å¤„ç† ========
def resource_path(relative_path):
    """è·å–èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„"""
    try:
        base_path = sys._MEIPASS
    except AttributeError:
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)

# ========== å…¨å±€é…ç½® ==========
LOGO_PATH = resource_path("SELOGO22 - 01.png")
PASSWORD = "OPS123"
VERSION = "6.6.0"
DEVELOPER = "OPS - Voon Kee"

# ä¸»é¢˜é…ç½®
ctk.set_appearance_mode("dark")
ctk.set_default_color_theme("blue")

# é¢œè‰²å®šä¹‰
DARK_BG = "#0f172a"
DARK_PANEL = "#1e293b"
ACCENT_BLUE = "#3b82f6"
BTN_HOVER = "#60a5fa"
ACCENT_GREEN = "#10b981"
ACCENT_RED = "#ef4444"
ACCENT_PURPLE = "#8b5cf6"
ENTRY_BG = "#334155"
TEXT_COLOR = "#e2e8f0"
PANEL_BG = "#1e293b"
TEXTBOX_BG = "#0f172a"

# å­—ä½“é…ç½®
FONT_TITLE = ("Microsoft JhengHei", 24, "bold")
FONT_BIGBTN = ("Microsoft JhengHei", 16, "bold")
FONT_MID = ("Microsoft JhengHei", 14)
FONT_SUB = ("Microsoft JhengHei", 12)
FONT_ZH = ("Microsoft JhengHei", 12)
FONT_EN = ("Segoe UI", 11, "italic")
FONT_LOG = ("Consolas", 14)

# ========== å¤šè¯­è¨€æ”¯æŒ ==========
def t(text):
    translations = {
        "mapping_not_available": "åˆ†åº—ä¾›åº”å•†å¯¹åº”æ•°æ®ä¸å¯ç”¨\nOutlet-supplier mapping not available",
        "log_not_available": "æ—¥å¿—æ•°æ®ä¸å¯ç”¨\nLog data not available",
        "info": "ä¿¡æ¯\nInformation",
        "processing": "è™•ç†ä¸­...\nProcessing...",
        "please_wait": "è«‹ç¨å€™...\nPlease wait...",
        "error": "éŒ¯èª¤\nError",
        "login": "ç³»çµ±ç™»éŒ„\nSystem Login",
        "password": "è¼¸å…¥å¯†ç¢¼...\nEnter password...",
        "login_btn": "ç™»å…¥\nLogin",
        "exit_confirm": "ç¢ºå®šè¦é€€å‡ºæ‡‰ç”¨ç¨‹åºå—ï¼Ÿ\nAre you sure you want to exit the application?",
        "incorrect_pw": "å¯†ç¢¼ä¸æ­£ç¢ºï¼Œè«‹é‡è©¦\nIncorrect password, please try again",
        "main_title": "Sushi Express è‡ªå‹•åŒ–å·¥å…·\nSushi Express Automation Tool",
        "select_function": "è«‹é¸æ“‡è¦åŸ·è¡Œçš„åŠŸèƒ½\nPlease select a function",
        "download_title": "Outlook è¨‚å–®ä¸‹è¼‰\nOutlook Order Download",
        "download_desc": "ä¸‹è¼‰æœ¬é€±çš„ Weekly Order é™„ä»¶\nDownload weekly order attachments",
        "browse": "ç€è¦½...\nBrowse...",
        "start_download": "é–‹å§‹ä¸‹è¼‰\nStart Download",
        "back_to_menu": "è¿”å›ä¸»èœå–®\nBack to Main Menu",
        "checklist_title": "Weekly Order æª¢æŸ¥è¡¨\nWeekly Order Checklist",
        "checklist_desc": "è«‹é¸æ“‡åŒ…å«ä¾›æ‡‰å•†è¨‚å–®çš„è³‡æ–™å¤¾\nSelect folder with supplier orders",
        "run_check": "åŸ·è¡Œæª¢æŸ¥\nRun Check",
        "automation_title": "è¨‚å–®è‡ªå‹•æ•´åˆ\nOrder Automation",
        "automation_desc": "è«‹é¸æ“‡ä¸‰å€‹å¿…è¦çš„è³‡æ–™å¤¾\nSelect required folders",
        "source_folder": "ä¾†æºè³‡æ–™å¤¾ (Weekly Orders)\nSource Folder (Weekly Orders)",
        "supplier_folder": "ä¾›æ‡‰å•†è³‡æ–™å¤¾ (Supplier)\nSupplier Folder",
        "outlet_folder": "åˆ†åº—è³‡æ–™å¤¾ (Outlet)\nOutlet Folder",
        "start_automation": "é–‹å§‹æ•´åˆæª”æ¡ˆ\nStart Automation",
        "processing_orders": "è™•ç†è¨‚å–®\nProcessing Orders",
        "outlet_suppliers": "åˆ†åº—ä¾›æ‡‰å•†å°æ‡‰\nOutlet-Supplier Mapping",
        "exit_system": "é€€å‡ºç³»çµ±\nExit System",
        "select_account": "é¸æ“‡ Outlook å¸³è™Ÿ\nSelect Outlook Account",
        "enter_index": "è«‹è¼¸å…¥åºè™Ÿï¼š\nPlease enter index:",
        "download_summary": "ä¸‹è¼‰æ‘˜è¦\nDownload Summary",
        "auto_download": "è‡ªå‹•ä¸‹è¼‰\nAuto Downloaded",
        "skipped": "è·³é\nSkipped",
        "saved_to": "ä¿å­˜åˆ°\nSaved to",
        "check_results": "æª¢æŸ¥çµæœ\nCheck Results",
        "success": "æˆåŠŸ\nSuccess",
        "warning": "è­¦å‘Š\nWarning",
        "folder_warning": "è«‹å…ˆé¸æ“‡æ‰€æœ‰å¿…è¦çš„è³‡æ–™å¤¾\nPlease select all required folders",
        "close": "é—œé–‰\nClose",
        "order_processing": "è¨‚å–®è™•ç†é€²åº¦\nOrder Processing Progress",
        "outlet_supplier_mapping": "åˆ†åº—-ä¾›æ‡‰å•†å°æ‡‰é—œä¿‚\nOutlet-Supplier Mapping",
        "select_folder": "é¸æ“‡æ–‡ä»¶å¤¾\nSelect Folder",
        "view_mapping": "æŸ¥çœ‹åˆ†åº—ä¾›æ‡‰å•†å°æ‡‰\nView Outlet-Supplier Mapping",
        "view_log": "æŸ¥çœ‹å®Œæ•´æ—¥èªŒ\nView Full Log",
        "supplier_files": "å·²è™•ç†çš„ä¾›æ‡‰å•†æ–‡ä»¶\nProcessed Supplier Files",
        "outlet_files": "å·²è™•ç†çš„åˆ†åº—æ–‡ä»¶\nProcessed Outlet Files",
        "outlet_orders": "åˆ†åº—è¨‚è³¼æƒ…æ³\nOutlet Orders",
        "supplier_orders": "ä¾›æ‡‰å•†è¨‚è³¼æƒ…æ³\nSupplier Orders",
        "send_emails": "ç™¼é€éƒµä»¶\nSend Emails",
        "operation_supplies": "ç‡Ÿé‹ç”¨å“\nOperation Supplies",
    }
    return translations.get(text, text)

def get_contrast_color(bg_color):
    # ç°¡å–®äº®è‰²/æš—è‰²å°æ¯”
    if isinstance(bg_color, str) and bg_color.startswith('#'):
        r = int(bg_color[1:3], 16)
        g = int(bg_color[3:5], 16)
        b = int(bg_color[5:7], 16)
        luminance = (0.299*r + 0.587*g + 0.114*b)
        return '#000000' if luminance > 186 else '#ffffff'
    return '#ffffff'

# ========== å·¥å…·å‡½æ•° ==========
def load_image(path, max_size=(400, 130)):
    """å®‰å…¨åŠ è½½å›¾åƒ"""
    try:
        if not os.path.exists(path):
            img = Image.new('RGB', max_size, color=DARK_BG[:3])
            draw = ImageDraw.Draw(img)
            font = ImageFont.truetype("arial.ttf", 24)
            draw.text((10,10), "Logo Missing", fill="white", font=font)
        else:
            img = Image.open(path)
        img.thumbnail(max_size, Image.LANCZOS)
        return ctk.CTkImage(img, size=img.size)
    except Exception as e:
        print(f"Error loading image: {e}")
        return None

# ========== è‡ªå®šä¹‰UIç»„ä»¶ ==========
class GlowButton(ctk.CTkButton):
    """å‘å…‰æ•ˆæœæŒ‰é’®ï¼ˆç¾åŒ–ç‰ˆï¼‰"""
    def __init__(self, master, text=None, glow_color=ACCENT_BLUE, **kwargs):
        super().__init__(master, text=text, **kwargs)
        self._glow_color = glow_color
        self._setup_style()
        self._bind_events()

    def _setup_style(self):
        self.configure(
            border_width=0,
            fg_color=self._glow_color,
            hover_color=self._adjust_color(self._glow_color, 40),
            text_color=get_contrast_color(self._glow_color),
            corner_radius=22,  # æ›´åœ†è§’
            font=("Microsoft JhengHei", 20, "bold"),  # æ›´å¤§æ›´ç²—
            height=70,  # æ›´é«˜
            width=340,  # æ›´å®½
            anchor="center"
        )

    def _bind_events(self):
        self.bind("<Enter>", self._on_enter)
        self.bind("<Leave>", self._on_leave)

    def _on_enter(self, event=None):
        self.configure(border_width=4, border_color=self._adjust_color(self._glow_color, 60), fg_color=self._adjust_color(self._glow_color, 20))

    def _on_leave(self, event=None):
        self.configure(border_width=0, fg_color=self._glow_color)
    
    @staticmethod
    def _adjust_color(color, amount):
        if isinstance(color, tuple) and len(color) >= 3:
            r, g, b = color[:3]
            adjusted = tuple(min(255, max(0, x + amount)) for x in (r, g, b))
            if len(color) == 4:
                return adjusted + (color[3],)
            return adjusted
        else:
            color = color.lstrip('#')
            rgb = tuple(int(color[i:i+2], 16) for i in (0, 2, 4))
            adjusted = tuple(min(255, max(0, x + amount)) for x in rgb)
            return f"#{adjusted[0]:02x}{adjusted[1]:02x}{adjusted[2]:02x}"

class ProgressPopup(ctk.CTkToplevel):
    """è¿›åº¦æ˜¾ç¤ºå¼¹çª—"""
    def __init__(self, parent, title, start_date=None, end_date=None, outlet_count=None):
        super().__init__(parent)
        self.title(title)
        self.geometry("900x700")
        self.transient(parent)
        self.grab_set()
        self.parent = parent
        self.configure(fg_color=DARK_BG)
        self.log_text = ctk.CTkTextbox(
            self,
            wrap="word",
            font=FONT_LOG,
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            corner_radius=10
        )
        self.log_text.pack(fill="both", expand=True, padx=20, pady=20)
        self.log_text.configure(state="normal")
        if start_date and end_date:
            self.log_text.insert("end", f"ğŸ“… æŠ“å–æ—¥æœŸç¯„åœ: {start_date} ~ {end_date}\n")
        self.log_text.configure(state="disabled")
        self.outlet_count_label = ctk.CTkLabel(
            self,
            text=f"ğŸª å·²ä¸‹è¼‰åˆ†åº—æ•¸é‡: {outlet_count if outlet_count is not None else 0} é–“",
            font=("Microsoft JhengHei", 18, "bold"),
            text_color="#10b981"
        )
        self.outlet_count_label.pack(pady=(0, 10))
        close_btn = GlowButton(
            self,
            text=t("close"),
            command=self.destroy_popup,
            width=120,
            height=40
        )
        close_btn.pack(pady=10)
    def update_outlet_count(self, count):
        if self.outlet_count_label:
            self.outlet_count_label.configure(text=f"ğŸª å·²ä¸‹è¼‰åˆ†åº—æ•¸é‡: {count} é–“")
    def destroy_popup(self):
        self.destroy()
        self.parent.progress_popup = None
    def log(self, message):
        self.log_text.configure(state="normal")
        self.log_text.insert("end", message)
        self.log_text.see("end")
        self.log_text.configure(state="disabled")
        # å¼·åˆ¶æ›´æ–°UI
        self.update()

class MappingPopup(ctk.CTkToplevel):
    """åˆ†åº—-ä¾›åº”å•†æ˜ å°„æ˜¾ç¤º"""
    def __init__(self, parent, title):
        super().__init__(parent)
        self.title(title)
        self.geometry("900x700")
        self.transient(parent)
        self.grab_set()
        self.parent = parent
        self.configure(fg_color=DARK_BG)
        
        self.mapping_text = ctk.CTkTextbox(
            self,
            wrap="word",
            font=FONT_LOG,
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            corner_radius=10
        )
        self.mapping_text.pack(fill="both", expand=True, padx=20, pady=20)
        self.mapping_text.configure(state="disabled")
        
        close_btn = GlowButton(
            self,
            text=t("close"),
            command=self.destroy_popup,
            width=120,
            height=40
        )
        close_btn.pack(pady=10)
    
    def destroy_popup(self):
        self.destroy()
        self.parent.mapping_popup = None
    
    def update_mapping(self, mapping):
        self.mapping_text.configure(state="normal")
        self.mapping_text.delete("1.0", "end")
        self.mapping_text.insert("1.0", mapping)
        self.mapping_text.configure(state="disabled")

class ScrollableMessageBox(ctk.CTkToplevel):
    """å¯æ»šåŠ¨æ¶ˆæ¯æ¡†"""
    def __init__(self, parent, title, message):
        super().__init__(parent)
        self.title(title)
        self.geometry("900x700")
        self.transient(parent)
        self.grab_set()
        self.configure(fg_color=DARK_BG)
        
        self.text_box = ctk.CTkTextbox(
            self,
            wrap="word",
            font=FONT_LOG,
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            corner_radius=10
        )
        self.text_box.pack(fill="both", expand=True, padx=20, pady=20)
        self.text_box.insert("1.0", message)
        self.text_box.configure(state="disabled")
        
        close_btn = GlowButton(
            self,
            text=t("close"),
            command=self.destroy,
            width=120,
            height=40
        )
        close_btn.pack(pady=10)

class EmailConfirmationDialog(ctk.CTkToplevel):
    """é‚®ä»¶å‘é€ç¡®è®¤å¯¹è¯æ¡†ï¼ˆåªé¡¯ç¤ºç´”æ–‡å­—ï¼Œä¿ç•™ç©ºè¡Œï¼‰"""
    def __init__(self, parent, mail_item, supplier_name, outlet_name, attachment_path, on_confirm):
        super().__init__(parent)
        self.title(f"ç¡®è®¤é‚®ä»¶ - {supplier_name}")
        self.geometry("800x700")
        self.transient(parent)
        self.grab_set()
        self.mail_item = mail_item
        self.on_confirm = on_confirm
        self.attachment_path = attachment_path
        self.configure(fg_color=DARK_BG)
        info_frame = ctk.CTkFrame(self, fg_color=DARK_PANEL, corner_radius=12)
        info_frame.pack(fill="x", padx=20, pady=10)
        ctk.CTkLabel(info_frame, text=f"æ”¶ä»¶äºº(To)/To: {mail_item.To}", font=FONT_MID).pack(anchor="w", padx=10, pady=5)
        ctk.CTkLabel(info_frame, text=f"æŠ„é€(CC)/CC: {mail_item.CC}", font=FONT_MID).pack(anchor="w", padx=10, pady=5)
        ctk.CTkLabel(info_frame, text=f"ä¸»é¢˜/Subject: {mail_item.Subject}", font=FONT_MID).pack(anchor="w", padx=10, pady=5)
        ctk.CTkLabel(info_frame, text=f"ä¾›åº”å•†/Supplier: {supplier_name}", font=FONT_MID).pack(anchor="w", padx=10, pady=5)
        ctk.CTkLabel(info_frame, text=f"åˆ†åº—/Outlet: {outlet_name}", font=FONT_MID).pack(anchor="w", padx=10, pady=5)
        if attachment_path:
            file_name = os.path.basename(attachment_path)
            ctk.CTkLabel(info_frame, text=f"é™„ä»¶/Attachment: {file_name}", font=FONT_MID).pack(anchor="w", padx=10, pady=5)
        body_frame = ctk.CTkFrame(self, fg_color=DARK_PANEL, corner_radius=12)
        body_frame.pack(fill="both", expand=True, padx=20, pady=10)
        ctk.CTkLabel(body_frame, text="é‚®ä»¶æ­£æ–‡/Email Body:", font=FONT_BIGBTN).pack(anchor="w", padx=10, pady=5)
        # åªé¡¯ç¤ºç´”æ–‡å­—ï¼Œä¿ç•™ç©ºè¡Œï¼Œé¿å…åå­—è¢«æ‹†è¡Œ
        import html
        raw_html = mail_item.HTMLBody or ""
        import re
        # 1. åªæŠŠçµæŸåˆ†è¡Œæ¨™ç±¤æ›æˆæ›è¡Œ
        text = re.sub(r'(<br\s*/?>|</div>|</p>|</li>|</tr>|</td>)', '\n', raw_html, flags=re.IGNORECASE)
        # 2. æŠŠé–‹å§‹æ¨™ç±¤ç›´æ¥ç§»é™¤ï¼ˆä¸æ›è¡Œï¼‰
        text = re.sub(r'(<div>|<p>|<li>|<tr>|<td>)', '', text, flags=re.IGNORECASE)
        # 3. ç§»é™¤å…¶ä»– HTML æ¨™ç±¤
        text = re.sub(r'<[^>]+>', '', text)
        # 4. decode HTML entity
        text = html.unescape(text)
        # 5. ç§»é™¤é–‹é ­/çµå°¾å¤šé¤˜ç©ºç™½
        text = text.strip()
        self.body_text = ctk.CTkTextbox(body_frame, wrap="word", height=300, font=FONT_MID)
        self.body_text.pack(fill="both", expand=True, padx=10, pady=5)
        self.body_text.insert("1.0", text)
        self.body_text.configure(state="disabled")
        btn_frame = ctk.CTkFrame(self, fg_color="transparent")
        btn_frame.pack(fill="x", padx=20, pady=10)
        ctk.CTkButton(
            btn_frame, 
            text="å‘é€é‚®ä»¶/Send Email", 
            command=self._send_email,
            fg_color=ACCENT_GREEN,
            hover_color=BTN_HOVER
        ).pack(side="right", padx=10)
        ctk.CTkButton(
            btn_frame, 
            text="å–æ¶ˆ/Cancel", 
            command=self.destroy
        ).pack(side="right", padx=10)
        ctk.CTkButton(
            btn_frame, 
            text="ç¼–è¾‘æ­£æ–‡/Edit Body", 
            command=self._edit_body,
            fg_color=ACCENT_BLUE,
            hover_color=BTN_HOVER
        ).pack(side="left", padx=10)
    def _edit_body(self):
        self.body_text.configure(state="normal")
    def _send_email(self):
        try:
            # 1. è¯»å–æ–‡æœ¬æ¡†å†…å®¹
            body = self.body_text.get("1.0", "end-1c")

            # 2. è®¡ç®—"æœˆ+å‘¨"è‹±æ–‡å­—ç¬¦ä¸²
            today = datetime.now()
            # è·å–å®Œæ•´è‹±æ–‡æœˆä»½åç§°ï¼Œå¦‚ "July"
            month_name = today.strftime("%B")
            # ä½¿ç”¨æ­£ç¢ºçš„é€±æ•¸è¨ˆç®—æ–¹æ³•
            week_of_month = get_week_of_month(today)
            # æ„é€  "July Week 3"
            month_week_str = f"{month_name} Week {week_of_month}"

            # 3. åœ¨æ¨¡æ¿ä¸­æ›¿æ¢å ä½ç¬¦
            body = body.replace("{week_no}", month_week_str)

            # 4. è½¬æˆ HTML å¹¶å‘é€
            html_body = body.replace("\n", "<br>")
            self.mail_item.HTMLBody = html_body
            self.mail_item.Send()
            self.on_confirm(True, "é‚®ä»¶å‘é€æˆåŠŸï¼")
        except Exception as e:
            self.on_confirm(False, f"å‘é€å¤±è´¥ï¼š{e}")
        finally:
            self.destroy()

class NavigationButton(ctk.CTkButton):
    """è‡ªå®šä¹‰å¯¼èˆªæŒ‰é’®ï¼Œæ”¯æŒé€‰ä¸­çŠ¶æ€"""
    def __init__(self, master, text, command, **kwargs):
        super().__init__(master, text=text, command=command, **kwargs)
        self.default_color = DARK_PANEL
        self.selected_color = ACCENT_BLUE
        self.hover_color = BTN_HOVER
        self.is_selected = False
        self.default_border_color = ACCENT_BLUE
        self.selected_border_color = ACCENT_GREEN
        self.configure(
            fg_color=self.default_color,
            hover_color=self.hover_color,
            text_color=get_contrast_color(self.default_color),
            border_width=2,
            border_color=self.default_border_color,
            corner_radius=10,
            font=FONT_BIGBTN,
            height=50,
            anchor="center"
        )
        self._bind_events()
    def _bind_events(self):
        self.bind("<Enter>", self._on_enter)
        self.bind("<Leave>", self._on_leave)
    def _on_enter(self, event=None):
        if not self.is_selected:
            self.configure(fg_color=self._adjust_color(self.default_color, 20))
    def _on_leave(self, event=None):
        if not self.is_selected:
            self.configure(fg_color=self.default_color)
    def select(self):
        self.is_selected = True
        self.configure(
            fg_color=self.selected_color,
            border_width=2,
            border_color=self.selected_border_color,
            text_color=get_contrast_color(self.selected_color)
        )
    def deselect(self):
        self.is_selected = False
        self.configure(
            fg_color=self.default_color,
            border_width=2,
            border_color=self.default_border_color,
            text_color=get_contrast_color(self.default_color)
        )
    @staticmethod
    def _adjust_color(color, amount):
        if isinstance(color, str) and color.startswith("#"):
            color = color.lstrip('#')
            rgb = tuple(int(color[i:i+2], 16) for i in (0, 2, 4))
            adjusted = tuple(min(255, max(0, x + amount)) for x in rgb)
            return f"#{adjusted[0]:02x}{adjusted[1]:02x}{adjusted[2]:02x}"
        return color

# ========== é€è´§æ—¥æœŸéªŒè¯å·¥å…· ==========
class DeliveryDateValidator:
    """é€è´§æ—¥æœŸéªŒè¯å·¥å…·"""
    
    DAYS_MAPPING = {
        'mon': 0, 'monday': 0, 'æ˜ŸæœŸä¸€': 0,
        'tue': 1, 'tuesday': 1, 'æ˜ŸæœŸäºŒ': 1,
        'wed': 2, 'wednesday': 2, 'æ˜ŸæœŸä¸‰': 2,
        'thu': 3, 'thursday': 3, 'æ˜ŸæœŸå››': 3,
        'fri': 4, 'friday': 4, 'æ˜ŸæœŸäº”': 4,
        'sat': 5, 'saturday': 5, 'æ˜ŸæœŸå…­': 5,
        'sun': 6, 'sunday': 6, 'æ˜ŸæœŸæ—¥': 6
    }

    def __init__(self, config_file=None):
        self.schedule = defaultdict(dict)
        if config_file:
            self.load_config(config_file)
    
    def load_config(self, config_file):
        """åŠ è½½é€è´§æ—¥æœŸé…ç½®"""
        try:
            with open(config_file, mode='r', encoding='utf-8-sig') as f:
                reader = csv.DictReader(f)
                for row in reader:
                    supplier = row['supplier'].strip().upper()
                    outlet = row['outlet_code'].strip().upper()
                    days = self.parse_delivery_days(row['delivery_days'])
                    
                    if outlet == "ALL":
                        self.schedule[supplier]['*'] = days
                    else:
                        self.schedule[supplier][outlet] = days
        except Exception as e:
            raise Exception(f"åŠ è½½é€è´§é…ç½®å¤±è´¥: {str(e)}")

    def parse_delivery_days(self, days_str):
        """è§£æé€è´§æ—¥æœŸå­—ç¬¦ä¸²"""
        days = set()
        for day in days_str.split(','):
            day = day.strip().lower()
            if day in self.DAYS_MAPPING:
                days.add(self.DAYS_MAPPING[day])
        return days

    def get_delivery_days(self, supplier, outlet_code):
        supplier = supplier.strip().upper()
        outlet_code = outlet_code.strip().upper()
        outlet_specific = self.schedule.get(supplier, {}).get(outlet_code)
        if outlet_specific is not None:
            return outlet_specific
        return self.schedule.get(supplier, {}).get('*', set())

    def validate_order(self, supplier, outlet_code, order_date, log_callback=None):
        supplier = supplier.strip().upper()
        outlet_code = outlet_code.strip().upper()
        delivery_days = self.get_delivery_days(supplier, outlet_code)
        
        if not delivery_days:
            return True
        
        try:
            if isinstance(order_date, (int, float)):
                order_date = datetime(1899, 12, 30) + timedelta(days=order_date)
            else:
                order_date = parse(str(order_date), fuzzy=True)
            
            order_weekday = order_date.weekday()
            
            if order_weekday not in delivery_days:
                day_name = ['Monday', 'Tuesday', 'Wednesday', 'Thursday',
                           'Friday', 'Saturday', 'Sunday'][order_weekday]
                if log_callback:
                    log_callback(
                        f"âŒ é€è´§æ—¥æœŸé”™è¯¯: {outlet_code} å‘ {supplier} ä¸‹å•\n"
                        f"  è®¢å•æ—¥æœŸ: {order_date.strftime('%Y-%m-%d')} ({day_name})\n"
                        f"  å…è®¸é€è´§æ—¥: {self.format_days(delivery_days)}"
                    )
                return False
            return True
        except Exception as e:
            if log_callback:
                log_callback(f"âš ï¸ æ—¥æœŸè§£æå¤±è´¥: {supplier}-{outlet_code} ({order_date}): {str(e)}")
            return False

    def format_days(self, day_numbers):
        """å°†æ•°å­—è½¬æ¢ä¸ºæ˜ŸæœŸåç§°"""
        days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 
               'Friday', 'Saturday', 'Sunday']
        return ", ".join(days[d] for d in sorted(day_numbers))

# ========== ç»Ÿä¸€é…ç½®ç®¡ç†å™¨ ==========
class UnifiedConfigManager:
    """ç®¡ç†ç»Ÿä¸€çš„Excelé…ç½®æ–‡ä»¶"""
    
    def __init__(self, config_path=None):
        self.config_path = config_path
        self.outlets = []
        self.suppliers = []
        self.delivery_schedule = []
        self.email_templates = {}
        self.supplier_requirements = {}
        
        if config_path:
            self.load_config(config_path)
    
    def load_config(self, config_path):
        """ä»Excelæ–‡ä»¶åŠ è½½é…ç½®"""
        try:
            wb = load_workbook(config_path, data_only=True)
            
            # è¯»å–åˆ†åº—ä¿¡æ¯
            if "Outlets" in wb.sheetnames:
                ws = wb["Outlets"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and row[0]:
                        self.outlets.append({
                            "code": row[0].strip().upper() if isinstance(row[0], str) else str(row[0]).strip().upper(),
                            "name": row[1].strip() if len(row) > 1 and isinstance(row[1], str) else str(row[1]).strip() if len(row) > 1 and row[1] is not None else "",
                            "email": row[2].strip().lower() if len(row) > 2 and isinstance(row[2], str) else str(row[2]).strip().lower() if len(row) > 2 and row[2] is not None else "",
                            "address": row[3].strip() if len(row) > 3 and isinstance(row[3], str) else str(row[3]).strip() if len(row) > 3 and row[3] is not None else "",
                            "delivery_day": row[4].strip() if len(row) > 4 and isinstance(row[4], str) else str(row[4]).strip() if len(row) > 4 and row[4] is not None else "",
                            "brand": row[5].strip() if len(row) > 5 and isinstance(row[5], str) else str(row[5]).strip() if len(row) > 5 and row[5] is not None else "Dine-In"
                        })
            
            # è¯»å–ä¾›åº”å•†ä¿¡æ¯
            if "Suppliers" in wb.sheetnames:
                ws = wb["Suppliers"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and row[0]:
                        self.suppliers.append({
                            "name": row[0].strip() if isinstance(row[0], str) else str(row[0]).strip(),
                            "email": row[1].strip().lower() if len(row) > 1 and isinstance(row[1], str) else str(row[1]).strip().lower() if len(row) > 1 and row[1] is not None else "",
                            "contact": row[2].strip() if len(row) > 2 and isinstance(row[2], str) else str(row[2]).strip() if len(row) > 2 and row[2] is not None else "",
                            "phone": row[3].strip() if len(row) > 3 and isinstance(row[3], str) else str(row[3]).strip() if len(row) > 3 and row[3] is not None else ""
                        })
            
            # è¯»å–é…é€æ—¥ç¨‹
            if "Delivery Schedule" in wb.sheetnames:
                ws = wb["Delivery Schedule"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and row[0]:
                        self.delivery_schedule.append({
                            "supplier": row[0].strip() if isinstance(row[0], str) else str(row[0]).strip(),
                            "outlet_code": row[1].strip().upper() if len(row) > 1 and isinstance(row[1], str) else str(row[1]).strip().upper() if len(row) > 1 and row[1] is not None else "ALL",
                            "delivery_days": row[2].strip() if len(row) > 2 and isinstance(row[2], str) else str(row[2]).strip() if len(row) > 2 and row[2] is not None else ""
                        })
            
            # è¯»å–é‚®ä»¶æ¨¡æ¿
            if "Email Templates" in wb.sheetnames:
                ws = wb["Email Templates"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and len(row) > 0 and row[0]:
                        self.email_templates[row[0].strip() if isinstance(row[0], str) else str(row[0]).strip()] = {
                            "subject": row[1].strip() if len(row) > 1 and isinstance(row[1], str) else str(row[1]).strip() if len(row) > 1 and row[1] is not None else "",
                            "body": row[2].strip() if len(row) > 2 and isinstance(row[2], str) else str(row[2]).strip() if len(row) > 2 and row[2] is not None else ""
                        }
            
            # è¯»å–ä¾›åº”å•†è¦æ±‚
            if "Supplier Requirements" in wb.sheetnames:
                ws = wb["Supplier Requirements"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and row[0]:
                        supplier_name = row[0].strip() if isinstance(row[0], str) else str(row[0]).strip()
                        # ä¿®æ­£ï¼šæ­£ç¢ºåˆ†å‰²ã€å»ç©ºæ ¼ã€è½‰å¤§å¯«
                        outlet_codes = []
                        if len(row) > 1 and row[1] is not None:
                            for code in str(row[1]).replace("\n", ",").replace("ï¼Œ", ",").split(","):
                                code = code.strip().upper()
                                if code:
                                    outlet_codes.append(code)
                        self.supplier_requirements[supplier_name] = outlet_codes
            
            return True, f"æˆåŠŸåŠ è½½é…ç½®æ–‡ä»¶: {len(self.outlets)} åˆ†åº—, {len(self.suppliers)} ä¾›åº”å•†"
        except Exception as e:
            return False, f"åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥: {str(e)}"
    
    def get_outlet(self, code):
        # æ ¹æ“šåˆ†åº—ä»£ç¢¼ç²å–åˆ†åº—å…¨å
        if not code:
            return None
        if isinstance(code, str):
            code = code.strip().upper()
        else:
            code = str(code).upper()
        for outlet in self.outlets:
            if outlet['short_name'].upper() == code:
                return outlet['full_name']
        return None
    
    def get_supplier(self, name):
        # æ ¹æ“šä¾›æ‡‰å•†åç¨±ç²å–æ¨™æº–åç¨±
        if not name:
            return None
        if isinstance(name, str):
            name = name.strip().upper()
        else:
            name = str(name).upper()
        for supplier in self.suppliers:
            if supplier['name'].upper() == name:
                return supplier['name']
        return None
    
    def get_delivery_schedule(self, supplier, outlet_code):
        """è·å–ç‰¹å®šä¾›åº”å•†-åˆ†åº—çš„é…é€æ—¥ç¨‹"""
        for schedule in self.delivery_schedule:
            if schedule["supplier"] == supplier and schedule["outlet_code"] == outlet_code:
                return schedule["delivery_days"]
        
        for schedule in self.delivery_schedule:
            if schedule["supplier"] == supplier and schedule["outlet_code"] == "ALL":
                return schedule["delivery_days"]
        
        return None
    
    def get_required_outlets(self, supplier_name):
        # ç”¨ normalize æ–¹å¼æ‰¾ keyï¼Œç¡®ä¿åŒ¹é…
        key = str(supplier_name).strip().upper()
        for k in self.supplier_requirements:
            if str(k).strip().upper() == key:
                return self.supplier_requirements[k]
        return []

# ========== é‚®ä»¶å‘é€ç®¡ç†å™¨ ==========
class EmailSender:
    """å¤„ç†é‚®ä»¶å‘é€åŠŸèƒ½"""

    def __init__(self, config_manager=None):
        self.config_manager = config_manager
        # åŠ è½½ GIF å›¾ç‰‡èµ„æº
        self.email_gif = self._load_email_gif()

    def _load_email_gif(self):
        """åŠ è½½é‚®ä»¶ç­¾å GIF å›¾ç‰‡"""
        try:
            gif_path = resource_path("email_gif.gif")
            if os.path.exists(gif_path):
                with open(gif_path, "rb") as f:
                    return f.read()
            return None
        except Exception as e:
            print(f"Error loading email GIF: {str(e)}")
            return None

    def _get_standard_subject(self, supplier_name):
        """ç”Ÿæˆæ ‡å‡†é‚®ä»¶ä¸»é¢˜"""
        now = datetime.now()
        month_name = now.strftime("%B")
        week_in_month = get_week_of_month(now)
        return f"Sushi Express Weekly Order - {supplier_name} - {month_name} - Week {week_in_month}"

    def get_to_cc_emails(self, supplier_name, config_path):
        """æ ¹æ“š config excel å–å¾— TO/CC éƒµä»¶ï¼Œä¸¦è‡ªå‹•åŠ  opsadmin åŠ purchasing.adminï¼Œä¸”CCä¸é‡è¤‡"""
        wb = load_workbook(config_path, data_only=True)
        to_emails = []
        cc_emails = []
        if "Suppliers" in wb.sheetnames:
            ws = wb["Suppliers"]
            for row in ws.iter_rows(min_row=2, values_only=True):
                if not row or not row[0]:
                    continue
                if str(row[0]).strip() == supplier_name:
                    typ = str(row[1]).strip().upper() if len(row) > 1 and row[1] else "TO"
                    email = str(row[2]).strip() if len(row) > 2 and row[2] else ""
                    if not email:
                        continue
                    if typ == "TO":
                        to_emails.append(email)
                    elif typ == "CC":
                        cc_emails.append(email)
        # å¿…é ˆCCçš„åå–®
        must_cc = [
            "opsadmin@sushiexpress.com.sg",
            "purchasing.admin@sushiexpress.com.sg"
        ]
        for cc in must_cc:
            if cc not in cc_emails:
                cc_emails.append(cc)
        # å»é‡ï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰
        seen = set()
        cc_unique = []
        for e in cc_emails:
            elower = e.lower()
            if elower not in seen:
                cc_unique.append(e)
                seen.add(elower)
        return to_emails, cc_unique

    def send_email(self, to_emails, cc_emails, supplier_name, body, attachment_path=None, account_idx=None, use_content_id=True, subject=None):
        import time
        import pywintypes
        max_retries = 3
        for attempt in range(max_retries):
            try:
                import win32com.client
                import os
                import base64
                outlook = win32com.client.Dispatch("Outlook.Application")
                # --- æ–°å¢ CreateItem è‡ªå‹•é‡è©¦ ---
                for create_attempt in range(3):
                    try:
                        mail = outlook.CreateItem(0)
                        break
                    except AttributeError as e:
                        if "CreateItem" in str(e):
                            print(f"[RETRY] Outlook COM é‚„æ²’æº–å‚™å¥½ï¼Œç¬¬ {create_attempt+1} æ¬¡é‡è©¦...")
                            time.sleep(2)
                            outlook = win32com.client.Dispatch("Outlook.Application")
                            continue
                        else:
                            raise
                else:
                    from tkinter import messagebox
                    messagebox.showerror("é‚®ä»¶å‘é€å¤±è´¥", "Outlook å•Ÿå‹•ç•°å¸¸ï¼Œè«‹ç¢ºèª Outlook å·²é–‹å•Ÿä¸”ç„¡å½ˆçª—ã€‚")
                    return None, "Outlook å•Ÿå‹•ç•°å¸¸ï¼Œè«‹ç¢ºèª Outlook å·²é–‹å•Ÿä¸”ç„¡å½ˆçª—ã€‚"
                # --- å…¶é¤˜åŸæœ¬çš„ send_email æµç¨‹ ---
                if account_idx is not None:
                    mapi = outlook.GetNamespace("MAPI")
                    accounts = [mapi.Folders.Item(i + 1) for i in range(mapi.Folders.Count)]
                    if 0 <= account_idx < len(accounts):
                        account = accounts[account_idx]
                        if hasattr(mail, 'SendUsingAccount'):
                            for acc in outlook.Session.Accounts:
                                if acc.DisplayName == account.Name:
                                    mail.SendUsingAccount = acc
                                    break
                # è™•ç†æ”¶ä»¶äºº
                if isinstance(to_emails, list):
                    to_emails_fixed = ';'.join(to_emails) if to_emails else ''
                else:
                    to_emails_fixed = to_emails.replace('ï¼Œ', ';').replace(',', ';') if to_emails else ''
                if isinstance(cc_emails, list):
                    cc_emails_fixed = ';'.join(cc_emails) if cc_emails else ''
                else:
                    cc_emails_fixed = cc_emails.replace('ï¼Œ', ';').replace(',', ';') if cc_emails else ''
                mail.To = to_emails_fixed
                mail.CC = cc_emails_fixed
                if subject:
                    mail.Subject = subject
                else:
                    mail.Subject = self._get_standard_subject(supplier_name)
                # æ·»åŠ  GIF ç°½å
                possible_gif_paths = [
                    "email_gif.gif",
                    os.path.join(os.path.dirname(__file__), "email_gif.gif"),
                    os.path.join(os.getcwd(), "email_gif.gif"),
                    os.path.abspath("email_gif.gif")
                ]
                signature_gif_path = None
                for path in possible_gif_paths:
                    if os.path.exists(path):
                        signature_gif_path = path
                        break
                print(f"[DEBUG] æª¢æŸ¥ GIF æ–‡ä»¶è·¯å¾‘: {possible_gif_paths}")
                print(f"[DEBUG] æ‰¾åˆ°çš„ GIF æ–‡ä»¶: {signature_gif_path}")
                print(f"[DEBUG] ç•¶å‰å·¥ä½œç›®éŒ„: {os.getcwd()}")
                print(f"[DEBUG] è…³æœ¬ç›®éŒ„: {os.path.dirname(__file__)}")
                html_body = body
                if not any(tag in body.lower() for tag in ['<br', '<p', '<div', '<table', '<ul', '<ol', '<li', '<b', '<strong', '<em', '<span']):
                    html_body = body.replace('\n', '<br>')
                if signature_gif_path and os.path.exists(signature_gif_path):
                    if use_content_id:
                        # Content-ID æ–¹å¼ï¼ˆæ–°ç‰ˆ Outlook å…¼å®¹ï¼‰
                        cid = "sigimg001"
                        signature_html = f"""
                        <br><br>
                        <img src=\"cid:{cid}\" alt=\"Signature\" style=\"max-width: 400px;\">
                        """
                        html_body += signature_html
                        mail.HTMLBody = html_body
                        att = mail.Attachments.Add(os.path.abspath(signature_gif_path))
                        att.PropertyAccessor.SetProperty("http://schemas.microsoft.com/mapi/proptag/0x3712001F", cid)
                        print(f"[DEBUG] å·²ç”¨ Content-ID æ’å…¥ GIF ç°½å")
                    else:
                        # base64 æ–¹å¼ï¼ˆèˆŠç‰ˆ Outlook å…¼å®¹ï¼‰
                        with open(signature_gif_path, 'rb') as f:
                            gif_data = base64.b64encode(f.read()).decode()
                        signature_html = f"""
                        <br><br>
                        <img src=\"data:image/gif;base64,{gif_data}\" alt=\"Signature\" style=\"max-width: 400px;\">
                        """
                        html_body += signature_html
                        mail.HTMLBody = html_body
                        print(f"[DEBUG] å·²ç”¨ base64 æ’å…¥ GIF ç°½å")
                else:
                    mail.HTMLBody = html_body
                # æ·»åŠ è®¢å•é™„ä»¶
                if attachment_path and os.path.exists(attachment_path):
                    mail.Attachments.Add(attachment_path)
                return mail
            except pywintypes.com_error as e:
                if hasattr(e, 'args') and len(e.args) > 0 and e.args[0] == -2147418111:
                    print(f"[RETRY] Outlook å¿™ç¢Œä¸­ï¼Œç¬¬ {attempt+1} æ¬¡é‡è©¦...")
                    time.sleep(2)
                    continue
                else:
                    import traceback
                    print(traceback.format_exc())
                    from tkinter import messagebox
                    messagebox.showerror("é‚®ä»¶å‘é€å¤±è´¥", f"{str(e)}\n\n{traceback.format_exc()}")
                    return None, f"åˆ›å»ºé‚®ä»¶å¤±è´¥: {str(e)}"
            except Exception as e:
                import traceback
                print(traceback.format_exc())
                from tkinter import messagebox
                messagebox.showerror("é‚®ä»¶å‘é€å¤±è´¥", f"{str(e)}\n\n{traceback.format_exc()}")
                return None, f"åˆ›å»ºé‚®ä»¶å¤±è´¥: {str(e)}"
        # å¦‚æœé‡è©¦å¾Œé‚„æ˜¯å¤±æ•—
        from tkinter import messagebox
        messagebox.showerror("é‚®ä»¶å‘é€å¤±è´¥", "Outlook å¿™ç¢Œï¼Œé‡è¯•å¤šæ¬¡ä»å¤±è´¥ã€‚è¯·ç¨åå†è¯•ã€‚")
        return None, "Outlook å¿™ç¢Œï¼Œé‡è¯•å¤šæ¬¡ä»å¤±è´¥ã€‚è¯·ç¨åå†è¯•ã€‚"

# ========== è®¢å•è‡ªåŠ¨åŒ–æ ¸å¿ƒ ==========
class OrderAutomation:
    """è®¢å•è‡ªåŠ¨åŒ–å·¥å…·"""
    
    def __init__(self, outlet_config=None):
        # outlet_config: list of dicts with keys 'short_name', 'full_name'
        self.outlet_name_map = {}
        if outlet_config:
            for o in outlet_config:
                full = o.get('full_name', '').strip().lower()
                short = o.get('short_name', '').strip().upper()
                if full:
                    self.outlet_name_map[full] = short
                if short:
                    self.outlet_name_map[short.lower()] = short
    def get_short_code(self, f5val):
        val = (str(f5val) or '').strip().lower()
        if val in self.outlet_name_map:
            return self.outlet_name_map[val]
        # é›™å‘æ¨¡ç³Šæ¯”å°
        for full, short in self.outlet_name_map.items():
            if full in val or val in full:
                return short
            # å–®å­—æ¯”å°
            for word in val.split():
                if word and word in full:
                    return short
        return 'UNKNOWN'

    @staticmethod
    def is_valid_date(cell_value, next_week_start, next_week_end):
        """æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ—¥æœŸ"""
        try:
            if isinstance(cell_value, (int, float)):
                base_date = datetime(1899, 12, 30)
                parsed = base_date + timedelta(days=cell_value)
            else:
                parsed = parse(str(cell_value), fuzzy=True, dayfirst=False)
            # å°æ–¼ Amendment æª”æ¡ˆï¼Œæˆ‘å€‘æ¥å—ä»»ä½•æ—¥æœŸï¼Œä¸é™åˆ¶åœ¨ç‰¹å®šé€±æœŸå…§
            return True  # æš«æ™‚æ¥å—æ‰€æœ‰æ—¥æœŸ
        except:
            return False

    @classmethod
    def find_delivery_date_row(cls, ws, next_week_start, next_week_end, max_rows=200, file_path=None):
        """æŸ¥æ‰¾é€è´§æ—¥æœŸè¡Œ"""
        valid_col_range = range(5, 12)
        invalid_labels = ["total", "total:", "sub-total", "sub-total:", "no. of cartons", "no. of cartons:"]
        found_blocks = []
        for i, row in enumerate(ws.iter_rows(min_row=1, max_row=max_rows)):
            cols = []
            for j, cell in enumerate(row):
                if j not in valid_col_range:
                    continue
                val = cell.value
                if cls.is_valid_date(val, next_week_start, next_week_end):
                    cols.append(j)
            if cols:
                found_blocks.append((i + 1, cols))
        for header_row, cols in found_blocks:
            for row_idx in range(header_row + 1, header_row + 200):
                label_val = ws.cell(row=row_idx, column=5).value
                label = str(label_val).lower().strip() if label_val else ""
                if any(invalid in label for invalid in invalid_labels):
                    continue
                for col_idx in cols:
                    qty_val = ws.cell(row=row_idx, column=col_idx+1).value
                    if isinstance(qty_val, (int, float)) and qty_val > 0:
                        return header_row, cols
        return None, []

    @classmethod
    def run_automation(cls, source_folder, supplier_folder, 
                      outlet_config=None, delivery_config=None,
                      log_callback=None, mapping_callback=None):
        """è¿è¡Œè®¢å•è‡ªåŠ¨åŒ–ï¼ˆä»…ç”Ÿæˆ supplier æ–‡ä»¶ï¼‰"""
        now = datetime.now()
        today = now.date()
        this_monday = today - timedelta(days=today.weekday())
        next_monday = this_monday + timedelta(days=7)
        next_sunday = next_monday + timedelta(days=6)
        start_of_period = datetime.combine(next_monday, datetime.min.time())
        end_of_period = datetime.combine(next_sunday, datetime.max.time())
        save_path = os.path.join(source_folder, f"next_week_order_log_{now.strftime('%Y%m%d_%H%M%S')}.txt")
        log_lines = [f"ğŸ¯ Next Week Order Integration Log\n", f"Scan Start Time: {now}\n", f"Target Week: {start_of_period.date()} to {end_of_period.date()}\n"]
        
        date_validator = DeliveryDateValidator(delivery_config) if delivery_config else None
        
        outlet_mapping = {}
        if outlet_config:
            try:
                outlet_mapping = {o['short_name']: o for o in outlet_config}
                if log_callback:
                    log_callback(f"âœ… å·²åŠ è½½åˆ†åº—é…ç½®: {len(outlet_mapping)} ä¸ªåˆ†åº—")
            except Exception as e:
                if log_callback:
                    log_callback(f"âš ï¸ åˆ†åº—é…ç½®åŠ è½½å¤±è´¥: {str(e)}")
        
        # æ–°å¢ï¼šå»ºç«‹ä¸€å€‹ OrderAutomation å¯¦ä¾‹ç”¨æ–¼ get_short_code
        oa_instance = cls(outlet_config) if outlet_config else cls()
        
        supplier_to_outlets = defaultdict(list)
        
        def log(message, include_timestamp=True):
            timestamp = datetime.now().strftime("%H:%M:%S") if include_timestamp else ""
            log_line = f"[{timestamp}] {message}" if include_timestamp else message
            log_lines.append(log_line + "\n")
            if log_callback:
                log_callback(log_line + "\n")

        files = [f for f in os.listdir(source_folder)
                 if f.endswith((".xlsx", ".xls")) and not f.startswith("~$")]
        total_files = len(files)

        if total_files == 0:
            log("æœªæ‰¾åˆ°Excelæ–‡ä»¶\nNo Excel files found in source folder. Exiting.")
            return False, "åœ¨æºæ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°Excelæ–‡ä»¶"

        log(f"æ‰¾åˆ° {total_files} ä¸ªExcelæ–‡ä»¶\nFound {total_files} Excel files")
        log(f"ç›®æ ‡å‘¨æœŸ: {start_of_period.strftime('%Y-%m-%d')} åˆ° {end_of_period.strftime('%Y-%m-%d')}\nTarget period: {start_of_period.strftime('%Y-%m-%d')} to {end_of_period.strftime('%Y-%m-%d')}")
        log(f"ğŸ” å°ˆæ³¨æ–¼ä¸‹é€±è¨‚å–®ï¼Œå¿½ç•¥å…¶ä»–é€±æœŸ\nğŸ” Focus on next week orders only, ignore other periods")

        for idx, file in enumerate(files):
            full_path = os.path.join(source_folder, file)
            try:
                # log(f"\nå¤„ç†æ–‡ä»¶ {idx+1}/{total_files}: {file}\nProcessing file {idx+1}/{total_files}: {file}")
                wb = load_workbook(full_path, data_only=True)
                # log(f"å·¥ä½œè¡¨: {', '.join(wb.sheetnames)}\nWorksheets: {', '.join(wb.sheetnames)}")
                for sheetname in wb.sheetnames:
                    ws = wb[sheetname]
                    if ws.sheet_state != "visible":
                        continue  # è·³ééš±è—å·¥ä½œè¡¨ä¸ logï¼Œä¸é¡¯ç¤ºä»»ä½•è¨Šæ¯
                    outlet_short = file.split('_')[0].strip() if '_' in file else file.split('.')[0].strip()
                    # log(f"  å·¥ä½œè¡¨: {sheetname}, æ–‡ä»¶ååˆ†åº—ç®€ç§°: '{outlet_short}'\n  Sheet: {sheetname}, Short Name (from filename): '{outlet_short}'")
                    has_order = False
                    week_days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                    for row in range(1, ws.max_row):
                        row_vals = [str(ws.cell(row=row, column=col).value).strip() if ws.cell(row=row, column=col).value else '' for col in range(6, 13)]
                        weekday_count = sum(day in row_vals for day in week_days)
                        if 'Mon' in row_vals and weekday_count >= 3:
                            date_row = row + 1
                            date_cols = []
                            for idx2, col in enumerate(range(6, 13)):
                                val = ws.cell(row=date_row, column=col).value
                                parsed = None
                                try:
                                    if val:
                                        sval = str(val)
                                        if re.match(r"^\d{1,2}-[A-Za-z]{3,}$", sval):
                                            year = start_of_period.year
                                            sval = f"{sval}-{year}"
                                        if isinstance(val, (int, float)):
                                            base_date = datetime(1899, 12, 30)
                                            parsed = base_date + timedelta(days=val)
                                        else:
                                            parsed = parse(sval, fuzzy=True, dayfirst=False)
                                except Exception:
                                    pass
                                if parsed and start_of_period.date() <= parsed.date() <= end_of_period.date():
                                    date_cols.append(col)
                            if date_cols:
                                for r in range(date_row+1, min(date_row+30, ws.max_row+1)):
                                    found_order_this_row = False
                                    for c in date_cols:
                                        val = ws.cell(row=r, column=c).value
                                        if isinstance(val, (datetime,)):
                                            if val.date() > end_of_period.date():
                                                found_order_this_row = True
                                                break
                                        elif isinstance(val, (int, float)) and val > 0:
                                            has_order = True
                                            found_order_this_row = True
                                            break
                                    if found_order_this_row:
                                        break
                            if has_order:
                                break
                    if has_order:
                        # åªè¨˜éŒ„æœ‰è¨‚å–®çš„å» å•†èˆ‡åˆ†åº—ï¼Œä¸è¨˜éŒ„ç´°ç¯€
                        supplier_to_outlets[sheetname].append((outlet_short, full_path, sheetname))
            except Exception as e:
                error_msg = f"âŒ å¤„ç†æ–‡ä»¶å‡ºé”™: {file}\nâŒ Error processing {file}: {str(e)}\n{traceback.format_exc()}"
                log(error_msg)
        
        log("\nğŸ“Š ä¸‹é€±è¨‚å–®æ•´åˆçµæœ / Next Week Order Integration Results:")
        for supplier, outlets in supplier_to_outlets.items():
            outlet_list = [str(o[0]) if o[0] else "UNKNOWN" for o in outlets]
            log(f"  ğŸ“¦ {supplier}: {', '.join(outlet_list)}")
        log(f"\nğŸ¯ åªè™•ç†ä¸‹é€±è¨‚å–®ï¼Œå…± {sum(len(outlets) for outlets in supplier_to_outlets.values())} å€‹é–€å¸‚æœ‰è¨‚å–®")
        log("\nCreating supplier files...")
        supplier_files = []
        import xlwings as xw
        for sheetname, outlet_file_pairs in supplier_to_outlets.items():
            supplier_path = os.path.join(supplier_folder, f"{sheetname}_Week_{now.isocalendar()[1]}.xlsx")
            # å…ˆå»ºç«‹ç©ºæª”æ¡ˆ
            if not os.path.exists(supplier_path):
                from openpyxl import Workbook
                wb = Workbook()
                wb.save(supplier_path)
            app = xw.App(visible=False)
            try:
                wb_dest = app.books.open(supplier_path)
                for outlet, src_file, original_sheet in outlet_file_pairs:
                    try:
                        wb_src = app.books.open(src_file)
                        sht = wb_src.sheets[original_sheet]
                        dest_sheet_name = outlet if outlet else original_sheet
                        # åˆªé™¤åŒååˆ†é 
                        for s in wb_dest.sheets:
                            if s.name == dest_sheet_name:
                                s.delete()
                        sht.api.Copy(Before=wb_dest.sheets[0].api)
                        wb_dest.sheets[0].name = dest_sheet_name
                        wb_src.close()
                        log(f"  âœ… {dest_sheet_name} å·²è¤‡è£½é€² {os.path.basename(supplier_path)}ï¼ˆæ ¼å¼/å…¬å¼å®Œæ•´ä¿ç•™ï¼‰")
                    except Exception as e:
                        log(f"    âŒ Failed to copy {outlet} in {sheetname}: {str(e)}\n{traceback.format_exc()}")
                wb_dest.save()
                wb_dest.close()
                supplier_files.append(os.path.basename(supplier_path))
            finally:
                app.quit()
        result_text = "\nğŸ¯ ä¸‹é€±è¨‚å–®æ•´åˆå®Œæˆ / Next Week Order Integration Complete:\n"
        result_text += f"ğŸ“¦ å·²è™•ç†ä¾›æ‡‰å•†æ–‡ä»¶: {len(supplier_files)}\n"
        result_text += f"ğŸ“… ç›®æ¨™é€±æœŸ: {start_of_period.strftime('%Y-%m-%d')} åˆ° {end_of_period.strftime('%Y-%m-%d')}\n\n"
        result_text += "ğŸ“‹ ä¾›æ‡‰å•†æ–‡ä»¶åˆ—è¡¨:\n" + "\n".join([f"  âœ… {file}" for file in supplier_files])
        log(result_text)
        try:
            with open(save_path, "w", encoding="utf-8") as logfile:
                logfile.writelines(log_lines)
            log(f"\nLog saved at: {save_path}")
            return True, f"è®¢å•æ•´åˆå®Œæˆï¼\n\næ—¥å¿—æ–‡ä»¶ä¿å­˜è‡³:\n{save_path}\n\n{result_text}"
        except Exception as e:
            log(f"âŒ Failed to write log file: {e}")
            return False, f"è®¢å•æ•´åˆå®Œæˆä½†æ—¥å¿—ä¿å­˜å¤±è´¥:\n{str(e)}"

# ========== å¢å¼ºç‰ˆè®¢å•æ£€æŸ¥å™¨ ==========
class EnhancedOrderChecker:
    """ä½¿ç”¨é…ç½®æ–‡ä»¶çš„è®¢å•æ£€æŸ¥å™¨"""
    
    def __init__(self, config_manager=None):
        self.config_manager = config_manager
        # æ–°å¢ï¼šå»ºç«‹ full name/short name/email name normalize æ˜ å°„åˆ° short name
        self.fullname_to_short = {}
        if config_manager and hasattr(config_manager, 'config_path'):
            import pandas as pd
            import os
            config_path = config_manager.config_path if hasattr(config_manager, 'config_path') else None
            if config_path and os.path.exists(config_path):
                try:
                    df = pd.read_excel(config_path, sheet_name=None)
                    outlet_df = None
                    for key in df.keys():
                        if key.strip().lower() == "outlet":
                            outlet_df = df[key]
                            break
                    if outlet_df is not None:
                        for _, row in outlet_df.iterrows():
                            short = str(row.get("Short Name", "")).strip()
                            full = str(row.get("Outlet Full Name", "")).strip()
                            email_name = str(row.get("Name in Email", "")).strip()
                            for n in [short, full, email_name]:
                                n_norm = self._normalize(n)
                                if n and n_norm:
                                    self.fullname_to_short[n_norm] = short
                except Exception as e:
                    print("[EnhancedOrderChecker] Outlet mapping read error:", e)

    @staticmethod
    def _normalize(text):
        """æ ‡å‡†åŒ–æ–‡æœ¬"""
        import re
        if not text:
            return ""
        # åªå»é™¤ç©ºæ ¼ï¼Œä¿ç•™æ‹¬å·å†…å®¹ä»¥åŒºåˆ†ä¸åŒä¾›åº”å•†
        return re.sub(r'[\s]', '', str(text).lower())

    def get_outlet_shortname(self, f5_value):
        """æ™ºèƒ½è·å–åˆ†åº—ç®€ç§°ï¼Œä¼˜å…ˆç”¨ config mapping"""
        import re
        
        if not f5_value or not isinstance(f5_value, str):
            return f"[EMPTY] {f5_value}"
        
        # å…ˆå˜—è©¦å®Œæ•´åŒ¹é…
        n = self._normalize(f5_value)
        if n in self.fullname_to_short:
            return self.fullname_to_short[n]
        
        # è™•ç†åŒ…å«é…é€æ—¥æœŸè³‡è¨Šçš„ F5 å€¼
        # ä¾‹å¦‚: "Sushi Express West Mall (MON,WED,FRI,SAT)" -> "Sushi Express West Mall"
        # ä½†ä¿ç•™åŒ…å«é–€å¸‚ä»£ç¢¼çš„æ‹¬è™Ÿï¼Œå¦‚ "Sushi Takeout CityVibe (GTM)"
        delivery_pattern = r'\s*\([A-Z]{2,4},[A-Z]{2,4},[A-Z]{2,4},[A-Z]{2,4}\)\s*$'
        cleaned_f5 = re.sub(delivery_pattern, '', f5_value.strip())
        
        if cleaned_f5 != f5_value:
            n = self._normalize(cleaned_f5)
            if n in self.fullname_to_short:
                return self.fullname_to_short[n]
        
        # fallback: åŸæœ‰ hardcode/æ­£åˆ™é€»è¾‘ï¼ˆå¯é€‰ï¼‰
        # ... existing code ...
        return f"[UNKNOWN] {f5_value}"

    def run_checklist(self, folder, log_callback=None, as_table=False):
        date_validator = None
        if self.config_manager:
            delivery_schedules = self.config_manager.delivery_schedule
            if delivery_schedules:
                date_validator = DeliveryDateValidator()
                date_validator.schedule = defaultdict(dict)
                for row in delivery_schedules:
                    supplier = row['supplier']
                    outlet = row['outlet_code']
                    days = DeliveryDateValidator().parse_delivery_days(row['delivery_days'])
                    if outlet == "ALL":
                        date_validator.schedule[supplier]['*'] = days
                    else:
                        date_validator.schedule[supplier][outlet] = days
        supplier_keywords = {}
        if self.config_manager:
            for supplier in self.config_manager.suppliers:
                supplier_keywords[supplier["name"]] = [supplier["name"].lower()]
        must_have_outlets = {}
        if self.config_manager:
            for supplier in self.config_manager.suppliers:
                must_have_outlets[supplier["name"]] = self.config_manager.get_required_outlets(supplier["name"])
        try:
            files = [f for f in os.listdir(folder) if f.endswith(".xlsx") and not f.startswith("~$")]
            def file_key(f):
                import re
                base = f.split("_Week_")[0]
                return self._normalize(base)
            normalized_files = {file_key(f): f for f in files}
            output = []
            table = []
            for supplier, keywords in supplier_keywords.items():
                matches = self._find_supplier_file(normalized_files, keywords)
                if not matches:
                    if as_table:
                        table.append({
                            "supplier": supplier,
                            "outlet": "-",
                            "cover_status": "âŒ",
                            "remark": "Supplier file not found"
                        })
                    else:
                        output.append(f"\nâŒ {supplier} - Supplier file not found.")
                    continue
                for match in matches:
                    result, table_rows = self._process_supplier_file(
                        folder, match, must_have_outlets[supplier], 
                        date_validator, log_callback, as_table=True, supplier=supplier
                    )
                if as_table:
                    table.extend(table_rows)
                else:
                    output.extend(result)
            if as_table:
                return table
            return "\n".join(output)
        except Exception as e:
            if as_table:
                return [{"supplier": "-", "outlet": "-", "cover_status": "âŒ", "remark": f"Error: {str(e)}"}]
            return f"âŒ Error running checklist: {str(e)}\n{traceback.format_exc()}"

    @classmethod
    def _find_supplier_file(cls, normalized_files, keywords):
        matches = []
        for k in keywords:
            nk = cls._normalize(k)
            for nf, of in normalized_files.items():
                if nf == nk:
                    matches.append(of)
        if matches:
            return matches
        # ä¸å†åšå”¯ä¸€æ¨¡ç³ŠåŒ¹é…ï¼Œé¿å…è¯¯é…
        return None

    def _process_supplier_file(self, folder, filename, required_outlets, date_validator=None, log_callback=None, as_table=False, supplier=None):
        import os
        from openpyxl import load_workbook
        import tkinter.messagebox as messagebox
        output = []
        table = []
        found = set()
        unidentified = []
        date_errors = []
        unknown_f5 = set()
        try:
            wb = load_workbook(os.path.join(folder, filename), data_only=True)
            for s in wb.sheetnames:
                # è·³è¿‡ sheet åä¸º 'Sheet' æˆ–ç©ºç™½çš„ sheet
                if not s.strip() or s.strip().lower() == 'sheet':
                    continue
                try:
                    f5 = wb[s]["F5"].value
                    code = self.get_outlet_shortname(f5)
                    sheet_name = s.strip().upper()
                    short_name_mismatch = False
                    
                    # è™•ç†ç‰¹æ®Šæƒ…æ³ï¼šå¦‚æœ F5 æ˜ å°„çµæœèˆ‡å·¥ä½œè¡¨åç¨±ä¸åŒï¼Œä½†éƒ½æŒ‡å‘åŒä¸€å€‹é–€å¸‚
                    # ä¾‹å¦‚ï¼šF5â†’BUGIS, Sheetâ†’BJï¼Œä½†éƒ½æŒ‡å‘ SushiPlus Bugis
                    if code != sheet_name and "[UNKNOWN]" not in code and "[EMPTY]" not in code:
                        # æª¢æŸ¥æ˜¯å¦éƒ½æ˜ å°„åˆ°åŒä¸€å€‹é–€å¸‚
                        f5_normalized = self._normalize(f5) if f5 else ""
                        sheet_normalized = self._normalize(sheet_name)
                        
                        # å¦‚æœ F5 æ˜ å°„å’Œå·¥ä½œè¡¨åç¨±éƒ½æŒ‡å‘åŒä¸€å€‹é–€å¸‚ï¼Œå‰‡ä¸è¦–ç‚º mismatch
                        if f5_normalized in self.fullname_to_short and sheet_normalized in self.fullname_to_short:
                            if self.fullname_to_short[f5_normalized] == self.fullname_to_short[sheet_normalized]:
                                short_name_mismatch = False
                            else:
                                short_name_mismatch = True
                        else:
                            short_name_mismatch = True
                    if "[UNKNOWN]" in code or "[EMPTY]" in code:
                        unidentified.append((s, f5))
                        unknown_f5.add(str(f5).strip() if f5 else "[ç©ºç™½]")
                        if as_table:
                            table.append({
                                "supplier": supplier,
                                "outlet": s,
                                "cover_status": "âš ï¸",
                                "remark": f"F5 error: {f5}" + (f"; Short name mismatch: F5â†’{code}, Sheetâ†’{sheet_name}" if short_name_mismatch else "")
                            })
                    else:
                        found.add(code)
                        date_status = "-"
                        remark = ""
                        if date_validator:
                            delivery_date = wb[s]['F8'].value if 'F8' in wb[s] else None
                            if delivery_date:
                                is_valid = date_validator.validate_order(
                                    supplier,
                                    code,
                                    delivery_date,
                                    log_callback
                                )
                                if not is_valid:
                                    date_status = "âŒ"
                                    remark = "Invalid delivery date"
                                    date_errors.append(code)
                                else:
                                    date_status = "âœ”ï¸"
                            else:
                                date_status = "âš ï¸"
                                remark = ""
                        if short_name_mismatch:
                            if remark:
                                remark += "; "
                            remark += f"Short name mismatch: F5â†’{code}, Sheetâ†’{sheet_name}"
                        if as_table:
                            table.append({
                                "supplier": supplier,
                                "outlet": code,
                                "cover_status": "âœ”ï¸",
                                "remark": remark
                            })
                except Exception as e:
                    unidentified.append((s, f"[F5 error: {e}]") )
                    if as_table:
                        table.append({
                            "supplier": supplier,
                            "outlet": s,
                            "cover_status": "âš ï¸",
                            "remark": f"F5 error: {e} (sheet: {s}, file: {filename})"
                        })
            required = set([str(x).strip().upper() for x in required_outlets])
            found = set([str(x).strip().upper() for x in found])
            print(f"[DEBUG] supplier={supplier}")
            print(f"[DEBUG] required={required}")
            print(f"[DEBUG] found={found}")
            print(f"[DEBUG] missing={required - found}")
            print(f"[DEBUG] all sheet names in {filename}: {wb.sheetnames}")
            print(f"[DEBUG] unidentified sheets: {unidentified}")
            print(f"[DEBUG] unknown F5 values: {unknown_f5}")
            print(f"[DEBUG] F5 to code mappings:")
            for s in wb.sheetnames:
                if not s.strip() or s.strip().lower() == 'sheet':
                    continue
                try:
                    f5 = wb[s]["F5"].value
                    code = self.get_outlet_shortname(f5)
                    print(f"  Sheet: {s}, F5: {f5}, Code: {code}")
                except Exception as e:
                    print(f"  Sheet: {s}, F5 Error: {e}")
            
            # æª¢æŸ¥ missing outlet æ˜¯å¦æœ‰å°æ‡‰çš„ sheet ä½† F5 å’Œ sheet name ä¸ä¸€è‡´
            missing_with_sheet_mismatch = set()
            for sheet_name in wb.sheetnames:
                if not sheet_name.strip() or sheet_name.strip().lower() == 'sheet':
                    continue
                sheet_name_upper = sheet_name.strip().upper()
                if sheet_name_upper in required and sheet_name_upper not in found:
                    try:
                        f5 = wb[sheet_name]["F5"].value
                        code = self.get_outlet_shortname(f5)
                        if code != sheet_name_upper and "[UNKNOWN]" not in code and "[EMPTY]" not in code:
                            missing_with_sheet_mismatch.add(sheet_name_upper)
                    except:
                        pass
            
            for o in sorted(required - found):
                if as_table:
                    if o in missing_with_sheet_mismatch:
                        # æœ‰ sheet ä½† F5 å’Œ sheet name ä¸ä¸€è‡´
                        table.append({
                            "supplier": supplier,
                            "outlet": o,
                            "cover_status": "âš ï¸",
                            "remark": f"Short name mismatch: Sheetâ†’{o}"
                        })
                    else:
                        # çœŸæ­£çš„ missing outlet
                        table.append({
                            "supplier": supplier,
                            "outlet": o,
                            "cover_status": "âŒ",
                            "remark": "Missing outlet"
                        })
            if as_table:
                # æ£€æŸ¥ç»“æŸåï¼Œå¼¹çª—æé†’æ‰€æœ‰æœªèƒ½ mapping çš„ F5 å†…å®¹
                if unknown_f5:
                    msg = "ä»¥ä¸‹ F5 å†…å®¹æœªèƒ½è‡ªåŠ¨ mapping åˆ° short nameï¼Œè¯·è¡¥å……åˆ° config çš„ OUTLET sheetï¼š\n" + "\n".join(f"- {f5val}" for f5val in sorted(unknown_f5))
                    try:
                        messagebox.showwarning("æ™ºèƒ½æç¤º/Smart Reminder", msg)
                    except Exception:
                        print("[æ™ºèƒ½æç¤º]", msg)
                return output, table
            # åŸæœ¬æ–‡å­—æŠ¥è¡¨
            output.append(f"\n=== {filename} ===")
            output.append(f"ğŸ“Š Required: {len(required)}, Found: {len(found)}, Missing: {len(required - found)}")
            for o in sorted(required & found):
                output.append(f"âœ”ï¸ {o}")
            for o in sorted(required - found):
                output.append(f"âŒ {o}")
            for s, v in unidentified:
                output.append(f"âš ï¸ {s} => {v}")
            if unknown_f5:
                output.append("[æ™ºèƒ½æç¤º] ä»¥ä¸‹ F5 å†…å®¹æœªèƒ½è‡ªåŠ¨ mapping åˆ° short nameï¼Œè¯·è¡¥å……åˆ° config çš„ OUTLET sheetï¼š")
                for f5val in sorted(unknown_f5):
                    output.append(f"  - {f5val}")
            return output, table
        except Exception as e:
            if as_table:
                return [{"supplier": "-", "outlet": "-", "cover_status": "âŒ", "remark": f"Error: {str(e)}"}]
            return f"âŒ Error running checklist: {str(e)}\n{traceback.format_exc()}"

# ========== å¢å¼ºç‰ˆè®¢å•è‡ªåŠ¨åŒ– ==========
class EnhancedOrderAutomation(OrderAutomation):
    """æ”¯æŒé‚®ä»¶å‘é€çš„è®¢å•è‡ªåŠ¨åŒ–"""
    
    def __init__(self, config_manager=None):
        super().__init__()
        self.config_manager = config_manager
        self.email_sender = EmailSender(config_manager)
    
    def run_automation(self, source_folder, supplier_folder, 
                      log_callback=None, mapping_callback=None, 
                      email_callback=None):
        """è¿è¡Œè‡ªåŠ¨åŒ–æµç¨‹ï¼ˆä»… supplier æ•´åˆï¼‰"""
        success, result = super().run_automation(
            source_folder, supplier_folder, 
            log_callback=log_callback, mapping_callback=mapping_callback
        )
        if not success:
            return success, result
        supplier_files = []
        for file in os.listdir(supplier_folder):
            if file.endswith(".xlsx") and "Week" in file:
                supplier_name = file.split("_")[0]
                supplier_files.append({
                    "path": os.path.join(supplier_folder, file),
                    "supplier": supplier_name
                })
        if self.config_manager and email_callback:
            email_callback(supplier_files)
        return success, result

class YellowHighlightedOrderAutomation(OrderAutomation):
    """åªæ•´åˆæœ‰é»ƒè‰²æ¨™è¨˜çš„è¨‚å–®"""
    
    def __init__(self, config_manager=None):
        super().__init__()
        self.config_manager = config_manager
    
    def has_yellow_highlight(self, ws, row, col):
        """æª¢æŸ¥æŒ‡å®šå–®å…ƒæ ¼æ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜"""
        try:
            cell = ws.cell(row=row, column=col)
            if cell.fill.start_color.rgb:
                fill_color = cell.fill.start_color.rgb
                print(f"[DEBUG] Cell ({row}, {col}) RGB: {fill_color}")
                
                # æª¢æŸ¥å¸¸è¦‹çš„é»ƒè‰² RGB å€¼
                yellow_rgbs = ['FFFF00', 'FFFFFF00', 'FF00FF00', 'FFD966', 'FFF200', 'FFEB9C', 'FFE066', 'FFD700', 'FFE135', 'FFD800', 'FFE100']
                if fill_color in yellow_rgbs:
                    print(f"[DEBUG] âœ… æ‰¾åˆ°æ¨™æº–é»ƒè‰²: {fill_color}")
                    return True
                
                # æ›´å¯¬é¬†çš„é»ƒè‰²æª¢æŸ¥ï¼šR å’Œ G éƒ½å¾ˆé«˜ï¼ŒB å¾ˆä½
                if fill_color.startswith('FF') and len(fill_color) == 8:
                    rgb = fill_color[2:]  # å»æ‰ alpha é€šé“
                    r = int(rgb[0:2], 16)
                    g = int(rgb[2:4], 16)
                    b = int(rgb[4:6], 16)
                    
                    # é»ƒè‰²æ¢ä»¶ï¼šR å’Œ G éƒ½ > 240ï¼ŒB < 50
                    if r > 240 and g > 240 and b < 50:
                        print(f"[DEBUG] âœ… æ‰¾åˆ°å¯¬é¬†é»ƒè‰²: R={r}, G={g}, B={b}")
                        return True
                    
                    # æ›´å¯¬é¬†çš„æ¢ä»¶ï¼šR å’Œ G éƒ½ > 200ï¼ŒB < 100
                    if r > 200 and g > 200 and b < 100:
                        print(f"[DEBUG] âœ… æ‰¾åˆ°éå¸¸å¯¬é¬†é»ƒè‰²: R={r}, G={g}, B={b}")
                        return True
                
                print(f"[DEBUG] âŒ ä¸æ˜¯é»ƒè‰²: {fill_color}")
            else:
                print(f"[DEBUG] Cell ({row}, {col}) æ²’æœ‰å¡«è‰²")
            return False
        except Exception as e:
            print(f"[DEBUG] Error checking yellow highlight: {e}")
            return False
    
    def check_file_has_yellow_highlight(self, filepath, this_week_start, this_week_end):
        """æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜çš„å–®å…ƒæ ¼"""
        try:
            print(f"[DEBUG] é–‹å§‹æª¢æŸ¥æª”æ¡ˆ: {filepath}")
            wb = openpyxl.load_workbook(filepath, data_only=True)
            for sheet_name in wb.sheetnames:
                ws = wb[sheet_name]
                print(f"[DEBUG] æª¢æŸ¥å·¥ä½œè¡¨: {sheet_name}")
                
                # å°‹æ‰¾æ—¥æœŸè¡Œ - ä½¿ç”¨æœ¬é€±æ—¥æœŸç¯„åœ
                date_row_result = self.find_delivery_date_row(ws, this_week_start, this_week_end, file_path=filepath)
                if date_row_result is None or date_row_result[0] is None:
                    print(f"[DEBUG] åœ¨å·¥ä½œè¡¨ {sheet_name} ä¸­æ‰¾ä¸åˆ°æ—¥æœŸè¡Œ")
                    continue
                
                date_row = date_row_result[0]  # å–å¾—è¡Œè™Ÿ
                print(f"[DEBUG] æ‰¾åˆ°æ—¥æœŸè¡Œ: {date_row}")
                
                # æª¢æŸ¥æ—¥æœŸè¡Œä¸‹æ–¹çš„æ•¸é‡å–®å…ƒæ ¼æ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜
                for row in range(date_row + 1, min(date_row + 50, ws.max_row + 1)):
                    # æª¢æŸ¥æ˜¯å¦ç‚ºç”¢å“è¡Œï¼ˆé€šå¸¸æœ‰ç”¢å“åç¨±ï¼‰- ä½¿ç”¨ E æ¬„èˆ‡ find_delivery_date_row ä¸€è‡´
                    product_name = ws.cell(row=row, column=5).value  # E æ¬„ç”¢å“åç¨±
                    if not product_name or str(product_name).strip() == "":
                        continue
                    
                    print(f"[DEBUG] æª¢æŸ¥ç”¢å“è¡Œ: {row}, ç”¢å“: {product_name}")
                    
                    # æª¢æŸ¥æ—¥æœŸæ¬„ä½ï¼ˆé€šå¸¸æ˜¯ F åˆ° L æ¬„ï¼‰
                    for col in range(6, 13):  # F åˆ° L æ¬„
                        cell_value = ws.cell(row=row, column=col).value
                        if cell_value and (isinstance(cell_value, (int, float)) or 
                                         (isinstance(cell_value, str) and cell_value.replace('.', '').isdigit())):
                            print(f"[DEBUG] æª¢æŸ¥æ•¸é‡æ ¼: ({row}, {col}), å€¼: {cell_value}")
                            # å¦‚æœæ•¸é‡ä¸ç‚º0ä¸”æœ‰é»ƒè‰²æ¨™è¨˜
                            if self.has_yellow_highlight(ws, row, col):
                                print(f"[DEBUG] âœ… åœ¨æª”æ¡ˆ {filepath} ä¸­æ‰¾åˆ°é»ƒè‰²æ¨™è¨˜!")
                                wb.close()
                                return True
            wb.close()
            print(f"[DEBUG] âŒ åœ¨æª”æ¡ˆ {filepath} ä¸­æ²’æœ‰æ‰¾åˆ°é»ƒè‰²æ¨™è¨˜")
            return False
        except Exception as e:
            print(f"[DEBUG] Error checking yellow highlight in {filepath}: {e}")
            return False
    
    def run_automation(self, source_folder, supplier_folder, log_callback=None, mapping_callback=None):
        from datetime import datetime, timedelta
        import os
        import openpyxl
        import xlwings as xw
        import traceback

        now = datetime.now()
        today = now.date()
        this_monday = today - timedelta(days=today.weekday())
        this_sunday = this_monday + timedelta(days=6)
        start_of_period = datetime.combine(this_monday, datetime.min.time())
        end_of_period = datetime.combine(this_sunday, datetime.max.time())
        save_path = os.path.join(source_folder, f"yellow_highlight_order_log_{now.strftime('%Y%m%d_%H%M%S')}.txt")
        log_lines = [
            f"ğŸ¯ Amendment Order Integration Log\n",
            f"Scan Start Time: {now}\n",
            f"Target Week: {start_of_period.date()} to {end_of_period.date()}\n"
        ]

        def log(message, include_timestamp=True):
            timestamp = datetime.now().strftime("%H:%M:%S") if include_timestamp else ""
            log_line = f"[{timestamp}] {message}" if include_timestamp else message
            log_lines.append(log_line + "\n")
            if log_callback:
                log_callback(log_line + "\n")

        files = [f for f in os.listdir(source_folder) if f.endswith((".xlsx", ".xls")) and not f.startswith("~$")]
        total_files = len(files)
        if total_files == 0:
            log("æœªæ‰¾åˆ°Excelæ–‡ä»¶\nNo Excel files found in source folder. Exiting.")
            return False, "åœ¨æºæ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°Excelæ–‡ä»¶"
        log(f"æ‰¾åˆ° {total_files} ä¸ªExcelæ–‡ä»¶\nFound {total_files} Excel files")
        log(f"ç›®æ ‡å‘¨æœŸ: {start_of_period.strftime('%Y-%m-%d')} åˆ° {end_of_period.strftime('%Y-%m-%d')}")
        log(f"ğŸ” å°ˆæ³¨æ–¼æœ¬é€±è¨‚å–®ï¼Œå¿½ç•¥å…¶ä»–é€±æœŸ")

        # 1. æ‰¾å‡ºæ‰€æœ‰æœ‰é»ƒè‰²æ¨™è¨˜çš„ (é–€å¸‚, å» å•†) sheet
        supplier_to_outlets = {}  # supplier: set(outlet)
        for filename in files:
            filepath = os.path.join(source_folder, filename)
            try:
                wb = openpyxl.load_workbook(filepath, data_only=True)
                for sheetname in wb.sheetnames:
                    ws = wb[sheetname]
                    # è·³ééš±è— sheet
                    if hasattr(ws, 'sheet_state') and ws.sheet_state != "visible":
                        continue
                    found_yellow = False
                    for row in ws.iter_rows():
                        for cell in row:
                            fill = cell.fill
                            if fill and fill.fgColor and hasattr(fill.fgColor, 'rgb'):
                                rgb = fill.fgColor.rgb
                                if isinstance(rgb, str) and (rgb.upper() == 'FFFFFF00' or rgb.upper() == 'FFFF00'):
                                    found_yellow = True
                                    break
                        if found_yellow:
                            break
                    if found_yellow:
                        supplier_to_outlets.setdefault(sheetname, set()).add(filepath)
                        log(f"âœ… {filename} ç™¼ç¾é»ƒè‰²æ¨™è¨˜: {sheetname}")
                wb.close()
            except Exception as e:
                log(f"âŒ æª¢æŸ¥ {filename} ç™¼ç”ŸéŒ¯èª¤: {e}")
        log("")
        log(f"ğŸ“Š çµ±è¨ˆçµæœ:")
        log(f"   - ç¸½æª”æ¡ˆæ•¸: {len(files)}")
        log(f"   - æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†: {len(supplier_to_outlets)}")
        log("")
        if not supplier_to_outlets:
            log("âŒ æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†")
            return False, "æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†"
        log(f"ğŸ“‹ æº–å‚™æ•´åˆä»¥ä¸‹å» å•†:")
        for supplier in supplier_to_outlets:
            log(f"   - {supplier}")
        log("")
        # 2. ä»¥å» å•†ç‚ºå–®ä½åˆä½µæ‰€æœ‰æœ‰é»ƒè‰²æ¨™è¨˜çš„é–€å¸‚çš„è©²å» å•† sheetï¼ˆç”¨ xlwings è¤‡è£½ sheetï¼Œä¿ç•™æ ¼å¼/å…¬å¼ï¼‰
        supplier_files = []
        for supplier, filelist in supplier_to_outlets.items():
            try:
                supplier_path = os.path.join(supplier_folder, f"{supplier}_Amendment_{now.isocalendar()[1]}.xlsx")
                # å…ˆå»ºç«‹ç©ºæª”æ¡ˆ
                if not os.path.exists(supplier_path):
                    from openpyxl import Workbook
                    wb = Workbook()
                    wb.save(supplier_path)
                app = xw.App(visible=False)
                try:
                    wb_dest = app.books.open(supplier_path)
                    for src_file in filelist:
                        try:
                            wb_src = app.books.open(src_file)
                            if supplier in [sht.name for sht in wb_src.sheets]:
                                sht = wb_src.sheets[supplier]
                                dest_sheet_name = os.path.splitext(os.path.basename(src_file))[0]
                                # åˆªé™¤åŒååˆ†é 
                                for s in wb_dest.sheets:
                                    if s.name == dest_sheet_name:
                                        s.delete()
                                sht.api.Copy(Before=wb_dest.sheets[0].api)
                                wb_dest.sheets[0].name = dest_sheet_name
                            wb_src.close()
                        except Exception as e:
                            log(f"    âŒ Failed to copy {supplier} in {os.path.basename(src_file)}: {str(e)}\n{traceback.format_exc()}")
                    wb_dest.save()
                    wb_dest.close()
                    supplier_files.append(os.path.basename(supplier_path))
                    log(f"  âœ… å·²æ•´åˆ: {os.path.basename(supplier_path)}")
                finally:
                    app.quit()
            except Exception as e:
                log(f"âŒ æ•´åˆ {supplier} ç™¼ç”ŸéŒ¯èª¤: {e}\n{traceback.format_exc()}")
        result_text = f"\nğŸ¯ æœ¬é€±è¨‚å–®æ•´åˆå®Œæˆ / Amendment Order Integration Complete:\n"
        result_text += f"ğŸ“¦ å·²è™•ç†ä¾›æ‡‰å•†æ–‡ä»¶: {len(supplier_files)}\n"
        result_text += f"ğŸ“… ç›®æ¨™é€±æœŸ: {this_monday.strftime('%Y-%m-%d')} åˆ° {this_sunday.strftime('%Y-%m-%d')}\n\n"
        result_text += "ğŸ“‹ ä¾›æ‡‰å•†æ–‡ä»¶åˆ—è¡¨:\n" + "\n".join([f"  âœ… {file}" for file in supplier_files])
        log(result_text)
        try:
            with open(save_path, "w", encoding="utf-8") as logfile:
                logfile.writelines(log_lines)
            log(f"\nLog saved at: {save_path}")
            return True, f"Amendment Order æ•´åˆå®Œæˆï¼\n\næ—¥å¿—æ–‡ä»¶ä¿å­˜è‡³:\n{save_path}\n\n{result_text}"
        except Exception as e:
            log(f"âŒ Failed to write log file: {e}")
            return False, f"Amendment Order æ•´åˆå®Œæˆä½†æ—¥å¿—ä¿å­˜å¤±è´¥:\n{str(e)}"



# ========== è®¢å•è‡ªåŠ¨åŒ–æ ¸å¿ƒ ==========
class OrderAutomation:
    """è®¢å•è‡ªåŠ¨åŒ–å·¥å…·"""
    
    def __init__(self, outlet_config=None):
        # outlet_config: list of dicts with keys 'short_name', 'full_name'
        self.outlet_name_map = {}
        if outlet_config:
            for o in outlet_config:
                full = o.get('full_name', '').strip().lower()
                short = o.get('short_name', '').strip().upper()
                if full:
                    self.outlet_name_map[full] = short
                if short:
                    self.outlet_name_map[short.lower()] = short
    def get_short_code(self, f5val):
        val = (str(f5val) or '').strip().lower()
        if val in self.outlet_name_map:
            return self.outlet_name_map[val]
        # é›™å‘æ¨¡ç³Šæ¯”å°
        for full, short in self.outlet_name_map.items():
            if full in val or val in full:
                return short
            # å–®å­—æ¯”å°
            for word in val.split():
                if word and word in full:
                    return short
        return 'UNKNOWN'

    @staticmethod
    def is_valid_date(cell_value, next_week_start, next_week_end):
        """æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ—¥æœŸ"""
        try:
            if isinstance(cell_value, (int, float)):
                base_date = datetime(1899, 12, 30)
                parsed = base_date + timedelta(days=cell_value)
            else:
                parsed = parse(str(cell_value), fuzzy=True, dayfirst=False)
            # å°æ–¼ Amendment æª”æ¡ˆï¼Œæˆ‘å€‘æ¥å—ä»»ä½•æ—¥æœŸï¼Œä¸é™åˆ¶åœ¨ç‰¹å®šé€±æœŸå…§
            return True  # æš«æ™‚æ¥å—æ‰€æœ‰æ—¥æœŸ
        except:
            return False

    @classmethod
    def find_delivery_date_row(cls, ws, next_week_start, next_week_end, max_rows=200, file_path=None):
        """æŸ¥æ‰¾é€è´§æ—¥æœŸè¡Œ"""
        valid_col_range = range(5, 12)
        invalid_labels = ["total", "total:", "sub-total", "sub-total:", "no. of cartons", "no. of cartons:"]
        found_blocks = []
        for i, row in enumerate(ws.iter_rows(min_row=1, max_row=max_rows)):
            cols = []
            for j, cell in enumerate(row):
                if j not in valid_col_range:
                    continue
                val = cell.value
                if cls.is_valid_date(val, next_week_start, next_week_end):
                    cols.append(j)
            if cols:
                found_blocks.append((i + 1, cols))
        for header_row, cols in found_blocks:
            for row_idx in range(header_row + 1, header_row + 200):
                label_val = ws.cell(row=row_idx, column=5).value
                label = str(label_val).lower().strip() if label_val else ""
                if any(invalid in label for invalid in invalid_labels):
                    continue
                for col_idx in cols:
                    qty_val = ws.cell(row=row_idx, column=col_idx+1).value
                    if isinstance(qty_val, (int, float)) and qty_val > 0:
                        return header_row, cols
        return None, []

    @classmethod
    def run_automation(cls, source_folder, supplier_folder, 
                      outlet_config=None, delivery_config=None,
                      log_callback=None, mapping_callback=None):
        """è¿è¡Œè®¢å•è‡ªåŠ¨åŒ–ï¼ˆä»…ç”Ÿæˆ supplier æ–‡ä»¶ï¼‰"""
        now = datetime.now()
        today = now.date()
        this_monday = today - timedelta(days=today.weekday())
        next_monday = this_monday + timedelta(days=7)
        next_sunday = next_monday + timedelta(days=6)
        start_of_period = datetime.combine(next_monday, datetime.min.time())
        end_of_period = datetime.combine(next_sunday, datetime.max.time())
        save_path = os.path.join(source_folder, f"next_week_order_log_{now.strftime('%Y%m%d_%H%M%S')}.txt")
        log_lines = [f"ğŸ¯ Next Week Order Integration Log\n", f"Scan Start Time: {now}\n", f"Target Week: {start_of_period.date()} to {end_of_period.date()}\n"]
        
        date_validator = DeliveryDateValidator(delivery_config) if delivery_config else None
        
        outlet_mapping = {}
        if outlet_config:
            try:
                outlet_mapping = {o['short_name']: o for o in outlet_config}
                if log_callback:
                    log_callback(f"âœ… å·²åŠ è½½åˆ†åº—é…ç½®: {len(outlet_mapping)} ä¸ªåˆ†åº—")
            except Exception as e:
                if log_callback:
                    log_callback(f"âš ï¸ åˆ†åº—é…ç½®åŠ è½½å¤±è´¥: {str(e)}")
        
        # æ–°å¢ï¼šå»ºç«‹ä¸€å€‹ OrderAutomation å¯¦ä¾‹ç”¨æ–¼ get_short_code
        oa_instance = cls(outlet_config) if outlet_config else cls()
        
        supplier_to_outlets = defaultdict(list)
        
        def log(message, include_timestamp=True):
            timestamp = datetime.now().strftime("%H:%M:%S") if include_timestamp else ""
            log_line = f"[{timestamp}] {message}" if include_timestamp else message
            log_lines.append(log_line + "\n")
            if log_callback:
                log_callback(log_line + "\n")

        files = [f for f in os.listdir(source_folder)
                 if f.endswith((".xlsx", ".xls")) and not f.startswith("~$")]
        total_files = len(files)

        if total_files == 0:
            log("æœªæ‰¾åˆ°Excelæ–‡ä»¶\nNo Excel files found in source folder. Exiting.")
            return False, "åœ¨æºæ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°Excelæ–‡ä»¶"

        log(f"æ‰¾åˆ° {total_files} ä¸ªExcelæ–‡ä»¶\nFound {total_files} Excel files")
        log(f"ç›®æ ‡å‘¨æœŸ: {start_of_period.strftime('%Y-%m-%d')} åˆ° {end_of_period.strftime('%Y-%m-%d')}\nTarget period: {start_of_period.strftime('%Y-%m-%d')} to {end_of_period.strftime('%Y-%m-%d')}")
        log(f"ğŸ” å°ˆæ³¨æ–¼ä¸‹é€±è¨‚å–®ï¼Œå¿½ç•¥å…¶ä»–é€±æœŸ\nğŸ” Focus on next week orders only, ignore other periods")

        for idx, file in enumerate(files):
            full_path = os.path.join(source_folder, file)
            try:
                # log(f"\nå¤„ç†æ–‡ä»¶ {idx+1}/{total_files}: {file}\nProcessing file {idx+1}/{total_files}: {file}")
                wb = load_workbook(full_path, data_only=True)
                # log(f"å·¥ä½œè¡¨: {', '.join(wb.sheetnames)}\nWorksheets: {', '.join(wb.sheetnames)}")
                for sheetname in wb.sheetnames:
                    ws = wb[sheetname]
                    if ws.sheet_state != "visible":
                        continue  # è·³ééš±è—å·¥ä½œè¡¨ä¸ logï¼Œä¸é¡¯ç¤ºä»»ä½•è¨Šæ¯
                    outlet_short = file.split('_')[0].strip() if '_' in file else file.split('.')[0].strip()
                    # log(f"  å·¥ä½œè¡¨: {sheetname}, æ–‡ä»¶ååˆ†åº—ç®€ç§°: '{outlet_short}'\n  Sheet: {sheetname}, Short Name (from filename): '{outlet_short}'")
                    has_order = False
                    week_days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                    for row in range(1, ws.max_row):
                        row_vals = [str(ws.cell(row=row, column=col).value).strip() if ws.cell(row=row, column=col).value else '' for col in range(6, 13)]
                        weekday_count = sum(day in row_vals for day in week_days)
                        if 'Mon' in row_vals and weekday_count >= 3:
                            date_row = row + 1
                            date_cols = []
                            for idx2, col in enumerate(range(6, 13)):
                                val = ws.cell(row=date_row, column=col).value
                                parsed = None
                                try:
                                    if val:
                                        sval = str(val)
                                        if re.match(r"^\d{1,2}-[A-Za-z]{3,}$", sval):
                                            year = start_of_period.year
                                            sval = f"{sval}-{year}"
                                        if isinstance(val, (int, float)):
                                            base_date = datetime(1899, 12, 30)
                                            parsed = base_date + timedelta(days=val)
                                        else:
                                            parsed = parse(sval, fuzzy=True, dayfirst=False)
                                except Exception:
                                    pass
                                if parsed and start_of_period.date() <= parsed.date() <= end_of_period.date():
                                    date_cols.append(col)
                            if date_cols:
                                for r in range(date_row+1, min(date_row+30, ws.max_row+1)):
                                    found_order_this_row = False
                                    for c in date_cols:
                                        val = ws.cell(row=r, column=c).value
                                        if isinstance(val, (datetime,)):
                                            if val.date() > end_of_period.date():
                                                found_order_this_row = True
                                                break
                                        elif isinstance(val, (int, float)) and val > 0:
                                            has_order = True
                                            found_order_this_row = True
                                            break
                                    if found_order_this_row:
                                        break
                            if has_order:
                                break
                    if has_order:
                        # åªè¨˜éŒ„æœ‰è¨‚å–®çš„å» å•†èˆ‡åˆ†åº—ï¼Œä¸è¨˜éŒ„ç´°ç¯€
                        supplier_to_outlets[sheetname].append((outlet_short, full_path, sheetname))
            except Exception as e:
                error_msg = f"âŒ å¤„ç†æ–‡ä»¶å‡ºé”™: {file}\nâŒ Error processing {file}: {str(e)}\n{traceback.format_exc()}"
                log(error_msg)
        
        log("\nğŸ“Š ä¸‹é€±è¨‚å–®æ•´åˆçµæœ / Next Week Order Integration Results:")
        for supplier, outlets in supplier_to_outlets.items():
            outlet_list = [str(o[0]) if o[0] else "UNKNOWN" for o in outlets]
            log(f"  ğŸ“¦ {supplier}: {', '.join(outlet_list)}")
        log(f"\nğŸ¯ åªè™•ç†ä¸‹é€±è¨‚å–®ï¼Œå…± {sum(len(outlets) for outlets in supplier_to_outlets.values())} å€‹é–€å¸‚æœ‰è¨‚å–®")
        log("\nCreating supplier files...")
        supplier_files = []
        import xlwings as xw
        for sheetname, outlet_file_pairs in supplier_to_outlets.items():
            supplier_path = os.path.join(supplier_folder, f"{sheetname}_Week_{now.isocalendar()[1]}.xlsx")
            # å…ˆå»ºç«‹ç©ºæª”æ¡ˆ
            if not os.path.exists(supplier_path):
                from openpyxl import Workbook
                wb = Workbook()
                wb.save(supplier_path)
            app = xw.App(visible=False)
            try:
                wb_dest = app.books.open(supplier_path)
                for outlet, src_file, original_sheet in outlet_file_pairs:
                    try:
                        wb_src = app.books.open(src_file)
                        sht = wb_src.sheets[original_sheet]
                        dest_sheet_name = outlet if outlet else original_sheet
                        # åˆªé™¤åŒååˆ†é 
                        for s in wb_dest.sheets:
                            if s.name == dest_sheet_name:
                                s.delete()
                        sht.api.Copy(Before=wb_dest.sheets[0].api)
                        wb_dest.sheets[0].name = dest_sheet_name
                        wb_src.close()
                        log(f"  âœ… {dest_sheet_name} å·²è¤‡è£½é€² {os.path.basename(supplier_path)}ï¼ˆæ ¼å¼/å…¬å¼å®Œæ•´ä¿ç•™ï¼‰")
                    except Exception as e:
                        log(f"    âŒ Failed to copy {outlet} in {sheetname}: {str(e)}\n{traceback.format_exc()}")
                wb_dest.save()
                wb_dest.close()
                supplier_files.append(os.path.basename(supplier_path))
            finally:
                app.quit()
        result_text = "\nğŸ¯ ä¸‹é€±è¨‚å–®æ•´åˆå®Œæˆ / Next Week Order Integration Complete:\n"
        result_text += f"ğŸ“¦ å·²è™•ç†ä¾›æ‡‰å•†æ–‡ä»¶: {len(supplier_files)}\n"
        result_text += f"ğŸ“… ç›®æ¨™é€±æœŸ: {start_of_period.strftime('%Y-%m-%d')} åˆ° {end_of_period.strftime('%Y-%m-%d')}\n\n"
        result_text += "ğŸ“‹ ä¾›æ‡‰å•†æ–‡ä»¶åˆ—è¡¨:\n" + "\n".join([f"  âœ… {file}" for file in supplier_files])
        log(result_text)
        try:
            with open(save_path, "w", encoding="utf-8") as logfile:
                logfile.writelines(log_lines)
            log(f"\nLog saved at: {save_path}")
            return True, f"è®¢å•æ•´åˆå®Œæˆï¼\n\næ—¥å¿—æ–‡ä»¶ä¿å­˜è‡³:\n{save_path}\n\n{result_text}"
        except Exception as e:
            log(f"âŒ Failed to write log file: {e}")
            return False, f"è®¢å•æ•´åˆå®Œæˆä½†æ—¥å¿—ä¿å­˜å¤±è´¥:\n{str(e)}"

# ========== å¢å¼ºç‰ˆè®¢å•æ£€æŸ¥å™¨ ==========
class EnhancedOrderChecker:
    """ä½¿ç”¨é…ç½®æ–‡ä»¶çš„è®¢å•æ£€æŸ¥å™¨"""
    
    def __init__(self, config_manager=None):
        self.config_manager = config_manager
        # æ–°å¢ï¼šå»ºç«‹ full name/short name/email name normalize æ˜ å°„åˆ° short name
        self.fullname_to_short = {}
        if config_manager and hasattr(config_manager, 'config_path'):
            import pandas as pd
            import os
            config_path = config_manager.config_path if hasattr(config_manager, 'config_path') else None
            if config_path and os.path.exists(config_path):
                try:
                    df = pd.read_excel(config_path, sheet_name=None)
                    outlet_df = None
                    for key in df.keys():
                        if key.strip().lower() == "outlet":
                            outlet_df = df[key]
                            break
                    if outlet_df is not None:
                        for _, row in outlet_df.iterrows():
                            short = str(row.get("Short Name", "")).strip()
                            full = str(row.get("Outlet Full Name", "")).strip()
                            email_name = str(row.get("Name in Email", "")).strip()
                            for n in [short, full, email_name]:
                                n_norm = self._normalize(n)
                                if n and n_norm:
                                    self.fullname_to_short[n_norm] = short
                except Exception as e:
                    print("[EnhancedOrderChecker] Outlet mapping read error:", e)

    @staticmethod
    def _normalize(text):
        """æ ‡å‡†åŒ–æ–‡æœ¬"""
        import re
        if not text:
            return ""
        # åªå»é™¤ç©ºæ ¼ï¼Œä¿ç•™æ‹¬å·å†…å®¹ä»¥åŒºåˆ†ä¸åŒä¾›åº”å•†
        return re.sub(r'[\s]', '', str(text).lower())

    def get_outlet_shortname(self, f5_value):
        """æ™ºèƒ½è·å–åˆ†åº—ç®€ç§°ï¼Œä¼˜å…ˆç”¨ config mapping"""
        import re
        
        if not f5_value or not isinstance(f5_value, str):
            return f"[EMPTY] {f5_value}"
        
        # å…ˆå˜—è©¦å®Œæ•´åŒ¹é…
        n = self._normalize(f5_value)
        if n in self.fullname_to_short:
            return self.fullname_to_short[n]
        
        # è™•ç†åŒ…å«é…é€æ—¥æœŸè³‡è¨Šçš„ F5 å€¼
        # ä¾‹å¦‚: "Sushi Express West Mall (MON,WED,FRI,SAT)" -> "Sushi Express West Mall"
        # ä½†ä¿ç•™åŒ…å«é–€å¸‚ä»£ç¢¼çš„æ‹¬è™Ÿï¼Œå¦‚ "Sushi Takeout CityVibe (GTM)"
        delivery_pattern = r'\s*\([A-Z]{2,4},[A-Z]{2,4},[A-Z]{2,4},[A-Z]{2,4}\)\s*$'
        cleaned_f5 = re.sub(delivery_pattern, '', f5_value.strip())
        
        if cleaned_f5 != f5_value:
            n = self._normalize(cleaned_f5)
            if n in self.fullname_to_short:
                return self.fullname_to_short[n]
        
        # fallback: åŸæœ‰ hardcode/æ­£åˆ™é€»è¾‘ï¼ˆå¯é€‰ï¼‰
        # ... existing code ...
        return f"[UNKNOWN] {f5_value}"

    def run_checklist(self, folder, log_callback=None, as_table=False):
        date_validator = None
        if self.config_manager:
            delivery_schedules = self.config_manager.delivery_schedule
            if delivery_schedules:
                date_validator = DeliveryDateValidator()
                date_validator.schedule = defaultdict(dict)
                for row in delivery_schedules:
                    supplier = row['supplier']
                    outlet = row['outlet_code']
                    days = DeliveryDateValidator().parse_delivery_days(row['delivery_days'])
                    if outlet == "ALL":
                        date_validator.schedule[supplier]['*'] = days
                    else:
                        date_validator.schedule[supplier][outlet] = days
        supplier_keywords = {}
        if self.config_manager:
            for supplier in self.config_manager.suppliers:
                supplier_keywords[supplier["name"]] = [supplier["name"].lower()]
        must_have_outlets = {}
        if self.config_manager:
            for supplier in self.config_manager.suppliers:
                must_have_outlets[supplier["name"]] = self.config_manager.get_required_outlets(supplier["name"])
        try:
            files = [f for f in os.listdir(folder) if f.endswith(".xlsx") and not f.startswith("~$")]
            def file_key(f):
                import re
                base = f.split("_Week_")[0]
                return self._normalize(base)
            normalized_files = {file_key(f): f for f in files}
            output = []
            table = []
            for supplier, keywords in supplier_keywords.items():
                matches = self._find_supplier_file(normalized_files, keywords)
                if not matches:
                    if as_table:
                        table.append({
                            "supplier": supplier,
                            "outlet": "-",
                            "cover_status": "âŒ",
                            "remark": "Supplier file not found"
                        })
                    else:
                        output.append(f"\nâŒ {supplier} - Supplier file not found.")
                    continue
                for match in matches:
                    result, table_rows = self._process_supplier_file(
                        folder, match, must_have_outlets[supplier], 
                        date_validator, log_callback, as_table=True, supplier=supplier
                    )
                if as_table:
                    table.extend(table_rows)
                else:
                    output.extend(result)
            if as_table:
                return table
            return "\n".join(output)
        except Exception as e:
            if as_table:
                return [{"supplier": "-", "outlet": "-", "cover_status": "âŒ", "remark": f"Error: {str(e)}"}]
            return f"âŒ Error running checklist: {str(e)}\n{traceback.format_exc()}"

    @classmethod
    def _find_supplier_file(cls, normalized_files, keywords):
        matches = []
        for k in keywords:
            nk = cls._normalize(k)
            for nf, of in normalized_files.items():
                if nf == nk:
                    matches.append(of)
        if matches:
            return matches
        # ä¸å†åšå”¯ä¸€æ¨¡ç³ŠåŒ¹é…ï¼Œé¿å…è¯¯é…
        return None

    def _process_supplier_file(self, folder, filename, required_outlets, date_validator=None, log_callback=None, as_table=False, supplier=None):
        import os
        from openpyxl import load_workbook
        import tkinter.messagebox as messagebox
        output = []
        table = []
        found = set()
        unidentified = []
        date_errors = []
        unknown_f5 = set()
        try:
            wb = load_workbook(os.path.join(folder, filename), data_only=True)
            for s in wb.sheetnames:
                # è·³è¿‡ sheet åä¸º 'Sheet' æˆ–ç©ºç™½çš„ sheet
                if not s.strip() or s.strip().lower() == 'sheet':
                    continue
                try:
                    f5 = wb[s]["F5"].value
                    code = self.get_outlet_shortname(f5)
                    sheet_name = s.strip().upper()
                    short_name_mismatch = False
                    
                    # è™•ç†ç‰¹æ®Šæƒ…æ³ï¼šå¦‚æœ F5 æ˜ å°„çµæœèˆ‡å·¥ä½œè¡¨åç¨±ä¸åŒï¼Œä½†éƒ½æŒ‡å‘åŒä¸€å€‹é–€å¸‚
                    # ä¾‹å¦‚ï¼šF5â†’BUGIS, Sheetâ†’BJï¼Œä½†éƒ½æŒ‡å‘ SushiPlus Bugis
                    if code != sheet_name and "[UNKNOWN]" not in code and "[EMPTY]" not in code:
                        # æª¢æŸ¥æ˜¯å¦éƒ½æ˜ å°„åˆ°åŒä¸€å€‹é–€å¸‚
                        f5_normalized = self._normalize(f5) if f5 else ""
                        sheet_normalized = self._normalize(sheet_name)
                        
                        # å¦‚æœ F5 æ˜ å°„å’Œå·¥ä½œè¡¨åç¨±éƒ½æŒ‡å‘åŒä¸€å€‹é–€å¸‚ï¼Œå‰‡ä¸è¦–ç‚º mismatch
                        if f5_normalized in self.fullname_to_short and sheet_normalized in self.fullname_to_short:
                            if self.fullname_to_short[f5_normalized] == self.fullname_to_short[sheet_normalized]:
                                short_name_mismatch = False
                            else:
                                short_name_mismatch = True
                        else:
                            short_name_mismatch = True
                    if "[UNKNOWN]" in code or "[EMPTY]" in code:
                        unidentified.append((s, f5))
                        unknown_f5.add(str(f5).strip() if f5 else "[ç©ºç™½]")
                        if as_table:
                            table.append({
                                "supplier": supplier,
                                "outlet": s,
                                "cover_status": "âš ï¸",
                                "remark": f"F5 error: {f5}" + (f"; Short name mismatch: F5â†’{code}, Sheetâ†’{sheet_name}" if short_name_mismatch else "")
                            })
                    else:
                        found.add(code)
                        date_status = "-"
                        remark = ""
                        if date_validator:
                            delivery_date = wb[s]['F8'].value if 'F8' in wb[s] else None
                            if delivery_date:
                                is_valid = date_validator.validate_order(
                                    supplier,
                                    code,
                                    delivery_date,
                                    log_callback
                                )
                                if not is_valid:
                                    date_status = "âŒ"
                                    remark = "Invalid delivery date"
                                    date_errors.append(code)
                                else:
                                    date_status = "âœ”ï¸"
                            else:
                                date_status = "âš ï¸"
                                remark = ""
                        if short_name_mismatch:
                            if remark:
                                remark += "; "
                            remark += f"Short name mismatch: F5â†’{code}, Sheetâ†’{sheet_name}"
                        if as_table:
                            table.append({
                                "supplier": supplier,
                                "outlet": code,
                                "cover_status": "âœ”ï¸",
                                "remark": remark
                            })
                except Exception as e:
                    unidentified.append((s, f"[F5 error: {e}]") )
                    if as_table:
                        table.append({
                            "supplier": supplier,
                            "outlet": s,
                            "cover_status": "âš ï¸",
                            "remark": f"F5 error: {e} (sheet: {s}, file: {filename})"
                        })
            required = set([str(x).strip().upper() for x in required_outlets])
            found = set([str(x).strip().upper() for x in found])
            print(f"[DEBUG] supplier={supplier}")
            print(f"[DEBUG] required={required}")
            print(f"[DEBUG] found={found}")
            print(f"[DEBUG] missing={required - found}")
            print(f"[DEBUG] all sheet names in {filename}: {wb.sheetnames}")
            print(f"[DEBUG] unidentified sheets: {unidentified}")
            print(f"[DEBUG] unknown F5 values: {unknown_f5}")
            print(f"[DEBUG] F5 to code mappings:")
            for s in wb.sheetnames:
                if not s.strip() or s.strip().lower() == 'sheet':
                    continue
                try:
                    f5 = wb[s]["F5"].value
                    code = self.get_outlet_shortname(f5)
                    print(f"  Sheet: {s}, F5: {f5}, Code: {code}")
                except Exception as e:
                    print(f"  Sheet: {s}, F5 Error: {e}")
            
            # æª¢æŸ¥ missing outlet æ˜¯å¦æœ‰å°æ‡‰çš„ sheet ä½† F5 å’Œ sheet name ä¸ä¸€è‡´
            missing_with_sheet_mismatch = set()
            for sheet_name in wb.sheetnames:
                if not sheet_name.strip() or sheet_name.strip().lower() == 'sheet':
                    continue
                sheet_name_upper = sheet_name.strip().upper()
                if sheet_name_upper in required and sheet_name_upper not in found:
                    try:
                        f5 = wb[sheet_name]["F5"].value
                        code = self.get_outlet_shortname(f5)
                        if code != sheet_name_upper and "[UNKNOWN]" not in code and "[EMPTY]" not in code:
                            missing_with_sheet_mismatch.add(sheet_name_upper)
                    except:
                        pass
            
            for o in sorted(required - found):
                if as_table:
                    if o in missing_with_sheet_mismatch:
                        # æœ‰ sheet ä½† F5 å’Œ sheet name ä¸ä¸€è‡´
                        table.append({
                            "supplier": supplier,
                            "outlet": o,
                            "cover_status": "âš ï¸",
                            "remark": f"Short name mismatch: Sheetâ†’{o}"
                        })
                    else:
                        # çœŸæ­£çš„ missing outlet
                        table.append({
                            "supplier": supplier,
                            "outlet": o,
                            "cover_status": "âŒ",
                            "remark": "Missing outlet"
                        })
            if as_table:
                # æ£€æŸ¥ç»“æŸåï¼Œå¼¹çª—æé†’æ‰€æœ‰æœªèƒ½ mapping çš„ F5 å†…å®¹
                if unknown_f5:
                    msg = "ä»¥ä¸‹ F5 å†…å®¹æœªèƒ½è‡ªåŠ¨ mapping åˆ° short nameï¼Œè¯·è¡¥å……åˆ° config çš„ OUTLET sheetï¼š\n" + "\n".join(f"- {f5val}" for f5val in sorted(unknown_f5))
                    try:
                        messagebox.showwarning("æ™ºèƒ½æç¤º/Smart Reminder", msg)
                    except Exception:
                        print("[æ™ºèƒ½æç¤º]", msg)
                return output, table
            # åŸæœ¬æ–‡å­—æŠ¥è¡¨
            output.append(f"\n=== {filename} ===")
            output.append(f"ğŸ“Š Required: {len(required)}, Found: {len(found)}, Missing: {len(required - found)}")
            for o in sorted(required & found):
                output.append(f"âœ”ï¸ {o}")
            for o in sorted(required - found):
                output.append(f"âŒ {o}")
            for s, v in unidentified:
                output.append(f"âš ï¸ {s} => {v}")
            if unknown_f5:
                output.append("[æ™ºèƒ½æç¤º] ä»¥ä¸‹ F5 å†…å®¹æœªèƒ½è‡ªåŠ¨ mapping åˆ° short nameï¼Œè¯·è¡¥å……åˆ° config çš„ OUTLET sheetï¼š")
                for f5val in sorted(unknown_f5):
                    output.append(f"  - {f5val}")
            return output, table
        except Exception as e:
            if as_table:
                return [{"supplier": "-", "outlet": "-", "cover_status": "âŒ", "remark": f"Error: {str(e)}"}]
            return f"âŒ Error running checklist: {str(e)}\n{traceback.format_exc()}"

# ========== å¢å¼ºç‰ˆè®¢å•è‡ªåŠ¨åŒ– ==========
class EnhancedOrderAutomation(OrderAutomation):
    """æ”¯æŒé‚®ä»¶å‘é€çš„è®¢å•è‡ªåŠ¨åŒ–"""
    
    def __init__(self, config_manager=None):
        super().__init__()
        self.config_manager = config_manager
        self.email_sender = EmailSender(config_manager)
    
    def run_automation(self, source_folder, supplier_folder, 
                      log_callback=None, mapping_callback=None, 
                      email_callback=None):
        """è¿è¡Œè‡ªåŠ¨åŒ–æµç¨‹ï¼ˆä»… supplier æ•´åˆï¼‰"""
        success, result = super().run_automation(
            source_folder, supplier_folder, 
            log_callback=log_callback, mapping_callback=mapping_callback
        )
        if not success:
            return success, result
        supplier_files = []
        for file in os.listdir(supplier_folder):
            if file.endswith(".xlsx") and "Week" in file:
                supplier_name = file.split("_")[0]
                supplier_files.append({
                    "path": os.path.join(supplier_folder, file),
                    "supplier": supplier_name
                })
        if self.config_manager and email_callback:
            email_callback(supplier_files)
        return success, result

class YellowHighlightedOrderAutomation(OrderAutomation):
    """åªæ•´åˆæœ‰é»ƒè‰²æ¨™è¨˜çš„è¨‚å–®"""
    
    def __init__(self, config_manager=None):
        super().__init__()
        self.config_manager = config_manager
    
    def has_yellow_highlight(self, ws, row, col):
        """æª¢æŸ¥æŒ‡å®šå–®å…ƒæ ¼æ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜"""
        try:
            cell = ws.cell(row=row, column=col)
            if cell.fill.start_color.rgb:
                fill_color = cell.fill.start_color.rgb
                print(f"[DEBUG] Cell ({row}, {col}) RGB: {fill_color}")
                
                # æª¢æŸ¥å¸¸è¦‹çš„é»ƒè‰² RGB å€¼
                yellow_rgbs = ['FFFF00', 'FFFFFF00', 'FF00FF00', 'FFD966', 'FFF200', 'FFEB9C', 'FFE066', 'FFD700', 'FFE135', 'FFD800', 'FFE100']
                if fill_color in yellow_rgbs:
                    print(f"[DEBUG] âœ… æ‰¾åˆ°æ¨™æº–é»ƒè‰²: {fill_color}")
                    return True
                
                # æ›´å¯¬é¬†çš„é»ƒè‰²æª¢æŸ¥ï¼šR å’Œ G éƒ½å¾ˆé«˜ï¼ŒB å¾ˆä½
                if fill_color.startswith('FF') and len(fill_color) == 8:
                    rgb = fill_color[2:]  # å»æ‰ alpha é€šé“
                    r = int(rgb[0:2], 16)
                    g = int(rgb[2:4], 16)
                    b = int(rgb[4:6], 16)
                    
                    # é»ƒè‰²æ¢ä»¶ï¼šR å’Œ G éƒ½ > 240ï¼ŒB < 50
                    if r > 240 and g > 240 and b < 50:
                        print(f"[DEBUG] âœ… æ‰¾åˆ°å¯¬é¬†é»ƒè‰²: R={r}, G={g}, B={b}")
                        return True
                    
                    # æ›´å¯¬é¬†çš„æ¢ä»¶ï¼šR å’Œ G éƒ½ > 200ï¼ŒB < 100
                    if r > 200 and g > 200 and b < 100:
                        print(f"[DEBUG] âœ… æ‰¾åˆ°éå¸¸å¯¬é¬†é»ƒè‰²: R={r}, G={g}, B={b}")
                        return True
                
                print(f"[DEBUG] âŒ ä¸æ˜¯é»ƒè‰²: {fill_color}")
            else:
                print(f"[DEBUG] Cell ({row}, {col}) æ²’æœ‰å¡«è‰²")
            return False
        except Exception as e:
            print(f"[DEBUG] Error checking yellow highlight: {e}")
            return False
    
    def check_file_has_yellow_highlight(self, filepath, this_week_start, this_week_end):
        """æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜çš„å–®å…ƒæ ¼"""
        try:
            print(f"[DEBUG] é–‹å§‹æª¢æŸ¥æª”æ¡ˆ: {filepath}")
            wb = openpyxl.load_workbook(filepath, data_only=True)
            for sheet_name in wb.sheetnames:
                ws = wb[sheet_name]
                print(f"[DEBUG] æª¢æŸ¥å·¥ä½œè¡¨: {sheet_name}")
                
                # å°‹æ‰¾æ—¥æœŸè¡Œ - ä½¿ç”¨æœ¬é€±æ—¥æœŸç¯„åœ
                date_row_result = self.find_delivery_date_row(ws, this_week_start, this_week_end, file_path=filepath)
                if date_row_result is None or date_row_result[0] is None:
                    print(f"[DEBUG] åœ¨å·¥ä½œè¡¨ {sheet_name} ä¸­æ‰¾ä¸åˆ°æ—¥æœŸè¡Œ")
                    continue
                
                date_row = date_row_result[0]  # å–å¾—è¡Œè™Ÿ
                print(f"[DEBUG] æ‰¾åˆ°æ—¥æœŸè¡Œ: {date_row}")
                
                # æª¢æŸ¥æ—¥æœŸè¡Œä¸‹æ–¹çš„æ•¸é‡å–®å…ƒæ ¼æ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜
                for row in range(date_row + 1, min(date_row + 50, ws.max_row + 1)):
                    # æª¢æŸ¥æ˜¯å¦ç‚ºç”¢å“è¡Œï¼ˆé€šå¸¸æœ‰ç”¢å“åç¨±ï¼‰- ä½¿ç”¨ E æ¬„èˆ‡ find_delivery_date_row ä¸€è‡´
                    product_name = ws.cell(row=row, column=5).value  # E æ¬„ç”¢å“åç¨±
                    if not product_name or str(product_name).strip() == "":
                        continue
                    
                    print(f"[DEBUG] æª¢æŸ¥ç”¢å“è¡Œ: {row}, ç”¢å“: {product_name}")
                    
                    # æª¢æŸ¥æ—¥æœŸæ¬„ä½ï¼ˆé€šå¸¸æ˜¯ F åˆ° L æ¬„ï¼‰
                    for col in range(6, 13):  # F åˆ° L æ¬„
                        cell_value = ws.cell(row=row, column=col).value
                        if cell_value and (isinstance(cell_value, (int, float)) or 
                                         (isinstance(cell_value, str) and cell_value.replace('.', '').isdigit())):
                            print(f"[DEBUG] æª¢æŸ¥æ•¸é‡æ ¼: ({row}, {col}), å€¼: {cell_value}")
                            # å¦‚æœæ•¸é‡ä¸ç‚º0ä¸”æœ‰é»ƒè‰²æ¨™è¨˜
                            if self.has_yellow_highlight(ws, row, col):
                                print(f"[DEBUG] âœ… åœ¨æª”æ¡ˆ {filepath} ä¸­æ‰¾åˆ°é»ƒè‰²æ¨™è¨˜!")
                                wb.close()
                                return True
            wb.close()
            print(f"[DEBUG] âŒ åœ¨æª”æ¡ˆ {filepath} ä¸­æ²’æœ‰æ‰¾åˆ°é»ƒè‰²æ¨™è¨˜")
            return False
        except Exception as e:
            print(f"[DEBUG] Error checking yellow highlight in {filepath}: {e}")
            return False
    
    def run_automation(self, source_folder, supplier_folder, log_callback=None, mapping_callback=None):
        from datetime import datetime, timedelta
        import os
        import openpyxl
        import xlwings as xw
        import traceback

        now = datetime.now()
        today = now.date()
        this_monday = today - timedelta(days=today.weekday())
        this_sunday = this_monday + timedelta(days=6)
        start_of_period = datetime.combine(this_monday, datetime.min.time())
        end_of_period = datetime.combine(this_sunday, datetime.max.time())
        save_path = os.path.join(source_folder, f"yellow_highlight_order_log_{now.strftime('%Y%m%d_%H%M%S')}.txt")
        log_lines = [
            f"ğŸ¯ Amendment Order Integration Log\n",
            f"Scan Start Time: {now}\n",
            f"Target Week: {start_of_period.date()} to {end_of_period.date()}\n"
        ]

        def log(message, include_timestamp=True):
            timestamp = datetime.now().strftime("%H:%M:%S") if include_timestamp else ""
            log_line = f"[{timestamp}] {message}" if include_timestamp else message
            log_lines.append(log_line + "\n")
            if log_callback:
                log_callback(log_line + "\n")

        files = [f for f in os.listdir(source_folder) if f.endswith((".xlsx", ".xls")) and not f.startswith("~$")]
        total_files = len(files)
        if total_files == 0:
            log("æœªæ‰¾åˆ°Excelæ–‡ä»¶\nNo Excel files found in source folder. Exiting.")
            return False, "åœ¨æºæ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°Excelæ–‡ä»¶"
        log(f"æ‰¾åˆ° {total_files} ä¸ªExcelæ–‡ä»¶\nFound {total_files} Excel files")
        log(f"ç›®æ ‡å‘¨æœŸ: {start_of_period.strftime('%Y-%m-%d')} åˆ° {end_of_period.strftime('%Y-%m-%d')}")
        log(f"ğŸ” å°ˆæ³¨æ–¼æœ¬é€±è¨‚å–®ï¼Œå¿½ç•¥å…¶ä»–é€±æœŸ")

        # 1. æ‰¾å‡ºæ‰€æœ‰æœ‰é»ƒè‰²æ¨™è¨˜çš„ (é–€å¸‚, å» å•†) sheet
        supplier_to_outlets = {}  # supplier: set(outlet)
        for filename in files:
            filepath = os.path.join(source_folder, filename)
            try:
                wb = openpyxl.load_workbook(filepath, data_only=True)
                for sheetname in wb.sheetnames:
                    ws = wb[sheetname]
                    # è·³ééš±è— sheet
                    if hasattr(ws, 'sheet_state') and ws.sheet_state != "visible":
                        continue
                    found_yellow = False
                    for row in ws.iter_rows():
                        for cell in row:
                            fill = cell.fill
                            if fill and fill.fgColor and hasattr(fill.fgColor, 'rgb'):
                                rgb = fill.fgColor.rgb
                                if isinstance(rgb, str) and (rgb.upper() == 'FFFFFF00' or rgb.upper() == 'FFFF00'):
                                    found_yellow = True
                                    break
                        if found_yellow:
                            break
                    if found_yellow:
                        supplier_to_outlets.setdefault(sheetname, set()).add(filepath)
                        log(f"âœ… {filename} ç™¼ç¾é»ƒè‰²æ¨™è¨˜: {sheetname}")
                wb.close()
            except Exception as e:
                log(f"âŒ æª¢æŸ¥ {filename} ç™¼ç”ŸéŒ¯èª¤: {e}")
        log("")
        log(f"ğŸ“Š çµ±è¨ˆçµæœ:")
        log(f"   - ç¸½æª”æ¡ˆæ•¸: {len(files)}")
        log(f"   - æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†: {len(supplier_to_outlets)}")
        log("")
        if not supplier_to_outlets:
            log("âŒ æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†")
            return False, "æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†"
        log(f"ğŸ“‹ æº–å‚™æ•´åˆä»¥ä¸‹å» å•†:")
        for supplier in supplier_to_outlets:
            log(f"   - {supplier}")
        log("")
        # 2. ä»¥å» å•†ç‚ºå–®ä½åˆä½µæ‰€æœ‰æœ‰é»ƒè‰²æ¨™è¨˜çš„é–€å¸‚çš„è©²å» å•† sheetï¼ˆç”¨ xlwings è¤‡è£½ sheetï¼Œä¿ç•™æ ¼å¼/å…¬å¼ï¼‰
        supplier_files = []
        for supplier, filelist in supplier_to_outlets.items():
            try:
                supplier_path = os.path.join(supplier_folder, f"{supplier}_Amendment_{now.isocalendar()[1]}.xlsx")
                # å…ˆå»ºç«‹ç©ºæª”æ¡ˆ
                if not os.path.exists(supplier_path):
                    from openpyxl import Workbook
                    wb = Workbook()
                    wb.save(supplier_path)
                app = xw.App(visible=False)
                try:
                    wb_dest = app.books.open(supplier_path)
                    for src_file in filelist:
                        try:
                            wb_src = app.books.open(src_file)
                            if supplier in [sht.name for sht in wb_src.sheets]:
                                sht = wb_src.sheets[supplier]
                                dest_sheet_name = os.path.splitext(os.path.basename(src_file))[0]
                                # åˆªé™¤åŒååˆ†é 
                                for s in wb_dest.sheets:
                                    if s.name == dest_sheet_name:
                                        s.delete()
                                sht.api.Copy(Before=wb_dest.sheets[0].api)
                                wb_dest.sheets[0].name = dest_sheet_name
                            wb_src.close()
                        except Exception as e:
                            log(f"    âŒ Failed to copy {supplier} in {os.path.basename(src_file)}: {str(e)}\n{traceback.format_exc()}")
                    wb_dest.save()
                    wb_dest.close()
                    supplier_files.append(os.path.basename(supplier_path))
                    log(f"  âœ… å·²æ•´åˆ: {os.path.basename(supplier_path)}")
                finally:
                    app.quit()
            except Exception as e:
                log(f"âŒ æ•´åˆ {supplier} ç™¼ç”ŸéŒ¯èª¤: {e}\n{traceback.format_exc()}")
        result_text = f"\nğŸ¯ æœ¬é€±è¨‚å–®æ•´åˆå®Œæˆ / Amendment Order Integration Complete:\n"
        result_text += f"ğŸ“¦ å·²è™•ç†ä¾›æ‡‰å•†æ–‡ä»¶: {len(supplier_files)}\n"
        result_text += f"ğŸ“… ç›®æ¨™é€±æœŸ: {this_monday.strftime('%Y-%m-%d')} åˆ° {this_sunday.strftime('%Y-%m-%d')}\n\n"
        result_text += "ğŸ“‹ ä¾›æ‡‰å•†æ–‡ä»¶åˆ—è¡¨:\n" + "\n".join([f"  âœ… {file}" for file in supplier_files])
        log(result_text)
        try:
            with open(save_path, "w", encoding="utf-8") as logfile:
                logfile.writelines(log_lines)
            log(f"\nLog saved at: {save_path}")
            return True, f"Amendment Order æ•´åˆå®Œæˆï¼\n\næ—¥å¿—æ–‡ä»¶ä¿å­˜è‡³:\n{save_path}\n\n{result_text}"
        except Exception as e:
            log(f"âŒ Failed to write log file: {e}")
            return False, f"Amendment Order æ•´åˆå®Œæˆä½†æ—¥å¿—ä¿å­˜å¤±è´¥:\n{str(e)}"

# ========== ä¸»åº”ç”¨ç¨‹åº ==========
class SushiExpressApp(ctk.CTk):
    """ä¸»åº”ç”¨ç¨‹åº"""
    
    def __init__(self):
        super().__init__()
        self.title(f"Sushi Express Automation Tool v{VERSION}")
        self.geometry("1400x900")
        self.minsize(1200,800)
        self.configure(fg_color=DARK_BG)
        self.iconbitmap(resource_path("SELOGO22 - 01.ico"))
        self.protocol("WM_DELETE_WINDOW", self._on_close)
        # åˆå§‹åŒ–æ‰€æœ‰ç”¨åˆ°çš„ StringVar
        self.download_folder_var = ctk.StringVar()
        self.config_file_var = ctk.StringVar()
        self.checklist_folder_var = ctk.StringVar()
        self.master_config_var = ctk.StringVar()
        self.folder_vars = {}
        self.master_file_var = ctk.StringVar()
        self.output_folder_var = ctk.StringVar()
        self.email_supplier_folder_var = ctk.StringVar()
        self.email_master_config_var = ctk.StringVar()
        self.source_folder_var = ctk.StringVar()  # æ·»åŠ ç¼ºå¤±çš„å±æ€§
        self.supplier_folder_var = ctk.StringVar()  # æ·»åŠ ç¼ºå¤±çš„å±æ€§
        self.append_outlet_files_var = ctk.StringVar()  # æ·»åŠ ç¼ºå¤±çš„å±æ€§
        self.append_supplier_folder_var = ctk.StringVar()  # æ·»åŠ ç¼ºå¤±çš„å±æ€§
        self.summary_supplier_files_var = ctk.StringVar()  # æ·»åŠ ç¼ºå¤±çš„å±æ€§
        self.progress_popup = None
        self.mapping_popup = None
        self.outlet_config_var = ctk.StringVar()
        self.email_dialogs = []
        self.current_function = None
        self.nav_buttons = {}
        self.selected_outlook_account_idx = None
        self.checklist_search_var = ctk.StringVar()
        self._setup_ui()
        self.show_login()
    
    def _setup_ui(self):
        self.main_container = ctk.CTkFrame(self, fg_color="transparent")
        self.main_container.pack(fill="both", expand=True, padx=20, pady=20)

        # å·¦å´å°èˆªæ¬„
        self.nav_frame = ctk.CTkFrame(
            self.main_container,
            fg_color=DARK_PANEL,
            corner_radius=24,
            width=300
        )
        self.nav_frame.pack(side="left", fill="y", padx=(0, 10), pady=10)
        self.nav_frame.pack_propagate(False)

        # åŠ å…¥ LOGO
        logo_img = load_image(LOGO_PATH, max_size=(220, 80))
        if logo_img:
            logo_label = ctk.CTkLabel(self.nav_frame, image=logo_img, text="")
            logo_label.image = logo_img  # é˜²æ­¢è¢«åƒåœ¾å›æ”¶
            logo_label.pack(pady=(18, 8))

        nav_title = ctk.CTkLabel(
            self.nav_frame,
            text="åŠŸèƒ½èœå•\nFunction Menu",
            font=FONT_TITLE,
            text_color=ACCENT_BLUE,
            justify="center"
        )
        nav_title.pack(pady=20)
        ctk.CTkFrame(self.nav_frame, height=2, fg_color=ACCENT_BLUE).pack(fill="x", padx=20, pady=10)

        # æŒ‰éˆ•å®¹å™¨
        self.button_container = ctk.CTkFrame(self.nav_frame, fg_color="transparent")
        self.button_container.pack(fill="both", expand=True, padx=10, pady=10)

        # å³å´å…§å®¹å€
        self.content_container = ctk.CTkFrame(
            self.main_container,
            fg_color=DARK_PANEL,
            corner_radius=24
        )
        self.content_container.pack(side="right", fill="both", expand=True, padx=10, pady=10)
        self.content_container.pack_propagate(False)

        # å³å´å…§å®¹å€çš„æ¨™é¡Œå€åŸŸ
        self.content_header = ctk.CTkFrame(self.content_container, fg_color="transparent")
        self.content_header.pack(fill="x", padx=20, pady=20)

        self.function_title = ctk.CTkLabel(
            self.content_header, 
            text="", 
            font=FONT_TITLE,
            text_color=ACCENT_BLUE
        )
        self.function_title.pack(side="left")
        
        self.function_subtitle = ctk.CTkLabel(
            self.content_header, 
            text="", 
            font=FONT_SUB,
            text_color=TEXT_COLOR
        )
        self.function_subtitle.pack(side="left", padx=20)
        
        # å³ä¾§å†…å®¹åŒºçš„ä¸»ä½“
        self.content_body = ctk.CTkFrame(self.content_container, fg_color="transparent")
        self.content_body.pack(fill="both", expand=True, padx=20, pady=20)
        
        # æ·»åŠ è¿”å›ä¸»èœå•æŒ‰é’®
        back_frame = ctk.CTkFrame(self.content_container, fg_color="transparent")
        back_frame.pack(fill="x", padx=20, pady=10)
        ctk.CTkButton(
            back_frame, 
            text="è¿”å›ä¸»èœå•\nBack to Main Menu", 
            command=self.show_main_menu,
            fg_color=ACCENT_PURPLE,
            hover_color=BTN_HOVER
        ).pack(side="right")
    
    def _on_close(self):
        print("on_close called")
        self.destroy()
    
    def show_login(self):
        """æ˜¾ç¤ºç™»å½•ç•Œé¢"""
        for w in self.content_container.winfo_children():
            if w != self.content_header and w != self.content_body:
                w.destroy()
        
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()
        
        # åˆ›å»ºç™»å½•ç•Œé¢
        login_frame = ctk.CTkFrame(
            self.content_body, 
            fg_color=DARK_PANEL, 
            corner_radius=24,
            width=450, 
            height=400
        )
        login_frame.place(relx=0.5, rely=0.5, anchor="center")
        
        self.pwd_entry = ctk.CTkEntry(
            login_frame, 
            show="*", 
            font=FONT_MID,  # æ”¹æˆè¼ƒå°å­—é«”
            width=300, 
            placeholder_text=t("password"), 
            fg_color=ENTRY_BG, 
            height=45
        )
        self.pwd_entry.pack(pady=(40,20))
        self.pwd_entry.bind("<Return>", lambda e: self._try_login())
        
        ctk.CTkButton(
            login_frame, 
            text=t("login_btn"), 
            command=self._try_login, 
            width=200,
            font=FONT_BIGBTN
        ).pack(pady=(0,20))
        
        ctk.CTkLabel(
            login_frame, 
            text=f"Version {VERSION} | {DEVELOPER}", 
            font=FONT_MID,
            text_color="#64748B"
        ).pack(side="bottom", pady=10)
        
        # è®¾ç½®æ ‡é¢˜
        self.function_title.configure(text="ç³»ç»Ÿç™»å½•\nSystem Login", font=FONT_TITLE)
        self.function_subtitle.configure(text="è¯·è¾“å…¥å¯†ç é€²å…¥ç³»ç»Ÿ\nPlease enter password to access the system", font=FONT_MID)
    
    def _try_login(self):
        """å°è¯•ç™»å½•"""
        if self.pwd_entry.get() == PASSWORD:
            self.show_main_menu()
        else:
            messagebox.showerror(t("error"), t("incorrect_pw"))
    
    def show_main_menu(self):
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®æ ‡é¢˜
        self.function_title.configure(text=t("main_title"))
        self.function_subtitle.configure(text=t("select_function"))

        # åˆ›å»ºæ¬¢è¿ç•Œé¢
        welcome_frame = ctk.CTkFrame(self.content_body, fg_color="transparent")
        welcome_frame.pack(fill="both", expand=True, padx=50, pady=50)

        welcome_text = (
            "æ¬¢è¿ä½¿ç”¨Sushi Express è‡ªåŠ¨åŒ–å·¥å…·\n"
            "Welcome to Sushi Express Automation Tool\n\n"
            "è¯·ä»å·¦ä¾§èœå•é€‰æ‹©æ‚¨éœ€è¦çš„åŠŸèƒ½\n"
            "Please select a function from the left menu"
        )

        ctk.CTkLabel(
            welcome_frame,
            text=welcome_text,
            font=FONT_MID,
            text_color=TEXT_COLOR,
            justify="center"
        ).pack(expand=True)

        # **æ¯æ¬¡éƒ½é‡å»ºæŒ‰éˆ•**
        self._create_navigation_buttons()
    
    def _create_navigation_buttons(self):
        for widget in self.button_container.winfo_children():
            widget.destroy()
        inner_frame = ctk.CTkFrame(self.button_container, fg_color="transparent")
        inner_frame.pack(expand=True)
        functions = [
            ("download_title", self.show_download_ui, ACCENT_BLUE),
            ("automation_title", self.show_automation_ui, ACCENT_GREEN),
            ("checklist_title", self.show_checklist_ui, ACCENT_PURPLE),
            ("send_emails", self.show_email_sending_ui, ACCENT_RED),
            ("operation_supplies", self.show_operation_supplies_ui, "#F97316"),
            ("exit_system", self._on_close, "#64748B")
        ]
        for func_key, command, color in functions:
            btn = NavigationButton(
                inner_frame,
                text=t(func_key),
                command=command if func_key == "exit_system" else lambda c=command, k=func_key: self._select_function(c, k),
                fg_color=DARK_PANEL,
                anchor="center",
                border_width=2,
                border_color=ACCENT_BLUE,
                corner_radius=10,
                font=FONT_BIGBTN,
                text_color=get_contrast_color(DARK_PANEL),
                height=50
            )
            btn.pack(fill="x", pady=7, padx=10)
            self.nav_buttons[func_key] = btn
        # æ–°å¢ï¼šç”¨æˆ¶æŒ‡å—æŒ‰éˆ•
        help_btn = NavigationButton(
            inner_frame,
            text="ç”¨æˆ·æŒ‡å—\nUser Guide",
            command=self.show_user_guide,
            fg_color=ACCENT_PURPLE,
            anchor="center",
            border_width=2,
            border_color=ACCENT_PURPLE,
            corner_radius=10,
            font=FONT_BIGBTN,
            text_color=get_contrast_color(ACCENT_PURPLE),
            height=50
        )
        help_btn.pack(fill="x", pady=7, padx=10)
    
    def _select_function(self, command, func_key):
        """é€‰æ‹©åŠŸèƒ½"""
        # å–æ¶ˆä¹‹å‰é€‰ä¸­çš„æŒ‰é’®
        if self.current_function:
            self.nav_buttons[self.current_function].deselect()
        
        # é€‰ä¸­å½“å‰æŒ‰é’®
        self.nav_buttons[func_key].select()
        self.current_function = func_key
        
        # æ‰§è¡ŒåŠŸèƒ½
        command()
    
    def _show_function_ui(self, title_key, subtitle_key, content_callback):
        """æ˜¾ç¤ºåŠŸèƒ½ç•Œé¢"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()
        
        # è®¾ç½®æ ‡é¢˜
        self.function_title.configure(text=t(title_key))
        # å‰¯æ¨™é¡Œçµ±ä¸€æ”¾å¤§
        if isinstance(subtitle_key, tuple):
            text = subtitle_key[0]
        else:
            text = t(subtitle_key)
        self.function_subtitle.configure(text=text, font=FONT_TITLE)
        
        # åˆ›å»ºå†…å®¹æ¡†æ¶
        content_frame = ctk.CTkFrame(self.content_body, fg_color="transparent")
        content_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        # æ„å»ºåŠŸèƒ½UI
        content_callback(content_frame)
    
    # ä¸‹é¢æ˜¯å„ä¸ªåŠŸèƒ½ç•Œé¢çš„ä¿®æ”¹ï¼Œåªéœ€è¦å°†åŸæ¥çš„show_xxx_uiæ–¹æ³•æ”¹ä¸ºä½¿ç”¨_show_function_ui

    def show_download_ui(self):
        """æ˜¾ç¤ºä¸‹è½½ç•Œé¢"""
        def build(c):
            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(fill="both", expand=True, padx=50, pady=20)

            # ä¸‹è½½æ–‡ä»¶å¤¹
            row1 = ctk.CTkFrame(form_frame)
            row1.pack(fill="x", pady=15)
            ctk.CTkLabel(row1, text="ä¸‹è½½æ–‡ä»¶å¤¹\nDownload Folder:", font=FONT_MID, anchor="w", justify="left").pack(side="left", padx=10)
            ctk.CTkEntry(row1, textvariable=self.download_folder_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
            browse_btn = ctk.CTkButton(
                row1,
                text="æµè§ˆ...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=self._select_download_folder,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn.pack(side="left", padx=5)

            # åˆ†åº—é…ç½®æ–‡ä»¶
            row2 = ctk.CTkFrame(form_frame)
            row2.pack(fill="x", pady=15)
            ctk.CTkLabel(row2, text="åˆ†åº—é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰\nOutlet Config (Optional):", font=FONT_MID, anchor="w", justify="left").pack(side="left", padx=10)
            ctk.CTkEntry(row2, textvariable=self.config_file_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
            browse_btn2 = ctk.CTkButton(
                row2,
                text="æµè§ˆ...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=self._select_config_file,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn2.pack(side="left", padx=5)

            # å¼€å§‹ä¸‹è½½æŒ‰é’®
            btn_frame = ctk.CTkFrame(c, fg_color="transparent")
            btn_frame.pack(pady=30)

            # ä¸»è¦ä¸‹è¼‰æŒ‰éˆ•
            GlowButton(
                btn_frame,
                text="é–‹å§‹ä¸‹è¼‰\nStart Download",
                command=self._run_download,
                glow_color=ACCENT_BLUE
            ).pack(fill="x", expand=True, padx=10, pady=5)

            # Amendment ä¸‹è¼‰æŒ‰éˆ•
            GlowButton(
                btn_frame,
                text="ä¸‹è¼‰ Amendment\nDownload Amendments",
                command=self._run_download_amendments,
                glow_color="#ef4444"
            ).pack(fill="x", expand=True, padx=10, pady=5)

            # æŸ¥çœ‹é‚®ä»¶å†…å®¹æŒ‰é’®
            def show_extracted_bodies():
                from tkinter import messagebox
                import os
                import tkinter as tk
                folder = self.download_folder_var.get()
                week_no = datetime.now().isocalendar()[1]
                save_path = os.path.join(folder, f"Week_{week_no}")
                log_file = os.path.join(save_path, "email_bodies_log.txt")
                bodies = getattr(OutlookDownloader, 'extracted_bodies', [])
                if not bodies and os.path.exists(log_file):
                    with open(log_file, "r", encoding="utf-8") as f:
                        content = f.read()
                    bodies = content.split("\n\nâ€”â€”â€” é‚®ä»¶ ") if content else []
                    if bodies and not bodies[0].startswith("â€”â€”â€” é‚®ä»¶ "):
                        bodies[0] = "â€”â€”â€” é‚®ä»¶ 1 â€”â€”â€”\n" + bodies[0]
                    bodies = [b if b.startswith("â€”â€”â€” é‚®ä»¶ ") else "â€”â€”â€” é‚®ä»¶ " + b for b in bodies]
                if not bodies:
                    messagebox.showinfo("æ— å†…å®¹", "è¯·å…ˆä¸‹è½½é‚®ä»¶ï¼Œå†æŸ¥çœ‹é‚®ä»¶å†…å®¹ï¼")
                    return
                # åˆ›å»ºæ˜¾ç¤ºçª—å£
                win = tk.Toplevel(self)
                win.title("é‚®ä»¶å†…å®¹æå–ç»“æœ/Extracted Email Bodies")
                win.geometry("900x700")
                from tkinter import scrolledtext
                text_widget = scrolledtext.ScrolledText(win, wrap="word", font=("Microsoft JhengHei", 14), bg="#f1f5f9", fg="#22292f")
                text_widget.pack(fill="both", expand=True, padx=10, pady=10)
                content = "\n\n".join(bodies)
                text_widget.insert("1.0", content)
                text_widget.configure(state="disabled")

            GlowButton(
                btn_frame,
                text="æŸ¥çœ‹é‚®ä»¶å†…å®¹\nCheck Email Bodies",
                command=show_extracted_bodies,
                width=300,
                height=48,
                glow_color=ACCENT_GREEN
            ).pack(pady=10)

        self._show_function_ui(
            "download_title",
            "download_desc",
            build
        )

    def show_checklist_ui(self):
        """æ˜¾ç¤ºæ£€æŸ¥è¡¨ç•Œé¢"""
        def build(c):
            self.checklist_folder_var = ctk.StringVar()
            self.master_config_var = ctk.StringVar()
            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(fill="both", expand=True, padx=50, pady=5)
            # è®¢å•æ–‡ä»¶å¤¹
            row1 = ctk.CTkFrame(form_frame)
            row1.pack(fill="x", pady=5)
            ctk.CTkLabel(row1, text="è¨‚å–®æ–‡ä»¶å¤¾\nOrder Folder:", font=FONT_BIGBTN).pack(side="left", padx=10)
            ctk.CTkEntry(row1, textvariable=self.checklist_folder_var, font=FONT_MID, state="readonly", width=250).pack(side="left", expand=True, fill="x", padx=5)
            checklist_browse_btn = ctk.CTkButton(
                row1, 
                text=str(t("browse")), 
                font=("Microsoft YaHei", 11, "bold"),
                command=self._select_checklist_folder,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            checklist_browse_btn.pack(side="left", padx=5)
            # ç»Ÿä¸€é…ç½®æ–‡ä»¶
            row3 = ctk.CTkFrame(form_frame)
            row3.pack(fill="x", pady=5)
            ctk.CTkLabel(row3, text="çµ±ä¸€é…ç½®æ–‡ä»¶\nMaster Config (Excel):", font=FONT_BIGBTN).pack(side="left", padx=10)
            ctk.CTkEntry(row3, textvariable=self.master_config_var, font=FONT_MID, state="readonly", width=250).pack(side="left", expand=True, fill="x", padx=5)
            checklist_config_browse_btn = ctk.CTkButton(
                row3, 
                text="ç€è¦½...\nBrowse...", 
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_config_file(self.master_config_var, [("Excel files", "*.xlsx")]),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            checklist_config_browse_btn.pack(side="left", padx=5)
            # æœç´¢å€ï¼ˆæ°¸é é¡¯ç¤ºï¼‰
            search_frame = ctk.CTkFrame(c, fg_color="transparent")
            search_frame.pack(fill="x", pady=5)
            # ç§»é™¤æœå°‹ç¯„åœä¸‹æ‹‰é¸å–®
            # if not hasattr(self, 'checklist_search_scope_var'):
            #     self.checklist_search_scope_var = ctk.StringVar(value="å…¨éƒ¨")
            # scope_options = ["å…¨éƒ¨", "ä¾›æ‡‰å•†", "åˆ†åº—"]
            # scope_menu = ctk.CTkOptionMenu(search_frame, variable=self.checklist_search_scope_var, values=scope_options, width=90, font=FONT_MID)
            # scope_menu.pack(side="left", padx=4)
            # Supplier ä¸‹æ‹‰é¸å–®
            if not hasattr(self, 'checklist_supplier_filter_var'):
                self.checklist_supplier_filter_var = ctk.StringVar(value="å…¨éƒ¨")
            if not hasattr(self, 'checklist_outlet_filter_var'):
                self.checklist_outlet_filter_var = ctk.StringVar(value="å…¨éƒ¨")
            def get_unique_suppliers():
                return ["å…¨éƒ¨"] + sorted(list({row["supplier"] for row in getattr(self, '_checklist_table_data', []) if row["supplier"]}))
            def get_unique_outlets():
                return ["å…¨éƒ¨"] + sorted(list({row["outlet"] for row in getattr(self, '_checklist_table_data', []) if row["outlet"]}))
            ctk.CTkLabel(search_frame, text="Supplier", font=("Microsoft JhengHei", 16, "bold"), text_color="#3b82f6").pack(side="left", padx=(0,2))
            self.supplier_menu = ctk.CTkOptionMenu(
                search_frame, variable=self.checklist_supplier_filter_var, values=get_unique_suppliers(), width=140, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#3b82f6", button_color="#3b82f6", button_hover_color="#2563eb", text_color="#fff", corner_radius=16,
                command=lambda _: self._filter_checklist_table())
            self.supplier_menu.pack(side="left", padx=4)
            ctk.CTkLabel(search_frame, text="Outlet", font=("Microsoft JhengHei", 16, "bold"), text_color="#3b82f6").pack(side="left", padx=(10,2))
            self.outlet_menu = ctk.CTkOptionMenu(
                search_frame, variable=self.checklist_outlet_filter_var, values=get_unique_outlets(), width=140, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#3b82f6", button_color="#3b82f6", button_hover_color="#2563eb", text_color="#fff", corner_radius=16,
                command=lambda _: self._filter_checklist_table())
            self.outlet_menu.pack(side="left", padx=4)
            ctk.CTkLabel(search_frame, text="æœç´¢/Filter:", font=("Microsoft JhengHei", 15, "bold"), text_color="#3b82f6").pack(side="left", padx=6)
            if not hasattr(self, 'checklist_search_var'):
                self.checklist_search_var = ctk.StringVar()
            search_entry = ctk.CTkEntry(search_frame, textvariable=self.checklist_search_var, font=("Microsoft JhengHei", 14), width=180, corner_radius=10, border_width=2, border_color="#3b82f6")
            search_entry.pack(side="left", padx=4)
            search_entry.bind("<KeyRelease>", lambda e: self._filter_checklist_table())
            def set_search_keyword(keyword):
                self.checklist_search_var.set(keyword)
                self._filter_checklist_table()
            ctk.CTkButton(
                search_frame, text="Missing", width=90, height=34, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#2563eb", hover_color="#60a5fa", text_color="#fff", corner_radius=16, border_width=2, border_color="#fff",
                command=lambda: set_search_keyword("missing")
            ).pack(side="left", padx=6)
            ctk.CTkButton(
                search_frame, text="Mismatch", width=100, height=34, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#f59e42", hover_color="#fbbf24", text_color="#fff", corner_radius=16, border_width=2, border_color="#fff",
                command=lambda: set_search_keyword("mismatch")
            ).pack(side="left", padx=6)
            # è¡¨æ ¼å€ï¼ˆæ°¸é é¡¯ç¤ºï¼Œæ²’è³‡æ–™æ™‚é¡¯ç¤ºç©ºè¡¨æ ¼ï¼‰
            table_frame = ctk.CTkFrame(c, fg_color="transparent")
            table_frame.pack(fill="both", expand=True, padx=10, pady=10)
            import tkinter.ttk as ttk
            style = ttk.Style()
            style.theme_use('default')
            style.configure("Custom.Treeview", background="#1e293b", fieldbackground="#1e293b", foreground="#e2e8f0", rowheight=28, font=("Microsoft JhengHei", 12))
            style.configure("Custom.Treeview.Heading", background="#334155", foreground="#60a5fa", font=("Microsoft JhengHei", 13, "bold"))
            style.map("Custom.Treeview", background=[('selected', '#334155')])
            if not hasattr(self, 'checklist_table'):
                self.checklist_table = None
            self.checklist_table = ttk.Treeview(
                table_frame, 
                columns=("supplier", "outlet", "cover_status", "remark"), 
                show="headings", 
                height=8,
                style="Custom.Treeview"
            )
            col_labels = [
                ("supplier", "ä¾›æ‡‰å•†/Supplier"),
                ("outlet", "åˆ†åº—/Outlet"),
                ("cover_status", "è¦†è“‹ç‹€æ…‹/Cover"),
                ("remark", "å‚™è¨»/Remark")
            ]
            for col, label in col_labels:
                self.checklist_table.heading(col, text=label)
                self.checklist_table.column(col, width=140 if col!="remark" else 300, anchor="center")
            self.checklist_table.pack(fill="both", expand=True)
            self.checklist_table.bind("<Double-1>", self._on_checklist_row_double_click)
            # è¤‡è£½/åŒ¯å‡ºæŒ‰éˆ•ï¼ˆæ°¸é é¡¯ç¤ºï¼‰
            btn_frame = ctk.CTkFrame(c, fg_color="transparent")
            btn_frame.pack(pady=10)
            btns = [
                ("åŒ¯å‡ºExcel\nExport Excel", self._export_checklist_table, "#10b981"),
                ("æŸ¥çœ‹å¿…è¦é–€å¸‚\nView Required Outlets", self._show_required_outlets_window, "#8b5cf6"),
                ("äº¤å‰æª¢æŸ¥\nCross Check", self._run_cross_check_email_log, "#f59e42"),
            ]
            for txt, cmd, color in btns:
                GlowButton(
                    btn_frame,
                    text=txt,
                    command=cmd,
                    width=90,
                    height=28,
                    glow_color=color
                ).pack(side="left", padx=4, pady=2)
            for col in range(2):
                btn_frame.grid_columnconfigure(col, weight=1)
            # Run Check æŒ‰éˆ•ï¼ˆå¤§ã€ä¸­æ–‡åœ¨ä¸Šè‹±æ–‡åœ¨ä¸‹ï¼Œç½®ä¸­ï¼Œæ°¸é é¡¯ç¤ºï¼‰
            run_btn_frame = ctk.CTkFrame(c, fg_color="transparent")
            run_btn_frame.pack(fill="x", pady=15)
            GlowButton(
                run_btn_frame,
                text="åŸ·è¡Œæª¢æŸ¥\nRun Check",
                command=self._run_enhanced_checklist,
                width=200,
                height=56,
                glow_color="#a78bfa"
            ).pack(anchor="center")
            # åˆå§‹åŒ–è¡¨æ ¼æ•¸æ“š
            if not hasattr(self, '_checklist_table_data'):
                self._checklist_table_data = []
            self._refresh_checklist_table()
        
        self._show_function_ui(
            "checklist_title", 
            "checklist_desc", 
            build
        )
    def _run_enhanced_checklist(self):
        folder = self.checklist_folder_var.get()
        master_config = self.master_config_var.get()
        if not folder or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
        config_mgr = UnifiedConfigManager(master_config)
        checker = EnhancedOrderChecker(config_mgr)
        table = checker.run_checklist(folder, as_table=True)
        self._checklist_table_data = table
        self._refresh_checklist_table()
        # ====== æ–°å¢ cross check with email log ======
        import os
        email_log_path = os.path.join(folder, "email_bodies_log.txt")
        if os.path.exists(email_log_path):
            with open(email_log_path, "r", encoding="utf-8") as f:
                content = f.read()
            import re
            # å‡è¨­æ ¼å¼ï¼šâ€”â€”â€” éƒµä»¶ N â€”â€”â€”\n[ç™¼ä»¶äºº] ...\n[ä¸»é¡Œ] ...\n[å…§å®¹]\n 1. Aries\n 2. Changcheng ...
            cross_check_result = []
            for block in content.split("â€”â€”â€” éƒµä»¶"):
                lines = block.strip().splitlines()
                if not lines or len(lines) < 3:
                    continue
                outlet = lines[1].replace("[ç™¼ä»¶äºº]", "").strip() if lines[1].startswith("[ç™¼ä»¶äºº]") else ""
                claimed = []
                for line in lines[3:]:
                    m = re.match(r"\d+\.\s*(.+)", line)
                    if m:
                        claimed.append(m.group(1).strip())
                # cross check: æª¢æŸ¥ claimed æ˜¯å¦æœ‰å‡ºç¾åœ¨ checklist table
                found = set()
                for row in table:
                    if outlet and outlet in row["outlet"] and row["supplier"] in claimed and row["cover_status"] == "âœ”ï¸":
                        found.add(row["supplier"])
                missed = [s for s in claimed if s not in found]
                if missed:
                    cross_check_result.append(f"[è­¦å‘Š] {outlet} è²ç¨±ä¸‹å–®ä½†æœªæ•´åˆåˆ°: {', '.join(missed)}")
            if cross_check_result:
                messagebox.showwarning("Cross Check Result", "\n".join(cross_check_result))
            else:
                messagebox.showinfo("Cross Check Result", "æ‰€æœ‰é–€å¸‚è²ç¨±ä¸‹å–®çš„ä¾›æ‡‰å•†éƒ½å·²æ•´åˆï¼")
        else:
            messagebox.showinfo("Cross Check Result", "æ‰¾ä¸åˆ° email_bodies_log.txtï¼")
    def _refresh_checklist_table(self):
        # æ¸…ç©ºè¡¨æ ¼
        for row in self.checklist_table.get_children():
            self.checklist_table.delete(row)
        # æ’å…¥æ•¸æ“š
        for row in self._checklist_table_data:
            values = (row["supplier"], row["outlet"], row["cover_status"], row["remark"])
            self.checklist_table.insert("", "end", values=values)
    def _filter_checklist_table(self):
        keyword = self.checklist_search_var.get().lower()
        scope = getattr(self, 'checklist_search_scope_var', None)
        scope_val = scope.get() if scope else "å…¨éƒ¨"
        supplier_val = getattr(self, 'checklist_supplier_filter_var', None)
        supplier_selected = supplier_val.get() if supplier_val else "å…¨éƒ¨"
        outlet_val = getattr(self, 'checklist_outlet_filter_var', None)
        outlet_selected = outlet_val.get() if outlet_val else "å…¨éƒ¨"
        def normalize(text):
            import re
            return re.sub(r'[^a-zA-Z0-9]', '', str(text)).lower()
        norm_keyword = normalize(keyword)
        def row_match(row):
            # ä¾›æ‡‰å•†/é–€å¸‚ä¸‹æ‹‰é¸å–®
            if supplier_selected != "å…¨éƒ¨" and row["supplier"] != supplier_selected:
                return False
            if outlet_selected != "å…¨éƒ¨" and row["outlet"] != outlet_selected:
                return False
            # æœå°‹ç¯„åœ
            if not norm_keyword:
                return True
            if scope_val == "å…¨éƒ¨":
                return norm_keyword in normalize(row["supplier"]) or norm_keyword in normalize(row["outlet"]) or norm_keyword in row["cover_status"] or norm_keyword in row["remark"].lower()
            elif scope_val == "ä¾›æ‡‰å•†":
                return norm_keyword in normalize(row["supplier"])
            elif scope_val == "åˆ†åº—":
                return norm_keyword in normalize(row["outlet"])
            return True
        filtered = [row for row in self._checklist_table_data if row_match(row)]
        for row in self.checklist_table.get_children():
            self.checklist_table.delete(row)
        for row in filtered:
            values = (row["supplier"], row["outlet"], row["cover_status"], row["remark"])
            self.checklist_table.insert("", "end", values=values)
        # å‹•æ…‹åˆ·æ–°ä¸‹æ‹‰é¸å–®å…§å®¹
        if hasattr(self, 'supplier_menu'):
            current = self.checklist_supplier_filter_var.get()
            suppliers = ["å…¨éƒ¨"] + sorted(list({row["supplier"] for row in self._checklist_table_data if row["supplier"]}))
            self.supplier_menu.configure(values=suppliers)
            if current not in suppliers:
                self.checklist_supplier_filter_var.set("å…¨éƒ¨")
        if hasattr(self, 'outlet_menu'):
            current = self.checklist_outlet_filter_var.get()
            outlets = ["å…¨éƒ¨"] + sorted(list({row["outlet"] for row in self._checklist_table_data if row["outlet"]}))
            self.outlet_menu.configure(values=outlets)
            if current not in outlets:
                self.checklist_outlet_filter_var.set("å…¨éƒ¨")
    def _copy_checklist_table(self):
        import pyperclip
        rows = ["\t".join(["ä¾›åº”å•†", "åˆ†åº—", "è¦†è“‹ç‹€æ…‹", "å‚™è¨»"])]
        for row in self._checklist_table_data:
            rows.append("\t".join([str(row["supplier"]), str(row["outlet"]), str(row["cover_status"]), str(row["remark"])]))
        pyperclip.copy("\n".join(rows))
        messagebox.showinfo("è¤‡è£½æˆåŠŸ", "å ±è¡¨å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼")
    def _export_checklist_table(self):
        import pandas as pd
        from tkinter import filedialog
        df = pd.DataFrame(self._checklist_table_data)
        file = filedialog.asksaveasfilename(defaultextension=".xlsx", filetypes=[("Excel files", "*.xlsx")])
        if file:
            df.to_excel(file, index=False)
            messagebox.showinfo("åŒ¯å‡ºæˆåŠŸ", f"å·²åŒ¯å‡ºåˆ° {file}")
    def _on_checklist_row_double_click(self, event):
        item = self.checklist_table.selection()
        if not item:
            return
        values = self.checklist_table.item(item[0], "values")
        detail = f"ä¾›åº”å•†: {values[0]}\nåˆ†åº—: {values[1]}\nè¦†è“‹ç‹€æ…‹: {values[2]}\nå‚™è¨»: {values[3]}"
        ScrollableMessageBox(self, "è¯¦ç»†ä¿¡æ¯", detail)
    
    def show_automation_ui(self):
        """æ˜¾ç¤ºè‡ªåŠ¨åŒ–ç•Œé¢"""
        def build(c):
            import os
            import traceback
            from datetime import datetime, timedelta
            import openpyxl
            self.folder_vars = {}
            self.master_config_var = ctk.StringVar()
            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(side="top", fill="x", expand=False, padx=30, pady=10)
            # åªä¿ç•™ä¸€çµ„ Supplier Folder æ¬„ä½
            folders = [
                ("source_folder", "ä¾†æºè³‡æ–™å¤¾\nSource Folder (Weekly Orders)"),
                ("supplier_folder", "ä¾›æ‡‰å•†æ–‡ä»¶å¤¾\nSupplier Folder")
            ]
            for key, label in folders:
                row = ctk.CTkFrame(form_frame)
                row.pack(fill="x", pady=8)
                var = ctk.StringVar()
                self.folder_vars[key] = var
                ctk.CTkLabel(row, text=label, font=("Microsoft JhengHei", 12, "bold"), anchor="w", justify="left").pack(side="left", padx=8)
                ctk.CTkEntry(row, textvariable=var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
                # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
                automation_browse_btn = ctk.CTkButton(
                    row, 
                    text="ç€è¦½...\nBrowse...", 
                    font=("Microsoft YaHei", 11, "bold"),
                    command=lambda k=key: self._select_folder(k),
                    corner_radius=8,
                    hover_color="#1976d2",
                    height=30
                )
                automation_browse_btn.pack(side="left", padx=5)
            # ç»Ÿä¸€é…ç½®æ–‡ä»¶
            row3 = ctk.CTkFrame(form_frame)
            row3.pack(fill="x", pady=8)
            ctk.CTkLabel(row3, text="çµ±ä¸€é…ç½®æ–‡ä»¶\nMaster Config (Excel):", font=("Microsoft JhengHei", 12, "bold")).pack(side="left", padx=8)
            ctk.CTkEntry(row3, textvariable=self.master_config_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
            automation_config_browse_btn = ctk.CTkButton(
                row3, 
                text=t("browse"), 
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_config_file(self.master_config_var, [("Excel files", "*.xlsx")]),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            automation_config_browse_btn.pack(side="left", padx=5)
            # é–‹å§‹è‡ªå‹•åŒ–æŒ‰éˆ•
            btn_frame = ctk.CTkFrame(form_frame, fg_color="transparent")
            btn_frame.pack(pady=(15, 0))
            
            # å‰µå»ºæ°´å¹³æ’åˆ—çš„æŒ‰éˆ•å®¹å™¨
            button_row = ctk.CTkFrame(btn_frame, fg_color="transparent")
            button_row.pack(anchor="center")
            
            # å·¦é‚ŠæŒ‰éˆ•ï¼šAmendment Order æ•´åˆæ”¹å–®
            GlowButton(
                button_row, 
                text="æ•´åˆæ”¹å–®\nAmendment Order",
                command=self._run_yellow_highlighted_automation,
                width=280,
                height=50,
                glow_color="#f59e0b",
                corner_radius=18
            ).pack(side="left", padx=(0, 10))
            
            # å³é‚ŠæŒ‰éˆ•ï¼šConsolidate Order æ•´åˆè¨‚å–®
            GlowButton(
                button_row, 
                text="æ•´åˆè¨‚å–®\nConsolidate Order",
                command=self._run_enhanced_automation,
                width=280,
                height=50,
                glow_color="#22c55e",
                corner_radius=18
            ).pack(side="left")
            # ========== è£œå–®å€å¡Šï¼ˆç§»åˆ°ä¸Šé¢ï¼‰ ==========
            append_frame = ctk.CTkFrame(c, fg_color=DARK_PANEL, corner_radius=16)
            append_frame.pack(side="top", fill="x", expand=False, padx=30, pady=(8, 0))
            ctk.CTkLabel(
                append_frame,
                text="è£œåŠ é–€å¸‚è¨‚å–®\nAppend Outlet Order",
                font=("Microsoft JhengHei", 12, "bold"),
                text_color=ACCENT_BLUE,
                anchor="w",
                justify="left"
            ).pack(anchor="w", padx=8, pady=(8, 3))
            # é¸æ“‡è¦è£œçš„é–€å¸‚è¨‚å–®æª”æ¡ˆï¼ˆå¯å¤šé¸ï¼‰
            self.append_outlet_files_var = ctk.StringVar()
            # ===== æª”æ¡ˆæ¸…å–®é¡¯ç¤ºå€ =====
            def select_append_files():
                from tkinter import filedialog
                files = filedialog.askopenfilenames(
                    title="é¸æ“‡è¦è£œçš„é–€å¸‚è¨‚å–®/Select Outlet Order Files",
                    filetypes=[("Excel files", "*.xlsx")]
                )
                if files:
                    self.append_outlet_files_var.set(";".join(files))
            rowa = ctk.CTkFrame(append_frame)
            rowa.pack(fill="x", pady=3)
            ctk.CTkLabel(rowa, text="é¸æ“‡è¦è£œçš„é–€å¸‚è¨‚å–®æª”æ¡ˆ\nSelect Outlet Order Files:", font=("Microsoft JhengHei", 11)).pack(side="left", padx=8)
            ctk.CTkEntry(rowa, textvariable=self.append_outlet_files_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•ï¼ˆçµ±ä¸€æ¨£å¼ï¼‰
            browse_btn_a = ctk.CTkButton(
                rowa, 
                text="æµè§ˆ...\nBrowse...", 
                font=("Microsoft YaHei", 11, "bold"),
                command=select_append_files, 
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_a.pack(side="left", padx=5)
            # é¸æ“‡å·²æ•´åˆçš„Supplieræª”æ¡ˆè³‡æ–™å¤¾
            self.append_supplier_folder_var = ctk.StringVar()
            rowb = ctk.CTkFrame(append_frame)
            rowb.pack(fill="x", pady=3)
            ctk.CTkLabel(rowb, text="é¸æ“‡å·²æ•´åˆçš„Supplieræª”æ¡ˆè³‡æ–™å¤¾\nSelect Supplier Folder:", font=("Microsoft JhengHei", 11)).pack(side="left", padx=8)
            ctk.CTkEntry(rowb, textvariable=self.append_supplier_folder_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
            browse_btn_b = ctk.CTkButton(
                rowb, 
                text="æµè§ˆ...\nBrowse...", 
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_folder_var(self.append_supplier_folder_var),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_b.pack(side="left", padx=5)
            # è£œå–®ä¸»æŒ‰éˆ•ï¼ˆGlowButton æ¨£å¼ï¼Œèˆ‡ Summary/Automation ä¸€è‡´ï¼‰
            def run_append_order():
                import os
                import shutil
                from openpyxl import load_workbook, Workbook
                import xlwings as xw
                from tkinter import messagebox
                from datetime import datetime, timedelta
                import re
                outlet_files = self.append_outlet_files_var.get().split(";")
                supplier_folder = self.append_supplier_folder_var.get()
                if not outlet_files or not supplier_folder:
                    messagebox.showwarning("è­¦å‘Š", "è«‹é¸æ“‡è¦è£œçš„é–€å¸‚è¨‚å–®æª”æ¡ˆå’Œå·²æ•´åˆçš„Supplierè³‡æ–™å¤¾ï¼")
                    return
                # è¨ˆç®—ä¸‹é€±ä¸€èˆ‡ä¸‹é€±æ—¥
                today = datetime.now().date()
                this_monday = today - timedelta(days=today.weekday())
                next_monday = this_monday + timedelta(days=7)
                next_sunday = next_monday + timedelta(days=6)
                for outlet_file in outlet_files:
                    if not outlet_file.strip():
                        continue
                    try:
                        wb_outlet = load_workbook(outlet_file, data_only=False)
                        for sheet_name in wb_outlet.sheetnames:
                            ws = wb_outlet[sheet_name]
                            # åˆ¤æ–·é€™å€‹ sheet æ˜¯å¦æœ‰ä¸‹é€±çš„è¨‚å–®ï¼ˆèˆ‡ order automation ä¸€è‡´ï¼‰
                            has_next_week_order = False
                            for row in ws.iter_rows(min_row=1, max_row=min(30, ws.max_row)):
                                row_vals = [str(cell.value).strip() if cell.value else '' for cell in row]
                                if any(re.match(r"\d{1,2}-[A-Za-z]{3,}$", v) for v in row_vals):
                                    # æ‰¾åˆ°æ—¥æœŸåˆ—
                                    for cell in row:
                                        val = cell.value
                                        parsed = None
                                        try:
                                            if val:
                                                sval = str(val)
                                                if re.match(r"^\d{1,2}-[A-Za-z]{3,}$", sval):
                                                    year = next_monday.year
                                                    sval = f"{sval}-{year}"
                                                if isinstance(val, (int, float)):
                                                    base_date = datetime(1899, 12, 30)
                                                    parsed = base_date + timedelta(days=val)
                                                else:
                                                    parsed = datetime.strptime(sval, "%d-%b-%Y")
                                        except Exception:
                                            pass
                                        if parsed and next_monday <= parsed.date() <= next_sunday:
                                            has_next_week_order = True
                                            break
                                if has_next_week_order:
                                    break
                            if not has_next_week_order:
                                continue  # è·³éæ²’æœ‰ä¸‹é€±è¨‚å–®çš„ sheet
                            supplier_name = sheet_name.strip()
                            supplier_file = os.path.join(supplier_folder, f"{supplier_name}_Week_Append.xlsx")
                            if not os.path.exists(supplier_file):
                                wb_supplier = Workbook()
                                if 'Sheet' in wb_supplier.sheetnames:
                                    del wb_supplier['Sheet']
                                wb_supplier.save(supplier_file)
                            app = xw.App(visible=False)
                            try:
                                wb_supp = app.books.open(supplier_file)
                                wb_out = app.books.open(outlet_file)
                                for sht in wb_out.sheets:
                                    if sht.name.strip() == supplier_name:
                                        for s in wb_supp.sheets:
                                            if s.name == sht.name:
                                                s.delete()
                                        sht.api.Copy(Before=wb_supp.sheets[0].api)
                                        wb_supp.sheets[0].name = sht.name
                                wb_supp.save()
                                wb_supp.close()
                                wb_out.close()
                            finally:
                                app.quit()
                    except Exception as e:
                        messagebox.showerror("éŒ¯èª¤", f"è™•ç† {outlet_file} æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
                messagebox.showinfo("å®Œæˆ", "è£œåŠ é–€å¸‚è¨‚å–®å·²å®Œæˆï¼(åƒ…è£œæœ‰ä¸‹é€±è¨‚å–®çš„é–€å¸‚)")
            GlowButton(
                append_frame,
                text="è£œåŠ é–€å¸‚è¨‚å–®\nAppend Outlet Order",
                command=run_append_order,
                width=300,
                height=40,
                glow_color=ACCENT_BLUE,
                corner_radius=18
            ).pack(pady=(8, 0))
            
            # ========== ç”¢ç”Ÿ Summary å€å¡Š ==========
            summary_frame = ctk.CTkFrame(c, fg_color=DARK_PANEL, corner_radius=16)
            summary_frame.pack(side="top", fill="x", expand=False, padx=30, pady=(8, 0))
            ctk.CTkLabel(summary_frame, text="ç”¢ç”Ÿ Summary Sheet\nGenerate Summary Sheet", font=("Microsoft JhengHei", 12, "bold"), text_color=ACCENT_GREEN, anchor="w", justify="left").pack(anchor="w", padx=8, pady=(8,3))
            self.summary_supplier_files_var = ctk.StringVar()
            def select_summary_files():
                from tkinter import filedialog
                files = filedialog.askopenfilenames(title="é¸æ“‡è¦ç”¢ç”Ÿ Summary çš„ Supplier æª”æ¡ˆ/Select Supplier Files", filetypes=[("Excel files", "*.xlsx")])
                if files:
                    self.summary_supplier_files_var.set(";".join(files))
            row_sum = ctk.CTkFrame(summary_frame)
            row_sum.pack(fill="x", pady=3)
            ctk.CTkLabel(row_sum, text="é¸æ“‡ Supplier æª”æ¡ˆ\nSelect Supplier Files:", font=("Microsoft JhengHei", 11)).pack(side="left", padx=8)
            ctk.CTkEntry(row_sum, textvariable=self.summary_supplier_files_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            browse_btn_sum = ctk.CTkButton(
                row_sum, 
                text="æµè§ˆ...\nBrowse...", 
                font=("Microsoft YaHei", 11, "bold"),
                command=select_summary_files,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_sum.pack(side="left", padx=5)

            import re
            from dateutil.parser import parse
            def create_supplier_summary(filepath):
                print("[DEBUG] é–‹å§‹ç”¢ç”Ÿ summary (ç”¢å“å+å…¬å¼è¡Œæ•¸é‡ä¸»æµç¨‹)...")
                import openpyxl
                from openpyxl.styles import Alignment, Font, PatternFill, Border, Side
                from openpyxl.utils import get_column_letter
                from datetime import datetime, timedelta
                # å–å¾—ä¸‹é€±ä¸€åˆ°ä¸‹é€±æ—¥æ—¥æœŸ
                today = datetime.now().date()
                this_monday = today - timedelta(days=today.weekday())
                next_monday = this_monday + timedelta(days=7)
                next_sunday = next_monday + timedelta(days=6)
                week_dates = [(next_monday + timedelta(days=i)) for i in range(7)]  # åŒ…å«é€±æ—¥
                week_days = [d.strftime('%a') for d in week_dates]
                week_dates_str = [d.strftime('%d-%b') for d in week_dates]
                wb = openpyxl.load_workbook(filepath, data_only=True)
                product_map = {}  # (eng, chi) -> {short: (full, [qtys...])}
                all_outlets = set()
                for sheet in wb.sheetnames:
                    if sheet in ("Sheet", "Summary"):
                        continue
                    ws = wb[sheet]
                    if ws.sheet_state != "visible":
                        continue
                    short_name = sheet
                    full_name = ws["F5"].value if ws["F5"].value else sheet
                    all_outlets.add((short_name, full_name))
                    last_row = ws.max_row
                    row = 1
                    while row <= last_row:
                        val = ws.cell(row=row, column=2).value  # Bæ¬„
                        if val and "description" in str(val).strip().lower():
                            date_row_idx = row  # æ—¥æœŸåˆ—å’Œ Description åŒä¸€è¡Œ
                            date_cols = list(range(6, 13))  # F~L (åŒ…å«é€±æ—¥)
                            # è§£ææ—¥æœŸåˆ—
                            date_vals = []
                            for col in date_cols:
                                cell_val = ws.cell(row=date_row_idx, column=col).value
                                try:
                                    if isinstance(cell_val, str):
                                        date_val = datetime.strptime(cell_val.strip(), "%d-%b")
                                        date_val = date_val.replace(year=next_monday.year)
                                        date_vals.append(date_val.date())
                                    elif isinstance(cell_val, datetime):
                                        date_vals.append(cell_val.date())
                                    else:
                                        date_vals.append(None)
                                except Exception:
                                    date_vals.append(None)
                            print(f"[DEBUG] sheet={sheet}, row={row}, date_row_idx={date_row_idx}, date_vals={date_vals}, next_monday={next_monday}, next_sunday={next_sunday}")
                            # åˆ¤æ–·é€™ä¸€å€å¡Šæ˜¯å¦å±¬æ–¼ä¸‹é€±
                            if not any(d and next_monday <= d <= next_sunday for d in date_vals):
                                row += 1
                                continue
                            # ç”¢å“è¡Œå¾ row+1 é–‹å§‹ï¼Œç›´åˆ°é‡åˆ°ç©ºç™½æˆ– sub-total
                            prod_row = row + 1
                            while prod_row <= last_row:
                                eng = ws.cell(row=prod_row, column=2).value
                                chi = ws.cell(row=prod_row, column=3).value
                                if not eng or str(eng).strip() == "" or str(eng).strip().lower().startswith("="):
                                    break
                                if "sub-total" in str(eng).lower():
                                    prod_row += 1
                                    continue
                                qtys = []
                                # å‹•æ…‹ç¢ºå®šé€™å€‹å» å•†çš„æ—¥æœŸç¯„åœ
                                valid_dates = [d for d in date_vals if d and next_monday <= d <= next_sunday]
                                max_days = len(valid_dates) if valid_dates else 7  # é è¨­7å¤©ï¼Œä½†æ ¹æ“šå¯¦éš›æ—¥æœŸèª¿æ•´
                                
                                for idx, col in enumerate(date_cols):
                                    val = ws.cell(row=prod_row, column=col).value
                                    if date_vals[idx] and next_monday <= date_vals[idx] <= next_sunday:
                                        try:
                                            qtys.append(int(val) if val is not None else 0)
                                        except Exception:
                                            try:
                                                qtys.append(float(val) if val is not None else 0)
                                            except Exception:
                                                qtys.append(0)
                                    else:
                                        qtys.append(0)
                                
                                # å¦‚æœé€™å€‹å» å•†åªæœ‰6å¤©è³‡æ–™ï¼Œç¢ºä¿qtysé™£åˆ—é•·åº¦ç‚º6
                                if len(valid_dates) == 6:
                                    qtys = qtys[:6]  # åªä¿ç•™å‰6å¤©çš„è³‡æ–™
                                key = (eng, chi)
                                if key not in product_map:
                                    product_map[key] = {}
                                product_map[key][short_name] = (full_name, qtys)
                                prod_row += 1
                            row = prod_row
                        else:
                            row += 1
                # å»ºç«‹ summary sheet ... (å¾ŒçºŒä¸è®Š)
                # å»ºç«‹ summary sheet
                if "Summary" in wb.sheetnames:
                    del wb["Summary"]
                ws_sum = wb.create_sheet("Summary")
                # æ¨£å¼
                header_fill = PatternFill("solid", fgColor="B7B7E1")
                date_fill = PatternFill("solid", fgColor="C6E0B4")
                center = Alignment(horizontal="center", vertical="center")
                bold = Font(bold=True)
                thin = Side(border_style="thin", color="000000")
                border = Border(left=thin, right=thin, top=thin, bottom=thin)
                # å¯«å…¥æ¯å€‹ç”¢å“å€å¡Šï¼Œæ©«å‘æ’åˆ—ï¼Œæœ€å¤š3å€‹ä¸€æ’ï¼Œè¶…éè‡ªå‹•æ›è¡Œ
                col_offset = 2
                row_offset = 2
                products = list(product_map.items())
                max_per_row = 3
                for idx, ((eng, chi), outlet_map) in enumerate(products):
                    block_idx = idx % max_per_row
                    block_row = idx // max_per_row
                    start_col = col_offset + block_idx * 9
                    start_row = row_offset + block_row * (len(all_outlets)+7)  # 7: æ¨™é¡Œ+æ¬„+æ—¥æœŸ+TOTAL+ç©ºç™½
                    # å‹•æ…‹ç¢ºå®šé€™å€‹ç”¢å“å€å¡Šçš„å¯¦éš›å¤©æ•¸
                    actual_days = 7  # é è¨­7å¤©
                    for short, full in sorted(all_outlets):
                        qtys = outlet_map.get(short, (full, [0]*7))[1]
                        if qtys and len(qtys) == 6:  # å¦‚æœç™¼ç¾æœ‰6å¤©çš„è³‡æ–™
                            actual_days = 6
                            break
                    
                    # æ¨™é¡Œåˆä½µï¼ˆæ ¹æ“šå¯¦éš›å¤©æ•¸èª¿æ•´ï¼‰
                    merge_end_col = start_col + actual_days + 1  # +1 æ˜¯å› ç‚ºæœ‰ Short Name å’Œ Full Name å…©æ¬„
                    ws_sum.merge_cells(start_row=start_row, start_column=start_col, end_row=start_row, end_column=merge_end_col)
                    ws_sum.cell(row=start_row, column=start_col, value=eng).fill = header_fill
                    ws_sum.cell(row=start_row, column=start_col, value=eng).font = bold
                    ws_sum.cell(row=start_row, column=start_col, value=eng).alignment = center
                    ws_sum.merge_cells(start_row=start_row+1, start_column=start_col, end_row=start_row+1, end_column=merge_end_col)
                    ws_sum.cell(row=start_row+1, column=start_col, value=chi).fill = header_fill
                    ws_sum.cell(row=start_row+1, column=start_col, value=chi).font = bold
                    ws_sum.cell(row=start_row+1, column=start_col, value=chi).alignment = center
                    # æ¬„æ¨™é¡Œ
                    ws_sum.cell(row=start_row+2, column=start_col, value="Short Name").font = bold
                    ws_sum.cell(row=start_row+2, column=start_col+1, value="Full Name").font = bold
                    # Full Name æ¬„å¯¬
                    ws_sum.column_dimensions[get_column_letter(start_col+1)].width = 34.71
                    # æ ¹æ“šå¯¦éš›å¤©æ•¸ç”Ÿæˆæ—¥æœŸæ¨™é¡Œ
                    for i in range(actual_days):
                        c = start_col+2+i
                        if i < len(week_days) and i < len(week_dates_str):
                            wd = week_days[i]
                            dt = week_dates_str[i]
                        ws_sum.cell(row=start_row+2, column=c, value=wd).fill = date_fill
                        ws_sum.cell(row=start_row+3, column=c, value=dt).fill = date_fill
                        ws_sum.cell(row=start_row+2, column=c, value=wd).alignment = center
                        ws_sum.cell(row=start_row+3, column=c, value=dt).alignment = center
                    ws_sum.cell(row=start_row+3, column=start_col, value="").fill = date_fill
                    ws_sum.cell(row=start_row+3, column=start_col+1, value="").fill = date_fill
                    # åˆ†åº—è³‡æ–™ï¼ˆæ‰€æœ‰åˆ†åº—éƒ½åˆ—å‡ºï¼Œæ²’æ•¸é‡å¡«0ï¼‰
                    row_idx = start_row+4
                    for short, full in sorted(all_outlets):
                        qtys = outlet_map.get(short, (full, [0]*7))[1]  # é è¨­7å¤©
                        if all(q == 0 or q == None for q in qtys):
                            continue  # è·³éå…¨ç‚º0çš„åˆ†åº—
                        ws_sum.cell(row=row_idx, column=start_col, value=short)
                        ws_sum.cell(row=row_idx, column=start_col+1, value=full)
                        for i, qty in enumerate(qtys):
                            ws_sum.cell(row=row_idx, column=start_col+2+i, value=(qty if qty not in (0, None) else ''))
                        row_idx += 1
                    # TOTAL è¡Œ
                    ws_sum.cell(row=row_idx, column=start_col, value="TOTAL").font = bold
                    # å‹•æ…‹ç¢ºå®šé€™å€‹ç”¢å“å€å¡Šçš„å¯¦éš›å¤©æ•¸
                    actual_days = 7  # é è¨­7å¤©
                    for short, full in sorted(all_outlets):
                        qtys = outlet_map.get(short, (full, [0]*7))[1]
                        if qtys and len(qtys) == 6:  # å¦‚æœç™¼ç¾æœ‰6å¤©çš„è³‡æ–™
                            actual_days = 6
                            break
                    
                    for i in range(actual_days):  # æ ¹æ“šå¯¦éš›å¤©æ•¸
                        col_letter = get_column_letter(start_col+2+i)
                        total_formula = f"=SUM({col_letter}{start_row+4}:{col_letter}{row_idx-1})"
                        ws_sum.cell(row=row_idx, column=start_col+2+i, value=total_formula)
                        ws_sum.cell(row=row_idx, column=start_col+2+i).font = bold
                        ws_sum.cell(row=row_idx, column=start_col+2+i).alignment = center
                    # æ ¼å¼åŒ–å€å¡Š
                    for r in range(start_row, row_idx+1):
                        for c in range(start_col, start_col+actual_days+2):  # +2 æ˜¯å› ç‚ºæœ‰ Short Name å’Œ Full Name å…©æ¬„
                            ws_sum.cell(row=r, column=c).border = border
                # å°‡ Summary ç§»åˆ°ç¬¬ä¸€å€‹ sheet
                wb._sheets = [ws_sum] + [s for s in wb._sheets if s != ws_sum]
                wb.save(filepath)
                print(f"[DEBUG] å·²å¯«å…¥ Summary sheet: {filepath}")

            def run_generate_summary():
                from tkinter import messagebox
                import traceback
                import tempfile
                import msoffcrypto
                import shutil
                import os

                file_list = self.summary_supplier_files_var.get().split(";")
                file_list = [f for f in file_list if f.strip()]
                if not file_list:
                    messagebox.showwarning("æœªé¸æ“‡æª”æ¡ˆ", "è«‹å…ˆé¸æ“‡è¦ç”¢ç”Ÿ Summary çš„ Supplier æª”æ¡ˆï¼")
                    return
                for file_path in file_list:
                    try:
                        print(f"[DEBUG] å˜—è©¦è®€å–: {file_path}")
                        # xlwings åªèƒ½è™•ç†æœªåŠ å¯†çš„ xlsx
                        # è‹¥åŠ å¯†ï¼Œå…ˆè§£å¯†åˆ°æš«å­˜æª”
                        tmp_path = None
                        try:
                            create_supplier_summary(file_path)
                        except Exception as e:
                            print(f"[DEBUG] xlwings è®€å–å¤±æ•—ï¼Œå˜—è©¦è§£å¯†: {e}")
                            with open(file_path, "rb") as f:
                                office_file = msoffcrypto.OfficeFile(f)
                                office_file.load_key(password="Apple")
                                with tempfile.NamedTemporaryFile(delete=False, suffix=".xlsx") as tmp:
                                    office_file.decrypt(tmp)
                                    tmp_path = tmp.name
                            create_supplier_summary(tmp_path)
                            # è¦†è“‹åŸæª”
                            shutil.copyfile(tmp_path, file_path)
                            os.remove(tmp_path)
                        print(f"[DEBUG] å·²å¯«å…¥: {file_path}")
                    except Exception as e:
                        import traceback
                        messagebox.showerror("éŒ¯èª¤", f"è™•ç†æª”æ¡ˆ {file_path} æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n{str(e)}\n{traceback.format_exc()}")
                        print(f"[DEBUG] ç™¼ç”ŸéŒ¯èª¤: {e}")
                        continue
                messagebox.showinfo("å®Œæˆ", "Summary å·²æˆåŠŸç”¢ç”Ÿä¸¦æ’å…¥åˆ°æ‰€é¸æª”æ¡ˆï¼")

            GlowButton(
                summary_frame,
                text="ç”¢ç”Ÿ Summary\nGenerate Summary",
                command=run_generate_summary,
                width=300,
                height=40,
                glow_color="#8B5CF6"  # æ”¹ç‚ºæ›´å¥½çœ‹çš„ç´«è‰²
            ).pack(pady=(8, 0))
 

        
        self._show_function_ui(
            "automation_title", 
            "automation_desc", 
            build
        )
    
    def show_email_sending_ui(self):
        """æ˜¾ç¤ºé‚®ä»¶å‘é€ç•Œé¢"""
        def build(c):
            import os
            self.email_supplier_folder_var = ctk.StringVar()
            self.email_master_config_var = ctk.StringVar()
            
            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(fill="both", expand=True, padx=30, pady=10)
            # ä¾›åº”å•†æ–‡ä»¶å¤¹
            row1 = ctk.CTkFrame(form_frame)
            row1.pack(fill="x", pady=8)
            ctk.CTkLabel(row1, text="ä¾›æ‡‰å•†æ–‡ä»¶å¤¾\nSupplier Folder:", font=("Microsoft JhengHei", 12, "bold")).pack(side="left", padx=8)
            ctk.CTkEntry(row1, textvariable=self.email_supplier_folder_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            email_browse_btn = ctk.CTkButton(
                row1, 
                text="ç€è¦½...\nBrowse...", 
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_folder_var(self.email_supplier_folder_var),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            email_browse_btn.pack(side="left", padx=5)
            # ç»Ÿä¸€é…ç½®æ–‡ä»¶
            row2 = ctk.CTkFrame(form_frame)
            row2.pack(fill="x", pady=8)
            ctk.CTkLabel(row2, text="çµ±ä¸€é…ç½®æ–‡ä»¶\nMaster Config (Excel):", font=("Microsoft JhengHei", 12, "bold")).pack(side="left", padx=8)
            ctk.CTkEntry(row2, textvariable=self.email_master_config_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            browse_btn_email_config = ctk.CTkButton(
                row2,
                text="ç€è¦½...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_config_file(self.email_master_config_var, [("Excel files", "*.xlsx")]),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_email_config.pack(side="left", padx=5)
            # æ–°å¢ï¼šä¾›æ‡‰å•†é¸æ“‡å€åŸŸ
            supplier_frame = ctk.CTkFrame(form_frame)
            supplier_frame.pack(fill="x", pady=8)
            ctk.CTkLabel(supplier_frame, text="é¸æ“‡ä¾›æ‡‰å•†\nSelect Supplier:", font=("Microsoft JhengHei", 12, "bold")).pack(side="left", padx=8)
            self.supplier_combobox = ctk.CTkComboBox(supplier_frame, values=["è«‹å…ˆé¸æ“‡æ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶"], state="readonly", width=300)
            self.supplier_combobox.pack(side="left", padx=5)
            
            # ç¾åŒ–ï¼šè‡ªè¨‚ä¸»æ—¨/Custom Subject è¡Œ
            subject_option_frame = ctk.CTkFrame(form_frame, fg_color="#232e3c", corner_radius=14, height=48)
            subject_option_frame.pack(fill="x", pady=10, padx=2)
            subject_option_frame.pack_propagate(False)
            # å½©è‰²icon/æ¢
            accent = ctk.CTkLabel(subject_option_frame, text="â˜…", font=("Segoe UI Emoji", 22), text_color="#38bdf8", width=32)
            accent.pack(side="left", padx=(12, 8), pady=0)
            self.use_custom_subject_var = ctk.BooleanVar(value=False)
            custom_subject_checkbox = ctk.CTkCheckBox(
                subject_option_frame,
                text="è‡ªè¨‚ä¸»æ—¨\nCustom Subject",
                variable=self.use_custom_subject_var,
                font=("Microsoft JhengHei", 14, "bold"),
                width=30,
                height=30,
                border_width=3,
                corner_radius=8,
                fg_color="#2563eb",
                hover_color="#1d4ed8",
                border_color="#60a5fa",
                text_color="#fff",
                checkbox_height=24,
                checkbox_width=24,
                command=lambda: self._toggle_subject_entry()
            )
            custom_subject_checkbox.pack(side="left", padx=(0, 18), pady=0)
            ctk.CTkLabel(subject_option_frame, text="éƒµä»¶ä¸»æ—¨\nEmail Subject:", font=("Microsoft JhengHei", 14, "bold"), text_color="#e0e7ef").pack(side="left", padx=(0, 12), pady=0)
            self.email_subject_var = ctk.StringVar()
            self.email_subject_entry = ctk.CTkEntry(subject_option_frame, textvariable=self.email_subject_var, font=("Microsoft JhengHei", 14), width=520, height=32, border_width=3, corner_radius=10, fg_color="#f1f5f9", text_color="#222", border_color="#38bdf8", state="disabled")
            self.email_subject_entry.pack(side="left", padx=(0, 18), fill="x", expand=True, pady=0)

            def _toggle_subject_entry(self=None):
                if self is None:
                    return
                if self.use_custom_subject_var.get():
                    self.email_subject_entry.configure(state="normal", fg_color="#fff", text_color="#222", border_color="#2563eb")
                else:
                    self.email_subject_entry.configure(state="disabled", fg_color="#f1f5f9", text_color="#222", border_color="#38bdf8")
            self._toggle_subject_entry = _toggle_subject_entry.__get__(self)
            
            # æ›´æ–°ä¾›æ‡‰å•†åˆ—è¡¨çš„å‡½æ•¸
            def update_supplier_list():
                folder = self.email_supplier_folder_var.get()
                master_config = self.email_master_config_var.get()
                if not folder or not master_config:
                    self.supplier_combobox.configure(values=["è«‹å…ˆé¸æ“‡æ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶"])
                    return
                
                try:
                    # è®€å–é…ç½®æ–‡ä»¶ä¸­çš„ä¾›æ‡‰å•†
                    wb = load_workbook(master_config, data_only=True)
                    supplier_dict = {}  # ä½¿ç”¨ dict ä¾†ä¿å­˜æ¯å€‹ä¾›æ‡‰å•†çš„ç¬¬ä¸€å€‹ email
                    if "Suppliers" in wb.sheetnames:
                        ws = wb["Suppliers"]
                        for row in ws.iter_rows(min_row=2, values_only=True):
                            if row and row[0]:
                                supplier = str(row[0]).strip()
                                if supplier not in supplier_dict:  # åªä¿å­˜æ¯å€‹ä¾›æ‡‰å•†çš„ç¬¬ä¸€å€‹ email
                                    supplier_dict[supplier] = str(row[2]).strip() if len(row) > 2 else ""
                    files = [f for f in os.listdir(folder) if f.endswith(".xlsx") and not f.startswith("~$")]
                    available_suppliers = []
                    for supplier in supplier_dict:
                        for file in files:
                            # åªè¦æª”åæœ‰å°æ‡‰å» å•†åç¨±ï¼ˆä¸é™å®š _Week_ï¼‰
                            if supplier in file and supplier not in available_suppliers:
                                available_suppliers.append(supplier)
                    if available_suppliers:
                        self.supplier_combobox.configure(values=sorted(available_suppliers))  # æ’åºé¡¯ç¤º
                        self.supplier_combobox.set(available_suppliers[0])
                    else:
                        self.supplier_combobox.configure(values=["æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¾›æ‡‰å•†æ–‡ä»¶"])
                except Exception as e:
                    self.supplier_combobox.configure(values=[f"éŒ¯èª¤: {str(e)}"])
            
            # ç¶å®šæ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶è®Šæ›´äº‹ä»¶
            self.email_supplier_folder_var.trace("w", lambda *args: update_supplier_list())
            self.email_master_config_var.trace("w", lambda *args: update_supplier_list())
            
            # éƒµä»¶æ­£æ–‡bodyè¼¸å…¥æ¡†
            ctk.CTkLabel(form_frame, text="éƒµä»¶æ­£æ–‡/Email Body:", font=("Microsoft JhengHei", 12, "bold")).pack(anchor="w", padx=10, pady=(12,0))
            self.email_body_textbox = ctk.CTkTextbox(form_frame, height=100, font=("Microsoft JhengHei", 12), wrap="word")
            self.email_body_textbox.pack(fill="x", padx=10, pady=(0,8))
            
            # æ¨¡æ¿æŒ‰éˆ•å€åŸŸ
            template_frame = ctk.CTkFrame(form_frame, fg_color="transparent")
            template_frame.pack(fill="x", padx=10, pady=(0,8))
            
            # ä¸€èˆ¬è¨‚å–®æ¨¡æ¿æŒ‰éˆ•
            weekly_template_btn = ctk.CTkButton(
                template_frame,
                text="ä¸€èˆ¬è¨‚å–®æ¨¡æ¿\nWeekly Order Template",
                command=lambda: self._load_weekly_template(),
                fg_color="#2563eb",
                hover_color="#1d4ed8",
                font=("Microsoft YaHei", 11, "bold"),
                corner_radius=8,
                height=30
            )
            weekly_template_btn.pack(side="left", padx=(0,8))
            
            # Amendment è¨‚å–®æ¨¡æ¿æŒ‰éˆ•
            amendment_template_btn = ctk.CTkButton(
                template_frame,
                text="Amendment æ¨¡æ¿\nAmendment Template",
                command=lambda: self._load_amendment_template(),
                fg_color="#dc2626",
                hover_color="#b91c1c",
                font=("Microsoft YaHei", 11, "bold"),
                corner_radius=8,
                height=30
            )
            amendment_template_btn.pack(side="left")
            
            # è¼‰å…¥æœ¬åœ°bodyé è¨­
            default_body = "Hi Team,\n\n{month_week} order as attached.\n\nBest Regards,"
            body_path = "email_body.txt"
            if os.path.exists(body_path):
                try:
                    with open(body_path, "r", encoding="utf-8") as f:
                        saved_body = f.read()
                    # æ›¿æ›æ¨¡æ¿ä¸­çš„è®Šæ•¸
                    from datetime import datetime, timedelta
                    now = datetime.now()
                    # è¨ˆç®—ä¸‹å‘¨çš„æ—¥æœŸ
                    days_until_next_monday = (7 - now.weekday()) % 7
                    if days_until_next_monday == 0:
                        days_until_next_monday = 7
                    next_monday = now + timedelta(days=days_until_next_monday)
                    month_name = next_monday.strftime("%B")
                    week_of_month = get_week_of_month(next_monday)
                    month_week = f"{month_name} - Week {week_of_month}"
                    
                    # æ›¿æ›æ¨¡æ¿ä¸­çš„è®Šæ•¸
                    saved_body = saved_body.replace("{month_week}", month_week)
                    
                    self.email_body_textbox.delete("1.0", "end")
                    self.email_body_textbox.insert("1.0", saved_body)
                except Exception:
                    self.email_body_textbox.insert("1.0", default_body)
            else:
                self.email_body_textbox.insert("1.0", default_body)
            # ä¿å­˜æŒ‰éˆ•
            def save_body():
                body = self.email_body_textbox.get("1.0", "end-1c")
                try:
                    with open("email_body.txt", "w", encoding="utf-8") as f:
                        f.write(body)
                    messagebox.showinfo("ä¿å­˜æˆåŠŸ", "éƒµä»¶æ­£æ–‡å·²ä¿å­˜ï¼")
                except Exception as e:
                    messagebox.showerror("ä¿å­˜å¤±æ•—", f"ä¿å­˜å¤±æ•—: {e}")
            # ç¾åŒ–çš„ä¿å­˜æŒ‰éˆ•
            save_btn = ctk.CTkButton(
                form_frame, 
                text="ä¿å­˜éƒµä»¶æ­£æ–‡/Save Email Body", 
                command=save_body, 
                fg_color=ACCENT_GREEN, 
                hover_color=BTN_HOVER,
                font=("Microsoft YaHei", 11, "bold"),
                corner_radius=10,
                height=30
            )
            save_btn.pack(anchor="e", padx=10, pady=(0,8))
            
            # é è¦½å’Œç™¼é€æŒ‰éˆ•
            btn_frame = ctk.CTkFrame(c, fg_color="transparent")
            btn_frame.pack(pady=15, fill="x", padx=20)
            btn_frame.grid_columnconfigure(0, weight=1)
            btn_frame.grid_columnconfigure(1, weight=1)
            # è®“æŒ‰éˆ•è‡ªé©æ‡‰å¯¬åº¦ï¼Œä¸¦åœ¨è¦–çª—çª„æ™‚è‡ªå‹•æ›è¡Œ
            send_btn = GlowButton(
                btn_frame, 
                text="å–®ç¨ç™¼é€\nSend Individual",
                command=self._preview_supplier_email,
                width=200,
                height=40,
                glow_color=ACCENT_BLUE
            )
            send_btn.grid(row=0, column=0, padx=8, pady=3, sticky="ew")
            dir_btn = GlowButton(
                btn_frame, 
                text="ç™¼é€ç›®éŒ„\nEmail Directory",
                command=self._show_email_directory,
                width=200,
                height=40,
                glow_color=ACCENT_RED
            )
            dir_btn.grid(row=0, column=1, padx=8, pady=3, sticky="ew")
            
            # ç¢ºä¿æŒ‰éˆ•åœ¨çª—å£ç¸®å°æ™‚ä¹Ÿèƒ½é¡¯ç¤º
            def on_configure(event):
                # ç•¶çª—å£å¤§å°æ”¹è®Šæ™‚ï¼Œç¢ºä¿æŒ‰éˆ•å¯è¦‹
                if event.width < 600:  # å¦‚æœçª—å£å¤ªçª„
                    send_btn.grid(row=0, column=0, padx=5, pady=3, sticky="ew")
                    dir_btn.grid(row=1, column=0, padx=5, pady=3, sticky="ew")
                else:
                    send_btn.grid(row=0, column=0, padx=8, pady=3, sticky="ew")
                    dir_btn.grid(row=0, column=1, padx=8, pady=3, sticky="ew")
            
            # ç¶å®šçª—å£å¤§å°æ”¹è®Šäº‹ä»¶
            c.bind("<Configure>", on_configure)
        
        self._show_function_ui(
            "send_emails",
            ("é€‰æ‹©ä¾›åº”å•†æ–‡ä»¶å¤¹å¹¶å‘é€é‚®ä»¶\nSelect supplier folder and send emails", FONT_TITLE),
            build
        )
    
    def _load_weekly_template(self):
        """è¼‰å…¥ä¸€èˆ¬è¨‚å–®æ¨¡æ¿"""
        from datetime import datetime, timedelta
        now = datetime.now()
        
        # è¨ˆç®—ä¸‹å‘¨çš„æ—¥æœŸ
        # æ‰¾åˆ°ä¸‹é€±ä¸€ï¼šå¦‚æœä»Šå¤©æ˜¯é€±ä¸€ï¼Œä¸‹é€±ä¸€å°±æ˜¯ä»Šå¤©+7å¤©ï¼›å¦å‰‡æ‰¾åˆ°ä¸‹ä¸€å€‹é€±ä¸€
        days_until_next_monday = (7 - now.weekday()) % 7
        if days_until_next_monday == 0:
            days_until_next_monday = 7  # å¦‚æœä»Šå¤©æ˜¯é€±ä¸€ï¼Œä¸‹é€±ä¸€å°±æ˜¯7å¤©å¾Œ
        next_monday = now + timedelta(days=days_until_next_monday)
        
        # ä½¿ç”¨ä¸‹å‘¨ä¸€çš„æœˆä»½å’Œé€±æ•¸
        month_name = next_monday.strftime("%B")
        week_of_month = get_week_of_month(next_monday)
        
        # ä¸€èˆ¬è¨‚å–®æ¨¡æ¿
        weekly_template = f"Hi Team,\n\n{month_name} - Week {week_of_month} order as attached.\n\nBest Regards,"
        
        # æ›´æ–°éƒµä»¶æ­£æ–‡
        self.email_body_textbox.delete("1.0", "end")
        self.email_body_textbox.insert("1.0", weekly_template)
        
        # æ›´æ–°ä¸»æ—¨ï¼ˆå¦‚æœå•Ÿç”¨äº†è‡ªè¨‚ä¸»æ—¨ï¼‰
        if self.use_custom_subject_var.get():
            subject_template = f"{month_name} - Week {week_of_month}"
            self.email_subject_var.set(subject_template)
    
    def _load_amendment_template(self):
        """è¼‰å…¥ Amendment è¨‚å–®æ¨¡æ¿"""
        from datetime import datetime
        now = datetime.now()
        month_name = now.strftime("%B")
        week_of_month = get_week_of_month(now)
        
        # Amendment è¨‚å–®æ¨¡æ¿
        amendment_template = f"Hi Team,\n\nAmendment order as attached.\n\nBest Regards,"
        
        # æ›´æ–°éƒµä»¶æ­£æ–‡
        self.email_body_textbox.delete("1.0", "end")
        self.email_body_textbox.insert("1.0", amendment_template)
        
        # æ›´æ–°ä¸»æ—¨ï¼ˆå¦‚æœå•Ÿç”¨äº†è‡ªè¨‚ä¸»æ—¨ï¼‰
        if self.use_custom_subject_var.get():
            subject_template = f"Sushi Express Amendment Order - {{Supplier}}"
            self.email_subject_var.set(subject_template)

    def _preview_supplier_email(self):
        """é è¦½é¸å®šä¾›æ‡‰å•†çš„éƒµä»¶å…§å®¹"""
        import os
        folder = self.email_supplier_folder_var.get()
        master_config = self.email_master_config_var.get()
        selected_supplier = self.supplier_combobox.get()
        
        if not folder or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
            
        if not selected_supplier or selected_supplier in ["è«‹å…ˆé¸æ“‡æ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶", "æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¾›æ‡‰å•†æ–‡ä»¶"]:
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡ä¾›æ‡‰å•†")
            return
        
        files = [f for f in os.listdir(folder) if f.endswith(".xlsx") and not f.startswith("~$")]
        matched_file = find_supplier_file(selected_supplier, files)
        if not matched_file:
            messagebox.showerror("éŒ¯èª¤", f"æ‰¾ä¸åˆ° {selected_supplier} çš„å°æ‡‰æ–‡ä»¶")
            return
        supplier_file = os.path.join(folder, matched_file)
        
        # ç²å–éƒµä»¶å…§å®¹
        body = self.email_body_textbox.get("1.0", "end-1c")
        config_mgr = UnifiedConfigManager(master_config)
        email_sender = EmailSender(config_mgr)
        
        to_emails, cc_emails = email_sender.get_to_cc_emails(selected_supplier, master_config)
        from datetime import datetime, timedelta
        now = datetime.now()
        
        # è¨ˆç®—ä¸‹å‘¨çš„æ—¥æœŸ
        days_until_next_monday = (7 - now.weekday()) % 7
        if days_until_next_monday == 0:
            days_until_next_monday = 7
        next_monday = now + timedelta(days=days_until_next_monday)
        
        # ä½¿ç”¨ä¸‹å‘¨ä¸€çš„æœˆä»½å’Œé€±æ•¸
        month_name = next_monday.strftime("%B")
        week_of_month = get_week_of_month(next_monday)
        
        # è™•ç†éƒµä»¶æ­£æ–‡ä¸­çš„è®Šæ•¸æ›¿æ›
        body = body.replace("{month_week}", f"{month_name} - Week {week_of_month}")
        
        # è™•ç†ä¸»æ—¨
        subject = ""
        if self.use_custom_subject_var.get():
            custom_subject = self.email_subject_var.get().strip()
            if custom_subject:
                # æ›¿æ›ä¸»æ—¨ä¸­çš„è®Šæ•¸
                subject = custom_subject.replace("{week_no}", str(week_of_month)).replace("{Supplier}", selected_supplier).replace("{Month}", month_name)
            else:
                subject = f"{month_name} - Week {week_of_month}"
        else:
            subject = f"{month_name} - Week {week_of_month}"
        
        self.email_subject_var.set(subject if self.use_custom_subject_var.get() else "")
        
        # å‰µå»ºé è¦½çª—å£
        preview_window = ctk.CTkToplevel(self)
        preview_window.title(f"éƒµä»¶é è¦½ - {selected_supplier}")
        preview_window.geometry("600x500")
        preview_window.resizable(True, True)
        preview_window.attributes('-topmost', True)  # è¨­ç½®è¦–çª—ç½®é ‚
        preview_window.focus_force()  # å¼·åˆ¶èšç„¦
        
        # éƒµä»¶ä¿¡æ¯
        info_frame = ctk.CTkFrame(preview_window)
        info_frame.pack(fill="x", padx=10, pady=10)
        
        ctk.CTkLabel(info_frame, text=f"ä¾›æ‡‰å•†/Supplier: {selected_supplier}", font=FONT_MID).pack(anchor="w", padx=10, pady=5)
        ctk.CTkLabel(info_frame, text=f"ä¸»æ—¨/Subject: {subject}", font=FONT_MID, wraplength=500).pack(anchor="w", padx=10, pady=5)
        
        # æ”¶ä»¶äººéƒµç®±é¡¯ç¤º
        to_emails_text = ", ".join(to_emails) if to_emails else "ç„¡"
        to_label = ctk.CTkLabel(info_frame, text=f"æ”¶ä»¶äºº/To: {to_emails_text}", font=FONT_MID, wraplength=500)
        to_label.pack(anchor="w", padx=10, pady=5)
        
        ctk.CTkLabel(info_frame, text=f"é™„ä»¶/Attachment: {matched_file}", font=FONT_MID).pack(anchor="w", padx=10, pady=5)
        
        # éƒµä»¶æ­£æ–‡é è¦½ï¼ˆå¯ç·¨è¼¯ï¼‰
        ctk.CTkLabel(preview_window, text="éƒµä»¶æ­£æ–‡/Email Body (å¯ç·¨è¼¯):", font=FONT_MID).pack(anchor="w", padx=10, pady=(10,0))
        body_textbox = ctk.CTkTextbox(preview_window, height=200, font=FONT_MID, wrap="word")
        body_textbox.pack(fill="both", expand=True, padx=10, pady=10)
        body_textbox.insert("1.0", body)
        
        # æŒ‰éˆ•å€åŸŸ
        btn_frame = ctk.CTkFrame(preview_window)
        btn_frame.pack(fill="x", padx=10, pady=10)
        
        def send_this_email():
            # ç™¼é€é€™å°éƒµä»¶ï¼ˆä½¿ç”¨ç·¨è¼¯å¾Œçš„å…§å®¹ï¼‰
            edited_body = body_textbox.get("1.0", "end-1c")
            from datetime import datetime, timedelta
            now = datetime.now()
            
            # è¨ˆç®—ä¸‹å‘¨çš„æ—¥æœŸï¼ˆèˆ‡æ¨¡æ¿é‚è¼¯ä¸€è‡´ï¼‰
            days_until_next_monday = (7 - now.weekday()) % 7
            if days_until_next_monday == 0:
                days_until_next_monday = 7
            next_monday = now + timedelta(days=days_until_next_monday)
            
            # ä½¿ç”¨ä¸‹å‘¨ä¸€çš„æœˆä»½å’Œé€±æ•¸
            month_name = next_monday.strftime("%B")
            week_of_month = get_week_of_month(next_monday)
            month_week = f"{month_name} - Week {week_of_month}"
            
            # è™•ç†éƒµä»¶æ­£æ–‡ä¸­çš„è®Šæ•¸æ›¿æ›
            edited_body = edited_body.replace("{month_week}", month_week)
            
            # è™•ç†ä¸»æ—¨ä¸­çš„è®Šæ•¸æ›¿æ›
            final_subject = subject.replace("{month_week}", month_week).replace("{Supplier}", selected_supplier)
            
            mail = email_sender.send_email(
                to_emails, cc_emails, selected_supplier, edited_body,
                attachment_path=supplier_file,
                account_idx=self.selected_outlook_account_idx,
                subject=final_subject
            )
            if isinstance(mail, tuple):
                messagebox.showerror("Error", mail[1])
                return
            if not mail:
                messagebox.showerror("Error", f"æ— æ³•åˆ›å»ºé‚®ä»¶: {selected_supplier}")
                return
            # ç›´æ¥ç™¼é€ï¼Œä¸é¡¯ç¤º Outlook è¦–çª—
            try:
                mail.Send()
                messagebox.showinfo("æˆåŠŸ", f"éƒµä»¶å·²ç›´æ¥ç™¼é€çµ¦ {selected_supplier}")
                preview_window.destroy()
            except Exception as e:
                messagebox.showerror("ç™¼é€å¤±æ•—", f"ç™¼é€éƒµä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}")
        
        # ç¾åŒ–çš„ç™¼é€æŒ‰éˆ•
        send_btn = ctk.CTkButton(
            btn_frame, 
            text="ç™¼é€æ­¤éƒµä»¶/Send This Email", 
            command=send_this_email, 
            fg_color=ACCENT_RED,
            font=("Microsoft YaHei", 12, "bold"),
            corner_radius=10,
            hover_color="#d32f2f",
            height=35
        )
        send_btn.pack(side="right", padx=5)
        
        # ç¾åŒ–çš„é—œé–‰æŒ‰éˆ•
        close_btn = ctk.CTkButton(
            btn_frame, 
            text="é—œé–‰/Close", 
            command=preview_window.destroy,
            font=("Microsoft YaHei", 12, "bold"),
            corner_radius=10,
            hover_color="#1976d2",
            height=35
        )
        close_btn.pack(side="right", padx=5)

    def _show_email_directory(self):
        """é¡¯ç¤ºéƒµä»¶ç™¼é€ç›®éŒ„"""
        import os
        
        folder = self.email_supplier_folder_var.get()
        master_config = self.email_master_config_var.get()
        
        if not folder or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
            
        def destroy_window():
            """æ­£ç¢ºæ¸…ç†è¦–çª—åŠå…¶å­å…ƒä»¶"""
            try:
                # å…ˆæ¸…ç†æ‰€æœ‰è¡Œæ¡†æ¶
                for row_frame, _ in row_frames:
                    for widget in row_frame.winfo_children():
                        widget.destroy()
                    row_frame.destroy()
                row_frames.clear()
                
                # æ¸…ç†å…¶ä»–æ¡†æ¶å’Œå…ƒä»¶
                for widget in scroll_frame.winfo_children():
                    widget.destroy()
                scroll_frame.destroy()
                
                for widget in table_frame.winfo_children():
                    widget.destroy()
                table_frame.destroy()
                
                for widget in batch_frame.winfo_children():
                    widget.destroy()
                batch_frame.destroy()
                
                # æœ€å¾ŒéŠ·æ¯€è¦–çª—
                directory_window.destroy()
            except Exception as e:
                print(f"Error during window cleanup: {e}")
                # å¦‚æœæ¸…ç†éç¨‹å‡ºéŒ¯ï¼Œå¼·åˆ¶é—œé–‰è¦–çª—
                try:
                    directory_window.destroy()
                except:
                    pass
        
        # ç²å–æ‰€æœ‰å¯ç”¨çš„ä¾›æ‡‰å•†å’Œæ–‡ä»¶
        files = [f for f in os.listdir(folder) if f.endswith(".xlsx") and not f.startswith("~$")]
        master_config_path = self.email_master_config_var.get()
        config_mgr = UnifiedConfigManager(master_config_path)
        email_sender = EmailSender(config_mgr)
        
        # è®€å–é…ç½®æ–‡ä»¶ä¸­çš„ä¾›æ‡‰å•†ï¼Œä½¿ç”¨ dict ä¾†å»é‡è¤‡
        wb = load_workbook(master_config_path, data_only=True)
        supplier_dict = {}  # ä½¿ç”¨ dict ä¾†ä¿å­˜æ¯å€‹ä¾›æ‡‰å•†çš„ç¬¬ä¸€å€‹ email
        if "Suppliers" in wb.sheetnames:
            ws = wb["Suppliers"]
            seen_suppliers = set()  # ä½¿ç”¨ set ä¾†è¨˜éŒ„å·²è™•ç†çš„ä¾›æ‡‰å•†
            for row in ws.iter_rows(min_row=2, values_only=True):
                if row and row[0]:
                    supplier = str(row[0]).strip()
                    if supplier not in seen_suppliers:  # åªè™•ç†æ¯å€‹ä¾›æ‡‰å•†çš„ç¬¬ä¸€å€‹ email
                        seen_suppliers.add(supplier)
                        to_emails, cc_emails = email_sender.get_to_cc_emails(supplier, master_config_path)
                        supplier_dict[supplier] = {
                            'to_emails': to_emails,
                            'cc_emails': cc_emails
                        }

        # å‰µå»ºç›®éŒ„çª—å£
        directory_window = ctk.CTkToplevel(self)
        directory_window.title("éƒµä»¶ç™¼é€ç›®éŒ„ / Email Directory")
        directory_window.geometry("1200x800")  # åŠ å¤§è¦–çª—å°ºå¯¸
        directory_window.resizable(True, True)
        directory_window.attributes('-topmost', True)  # è¨­ç½®è¦–çª—ç½®é ‚
        directory_window.focus_force()  # å¼·åˆ¶èšç„¦

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(directory_window, text="ä¾›æ‡‰å•†éƒµä»¶ç™¼é€ç›®éŒ„\nSupplier Email Directory", font=FONT_TITLE)
        title_label.pack(pady=10)

        # å‰µå»ºè¡¨æ ¼æ¡†æ¶
        table_frame = ctk.CTkFrame(directory_window)
        table_frame.pack(fill="both", expand=True, padx=20, pady=10)

        # è¡¨æ ¼æ¨™é¡Œï¼ˆå¢åŠ é–“è·å’ŒèƒŒæ™¯è‰²ï¼‰
        header_frame = ctk.CTkFrame(table_frame, fg_color=ACCENT_BLUE)
        header_frame.pack(fill="x", padx=10, pady=10)

        ctk.CTkLabel(header_frame, text="ä¾›æ‡‰å•†/Supplier", font=FONT_MID, width=150, text_color="#ffffff").pack(side="left", padx=5)
        ctk.CTkLabel(header_frame, text="æ”¶ä»¶äºº/To", font=FONT_MID, width=400, text_color="#ffffff").pack(side="left", padx=5)
        ctk.CTkLabel(header_frame, text="é™„ä»¶/Attachment", font=FONT_MID, width=250, text_color="#ffffff").pack(side="left", padx=5)
        ctk.CTkLabel(header_frame, text="æ“ä½œ/Action", font=FONT_MID, width=100, text_color="#ffffff").pack(side="left", padx=5)

        # æœå°‹æ¡†æ¶
        search_frame = ctk.CTkFrame(table_frame)
        search_frame.pack(fill="x", padx=10, pady=5)

        ctk.CTkLabel(search_frame, text="æœå°‹ä¾›æ‡‰å•† / Search Supplier:", font=FONT_MID).pack(side="left", padx=5)
        search_var = ctk.StringVar()
        search_entry = ctk.CTkEntry(search_frame, textvariable=search_var, width=300)
        search_entry.pack(side="left", padx=5)

        # æ»¾å‹•æ¡†æ¶
        scroll_frame = ctk.CTkScrollableFrame(table_frame)
        scroll_frame.pack(fill="both", expand=True, padx=10, pady=5)

        # å„²å­˜æ‰€æœ‰è¡Œæ¡†æ¶çš„å¼•ç”¨ï¼Œç”¨æ–¼æœå°‹éæ¿¾
        row_frames = []
        email_list = []
        supplier_check_vars = {}  # æ–°å¢ï¼šæ¯å€‹ä¾›æ‡‰å•†çš„å‹¾é¸ç‹€æ…‹
        sent_status = {}  # æ–°å¢ï¼šè¨˜éŒ„å·²ç™¼é€ç‹€æ…‹

        def filter_rows(*args):
            """æ ¹æ“šæœå°‹æ–‡å­—éæ¿¾è¡Œ"""
            search_text = search_var.get().lower()
            visible_count = 0
            for row_frame, supplier_name in row_frames:
                if search_text in supplier_name.lower():
                    row_frame.pack(fill="x", padx=5, pady=5)
                    visible_count += 1
                else:
                    row_frame.pack_forget()
            # æ›´æ–°ç¸½çµä¿¡æ¯
            summary_label.configure(text=f"ç¸½å…±æ‰¾åˆ° {len(email_list)} å€‹ä¾›æ‡‰å•†ï¼Œé¡¯ç¤º {visible_count} å€‹")

        # ç¶å®šæœå°‹äº‹ä»¶
        search_var.trace("w", filter_rows)

        # åªè™•ç†æ¯å€‹ä¾›æ‡‰å•†ä¸€æ¬¡
        processed_suppliers = set()  # ä½¿ç”¨ set ä¾†è¨˜éŒ„å·²è™•ç†çš„ä¾›æ‡‰å•†
        for supplier in supplier_dict:
            if supplier in processed_suppliers:
                continue
            processed_suppliers.add(supplier)

            matched_file = find_supplier_file(supplier, files)
            if matched_file:
                to_emails = supplier_dict[supplier]['to_emails']
                cc_emails = supplier_dict[supplier]['cc_emails']

                row_frame = ctk.CTkFrame(scroll_frame)
                row_frames.append((row_frame, supplier))
                row_frame.pack(fill="x", padx=5, pady=5)

                var = ctk.BooleanVar(value=True)
                supplier_check_vars[supplier] = var
                check_btn = ctk.CTkCheckBox(row_frame, variable=var, text="", width=24)
                check_btn.pack(side="left", padx=5)
                supplier_label = ctk.CTkLabel(row_frame, text=supplier, font=FONT_MID, width=150)
                supplier_label.pack(side="left", padx=5)
                to_emails_text = ", ".join(to_emails) if to_emails else "ç„¡"
                to_label = ctk.CTkLabel(row_frame, text=to_emails_text, font=FONT_MID, width=400, wraplength=380)
                to_label.pack(side="left", padx=5)
                attachment_label = ctk.CTkLabel(row_frame, text=matched_file, font=FONT_MID, width=250)
                attachment_label.pack(side="left", padx=5)
                status_label = ctk.CTkLabel(row_frame, text="", font=FONT_MID, width=40)
                status_label.pack(side="left", padx=5)
                sent_status[supplier] = status_label

                def create_send_function(supplier, to_emails, cc_emails, attachment_file):
                    def send_email():
                        # ...åŸæœ¬å…§å®¹...
                        pass
                    return send_email

                send_btn = ctk.CTkButton(
                    row_frame, 
                    text="ç™¼é€/Send", 
                    command=create_send_function(supplier, to_emails, cc_emails, matched_file),
                    width=80,
                    height=30,
                    fg_color=ACCENT_RED,
                    font=("Microsoft YaHei", 11, "bold"),
                    corner_radius=8,
                    hover_color="#d32f2f"
                )
                send_btn.pack(side="right", padx=5)
                email_list.append({
                    'supplier': supplier,
                    'to_emails': to_emails,
                    'cc_emails': cc_emails,
                    'attachment': matched_file
                })
        # æ‰¹é‡ç™¼é€æŒ‰éˆ•
        batch_frame = ctk.CTkFrame(directory_window)
        batch_frame.pack(fill="x", padx=20, pady=10)
        
        def batch_send_selected():
            import threading
            import time
            from tkinter import messagebox
            selected_suppliers = [s for s, v in supplier_check_vars.items() if v.get()]
            if not selected_suppliers:
                messagebox.showwarning("æœªé¸æ“‡", "è«‹å…ˆå‹¾é¸è¦ç™¼é€çš„ä¾›æ‡‰å•†ï¼")
                return
            # å½ˆå‡ºé€²åº¦è¦–çª—
            progress_win = ctk.CTkToplevel(directory_window)
            progress_win.title("éƒµä»¶ç™¼é€é€²åº¦/Email Send Progress")
            progress_win.geometry("600x600")
            ctk.CTkLabel(progress_win, text="éƒµä»¶ç™¼é€é€²åº¦", font=FONT_TITLE).pack(pady=10)
            progress_frame = ctk.CTkScrollableFrame(progress_win)
            progress_frame.pack(fill="both", expand=True, padx=10, pady=10)
            progress_labels = {}
            for supplier in selected_suppliers:
                lbl = ctk.CTkLabel(progress_frame, text=f"{supplier} ...", font=FONT_MID)
                lbl.pack(anchor="w", pady=2)
                progress_labels[supplier] = lbl
            def send_all():
                for idx, supplier in enumerate(selected_suppliers):
                    entry = next((e for e in email_list if e['supplier'] == supplier), None)
                    if not entry:
                        progress_labels[supplier].configure(text=f"{supplier} - æª”æ¡ˆ/éƒµä»¶è³‡æ–™ç¼ºå¤±", text_color=ACCENT_RED)
                        continue
                    try:
                        body = self.email_body_textbox.get("1.0", "end-1c")
                        from datetime import datetime, timedelta
                        today = datetime.now().date()
                        this_monday = today - timedelta(days=today.weekday())
                        next_monday = this_monday + timedelta(days=7)
                        target_date = next_monday
                        month_name = target_date.strftime("%B")
                        week_of_month = get_week_of_month(target_date)
                        month_week = f"{month_name} - Week {week_of_month}"
                        body_filled = body.replace("{month_week}", month_week)
                        subject = f"Sushi Express Weekly Order - {supplier} - {month_name} - Week {week_of_month}"
                        mail = email_sender.send_email(
                            entry['to_emails'], entry['cc_emails'], supplier, body_filled,
                            attachment_path=os.path.join(folder, entry['attachment']),
                            account_idx=self.selected_outlook_account_idx,
                            subject=subject
                        )
                        if isinstance(mail, tuple) or not mail:
                            progress_labels[supplier].configure(text=f"{supplier} âœ— {mail[1] if isinstance(mail, tuple) else ''}", text_color=ACCENT_RED)
                            sent_status[supplier].configure(text="âœ—", text_color=ACCENT_RED)
                            continue
                        try:
                            mail.Send()
                            progress_labels[supplier].configure(text=f"{supplier} âœ” å·²ç™¼é€", text_color=ACCENT_GREEN)
                            sent_status[supplier].configure(text="âœ”", text_color=ACCENT_GREEN)
                        except Exception as e:
                            progress_labels[supplier].configure(text=f"{supplier} âœ— {str(e)}", text_color=ACCENT_RED)
                            sent_status[supplier].configure(text="âœ—", text_color=ACCENT_RED)
                    except Exception as e:
                        progress_labels[supplier].configure(text=f"{supplier} âœ— {str(e)}", text_color=ACCENT_RED)
                        sent_status[supplier].configure(text="âœ—", text_color=ACCENT_RED)
                    time.sleep(2)  # ç·©è¡ 2 ç§’
            threading.Thread(target=send_all).start()
        # æ–°å¢ã€Œç™¼é€å‹¾é¸ã€æŒ‰éˆ•
        send_selected_btn = ctk.CTkButton(
            batch_frame, 
            text="ç™¼é€å‹¾é¸éƒµä»¶\nSend Selected",
            command=batch_send_selected,
            width=200,
            height=50,
            fg_color=ACCENT_GREEN,
            font=("Microsoft YaHei", 12, "bold"),
            corner_radius=10,
            hover_color="#059669"
        )
        send_selected_btn.pack(side="right", padx=10)
        
        # ç¸½çµä¿¡æ¯
        summary_label = ctk.CTkLabel(directory_window, text=f"ç¸½å…±æ‰¾åˆ° {len(email_list)} å€‹ä¾›æ‡‰å•†å¯ä»¥ç™¼é€éƒµä»¶", font=FONT_MID)
        summary_label.pack(pady=10)

    def _show_batch_result(self, success_count, failed_count, failed_suppliers):
        """é¡¯ç¤ºæ‰¹é‡ç™¼é€çµæœ"""
        from tkinter import messagebox
        
        result_window = ctk.CTkToplevel(self)
        result_window.title("æ‰¹é‡ç™¼é€çµæœ / Batch Send Result")
        result_window.geometry("500x400")
        result_window.resizable(True, True)
        result_window.attributes('-topmost', True)  # è¨­ç½®è¦–çª—ç½®é ‚
        result_window.focus_force()  # å¼·åˆ¶èšç„¦
        
        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(result_window, text="æ‰¹é‡ç™¼é€çµæœ\nBatch Send Result", font=FONT_TITLE)
        title_label.pack(pady=10)
        
        # çµæœæ‘˜è¦
        summary_frame = ctk.CTkFrame(result_window)
        summary_frame.pack(fill="x", padx=20, pady=10)
        
        ctk.CTkLabel(summary_frame, text=f"æˆåŠŸç™¼é€: {success_count} å€‹ä¾›æ‡‰å•†", 
                    font=FONT_MID, text_color=ACCENT_GREEN).pack(anchor="w", padx=10, pady=5)
        ctk.CTkLabel(summary_frame, text=f"ç™¼é€å¤±æ•—: {failed_count} å€‹ä¾›æ‡‰å•†", 
                    font=FONT_MID, text_color=ACCENT_RED).pack(anchor="w", padx=10, pady=5)
        
        # å¤±æ•—è©³æƒ…
        if failed_suppliers:
            ctk.CTkLabel(result_window, text="å¤±æ•—è©³æƒ… / Failed Details:", font=FONT_MID).pack(anchor="w", padx=20, pady=(10,0))
            
            # æ»¾å‹•æ¡†æ¶é¡¯ç¤ºå¤±æ•—è©³æƒ…
            scroll_frame = ctk.CTkScrollableFrame(result_window)
            scroll_frame.pack(fill="both", expand=True, padx=20, pady=10)
            
            for supplier in failed_suppliers:
                ctk.CTkLabel(scroll_frame, text=f"â€¢ {supplier}", 
                            font=FONT_MID, text_color=ACCENT_RED).pack(anchor="w", padx=10, pady=2)
        
        # ç¾åŒ–çš„é—œé–‰æŒ‰éˆ•
        close_btn = ctk.CTkButton(
            result_window, 
            text="é—œé–‰/Close", 
            command=result_window.destroy,
            font=("Microsoft YaHei", 12, "bold"),
            corner_radius=10,
            hover_color="#1976d2",
            height=35
        )
        close_btn.pack(pady=10)



    def _send_supplier_emails(self):
        import os
        folder = self.email_supplier_folder_var.get()
        master_config = self.email_master_config_var.get()
        if not folder or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
        # é¸æ“‡Outlookå¸³è™Ÿï¼ˆåªé¸ä¸€æ¬¡ï¼‰
        if self.selected_outlook_account_idx is None:
            try:
                import win32com.client
                outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
                accounts = [outlook.Folders.Item(i + 1) for i in range(outlook.Folders.Count)]
                account_names = [acct.Name for acct in accounts]
                from tkinter import simpledialog
                # å»ºç«‹ä¸€å€‹ç½®é ‚çš„è‡¨æ™‚è¦–çª—ä½œç‚º parent
                import tkinter as tk
                top = tk.Toplevel()
                top.attributes('-topmost', True)
                top.withdraw()  # ä¸é¡¯ç¤ºå…§å®¹ï¼Œåªåšç‚º parent
                idx = simpledialog.askinteger(
                    "é¸æ“‡Outlookå¸³è™Ÿ/Select Outlook Account",
                    "\n".join([f"[{i}] {name}" for i, name in enumerate(account_names)]) + "\nè«‹è¼¸å…¥åºè™Ÿ/Please enter index:",
                    minvalue=0, maxvalue=len(account_names)-1,
                    parent=top
                )
                top.destroy()
                if idx is None:
                    messagebox.showwarning("å–æ¶ˆ/Cancelled", "æœªé¸æ“‡å¸³è™Ÿï¼Œå·²å–æ¶ˆç™¼é€/No account selected, sending cancelled.")
                    return
                self.selected_outlook_account_idx = idx
            except Exception as e:
                messagebox.showerror("éŒ¯èª¤/Error", f"ç²å–Outlookå¸³è™Ÿå¤±æ•—/Failed to get Outlook accounts: {e}")
            return
        # å–å¾—bodyå…§å®¹ï¼Œä¸¦ä¿å­˜åˆ°æœ¬åœ°
        body = self.email_body_textbox.get("1.0", "end-1c")
        try:
            with open("email_body.txt", "w", encoding="utf-8") as f:
                f.write(body)
        except Exception:
            pass
        # æª¢æŸ¥æ˜¯å¦æœ‰é¸å®šçš„ä¾›æ‡‰å•†
        selected_supplier = getattr(self, 'supplier_combobox', None)
        if selected_supplier:
            selected_supplier_name = selected_supplier.get()
            if selected_supplier_name and selected_supplier_name not in ["è«‹å…ˆé¸æ“‡æ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶", "æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¾›æ‡‰å•†æ–‡ä»¶"]:
                files = [f for f in os.listdir(folder) if f.endswith(".xlsx") and not f.startswith("~$")]
                config_mgr = UnifiedConfigManager(master_config)
                email_sender = EmailSender(config_mgr)
                matched_file = find_supplier_file(selected_supplier_name, files)
                if not matched_file:
                    messagebox.showerror("éŒ¯èª¤", f"æ‰¾ä¸åˆ° {selected_supplier_name} çš„å°æ‡‰æ–‡ä»¶")
                    return
                supplier_file = os.path.join(folder, matched_file)
                to_emails, cc_emails = email_sender.get_to_cc_emails(selected_supplier_name, master_config)
                from datetime import datetime
                now = datetime.now()
                week_no = now.isocalendar()[1]
                body_filled = body.replace("{week_no}", str(week_no))
                subject = f"Sushi Express Weekly Order - {selected_supplier_name} - {now.strftime('%B')} - Week {week_no}"
                mail = email_sender.send_email(
                    to_emails, cc_emails, selected_supplier_name, body_filled,
                    attachment_path=supplier_file,
                    account_idx=self.selected_outlook_account_idx,
                    subject=subject
                )
                if isinstance(mail, tuple):
                    messagebox.showerror("Error", mail[1])
                    return
                if not mail:
                    messagebox.showerror("Error", f"æ— æ³•åˆ›å»ºé‚®ä»¶: {selected_supplier_name}")
                    return
                messagebox.showinfo("æˆåŠŸ", f"éƒµä»¶å·²ç™¼é€çµ¦ {selected_supplier_name}")
                return
        
        # å¦‚æœæ²’æœ‰é¸å®šä¾›æ‡‰å•†ï¼Œå‰‡ç™¼é€çµ¦æ‰€æœ‰ä¾›æ‡‰å•†ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
        files = [f for f in os.listdir(folder) if f.endswith(".xlsx") and not f.startswith("~$")]
        config_mgr = UnifiedConfigManager(master_config)
        email_sender = EmailSender(config_mgr)
        supplier_names = set()
        wb = load_workbook(master_config, data_only=True)
        if "Suppliers" in wb.sheetnames:
            ws = wb["Suppliers"]
            for row in ws.iter_rows(min_row=2, values_only=True):
                if row and row[0]:
                    supplier_names.add(str(row[0]).strip())
        from datetime import datetime
        email_list = []
        matched_files = set()
        for sname in supplier_names:
            matched_file = find_supplier_file(sname, files)
            if not matched_file:
                continue
            matched_files.add(matched_file)
            supplier_file = os.path.join(folder, matched_file)
            to_emails, cc_emails = email_sender.get_to_cc_emails(sname, master_config)
            now = datetime.now()
            week_no = now.isocalendar()[1]
            body_filled = body.replace("{week_no}", str(week_no))
            subject = f"Sushi Express Weekly Order - {sname} - {now.strftime('%B')} - Week {week_no}"
            mail = email_sender.send_email(
                to_emails, cc_emails, sname, body_filled,
                attachment_path=supplier_file,
                account_idx=self.selected_outlook_account_idx,
                subject=subject
            )
            if isinstance(mail, tuple):
                messagebox.showerror("Error", mail[1])
                continue
            if not mail:
                messagebox.showerror("Error", f"æ— æ³•åˆ›å»ºé‚®ä»¶: {sname}")
                continue
            email_list.append((mail, sname, supplier_file))
        unmatched_files = [f for f in files if f not in matched_files]
        if unmatched_files:
            messagebox.showwarning("æœªé…å°æª”æ¡ˆ", f"ä»¥ä¸‹æª”æ¡ˆæœªé…å°åˆ°ä»»ä½•Supplierï¼Œæœªç™¼é€éƒµä»¶ï¼š\n" + "\n".join(unmatched_files))
        for mail, matched_supplier, supplier_file in email_list:
            def on_confirm(success, msg, ms=matched_supplier):
                if success:
                    messagebox.showinfo("Success", f"{ms} éƒµä»¶å·²ç™¼é€ï¼")
                else:
                    messagebox.showinfo("å·²å–æ¶ˆ/Cancelled", f"{ms} éƒµä»¶æœªç™¼é€ã€‚")
            EmailConfirmationDialog(self, mail, matched_supplier, "-", supplier_file, on_confirm)
    
    def show_operation_supplies_ui(self):
        """æ˜¾ç¤ºè¿è¥ç”¨å“ç•Œé¢"""
        def build(c):
            self.master_file_var = ctk.StringVar()
            self.output_folder_var = ctk.StringVar()
            
            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(fill="both", expand=True, padx=50, pady=20)
            
            # ä¸»æ–‡ä»¶é€‰æ‹©
            row1 = ctk.CTkFrame(form_frame)
            row1.pack(fill="x", pady=15)
            ctk.CTkLabel(row1, text="é€‰æ‹©ä¸»æ–‡ä»¶/Select Master File:", font=FONT_MID).pack(side="left", padx=10)
            ctk.CTkEntry(row1, textvariable=self.master_file_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            ctk.CTkButton(row1, text=t("browse"), font=FONT_MID, command=self._select_master_file).pack(side="left", padx=5)
            
            # è¾“å‡ºæ–‡ä»¶å¤¹é€‰æ‹©
            row2 = ctk.CTkFrame(form_frame)
            row2.pack(fill="x", pady=15)
            ctk.CTkLabel(row2, text="é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹/Select Output Folder:", font=FONT_MID).pack(side="left", padx=10)
            ctk.CTkEntry(row2, textvariable=self.output_folder_var, font=FONT_MID, state="readonly", width=400).pack(side="left", expand=True, fill="x", padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
            browse_btn_output = ctk.CTkButton(
                row2, 
                text="ç€è¦½...\nBrowse...", 
                font=("Microsoft YaHei", 11, "bold"),
                command=self._select_output_folder,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_output.pack(side="left", padx=5)
            
            # å¼€å§‹å¤„ç†æŒ‰é’®
            btn_frame = ctk.CTkFrame(c, fg_color="transparent")
            btn_frame.pack(pady=30)
            GlowButton(
                btn_frame, 
                text="å¼€å§‹å¤„ç†/Start Processing",
                command=self._run_operation_supplies,
                width=300,
                height=60,
                glow_color="#F97316"
            ).pack()
        
        self._show_function_ui(
            "operation_supplies",
            ("å¤„ç†è¿è¥ç”¨å“æœˆè®¢å•\nProcess monthly operation supplies orders", FONT_TITLE),
            build
        )

    def _select_master_file(self):
        """é€‰æ‹©ä¸»æ–‡ä»¶"""
        f = filedialog.askopenfilename(title=t("select_folder"), filetypes=[("Excel","*.xlsx;*.xls")])
        if f: self.master_file_var.set(f)

    def _select_output_folder(self):
        """é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹"""
        f = filedialog.askdirectory(title=t("select_folder"))
        if f: self.output_folder_var.set(f)

    def _run_operation_supplies(self):
        """è¿è¡Œè¿è¥ç”¨å“å¤„ç†"""
        mf, of = self.master_file_var.get(), self.output_folder_var.get()
        if not mf or not of: messagebox.showwarning(t("warning"), t("folder_warning")); return
        p = ProgressPopup(self, t("processing"))
        self.progress_popup = p
        def logcb(m): p.log(m)
        threading.Thread(target=lambda: self._thread_task(lambda: OperationSuppliesOrder.process_order(mf, of, logcb))).start()

    def _thread_task(self, fn, show_message=True):
        """çº¿ç¨‹ä»»åŠ¡"""
        try:
            result = fn()
            if show_message:
                self.after(0, lambda: messagebox.showinfo(t("success"), result))
        except Exception as e:
            error_msg = str(e)
            self.after(0, lambda: messagebox.showerror(t("error"), f"æ“ä½œå¤±è´¥: {error_msg}"))

    def _select_download_folder(self):
        f = filedialog.askdirectory(title=t("select_folder"))
        if f:
            self.download_folder_var.set(f)

    def _select_checklist_folder(self):
        f = filedialog.askdirectory(title=t("select_folder"))
        if f:
            self.checklist_folder_var.set(f)

    def _run_download(self):
        """åŸ·è¡Œä¸‹è¼‰"""
        folder = self.download_folder_var.get()
        config_file = self.config_file_var.get()
        if not folder:
            messagebox.showwarning("è­¦å‘Š", "è«‹é¸æ“‡ä¸‹è¼‰è³‡æ–™å¤¾ï¼")
            return
        
        # è¨ˆç®—ä¸‹è¼‰æ—¥æœŸç¯„åœ
        from datetime import datetime, timedelta
        today = datetime.now()
        days_since_last_friday = (today.weekday() - 4) % 7 or 7
        start_of_period = (today - timedelta(days=days_since_last_friday)).replace(hour=0, minute=0, second=0, microsecond=0)
        end_of_period = today.replace(hour=23, minute=59, second=59, microsecond=999999)
        start_date = start_of_period.strftime("%Y-%m-%d")
        end_date = end_of_period.strftime("%Y-%m-%d")
        
        # å‰µå»ºé€²åº¦å½ˆçª—ï¼Œé¡¯ç¤ºæ—¥æœŸç¯„åœ
        p = ProgressPopup(self, "ä¸‹è¼‰ä¸­...", start_date, end_date, 0)
        self.progress_popup = p
        
        def log_callback(message):
            # æ¯å€‹æ¶ˆæ¯å¾Œé¢æ·»åŠ ç©ºè¡Œ
            p.log(message + "\n")
            print(message)  # åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°
        
        self._thread_task(
            lambda: OutlookDownloader.download_weekly_orders(
                folder, config_file, self.selected_outlook_account_idx,
                callback=log_callback, progress_popup=p
            ),
            show_message=False
        )



    def _run_download_amendments(self):
        """åŸ·è¡Œ Amendment ä¸‹è¼‰"""
        folder = self.download_folder_var.get()
        config_file = self.config_file_var.get()
        if not folder:
            messagebox.showwarning("è­¦å‘Š", "è«‹é¸æ“‡ä¸‹è¼‰è³‡æ–™å¤¾ï¼")
            return
        
        # è¨ˆç®—ä¸‹è¼‰æ—¥æœŸç¯„åœ
        from datetime import datetime, timedelta
        today = datetime.now()
        days_since_last_friday = (today.weekday() - 4) % 7 or 7
        start_of_period = (today - timedelta(days=days_since_last_friday)).replace(hour=0, minute=0, second=0, microsecond=0)
        end_of_period = today.replace(hour=23, minute=59, second=59, microsecond=999999)
        start_date = start_of_period.strftime("%Y-%m-%d")
        end_date = end_of_period.strftime("%Y-%m-%d")
        
        # å‰µå»ºé€²åº¦å½ˆçª—ï¼Œé¡¯ç¤ºæ—¥æœŸç¯„åœ
        p = ProgressPopup(self, "ä¸‹è¼‰ Amendment ä¸­...", start_date, end_date, 0)
        self.progress_popup = p
        
        def log_callback(message):
            # æ¯å€‹æ¶ˆæ¯å¾Œé¢æ·»åŠ ç©ºè¡Œ
            p.log(message + "\n")
            print(message)  # åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°
        
        self._thread_task(
            lambda: OutlookDownloader.download_amendment_orders(
                folder, config_file, self.selected_outlook_account_idx,
                callback=log_callback, progress_popup=p
            ),
            show_message=False
        )

    def _run_enhanced_automation(self):
        source = self.folder_vars.get("source_folder", ctk.StringVar()).get()
        supplier = self.folder_vars.get("supplier_folder", ctk.StringVar()).get()
        master_config = self.master_config_var.get()
        if not source or not supplier or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
        p = ProgressPopup(self, t("processing"))
        self.progress_popup = p
        def logcb(m): p.log(m)
        config_mgr = UnifiedConfigManager(master_config)
        auto = EnhancedOrderAutomation(config_mgr)
        import threading
        def run_and_show_count():
            result = auto.run_automation(source, supplier, log_callback=logcb)[1]
            # çµ±è¨ˆå·²æ•´ç†åˆ†åº—æ•¸é‡
            import re
            outlet_count = 0
            for line in result.splitlines():
                m = re.match(r"- (.+)_Week", line)
                if m:
                    outlet_count += 1
            # åœ¨ popup ä¸‹æ–¹é¡¯ç¤º
            if hasattr(p, 'outlet_count_label') and p.outlet_count_label:
                p.outlet_count_label.configure(text=f"ğŸª å·²æ•´ç†åˆ†åº—æ•¸é‡: {outlet_count} é–“", text_color="#10b981")
            else:
                import customtkinter as ctk
                p.outlet_count_label = ctk.CTkLabel(
                    p,
                    text=f"ğŸª å·²æ•´ç†åˆ†åº—æ•¸é‡: {outlet_count} é–“",
                    font=("Microsoft JhengHei", 18, "bold"),
                    text_color="#10b981"
                )
                p.outlet_count_label.pack(pady=(0, 10))
        threading.Thread(target=run_and_show_count).start()

    def _run_yellow_highlighted_automation(self):
        """åªæ•´åˆæœ‰é»ƒè‰²æ¨™è¨˜çš„è¨‚å–®"""
        source = self.folder_vars.get("source_folder", ctk.StringVar()).get()
        supplier = self.folder_vars.get("supplier_folder", ctk.StringVar()).get()
        master_config = self.master_config_var.get()
        if not source or not supplier or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
        
        p = ProgressPopup(self, "è™•ç†é»ƒè‰²æ¨™è¨˜è¨‚å–®ä¸­...")
        self.progress_popup = p
        def logcb(m): p.log(m)
        
        config_mgr = UnifiedConfigManager(master_config)
        auto = YellowHighlightedOrderAutomation(config_mgr)
        
        import threading
        def run_and_show_count():
            result = auto.run_automation(source, supplier, log_callback=logcb)[1]
            # çµ±è¨ˆå·²æ•´ç†åˆ†åº—æ•¸é‡
            import re
            outlet_count = 0
            for line in result.splitlines():
                m = re.match(r"- (.+)_Week", line)
                if m:
                    outlet_count += 1
            # åœ¨ popup ä¸‹æ–¹é¡¯ç¤º
            if hasattr(p, 'outlet_count_label') and p.outlet_count_label:
                p.outlet_count_label.configure(text=f"ğŸª å·²æ•´ç†åˆ†åº—æ•¸é‡: {outlet_count} é–“", text_color="#f59e0b")
            else:
                import customtkinter as ctk
                p.outlet_count_label = ctk.CTkLabel(
                    p,
                    text=f"ğŸª å·²æ•´ç†åˆ†åº—æ•¸é‡: {outlet_count} é–“",
                    font=("Microsoft JhengHei", 18, "bold"),
                    text_color="#f59e0b"
                )
                p.outlet_count_label.pack(pady=(0, 10))
        threading.Thread(target=run_and_show_count).start()

    def _select_config_file(self, var=None, filetypes=None):
        f = filedialog.askopenfilename(title=t("select_folder"), filetypes=filetypes or [("Excel files", "*.xlsx;*.xls")])
        if f:
            if var:
                var.set(f)
            else:
                self.config_file_var.set(f)

    def _select_master_config(self):
        """é€‰æ‹©ä¸»é…ç½®æ–‡ä»¶"""
        from tkinter import filedialog
        f = filedialog.askopenfilename(
            title="é€‰æ‹©ä¸»é…ç½®æ–‡ä»¶/Select Master Config File",
            filetypes=[("Excel files", "*.xlsx;*.xls")]
        )
        if f:
            self.master_config_var.set(f)

    def _select_folder(self, key):
        f = filedialog.askdirectory(title=t("select_folder"))
        if f:
            self.folder_vars[key].set(f)

    def _select_folder_var(self, var):
        f = filedialog.askdirectory(title=t("select_folder"))
        if f:
            var.set(f)

    def _show_required_outlets_window(self):
        import pandas as pd
        import tkinter.ttk as ttk
        master_config = self.master_config_var.get()
        df_req = pd.read_excel(master_config, sheet_name="Supplier Requirements")
        config_suppliers = set(str(row[0]).strip() for _, row in df_req.iterrows() if str(row[0]).strip())

        win = ctk.CTkToplevel(self)
        win.title("å¿…è¦é–€å¸‚æ¸…å–®/Required Outlets List")
        win.geometry("800x500")
        ctk.CTkLabel(win, text="ğŸ“‹ ä¾›æ‡‰å•†/Supplier        â—ç¼ºæ¼åˆ†åº—/Missing Outlets", font=FONT_BIGBTN).pack(pady=10)
        frame = ctk.CTkFrame(win)
        frame.pack(fill="both", expand=True, padx=10, pady=10)
        tree = ttk.Treeview(frame, columns=("supplier", "missing"), show="headings", height=16)
        tree.heading("supplier", text="ğŸ“‹ ä¾›æ‡‰å•†/Supplier")
        tree.heading("missing", text="â—ç¼ºæ¼åˆ†åº—/Missing Outlets")
        tree.column("supplier", width=180, anchor="center")
        tree.column("missing", width=600, anchor="w")

        # 1. åˆ†çµ„æ•´ç† missing outletï¼Œåªé‡å° config supplier
        missing_by_supplier = {}
        for row in getattr(self, '_checklist_table_data', []):
            if row.get("cover_status") == "âŒ":
                supplier = str(row.get("supplier", "")).strip()
                outlet = str(row.get("outlet", "")).strip()
                if supplier in config_suppliers:
                    if supplier not in missing_by_supplier:
                        missing_by_supplier[supplier] = []
                    missing_by_supplier[supplier].append(outlet)

        # 2. é¡¯ç¤º
        for supplier in config_suppliers:
            if supplier in missing_by_supplier:
                tree.insert("", "end", values=(supplier, ", ".join(missing_by_supplier[supplier])))
        tree.pack(fill="both", expand=True)

        # è‹¥æ²’æœ‰ä»»ä½•ç¼ºæ¼
        if not any(missing_by_supplier.values()):
            tree.insert("", "end", values=("âœ” All covered", ""))

        # è¤‡è£½æŒ‰éˆ•
        def copy_selected():
            items = tree.selection()
            if not items:
                return
            import pyperclip
            rows = []
            for item in items:
                vals = tree.item(item, "values")
                rows.append("\t".join(vals))
            pyperclip.copy("\n".join(rows))
            messagebox.showinfo("è¤‡è£½æˆåŠŸ/Copy Success", "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼/Copied to clipboard!")
        ctk.CTkButton(win, text="è¤‡è£½æ‰€é¸/Copy Selected", command=copy_selected).pack(pady=5)

    def show_user_guide(self):
        """æ˜¾ç¤ºç”¨æˆ·æŒ‡å—"""
        try:
            guide_path = resource_path("UserGuide.txt")
            if os.path.exists(guide_path):
                with open(guide_path, "r", encoding="utf-8") as f:
                    content = f.read()
                ScrollableMessageBox(self, "ç”¨æˆ·æŒ‡å—", content)
            else:
                messagebox.showwarning("æŒ‡å—ç¼ºå¤±", "ç”¨æˆ·æŒ‡å—æ–‡ä»¶æœªæ‰¾åˆ°")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"æ— æ³•åŠ è½½ç”¨æˆ·æŒ‡å—: {str(e)}")

    def _run_cross_check_email_log(self):
        import os
        import re
        import pandas as pd
        import customtkinter as ctk
        folder = self.checklist_folder_var.get()
        table = getattr(self, '_checklist_table_data', [])
        config_path = self.master_config_var.get()
        email_log_path = os.path.join(folder, "email_bodies_log.txt")
        if not os.path.exists(email_log_path):
            from tkinter import messagebox
            messagebox.showinfo("äº¤å‰æª¢æŸ¥çµæœ\nCross Check Result", "æ‰¾ä¸åˆ° email_bodies_log.txtï¼\nEmail log not found!")
            return
        # 1. è®€å– OUTLET mapping
        outlet_map = {}
        unknown_records = []  # æ”¶é›† unknown éƒµä»¶è³‡è¨Š
        if os.path.exists(config_path):
            try:
                df = pd.read_excel(config_path, sheet_name=None)
                outlet_df = None
                for key in df.keys():
                    if key.strip().lower() in ["outlets", "outlet"]:
                        outlet_df = df[key]
                        break
                if outlet_df is not None:
                    for _, row in outlet_df.iterrows():
                        short = str(row[0]).strip().upper() if pd.notna(row[0]) else ''
                        full = str(row[1]).strip() if pd.notna(row[1]) else ''
                        email = str(row[2]).strip().lower() if pd.notna(row[2]) else ''
                        # æ”¯æ´ Alias/Keyword æ¬„ï¼ˆç¬¬4æ¬„æˆ–ç¬¬5æ¬„ï¼Œå…è¨±å¤šå€‹é€—è™Ÿåˆ†éš”ï¼‰
                        alias_col = None
                        for idx in range(3, len(row)):
                            colname = str(outlet_df.columns[idx]).strip().lower()
                            if colname in ["alias", "keyword", "åˆ¥å", "é—œéµå­—"]:
                                alias_col = idx
                                break
                        aliases = []
                        if alias_col is not None and pd.notna(row[alias_col]):
                            aliases = [a.strip() for a in str(row[alias_col]).split(",") if a.strip()]
                        # å»ºç«‹ mapping
                        for key in [short, full, email] + aliases:
                            k = key.strip().lower().replace(" ", "")
                            if k:
                                outlet_map[k] = short
            except Exception as e:
                print(f"[DEBUG] è®€ config å‡ºéŒ¯: {e}")
        def normalize_name(name):
            if not name:
                return ""
            import re
            name = re.sub(r'\(.*?\)', '', name)
            name = re.sub(r'update', '', name, flags=re.IGNORECASE)
            name = re.sub(r'[^a-zA-Z0-9]', '', name)
            return name.strip().upper()
        def is_supplier_match(s1, s2):
            n1, n2 = normalize_name(s1), normalize_name(s2)
            return n1 in n2 or n2 in n1 or (len(n1) > 3 and n1[:4] in n2) or (len(n2) > 3 and n2[:4] in n1)
        def is_cover_status_ok(status):
            return any(x in status for x in ['âœ”', 'âœ“'])
        # ===== Outlet mapping èˆ‡æ–°ç‰ˆæ¯”å° function =====
        short_to_full = {}
        full_to_short = {}
        email_name_to_short = {}
        outlet_all_names = set()
        # ä¿®æ­£ master_config æœªå®šä¹‰ä¸º config_path
        if os.path.exists(config_path):
            try:
                df = pd.read_excel(config_path, sheet_name=None)
                outlet_df = None
                for key in df.keys():
                    if key.strip().lower() == "outlet":
                        outlet_df = df[key]
                        break
                if outlet_df is not None:
                    for _, row in outlet_df.iterrows():
                        short = str(row.get("Short Name", "")).strip()
                        full = str(row.get("Outlet Full Name", "")).strip()
                        email_name = str(row.get("Name in Email", "")).strip()
                        n_short = normalize_name(short)
                        n_full = normalize_name(full)
                        n_email = normalize_name(email_name)
                        if short:
                            short_to_full[n_short] = full
                            outlet_all_names.add(n_short)
                        if full:
                            full_to_short[n_full] = short
                            outlet_all_names.add(n_full)
                        if email_name:
                            email_name_to_short[n_email] = short
                            outlet_all_names.add(n_email)
            except Exception as e:
                print("Outlet mapping read error:", e)
        def is_outlet_match(req_outlet, ordered_outlet):
            n_req = normalize_name(req_outlet)
            n_ordered = normalize_name(ordered_outlet)
            # ä¸‰è€…ä»»å…©å€‹ normalize å¾Œæœ‰ match å°± True
            if n_req and n_ordered and n_req == n_ordered:
                return True
            if n_req in outlet_all_names or n_ordered in outlet_all_names:
                return True
            for n in outlet_all_names:
                if n == n_req or n == n_ordered:
                    return True
            return False
        # 2. è§£æ email log
        with open(email_log_path, "r", encoding="utf-8") as f:
            content = f.read()
        outlet_results = {}
        import re
        blocks = re.split(r"â€”â€”â€” ?é‚®ä»¶ ?\d+ ?â€”â€”â€”", content)
        for block in blocks:
            lines = [l.strip() for l in block.strip().splitlines() if l.strip()]
            if not lines or len(lines) < 2:
                continue
            outlet_raw = ""
            for l in lines:
                m = re.match(r"\[å‘ä»¶äºº\](.+)", l)
                if m:
                    outlet_raw = m.group(1).strip()
                    break
            if not outlet_raw:
                continue
            outlet_norm = normalize_name(outlet_raw)
            outlet_short = outlet_map.get(outlet_norm.lower(), outlet_raw)
            # å…ˆ map æˆ shortï¼Œå†æ‰¾ config excel çš„å…¨å
            outlet_full = outlet_raw
            if os.path.exists(config_path):
                try:
                    df = pd.read_excel(config_path, sheet_name=None)
                    outlet_df = None
                    for key in df.keys():
                        if key.strip().lower() == "outlet":
                            outlet_df = df[key]
                            break
                    if outlet_df is not None:
                        for _, row in outlet_df.iterrows():
                            short = str(row.get("Short Name", "")).strip()
                            full = str(row.get("Outlet Full Name", "")).strip()
                            if short and short == outlet_short:
                                outlet_full = full
                                break
                except Exception as e:
                    pass
            outlet_norm_full = normalize_name(outlet_full)
            claimed = []
            for line in lines:
                m = re.match(r"\d+\.\s*(.+)", line)
                if m:
                    claimed.append(m.group(1).strip())
            found = set()
            for row in table:
                row_outlet_norm = normalize_name(row["outlet"])
                # outlet æ¯”å°åŠ å¼·ï¼šå…è¨± substring/å‰4ç¢¼
                outlet_match = is_outlet_match(row["outlet"], outlet_full)
                for s in claimed:
                    supplier_match = is_supplier_match(row["supplier"], s)
                    cover_ok = is_cover_status_ok(row["cover_status"])
                    print(f"[DEBUG] æ¯”å°: supplier: {normalize_name(row['supplier'])} <-> {normalize_name(s)} | outlet: {row['outlet']} <-> {outlet_full} | outlet_match: {outlet_match} | cover: {row['cover_status']} => {cover_ok}")
                    if outlet_full and outlet_match and supplier_match and cover_ok:
                        found.add(s)
            outlet_results[outlet_full] = []
            for supplier in claimed:
                if supplier in found:
                    outlet_results[outlet_full].append((supplier, True))
                else:
                    outlet_results[outlet_full].append((supplier, False))
        # å°‡ outlet_results è½‰æˆè¡¨æ ¼è³‡æ–™
        table_data = []
        for outlet, suppliers in outlet_results.items():
            for supplier, ok in suppliers:
                status = "âœ” æœ‰æ•´åˆï¼\nIntegrated!" if ok else "âœ— æ²’æœ‰æ•´åˆï¼\nNot Integrated!"
                table_data.append((supplier, outlet, status, ok))
        class CrossCheckResultTable(ctk.CTkToplevel):
            def __init__(self, master, table_data):
                super().__init__(master)
                self.title("äº¤å‰æª¢æŸ¥çµæœ\nCross Check Result")
                self.geometry("700x700")
                self.search_var = ctk.StringVar()
                ctk.CTkLabel(self, text="æœå°‹/åˆ†åº—/ä¾›æ‡‰å•†\nSearch Outlet/Supplier").pack(pady=(10, 0))
                search_entry = ctk.CTkEntry(self, textvariable=self.search_var)
                search_entry.pack(fill="x", padx=10)
                search_entry.bind("<KeyRelease>", self.update_filter)
                import tkinter as tk
                from tkinter import ttk
                frame = ctk.CTkFrame(self)
                frame.pack(fill="both", expand=True, padx=10, pady=10)
                columns = ("supplier", "outlet", "status")
                self.tree = ttk.Treeview(frame, columns=columns, show="headings", height=25)
                self.tree.heading("supplier", text="ä¾›æ‡‰å•†\nSupplier")
                self.tree.heading("outlet", text="åˆ†åº—\nOutlet")
                self.tree.heading("status", text="ç‹€æ…‹\nStatus")
                self.tree.column("supplier", width=180)
                self.tree.column("outlet", width=120)
                self.tree.column("status", width=180)
                self.tree.pack(fill="both", expand=True)
                vsb = ttk.Scrollbar(frame, orient="vertical", command=self.tree.yview)
                self.tree.configure(yscroll=vsb.set)
                vsb.pack(side="right", fill="y")
                self.full_data = [(s, o, st) for s, o, st, _ in table_data]
                self.update_table(self.full_data)
                ctk.CTkButton(self, text="é—œé–‰\nClose", command=self.destroy).pack(pady=10)
            def update_table(self, data):
                for row in self.tree.get_children():
                    self.tree.delete(row)
                for supplier, outlet, status in data:
                    self.tree.insert("", "end", values=(supplier, outlet, status))
            def update_filter(self, event=None):
                keyword = self.search_var.get().lower()
                filtered = [row for row in self.full_data if keyword in row[0].lower() or keyword in row[1].lower()]
                self.update_table(filtered)
        CrossCheckResultTable(self, table_data)

    def show_download_summary(self, start_date, end_date, outlet_count):
        # æ¸…ç©ºå…§å®¹å€
        for w in self.content_body.winfo_children():
            w.destroy()
        frame = ctk.CTkFrame(self.content_body, fg_color="#1e293b", corner_radius=18)
        frame.pack(fill="both", expand=True, padx=60, pady=60)
        ctk.CTkLabel(
            frame,
            text=f"ğŸ“… æŠ“å–æ—¥æœŸç¯„åœ\n{start_date} ~ {end_date}",
            font=("Microsoft JhengHei", 24, "bold"),
            text_color="#3b82f6"
        ).pack(pady=(30, 10))
        ctk.CTkFrame(frame, height=2, fg_color="#60a5fa").pack(fill="x", padx=20, pady=10)
        ctk.CTkLabel(
            frame,
            text=f"ğŸª å·²ä¸‹è¼‰åˆ†åº—æ•¸é‡\n{outlet_count} é–“",
            font=("Microsoft JhengHei", 28, "bold"),
            text_color="#10b981"
        ).pack(pady=(10, 30))

# ========== Outlookä¸‹è½½å™¨ ==========
class OutlookDownloader:
    """Outlookè®¢å•ä¸‹è½½å™¨"""
    
    OUTLET_MAP = {
        "century": "CSQ", "clementi": "TCM", "funan": "FN", "heartbeat": "HBB",
        "heartland": "HLM", "hillion": "HM", "hougang": "HGM", "imm": "IMM",
        "jurong": "JP", "nex": "NEX", "north point city": "NPG", "north point": "NPC",
        "parkway": "PP", "paya lebar": "PLQ", "sengkang grand": "SKG", "seletar": "SM",
        "sun plaza": "SP", "waterway": "WWP", "westgate": "WG", "white sands": "WS",
        "cityvibe": "GTM", "tampines smrt": "TSMRT", "woodlands": "WL", "toa payoh": "TPY",
        "junction 8": "J8TO", "hougang mrt": "HGTO", "oasis": "OASIS", "sengkang mrt": "SKMRT",
        "yew tee": "YTS", "poiz": "TPC", "central kitchen": "CK GOGO", "bugis": "Bugis",
        "313": "Sushi+ 313", "tampines one": "T1", "ang mo kio": "AMK", "canberra": "CBP",
        "gombak": "BKG", "pasir ris": "PRM", "lavendar": "VHL", "west mall": "WSM"
    }
    
    @staticmethod
    def get_smtp_address(msg):
        """å–å¾—éƒµä»¶çš„ SMTP æ ¼å¼å¯„ä»¶äººï¼Œå¼·åŒ– fallbackï¼Œæ”¯æ´ Exchange éƒµä»¶"""
        try:
            if hasattr(msg, "SenderEmailType") and msg.SenderEmailType == "SMTP":
                return str(msg.SenderEmailAddress).lower().strip()
            if hasattr(msg, "Sender") and hasattr(msg.Sender, "GetExchangeUser"):
                try:
                    ex_user = msg.Sender.GetExchangeUser()
                    if ex_user and hasattr(ex_user, "PrimarySmtpAddress"):
                        smtp = str(ex_user.PrimarySmtpAddress).lower().strip()
                        if smtp:
                            return smtp
                except Exception:
                    pass
            # æ–°å¢ï¼šç”¨ MAPI å±¬æ€§æŠ“ SMTP
            try:
                mapi = msg.Sender
                smtp = mapi.PropertyAccessor.GetProperty("http://schemas.microsoft.com/mapi/proptag/0x39FE001E")
                if smtp:
                    return str(smtp).lower().strip()
            except Exception:
                pass
            # fallback: ç›´æ¥ç”¨ SenderEmailAddressï¼ˆå³ä½¿æ˜¯ EXï¼‰
            if hasattr(msg, "SenderEmailAddress"):
                email_addr = str(msg.SenderEmailAddress).lower().strip()
                if email_addr:
                    return email_addr
            # fallback: ç›´æ¥ç”¨ SenderName
            if hasattr(msg, "SenderName"):
                return str(msg.SenderName).lower().strip()
        except Exception:
            pass
        return ""

    @classmethod
    def read_outlet_config(cls, config_file):
        import pandas as pd
        df = pd.read_excel(config_file)
        outlets = []
        emails = []
        for _, row in df.iterrows():
            # å¼·åˆ¶ç”¨ column C (index 2) ä½œç‚º emailï¼Œä¸¦è½‰å°å¯«
            email = str(row.iloc[2]).strip().lower() if len(row) > 2 and not pd.isna(row.iloc[2]) else ''
            short_name = str(row.iloc[0]).strip() if len(row) > 0 and not pd.isna(row.iloc[0]) else ''
            if not email or not short_name:
                continue
            emails.append(email)
            outlets.append({
                'email': email,
                'short_name': short_name,
            })
        print('[DEBUG] All emails from config:', emails)
        return outlets

    @classmethod
    def download_weekly_orders(cls, destination_folder, config_file=None, account_idx=None, callback=None, progress_popup=None):
        import win32com.client
        from datetime import datetime, timedelta
        import os
        import re
        import pandas as pd
        import hashlib
        # å–å¾—ä»Šå¤©æ—¥æœŸ
        today = datetime.now()
        week_no = today.isocalendar()[1]
        
        # ====== æ­£ç¢ºå›æ¨åˆ°ä¸Šé€±äº” ======
        # today.weekday(): 0=Mon, 4=Fri, 6=Sun
        days_since_last_friday = (today.weekday() - 4) % 7 or 7
        start_of_period = (today - timedelta(days=days_since_last_friday)).replace(hour=0, minute=0, second=0, microsecond=0)
        end_of_period = today.replace(hour=23, minute=59, second=59, microsecond=999999)
        
        save_path = os.path.join(destination_folder, f"Week_{week_no}")
        os.makedirs(save_path, exist_ok=True)
        
        # ====== æª¢æŸ¥å·²ä¸‹è¼‰æª”æ¡ˆè¨˜éŒ„ ======
        downloaded_log_file = os.path.join(save_path, "downloaded_files_log.txt")
        downloaded_files = set()
        if os.path.exists(downloaded_log_file):
            try:
                with open(downloaded_log_file, 'r', encoding='utf-8') as f:
                    for line in f:
                        line = line.strip()
                        if line:
                            downloaded_files.add(line)
                if callback:
                    callback(f"ğŸ“‹ å·²è¼‰å…¥ {len(downloaded_files)} å€‹å·²ä¸‹è¼‰æª”æ¡ˆè¨˜éŒ„")
            except Exception as e:
                if callback:
                    callback(f"âš ï¸ è¼‰å…¥å·²ä¸‹è¼‰è¨˜éŒ„å¤±æ•—: {e}")
        
        def save_downloaded_file_info(filename, sender_email, subject, received_time):
            """è¨˜éŒ„å·²ä¸‹è¼‰çš„æª”æ¡ˆè³‡è¨Š"""
            try:
                with open(downloaded_log_file, 'a', encoding='utf-8') as f:
                    file_info = f"{filename}|{sender_email}|{subject}|{received_time}"
                    f.write(file_info + "\n")
                    downloaded_files.add(file_info)
            except Exception as e:
                if callback:
                    callback(f"âš ï¸ è¨˜éŒ„ä¸‹è¼‰è³‡è¨Šå¤±æ•—: {e}")
        
        def is_file_already_downloaded(filename, sender_email, subject, received_time):
            """æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å·²ç¶“ä¸‹è¼‰é"""
            file_info = f"{filename}|{sender_email}|{subject}|{received_time}"
            return file_info in downloaded_files

        # ===== è®€ configï¼Œå»ºç«‹ email -> short_name æ˜ å°„ =====
        email_to_short = {}  # email(lowercase) -> short_name
        name_to_short = {}   # name(lowercase)  -> short_name
        if config_file and os.path.exists(config_file):
            try:
                df = pd.read_excel(config_file)
                for _, row in df.iterrows():
                    email = str(row.iloc[2]).strip().lower() if len(row) > 2 and not pd.isna(row.iloc[2]) else ''
                    short_name = str(row.iloc[0]).strip() if len(row) > 0 and not pd.isna(row.iloc[0]) else ''
                    name_in_email = str(row.iloc[4]).strip().lower() if len(row) > 4 and not pd.isna(row.iloc[4]) else ''
                    if email and short_name:
                        email_to_short[email] = short_name
                    if name_in_email and short_name:
                        name_to_short[name_in_email] = short_name
            except Exception as e:
                pass

        # é¸æ“‡å¸³è™Ÿ
        outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
        accounts = [outlook.Folders.Item(i + 1) for i in range(outlook.Folders.Count)]
        if account_idx is None:
            from tkinter import simpledialog
            account_names = [acct.Name for acct in accounts]
            # å˜—è©¦æ‰¾åˆ°ä¸»è¦–çª—
            import tkinter as tk
            main_window = None
            for w in tk._default_root.winfo_children():
                if hasattr(w, 'attributes'):
                    main_window = w
                    break

            # ç¢ºä¿ä¸»è¦–çª—åœ¨æœ€é ‚å±¤
            if main_window:
                main_window.attributes('-topmost', True)
                main_window.lift()  # æå‡åˆ°æœ€é ‚å±¤
                main_window.focus_force()  # å¼·åˆ¶ç²å¾—ç„¦é»

            idx = simpledialog.askinteger(
                t("select_account"),
                "\n".join([f"[{i}] {name}" for i, name in enumerate(account_names)]) + "\n" + t("enter_index"),
                minvalue=0, maxvalue=len(account_names)-1,
                parent=main_window if main_window else None
            )

            # æ¢å¾©ä¸»è¦–çª—è¨­ç½®
            if main_window:
                main_window.attributes('-topmost', False)

            if idx is None:
                # if callback:
                #     callback("âŒ æœªé¸æ“‡å¸³è™Ÿï¼Œå·²å–æ¶ˆä¸‹è¼‰")
                return
            account_idx = idx
        account_folder = accounts[account_idx]
        # éè¿´æŠ“å–æ‰€æœ‰å­è³‡æ–™å¤¾çš„éƒµä»¶
        def collect_messages_from_subfolders(folder):
            all_messages = []
            try:
                if hasattr(folder, 'DefaultItemType') and folder.DefaultItemType == 0:
                    print(f"[DEBUG] Scanning folder: {folder.Name}")
                    items = folder.Items
                    items.Sort("[ReceivedTime]", True)
                    count = 0
                    for msg in items:
                        try:
                            if msg.Class == 43:
                                received = getattr(msg, 'ReceivedTime', None)
                                subject = getattr(msg, 'Subject', '')
                                if received:
                                    # è‹¥ received æœ‰ tzinfoï¼Œè½‰æˆ naive
                                    if hasattr(received, 'tzinfo') and received.tzinfo is not None:
                                        received_naive = received.replace(tzinfo=None)
                                    else:
                                        received_naive = received
                                    if start_of_period <= received_naive <= end_of_period:
                                        print(f"[DEBUG] Message: ReceivedTime={received}, Subject={subject}")
                                        all_messages.append(msg)
                                        count += 1
                        except Exception as e:
                            print(f"[DEBUG] Error reading message in {folder.Name}: {e}")
                    print(f"[DEBUG] Folder '{folder.Name}' matched messages: {count}")
            except Exception as e:
                print(f"[DEBUG] Exception in collect_messages_from_subfolders: {e} (Folder: {getattr(folder, 'Name', '')})")
            for sub in folder.Folders:
                all_messages.extend(collect_messages_from_subfolders(sub))
            return all_messages
        messages = collect_messages_from_subfolders(account_folder)
        if callback:
            callback(f"ğŸ“¬ å–å¾—éƒµä»¶æ•¸é‡ï¼ˆé™åˆ¶ä¸Šé€±äº”èµ·ï¼Œå«æ‰€æœ‰å­è³‡æ–™å¤¾ï¼‰: {len(messages)}")
        # åªä¿ç•™ config è£¡ email/name çš„æœ€æ–°ä¸€å°éƒµä»¶
        latest_msg_by_sender = {}
        for msg in messages:
            try:
                sender_email = cls.get_smtp_address(msg).strip().lower()
                sender_name = getattr(msg, "SenderName", "").strip().lower()
                key = None
                if sender_email in email_to_short:
                    key = sender_email
                elif sender_name in name_to_short:
                    key = sender_name
                if not key:
                    continue
                if key not in latest_msg_by_sender or msg.ReceivedTime > latest_msg_by_sender[key].ReceivedTime:
                    latest_msg_by_sender[key] = msg
            except Exception:
                continue
        # ç‚ºæ¯å€‹é–€å¸‚æ”¶é›†æ‰€æœ‰éƒµä»¶ï¼ŒæŒ‰æ™‚é–“æ’åº
        all_messages_by_sender = {}
        for msg in messages:
            try:
                sender_email = cls.get_smtp_address(msg).strip().lower()
                sender_name = getattr(msg, "SenderName", "").strip().lower()
                key = None
                if sender_email in email_to_short:
                    key = sender_email
                elif sender_name in name_to_short:
                    key = sender_name
                if not key:
                    continue
                if key not in all_messages_by_sender:
                    all_messages_by_sender[key] = []
                all_messages_by_sender[key].append(msg)
            except Exception:
                continue
        # æŒ‰æ™‚é–“æ’åºæ¯å€‹é–€å¸‚çš„éƒµä»¶
        for key in all_messages_by_sender:
            all_messages_by_sender[key].sort(key=lambda x: x.ReceivedTime, reverse=True)
        downloaded = 0
        skipped = 0
        manual_confirmed = 0
        downloaded_short_names = set()
        downloaded_emails = set()  # æ–°å¢ï¼šçµ±è¨ˆæœ‰ä¸‹è¼‰ weekly order çš„ email
        # ===== åªä¿ç•™ä¸€ä»½ä¸‹è¼‰é‚è¼¯ =====
        for key, messages_list in all_messages_by_sender.items():
            try:
                # å…ˆæ‰¾ short_name
                if key in email_to_short:
                    short_name = email_to_short[key]
                elif key in name_to_short:
                    short_name = name_to_short[key]
                else:
                    continue
                excel_found = False
                
                # éæ­·è©²é–€å¸‚çš„æ‰€æœ‰éƒµä»¶ï¼ŒæŒ‰æ™‚é–“é †åº
                for msg in messages_list:
                    attachments = msg.Attachments
                    if attachments.Count == 0:
                        continue
                    
                    # æª¢æŸ¥æ˜¯å¦æœ‰ Excel é™„ä»¶
                    excel_attachments = []
                    for att in attachments:
                        filename = att.FileName
                        name_lower = filename.lower()
                        # æª¢æŸ¥æ˜¯å¦ç‚º Excel æ–‡ä»¶
                        if name_lower.endswith('.xlsx') or name_lower.endswith('.xls'):
                            # è·³éåŒ…å« amendment æˆ– amend é—œéµå­—çš„é™„ä»¶
                            amendment_keywords = ['amendment', 'amend', 'admentmend', 'adment', 'amendmend', 'amendement']
                            if any(keyword in name_lower for keyword in amendment_keywords):
                                if callback:
                                    callback(f"â© è·³é amendment æª”æ¡ˆ: {filename}")
                                    callback("")  # æ·»åŠ ç©ºè¡Œ
                                continue
                            excel_attachments.append(att)
                    
                    # é¡å¤–æª¢æŸ¥ï¼šå¦‚æœéƒµä»¶ä¸»æ—¨åŒ…å« amendmentï¼Œä¹Ÿè·³é
                    subject = getattr(msg, 'Subject', '') or ''
                    subject_lower = subject.lower()
                    amendment_keywords = ['amendment', 'amend', 'admentmend', 'adment', 'amendmend', 'amendement']
                    if any(keyword in subject_lower for keyword in amendment_keywords):
                        if callback:
                            callback(f"â© è·³é amendment ä¸»æ—¨éƒµä»¶: {subject}")
                            callback("")  # æ·»åŠ ç©ºè¡Œ
                        continue
                    
                    # å¦‚æœæ²’æœ‰ Excel é™„ä»¶ï¼Œç¹¼çºŒä¸‹ä¸€å°éƒµä»¶
                    if not excel_attachments:
                        continue
                    
                    # æ‰¾åˆ° Excel é™„ä»¶ï¼Œä¸‹è¼‰ç¬¬ä¸€å€‹
                    att = excel_attachments[0]
                    filename = att.FileName
                    save_filename = f"{short_name}_WeeklyOrder_{week_no}.xlsx"
                    full_path = os.path.join(save_path, save_filename)
                    base, ext = os.path.splitext(full_path)
                    counter = 1
                    while os.path.exists(full_path):
                        full_path = f"{base} ({counter}){ext}"
                        counter += 1
                    
                    # æª¢æŸ¥æ˜¯å¦å·²ç¶“ä¸‹è¼‰é
                    sender_email = cls.get_smtp_address(msg).strip().lower()
                    subject = getattr(msg, 'Subject', '') or ''
                    received_time = getattr(msg, 'ReceivedTime', '').strftime('%Y-%m-%d %H:%M:%S') if hasattr(msg, 'ReceivedTime') else ''
                    
                    if is_file_already_downloaded(filename, sender_email, subject, received_time):
                        if callback:
                            callback(f"â© è·³éå·²ä¸‹è¼‰æª”æ¡ˆ: {filename} (from {key})")
                        continue
                    
                    att.SaveAsFile(full_path)
                    
                    # è¨˜éŒ„ä¸‹è¼‰è³‡è¨Š
                    save_downloaded_file_info(filename, sender_email, subject, received_time)
                    
                    print(f"[DEBUG] Downloaded from sender_email: {key}")
                    downloaded_emails.add(key)  # æ–°å¢ï¼šè¨˜éŒ„æœ‰ä¸‹è¼‰çš„ email
                    downloaded += 1
                    downloaded_short_names.add(short_name)
                    excel_found = True
                    if progress_popup:
                        progress_popup.update_outlet_count(len(downloaded_short_names))
                    if callback:
                        callback(f"[AUTO] {os.path.basename(full_path)} (from {key})")
                        callback("")  # æ·»åŠ ç©ºè¡Œ
                    break  # æ‰¾åˆ° Excel é™„ä»¶å¾Œè·³å‡ºå¾ªç’°
                
                # å¦‚æœè©²é–€å¸‚çš„æ‰€æœ‰éƒµä»¶éƒ½æ²’æœ‰ Excel é™„ä»¶
                if not excel_found:
                    if callback:
                        callback(f"â© è·³é {key} - æ‰€æœ‰éƒµä»¶éƒ½æ²’æœ‰ Excel é™„ä»¶")
                        callback("")  # æ·»åŠ ç©ºè¡Œ
                    skipped += 1
                    
            except Exception as e:
                if callback:
                    callback(f"âŒ Failed to process a message: {e}")
                skipped += 1
        config_short_names = set(email_to_short.values())
        not_downloaded = config_short_names - downloaded_short_names
        summary = (
            f"\n=== Download Summary ===\n"
            f"Downloaded (auto): {downloaded}\n"
            f"Skipped: {skipped}\n"
            f"Saved to: {save_path}\n"
            f"\n=== æª”æ¡ˆä¸‹è¼‰çµæœ ===\n"
            f"å·²ä¸‹è¼‰: {', '.join(sorted(downloaded_short_names)) if downloaded_short_names else 'ç„¡'}\n"
            f"æœªä¸‹è¼‰: {', '.join(sorted(not_downloaded)) if not_downloaded else 'ç„¡'}"
        )
        if callback:
            callback(summary)
        # é¡å¤–ï¼šå‘¼å«ä¸»ç•«é¢ç¾åŒ–é¡¯ç¤º
        try:
            # å–å¾—æŠ“å–æ—¥æœŸç¯„åœ
            start_date = start_of_period.strftime("%Y-%m-%d")
            end_date = end_of_period.strftime("%Y-%m-%d")
            outlet_count = len(downloaded_short_names)
            # å˜—è©¦å–å¾— app å¯¦ä¾‹ä¸¦é¡¯ç¤º
            import tkinter as tk
            for w in tk._default_root.winfo_children():
                if hasattr(w, 'show_download_summary'):
                    w.show_download_summary(start_date, end_date, outlet_count)
                    break
        except Exception:
            pass

        # ====== ä¸‹è¼‰é‚è¼¯çµæŸå¾Œï¼Œæ•´ç†æ‰€æœ‰éƒµä»¶çš„ bodyï¼ˆåªä¿ç•™æ­£æ–‡ï¼Œç„¡æ•¸å­—é–‹é ­åˆ¤æ–·ï¼‰ ======
        bodies = []
        signature_keywords = [
            'best regards', 'regards', 'thanks', 'thank you', 'cheers', 'sincerely', 'æ­¤è‡´', 'æ•¬ç¤¼', 'ç¥å¥½', 'è¬è¬', 'æ„Ÿè¬', 'è‡´æ•¬', 'æ•¬ä¸Š', 'é¡ºç¥å•†ç¥º', 'é¡ºé¢‚æ—¶ç¥º', 'é¡ºé¢‚å•†ç¥º', 'é¡ºè‡´æ•¬æ„', 'With regards', 'Yours faithfully', 'Yours sincerely', 'Yours truly', 'Kind regards', 'BR', 'æ•¬è«‹', 'é †é Œ']
        import re
        for idx, msg in enumerate(latest_msg_by_sender.values(), 1):
            try:
                sender = getattr(msg, 'SenderName', '')
                subject = getattr(msg, 'Subject', '')
                body = getattr(msg, 'Body', '') or ''
                body_lines = body.splitlines()
                cut_idx = len(body_lines)
                for i, line in enumerate(body_lines):
                    l = line.strip().lower()
                    if any(kw in l for kw in signature_keywords):
                        cut_idx = i
                        break
                clean_body = '\n'.join(body_lines[:cut_idx]).strip()
                if not clean_body:
                    clean_body = "(æ— æ­£æ–‡)"
                pretty = f"â€”â€”â€” é‚®ä»¶ {idx} â€”â€”â€”\n[å‘ä»¶äºº] {sender}\n[ä¸»é¢˜] {subject}\n[å†…å®¹]\n" + clean_body
                bodies.append(pretty)
            except Exception:
                continue
        cls.extracted_bodies = bodies
        # è‡ªå‹•å¯«å‡º email_bodies_log.txt
        try:
            log_file = os.path.join(save_path, "email_bodies_log.txt")
            with open(log_file, "w", encoding="utf-8") as f:
                f.write("\n\n".join(bodies))
        except Exception as e:
            pass

        print("[DEBUG] config_file:", config_file)
        print("[DEBUG] save_path:", save_path)
        print("[DEBUG] email_to_short:", email_to_short)
        print("[DEBUG] messages count:", len(messages))
        for msg in messages:
            try:
                sender_email = cls.get_smtp_address(msg).strip().lower()
                if not sender_email:
                    print("[DEBUG] msg.Sender:", getattr(msg, "Sender", None))
                    print("[DEBUG] msg.SenderName:", getattr(msg, "SenderName", None))
                    print("[DEBUG] msg.SenderEmailAddress:", getattr(msg, "SenderEmailAddress", None))
                    print("[DEBUG] msg.SenderEmailType:", getattr(msg, "SenderEmailType", None))
                print("[DEBUG] sender_email:", sender_email)
            except Exception as e:
                print("[DEBUG] error getting sender_email:", e)
        # åœ¨æµç¨‹çµæŸæ™‚è‡ªå‹•é—œé–‰consoleï¼ˆåƒ…é™exeä¸”æœ‰consoleæ™‚ï¼‰
        if getattr(sys, 'frozen', False) and sys.stdout and sys.stdout.isatty():
            import time
            print("[DEBUG] Download process finished. Console will close in 5 seconds...")
            time.sleep(5)
            sys.exit(0)

        print("[DEBUG] All sender_email with weekly order downloaded:", list(downloaded_emails))

    @classmethod
    def download_amendment_orders(cls, destination_folder, config_file=None, account_idx=None, callback=None, progress_popup=None):
        """å°ˆé–€ä¸‹è¼‰ Amendment è¨‚å–®"""
        import win32com.client
        from datetime import datetime, timedelta
        import os
        import re
        import pandas as pd
        
        # å–å¾—ä»Šå¤©æ—¥æœŸ
        today = datetime.now()
        week_no = today.isocalendar()[1]
        
        # ====== æ­£ç¢ºå›æ¨åˆ°ä¸Šé€±äº” ======
        days_since_last_friday = (today.weekday() - 4) % 7 or 7
        start_of_period = (today - timedelta(days=days_since_last_friday)).replace(hour=0, minute=0, second=0, microsecond=0)
        end_of_period = today.replace(hour=23, minute=59, second=59, microsecond=999999)
        
        save_path = os.path.join(destination_folder, f"Week_{week_no}_Amendment")
        os.makedirs(save_path, exist_ok=True)
        
        # ====== æª¢æŸ¥å·²ä¸‹è¼‰æª”æ¡ˆè¨˜éŒ„ ======
        downloaded_log_file = os.path.join(save_path, "downloaded_amendment_log.txt")
        downloaded_files = set()
        if os.path.exists(downloaded_log_file):
            try:
                with open(downloaded_log_file, 'r', encoding='utf-8') as f:
                    for line in f:
                        line = line.strip()
                        if line:
                            downloaded_files.add(line)
                if callback:
                    callback(f"ğŸ“‹ å·²è¼‰å…¥ {len(downloaded_files)} å€‹å·²ä¸‹è¼‰ Amendment æª”æ¡ˆè¨˜éŒ„")
            except Exception as e:
                if callback:
                    callback(f"âš ï¸ è¼‰å…¥å·²ä¸‹è¼‰ Amendment è¨˜éŒ„å¤±æ•—: {e}")
        
        def save_downloaded_amendment_info(filename, sender_email, subject, received_time):
            """è¨˜éŒ„å·²ä¸‹è¼‰çš„ Amendment æª”æ¡ˆè³‡è¨Š"""
            try:
                with open(downloaded_log_file, 'a', encoding='utf-8') as f:
                    file_info = f"{filename}|{sender_email}|{subject}|{received_time}"
                    f.write(file_info + "\n")
                    downloaded_files.add(file_info)
            except Exception as e:
                if callback:
                    callback(f"âš ï¸ è¨˜éŒ„ Amendment ä¸‹è¼‰è³‡è¨Šå¤±æ•—: {e}")
        
        def is_amendment_already_downloaded(filename, sender_email, subject, received_time):
            """æª¢æŸ¥ Amendment æª”æ¡ˆæ˜¯å¦å·²ç¶“ä¸‹è¼‰é"""
            file_info = f"{filename}|{sender_email}|{subject}|{received_time}"
            return file_info in downloaded_files
        
        # ===== è®€ configï¼Œå»ºç«‹ email -> short_name æ˜ å°„ =====
        email_to_short = {}  # email(lowercase) -> short_name
        name_to_short = {}   # name(lowercase)  -> short_name
        if config_file and os.path.exists(config_file):
            try:
                df = pd.read_excel(config_file)
                for _, row in df.iterrows():
                    email = str(row.iloc[2]).strip().lower() if len(row) > 2 and not pd.isna(row.iloc[2]) else ''
                    short_name = str(row.iloc[0]).strip() if len(row) > 0 and not pd.isna(row.iloc[0]) else ''
                    name_in_email = str(row.iloc[4]).strip().lower() if len(row) > 4 and not pd.isna(row.iloc[4]) else ''
                    if email and short_name:
                        email_to_short[email] = short_name
                    if name_in_email and short_name:
                        name_to_short[name_in_email] = short_name
            except Exception as e:
                pass
        
        # é¸æ“‡å¸³è™Ÿ
        outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
        accounts = [outlook.Folders.Item(i + 1) for i in range(outlook.Folders.Count)]
        if account_idx is None:
            from tkinter import simpledialog
            account_names = [acct.Name for acct in accounts]
            # å˜—è©¦æ‰¾åˆ°ä¸»è¦–çª—
            import tkinter as tk
            main_window = None
            for w in tk._default_root.winfo_children():
                if hasattr(w, 'attributes'):
                    main_window = w
                    break
            
            # ç¢ºä¿ä¸»è¦–çª—åœ¨æœ€é ‚å±¤
            if main_window:
                main_window.attributes('-topmost', True)
                main_window.lift()  # æå‡åˆ°æœ€é ‚å±¤
                main_window.focus_force()  # å¼·åˆ¶ç²å¾—ç„¦é»
            
            idx = simpledialog.askinteger(
                "é¸æ“‡å¸³è™Ÿ",
                "\n".join([f"[{i}] {name}" for i, name in enumerate(account_names)]) + "\nè«‹è¼¸å…¥å¸³è™Ÿç´¢å¼•:",
                minvalue=0, maxvalue=len(account_names)-1,
                parent=main_window if main_window else None
            )
            
            # æ¢å¾©ä¸»è¦–çª—è¨­ç½®
            if main_window:
                main_window.attributes('-topmost', False)
            
            if idx is None:
                return
            account_idx = idx
        account_folder = accounts[account_idx]
        
        # éè¿´æŠ“å–æ‰€æœ‰å­è³‡æ–™å¤¾çš„éƒµä»¶
        def collect_messages_from_subfolders(folder):
            all_messages = []
            try:
                if hasattr(folder, 'DefaultItemType') and folder.DefaultItemType == 0:
                    items = folder.Items
                    items.Sort("[ReceivedTime]", True)
                    count = 0
                    for msg in items:
                        try:
                            if msg.Class == 43:
                                received = getattr(msg, 'ReceivedTime', None)
                                subject = getattr(msg, 'Subject', '')
                                if received:
                                    if hasattr(received, 'tzinfo') and received.tzinfo is not None:
                                        received_naive = received.replace(tzinfo=None)
                                    else:
                                        received_naive = received
                                    if start_of_period <= received_naive <= end_of_period:
                                        all_messages.append(msg)
                                        count += 1
                        except Exception as e:
                            pass
            except Exception as e:
                pass
            for sub in folder.Folders:
                all_messages.extend(collect_messages_from_subfolders(sub))
            return all_messages
        
        messages = collect_messages_from_subfolders(account_folder)
        if callback:
            callback(f"ğŸ“¬ å–å¾—éƒµä»¶æ•¸é‡ï¼ˆAmendment æ¨¡å¼ï¼‰: {len(messages)}")
        
        # ç‚ºæ¯å€‹é–€å¸‚æ”¶é›†æ‰€æœ‰éƒµä»¶ï¼ŒæŒ‰æ™‚é–“æ’åº
        all_messages_by_sender = {}
        for msg in messages:
            try:
                sender_email = cls.get_smtp_address(msg).strip().lower()
                sender_name = getattr(msg, "SenderName", "").strip().lower()
                key = None
                if sender_email in email_to_short:
                    key = sender_email
                elif sender_name in name_to_short:
                    key = sender_name
                if not key:
                    continue
                if key not in all_messages_by_sender:
                    all_messages_by_sender[key] = []
                all_messages_by_sender[key].append(msg)
            except Exception:
                continue
        
        # æŒ‰æ™‚é–“æ’åºæ¯å€‹é–€å¸‚çš„éƒµä»¶
        for key in all_messages_by_sender:
            all_messages_by_sender[key].sort(key=lambda x: x.ReceivedTime, reverse=True)
        
        downloaded = 0
        skipped = 0
        downloaded_short_names = set()
        
        # ===== Amendment ä¸‹è¼‰é‚è¼¯ =====
        for key, messages_list in all_messages_by_sender.items():
            try:
                # å…ˆæ‰¾ short_name
                if key in email_to_short:
                    short_name = email_to_short[key]
                elif key in name_to_short:
                    short_name = name_to_short[key]
                else:
                    continue
                amendment_found = False
                
                # éæ­·è©²é–€å¸‚çš„æ‰€æœ‰éƒµä»¶ï¼ŒæŒ‰æ™‚é–“é †åº
                for msg in messages_list:
                    attachments = msg.Attachments
                    if attachments.Count == 0:
                        continue
                    
                    # æª¢æŸ¥æ˜¯å¦æœ‰ Amendment Excel é™„ä»¶
                    amendment_attachments = []
                    for att in attachments:
                        filename = att.FileName
                        name_lower = filename.lower()
                        # æª¢æŸ¥æ˜¯å¦ç‚º Excel æ–‡ä»¶ä¸”åŒ…å« amendment é—œéµå­—
                        if name_lower.endswith('.xlsx') or name_lower.endswith('.xls'):
                            # æ“´å±•é—œéµå­—æœå°‹ï¼ŒåŒ…å«å¸¸è¦‹çš„æ‹¼å¯«éŒ¯èª¤
                            amendment_keywords = ['amendment', 'amend', 'admentmend', 'adment', 'amendmend', 'amendement']
                            if any(keyword in name_lower for keyword in amendment_keywords):
                                amendment_attachments.append(att)
                    
                    # æª¢æŸ¥éƒµä»¶ä¸»æ—¨æ˜¯å¦åŒ…å« amendment
                    subject = getattr(msg, 'Subject', '') or ''
                    subject_lower = subject.lower()
                    # æ“´å±•é—œéµå­—æœå°‹ï¼ŒåŒ…å«å¸¸è¦‹çš„æ‹¼å¯«éŒ¯èª¤
                    amendment_keywords = ['amendment', 'amend', 'admentmend', 'adment', 'amendmend', 'amendement']
                    is_amendment_subject = any(keyword in subject_lower for keyword in amendment_keywords)
                    
                    # å¦‚æœæ²’æœ‰ Amendment é™„ä»¶ä¸”ä¸»æ—¨ä¹Ÿä¸æ˜¯ Amendmentï¼Œç¹¼çºŒä¸‹ä¸€å°éƒµä»¶
                    if not amendment_attachments and not is_amendment_subject:
                        continue
                    
                    # æ‰¾åˆ° Amendment é™„ä»¶ï¼Œä¸‹è¼‰ç¬¬ä¸€å€‹
                    if amendment_attachments:
                        att = amendment_attachments[0]
                        filename = att.FileName
                        save_filename = f"{short_name}_Amendment_{week_no}.xlsx"
                        full_path = os.path.join(save_path, save_filename)
                        base, ext = os.path.splitext(full_path)
                        counter = 1
                        while os.path.exists(full_path):
                            full_path = f"{base} ({counter}){ext}"
                            counter += 1
                        
                        # æª¢æŸ¥æ˜¯å¦å·²ç¶“ä¸‹è¼‰é
                        sender_email = cls.get_smtp_address(msg).strip().lower()
                        received_time = getattr(msg, 'ReceivedTime', '').strftime('%Y-%m-%d %H:%M:%S') if hasattr(msg, 'ReceivedTime') else ''
                        
                        if is_amendment_already_downloaded(filename, sender_email, subject, received_time):
                            if callback:
                                callback(f"â© è·³éå·²ä¸‹è¼‰ Amendment: {filename} (from {key})")
                            continue
                        
                        att.SaveAsFile(full_path)
                        
                        # è¨˜éŒ„ä¸‹è¼‰è³‡è¨Š
                        save_downloaded_amendment_info(filename, sender_email, subject, received_time)
                        
                        downloaded += 1
                        downloaded_short_names.add(short_name)
                        amendment_found = True
                        if progress_popup:
                            progress_popup.update_outlet_count(len(downloaded_short_names))
                        if callback:
                            callback(f"[AMENDMENT] {os.path.basename(full_path)} (from {key})")
                        break  # æ‰¾åˆ° Amendment é™„ä»¶å¾Œè·³å‡ºå¾ªç’°
                    
                    # å¦‚æœä¸»æ—¨åŒ…å« amendment ä½†æ²’æœ‰ amendment é™„ä»¶ï¼Œä¸‹è¼‰ç¬¬ä¸€å€‹ Excel é™„ä»¶
                    elif is_amendment_subject:
                        excel_attachments = []
                        for att in attachments:
                            filename = att.FileName
                            name_lower = filename.lower()
                            if name_lower.endswith('.xlsx') or name_lower.endswith('.xls'):
                                excel_attachments.append(att)
                        
                        if excel_attachments:
                            att = excel_attachments[0]
                        filename = att.FileName
                        save_filename = f"{short_name}_Amendment_{week_no}.xlsx"
                        full_path = os.path.join(save_path, save_filename)
                        base, ext = os.path.splitext(full_path)
                        counter = 1
                        while os.path.exists(full_path):
                            full_path = f"{base} ({counter}){ext}"
                            counter += 1
                        
                        # æª¢æŸ¥æ˜¯å¦å·²ç¶“ä¸‹è¼‰é
                        sender_email = cls.get_smtp_address(msg).strip().lower()
                        received_time = getattr(msg, 'ReceivedTime', '').strftime('%Y-%m-%d %H:%M:%S') if hasattr(msg, 'ReceivedTime') else ''
                        
                        if is_amendment_already_downloaded(filename, sender_email, subject, received_time):
                            if callback:
                                callback(f"â© è·³éå·²ä¸‹è¼‰ Amendment: {filename} (from {key})")
                            continue
                        
                        att.SaveAsFile(full_path)
                        
                        # è¨˜éŒ„ä¸‹è¼‰è³‡è¨Š
                        save_downloaded_amendment_info(filename, sender_email, subject, received_time)
                        
                        downloaded += 1
                        downloaded_short_names.add(short_name)
                        amendment_found = True
                        if progress_popup:
                            progress_popup.update_outlet_count(len(downloaded_short_names))
                        if callback:
                            callback(f"[AMENDMENT] {os.path.basename(full_path)} (from {key})")
                        break  # æ‰¾åˆ° Amendment é™„ä»¶å¾Œè·³å‡ºå¾ªç’°
                
                # å¦‚æœè©²é–€å¸‚çš„æ‰€æœ‰éƒµä»¶éƒ½æ²’æœ‰ Amendment é™„ä»¶
                if not amendment_found:
                    if callback:
                        callback(f"â© è·³é {key} - æ²’æœ‰æ‰¾åˆ° Amendment æª”æ¡ˆ")
                    skipped += 1
                    
            except Exception as e:
                if callback:
                    callback(f"âŒ Failed to process Amendment message: {e}")
                skipped += 1
        
        config_short_names = set(email_to_short.values())
        not_downloaded = config_short_names - downloaded_short_names
        summary = (
            f"\n=== Amendment Download Summary ===\n"
            f"Downloaded Amendment: {downloaded}\n"
            f"Skipped: {skipped}\n"
            f"Saved to: {save_path}\n"
            f"\n=== Amendment æª”æ¡ˆä¸‹è¼‰çµæœ ===\n"
            f"å·²ä¸‹è¼‰: {', '.join(sorted(downloaded_short_names)) if downloaded_short_names else 'ç„¡'}\n"
            f"æœªä¸‹è¼‰: {', '.join(sorted(not_downloaded)) if not_downloaded else 'ç„¡'}"
        )
        if callback:
            callback(summary)

    @classmethod
    def _collect_messages(cls, folder, start_date, end_date, allowed_senders):
        """éæ­·æ‰€æœ‰å­è³‡æ–™å¤¾ï¼Œæ”¶é›†æœ¬é€±æ‰€æœ‰éƒµä»¶ï¼ˆåªä¿ç•™ config è£¡çš„ senderï¼‰"""
        messages = []
        try:
            items = folder.Items
            items.Sort("[ReceivedTime]", True)
            for msg in items:
                try:
                    received = getattr(msg, 'ReceivedTime', None)
                    msg_class = getattr(msg, 'Class', None)
                    subject = getattr(msg, 'Subject', '')
                    sender_type = getattr(msg, 'SenderEmailType', '')
                    sender_addr = getattr(msg, 'SenderEmailAddress', '')
                    primary_smtp = ''
                    if sender_type == 'EX':
                        try:
                            ex_user = msg.Sender.GetExchangeUser()
                            if ex_user and hasattr(ex_user, 'PrimarySmtpAddress'):
                                primary_smtp = str(ex_user.PrimarySmtpAddress).lower()
                        except Exception as e:
                            print(f"[DEBUG] Error getting PrimarySmtpAddress: {e}")
                    if received:
                        if hasattr(received, 'tzinfo') and received.tzinfo is not None:
                            received_naive = received.replace(tzinfo=None)
                        else:
                            received_naive = received
                        if start_date <= received_naive <= end_date:
                            sender_email = clean_email(cls.get_smtp_sender(msg))
                            print(f"[DEBUG] æ”¶ä»¶æ—¥: {received_naive}, ä¸»æ—¨: {subject}, SenderEmailType: {sender_type}, SenderEmailAddress: {sender_addr}, PrimarySmtpAddress: {primary_smtp}, æ¯”å°ç”¨ sender_email: {sender_email}, msg_class: {msg_class}")
                            if allowed_senders and sender_email in allowed_senders:
                                if msg_class == 43:
                                    messages.append(msg)
                except Exception as e:
                    print(f"[DEBUG] Error reading message: {e}")
        except Exception as e:
            print(f"[DEBUG] Error accessing folder {folder.Name}: {e}")
        for sub in folder.Folders:
            messages.extend(cls._collect_messages(sub, start_date, end_date, allowed_senders))
        return messages

    @classmethod
    def _download_attachments(cls, messages, save_path, email_to_outlet=None, week_no=None):
        result = {
            "downloaded": 0,
            "skipped": 0,
            "matched_outlets": [],
            "unmatched_emails": set()
        }
        allowed_senders = set(email_to_outlet.keys()) if email_to_outlet else set()
        for msg in messages:
            try:
                sender_email = clean_email(cls.get_smtp_address(msg))
                subject = getattr(msg, "Subject", "") or ""
                attachments = msg.Attachments
                short_name = email_to_outlet.get(sender_email, "")
                if not short_name:
                    result['unmatched_emails'].add(sender_email)
                    continue
                for att in attachments:
                    filename = att.FileName
                    name_lower = filename.lower()
                    subject_lower = subject.lower()
                    # å¤šé‡é—œéµå­—åˆ¤æ–·
                    is_weekly = any(
                        kw in subject_lower or kw in name_lower
                        for kw in ["weekly order", "order form", "ordering"]
                    )
                    if is_weekly:
                        new_filename = f"{short_name}_WeeklyOrder-Week{week_no}{os.path.splitext(filename)[1]}"
                        save_file = os.path.join(save_path, new_filename)
                        att.SaveAsFile(save_file)
                        print(f"âœ… Downloaded: {save_file}")
                        result['downloaded'] += 1
                        result['matched_outlets'].append(short_name)
                    else:
                        result['skipped'] += 1
            except Exception as e:
                print(f"Error downloading attachment: {e}")
                result['skipped'] += 1
        return result

    extracted_bodies = []

    @staticmethod
    def get_smtp_sender(msg):
        try:
            sender = msg.Sender
            if sender is not None:
                if sender.AddressEntryUserType == 0:  # olExchangeUserAddressEntry
                    ex_user = sender.GetExchangeUser()
                    if ex_user is not None:
                        return ex_user.PrimarySmtpAddress.lower()
                elif sender.AddressEntryUserType == 5:  # olSmtpAddressEntry
                    return sender.Address.lower()
            return str(getattr(msg, 'SenderEmailAddress', '')).lower()
        except Exception as e:
            print(f"[DEBUG] get_smtp_sender: Exception: {e}")
            return str(getattr(msg, 'SenderEmailAddress', '')).lower()

# ========== è¿è¥ç”¨å“è®¢å• ==========
class OperationSuppliesOrder:
    """è¿è¥ç”¨å“è®¢å•å¤„ç†"""
    
    @staticmethod
    def get_monthly_order_data(master_file):
        """è·å–æœˆåº¦è®¢å•æ•°æ®"""
        try:
            wb = load_workbook(master_file, data_only=True)
            data_sheet = wb["Data"]
            
            outlets = []
            for row in data_sheet.iter_rows(min_row=2, max_col=7, values_only=True):
                if row[1] and row[2]:
                    outlets.append({
                        "brand": row[1],
                        "outlet": row[2],
                        "short_name": row[3],
                        "full_name": row[4],
                        "address": row[5],
                        "delivery_day": row[6]
                    })
            
            orders = defaultdict(dict)
            unit_prices = defaultdict(dict)
            
            for supplier in ["Freshening", "Legacy", "Unikleen"]:
                if supplier in wb.sheetnames:
                    ws = wb[supplier]
                    
                    if supplier == "Freshening":
                        unit_prices[supplier] = [ws[f'D{i}'].value for i in range(12, 46)]
                    elif supplier == "Legacy":
                        unit_prices[supplier] = [ws[f'D{i}'].value for i in range(12, 15)]
                    else:
                        unit_prices[supplier] = [ws[f'D{i}'].value for i in range(12, 30)]
            
            for outlet in outlets:
                sheet_name = outlet["short_name"]
                if sheet_name in wb.sheetnames:
                    ws = wb[sheet_name]
                    
                    freshening = []
                    for row in range(4, 38):
                        cell_value = ws[f'L{row}'].value
                        freshening.append(cell_value if cell_value is not None else 0)
                    
                    legacy = []
                    for row in range(41, 44):
                        cell_value = ws[f'L{row}'].value
                        legacy.append(cell_value if cell_value is not None else 0)
                    
                    unikleen = []
                    for row in range(47, 65):
                        cell_value = ws[f'L{row}'].value
                        unikleen.append(cell_value if cell_value is not None else 0)
                    
                    orders[sheet_name] = {
                        "freshening": freshening,
                        "legacy": legacy,
                        "unikleen": unikleen
                    }
            
            templates = {}
            for supplier in ["Freshening", "Legacy", "Unikleen"]:
                if supplier in wb.sheetnames:
                    templates[supplier] = wb[supplier]
            
            return outlets, orders, templates, unit_prices
        except Exception as e:
            return None, f"Error reading master file: {str(e)}"

    @staticmethod
    def _is_number(val):
        try:
            float(val)
            return True
        except (TypeError, ValueError):
            return False

    @classmethod
    def calculate_order_amounts(cls, orders, unit_prices):
        """è®¡ç®—è®¢å•é‡‘é¢"""
        amounts = defaultdict(dict)
        for outlet, order_data in orders.items():
            for supplier in ["freshening", "legacy", "unikleen"]:
                items = order_data.get(supplier, [])
                prices = unit_prices.get(supplier.capitalize(), [])
                if len(prices) < len(items):
                    prices = prices + [0] * (len(items) - len(prices))
                total = sum(
                    float(qty) * float(price)
                    for qty, price in zip(items, prices)
                    if cls._is_number(qty) and cls._is_number(price)
                )
                amounts[outlet][supplier] = total
        return amounts

    @classmethod
    def check_moq(cls, outlets, orders, unit_prices, log_callback=None):
        """æ£€æŸ¥MOQ"""
        results = {
            "freshening": defaultdict(list),
            "legacy": defaultdict(list),
            "unikleen": defaultdict(list)
        }
        
        amounts = cls.calculate_order_amounts(orders, unit_prices)
        
        for outlet in outlets:
            short_name = outlet["short_name"]
            brand_type = outlet["brand"]
            amount = amounts.get(short_name, {}).get("freshening", 0)
            
            if brand_type == "Dine-In" and amount < 150:
                results["freshening"]["below_moq"].append(f"{short_name} (${amount:.2f} < $150)")
            elif brand_type == "GOGO" and amount < 100:
                results["freshening"]["below_moq"].append(f"{short_name} (${amount:.2f} < $100)")
            elif brand_type == "CNK" and amount < 150:
                results["freshening"]["below_moq"].append(f"{short_name} (${amount:.2f} < $150)")
            elif amount > 0:
                results["freshening"]["above_moq"].append(f"{short_name} (${amount:.2f})")
        
        for outlet in outlets:
            short_name = outlet["short_name"]
            quantities = orders.get(short_name, {}).get("legacy", [])
            
            total = sum(q for q in quantities if isinstance(q, (int, float)))
            cartons = total
            
            if cartons < 2 and total > 0:
                results["legacy"]["below_moq"].append(f"{short_name} ({cartons} ctn < 2 ctn)")
            elif total > 0:
                results["legacy"]["above_moq"].append(f"{short_name} ({cartons} ctn)")
        
        for outlet in outlets:
            short_name = outlet["short_name"]
            amount = amounts.get(short_name, {}).get("unikleen", 0)
            
            if amount < 80 and amount > 0:
                results["unikleen"]["below_moq"].append(f"{short_name} (${amount:.2f} < $80)")
            elif amount > 0:
                results["unikleen"]["above_moq"].append(f"{short_name} (${amount:.2f})")
        
        summary = "=== MOQ æª¢æŸ¥çµæœ (é¡¯ç¤ºè¨‚è³¼é‡‘é¡) ===\n"
        
        for supplier in ["freshening", "legacy", "unikleen"]:
            summary += f"\n** {supplier.capitalize()} **\n"
            
            if results[supplier]["below_moq"]:
                summary += "âŒ æœªé”MOQ:\n"
                summary += "\n".join([f"  - {outlet}" for outlet in results[supplier]["below_moq"]]) + "\n"
            
            if results[supplier]["above_moq"]:
                summary += "âœ… å·²é”MOQ:\n"
                summary += "\n".join([f"  - {outlet}" for outlet in results[supplier]["above_moq"]]) + "\n"
            
            if not results[supplier]["below_moq"] and not results[supplier]["above_moq"]:
                summary += "âš ï¸ æ²’æœ‰è¨‚å–®\n"
        
        if log_callback:
            log_callback(summary)
        
        return results, summary, amounts

    @classmethod
    def safe_set_cell_value(cls, ws, addr, value):
        from openpyxl.cell.cell import MergedCell
        cell = ws[addr]
        if not isinstance(cell, MergedCell):
            cell.value = value

    @classmethod
    def generate_supplier_files(
        cls, master_file, output_folder,
        outlets, orders, templates, amounts, log_callback=None
    ):
        """åªè¨‚ä¸€æ¬¡è²¨ï¼šä¸‹æœˆ1è™Ÿä¹‹å¾Œçš„ç¬¬ä¸€å€‹é€è²¨æ—¥ï¼Œä¸”ä¿è­‰æ ¼å¼/å…¬å¼/æ¢ä»¶æ ¼å¼"""
        from openpyxl import Workbook
        from openpyxl.utils import get_column_letter
        import copy

        now = datetime.now()
        next_month = (now.month % 12) + 1
        year = now.year + (now.month // 12)
        saved = []

        for sup, tmpl_ws in templates.items():
            if log_callback: log_callback(f"\n--- Generating {sup} files ---")

            weekday_to_col = {
                'mon': 6, 'tue': 7, 'wed': 8, 'thu': 9, 'fri': 10, 'sat': 11, 'sun': 12
            }
            first_day = datetime(year, next_month, 1)
            first_wd_num = first_day.weekday()  # 0=Mon, 6=Sun
            first_wd = first_day.strftime("%a").lower()[:3]

            wb_out = Workbook()
            if wb_out.active is not None:
                wb_out.remove(wb_out.active)
            cnt = 0
            for o in outlets:
                sn = o["short_name"]
                data_list = orders.get(sn, {}).get(sup.lower(), [])
                nums = []
                for x in data_list:
                    try:
                        nums.append(float(x))
                    except:
                        nums.append(0.0)
                if not any(nums):
                    continue
                ws_new = wb_out.create_sheet(title=sn)
                # è¤‡è£½æ¨¡æ¿å…§å®¹
                for row in tmpl_ws.iter_rows():
                    for cell in row:
                        nc = ws_new.cell(row=cell.row, column=cell.column)
                        nc.value = cell.value
                        if cell.has_style:
                            nc.font = copy.copy(cell.font)
                            nc.border = copy.copy(cell.border)
                            nc.fill = copy.copy(cell.fill)
                            nc.number_format = cell.number_format
                            nc.protection = copy.copy(cell.protection)
                            nc.alignment = copy.copy(cell.alignment)
                if hasattr(tmpl_ws.conditional_formatting, '_cf_rules'):
                    for sqref, rules in tmpl_ws.conditional_formatting._cf_rules.items():
                        if isinstance(rules, list):
                            for rule in rules:
                                ws_new.conditional_formatting.add(sqref, rule)
                        else:
                            ws_new.conditional_formatting.add(sqref, rules)
                for ci in range(1, tmpl_ws.max_column+1):
                    cl = get_column_letter(ci)
                    ws_new.column_dimensions[cl].width = tmpl_ws.column_dimensions[cl].width
                for ri in range(1, tmpl_ws.max_row+1):
                    ws_new.row_dimensions[ri].height = tmpl_ws.row_dimensions[ri].height
                for mr in tmpl_ws.merged_cells.ranges:
                    ws_new.merge_cells(str(mr))
                # F5/F6
                cls.safe_set_cell_value(ws_new, "F5", o["full_name"])
                cls.safe_set_cell_value(ws_new, "F6", o["address"])
                # Freshening å¯«å…¥
                if sup == "Freshening":
                    cls.safe_set_cell_value(ws_new, "F8", o["delivery_day"])
                    # è§£ææ‰€æœ‰é€è²¨æ—¥
                    days = []
                    rawd = o["delivery_day"]
                    if isinstance(rawd, (int, float)):
                        d0 = datetime(1899, 12, 30) + timedelta(days=rawd)
                        days = [d0.strftime("%a").lower()[:3]]
                    else:
                        for p in str(rawd).split("/"):
                            if isinstance(p, str):
                                kd = p.strip().lower()[:3]
                            else:
                                kd = str(p).lower()[:3]
                            if kd in weekday_to_col:
                                days.append(kd)
                    days = list(dict.fromkeys(days))
                    # æ‰¾å‡ºä¸‹æœˆ1è™Ÿä¹‹å¾Œçš„ç¬¬ä¸€å€‹é€è²¨æ—¥
                    day_num_map = {'mon':0,'tue':1,'wed':2,'thu':3,'fri':4,'sat':5,'sun':6}
                    delivery_nums = [day_num_map[d] for d in days if d in day_num_map]
                    next_delivery = None
                    after = [d for d in delivery_nums if d >= first_wd_num]
                    if after:
                        next_delivery_num = min(after)
                    elif delivery_nums:
                        next_delivery_num = min(delivery_nums)
                    else:
                        next_delivery_num = None
                    # åæŸ¥ weekday_to_col
                    next_delivery_wd = None
                    for k, v in day_num_map.items():
                        if v == next_delivery_num:
                            next_delivery_wd = k
                            break
                    if next_delivery_wd and next_delivery_wd in weekday_to_col:
                        col = weekday_to_col[next_delivery_wd]
                        # æ±ºå®š row èµ·é»
                        if first_wd in ['fri','sat','sun']:
                            base_row = 51
                        else:
                            base_row = 12
                        for row_idx, qty in enumerate(nums):
                            excel_row = base_row + row_idx
                            cls.safe_set_cell_value(ws_new, f"{get_column_letter(col)}{excel_row}", qty)
                elif sup == "Legacy":
                    # åªè¨‚ä¸€æ¬¡è²¨ï¼Œæ‰¾ä¸‹æœˆ1è™Ÿä¹‹å¾Œçš„ç¬¬ä¸€å€‹é€è²¨æ—¥
                    days = ['mon','tue','wed','thu','fri']
                    day_num_map = {'mon':0,'tue':1,'wed':2,'thu':3,'fri':4}
                    delivery_nums = [day_num_map[d] for d in days if d in day_num_map]
                    after = [d for d in delivery_nums if d >= first_wd_num]
                    if after:
                        next_delivery_num = min(after)
                    elif delivery_nums:
                        next_delivery_num = min(delivery_nums)
                    else:
                        next_delivery_num = None
                    next_delivery_wd = None
                    for k, v in day_num_map.items():
                        if v == next_delivery_num:
                            next_delivery_wd = k
                            break
                    if next_delivery_wd and next_delivery_wd in weekday_to_col:
                        col = weekday_to_col[next_delivery_wd]
                        row = 12
                        for idx, qty in enumerate(nums):
                            cls.safe_set_cell_value(ws_new, f"{get_column_letter(col)}{row}", qty if idx == 0 else 0)
                elif sup == "Unikleen":
                    # åªè¨‚ä¸€æ¬¡è²¨ï¼Œç›´æ¥ç”¨ä¸‹æœˆ1è™Ÿæ˜¯æ˜ŸæœŸå¹¾
                    col = weekday_to_col[first_wd]
                    row = 12
                    cls.safe_set_cell_value(ws_new, f"{get_column_letter(col)}{row}", nums[0] if len(nums) > 0 else 0)
                cnt += 1
            # ä¿å­˜
            if cnt:
                fn = f"{sup}_Order_{year}_{next_month:02d}.xlsx"
                path = os.path.join(output_folder, fn)
                wb_out.save(path)
                saved.append(fn)
                if log_callback: log_callback(f"âœ… Saved {fn} ({cnt} sheets)")
            else:
                if log_callback: log_callback(f"âš ï¸ {sup} ç„¡è¨‚å–®ï¼Œæœªç”Ÿæˆæª”æ¡ˆ")

        return True, saved

    @classmethod
    def process_order(cls, master_file, output_folder, log_callback=None, progress_callback=None):
        """å¤„ç†è®¢å•"""
        try:
            if log_callback:
                log_callback(f"è®€å–ä¸»æ–‡ä»¶: {os.path.basename(master_file)}")
            outlets, orders, templates, unit_prices = cls.get_monthly_order_data(master_file)
            
            if not outlets:
                return False, "ç„¡æ³•è®€å–åˆ†åº—æ•¸æ“šï¼Œè«‹æª¢æŸ¥Dataå·¥ä½œè¡¨"
            
            if log_callback:
                log_callback("\nè¨ˆç®—è¨‚è³¼é‡‘é¡ä¸¦æª¢æŸ¥MOQè¦æ±‚...")
            moq_results, moq_summary, amounts = cls.check_moq(outlets, orders, unit_prices, log_callback)
            
            if log_callback:
                log_callback("\nç”Ÿæˆä¾›æ‡‰å•†è¨‚å–®æ–‡ä»¶ä¸¦é¡¯ç¤ºè¨‚è³¼é‡‘é¡...")
            success, supplier_files = cls.generate_supplier_files(
                master_file, output_folder, outlets, orders, templates, amounts, log_callback
            )
            
            if not success:
                return False, supplier_files
            
            result = (
                f"=== ç‡Ÿé‹ç”¨å“æœˆè¨‚å–®è™•ç†å®Œæˆ ===\n"
                f"æˆåŠŸç”Ÿæˆ {len(saved)} å€‹ä¾›æ‡‰å•†è¨‚å–®æ–‡ä»¶\n"
                f"ä¿å­˜ä½ç½®: {output_folder}\n"
                f"ç”Ÿæˆæ–‡ä»¶: {', '.join(saved)}"
            )
            
            if log_callback:
                log_callback(result)
            
            return True, saved
            
        except Exception as e:
            error_msg = f"è™•ç†è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}"
            if log_callback:
                log_callback(error_msg)
            return False, error_msg
            
# ====== åœ¨æª”æ¡ˆé–‹é ­ï¼ˆimport ä¹‹å¾Œï¼‰æ–°å¢ ======
def clean_email(val):
    if not val:
        return ""
    import re
    # å»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ã€Tabã€æ¢è¡Œã€å…¨è§’ç©ºæ ¼ç­‰ï¼‰ï¼Œå¹¶è½¬å°å†™
    return re.sub(r"\s+", "", str(val)).lower().strip()

# ========== æ”¯æ´å…¬å¼è‡ªå‹•è¨ˆç®—çš„ cell è®€å–ï¼ˆå·²æ£„ç”¨ï¼Œæ”¹ç”¨ data_only=Trueï¼‰ ==========
def get_cell_value_with_formula_support(ws, row, col, file_path=None, sheet_name=None):
    # ç¾åœ¨ç›´æ¥ä½¿ç”¨ cell.valueï¼Œå› ç‚ºæª”æ¡ˆå·²ç¶“ç”¨ data_only=True è®€å–
    return ws.cell(row=row, column=col).value

# ========== æ‰¹é‡è™•ç†å…¬å¼çš„å„ªåŒ–ç‰ˆæœ¬ ==========
def process_formula_cells_batch(ws, file_path=None, sheet_name=None, max_rows=150):
    """æ‰¹é‡è™•ç†æ‰€æœ‰å…¬å¼ cellï¼Œä¸€æ¬¡å•Ÿå‹• Excel è™•ç†æ•´å€‹æª”æ¡ˆ"""
    if not file_path or not sheet_name:
        return ws
    
    try:
        import xlwings as xw
        print(f"[DEBUG] å•Ÿå‹• Excel è™•ç†å…¬å¼: {file_path}")
        app = xw.App(visible=False)
        wb = app.books.open(file_path)
        ws_xl = wb.sheets[sheet_name]
        
        # æƒææ‰€æœ‰éœ€è¦è™•ç†çš„ cell
        formula_cells = []
        for row in range(1, min(max_rows, ws.max_row + 1)):
            for col in range(1, ws.max_column + 1):
                cell = ws.cell(row=row, column=col)
                
                # è·³éåˆä½µå„²å­˜æ ¼
                if isinstance(cell, MergedCell):
                    continue
                
                val = cell.value
                
                # æª¢æŸ¥æ˜¯å¦ç‚ºå…¬å¼ï¼ˆåªè™•ç†çœŸæ­£çš„å…¬å¼ï¼Œä¸æ˜¯ Noneï¼‰
                is_formula = (isinstance(val, str) and val.startswith("=")) or \
                            (hasattr(val, '__class__') and 'ArrayFormula' in str(val.__class__))
                
                if is_formula:
                    formula_cells.append((row, col))
        
        # æ‰¹é‡è®€å–æ‰€æœ‰å…¬å¼ cell çš„å€¼
        if formula_cells:
            print(f"[DEBUG] æ‰¾åˆ° {len(formula_cells)} å€‹å…¬å¼ cellï¼Œé–‹å§‹æ‰¹é‡è™•ç†")
            for row, col in formula_cells:
                try:
                    display_value = ws_xl.range((row, col)).value
                    # æ›´æ–° openpyxl çš„ cell å€¼
                    ws.cell(row=row, column=col).value = display_value
                except Exception as e:
                    print(f"[DEBUG] è™•ç†å…¬å¼å¤±æ•— row={row} col={col}: {e}")
        
        wb.close()
        app.quit()
        print(f"[DEBUG] Excel è™•ç†å®Œæˆ")
        
    except Exception as e:
        print(f"[DEBUG] æ‰¹é‡è™•ç†å…¬å¼å¤±æ•—: {e}")
    
    return ws

# ========== å…¥å£ç‚¹ ==========
if __name__ == '__main__':
    try:
        app = SushiExpressApp()
        app.mainloop()
    except Exception as e:
        messagebox.showerror("Error", f"Startup failed: {e}")
        sys.exit(1)
