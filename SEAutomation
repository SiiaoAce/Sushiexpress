import os
import sys
import threading
import time
import re
import copy
import csv
import traceback
import calendar
from datetime import datetime, timedelta
from collections import defaultdict
from dateutil.parser import parse
from typing import List, Optional, Tuple
try:
    from tkcalendar import DateEntry
except ImportError:
    DateEntry = None
import customtkinter as ctk
from tkinter import filedialog, messagebox, simpledialog
from openpyxl import load_workbook, Workbook
from openpyxl.utils import get_column_letter
from openpyxl.worksheet.worksheet import Worksheet
import codecs
import pandas as pd
from PIL import Image, ImageDraw, ImageFont
from openpyxl.cell.cell import MergedCell
import glob
import xlwings as xw
import tkinter.ttk as ttk
import tempfile
import uuid
import win32com.client
import base64
import pywintypes
import openpyxl
from openpyxl.styles import Alignment, Font, PatternFill, Border, Side
from calendar import monthcalendar
from typing import Dict, List, Tuple, Optional, Any, Union, Callable
import multiprocessing
multiprocessing.freeze_support()   # for PyInstaller on Windows



def safe_save_excel_workbook(workbook, file_path):
    """å…¨å±€å®‰å…¨ä¿å­˜ Excel å·¥ä½œç°¿å‡½æ•¸ï¼Œé¿å…å‘½åç¯„åœå•é¡Œ"""
    try:
        import shutil
        import copy
        
        # å‰µå»ºå‚™ä»½
        backup_path = file_path.replace('.xlsx', '_backup.xlsx')
        shutil.copy2(file_path, backup_path)
        
        # ä½¿ç”¨å·¥ä½œç°¿è¤‡è£½æ–¹æ³•ï¼Œå®Œå…¨é¿å…å¤–éƒ¨éˆæ¥å’Œå‘½åç¯„åœå•é¡Œ
        try:
            print(f"[DEBUG] ä½¿ç”¨å·¥ä½œç°¿è¤‡è£½æ–¹æ³•ï¼Œé¿å…æ‰€æœ‰Excelä¿®å¾©å•é¡Œ")
            
            # å‰µå»ºæ–°çš„å·¥ä½œç°¿
            new_wb = openpyxl.Workbook()
            
            # åˆªé™¤é»˜èªå·¥ä½œè¡¨
            if 'Sheet' in new_wb.sheetnames:
                del new_wb['Sheet']
            
            # è¤‡è£½æ‰€æœ‰å·¥ä½œè¡¨
            for sheet in workbook.worksheets:
                new_ws = new_wb.create_sheet(sheet.title)
                
                # è¤‡è£½æ‰€æœ‰æ•¸æ“šå’Œæ ¼å¼
                for row in sheet.iter_rows():
                    for cell in row:
                        new_cell = new_ws.cell(row=cell.row, column=cell.column)
                        
                        # è¤‡è£½å€¼ï¼ˆä¿æŒåŸå§‹å€¼ï¼ŒåŒ…æ‹¬æ‰€æœ‰å…¬å¼ï¼‰
                        if cell.value is not None:
                            new_cell.value = cell.value
                            print(f"[DEBUG] è¤‡è£½å€¼: {cell.coordinate} = {cell.value}")
                        
                        # å®‰å…¨è¤‡è£½æ ¼å¼ï¼Œé¿å…å¾ªç’°å¼•ç”¨
                        try:
                            if cell.font:
                                from openpyxl.styles import Font
                                new_cell.font = Font(
                                    name=cell.font.name,
                                    size=cell.font.size,
                                    bold=cell.font.bold,
                                    italic=cell.font.italic,
                                    vertAlign=cell.font.vertAlign,
                                    underline=cell.font.underline,
                                    strike=cell.font.strike,
                                    color=cell.font.color
                                )
                        except Exception:
                            pass
                        
                        try:
                            if cell.fill and hasattr(cell.fill, 'fill_type'):
                                from openpyxl.styles import PatternFill
                                new_cell.fill = PatternFill(
                                    fill_type=cell.fill.fill_type,
                                    start_color=cell.fill.start_color,
                                    end_color=cell.fill.end_color
                                )
                        except Exception:
                            pass
                        
                        try:
                            if cell.alignment:
                                from openpyxl.styles import Alignment
                                new_cell.alignment = Alignment(
                                    horizontal=cell.alignment.horizontal,
                                    vertical=cell.alignment.vertical,
                                    text_rotation=cell.alignment.text_rotation,
                                    wrap_text=cell.alignment.wrap_text,
                                    shrink_to_fit=cell.alignment.shrink_to_fit,
                                    indent=cell.alignment.indent
                                )
                        except Exception:
                            pass
                        
                        try:
                            if cell.border:
                                from openpyxl.styles import Border, Side
                                new_cell.border = Border(
                                    left=Side(border_style=cell.border.left.style, color=cell.border.left.color),
                                    right=Side(border_style=cell.border.right.style, color=cell.border.right.color),
                                    top=Side(border_style=cell.border.top.style, color=cell.border.top.color),
                                    bottom=Side(border_style=cell.border.bottom.style, color=cell.border.bottom.color)
                                )
                        except Exception:
                            pass
                        
                        try:
                            if cell.number_format:
                                new_cell.number_format = cell.number_format
                        except Exception:
                            pass
                
                # è¤‡è£½åˆä½µå„²å­˜æ ¼
                for merged_range in sheet.merged_cells.ranges:
                    new_ws.merge_cells(str(merged_range))
                
                # è¤‡è£½åˆ—å¯¬å’Œè¡Œé«˜
                for col in sheet.column_dimensions:
                    new_ws.column_dimensions[col].width = sheet.column_dimensions[col].width
                    # è¤‡è£½åˆ—çš„éš±è—ç‹€æ…‹
                    if hasattr(sheet.column_dimensions[col], 'hidden'):
                        new_ws.column_dimensions[col].hidden = sheet.column_dimensions[col].hidden
                        print(f"[DEBUG] è¤‡è£½åˆ—éš±è—ç‹€æ…‹: åˆ—{col} = {sheet.column_dimensions[col].hidden}")
                
                for row in sheet.row_dimensions:
                    new_ws.row_dimensions[row].height = sheet.row_dimensions[row].height
                    # è¤‡è£½è¡Œçš„éš±è—ç‹€æ…‹
                    if hasattr(sheet.row_dimensions[row], 'hidden'):
                        new_ws.row_dimensions[row].hidden = sheet.row_dimensions[row].hidden
                        print(f"[DEBUG] è¤‡è£½è¡Œéš±è—ç‹€æ…‹: è¡Œ{row} = {sheet.row_dimensions[row].hidden}")
                
                # å›ºå®šè¨­å®šå‡çµçª—æ ¼ç‚º A9
                try:
                    new_ws.freeze_panes = "A9"
                    print(f"[DEBUG] è¨­å®šå›ºå®šå‡çµçª—æ ¼: A9")
                except Exception as freeze_error:
                    print(f"[DEBUG] è¨­å®šå‡çµçª—æ ¼å¤±æ•—: {freeze_error}")
                
                # è¤‡è£½å·¥ä½œè¡¨ä¿è­·
                if sheet.protection:
                    new_ws.protection = sheet.protection
            
            # ä¿å­˜æ–°å·¥ä½œç°¿
            new_wb.save(file_path)
            new_wb.close()
            print(f"[DEBUG] å·¥ä½œç°¿è¤‡è£½ä¿å­˜æˆåŠŸ: {file_path}")
            
            # åˆªé™¤å‚™ä»½
            if os.path.exists(backup_path):
                os.remove(backup_path)
            
            return True
            
        except Exception as copy_error:
            print(f"[DEBUG] å·¥ä½œç°¿è¤‡è£½å¤±æ•—ï¼Œä½¿ç”¨æ–°å·¥ä½œç°¿æ–¹æ³•: {copy_error}")
            
            # æ–¹æ³•2ï¼šå‰µå»ºæ–°å·¥ä½œç°¿
            new_wb = openpyxl.Workbook()
            
            # åˆªé™¤é»˜èªå·¥ä½œè¡¨
            if 'Sheet' in new_wb.sheetnames:
                del new_wb['Sheet']
            
            # è¤‡è£½æ‰€æœ‰å·¥ä½œè¡¨
            for sheet in workbook.worksheets:
                new_ws = new_wb.create_sheet(sheet.title)
                
                # è¤‡è£½æ‰€æœ‰æ•¸æ“šå’Œæ ¼å¼
                for row in sheet.iter_rows():
                    for cell in row:
                        new_cell = new_ws.cell(row=cell.row, column=cell.column)
                        
                        # è¤‡è£½å€¼ï¼ŒåŒ…æ‹¬å…¬å¼
                        if cell.value is not None:
                            new_cell.value = cell.value
                            print(f"[DEBUG] è¤‡è£½å€¼: {cell.coordinate} = {cell.value}")
                        
                        # è¤‡è£½æ ¼å¼ - ä½¿ç”¨å®‰å…¨çš„æ–¹æ³•é¿å… StyleProxy éŒ¯èª¤
                        if cell.has_style:
                            try:
                                # åªè¤‡è£½å€¼ï¼Œä¸è¤‡è£½æ¨£å¼å°è±¡å¼•ç”¨
                                if cell.font and hasattr(cell.font, 'name'):
                                    new_cell.font = openpyxl.styles.Font(
                                        name=cell.font.name,
                                        size=cell.font.size,
                                        bold=cell.font.bold,
                                        italic=cell.font.italic,
                                        color=cell.font.color
                                    )
                                # å®Œå…¨è·³éé‚Šæ¡†è¤‡è£½ï¼Œé¿å…ç”¢ç”Ÿè«åçš„é»‘ç·š
                                # ä¸è¤‡è£½é‚Šæ¡†ï¼Œè®“ Excel ä½¿ç”¨é»˜èªçš„ç¶²æ ¼ç·š
                                pass
                                if cell.fill and hasattr(cell.fill, 'fill_type'):
                                    new_cell.fill = openpyxl.styles.PatternFill(
                                        fill_type=cell.fill.fill_type,
                                        start_color=cell.fill.start_color,
                                        end_color=cell.fill.end_color
                                    )
                                if cell.alignment and hasattr(cell.alignment, 'horizontal'):
                                    new_cell.alignment = openpyxl.styles.Alignment(
                                        horizontal=cell.alignment.horizontal,
                                        vertical=cell.alignment.vertical,
                                        wrap_text=cell.alignment.wrap_text
                                    )
                                new_cell.number_format = cell.number_format
                            except Exception as style_error:
                                print(f"âš ï¸ è¤‡è£½æ¨£å¼æ™‚å‡ºéŒ¯ï¼Œè·³éæ¨£å¼: {style_error}")
                                # å¦‚æœæ¨£å¼è¤‡è£½å¤±æ•—ï¼Œåªè¤‡è£½å€¼
                                pass
                
                # è¤‡è£½åˆä½µå„²å­˜æ ¼
                for merged_range in sheet.merged_cells.ranges:
                    new_ws.merge_cells(str(merged_range))
                
                # è¤‡è£½åˆ—å¯¬å’Œéš±è—ç‹€æ…‹
                for col_letter, dimension in sheet.column_dimensions.items():
                    new_ws.column_dimensions[col_letter].width = dimension.width
                    # è¤‡è£½åˆ—çš„éš±è—ç‹€æ…‹
                    if hasattr(dimension, 'hidden'):
                        new_ws.column_dimensions[col_letter].hidden = dimension.hidden
                        print(f"[DEBUG] è¤‡è£½åˆ—éš±è—ç‹€æ…‹: åˆ—{col_letter} = {dimension.hidden}")
                
                # è¤‡è£½è¡Œé«˜å’Œéš±è—ç‹€æ…‹
                for row_num, row_dimension in sheet.row_dimensions.items():
                    new_ws.row_dimensions[row_num] = row_dimension
                    # è¤‡è£½è¡Œçš„éš±è—ç‹€æ…‹
                    if hasattr(row_dimension, 'hidden'):
                        new_ws.row_dimensions[row_num].hidden = row_dimension.hidden
                        print(f"[DEBUG] è¤‡è£½è¡Œéš±è—ç‹€æ…‹: è¡Œ{row_num} = {row_dimension.hidden}")
                
                # è¤‡è£½å‡çµçª—æ ¼ (Freeze Panes)
                if sheet.freeze_panes:
                    new_ws.freeze_panes = sheet.freeze_panes
                
                # è¤‡è£½æ¢ä»¶æ ¼å¼
                try:
                    if hasattr(sheet, 'conditional_formatting') and hasattr(sheet.conditional_formatting, '_cf_rules'):
                        for sqref, rules in sheet.conditional_formatting._cf_rules.items():
                            if isinstance(rules, list):
                                for rule in rules:
                                    new_ws.conditional_formatting.add(sqref, rule)
                            else:
                                new_ws.conditional_formatting.add(sqref, rules)
                except Exception as cf_error:
                    print(f"âš ï¸ è¤‡è£½æ¢ä»¶æ ¼å¼æ™‚å‡ºéŒ¯: {cf_error}")
                
                # è¤‡è£½å·¥ä½œè¡¨è¦–åœ–è¨­å®š
                try:
                    if hasattr(sheet, 'views') and sheet.views:
                        new_ws.views = sheet.views
                except Exception as views_error:
                    print(f"âš ï¸ è¤‡è£½è¦–åœ–è¨­å®šæ™‚å‡ºéŒ¯: {views_error}")
                
                # è¤‡è£½æ‰“å°è¨­å®š
                try:
                    if hasattr(sheet, 'print_options') and sheet.print_options:
                        new_ws.print_options = sheet.print_options
                    if hasattr(sheet, 'page_setup') and sheet.page_setup:
                        new_ws.page_setup = sheet.page_setup
                    if hasattr(sheet, 'page_margins') and sheet.page_margins:
                        new_ws.page_margins = sheet.page_margins
                except Exception as print_error:
                    print(f"âš ï¸ è¤‡è£½æ‰“å°è¨­å®šæ™‚å‡ºéŒ¯: {print_error}")
            
            # ä¿å­˜æ–°å·¥ä½œç°¿
            new_wb.save(file_path)
            new_wb.close()
            
            print(f"[DEBUG] ä½¿ç”¨æ–°å·¥ä½œç°¿ä¿å­˜æˆåŠŸ: {file_path}")
            
            # åˆªé™¤å‚™ä»½
            if os.path.exists(backup_path):
                os.remove(backup_path)
            
            return True
            
    except Exception as e:
        print(f"[DEBUG] å®‰å…¨ä¿å­˜å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹æ–¹æ³•: {e}")
        # å¦‚æœå®‰å…¨ä¿å­˜å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹æ–¹æ³•
        try:
            workbook.save(file_path)
            return False
        except Exception as final_error:
            print(f"[DEBUG] åŸå§‹ä¿å­˜ä¹Ÿå¤±æ•—: {final_error}")
            # å¦‚æœåŸå§‹ä¿å­˜ä¹Ÿå¤±æ•—ï¼Œæ¢å¾©å‚™ä»½
            if os.path.exists(backup_path):
                shutil.copy2(backup_path, file_path)
                os.remove(backup_path)
                print(f"[DEBUG] å·²æ¢å¾©å‚™ä»½æ–‡ä»¶")
            raise final_error


def normalize_supplier_name(name):
    return name.lower().replace(
    " ",
    "").replace(
        ".",
        "").replace(
            "_",
             "")


def get_week_of_month(dt: datetime) -> int:
    """
    æ ¹æ“šå¯¦éš›æ˜ŸæœŸä¾†åˆ¤æ–·æ˜¯ç•¶æœˆç¬¬å¹¾é€±
    ï¼ˆé€±ä¸€ç‚ºä¸€é€±çš„é–‹å§‹ï¼‰
    """
    year, month, day = dt.year, dt.month, dt.day
    month_cal = calendar.monthcalendar(year, month)
    week_no = 0
    for week in month_cal:
        if day in week:
            week_no = month_cal.index(week) 
            break
    return week_no


def find_supplier_file(supplier_name, files):
    norm_supplier = normalize_supplier_name(supplier_name)
    candidates = []
    exact_matches = []
    
    print(f"[DEBUG] æŸ¥æ‰¾ä¾›åº”å•†æ–‡ä»¶: {supplier_name}")
    print(f"[DEBUG] æ ‡å‡†åŒ–ä¾›åº”å•†åç§°: {norm_supplier}")

    for f in files:
        # ç²å–æª”åï¼ˆä¸å«å‰¯æª”åï¼‰
        filename_without_ext = os.path.splitext(f)[0]
        norm_f = normalize_supplier_name(filename_without_ext)
        
        # ç²¾ç¢ºåŒ¹é…ï¼šæª”åé–‹é ­å®Œå…¨åŒ¹é…ä¾›æ‡‰å•†åç¨±
        if norm_f.startswith(norm_supplier):
            remaining = norm_f[len(norm_supplier):]
            print(f"[DEBUG] æ–‡ä»¶ {f} å¼€å¤´åŒ¹é…ï¼Œå‰©ä½™: '{remaining}'")
            
            # æª¢æŸ¥æ˜¯å¦ç‚ºç²¾ç¢ºåŒ¹é…
            if not remaining or remaining.startswith(
                '_') or remaining.startswith('amendment'):
                print(f"[DEBUG] æ·»åŠ åˆ°ç²¾ç¡®åŒ¹é…ï¼ˆæ— å‰©ä½™æˆ–ä¸‹åˆ’çº¿ï¼‰")
                exact_matches.append(f)
            elif '(' in remaining and ')' in remaining:
                # å…è¨±æ‹¬è™Ÿè®Šé«”ï¼Œå¦‚ "Super Q (Chawan)"
                print(f"[DEBUG] æ·»åŠ åˆ°ç²¾ç¡®åŒ¹é…ï¼ˆæ‹¬å·å˜ä½“ï¼‰")
                exact_matches.append(f)
            elif remaining.isalnum() or any(x in remaining.lower() for x in ['oct', 'nov', 'dec', 'jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'week']):
                # å…è¨±æ™‚é–“æ¨™è­˜ï¼Œå¦‚ "octweek3"
                print(f"[DEBUG] æ·»åŠ åˆ°ç²¾ç¡®åŒ¹é…ï¼ˆæ—¶é—´æ ‡è¯†ï¼‰")
                exact_matches.append(f)
            else:
                print(f"[DEBUG] æ·»åŠ åˆ°å€™é€‰åŒ¹é…")
                candidates.append(f)
        # åŒ…å«åŒ¹é…ï¼šæª”ååŒ…å«ä¾›æ‡‰å•†åç¨±
        elif norm_supplier in norm_f:
            print(f"[DEBUG] æ–‡ä»¶ {f} åŒ…å«åŒ¹é…ï¼Œæ·»åŠ åˆ°å€™é€‰")
            candidates.append(f)
        else:
            print(f"[DEBUG] æ–‡ä»¶ {f} ä¸åŒ¹é…")

    # å„ªå…ˆè¿”å›ç²¾ç¢ºåŒ¹é…
    if len(exact_matches) == 1:
        print(f"[DEBUG] æ‰¾åˆ°å”¯ä¸€ç²¾ç¡®åŒ¹é…: {exact_matches[0]}")
        return exact_matches[0]
    elif len(exact_matches) > 1:
        print(f"[DEBUG] æ‰¾åˆ°å¤šä¸ªç²¾ç¡®åŒ¹é…: {exact_matches}")
        # å¦‚æœæœ‰å¤šä¸ªç²¾ç¡®åŒ¹é…ï¼Œä¼˜å…ˆé€‰æ‹©ä¸ä¾›åº”å•†åç§°æœ€åŒ¹é…çš„æ–‡ä»¶
        # å¦‚æœä¾›åº”å•†åç§°åŒ…å«æ‹¬å·ï¼Œä¼˜å…ˆé€‰æ‹©åŒ…å«æ‹¬å·çš„æ–‡ä»¶
        supplier_has_brackets = '(' in supplier_name and ')' in supplier_name
        
        if supplier_has_brackets:
            # ä¾›åº”å•†åç§°åŒ…å«æ‹¬å·ï¼Œä¼˜å…ˆé€‰æ‹©åŒ…å«æ‹¬å·çš„æ–‡ä»¶
            for f in exact_matches:
                if '(' in f and ')' in f:
                    print(f"[DEBUG] é€‰æ‹©åŒ…å«æ‹¬å·çš„æ–‡ä»¶: {f}")
                    return f
        
        # ä¾›åº”å•†åç§°ä¸åŒ…å«æ‹¬å·ï¼Œä¼˜å…ˆé€‰æ‹©ä¸åŒ…å«æ‹¬å·çš„æ–‡ä»¶
        for f in exact_matches:
            if '(' not in f and ')' not in f:
                print(f"[DEBUG] é€‰æ‹©ä¸åŒ…å«æ‹¬å·çš„æ–‡ä»¶: {f}")
                return f
        
        # å¦‚æœéƒ½æœ‰æ‹¬è™Ÿæˆ–éƒ½æ²’æœ‰æ‹¬è™Ÿï¼Œé¸æ“‡æœ€çŸ­çš„
        return min(exact_matches, key=len)

    # å¦‚æœæ²’æœ‰ç²¾ç¢ºåŒ¹é…ï¼Œä½¿ç”¨å€™é¸åŒ¹é…
    if len(candidates) == 1:
        return candidates[0]
    elif len(candidates) > 1:
        # å¦‚æœæœ‰å¤šä¸ªå€™é€‰åŒ¹é…ï¼Œä¼˜å…ˆé€‰æ‹©ä¸ä¾›åº”å•†åç§°æœ€åŒ¹é…çš„æ–‡ä»¶
        supplier_has_brackets = '(' in supplier_name and ')' in supplier_name
        
        if supplier_has_brackets:
            # ä¾›åº”å•†åç§°åŒ…å«æ‹¬å·ï¼Œä¼˜å…ˆé€‰æ‹©åŒ…å«æ‹¬å·çš„æ–‡ä»¶
            for f in candidates:
                if '(' in f and ')' in f and f.startswith(supplier_name):
                    print(f"[DEBUG] é€‰æ‹©åŒ…å«æ‹¬å·çš„å€™é€‰æ–‡ä»¶: {f}")
                    return f
        
        # ä¾›åº”å•†åç§°ä¸åŒ…å«æ‹¬å·ï¼Œä¼˜å…ˆé€‰æ‹©ä¸åŒ…å«æ‹¬å·çš„æ–‡ä»¶
        for f in candidates:
            if '(' not in f and ')' not in f and f.startswith(supplier_name):
                print(f"[DEBUG] é€‰æ‹©ä¸åŒ…å«æ‹¬å·çš„å€™é€‰æ–‡ä»¶: {f}")
                return f
        
        # å˜—è©¦æ‰¾åˆ°ä»¥ä¾›æ‡‰å•†åç¨±é–‹é ­çš„æ–‡ä»¶
        for f in candidates:
            if f.startswith(supplier_name):
                return f
        return candidates[0]

    return None


def find_all_supplier_files(supplier_name, files):
    """æŸ¥æ‰¾ä¾›åº”å•†çš„æ‰€æœ‰ç›¸å…³æ–‡ä»¶ï¼Œæ”¯æŒå¤šæ–‡ä»¶å‘é€"""
    all_matches = []
    
    for f in files:
        # è·å–æ–‡ä»¶åï¼ˆä¸å«å‰¯æ¡£åï¼‰
        filename_without_ext = os.path.splitext(f)[0]
        
        # æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦ä»¥ä¾›åº”å•†åç§°å¼€å¤´ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        if filename_without_ext.lower().startswith(supplier_name.lower()):
            # æ¥å—æ‰€æœ‰ç›¸å…³æ–‡ä»¶ï¼Œåªè¦æ–‡ä»¶åä»¥ä¾›åº”å•†åç§°å¼€å¤´
            # æ”¯æŒå„ç§æ ¼å¼ï¼š
            # - Super Q_Sep_Week_1.xlsx
            # - Super Q (Chawan)_Sep_Week_1.xlsx
            # - Super Q Sep_Week_1.xlsx
            # - Super Q_Amendment_Sep_1.xlsx
            all_matches.append(f)
    
    # æŒ‰æ–‡ä»¶åæ’åºï¼Œç¡®ä¿é¡ºåºä¸€è‡´
    all_matches.sort()
    return all_matches

# ======== èµ„æºè·¯å¾„å¤„ç† ========


def resource_path(relative_path):
    """è·å–èµ„æºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„"""
    try:
        base_path = sys._MEIPASS
    except AttributeError:
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)


# ========== å…¨å±€é…ç½® ==========
LOGO_PATH = resource_path("SELOGO22 - 01.png")
PASSWORD = "OPS123"
VERSION = "6.6.1"
DEVELOPER = "OPS - Voon Kee"

# ä¸»é¢˜é…ç½®
ctk.set_appearance_mode("dark")
ctk.set_default_color_theme("blue")

# ========== é¢œè‰²ä¸»é¢˜ç³»ç»Ÿ ==========
class ColorTheme:
    """é¢œè‰²ä¸»é¢˜ç±»"""
    def __init__(self, name, dark_bg, dark_panel, accent_blue, btn_hover, accent_green, 
                 accent_red, accent_purple, entry_bg, text_color, panel_bg, textbox_bg, 
                 gradient_colors=None, description=""):
        self.name = name
        self.dark_bg = dark_bg
        self.dark_panel = dark_panel
        self.accent_blue = accent_blue
        self.btn_hover = btn_hover
        self.accent_green = accent_green
        self.accent_red = accent_red
        self.accent_purple = accent_purple
        self.entry_bg = entry_bg
        self.text_color = text_color
        self.panel_bg = panel_bg
        self.textbox_bg = textbox_bg
        self.gradient_colors = gradient_colors or []
        self.description = description

# é¢„å®šä¹‰ä¸»é¢˜
THEMES = {
    "classic_blue": ColorTheme(
        name="ç¶“å…¸è—\nClassic Blue",
        dark_bg="#0f172a",
        dark_panel="#1e293b", 
        accent_blue="#3b82f6",
        btn_hover="#2563eb",
        accent_green="#10b981",
        accent_red="#ef4444",
        accent_purple="#8b5cf6",
        entry_bg="#334155",
        text_color="#f1f5f9",
        panel_bg="#1e293b",
        textbox_bg="#0f172a",
        gradient_colors=["#0f172a", "#1e293b", "#334155", "#475569", "#64748b"],
        description="ç¶“å…¸è—è‰²ä¸»é¡Œï¼Œå°ˆæ¥­ç©©é‡"
    ),
    "pure_black": ColorTheme(
        name="ç´”é»‘\nPure Black",
        dark_bg="#000000",
        dark_panel="#111111",
        accent_blue="#60a5fa",
        btn_hover="#3b82f6",
        accent_green="#34d399",
        accent_red="#f87171",
        accent_purple="#a78bfa",
        entry_bg="#1f1f1f",
        text_color="#ffffff",
        panel_bg="#111111",
        textbox_bg="#000000",
        gradient_colors=["#000000", "#111111", "#1f1f1f", "#2d2d2d", "#404040"],
        description="ç´”é»‘ä¸»é¡Œï¼Œç°¡ç´„æ™‚å°š"
    ),
    "blue_gradient": ColorTheme(
        name="è—è‰²æ¼¸è®Š\nBlue Gradient",
        dark_bg="#0c4a6e",
        dark_panel="#075985",
        accent_blue="#0ea5e9",
        btn_hover="#0284c7",
        accent_green="#22d3ee",
        accent_red="#f472b6",
        accent_purple="#a855f7",
        entry_bg="#0369a1",
        text_color="#e0f2fe",
        panel_bg="#075985",
        textbox_bg="#0c4a6e",
        gradient_colors=["#0c4a6e", "#075985", "#0369a1", "#0284c7", "#0ea5e9"],
        description="è—è‰²æ¼¸è®Šä¸»é¡Œï¼Œæ¸…æ–°å„ªé›…"
    ),
    "bright_light": ColorTheme(
        name="æ˜äº®ä¸»é¡Œ\nBright Light",
        dark_bg="#ffffff",
        dark_panel="#f8fafc",
        accent_blue="#2563eb",
        btn_hover="#3b82f6",
        accent_green="#059669",
        accent_red="#dc2626",
        accent_purple="#7c3aed",
        entry_bg="#e2e8f0",
        text_color="#1e293b",
        panel_bg="#f1f5f9",
        textbox_bg="#ffffff",
        gradient_colors=["#ffffff", "#f8fafc", "#e2e8f0", "#cbd5e1", "#94a3b8"],
        description="æ˜äº®æ¸…çˆ½ä¸»é¡Œï¼Œé©åˆç™½å¤©ä½¿ç”¨"
    )
}

# å½“å‰ä¸»é¢˜
CURRENT_THEME = "classic_blue"

def get_current_theme():
    """è·å–å½“å‰ä¸»é¢˜"""
    return THEMES.get(CURRENT_THEME, THEMES["classic_blue"])

def set_theme(theme_name):
    """è®¾ç½®ä¸»é¢˜"""
    global CURRENT_THEME
    if theme_name in THEMES:
        CURRENT_THEME = theme_name
        return True
    return False

def save_theme_config():
    """ä¿å­˜ä¸»é¢˜é…ç½®"""
    try:
        import json
        config = {"theme": CURRENT_THEME}
        with open("theme_config.json", "w", encoding="utf-8") as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
    except Exception as e:
        print(f"ä¿å­˜ä¸»é¢˜é…ç½®å¤±è´¥: {e}")

def load_theme_config():
    """åŠ è½½ä¸»é¢˜é…ç½®"""
    try:
        if os.path.exists("theme_config.json"):
            import json
            with open("theme_config.json", "r", encoding="utf-8") as f:
                config = json.load(f)
                if "theme" in config and config["theme"] in THEMES:
                    global CURRENT_THEME
                    CURRENT_THEME = config["theme"]
    except Exception as e:
        print(f"åŠ è½½ä¸»é¢˜é…ç½®å¤±è´¥: {e}")

# åŠ è½½ä¸»é¢˜é…ç½®
load_theme_config()

# é¢œè‰²å®šä¹‰
DARK_BG = "#0f172a"
DARK_PANEL = "#1e293b"
ACCENT_BLUE = "#3b82f6"
BTN_HOVER = "#60a5fa"
ACCENT_GREEN = "#10b981"
ACCENT_RED = "#ef4444"
ACCENT_PURPLE = "#8b5cf6"
ACCENT_ORANGE = "#f97316"
ENTRY_BG = "#334155"
TEXT_COLOR = "#e2e8f0"
PANEL_BG = "#1e293b"
TEXTBOX_BG = "#0f172a"

# å­—ä½“é…ç½®
FONT_TITLE = ("Microsoft JhengHei", 24, "bold")
FONT_BIGBTN = ("Microsoft JhengHei", 16, "bold")
FONT_MID = ("Microsoft JhengHei", 14)
FONT_SUB = ("Microsoft JhengHei", 12)
FONT_ZH = ("Microsoft JhengHei", 12)
FONT_EN = ("Segoe UI", 11, "italic")
FONT_LOG = ("Consolas", 14)
FONT_SMALL = ("Microsoft JhengHei", 10)

# ========== å¤šè¯­è¨€æ”¯æŒ ==========


def t(text):
    translations = {
        "mapping_not_available": "åˆ†åº—ä¾›åº”å•†å¯¹åº”æ•°æ®ä¸å¯ç”¨\nOutlet-supplier mapping not available",
        "log_not_available": "æ—¥å¿—æ•°æ®ä¸å¯ç”¨\nLog data not available",
        "info": "ä¿¡æ¯\nInformation",
        "processing": "è™•ç†ä¸­...\nProcessing...",
        "please_wait": "è«‹ç¨å€™...\nPlease wait...",
        "error": "éŒ¯èª¤\nError",
        "login": "ç³»çµ±ç™»éŒ„\nSystem Login",
        "password": "è¼¸å…¥å¯†ç¢¼...\nEnter password...",
        "login_btn": "ç™»å…¥\nLogin",
        "exit_confirm": "ç¢ºå®šè¦é€€å‡ºæ‡‰ç”¨ç¨‹åºå—ï¼Ÿ\nAre you sure you want to exit the application?",
        "incorrect_pw": "å¯†ç¢¼ä¸æ­£ç¢ºï¼Œè«‹é‡è©¦\nIncorrect password, please try again",
        "main_title": "Sushi Express è‡ªå‹•åŒ–å·¥å…·\nSushi Express Automation Tool",
        "select_function": "è«‹é¸æ“‡è¦åŸ·è¡Œçš„åŠŸèƒ½\nPlease select a function",
        "download_title": "Outlook è¨‚å–®ä¸‹è¼‰\nOutlook Order Download",
        "download_desc": "ä¸‹è¼‰æœ¬é€±çš„ Weekly Order é™„ä»¶\nDownload weekly order attachments",
        "browse": "ç€è¦½...\nBrowse...",
        "start_download": "é–‹å§‹ä¸‹è¼‰\nStart Download",
        "back_to_menu": "è¿”å›ä¸»èœå–®\nBack to Main Menu",
        "checklist_title": "Weekly Order æª¢æŸ¥è¡¨\nWeekly Order Checklist",
        "checklist_desc": "è«‹é¸æ“‡åŒ…å«ä¾›æ‡‰å•†è¨‚å–®çš„è³‡æ–™å¤¾\nSelect folder with supplier orders",
        "run_check": "åŸ·è¡Œæª¢æŸ¥\nRun Check",
        "automation_title": "è¨‚å–®è‡ªå‹•æ•´åˆ\nOrder Automation",
        "automation_desc": "è«‹é¸æ“‡ä¸‰å€‹å¿…è¦çš„è³‡æ–™å¤¾\nSelect required folders",
        "source_folder": "ä¾†æºè³‡æ–™å¤¾ (Weekly Orders)\nSource Folder (Weekly Orders)",
        "supplier_folder": "ä¾›æ‡‰å•†è³‡æ–™å¤¾ (Supplier)\nSupplier Folder",
        "outlet_folder": "åˆ†åº—è³‡æ–™å¤¾ (Outlet)\nOutlet Folder",
        "start_automation": "é–‹å§‹æ•´åˆæª”æ¡ˆ\nStart Automation",
        "processing_orders": "è™•ç†è¨‚å–®\nProcessing Orders",
        "outlet_suppliers": "åˆ†åº—ä¾›æ‡‰å•†å°æ‡‰\nOutlet-Supplier Mapping",
        "exit_system": "é€€å‡ºç³»çµ±\nExit System",
        "theme_selection": "ä¸»é¡Œé¸æ“‡\nTheme Selection",
        "select_account": "é¸æ“‡ Outlook å¸³è™Ÿ\nSelect Outlook Account",
        "enter_index": "è«‹è¼¸å…¥åºè™Ÿï¼š\nPlease enter index:",
        "download_summary": "ä¸‹è¼‰æ‘˜è¦\nDownload Summary",
        "auto_download": "è‡ªå‹•ä¸‹è¼‰\nAuto Downloaded",
        "skipped": "è·³é\nSkipped",
        "saved_to": "ä¿å­˜åˆ°\nSaved to",
        "check_results": "æª¢æŸ¥çµæœ\nCheck Results",
        "success": "æˆåŠŸ\nSuccess",
        "warning": "è­¦å‘Š\nWarning",
        "folder_warning": "è«‹å…ˆé¸æ“‡æ‰€æœ‰å¿…è¦çš„è³‡æ–™å¤¾\nPlease select all required folders",
        "close": "é—œé–‰\nClose",
        "order_processing": "è¨‚å–®è™•ç†é€²åº¦\nOrder Processing Progress",
        "outlet_supplier_mapping": "åˆ†åº—-ä¾›æ‡‰å•†å°æ‡‰é—œä¿‚\nOutlet-Supplier Mapping",
        "select_folder": "é¸æ“‡æ–‡ä»¶å¤¾\nSelect Folder",
        "view_mapping": "æŸ¥çœ‹åˆ†åº—ä¾›æ‡‰å•†å°æ‡‰\nView Outlet-Supplier Mapping",
        "view_log": "æŸ¥çœ‹å®Œæ•´æ—¥èªŒ\nView Full Log",
        "supplier_files": "å·²è™•ç†çš„ä¾›æ‡‰å•†æ–‡ä»¶\nProcessed Supplier Files",
        "outlet_files": "å·²è™•ç†çš„åˆ†åº—æ–‡ä»¶\nProcessed Outlet Files",
        "outlet_orders": "åˆ†åº—è¨‚è³¼æƒ…æ³\nOutlet Orders",
        "supplier_orders": "ä¾›æ‡‰å•†è¨‚è³¼æƒ…æ³\nSupplier Orders",
        "send_emails": "ç™¼é€éƒµä»¶\nSend Emails",
        "operation_supplies": "ç‡Ÿé‹ç”¨å“\nOperation Supplies",
        "ordering_function": "è¨‚å–®åŠŸèƒ½\nOrdering Function",
        "monthend_function": "æœˆçµåŠŸèƒ½\nMonthend Closing Function",
        "function_selection": "åŠŸèƒ½é¸æ“‡\nFunction Selection",
        "enter_monthend": "é€²å…¥æœˆçµåŠŸèƒ½\nEnter Monthend Function",
        "ordering_function_title": "ğŸ“‹ è¨‚å–®åŠŸèƒ½\nOrdering Function",
        "monthend_function_title": "ğŸ“Š æœˆçµåŠŸèƒ½\nMonthend Closing Function",
        "monthend_related": "æœˆçµç›¸é—œåŠŸèƒ½\nMonthend related functions",
        "monthend_function_nav": "ğŸ“Š æœˆçµåŠŸèƒ½\nMonthend Function",
        "month_end_function": "ğŸ“Š æœˆçµåŠŸèƒ½\nMonth-end Function",
        "back_to_main": "è¿”å›ä¸»èœå–®\nBack to Main",
        "coming_soon": "(å³å°‡æ¨å‡º Coming Soon)",
        "outlook_order_download": "Outlookè¨‚å–®ä¸‹è¼‰\nOutlook Order Download",
        "order_automation": "è¨‚å–®è‡ªå‹•æ•´åˆ\nOrder Automation",
        "weekly_order_checklist": "æ¯é€±è¨‚å–®æª¢æŸ¥è¡¨\nWeekly Order Checklist",
        "send_emails": "ç™¼é€éƒµä»¶\nSend Emails",
        "operation_supplies": "ç‡Ÿé‹ç”¨å“\nOperation Supplies",
        "monthend_download": "æœˆçµæ–‡ä»¶ä¸‹è¼‰\nMonth-end Download",
        "monthly_order_summary": "è¨‚å–®æœˆåº¦å½™ç¸½\nMonthly Order Summary",
        "supplier_statement": "ä¾›æ‡‰å•†å°è³¬å–®\nSupplier Statement",
        "monthly_sales_report": "æœˆåº¦éŠ·å”®å ±è¡¨\nMonthly Sales Report",
        "cost_analysis": "æˆæœ¬åˆ†ææ ¸ç®—\nCost Analysis",
        "inventory_count": "åº«å­˜ç›¤é»æ•´ç†\nInventory Count",
    }
    return translations.get(text, text)


def get_contrast_color(bg_color):
    # ç°¡å–®äº®è‰²/æš—è‰²å°æ¯”
    if isinstance(bg_color, str) and bg_color.startswith('#'):
        r = int(bg_color[1:3], 16)
        g = int(bg_color[3:5], 16)
        b = int(bg_color[5:7], 16)
        luminance = (0.299 * r + 0.587 * g + 0.114 * b)
        return '#000000' if luminance > 186 else '#ffffff'
    return '#ffffff'

# ========== å·¥å…·å‡½æ•° ==========


def load_image(path, max_size=(400, 130)):
    """å®‰å…¨åŠ è½½å›¾åƒ"""
    try:
        if not os.path.exists(path):
            img = Image.new('RGB', max_size, color=DARK_BG[:3])
            draw = ImageDraw.Draw(img)
            font = ImageFont.truetype("arial.ttf", 24)
            draw.text((10, 10), "Logo Missing", fill="white", font=font)
        else:
            img = Image.open(path)
        img.thumbnail(max_size, Image.LANCZOS)
        return ctk.CTkImage(img, size=img.size)
    except Exception as e:
        print(f"Error loading image: {e}")
        return None

# ========== è‡ªå®šä¹‰UIç»„ä»¶ ==========


class TopMostSuccessDialog(ctk.CTkToplevel):
    """ç½®é ‚æˆåŠŸæç¤ºå°è©±æ¡†"""

    def __init__(self, parent, title, message, auto_close_seconds=3):
        super().__init__(parent)
        self.title(title)
        self.geometry("400x200")
        self.resizable(False, False)
        self.transient(parent)
        self.grab_set()

        # è¨­ç½®ç½®é ‚
        self.attributes('-topmost', True)

        # å±…ä¸­é¡¯ç¤º
        self.center_window()

        # è¨­ç½®èƒŒæ™¯è‰²
        self.configure(fg_color=DARK_BG)

        # ä¸»å®¹å™¨
        main_frame = ctk.CTkFrame(self, fg_color=DARK_PANEL, corner_radius=12)
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # æˆåŠŸåœ–æ¨™
        icon_label = ctk.CTkLabel(
            main_frame,
            text="âœ…",
            font=("Microsoft YaHei", 32),
            text_color=ACCENT_GREEN
        )
        icon_label.pack(pady=(20, 10))

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
            main_frame,
            text=title,
            font=("Microsoft YaHei", 16, "bold"),
            text_color="white"
        )
        title_label.pack(pady=(0, 10))

        # æ¶ˆæ¯
        message_label = ctk.CTkLabel(
            main_frame,
            text=message,
            font=("Microsoft YaHei", 12),
            text_color="#cccccc",
            wraplength=300
        )
        message_label.pack(pady=(0, 20))

        # ç¢ºå®šæŒ‰éˆ•
        ok_button = ctk.CTkButton(
            main_frame,
            text="ç¢ºå®š / OK",
            command=self.destroy,
            fg_color=ACCENT_GREEN,
            hover_color="#059669",
            font=("Microsoft YaHei", 12, "bold"),
            width=100,
            height=32
        )
        ok_button.pack(pady=(0, 20))

        # å¼·åˆ¶ç²å¾—ç„¦é»
        self.focus_force()

        # è‡ªå‹•é—œé–‰
        if auto_close_seconds > 0:
            self.after(auto_close_seconds * 1000, self.destroy)

    def center_window(self):
        """å±…ä¸­é¡¯ç¤ºè¦–çª—"""
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f"{width}x{height}+{x}+{y}")


def show_topmost_success(parent, title, message, auto_close_seconds=3):
    """é¡¯ç¤ºç½®é ‚æˆåŠŸæç¤ºå°è©±æ¡†çš„ä¾¿åˆ©å‡½æ•¸"""
    TopMostSuccessDialog(parent, title, message, auto_close_seconds)


class OutlookAccountSelector(ctk.CTkToplevel):
    """ç¾åŒ–çš„ Outlook å¸³è™Ÿé¸æ“‡å°è©±æ¡†"""

    def __init__(self, parent, account_names):
        super().__init__(parent)
        self.title("é¸æ“‡ Outlook å¸³è™Ÿ / Select Outlook Account")
        self.geometry("600x550")  # å¢åŠ å¯¬åº¦å’Œé«˜åº¦
        self.configure(fg_color=DARK_BG)
        self.selected_index = None

        # è¨­ç½®ç‚ºç½®é ‚ä¸¦å±…ä¸­
        self.attributes('-topmost', True)
        self.resizable(True, True)  # å…è¨±èª¿æ•´å¤§å°

        # å±…ä¸­é¡¯ç¤º
        self.update_idletasks()
        x = (self.winfo_screenwidth() // 2) - (600 // 2)
        y = (self.winfo_screenheight() // 2) - (550 // 2)
        self.geometry(f"600x550+{x}+{y}")

        # ä¸»å®¹å™¨
        main_container = ctk.CTkFrame(self, fg_color="transparent")
        main_container.pack(fill="both", expand=True, padx=20, pady=20)

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
            main_container,
            text="é¸æ“‡ Outlook å¸³è™Ÿ\nSelect Outlook Account",
            font=("Microsoft JhengHei", 18, "bold"),
            text_color=ACCENT_BLUE
        )
        title_label.pack(pady=(0, 10))

        # èªªæ˜æ–‡å­—
        info_label = ctk.CTkLabel(
            main_container,
            text="è«‹é¸æ“‡è¦ç”¨æ–¼ä¸‹è¼‰éƒµä»¶çš„ Outlook å¸³è™Ÿ\nPlease select the Outlook account for downloading emails",
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR
        )
        info_label.pack(pady=(0, 20))

        # å¸³è™Ÿåˆ—è¡¨æ¡†æ¶
        list_frame = ctk.CTkFrame(
    main_container,
    fg_color=DARK_PANEL,
     corner_radius=10)
        list_frame.pack(fill="both", expand=True, pady=(0, 20))

        # æ»¾å‹•æ¡†æ¶
        scroll_frame = ctk.CTkScrollableFrame(
            list_frame, fg_color="transparent")
        scroll_frame.pack(fill="both", expand=True, padx=15, pady=15)

        # å¸³è™Ÿé¸é …
        self.account_vars = []
        for i, account_name in enumerate(account_names):
            var = ctk.StringVar(value="")
            self.account_vars.append(var)

            # å¸³è™Ÿé¸é …æ¡†æ¶
            account_frame = ctk.CTkFrame(
    scroll_frame, fg_color=ENTRY_BG, corner_radius=8)
            account_frame.pack(fill="x", pady=5)

            # å–®é¸æŒ‰éˆ•
            radio_btn = ctk.CTkRadioButton(
                account_frame,
                text=f"[{i}] {account_name}",
                variable=var,
                value=str(i),
                font=("Microsoft JhengHei", 12),
                text_color=TEXT_COLOR,
                fg_color=ACCENT_BLUE,
                hover_color=BTN_HOVER,
                command=lambda idx=i: self._on_account_selected(idx)
            )
            radio_btn.pack(anchor="w", padx=15, pady=10)

        # æŒ‰éˆ•æ¡†æ¶
        btn_frame = ctk.CTkFrame(main_container, fg_color="transparent")
        btn_frame.pack(fill="x", pady=(10, 0))

        # å–æ¶ˆæŒ‰éˆ•
        cancel_btn = ctk.CTkButton(
            btn_frame,
            text="å–æ¶ˆ / Cancel",
            command=self._on_cancel,
            fg_color="#6b7280",
            hover_color="#4b5563",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=120,
            height=40
        )
        cancel_btn.pack(side="right", padx=(10, 0))

        # ç¢ºå®šæŒ‰éˆ•
        ok_btn = ctk.CTkButton(
            btn_frame,
            text="ç¢ºå®š / OK",
            command=self._on_ok,
            fg_color=ACCENT_GREEN,
            hover_color="#059669",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=120,
            height=40
        )
        ok_btn.pack(side="right", padx=(0, 10))

        # ç¢ºä¿è¦–çª—ç²å¾—ç„¦é»
        self.focus_force()
        self.grab_set()

        # å¼·åˆ¶æ›´æ–°ä½ˆå±€
        self.update_idletasks()

    def _on_account_selected(self, index):
        """ç•¶é¸æ“‡å¸³è™Ÿæ™‚"""
        self.selected_index = index
        # æ¸…é™¤å…¶ä»–é¸é …
        for i, var in enumerate(self.account_vars):
            if i != index:
                var.set("")

    def _on_ok(self):
        """ç¢ºå®šæŒ‰éˆ•"""
        if self.selected_index is not None:
            self.destroy()
        else:
            messagebox.showwarning("æœªé¸æ“‡", "è«‹å…ˆé¸æ“‡ä¸€å€‹ Outlook å¸³è™Ÿ")

    def _on_cancel(self):
        """å–æ¶ˆæŒ‰éˆ•"""
        self.selected_index = None
        self.destroy()


def show_outlook_account_selector(parent, account_names):
    """é¡¯ç¤º Outlook å¸³è™Ÿé¸æ“‡å°è©±æ¡†"""
    dialog = OutlookAccountSelector(parent, account_names)

    # ç­‰å¾…å°è©±æ¡†é—œé–‰
    try:
        if parent:
            parent.wait_window(dialog)
        else:
            dialog.wait_window()
    except Exception as e:
        print(f"å°è©±æ¡†ç­‰å¾…éŒ¯èª¤: {e}")

    return dialog.selected_index

# ========== è‡ªå®šä¹‰UIç»„ä»¶ ==========


class GlowButton(ctk.CTkButton):
    """å‘å…‰æ•ˆæœæŒ‰é’®ï¼ˆç¾åŒ–ç‰ˆï¼‰"""

    def __init__(self, master, text=None, glow_color=ACCENT_BLUE, **kwargs):
        super().__init__(master, text=text, **kwargs)
        self._glow_color = glow_color
        self._setup_style()
        self._bind_events()

    def _setup_style(self):
        self.configure(
            border_width=0,
            fg_color=self._glow_color,
            hover_color=self._adjust_color(self._glow_color, 40),
            text_color=get_contrast_color(self._glow_color),
            corner_radius=22,  # æ›´åœ†è§’
            font=("Microsoft JhengHei", 20, "bold"),  # æ›´å¤§æ›´ç²—
            height=70,  # æ›´é«˜
            width=340,  # æ›´å®½
            anchor="center"
        )

    def _bind_events(self):
        self.bind("<Enter>", self._on_enter)
        self.bind("<Leave>", self._on_leave)

    def _on_enter(self, event=None):
        self.configure(
    border_width=4, border_color=self._adjust_color(
        self._glow_color, 60), fg_color=self._adjust_color(
            self._glow_color, 20))

    def _on_leave(self, event=None):
        self.configure(border_width=0, fg_color=self._glow_color)

    @staticmethod
    def _adjust_color(color, amount):
        if isinstance(color, tuple) and len(color) >= 3:
            r, g, b = color[:3]
            adjusted = tuple(min(255, max(0, x + amount)) for x in (r, g, b))
            if len(color) == 4:
                return adjusted + (color[3],)
            return adjusted
        else:
            color = color.lstrip('#')
            rgb = tuple(int(color[i:i + 2], 16) for i in (0, 2, 4))
            adjusted = tuple(min(255, max(0, x + amount)) for x in rgb)
            return f"#{adjusted[0]:02x}{adjusted[1]:02x}{adjusted[2]:02x}"


class ProgressPopup(ctk.CTkToplevel):
    """è¿›åº¦æ˜¾ç¤ºå¼¹çª—"""

    def __init__(
    self,
    parent,
    title,
    start_date=None,
    end_date=None,
     outlet_count=None):
        super().__init__(parent)
        self.title(title)
        self.geometry("900x700")
        self.transient(parent)
        self.grab_set()
        self.parent = parent
        self.configure(fg_color=DARK_BG)
        self.log_text = ctk.CTkTextbox(
            self,
            wrap="word",
            font=FONT_LOG,
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            corner_radius=10
        )
        self.log_text.pack(fill="both", expand=True, padx=20, pady=20)
        self.log_text.configure(state="normal")
        if start_date and end_date:
            self.log_text.insert(
    "end", f"ğŸ“… æŠ“å–æ—¥æœŸç¯„åœ: {start_date} ~ {end_date}\n")
        self.log_text.configure(state="disabled")
        self.outlet_count_label = ctk.CTkLabel(
            self,
            text=f"ğŸª å·²ä¸‹è¼‰åˆ†åº—æ•¸é‡: {
    outlet_count if outlet_count is not None else 0} é–“",
            font=("Microsoft JhengHei", 18, "bold"),
            text_color="#10b981"
        )
        self.outlet_count_label.pack(pady=(0, 10))
        close_btn = GlowButton(
            self,
            text=t("close"),
            command=self.destroy_popup,
            width=120,
            height=40
        )
        close_btn.pack(pady=10)

    def update_outlet_count(self, count):
        if self.outlet_count_label:
            self.outlet_count_label.configure(text=f"ğŸª å·²ä¸‹è¼‰åˆ†åº—æ•¸é‡: {count} é–“")

    def destroy_popup(self):
        self.destroy()
        self.parent.progress_popup = None

    def log(self, message):
        self.log_text.configure(state="normal")
        self.log_text.insert("end", message)
        self.log_text.see("end")
        self.log_text.configure(state="disabled")
        # å¼·åˆ¶æ›´æ–°UI
        self.update()


class MappingPopup(ctk.CTkToplevel):
    """åˆ†åº—-ä¾›åº”å•†æ˜ å°„æ˜¾ç¤º"""

    def __init__(self, parent, title):
        super().__init__(parent)
        self.title(title)
        self.geometry("900x700")
        self.transient(parent)
        self.grab_set()
        self.parent = parent
        self.configure(fg_color=DARK_BG)

        self.mapping_text = ctk.CTkTextbox(
            self,
            wrap="word",
            font=FONT_LOG,
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            corner_radius=10
        )
        self.mapping_text.pack(fill="both", expand=True, padx=20, pady=20)
        self.mapping_text.configure(state="disabled")

        close_btn = GlowButton(
            self,
            text=t("close"),
            command=self.destroy_popup,
            width=120,
            height=40
        )
        close_btn.pack(pady=10)

    def destroy_popup(self):
        self.destroy()
        self.parent.mapping_popup = None

    def update_mapping(self, mapping):
        self.mapping_text.configure(state="normal")
        self.mapping_text.delete("1.0", "end")
        self.mapping_text.insert("1.0", mapping)
        self.mapping_text.configure(state="disabled")


class ScrollableMessageBox(ctk.CTkToplevel):
    """å¯æ»šåŠ¨æ¶ˆæ¯æ¡†"""

    def __init__(self, parent, title, message):
        super().__init__(parent)
        self.title(title)
        self.geometry("900x700")
        self.transient(parent)
        self.grab_set()
        self.configure(fg_color=DARK_BG)

        self.text_box = ctk.CTkTextbox(
            self,
            wrap="word",
            font=FONT_LOG,
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            corner_radius=10
        )
        self.text_box.pack(fill="both", expand=True, padx=20, pady=20)
        self.text_box.insert("1.0", message)
        self.text_box.configure(state="disabled")

        close_btn = GlowButton(
            self,
            text=t("close"),
            command=self.destroy,
            width=120,
            height=40
        )
        close_btn.pack(pady=10)


class MismatchCorrectionDialog(ctk.CTkToplevel):
    """Mismatch ä¿®æ­£å’Œæ‰£åˆ†å°è©±æ¡†"""

    def __init__(self, parent, supplier, outlet, cover_status, remark):
        super().__init__(parent)
        self.title("Mismatch ä¿®æ­£å’Œæ‰£åˆ† / Mismatch Correction & Deduction")
        self.geometry("800x700")
        self.transient(parent)
        self.grab_set()
        self.configure(fg_color=DARK_BG)
        self.supplier = supplier
        self.outlet = outlet
        self.cover_status = cover_status
        self.remark = remark

        # å±…ä¸­é¡¯ç¤º
        self.center_window()

        # ä¸»å®¹å™¨
        main_frame = ctk.CTkFrame(self, fg_color="transparent")
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
            main_frame,
            text="ğŸ”§ Mismatch ä¿®æ­£å’Œæ‰£åˆ†\nğŸ”§ Mismatch Correction & Deduction",
            font=("Microsoft JhengHei", 18, "bold"),
            text_color=ACCENT_BLUE
        )
        title_label.pack(pady=(0, 20))

        # éŒ¯èª¤ä¿¡æ¯é¡¯ç¤º
        error_frame = ctk.CTkFrame(
    main_frame,
    fg_color=DARK_PANEL,
     corner_radius=12)
        error_frame.pack(fill="x", pady=(0, 20))

        ctk.CTkLabel(
            error_frame,
            text="éŒ¯èª¤ä¿¡æ¯ / Error Information:",
            font=("Microsoft JhengHei", 14, "bold"),
            text_color=ACCENT_RED
        ).pack(anchor="w", padx=15, pady=(15, 5))

        error_text = f"ä¾›æ‡‰å•†: {supplier}\nåˆ†åº—: {outlet}\nç‹€æ…‹: {cover_status}\néŒ¯èª¤: {remark}"
        ctk.CTkLabel(
            error_frame,
            text=error_text,
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR,
            justify="left"
        ).pack(anchor="w", padx=15, pady=(0, 15))

        # ä¿®æ­£å€åŸŸ
        correction_frame = ctk.CTkFrame(
    main_frame, fg_color=DARK_PANEL, corner_radius=12)
        correction_frame.pack(fill="x", pady=(0, 20))

        ctk.CTkLabel(
            correction_frame,
            text="ä¿®æ­£ä¿¡æ¯ / Correction Information:",
            font=("Microsoft JhengHei", 14, "bold"),
            text_color=ACCENT_GREEN
        ).pack(anchor="w", padx=15, pady=(15, 10))

        # æ­£ç¢ºåº—åè¼¸å…¥
        ctk.CTkLabel(
            correction_frame,
            text="æ­£ç¢ºåº—å / Correct Outlet Name:",
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 2))

        self.correct_outlet_var = ctk.StringVar()
        self.correct_outlet_entry = ctk.CTkEntry(
            correction_frame,
            textvariable=self.correct_outlet_var,
            font=("Microsoft JhengHei", 12),
            height=35,
            placeholder_text="è¼¸å…¥æ­£ç¢ºçš„åº—å..."
        )
        self.correct_outlet_entry.pack(fill="x", padx=15, pady=(0, 10))

        # æ­£ç¢ºåœ°å€è¼¸å…¥
        ctk.CTkLabel(
            correction_frame,
            text="æ­£ç¢ºåœ°å€ / Correct Address:",
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 2))

        self.correct_address_var = ctk.StringVar()
        self.correct_address_entry = ctk.CTkEntry(
            correction_frame,
            textvariable=self.correct_address_var,
            font=("Microsoft JhengHei", 12),
            height=35,
            placeholder_text="è¼¸å…¥æ­£ç¢ºçš„åœ°å€..."
        )
        self.correct_address_entry.pack(fill="x", padx=15, pady=(0, 15))

        # æ‰£åˆ†å€åŸŸ
        deduction_frame = ctk.CTkFrame(
    main_frame, fg_color=DARK_PANEL, corner_radius=12)
        deduction_frame.pack(fill="x", pady=(0, 20))

        ctk.CTkLabel(
            deduction_frame,
            text="æ‰£åˆ†ä¿¡æ¯ / Deduction Information:",
            font=("Microsoft JhengHei", 14, "bold"),
            text_color=ACCENT_PURPLE
        ).pack(anchor="w", padx=15, pady=(15, 10))

        # æ‰£åˆ†äººå“¡è¼¸å…¥
        ctk.CTkLabel(
            deduction_frame,
            text="æ‰£åˆ†äººå“¡ / Deducted By:",
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 2))

        self.deducted_by_var = ctk.StringVar()
        self.deducted_by_entry = ctk.CTkEntry(
            deduction_frame,
            textvariable=self.deducted_by_var,
            font=("Microsoft JhengHei", 12),
            height=35,
            placeholder_text="è¼¸å…¥æ‰£åˆ†äººå“¡å§“å..."
        )
        self.deducted_by_entry.pack(fill="x", padx=15, pady=(0, 10))

        # å‚™è¨»è¼¸å…¥
        ctk.CTkLabel(
            deduction_frame,
            text="å‚™è¨» / Notes:",
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 2))

        self.notes_var = ctk.StringVar(value=supplier)  # é»˜èªå¡«å…¥ä¾›æ‡‰å•†åç¨±
        self.notes_entry = ctk.CTkEntry(
            deduction_frame,
            textvariable=self.notes_var,
            font=("Microsoft JhengHei", 12),
            height=35,
            placeholder_text="è¼¸å…¥å‚™è¨»ï¼ˆé»˜èªç‚ºä¾›æ‡‰å•†åç¨±ï¼‰..."
        )
        self.notes_entry.pack(fill="x", padx=15, pady=(0, 15))

        # æŒ‰éˆ•å€åŸŸ
        btn_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        btn_frame.pack(fill="x", pady=(10, 0))

        # å–æ¶ˆæŒ‰éˆ•
        cancel_btn = ctk.CTkButton(
            btn_frame,
            text="å–æ¶ˆ / Cancel",
            command=self.destroy,
            fg_color="#6b7280",
            hover_color="#4b5563",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=120,
            height=40
        )
        cancel_btn.pack(side="right", padx=(10, 0))

        # ä¿å­˜æ‰£åˆ†è¨˜éŒ„æŒ‰éˆ•
        save_btn = ctk.CTkButton(
            btn_frame,
            text="ä¿å­˜æ‰£åˆ†è¨˜éŒ„\nSave Deduction",
            command=self._save_deduction_record,
            fg_color=ACCENT_RED,
            hover_color="#dc2626",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=150,
            height=40
        )
        save_btn.pack(side="right", padx=(0, 10))

        # ä¿®æ­£ä¸¦ä¿å­˜æŒ‰éˆ•
        correct_btn = ctk.CTkButton(
            btn_frame,
            text="ä¿®æ­£ä¸¦ä¿å­˜\nCorrect & Save",
            command=self._correct_and_save,
            fg_color=ACCENT_GREEN,
            hover_color="#059669",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=150,
            height=40
        )
        correct_btn.pack(side="right", padx=(0, 10))

        # å¼·åˆ¶ç²å¾—ç„¦é»
        self.focus_force()

    def center_window(self):
        """å±…ä¸­é¡¯ç¤ºè¦–çª—"""
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f"{width}x{height}+{x}+{y}")

    def _save_deduction_record(self):
        """ä¿å­˜æ‰£åˆ†è¨˜éŒ„åˆ° Excel"""
        try:
            from datetime import datetime
            import openpyxl
            from openpyxl.styles import Font, Alignment
            import os

            # æª¢æŸ¥å¿…å¡«æ¬„ä½
            deducted_by = self.deducted_by_var.get().strip()
            if not deducted_by:
                messagebox.showwarning("è­¦å‘Š", "è«‹è¼¸å…¥æ‰£åˆ†äººå“¡å§“åï¼")
                return

            # æ‰£åˆ†è¡¨æ–‡ä»¶è·¯å¾‘
            deduction_file = "outlet_deduction_record.xlsx"

            # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°æ–‡ä»¶
            if not os.path.exists(deduction_file):
                wb = openpyxl.Workbook()
                ws = wb.active
                ws.title = "æ‰£åˆ†è¨˜éŒ„"

                # è¨­ç½®æ¨™é¡Œè¡Œ
                headers = ["æ—¥æœŸ", "é¡åˆ¥", "æè¿°", "æ‰£åˆ†é …ç›®", "æ‰£åˆ†", "æ‰£åˆ†äººå“¡", "å‚™è¨»"]
                for col, header in enumerate(headers, 1):
                    cell = ws.cell(row=1, column=col, value=header)
                    cell.font = Font(bold=True)
                    cell.alignment = Alignment(horizontal="center")

                # è¨­ç½®åˆ—å¯¬
                ws.column_dimensions['A'].width = 12  # æ—¥æœŸ
                ws.column_dimensions['B'].width = 15  # é¡åˆ¥
                ws.column_dimensions['C'].width = 50  # æè¿°
                ws.column_dimensions['D'].width = 12  # æ‰£åˆ†é …ç›®
                ws.column_dimensions['E'].width = 8   # æ‰£åˆ†
                ws.column_dimensions['F'].width = 15  # æ‰£åˆ†äººå“¡
                ws.column_dimensions['G'].width = 20  # å‚™è¨»

                wb.save(deduction_file)

            # æ‰“é–‹ç¾æœ‰æ–‡ä»¶
            wb = openpyxl.load_workbook(deduction_file)
            ws = wb.active

            # æ‰¾åˆ°ä¸‹ä¸€å€‹ç©ºè¡Œ
            next_row = ws.max_row + 1

            # å¡«å…¥æ•¸æ“š
            today = datetime.now().strftime("%Y-%m-%d")
            ws.cell(row=next_row, column=1, value=today)  # A: æ—¥æœŸ
            ws.cell(row=next_row, column=2, value="WeeklyOrder")  # B: é¡åˆ¥
            ws.cell(
    row=next_row,
    column=3,
     # C: æè¿°
     value="Order Wrong Data (e.g. Wrong Date, Wrong Outlet Selected, etc.)")
            ws.cell(row=next_row, column=4, value=10)  # D: æ‰£åˆ†é …ç›® (å›ºå®š10åˆ†)
            ws.cell(row=next_row, column=5, value=1)   # E: æ‰£åˆ† (å›ºå®š1åˆ†)
            ws.cell(row=next_row, column=6, value=deducted_by)  # F: æ‰£åˆ†äººå“¡
            ws.cell(
    row=next_row,
    column=7,
     value=self.notes_var.get().strip())  # G: å‚™è¨»

            # ä¿å­˜æ–‡ä»¶
            wb.save(deduction_file)

            messagebox.showinfo("æˆåŠŸ", f"æ‰£åˆ†è¨˜éŒ„å·²ä¿å­˜åˆ° {deduction_file}")

        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"ä¿å­˜æ‰£åˆ†è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

    def _correct_and_save(self):
        """ä¿®æ­£éŒ¯èª¤ä¸¦ä¿å­˜æ‰£åˆ†è¨˜éŒ„"""
        # æª¢æŸ¥ä¿®æ­£ä¿¡æ¯
        correct_outlet = self.correct_outlet_var.get().strip()
        correct_address = self.correct_address_var.get().strip()

        if not correct_outlet and not correct_address:
            messagebox.showwarning("è­¦å‘Š", "è«‹è‡³å°‘å¡«å…¥æ­£ç¢ºçš„åº—åæˆ–åœ°å€ï¼")
            return

        # å…ˆä¿å­˜æ‰£åˆ†è¨˜éŒ„
        self._save_deduction_record()

        # é¡¯ç¤ºä¿®æ­£ä¿¡æ¯ï¼ˆé€™è£¡å¯ä»¥æ“´å±•ç‚ºå¯¦éš›ä¿®æ­£æ–‡ä»¶çš„åŠŸèƒ½ï¼‰
        correction_info = f"ä¿®æ­£ä¿¡æ¯å·²è¨˜éŒ„ï¼š\n"
        if correct_outlet:
            correction_info += f"æ­£ç¢ºåº—å: {correct_outlet}\n"
        if correct_address:
            correction_info += f"æ­£ç¢ºåœ°å€: {correct_address}\n"

        messagebox.showinfo("ä¿®æ­£å®Œæˆ", correction_info + "\næ‰£åˆ†è¨˜éŒ„ä¹Ÿå·²åŒæ™‚ä¿å­˜ã€‚")
        self.destroy()


class EmailConfirmationDialog(ctk.CTkToplevel):
    """é‚®ä»¶å‘é€ç¡®è®¤å¯¹è¯æ¡†ï¼ˆåªé¡¯ç¤ºç´”æ–‡å­—ï¼Œä¿ç•™ç©ºè¡Œï¼‰"""

    def __init__(
        self,
        parent,
        mail_item,
        supplier_name,
        outlet_name,
        attachment_path,
        on_confirm):
        super().__init__(parent)
        self.title(f"ç¡®è®¤é‚®ä»¶ - {supplier_name}")
        self.geometry("800x700")
        self.transient(parent)
        self.grab_set()
        self.mail_item = mail_item
        self.on_confirm = on_confirm
        self.attachment_path = attachment_path
        self.configure(fg_color=DARK_BG)
        info_frame = ctk.CTkFrame(self, fg_color=DARK_PANEL, corner_radius=12)
        info_frame.pack(fill="x", padx=20, pady=10)
        ctk.CTkLabel(info_frame,
    text=f"æ”¶ä»¶äºº(To)/To: {mail_item.To}",
    font=FONT_MID).pack(anchor="w",
    padx=10,
     pady=5)
        ctk.CTkLabel(info_frame,
    text=f"æŠ„é€(CC)/CC: {mail_item.CC}",
    font=FONT_MID).pack(anchor="w",
    padx=10,
     pady=5)
        ctk.CTkLabel(info_frame,
    text=f"ä¸»é¢˜/Subject: {mail_item.Subject}",
    font=FONT_MID).pack(anchor="w",
    padx=10,
     pady=5)
        ctk.CTkLabel(
    info_frame,
    text=f"ä¾›åº”å•†/Supplier: {supplier_name}",
    font=FONT_MID).pack(
        anchor="w",
        padx=10,
         pady=5)
        ctk.CTkLabel(
    info_frame,
    text=f"åˆ†åº—/Outlet: {outlet_name}",
    font=FONT_MID).pack(
        anchor="w",
        padx=10,
         pady=5)
        if attachment_path:
            file_name = os.path.basename(attachment_path)
            ctk.CTkLabel(
    info_frame,
    text=f"é™„ä»¶/Attachment: {file_name}",
    font=FONT_MID).pack(
        anchor="w",
        padx=10,
         pady=5)
        body_frame = ctk.CTkFrame(self, fg_color=DARK_PANEL, corner_radius=12)
        body_frame.pack(fill="both", expand=True, padx=20, pady=10)
        ctk.CTkLabel(
    body_frame,
    text="é‚®ä»¶æ­£æ–‡/Email Body:",
    font=FONT_BIGBTN).pack(
        anchor="w",
        padx=10,
         pady=5)
        # åªé¡¯ç¤ºç´”æ–‡å­—ï¼Œä¿ç•™ç©ºè¡Œï¼Œé¿å…åå­—è¢«æ‹†è¡Œ
        import html
        raw_html = mail_item.HTMLBody or ""
        import re
        # 1. åªæŠŠçµæŸåˆ†è¡Œæ¨™ç±¤æ›æˆæ›è¡Œ
        text = re.sub(
    r'(<br\s*/?>|</div>|</p>|</li>|</tr>|</td>)',
    '\n',
    raw_html,
     flags=re.IGNORECASE)
        # 2. æŠŠé–‹å§‹æ¨™ç±¤ç›´æ¥ç§»é™¤ï¼ˆä¸æ›è¡Œï¼‰
        text = re.sub(r'(<div>|<p>|<li>|<tr>|<td>)',
                      '', text, flags=re.IGNORECASE)
        # 3. ç§»é™¤å…¶ä»– HTML æ¨™ç±¤
        text = re.sub(r'<[^>]+>', '', text)
        # 4. decode HTML entity
        text = html.unescape(text)
        # 5. ç§»é™¤é–‹é ­/çµå°¾å¤šé¤˜ç©ºç™½
        text = text.strip()
        self.body_text = ctk.CTkTextbox(
    body_frame, wrap="word", height=300, font=FONT_MID)
        self.body_text.pack(fill="both", expand=True, padx=10, pady=5)
        self.body_text.insert("1.0", text)
        self.body_text.configure(state="disabled")
        btn_frame = ctk.CTkFrame(self, fg_color="transparent")
        btn_frame.pack(fill="x", padx=20, pady=10)
        ctk.CTkButton(
            btn_frame,
            text="å‘é€é‚®ä»¶/Send Email",
            command=self._send_email,
            fg_color=ACCENT_GREEN,
            hover_color=BTN_HOVER
        ).pack(side="right", padx=10)
        ctk.CTkButton(
            btn_frame,
            text="å–æ¶ˆ/Cancel",
            command=self.destroy
        ).pack(side="right", padx=10)
        ctk.CTkButton(
            btn_frame,
            text="ç¼–è¾‘æ­£æ–‡/Edit Body",
            command=self._edit_body,
            fg_color=ACCENT_BLUE,
            hover_color=BTN_HOVER
        ).pack(side="left", padx=10)

    def _edit_body(self):
        self.body_text.configure(state="normal")

    def _send_email(self):
        try:
            # 1. è¯»å–æ–‡æœ¬æ¡†å†…å®¹
            body = self.body_text.get("1.0", "end-1c")

            # 2. è®¡ç®—"æœˆ+å‘¨"è‹±æ–‡å­—ç¬¦ä¸²
            today = datetime.now()
            # è·å–å®Œæ•´è‹±æ–‡æœˆä»½åç§°ï¼Œå¦‚ "July"
            month_name = today.strftime("%B")
            # ä½¿ç”¨æ­£ç¢ºçš„é€±æ•¸è¨ˆç®—æ–¹æ³•
            week_of_month = get_week_of_month(today)
            # æ„é€  "July Week 3"
            month_week_str = f"{month_name} Week {week_of_month}"

            # 3. åœ¨æ¨¡æ¿ä¸­æ›¿æ¢å ä½ç¬¦
            body = body.replace("{week_no}", month_week_str)

            # 4. è½¬æˆ HTML å¹¶å‘é€
            html_body = body.replace("\n", "<br>")
            self.mail_item.HTMLBody = html_body
            self.mail_item.Send()
            self.on_confirm(True, "é‚®ä»¶å‘é€æˆåŠŸï¼")
        except Exception as e:
            self.on_confirm(False, f"å‘é€å¤±è´¥ï¼š{e}")
        finally:
            self.destroy()


class EmailSendConfirmationDialog(ctk.CTkToplevel):
    """ç¾åŒ–çš„é‚®ä»¶å‘é€ç¡®è®¤å¯¹è¯æ¡†"""
    
    def __init__(self, parent, suppliers_list, on_confirm):
        super().__init__(parent)
        self.parent = parent
        self.suppliers_list = suppliers_list
        self.on_confirm = on_confirm
        self.result = False
        
        # è®¾ç½®çª—å£å±æ€§
        self.title("ç¢ºèªç™¼é€\nConfirm Send")
        self.geometry("800x700")
        self.configure(fg_color=DARK_BG)
        
        # è®¾ç½®ç½®é¡¶
        self.attributes('-topmost', True)
        self.transient(parent)
        self.grab_set()
        
        # å±…ä¸­æ˜¾ç¤º
        self._center_window()
        
        # åˆ›å»ºUI
        self._create_ui()
        
        # ç»‘å®šå…³é—­äº‹ä»¶
        self.protocol("WM_DELETE_WINDOW", self._on_cancel)
    
    def _center_window(self):
        """å°†çª—å£å±…ä¸­æ˜¾ç¤º"""
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f"{width}x{height}+{x}+{y}")
    
    def _create_ui(self):
        """åˆ›å»ºç”¨æˆ·ç•Œé¢"""
        # ä¸»å®¹å™¨
        main_frame = ctk.CTkFrame(self, fg_color=DARK_PANEL, corner_radius=15)
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        # æ ‡é¢˜åŒºåŸŸ
        title_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        title_frame.pack(fill="x", padx=20, pady=(20, 10))
        
        # å›¾æ ‡å’Œæ ‡é¢˜
        icon_frame = ctk.CTkFrame(title_frame, fg_color="transparent")
        icon_frame.pack()
        
        # é—®å·å›¾æ ‡ï¼ˆä½¿ç”¨è“è‰²åœ†å½¢èƒŒæ™¯ï¼‰
        icon_label = ctk.CTkLabel(
            icon_frame,
            text="?",
            font=("Microsoft JhengHei", 48, "bold"),
            text_color="white",
            width=80,
            height=80,
            fg_color=ACCENT_BLUE,
            corner_radius=40
        )
        icon_label.pack(pady=(0, 15))
        
        # æ ‡é¢˜æ–‡å­—
        title_text = f"ç¢ºèªè¦ç™¼é€éƒµä»¶çµ¦ä»¥ä¸‹ {len(self.suppliers_list)} å€‹ä¾›æ‡‰å•†å—ï¼Ÿ\nConfirm sending email to the following {len(self.suppliers_list)} suppliers?"
        title_label = ctk.CTkLabel(
            title_frame,
            text=title_text,
            font=("Microsoft JhengHei", 16, "bold"),
            text_color=TEXT_COLOR,
            wraplength=400,
            justify="center"
        )
        title_label.pack(pady=(0, 20))
        
        # ä¾›åº”å•†åˆ—è¡¨åŒºåŸŸ
        list_frame = ctk.CTkFrame(main_frame, fg_color=ENTRY_BG, corner_radius=10)
        list_frame.pack(fill="both", expand=True, padx=20, pady=(0, 20))
        
        # ä¾›åº”å•†åˆ—è¡¨æ ‡é¢˜
        list_title = ctk.CTkLabel(
            list_frame,
            text="ä¾›æ‡‰å•†åˆ—è¡¨\nSupplier List",
            font=("Microsoft JhengHei", 14, "bold"),
            text_color=TEXT_COLOR
        )
        list_title.pack(pady=(15, 10))
        
        # ä¾›åº”å•†åˆ—è¡¨
        suppliers_text = "\n".join([f"â€¢ {supplier}" for supplier in self.suppliers_list])
        suppliers_label = ctk.CTkLabel(
            list_frame,
            text=suppliers_text,
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR,
            justify="left",
            anchor="w"
        )
        suppliers_label.pack(pady=(0, 15), padx=20, fill="x")
        
        # æŒ‰é’®åŒºåŸŸ
        button_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        button_frame.pack(fill="x", padx=20, pady=(0, 20))
        
        # æŒ‰é’®å®¹å™¨
        btn_container = ctk.CTkFrame(button_frame, fg_color="transparent")
        btn_container.pack(expand=True)
        
        # å–æ¶ˆæŒ‰é’®
        cancel_btn = ctk.CTkButton(
            btn_container,
            text="å–æ¶ˆ\nCancel",
            command=self._on_cancel,
            fg_color=ACCENT_RED,
            hover_color="#dc2626",
            font=("Microsoft JhengHei", 14, "bold"),
            width=120,
            height=40,
            corner_radius=20
        )
        cancel_btn.pack(side="left", padx=(0, 15))
        
        # ç¡®è®¤æŒ‰é’®
        confirm_btn = ctk.CTkButton(
            btn_container,
            text="ç¢ºèª\nConfirm",
            command=self._on_confirm,
            fg_color=ACCENT_GREEN,
            hover_color="#059669",
            font=("Microsoft JhengHei", 14, "bold"),
            width=120,
            height=40,
            corner_radius=20
        )
        confirm_btn.pack(side="right", padx=(15, 0))
        
        # ç§»é™¤ focus_set() é¿å… TclError
    
    def _on_confirm(self):
        """ç¡®è®¤å‘é€"""
        self.result = True
        self.on_confirm(True)
        self.destroy()
    
    def _on_cancel(self):
        """å–æ¶ˆå‘é€"""
        self.result = False
        self.on_confirm(False)
        self.destroy()


class NavigationButton(ctk.CTkButton):
    """è‡ªå®šä¹‰å¯¼èˆªæŒ‰é’®ï¼Œæ”¯æŒé€‰ä¸­çŠ¶æ€"""

    def __init__(self, master, text, command, **kwargs):
        super().__init__(master, text=text, command=command, **kwargs)

        # ä¿å­˜è‡ªå®šä¹‰é¢œè‰²
        self.custom_fg_color = kwargs.get('fg_color', DARK_PANEL)
        self.custom_text_color = kwargs.get(
    'text_color', get_contrast_color(
        self.custom_fg_color))
        self.custom_border_color = kwargs.get(
            'border_color', self.custom_fg_color)
        self.custom_border_width = kwargs.get('border_width', 0)
        self.custom_height = kwargs.get('height', 50)

        # è®¾ç½®é»˜è®¤é¢œè‰²
        self.default_color = self.custom_fg_color
        self.selected_color = ACCENT_BLUE
        self.is_selected = False

        # é…ç½®æŒ‰é’® - ç§»é™¤hover_colorï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‚¬åœæ•ˆæœ
        self.configure(
            fg_color=self.custom_fg_color,
            text_color=self.custom_text_color,
            border_width=self.custom_border_width,
            border_color=self.custom_border_color,
            corner_radius=10,
            font=FONT_BIGBTN,
            height=self.custom_height,
            anchor="center"
        )
        self._bind_events()

    def _bind_events(self):
        self.bind("<Enter>", self._on_enter)
        self.bind("<Leave>", self._on_leave)

    def _on_enter(self, event=None):
        if not self.is_selected:
            # æ‚¬åœæ—¶èƒŒæ™¯è‰²å˜æˆè¾¹æ¡†é¢œè‰²
            hover_color = self.custom_border_color
            self.configure(fg_color=hover_color)

    def _on_leave(self, event=None):
        if not self.is_selected:
            # æ¢å¤åŸæ¥çš„èƒŒæ™¯è‰²
            self.configure(fg_color=self.custom_fg_color)

    def select(self):
        self.is_selected = True
        self.configure(
            fg_color=self.selected_color,
            border_width=2,
            border_color=ACCENT_GREEN,
            text_color="white"
        )

    def deselect(self):
        self.is_selected = False
        # æ¢å¤è‡ªå®šä¹‰é¢œè‰²
        self.configure(
            fg_color=self.custom_fg_color,
            border_width=self.custom_border_width,
            border_color=self.custom_border_color,
            text_color=self.custom_text_color
        )

    @staticmethod
    def _adjust_color(color, amount):
        if isinstance(color, str) and color.startswith("#"):
            color = color.lstrip('#')
            rgb = tuple(int(color[i:i + 2], 16) for i in (0, 2, 4))
            adjusted = tuple(min(255, max(0, x + amount)) for x in rgb)
            return f"#{adjusted[0]:02x}{adjusted[1]:02x}{adjusted[2]:02x}"
        return color

# ========== é€è´§æ—¥æœŸéªŒè¯å·¥å…· ==========


class DeliveryDateValidator:
    """é€è´§æ—¥æœŸéªŒè¯å·¥å…·"""

    DAYS_MAPPING = {
        'mon': 0, 'monday': 0, 'æ˜ŸæœŸä¸€': 0,
        'tue': 1, 'tuesday': 1, 'æ˜ŸæœŸäºŒ': 1,
        'wed': 2, 'wednesday': 2, 'æ˜ŸæœŸä¸‰': 2,
        'thu': 3, 'thursday': 3, 'æ˜ŸæœŸå››': 3,
        'fri': 4, 'friday': 4, 'æ˜ŸæœŸäº”': 4,
        'sat': 5, 'saturday': 5, 'æ˜ŸæœŸå…­': 5,
        'sun': 6, 'sunday': 6, 'æ˜ŸæœŸæ—¥': 6
    }

    def __init__(self, config_file=None):
        self.schedule = defaultdict(dict)
        if config_file:
            self.load_config(config_file)

    def load_config(self, config_file):
        """åŠ è½½é€è´§æ—¥æœŸé…ç½®"""
        try:
            with open(config_file, mode='r', encoding='utf-8-sig') as f:
                reader = csv.DictReader(f)
                for row in reader:
                    supplier = row['supplier'].strip().upper()
                    outlet = row['outlet_code'].strip().upper()
                    days = self.parse_delivery_days(row['delivery_days'])

                    if outlet == "ALL":
                        self.schedule[supplier]['*'] = days
                    else:
                        self.schedule[supplier][outlet] = days
        except Exception as e:
            raise Exception(f"åŠ è½½é€è´§é…ç½®å¤±è´¥: {str(e)}")

    def parse_delivery_days(self, days_str):
        """è§£æé€è´§æ—¥æœŸå­—ç¬¦ä¸²"""
        days = set()
        for day in days_str.split(','):
            day = day.strip().lower()
            if day in self.DAYS_MAPPING:
                days.add(self.DAYS_MAPPING[day])
        return days

    def get_delivery_days(self, supplier, outlet_code):
        supplier = supplier.strip().upper()
        outlet_code = outlet_code.strip().upper()
        outlet_specific = self.schedule.get(supplier, {}).get(outlet_code)
        if outlet_specific is not None:
            return outlet_specific
        return self.schedule.get(supplier, {}).get('*', set())

    def validate_order(
    self,
    supplier,
    outlet_code,
    order_date,
     log_callback=None):
        supplier = supplier.strip().upper()
        outlet_code = outlet_code.strip().upper()
        delivery_days = self.get_delivery_days(supplier, outlet_code)

        if not delivery_days:
            return True

        try:
            if isinstance(order_date, (int, float)):
                order_date = datetime(1899, 12, 30) + \
                                      timedelta(days=order_date)
            else:
                order_date = parse(str(order_date), fuzzy=True)

            order_weekday = order_date.weekday()

            if order_weekday not in delivery_days:
                day_name = ['Monday', 'Tuesday', 'Wednesday', 'Thursday',
                           'Friday', 'Saturday', 'Sunday'][order_weekday]
                if log_callback:
                    log_callback(
                        f"âŒ é€è´§æ—¥æœŸé”™è¯¯: {outlet_code} å‘ {supplier} ä¸‹å•\n"
                        f"  è®¢å•æ—¥æœŸ: {
    order_date.strftime('%Y-%m-%d')} ({day_name})\n"
                        f"  å…è®¸é€è´§æ—¥: {self.format_days(delivery_days)}"
                    )
                return False
            return True
        except Exception as e:
            if log_callback:
                log_callback(
                    f"âš ï¸ æ—¥æœŸè§£æå¤±è´¥: {supplier}-{outlet_code} ({order_date}): {str(e)}")
            return False

    def format_days(self, day_numbers):
        """å°†æ•°å­—è½¬æ¢ä¸ºæ˜ŸæœŸåç§°"""
        days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday',
               'Friday', 'Saturday', 'Sunday']
        return ", ".join(days[d] for d in sorted(day_numbers))

# ========== ç»Ÿä¸€é…ç½®ç®¡ç†å™¨ ==========


class UnifiedConfigManager:
    """ç®¡ç†ç»Ÿä¸€çš„Excelé…ç½®æ–‡ä»¶"""

    def __init__(self, config_path=None):
        self.config_path = config_path
        self.outlets = []
        self.suppliers = []
        self.delivery_schedule = []
        self.email_templates = {}
        self.supplier_requirements = {}

        if config_path:
            self.load_config(config_path)

    def load_config(self, config_path):
        """ä»Excelæ–‡ä»¶åŠ è½½é…ç½®"""
        try:
            wb = load_workbook(config_path, data_only=True)

            # è¯»å–åˆ†åº—ä¿¡æ¯ - æ”¯æŒå¤šç¨®å·¥ä½œè¡¨åç¨±
            outlet_sheet = None
            for sheet_name in [
    "OUTLET",
    "Outlets",
    "Outlet",
    "outlets",
     "outlet"]:
                if sheet_name in wb.sheetnames:
                    outlet_sheet = wb[sheet_name]
                    print(f"[DEBUG] æ‰¾åˆ°é–€å¸‚å·¥ä½œè¡¨: {sheet_name}")
                    break

            if outlet_sheet:
                for row in outlet_sheet.iter_rows(min_row=2, values_only=True):
                    if row and row[0]:
                        outlet_data = {
                            "code": row[0].strip().upper() if isinstance(row[0], str) else str(row[0]).strip().upper(),
                            "name": row[1].strip() if len(row) > 1 and isinstance(row[1], str) else str(row[1]).strip() if len(row) > 1 and row[1] is not None else "",
                            "email": row[2].strip().lower() if len(row) > 2 and isinstance(row[2], str) else str(row[2]).strip().lower() if len(row) > 2 and row[2] is not None else "",
                            "address": row[3].strip() if len(row) > 3 and isinstance(row[3], str) else str(row[3]).strip() if len(row) > 3 and row[3] is not None else "",
                            "delivery_day": row[4].strip() if len(row) > 4 and isinstance(row[4], str) else str(row[4]).strip() if len(row) > 4 and row[4] is not None else "",
                            "brand": row[5].strip() if len(row) > 5 and isinstance(row[5], str) else str(row[5]).strip() if len(row) > 5 and row[5] is not None else "Dine-In"
                        }
                        self.outlets.append(outlet_data)

            # è¯»å–ä¾›åº”å•†ä¿¡æ¯
            if "Suppliers" in wb.sheetnames:
                ws = wb["Suppliers"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and row[0]:
                        self.suppliers.append({
                            "name": row[0].strip() if isinstance(row[0], str) else str(row[0]).strip(),
                            "email": row[1].strip().lower() if len(row) > 1 and isinstance(row[1], str) else str(row[1]).strip().lower() if len(row) > 1 and row[1] is not None else "",
                            "contact": row[2].strip() if len(row) > 2 and isinstance(row[2], str) else str(row[2]).strip() if len(row) > 2 and row[2] is not None else "",
                            "phone": row[3].strip() if len(row) > 3 and isinstance(row[3], str) else str(row[3]).strip() if len(row) > 3 and row[3] is not None else ""
                        })

            # è¯»å–é…é€æ—¥ç¨‹
            if "Delivery Schedule" in wb.sheetnames:
                ws = wb["Delivery Schedule"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and row[0]:
                        self.delivery_schedule.append({
                            "supplier": row[0].strip() if isinstance(row[0], str) else str(row[0]).strip(),
                            "outlet_code": row[1].strip().upper() if len(row) > 1 and isinstance(row[1], str) else str(row[1]).strip().upper() if len(row) > 1 and row[1] is not None else "ALL",
                            "delivery_days": row[2].strip() if len(row) > 2 and isinstance(row[2], str) else str(row[2]).strip() if len(row) > 2 and row[2] is not None else ""
                        })

            # è¯»å–é‚®ä»¶æ¨¡æ¿
            if "Email Templates" in wb.sheetnames:
                ws = wb["Email Templates"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and len(row) > 0 and row[0]:
                        self.email_templates[row[0].strip() if isinstance(row[0], str) else str(row[0]).strip()] = {
                            "subject": row[1].strip() if len(row) > 1 and isinstance(row[1], str) else str(row[1]).strip() if len(row) > 1 and row[1] is not None else "",
                            "body": row[2].strip() if len(row) > 2 and isinstance(row[2], str) else str(row[2]).strip() if len(row) > 2 and row[2] is not None else ""
                        }

            # è¯»å–ä¾›åº”å•†è¦æ±‚
            if "Supplier Requirements" in wb.sheetnames:
                ws = wb["Supplier Requirements"]
                for row in ws.iter_rows(min_row=2, values_only=True):
                    if row and row[0]:
                        supplier_name = row[0].strip() if isinstance(
                            row[0], str) else str(row[0]).strip()
                        # ä¿®æ­£ï¼šæ­£ç¢ºåˆ†å‰²ã€å»ç©ºæ ¼ã€è½‰å¤§å¯«
                        outlet_codes = []
                        if len(row) > 1 and row[1] is not None:
                            for code in str(
    row[1]).replace(
        "\n", ",").replace(
            "ï¼Œ", ",").split(","):
                                code = code.strip().upper()
                                if code:
                                    outlet_codes.append(code)
                        self.supplier_requirements[supplier_name] = outlet_codes

            return True, f"æˆåŠŸåŠ è½½é…ç½®æ–‡ä»¶: {len(self.outlets)} åˆ†åº—, {len(self.suppliers)} ä¾›åº”å•†"
        except Exception as e:
            return False, f"åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥: {str(e)}"

    def get_outlet(self, code):
        # æ ¹æ“šåˆ†åº—ä»£ç¢¼ç²å–åˆ†åº—å…¨å
        if not code:
            return None
        if isinstance(code, str):
            code = code.strip().upper()
        else:
            code = str(code).upper()
        for outlet in self.outlets:
            if outlet['short_name'].upper() == code:
                return outlet['full_name']
        return None

    def get_supplier(self, name):
        # æ ¹æ“šä¾›æ‡‰å•†åç¨±ç²å–æ¨™æº–åç¨±
        if not name:
            return None
        if isinstance(name, str):
            name = name.strip().upper()
        else:
            name = str(name).upper()
        for supplier in self.suppliers:
            if supplier['name'].upper() == name:
                return supplier['name']
        return None

    def get_delivery_schedule(self, supplier, outlet_code):
        """è·å–ç‰¹å®šä¾›åº”å•†-åˆ†åº—çš„é…é€æ—¥ç¨‹"""
        for schedule in self.delivery_schedule:
            if schedule["supplier"] == supplier and schedule["outlet_code"] == outlet_code:
                return schedule["delivery_days"]

        for schedule in self.delivery_schedule:
            if schedule["supplier"] == supplier and schedule["outlet_code"] == "ALL":
                return schedule["delivery_days"]

        return None

    def get_required_outlets(self, supplier_name):
        # ç”¨ normalize æ–¹å¼æ‰¾ keyï¼Œç¡®ä¿åŒ¹é…
        key = str(supplier_name).strip().upper()
        for k in self.supplier_requirements:
            if str(k).strip().upper() == key:
                return self.supplier_requirements[k]
        return []

# ========== é‚®ä»¶å‘é€ç®¡ç†å™¨ ==========


class EmailSender:
    """å¤„ç†é‚®ä»¶å‘é€åŠŸèƒ½"""

    def __init__(self, config_manager=None):
        self.config_manager = config_manager
        # åŠ è½½ GIF å›¾ç‰‡èµ„æº
        self.email_gif = self._load_email_gif()

    def _load_email_gif(self):
        """åŠ è½½é‚®ä»¶ç­¾å GIF å›¾ç‰‡"""
        try:
            gif_path = resource_path("email_gif.gif")
            if os.path.exists(gif_path):
                with open(gif_path, "rb") as f:
                    return f.read()
            return None
        except Exception as e:
            print(f"Error loading email GIF: {str(e)}")
            return None

    def _get_standard_subject(self, supplier_name):
        """ç”Ÿæˆæ ‡å‡†é‚®ä»¶ä¸»é¢˜"""
        now = datetime.now()
        month_name = now.strftime("%B")
        week_in_month = get_week_of_month(now)
        return f"Sushi Express Weekly Order - {supplier_name} - {month_name} - Week {week_in_month}"

    def get_to_cc_emails(self, supplier_name, config_path):
        """æ ¹æ“š config excel å–å¾— TO/CC éƒµä»¶ï¼Œä¸¦è‡ªå‹•åŠ  opsadmin åŠ purchasing.adminï¼Œä¸”CCä¸é‡è¤‡"""
        wb = load_workbook(config_path, data_only=True)
        to_emails = []
        cc_emails = []
        if "Suppliers" in wb.sheetnames:
            ws = wb["Suppliers"]
            for row in ws.iter_rows(min_row=2, values_only=True):
                if not row or not row[0]:
                    continue
                if str(row[0]).strip() == supplier_name:
                    typ = str(row[1]).strip().upper() if len(
                        row) > 1 and row[1] else "TO"
                    email = str(row[2]).strip() if len(
                        row) > 2 and row[2] else ""
                    if not email:
                        continue
                    if typ == "TO":
                        to_emails.append(email)
                    elif typ == "CC":
                        cc_emails.append(email)
        # å¿…é ˆCCçš„åå–®
        must_cc = [
            "opsadmin@sushiexpress.com.sg",
            "purchasing.admin@sushiexpress.com.sg"
        ]
        for cc in must_cc:
            if cc not in cc_emails:
                cc_emails.append(cc)
        # å»é‡ï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰
        seen = set()
        cc_unique = []
        for e in cc_emails:
            elower = e.lower()
            if elower not in seen:
                cc_unique.append(e)
                seen.add(elower)
        return to_emails, cc_unique

    def send_email(
    self,
    to_emails,
    cc_emails,
    supplier_name,
    body,
    attachment_path=None,
    account_idx=None,
    use_content_id=True,
     subject=None):
        import time
        import pywintypes
        max_retries = 3
        for attempt in range(max_retries):
            try:
                import win32com.client
                import pythoncom
                import os
                import base64

                # åˆå§‹åŒ– COM çµ„ä»¶
                pythoncom.CoInitialize()

                outlook = win32com.client.Dispatch("Outlook.Application")
                # --- æ–°å¢ CreateItem è‡ªå‹•é‡è©¦ ---
                for create_attempt in range(3):
                    try:
                        mail = outlook.CreateItem(0)
                        break
                    except AttributeError as e:
                        if "CreateItem" in str(e):
                            print(
    f"[RETRY] Outlook COM é‚„æ²’æº–å‚™å¥½ï¼Œç¬¬ {
        create_attempt + 1} æ¬¡é‡è©¦...")
                            time.sleep(2)
                            outlook = win32com.client.Dispatch(
                                "Outlook.Application")
                            continue
                        else:
                            raise
                else:
                    from tkinter import messagebox
                    messagebox.showerror(
    "é‚®ä»¶å‘é€å¤±è´¥", "Outlook å•Ÿå‹•ç•°å¸¸ï¼Œè«‹ç¢ºèª Outlook å·²é–‹å•Ÿä¸”ç„¡å½ˆçª—ã€‚")
                    return None, "Outlook å•Ÿå‹•ç•°å¸¸ï¼Œè«‹ç¢ºèª Outlook å·²é–‹å•Ÿä¸”ç„¡å½ˆçª—ã€‚"
                # --- å…¶é¤˜åŸæœ¬çš„ send_email æµç¨‹ ---
                if account_idx is not None:
                    mapi = outlook.GetNamespace("MAPI")
                    accounts = [
    mapi.Folders.Item(
        i +
        1) for i in range(
            mapi.Folders.Count)]
                    if 0 <= account_idx < len(accounts):
                        account = accounts[account_idx]
                        if hasattr(mail, 'SendUsingAccount'):
                            for acc in outlook.Session.Accounts:
                                if acc.DisplayName == account.Name:
                                    mail.SendUsingAccount = acc
                                    break
                # è™•ç†æ”¶ä»¶äºº
                if isinstance(to_emails, list):
                    to_emails_fixed = ';'.join(to_emails) if to_emails else ''
                else:
                    to_emails_fixed = to_emails.replace(
    'ï¼Œ', ';').replace(
        ',', ';') if to_emails else ''
                if isinstance(cc_emails, list):
                    cc_emails_fixed = ';'.join(cc_emails) if cc_emails else ''
                else:
                    cc_emails_fixed = cc_emails.replace(
    'ï¼Œ', ';').replace(
        ',', ';') if cc_emails else ''
                mail.To = to_emails_fixed
                mail.CC = cc_emails_fixed
                if subject:
                    mail.Subject = subject
                else:
                    mail.Subject = self._get_standard_subject(supplier_name)
                # æ·»åŠ  GIF ç°½å
                possible_gif_paths = [
                    "email_gif.gif",
                    os.path.join(os.path.dirname(__file__), "email_gif.gif"),
                    os.path.join(os.getcwd(), "email_gif.gif"),
                    os.path.abspath("email_gif.gif")
                ]
                signature_gif_path = None
                for path in possible_gif_paths:
                    if os.path.exists(path):
                        signature_gif_path = path
                        break
                print(f"[DEBUG] æª¢æŸ¥ GIF æ–‡ä»¶è·¯å¾‘: {possible_gif_paths}")
                print(f"[DEBUG] æ‰¾åˆ°çš„ GIF æ–‡ä»¶: {signature_gif_path}")
                print(f"[DEBUG] ç•¶å‰å·¥ä½œç›®éŒ„: {os.getcwd()}")
                print(f"[DEBUG] è…³æœ¬ç›®éŒ„: {os.path.dirname(__file__)}")
                html_body = body
                if not any(
    tag in body.lower() for tag in [
        '<br',
        '<p',
        '<div',
        '<table',
        '<ul',
        '<ol',
        '<li',
        '<b',
        '<strong',
        '<em',
         '<span']):
                    html_body = body.replace('\n', '<br>')
                if signature_gif_path and os.path.exists(signature_gif_path):
                    if use_content_id:
                        # Content-ID æ–¹å¼ï¼ˆæ–°ç‰ˆ Outlook å…¼å®¹ï¼‰
                        cid = "sigimg001"
                        signature_html = f"""
                        <br><br>
                        <img src=\"cid:{cid}\" alt=\"Signature\" style=\"max-width: 400px;\">
                        """
                        html_body += signature_html
                        mail.HTMLBody = html_body
                        att = mail.Attachments.Add(
    os.path.abspath(signature_gif_path))
                        att.PropertyAccessor.SetProperty(
    "http://schemas.microsoft.com/mapi/proptag/0x3712001F", cid)
                        print(f"[DEBUG] å·²ç”¨ Content-ID æ’å…¥ GIF ç°½å")
                    else:
                        # base64 æ–¹å¼ï¼ˆèˆŠç‰ˆ Outlook å…¼å®¹ï¼‰
                        with open(signature_gif_path, 'rb') as f:
                            gif_data = base64.b64encode(f.read()).decode()
                        signature_html = f"""
                        <br><br>
                        <img src=\"data:image/gif;base64,{gif_data}\" alt=\"Signature\" style=\"max-width: 400px;\">
                        """
                        html_body += signature_html
                        mail.HTMLBody = html_body
                        print(f"[DEBUG] å·²ç”¨ base64 æ’å…¥ GIF ç°½å")
                else:
                    mail.HTMLBody = html_body
                # æ·»åŠ è®¢å•é™„ä»¶
                if attachment_path:
                    if isinstance(attachment_path, list):
                        # å¤šæ–‡ä»¶é™„ä»¶çš„æƒ…å†µ
                        for file_path in attachment_path:
                            if os.path.exists(file_path):
                                mail.Attachments.Add(file_path)
                                print(f"[DEBUG] å·²æ·»åŠ é™„ä»¶: {os.path.basename(file_path)}")
                            else:
                                print(f"[WARNING] é™„ä»¶æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
                    else:
                        # å•æ–‡ä»¶é™„ä»¶çš„æƒ…å†µ
                        if os.path.exists(attachment_path):
                            mail.Attachments.Add(attachment_path)
                            print(f"[DEBUG] å·²æ·»åŠ é™„ä»¶: {os.path.basename(attachment_path)}")
                        else:
                            print(f"[WARNING] é™„ä»¶æ–‡ä»¶ä¸å­˜åœ¨: {attachment_path}")
                return mail
            except pywintypes.com_error as e:
                if hasattr(
    e, 'args') and len(
        e.args) > 0 and e.args[0] == -2147418111:
                    print(f"[RETRY] Outlook å¿™ç¢Œä¸­ï¼Œç¬¬ {attempt + 1} æ¬¡é‡è©¦...")
                    time.sleep(2)
                    continue
                else:
                    import traceback
                    print(traceback.format_exc())
                    from tkinter import messagebox
                    messagebox.showerror(
    "é‚®ä»¶å‘é€å¤±è´¥", f"{
        str(e)}\n\n{
            traceback.format_exc()}")
                    return None, f"åˆ›å»ºé‚®ä»¶å¤±è´¥: {str(e)}"
            except Exception as e:
                import traceback
                print(traceback.format_exc())
                from tkinter import messagebox
                messagebox.showerror(
    "é‚®ä»¶å‘é€å¤±è´¥", f"{
        str(e)}\n\n{
            traceback.format_exc()}")
                return None, f"åˆ›å»ºé‚®ä»¶å¤±è´¥: {str(e)}"
        # å¦‚æœé‡è©¦å¾Œé‚„æ˜¯å¤±æ•—
        from tkinter import messagebox
        messagebox.showerror("é‚®ä»¶å‘é€å¤±è´¥", "Outlook å¿™ç¢Œï¼Œé‡è¯•å¤šæ¬¡ä»å¤±è´¥ã€‚è¯·ç¨åå†è¯•ã€‚")
        return None, "Outlook å¿™ç¢Œï¼Œé‡è¯•å¤šæ¬¡ä»å¤±è´¥ã€‚è¯·ç¨åå†è¯•ã€‚"

# ========== è®¢å•è‡ªåŠ¨åŒ–æ ¸å¿ƒ ==========


class OrderAutomation:
    """è®¢å•è‡ªåŠ¨åŒ–å·¥å…·"""

    def __init__(self, outlet_config=None):
        # outlet_config: list of dicts with keys 'short_name', 'full_name'
        self.outlet_name_map = {}
        if outlet_config:
            for o in outlet_config:
                full = o.get('full_name', '').strip().lower()
                short = o.get('short_name', '').strip().upper()
                if full:
                    self.outlet_name_map[full] = short
                if short:
                    self.outlet_name_map[short.lower()] = short

    def get_short_code(self, f5val):
        val = (str(f5val) or '').strip().lower()
        if val in self.outlet_name_map:
            return self.outlet_name_map[val]
        # é›™å‘æ¨¡ç³Šæ¯”å°
        for full, short in self.outlet_name_map.items():
            if full in val or val in full:
                return short
            # å–®å­—æ¯”å°
            for word in val.split():
                if word and word in full:
                    return short
        return 'UNKNOWN'

    @staticmethod
    def is_valid_date(cell_value, next_week_start, next_week_end):
        """æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ—¥æœŸ"""
        try:
            if isinstance(cell_value, (int, float)):
                base_date = datetime(1899, 12, 30)
                parsed = base_date + timedelta(days=cell_value)
            else:
                parsed = parse(str(cell_value), fuzzy=True, dayfirst=False)
            # å°æ–¼ Amendment æª”æ¡ˆï¼Œæˆ‘å€‘æ¥å—ä»»ä½•æ—¥æœŸï¼Œä¸é™åˆ¶åœ¨ç‰¹å®šé€±æœŸå…§
            return True  # æš«æ™‚æ¥å—æ‰€æœ‰æ—¥æœŸ
        except:
            return False

    @classmethod
    def find_delivery_date_row(
    cls,
    ws,
    next_week_start,
    next_week_end,
    max_rows=200,
     file_path=None):
        """æŸ¥æ‰¾é€è´§æ—¥æœŸè¡Œ"""
        valid_col_range = range(5, 12)
        invalid_labels = [
    "total",
    "total:",
    "sub-total",
    "sub-total:",
    "no. of cartons",
     "no. of cartons:"]
        found_blocks = []
        for i, row in enumerate(ws.iter_rows(min_row=1, max_row=max_rows)):
            cols = []
            for j, cell in enumerate(row):
                if j not in valid_col_range:
                    continue
                val = cell.value
                if cls.is_valid_date(val, next_week_start, next_week_end):
                    cols.append(j)
            if cols:
                found_blocks.append((i + 1, cols))
        for header_row, cols in found_blocks:
            for row_idx in range(header_row + 1, header_row + 200):
                label_val = ws.cell(row=row_idx, column=5).value
                label = str(label_val).lower().strip() if label_val else ""
                if any(invalid in label for invalid in invalid_labels):
                    continue
                for col_idx in cols:
                    qty_val = ws.cell(row=row_idx, column=col_idx + 1).value
                    if isinstance(qty_val, (int, float)) and qty_val > 0:
                        return header_row, cols
        return None, []

    @classmethod
    def run_automation(cls, source_folder, supplier_folder,
                      outlet_config=None, delivery_config=None,
                      log_callback=None, mapping_callback=None):
        """è¿è¡Œè®¢å•è‡ªåŠ¨åŒ–ï¼ˆä»…ç”Ÿæˆ supplier æ–‡ä»¶ï¼‰"""
        import os  # ç¡®ä¿ os æ¨¡å—å¯ç”¨
        now = datetime.now()
        today = now.date()
        this_monday = today - timedelta(days=today.weekday())
        next_monday = this_monday + timedelta(days=7)
        next_sunday = next_monday + timedelta(days=6)
        start_of_period = datetime.combine(next_monday, datetime.min.time())
        end_of_period = datetime.combine(next_sunday, datetime.max.time())
        save_path = os.path.join(
    source_folder, f"next_week_order_log_{
        now.strftime('%Y%m%d_%H%M%S')}.txt")
        log_lines = [
    f"ğŸ¯ Next Week Order Integration Log\n",
    f"Scan Start Time: {now}\n",
    f"Target Week: {
        start_of_period.date()} to {
            end_of_period.date()}\n"]

        date_validator = DeliveryDateValidator(
            delivery_config) if delivery_config else None

        outlet_mapping = {}
        if outlet_config:
            try:
                outlet_mapping = {o['short_name']: o for o in outlet_config}
                if log_callback:
                    log_callback(f"âœ… å·²åŠ è½½åˆ†åº—é…ç½®: {len(outlet_mapping)} ä¸ªåˆ†åº—")
            except Exception as e:
                if log_callback:
                    log_callback(f"âš ï¸ åˆ†åº—é…ç½®åŠ è½½å¤±è´¥: {str(e)}")

        # æ–°å¢ï¼šå»ºç«‹ä¸€å€‹ OrderAutomation å¯¦ä¾‹ç”¨æ–¼ get_short_code
        oa_instance = cls(outlet_config) if outlet_config else cls()

        supplier_to_outlets = defaultdict(list)

        def log(message, include_timestamp=True):
            timestamp = datetime.now().strftime("%H:%M:%S") if include_timestamp else ""
            log_line = f"[{timestamp}] {message}" if include_timestamp else message
            log_lines.append(log_line + "\n")
            if log_callback:
                log_callback(log_line + "\n")

        files = [f for f in os.listdir(source_folder)
                 if f.endswith((".xlsx", ".xls")) and not f.startswith("~$")]
        total_files = len(files)

        if total_files == 0:
            log("æœªæ‰¾åˆ°Excelæ–‡ä»¶\nNo Excel files found in source folder. Exiting.")
            return False, "åœ¨æºæ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°Excelæ–‡ä»¶"

        log(f"æ‰¾åˆ° {total_files} ä¸ªExcelæ–‡ä»¶\nFound {total_files} Excel files")
        log(
    f"ç›®æ ‡å‘¨æœŸ: {
        start_of_period.strftime('%Y-%m-%d')} åˆ° {
            end_of_period.strftime('%Y-%m-%d')}\nTarget period: {
                start_of_period.strftime('%Y-%m-%d')} to {
                    end_of_period.strftime('%Y-%m-%d')}")
        log(f"ğŸ” å°ˆæ³¨æ–¼ä¸‹é€±è¨‚å–®ï¼Œå¿½ç•¥å…¶ä»–é€±æœŸ\nğŸ” Focus on next week orders only, ignore other periods")

        for idx, file in enumerate(files):
            full_path = os.path.join(source_folder, file)
            try:
                # log(f"\nå¤„ç†æ–‡ä»¶ {idx+1}/{total_files}: {file}\nProcessing file
                # {idx+1}/{total_files}: {file}")
                wb = load_workbook(full_path, data_only=True)
                # log(f"å·¥ä½œè¡¨: {', '.join(wb.sheetnames)}\nWorksheets: {',
                # '.join(wb.sheetnames)}")
                for sheetname in wb.sheetnames:
                    ws = wb[sheetname]
                    if ws.sheet_state != "visible":
                        continue  # è·³ééš±è—å·¥ä½œè¡¨ä¸ logï¼Œä¸é¡¯ç¤ºä»»ä½•è¨Šæ¯
                    outlet_short = file.split('_')[0].strip(
                    ) if '_' in file else file.split('.')[0].strip()
                    # log(f"  å·¥ä½œè¡¨: {sheetname}, æ–‡ä»¶ååˆ†åº—ç®€ç§°: '{outlet_short}'\n
                    # Sheet: {sheetname}, Short Name (from filename):
                    # '{outlet_short}'")
                    has_order = False
                    week_days = [
    'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                    for row in range(1, ws.max_row):
                        row_vals = [str(ws.cell(row=row, column=col).value).strip() if ws.cell(
                            row=row, column=col).value else '' for col in range(6, 13)]
                        weekday_count = sum(
    day in row_vals for day in week_days)
                        if 'Mon' in row_vals and weekday_count >= 3:
                            date_row = row + 1
                            date_cols = []
                            for idx2, col in enumerate(range(6, 13)):
                                val = ws.cell(row=date_row, column=col).value
                                parsed = None
                                try:
                                    if val:
                                        sval = str(val)
                                        if re.match(
    r"^\d{1,2}-[A-Za-z]{3,}$", sval):
                                            year = start_of_period.year
                                            sval = f"{sval}-{year}"
                                        if isinstance(val, (int, float)):
                                            base_date = datetime(1899, 12, 30)
                                            parsed = base_date + \
                                                timedelta(days=val)
                                        else:
                                            parsed = parse(
                                                sval, fuzzy=True, dayfirst=False)
                                except Exception:
                                    pass
                                if parsed and start_of_period.date() <= parsed.date() <= end_of_period.date():
                                    date_cols.append(col)
                            if date_cols:
                                for r in range(
                                    date_row + 1, min(date_row + 30, ws.max_row + 1)):
                                    found_order_this_row = False
                                    for c in date_cols:
                                        val = ws.cell(row=r, column=c).value
                                        if isinstance(val, (datetime,)):
                                            if val.date() > end_of_period.date():
                                                found_order_this_row = True
                                                break
                                        elif isinstance(val, (int, float)) and val > 0:
                                            has_order = True
                                            found_order_this_row = True
                                            break
                                    if found_order_this_row:
                                        break
                            if has_order:
                                break
                    if has_order:
                        # åªè¨˜éŒ„æœ‰è¨‚å–®çš„å» å•†èˆ‡åˆ†åº—ï¼Œä¸è¨˜éŒ„ç´°ç¯€
                        supplier_to_outlets[sheetname].append(
                            (outlet_short, full_path, sheetname))
            except Exception as e:
                error_msg = f"âŒ å¤„ç†æ–‡ä»¶å‡ºé”™: {file}\nâŒ Error processing {file}: {
    str(e)}\n{
        traceback.format_exc()}"
                log(error_msg)

        log("\nğŸ“Š ä¸‹é€±è¨‚å–®æ•´åˆçµæœ / Next Week Order Integration Results:")
        for supplier, outlets in supplier_to_outlets.items():
            outlet_list = [str(o[0]) if o[0] else "UNKNOWN" for o in outlets]
            log(f"  ğŸ“¦ {supplier}: {', '.join(outlet_list)}")
        log(f"\nğŸ¯ åªè™•ç†ä¸‹é€±è¨‚å–®ï¼Œå…± {sum(len(outlets) for outlets in supplier_to_outlets.values())} å€‹é–€å¸‚æœ‰è¨‚å–®")
        log("\nCreating supplier files...")
        supplier_files = []
        import os
        import xlwings as xw
        for sheetname, outlet_file_pairs in supplier_to_outlets.items():
            # use next Monday for Month_WeekX naming
            today_d = now.date()
            next_mon = today_d + timedelta(days=(7 - today_d.weekday()))
            month_abbr = next_mon.strftime('%b')
            week_in_month = ((next_mon.day - 1) // 7) + 1
            supplier_path = os.path.join(
    supplier_folder,
     f"{sheetname}_{month_abbr}_Week_{week_in_month}.xlsx")
            # rename legacy files (e.g., *_Week_XX.xlsx) to Month_WeekX if
            # present
            try:
                existing = None
                for fname in os.listdir(supplier_folder):
                    if fname.lower().endswith('.xlsx') and sheetname.lower() in fname.lower():
                        cand = os.path.join(supplier_folder, fname)
                        # skip temp/open files
                        if os.path.basename(cand).startswith('~$'):
                            continue
                        existing = cand
                        break
                if existing and os.path.normcase(
                    existing) != os.path.normcase(supplier_path):
                    if not os.path.exists(supplier_path):
                        os.replace(existing, supplier_path)
            except Exception:
                pass
            # å…ˆå»ºç«‹ç©ºæª”æ¡ˆ
            if not os.path.exists(supplier_path):
                from openpyxl import Workbook
                wb = Workbook()
                wb.save(supplier_path)
            app = xw.App(visible=False)
            try:
                wb_dest = app.books.open(supplier_path)
                for outlet, src_file, original_sheet in outlet_file_pairs:
                    try:
                        wb_src = app.books.open(src_file)
                        sht = wb_src.sheets[original_sheet]
                        dest_sheet_name = outlet if outlet else original_sheet
                        # åˆªé™¤åŒååˆ†é ï¼ˆä½†è¦ç¢ºä¿è‡³å°‘ä¿ç•™ä¸€å€‹å·¥ä½œè¡¨ï¼‰
                        sheets_to_delete = []
                        for s in wb_dest.sheets:
                            if s.name == dest_sheet_name:
                                sheets_to_delete.append(s)
                        
                        # åªæœ‰åœ¨æœ‰å¤šå€‹å·¥ä½œè¡¨æ™‚æ‰åˆªé™¤
                        if len(wb_dest.sheets) > 1:
                            for s in sheets_to_delete:
                                s.delete()
                            sht.api.Copy(Before=wb_dest.sheets[0].api)
                            # æª¢æŸ¥æ–°è¤‡è£½çš„å·¥ä½œè¡¨åç¨±æ˜¯å¦è¡çªï¼Œå¦‚æœè¡çªå‰‡æ·»åŠ å¾Œç¶´
                            new_sheet = wb_dest.sheets[0]
                            original_name = dest_sheet_name
                            counter = 1
                            while any(s.name == dest_sheet_name for s in wb_dest.sheets if s != new_sheet):
                                dest_sheet_name = f"{original_name}_{counter}"
                                counter += 1
                            new_sheet.name = dest_sheet_name
                        else:
                            # å¦‚æœåªæœ‰ä¸€å€‹å·¥ä½œè¡¨ï¼Œç›´æ¥è¤‡è£½ä¸¦é‡å‘½å
                            sht.api.Copy(Before=wb_dest.sheets[0].api)
                            # æª¢æŸ¥æ–°è¤‡è£½çš„å·¥ä½œè¡¨åç¨±æ˜¯å¦è¡çªï¼Œå¦‚æœè¡çªå‰‡æ·»åŠ å¾Œç¶´
                            new_sheet = wb_dest.sheets[0]
                            original_name = dest_sheet_name
                            counter = 1
                            while any(s.name == dest_sheet_name for s in wb_dest.sheets if s != new_sheet):
                                dest_sheet_name = f"{original_name}_{counter}"
                                counter += 1
                            new_sheet.name = dest_sheet_name
                        wb_src.close()
                        log(
    f"  âœ… {dest_sheet_name} å·²è¤‡è£½é€² {
        os.path.basename(supplier_path)}ï¼ˆæ ¼å¼/å…¬å¼å®Œæ•´ä¿ç•™ï¼‰")
                    except Exception as e:
                        log(
    f"    âŒ Failed to copy {outlet} in {sheetname}: {
        str(e)}\n{
            traceback.format_exc()}")
                # åˆªé™¤ç©ºç™½çš„ Sheetï¼ˆå¦‚æœå­˜åœ¨ä¸”æœ‰å…¶ä»–å·¥ä½œè¡¨ï¼‰
                try:
                    if len(wb_dest.sheets) > 1:  # ç¢ºä¿ä¸æ˜¯å”¯ä¸€çš„å·¥ä½œè¡¨
                        sheets_to_delete = []
                        for sheet in wb_dest.sheets:
                            if sheet.name in ['Sheet', 'Sheet1']:
                                # æª¢æŸ¥å·¥ä½œè¡¨æ˜¯å¦çœŸçš„æ˜¯ç©ºç™½çš„
                                is_empty = True
                                try:
                                    if sheet.used_range is not None:
                                        # æª¢æŸ¥ used_range ä¸­æ˜¯å¦æœ‰å¯¦éš›æ•¸æ“š
                                        for row in sheet.used_range.rows:
                                            for cell in row:
                                                if cell.value is not None and str(
                                                    cell.value).strip() != "":
                                                    is_empty = False
                                                    break
                                            if not is_empty:
                                                break
                                except:
                                    # å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œå‡è¨­ä¸æ˜¯ç©ºç™½çš„
                                    is_empty = False

                                if is_empty:
                                    sheets_to_delete.append(sheet)

                        # åˆªé™¤ç©ºç™½å·¥ä½œè¡¨
                        for sheet in sheets_to_delete:
                            sheet.delete()
                            log(f"  ğŸ—‘ï¸ å·²åˆªé™¤ç©ºç™½å·¥ä½œè¡¨: {sheet.name}")

                except Exception as e:
                    # é™é»˜å¤„ç†åˆ é™¤ç©ºç™½å·¥ä½œè¡¨æ—¶çš„é”™è¯¯ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    pass

                wb_dest.save()
                wb_dest.close()
                supplier_files.append(os.path.basename(supplier_path))
            finally:
                app.quit()
        result_text = "\nğŸ¯ ä¸‹é€±è¨‚å–®æ•´åˆå®Œæˆ / Next Week Order Integration Complete:\n"
        result_text += f"ğŸ“¦ å·²è™•ç†ä¾›æ‡‰å•†æ–‡ä»¶: {len(supplier_files)}\n"
        result_text += f"ğŸ“… ç›®æ¨™é€±æœŸ: {
    start_of_period.strftime('%Y-%m-%d')} åˆ° {
        end_of_period.strftime('%Y-%m-%d')}\n\n"
        result_text += "ğŸ“‹ ä¾›æ‡‰å•†æ–‡ä»¶åˆ—è¡¨:\n" + \
            "\n".join([f"  âœ… {file}" for file in supplier_files])
        log(result_text)
        try:
            with open(save_path, "w", encoding="utf-8") as logfile:
                logfile.writelines(log_lines)
            log(f"\nLog saved at: {save_path}")
            return True, f"è®¢å•æ•´åˆå®Œæˆï¼\n\næ—¥å¿—æ–‡ä»¶ä¿å­˜è‡³:\n{save_path}\n\n{result_text}"
        except Exception as e:
            log(f"âŒ Failed to write log file: {e}")
            return False, f"è®¢å•æ•´åˆå®Œæˆä½†æ—¥å¿—ä¿å­˜å¤±è´¥:\n{str(e)}"

# ========== å¢å¼ºç‰ˆè®¢å•æ£€æŸ¥å™¨ ==========


class EnhancedOrderChecker:
    """ä½¿ç”¨é…ç½®æ–‡ä»¶çš„è®¢å•æ£€æŸ¥å™¨"""

    def __init__(self, config_manager=None):
        self.config_manager = config_manager
        # æ–°å¢ï¼šå»ºç«‹ full name/short name/email name normalize æ˜ å°„åˆ° short name
        self.fullname_to_short = {}
        if config_manager and hasattr(config_manager, 'config_path'):
            import pandas as pd
            import os
            config_path = config_manager.config_path if hasattr(
                config_manager, 'config_path') else None
            if config_path and os.path.exists(config_path):
                try:
                    df = pd.read_excel(config_path, sheet_name=None)
                    outlet_df = None
                    for key in df.keys():
                        if key.strip().lower() == "outlet":
                            outlet_df = df[key]
                            break
                    if outlet_df is not None:
                        for _, row in outlet_df.iterrows():
                            short = str(row.get("Short Name", "")).strip()
                            full = str(row.get("Outlet Full Name", "")).strip()
                            email_name = str(
                                row.get("Name in Email", "")).strip()
                            for n in [short, full, email_name]:
                                n_norm = self._normalize(n)
                                if n and n_norm:
                                    self.fullname_to_short[n_norm] = short
                except Exception as e:
                    print(
    "[EnhancedOrderChecker] Outlet mapping read error:", e)

    @staticmethod
    def _normalize(text):
        """æ ‡å‡†åŒ–æ–‡æœ¬"""
        import re
        if not text:
            return ""
        # åªå»é™¤ç©ºæ ¼ï¼Œä¿ç•™æ‹¬å·å†…å®¹ä»¥åŒºåˆ†ä¸åŒä¾›åº”å•†
        return re.sub(r'[\s]', '', str(text).lower())

    def get_outlet_shortname(self, f5_value):
        """æ™ºèƒ½è·å–åˆ†åº—ç®€ç§°ï¼Œä¼˜å…ˆç”¨ config mapping"""
        import re

        if not f5_value or not isinstance(f5_value, str):
            return f"[EMPTY] {f5_value}"

        # å…ˆå˜—è©¦å®Œæ•´åŒ¹é…
        n = self._normalize(f5_value)
        if n in self.fullname_to_short:
            return self.fullname_to_short[n]

        # è™•ç†åŒ…å«é…é€æ—¥æœŸè³‡è¨Šçš„ F5 å€¼
        # ä¾‹å¦‚: "Sushi Express West Mall (MON,WED,FRI,SAT)" -> "Sushi Express West Mall"
        # ä½†ä¿ç•™åŒ…å«é–€å¸‚ä»£ç¢¼çš„æ‹¬è™Ÿï¼Œå¦‚ "Sushi Takeout CityVibe (GTM)"
        delivery_pattern = r'\s*\([A-Z]{2,4},[A-Z]{2,4},[A-Z]{2,4},[A-Z]{2,4}\)\s*$'
        cleaned_f5 = re.sub(delivery_pattern, '', f5_value.strip())

        if cleaned_f5 != f5_value:
            n = self._normalize(cleaned_f5)
            if n in self.fullname_to_short:
                return self.fullname_to_short[n]

        # fallback: åŸæœ‰ hardcode/æ­£åˆ™é€»è¾‘ï¼ˆå¯é€‰ï¼‰
        # ... existing code ...
        return f"[UNKNOWN] {f5_value}"

    def run_checklist(self, folder, log_callback=None, as_table=False):
        date_validator = None
        if self.config_manager:
            delivery_schedules = self.config_manager.delivery_schedule
            if delivery_schedules:
                date_validator = DeliveryDateValidator()
                date_validator.schedule = defaultdict(dict)
                for row in delivery_schedules:
                    supplier = row['supplier']
                    outlet = row['outlet_code']
                    days = DeliveryDateValidator().parse_delivery_days(
                        row['delivery_days'])
                    if outlet == "ALL":
                        date_validator.schedule[supplier]['*'] = days
                    else:
                        date_validator.schedule[supplier][outlet] = days
        supplier_keywords = {}
        if self.config_manager:
            # é¦–å…ˆæ‰«ææ–‡ä»¶å¤¹ï¼Œæ‰¾åˆ°æ‰€æœ‰ä¾›åº”å•†æ–‡ä»¶ï¼ˆåŒ…æ‹¬å˜ä½“ï¼‰ï¼Œçµ±ä¸€ä½¿ç”¨ç¬¬ä¸€å€‹åº•ç·šå‰çš„åç¨±ä½œç‚ºä¾›æ‡‰å•†å
            all_supplier_files = set()
            try:
                files = [f for f in os.listdir(folder) if f.endswith(".xlsx") and not f.startswith("~$")]
                for file in files:
                    base_no_ext = os.path.splitext(file)[0]
                    base_variant = base_no_ext.split('_')[0]
                    all_supplier_files.add(base_variant)
                    print(f"[DEBUG] å‘ç°ä¾›åº”å•†æ–‡ä»¶: {base_no_ext} -> åŸºæº–: {base_variant}")
            except Exception as e:
                print(f"[DEBUG] æ‰«æä¾›åº”å•†æ–‡ä»¶æ—¶å‡ºé”™: {e}")
            
            # å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„ä¾›åº”å•†
            for supplier in self.config_manager.suppliers:
                supplier_name = supplier["name"]
                keywords = [supplier_name.lower()]
                supplier_keywords[supplier_name] = keywords
                
                # æ£€æŸ¥æ˜¯å¦æœ‰æ‹¬å·å˜ä½“æ–‡ä»¶
                if '(' not in supplier_name and ')' not in supplier_name:
                    for file_name in all_supplier_files:
                        if file_name.startswith(supplier_name) and '(' in file_name and ')' in file_name:
                            variant_name = file_name
                            # ä¸ºå˜ä½“åˆ›å»ºç‹¬ç«‹çš„ä¾›åº”å•†æ¡ç›®
                            if variant_name not in supplier_keywords:
                                supplier_keywords[variant_name] = [variant_name.lower()]
                                print(f"[DEBUG] å‘ç°ä¾›åº”å•†å˜ä½“: {supplier_name} -> {variant_name}")
            
            # å¤„ç†ç‹¬ç«‹çš„æ‹¬å·å˜ä½“æ–‡ä»¶ï¼ˆä¸åœ¨é…ç½®ä¸­çš„ï¼‰
            for file_name in all_supplier_files:
                if '(' in file_name and ')' in file_name:
                    base_variant = file_name
                    if base_variant not in supplier_keywords:
                        supplier_keywords[base_variant] = [base_variant.lower()]
                        print(f"[DEBUG] å‘ç°ç‹¬ç«‹ä¾›åº”å•†å˜ä½“: {base_variant}")

            # å¤„ç†ç¨ç«‹çš„éæ‹¬è™ŸåŸºç¤ä¾›æ‡‰å•†ï¼ˆä¾‹å¦‚æœ‰ Super Q ä½†é…ç½®ä¸­æ²’æœ‰ï¼‰
            for file_name in all_supplier_files:
                if '(' not in file_name and ')' not in file_name:
                    base_name = file_name
                    if base_name not in supplier_keywords:
                        supplier_keywords[base_name] = [base_name.lower()]
                        print(f"[DEBUG] å‘ç°ç‹¬ç«‹ä¾›åº”å•†: {base_name}")

            # ä¸ç§»é™¤åŸºç¤åï¼›ä¿ç•™åŸºç¤èˆ‡å„è®Šé«”ï¼Œç¢ºä¿åŒæ™‚è™•ç† Super Q èˆ‡ Super Q (Chawan)
        must_have_outlets = {}
        if self.config_manager:
            for supplier in self.config_manager.suppliers:
                must_have_outlets[supplier["name"]] = self.config_manager.get_required_outlets(
                    supplier["name"])
            
            # ä¸ºå˜ä½“ä¾›åº”å•†æ·»åŠ é…ç½®ï¼ˆç»§æ‰¿åŸºç¡€ä¾›åº”å•†çš„é…ç½®ï¼‰
            for supplier_name in supplier_keywords.keys():
                if supplier_name not in must_have_outlets:
                    # æŸ¥æ‰¾å¯¹åº”çš„åŸºç¡€ä¾›åº”å•†
                    base_supplier = None
                    for config_supplier in self.config_manager.suppliers:
                        config_name = config_supplier["name"]
                        if supplier_name.startswith(config_name) and '(' in supplier_name:
                            base_supplier = config_name
                            break
                    
                    if base_supplier:
                        must_have_outlets[supplier_name] = must_have_outlets[base_supplier]
                        print(f"[DEBUG] å˜ä½“ä¾›åº”å•† {supplier_name} ç»§æ‰¿åŸºç¡€ä¾›åº”å•† {base_supplier} çš„é…ç½®")
                    else:
                        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŸºç¡€ä¾›åº”å•†ï¼Œä½¿ç”¨ç©ºé…ç½®
                        must_have_outlets[supplier_name] = []
                        print(f"[DEBUG] å˜ä½“ä¾›åº”å•† {supplier_name} ä½¿ç”¨ç©ºé…ç½®")
        
        print(f"[DEBUG] æœ€ç»ˆä¾›åº”å•†åˆ—è¡¨: {list(supplier_keywords.keys())}")
        print(f"[DEBUG] ä¾›åº”å•†é…ç½®æ•°é‡: {len(must_have_outlets)}")
        try:
            files = [f for f in os.listdir(folder) if f.endswith(
                ".xlsx") and not f.startswith("~$")]

            def file_key(f):
                # æå–ç¬¬ä¸€ä¸ªä¸‹åˆ’çº¿ä¹‹å‰çš„ä¾›åº”å•†å
                import os
                base = os.path.splitext(f)[0]  # ç§»é™¤ .xlsx æ‰©å±•å
                supplier_name = base.split('_')[0]  # å–ç¬¬ä¸€ä¸ªä¸‹åˆ’çº¿ä¹‹å‰çš„éƒ¨åˆ†
                return self._normalize(supplier_name)
            normalized_files = {file_key(f): f for f in files}
            output = []
            table = []
            for supplier, keywords in supplier_keywords.items():
                print(f"\n[DEBUG] ===== å¤„ç†ä¾›åº”å•†: {supplier} =====")
                matches = self._find_supplier_file(normalized_files, keywords)
                if not matches:
                    if as_table:
                        table.append({
                            "supplier": supplier,
                            "outlet": "-",
                            "cover_status": "âŒ",
                            "remark": "Supplier file not found"
                        })
                    else:
                        output.append(
    f"\nâŒ {supplier} - Supplier file not found.")
                    continue
                for match in matches:
                    result, table_rows = self._process_supplier_file(
                        folder, match, must_have_outlets[supplier],
                        date_validator, log_callback, as_table=True, supplier=supplier
                    )
                if as_table:
                    table.extend(table_rows)
                else:
                    output.extend(result)
            if as_table:
                return table
            return "\n".join(output)
        except Exception as e:
            if as_table:
                return [{"supplier": "-", "outlet": "-",
                    "cover_status": "âŒ", "remark": f"Error: {str(e)}"}]
            return f"âŒ Error running checklist: {
    str(e)}\n{
        traceback.format_exc()}"

    @classmethod
    def _find_supplier_file(cls, normalized_files, keywords):
        # ä½¿ç”¨å…¨å±€çš„find_supplier_fileå‡½æ•°ï¼Œå®ƒå·²ç»ä¿®å¤äº†æ‹¬å·å˜ä½“çš„é€‰æ‹©é€»è¾‘
        all_files = list(normalized_files.values())
        matches = []
        
        print(f"[DEBUG] å¤„ç†å…³é”®å­—: {keywords}")
        
        for keyword in keywords:
            # ä½¿ç”¨ä¿®å¤åçš„find_supplier_fileå‡½æ•°
            matched_file = find_supplier_file(keyword, all_files)
            if matched_file and matched_file not in matches:
                matches.append(matched_file)
                print(f"[DEBUG] æ‰¾åˆ°æ–‡ä»¶: {matched_file}")
        return matches if matches else None

    def _process_supplier_file(
    self,
    folder,
    filename,
    required_outlets,
    date_validator=None,
    log_callback=None,
    as_table=False,
     supplier=None):
        import os
        from openpyxl import load_workbook
        import tkinter.messagebox as messagebox
        output = []
        table = []
        found = set()
        unidentified = []
        date_errors = []
        unknown_f5 = set()
        try:
            wb = load_workbook(os.path.join(folder, filename), data_only=True)
            print(f"[DEBUG] å¤„ç†æ–‡ä»¶: {filename}")
            print(f"[DEBUG] å·¥ä½œè¡¨åˆ—è¡¨: {wb.sheetnames}")
            
            for s in wb.sheetnames:
                # è·³è¿‡ sheet åä¸º 'Sheet' æˆ–ç©ºç™½çš„ sheet
                if not s.strip() or s.strip().lower() == 'sheet':
                    print(f"[DEBUG] è·³è¿‡ç©ºç™½å·¥ä½œè¡¨: {s}")
                    continue
                try:
                    f5 = wb[s]["F5"].value
                    code = self.get_outlet_shortname(f5)
                    sheet_name = s.strip().upper()
                    short_name_mismatch = False

                    # æ·»åŠ è°ƒè¯•ä¿¡æ¯
                    print(f"[DEBUG] å¤„ç†å·¥ä½œè¡¨: {s}, F5: {f5}, Code: {code}")

                    # è™•ç†ç‰¹æ®Šæƒ…æ³ï¼šå¦‚æœ F5 æ˜ å°„çµæœèˆ‡å·¥ä½œè¡¨åç¨±ä¸åŒï¼Œä½†éƒ½æŒ‡å‘åŒä¸€å€‹é–€å¸‚
                    # ä¾‹å¦‚ï¼šF5â†’BUGIS, Sheetâ†’BJï¼Œä½†éƒ½æŒ‡å‘ SushiPlus Bugis
                    if code != sheet_name and "[UNKNOWN]" not in code and "[EMPTY]" not in code:
                        # æª¢æŸ¥æ˜¯å¦éƒ½æ˜ å°„åˆ°åŒä¸€å€‹é–€å¸‚
                        f5_normalized = self._normalize(f5) if f5 else ""
                        sheet_normalized = self._normalize(sheet_name)

                        # å¦‚æœ F5 æ˜ å°„å’Œå·¥ä½œè¡¨åç¨±éƒ½æŒ‡å‘åŒä¸€å€‹é–€å¸‚ï¼Œå‰‡ä¸è¦–ç‚º mismatch
                        if f5_normalized in self.fullname_to_short and sheet_normalized in self.fullname_to_short:
                            if self.fullname_to_short[f5_normalized] == self.fullname_to_short[sheet_normalized]:
                                short_name_mismatch = False
                            else:
                                short_name_mismatch = True
                        else:
                            short_name_mismatch = True
                    if "[UNKNOWN]" in code or "[EMPTY]" in code:
                        print(f"[DEBUG] å·¥ä½œè¡¨ {s} æœ‰F5é”™è¯¯: F5={f5}, Code={code}")
                        unidentified.append((s, f5))
                        unknown_f5.add(str(f5).strip() if f5 else "[ç©ºç™½]")
                        if as_table:
                            table.append({
                                "supplier": supplier,
                                "outlet": s,
                                "cover_status": "âš ï¸",
                                "remark": f"F5 error: {f5}" + (f"; Short name mismatch: F5â†’{code}, Sheetâ†’{sheet_name}" if short_name_mismatch else "")
                            })
                    else:
                        print(f"[DEBUG] å·¥ä½œè¡¨ {s} å¤„ç†æˆåŠŸ: F5={f5}, Code={code}")
                        found.add(code)
                        date_status = "-"
                        remark = ""
                        if date_validator:
                            delivery_date = wb[s]['F8'].value if 'F8' in wb[s] else None
                            if delivery_date:
                                is_valid = date_validator.validate_order(
                                    supplier,
                                    code,
                                    delivery_date,
                                    log_callback
                                )
                                if not is_valid:
                                    date_status = "âŒ"
                                    remark = "Invalid delivery date"
                                    date_errors.append(code)
                                else:
                                    date_status = "âœ”ï¸"
                            else:
                                date_status = "âš ï¸"
                                remark = ""
                        if short_name_mismatch:
                            if remark:
                                remark += "; "
                            remark += f"Short name mismatch: F5â†’{code}, Sheetâ†’{sheet_name}"
                        if as_table:
                            table.append({
                                "supplier": supplier,
                                "outlet": code,
                                "cover_status": "âœ”ï¸",
                                "remark": remark
                            })
                except Exception as e:
                    unidentified.append((s, f"[F5 error: {e}]"))
                    if as_table:
                        table.append({
                            "supplier": supplier,
                            "outlet": s,
                            "cover_status": "âš ï¸",
                            "remark": f"F5 error: {e} (sheet: {s}, file: {filename})"
                        })
            required = set([str(x).strip().upper() for x in required_outlets])
            found = set([str(x).strip().upper() for x in found])
            print(f"[DEBUG] supplier={supplier}")
            print(f"[DEBUG] required={required}")
            print(f"[DEBUG] found={found}")
            print(f"[DEBUG] missing={required - found}")
            print(f"[DEBUG] all sheet names in {filename}: {wb.sheetnames}")
            print(f"[DEBUG] unidentified sheets: {unidentified}")
            print(f"[DEBUG] unknown F5 values: {unknown_f5}")
            print(f"[DEBUG] F5 to code mappings:")
            for s in wb.sheetnames:
                if not s.strip() or s.strip().lower() == 'sheet':
                    continue
                try:
                    f5 = wb[s]["F5"].value
                    code = self.get_outlet_shortname(f5)
                    print(f"  Sheet: {s}, F5: {f5}, Code: {code}")
                except Exception as e:
                    print(f"  Sheet: {s}, F5 Error: {e}")

            # æª¢æŸ¥ missing outlet æ˜¯å¦æœ‰å°æ‡‰çš„ sheet ä½† F5 å’Œ sheet name ä¸ä¸€è‡´
            missing_with_sheet_mismatch = set()
            for sheet_name in wb.sheetnames:
                if not sheet_name.strip() or sheet_name.strip().lower() == 'sheet':
                    continue
                sheet_name_upper = sheet_name.strip().upper()
                if sheet_name_upper in required and sheet_name_upper not in found:
                    try:
                        f5 = wb[sheet_name]["F5"].value
                        code = self.get_outlet_shortname(f5)
                        if code != sheet_name_upper and "[UNKNOWN]" not in code and "[EMPTY]" not in code:
                            missing_with_sheet_mismatch.add(sheet_name_upper)
                    except:
                        pass

            for o in sorted(required - found):
                if as_table:
                    if o in missing_with_sheet_mismatch:
                        # æœ‰ sheet ä½† F5 å’Œ sheet name ä¸ä¸€è‡´
                        table.append({
                            "supplier": supplier,
                            "outlet": o,
                            "cover_status": "âš ï¸",
                            "remark": f"Short name mismatch: Sheetâ†’{o}"
                        })
                    else:
                        # çœŸæ­£çš„ missing outlet
                        table.append({
                            "supplier": supplier,
                            "outlet": o,
                            "cover_status": "âŒ",
                            "remark": "Missing outlet"
                        })
            if as_table:
                # æ£€æŸ¥ç»“æŸåï¼Œå¼¹çª—æé†’æ‰€æœ‰æœªèƒ½ mapping çš„ F5 å†…å®¹
                if unknown_f5:
                    msg = "ä»¥ä¸‹ F5 å†…å®¹æœªèƒ½è‡ªåŠ¨ mapping åˆ° short nameï¼Œè¯·è¡¥å……åˆ° config çš„ OUTLET sheetï¼š\n" + \
                        "\n".join(f"- {f5val}" for f5val in sorted(unknown_f5))
                    try:
                        messagebox.showwarning("æ™ºèƒ½æç¤º/Smart Reminder", msg)
                    except Exception:
                        print("[æ™ºèƒ½æç¤º]", msg)
                return output, table
            # åŸæœ¬æ–‡å­—æŠ¥è¡¨
            output.append(f"\n=== {filename} ===")
            output.append(
    f"ğŸ“Š Required: {
        len(required)}, Found: {
            len(found)}, Missing: {
                len(
                    required -
                     found)}")
            for o in sorted(required & found):
                output.append(f"âœ”ï¸ {o}")
            for o in sorted(required - found):
                output.append(f"âŒ {o}")
            for s, v in unidentified:
                output.append(f"âš ï¸ {s} => {v}")
            if unknown_f5:
                output.append(
                    "[æ™ºèƒ½æç¤º] ä»¥ä¸‹ F5 å†…å®¹æœªèƒ½è‡ªåŠ¨ mapping åˆ° short nameï¼Œè¯·è¡¥å……åˆ° config çš„ OUTLET sheetï¼š")
                for f5val in sorted(unknown_f5):
                    output.append(f"  - {f5val}")
            return output, table
        except Exception as e:
            if as_table:
                return output, [{"supplier": "-", "outlet": "-",
                    "cover_status": "âŒ", "remark": f"Error: {str(e)}"}]
            return f"âŒ Error running checklist: {
    str(e)}\n{
        traceback.format_exc()}", []

# ========== å¢å¼ºç‰ˆè®¢å•è‡ªåŠ¨åŒ– ==========


class EnhancedOrderAutomation(OrderAutomation):
    """æ”¯æŒé‚®ä»¶å‘é€çš„è®¢å•è‡ªåŠ¨åŒ–"""

    def __init__(self, config_manager=None):
        super().__init__()
        self.config_manager = config_manager
        self.email_sender = EmailSender(config_manager)

    def run_automation(self, source_folder, supplier_folder,
                      log_callback=None, mapping_callback=None,
                      email_callback=None):
        """è¿è¡Œè‡ªåŠ¨åŒ–æµç¨‹ï¼ˆä»… supplier æ•´åˆï¼‰"""
        import os  # ç¡®ä¿ os æ¨¡å—å¯ç”¨
        success, result = super().run_automation(
            source_folder, supplier_folder,
            log_callback=log_callback, mapping_callback=mapping_callback
        )
        if not success:
            return success, result
        supplier_files = []
        for file in os.listdir(supplier_folder):
            if file.endswith(".xlsx") and "Week" in file:
                supplier_name = file.split("_")[0]
                supplier_files.append({
                    "path": os.path.join(supplier_folder, file),
                    "supplier": supplier_name
                })
        if self.config_manager and email_callback:
            email_callback(supplier_files)
        return success, result


class YellowHighlightedOrderAutomation(OrderAutomation):
    """åªæ•´åˆæœ‰é»ƒè‰²æ¨™è¨˜çš„è¨‚å–®"""
    # æ˜¯å¦åœ¨ç„¡é»ƒè‰²æ¨™è¨˜ä½†åµæ¸¬åˆ°æœ¬é€±æ•¸é‡æ™‚ä¹Ÿç´å…¥ï¼ˆé è¨­é—œé–‰ï¼Œç¶­æŒåš´æ ¼æ¨¡å¼ï¼‰
    ENABLE_FALLBACK_WHEN_NO_YELLOW = False
    # æ˜¯å¦å•Ÿç”¨å»£æ³›çš„æ¨™è¨˜è‰²æª¢æ¸¬ï¼ˆé è¨­é—œé–‰ï¼Œé¿å…èª¤æª¢æ¸¬ï¼‰
    ENABLE_BROAD_MARKER_DETECTION = False

    def __init__(self, config_manager=None):
        super().__init__()
        self.config_manager = config_manager

    def has_yellow_highlight(self, ws, row, col):
        """æª¢æŸ¥æŒ‡å®šå–®å…ƒæ ¼æ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜ï¼ˆåŒ…å« RGBã€ç´¢å¼•è‰²ã€å‰æ™¯è‰²/èƒŒæ™¯è‰²ï¼‰ã€‚
        æ³¨æ„ï¼šæ¢ä»¶å¼æ ¼å¼é€ æˆçš„é¡è‰² OpenPyXL ä¸æœƒè©•ä¼°ï¼Œåªèƒ½ç›¡é‡åµæ¸¬éœæ…‹å¡«è‰²ã€‚
        """
        # å¦‚æœå•Ÿç”¨å»£æ³›æª¢æ¸¬ï¼Œå…ˆå˜—è©¦å»£æ³›æª¢æ¸¬
        if self.ENABLE_BROAD_MARKER_DETECTION:
            if self.has_marker_color(ws, row, col):
                return True

        # ç„¶å¾Œå˜—è©¦æ¨™æº–çš„é»ƒè‰²æª¢æ¸¬
        return self._has_yellow_highlight_strict(ws, row, col)

    def has_marker_color(self, ws, row, col):
        """å»£æ³›æª¢æ¸¬ä»»ä½•å¯èƒ½çš„æ¨™è¨˜é¡è‰²ï¼ˆä¸åƒ…é™é»ƒè‰²ï¼‰"""
        try:
            from openpyxl.styles.colors import Color
            cell = ws.cell(row=row, column=col)

            # æª¢æŸ¥å¡«å……é¡è‰²
            f = cell.fill
            if f:
                for attr in ('start_color', 'end_color', 'fgColor', 'bgColor'):
                    c = getattr(f, attr, None)
                    if c and self._is_marker_color(c):
                        print(f"[DEBUG] âœ… ç™¼ç¾æ¨™è¨˜å¡«å……: row={row}, col={col}, color={c}")
                        return True

            # æª¢æŸ¥å­—é«”é¡è‰²
            font = cell.font
            if font and hasattr(font, 'color') and font.color:
                if self._is_marker_color(font.color):
                    print(f"[DEBUG] âœ… ç™¼ç¾æ¨™è¨˜å­—é«”: row={row}, col={col}, font_color={font.color}")
                    return True

            return False
        except Exception as e:
            print(f"[DEBUG] å»£æ³›æª¢æ¸¬æ™‚å‡ºéŒ¯: {e}")
            return False

    def _is_marker_color(self, color):
        """åˆ¤æ–·é¡è‰²æ˜¯å¦ç‚ºæ¨™è¨˜è‰²ï¼ˆå»£æ³›å®šç¾©ï¼‰"""
        try:
            # RGBé¡è‰²
            if getattr(color, 'rgb', None):
                rgb = color.rgb
                if not isinstance(rgb, str):
                    return False
                rgb_up = rgb.upper()
                if len(rgb_up) == 8:
                    rgb_up = rgb_up[2:]

                try:
                    r = int(rgb_up[0:2], 16)
                    g = int(rgb_up[2:4], 16)
                    b = int(rgb_up[4:6], 16)

                    # æ’é™¤ç™½è‰²å’Œé»‘è‰²ç³»
                    if r > 240 and g > 240 and b > 240:  # æ¥è¿‘ç™½è‰²
                        return False
                    if r < 15 and g < 15 and b < 15:  # æ¥è¿‘é»‘è‰²
                        return False

                    # ä»»ä½•é®®è‰·æˆ–å½©è‰²çš„éƒ½è¦–ç‚ºæ¨™è¨˜
                    max_val = max(r, g, b)
                    min_val = min(r, g, b)
                    if max_val - min_val > 50:  # æœ‰ä¸€å®šé£½å’Œåº¦
                        return True
                except Exception:
                    pass

            # ä¸»é¡Œè‰²
            if getattr(color, 'theme', None) is not None:
                theme_id = color.theme
                if theme_id not in {1, 2, 64}:  # æ’é™¤ç™½è‰²å’Œé»‘è‰²ä¸»é¡Œè‰²
                    return True

            # ç´¢å¼•è‰²
            if getattr(color, 'indexed', None) is not None:
                indexed = color.indexed
                if indexed not in {1, 2, 64}:  # æ’é™¤ç™½è‰²å’Œé»‘è‰²ç´¢å¼•è‰²
                    return True

            return False
        except Exception:
            return False

    def _has_yellow_highlight_strict(self, ws, row, col):
        """åš´æ ¼çš„é»ƒè‰²æ¨™è¨˜æª¢æ¸¬ï¼ˆåŸå§‹é‚è¼¯ï¼‰"""
        try:
            from openpyxl.styles.colors import Color
            cell = ws.cell(row=row, column=col)

            def color_is_yellowish_strict(color: Color) -> bool:
                try:
                    # 1) ç›´æ¥ RGB
                    if getattr(color, 'rgb', None):
                        rgb = color.rgb
                        if not isinstance(rgb, str):
                            return False
                        rgb_up = rgb.upper()
                        if len(rgb_up) == 8:  # e.g. FFFF00FF (ARGB)
                            rgb_up = rgb_up[2:]
                        # å¸¸è¦‹é»ƒç³» - æ“´å±•æ›´å¤šé»ƒè‰²èª¿
                        common = {
    'FFFF00',  # ç´”é»ƒ
    'FFD966',  # æ·ºé»ƒ
    'FFF200',  # äº®é»ƒ
    'FFEB9C',  # ç±³é»ƒ
    'FFE066',  # é‡‘é»ƒ
    'FFD700',  # é‡‘è‰²
    'FFE135',  # æ©™é»ƒ
    'FFD800',  # æ·±é»ƒ
    'FFE100',  # æª¸æª¬é»ƒ
    'FFFF99',  # æ·ºé»ƒ
    'FFFFCC',  # å¾ˆæ·ºçš„é»ƒ
    'FFCC00',  # æ©™é»ƒ
    'FFCC33',  # æ©™é»ƒ
    'FF9900',  # æ©™è‰²
    'FFCC66',  # æ·ºæ©™é»ƒ
    'FFFF66',  # æ·ºé»ƒ
    'FFCC99',  # ç±³é»ƒ
    'FFE4B5',  # é¹¿çš®è‰²
    'F0E68C',  # å¡å…¶è‰²
    'FFF8DC',  # ç‰ç±³çµ²è‰²
    'FAFAD2',  # æ·¡é‡‘é»ƒ
    'FFEFD5',  # ç•ªæœ¨ç“œè‰²
    'FFE4C4',  # è–„é¤…è‰²
    'FFDAB9',  # æ¡ƒè‰²
    'FFE4E1',  # è–„éœ§ç«ç‘°
}
                        if rgb_up in common:
                            return True
                        # å¯¬é¬†é»ƒç³»ï¼šRã€G é«˜ï¼ŒB ä½ - æ”¾å¯¬æ¢ä»¶ä»¥æ¶µè“‹æ›´å¤šé»ƒè‰²èª¿
                        try:
                            r = int(rgb_up[0:2], 16)
                            g = int(rgb_up[2:4], 16)
                            b = int(rgb_up[4:6], 16)
                            # æ”¾å¯¬é»ƒè‰²æª¢æ¸¬æ¢ä»¶ï¼Œæ¶µè“‹æ›´å»£æ³›çš„é»ƒè‰²èª¿
                            if (r >= 200 and g >= 200 and b <= 150) or (r >= 180 and g >= 180 and b <= 120) or (r >= 240 and g >= 240 and b <= 200):
                                return True
                            # å¦å¤–æª¢æŸ¥æ©™é»ƒè‰²ç³»ï¼šR é«˜ï¼ŒG ä¸­ç­‰ï¼ŒB ä½
                            if r >= 200 and g >= 150 and g <= 220 and b <= 100:
                                return True
                        except Exception:
                            pass
                    # 2) ç´¢å¼•è‰²ï¼ˆExcel Indexed å»£æ³›æ¶µè“‹æ¨™è¨˜è‰²ï¼‰
                    if getattr(color, 'indexed', None) is not None:
                        # æ“´å±•ç´¢å¼•è‰²ç¯„åœï¼Œæ¶µè“‹æ›´å¤šå¯èƒ½çš„æ¨™è¨˜è‰²
                        mark_colors = {3, 4, 5, 6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64}
                        if color.indexed in mark_colors:
                            return True
                    # 3) ä¸»é¡Œè‰²ï¼šå˜—è©¦æ ¹æ“šä¸»é¡ŒIDå’Œè‰²èª¿ä¼°è¨ˆé¡è‰²
                    if getattr(color, 'theme', None) is not None and getattr(color, 'tint', None) is not None:
                        theme_id = color.theme
                        tint = color.tint
                        # Excelä¸»é¡Œè‰²æ˜ å°„ï¼ˆå»£æ³›æ¶µè“‹æ‰€æœ‰å¯èƒ½çš„æ¨™è¨˜è‰²ä¸»é¡ŒIDï¼‰
                        # æ ¹æ“šExcelä¸»é¡Œè‰²å½©ç›¤ï¼Œå¤§éƒ¨åˆ†æ¨™è¨˜è‰²éƒ½åœ¨é€™äº›ç¯„åœå…§
                        theme_bright_colors = set(range(5, 19))  # 5-18: é»ƒè‰²ã€ç¶ è‰²ã€è—è‰²ã€ç´«è‰²ç­‰é®®è‰·è‰²å½©
                        theme_pastel_colors = set(range(1, 5)) + set(range(19, 23))  # æ·ºè‰²èª¿

                        if theme_id in theme_bright_colors:
                            # é®®è‰·è‰²å½©çš„ä»»ä½•è‰²èª¿éƒ½è¦–ç‚ºæ¨™è¨˜ï¼ˆåŒ…æ‹¬æ·±è‰²èª¿ï¼‰
                            return True
                        elif theme_id in theme_pastel_colors:
                            # æ·ºè‰²èª¿éœ€è¦è¼ƒé«˜çš„tintå€¼
                            if tint > 0.05:  # é€²ä¸€æ­¥é™ä½é–€æª»
                                return True
                except Exception:
                    return False
                return False

            def any_fill_yellow_strict(f) -> bool:
                if not f:
                    return False
                # æª¢æŸ¥ä¸åŒå±¬æ€§
                for attr in ('start_color', 'end_color', 'fgColor', 'bgColor'):
                    c = getattr(f, attr, None)
                    if c and color_is_yellowish_strict(c):
                        return True
                return False

            # æª¢æŸ¥å¡«å……é¡è‰²
            f = cell.fill
            if any_fill_yellow_strict(f):
                print(f"[DEBUG] âœ… ç™¼ç¾é»ƒè‰²å¡«å……: row={row}, col={col}, fill={f}")
                return True

            # æª¢æŸ¥å­—é«”é¡è‰²
            try:
                font = cell.font
                if font and hasattr(font, 'color') and font.color:
                    if color_is_yellowish_strict(font.color):
                        print(f"[DEBUG] âœ… ç™¼ç¾é»ƒè‰²å­—é«”: row={row}, col={col}, font_color={font.color}")
                        return True
            except Exception as e:
                print(f"[DEBUG] æª¢æŸ¥å­—é«”é¡è‰²æ™‚å‡ºéŒ¯: {e}")

            # èª¿è©¦ä¿¡æ¯ï¼šè¼¸å‡ºå¡«å……è©³æƒ…å¹«åŠ©è¨ºæ–·ï¼ˆåªè¼¸å‡ºé—œéµä¿¡æ¯ï¼‰
            try:
                if f and (hasattr(f, 'fgColor') or hasattr(f, 'bgColor')):
                    # åªåœ¨ç™¼ç¾ä¸»é¡Œè‰²æ™‚è¼¸å‡ºè©³ç´°ä¿¡æ¯
                    has_theme = False
                    if hasattr(f, 'fgColor') and hasattr(f.fgColor, 'theme') and f.fgColor.theme:
                        has_theme = True
                    if hasattr(f, 'bgColor') and hasattr(f.bgColor, 'theme') and f.bgColor.theme:
                        has_theme = True

                    if has_theme:
                        print(f"[DEBUG] ğŸ” ç™¼ç¾ä¸»é¡Œè‰²å¡«å……: row={row}, col={col}")
                        print(f"[DEBUG]    - fgColor theme: {getattr(f.fgColor, 'theme', None)}, tint: {getattr(f.fgColor, 'tint', None)}")
                        print(f"[DEBUG]    - bgColor theme: {getattr(f.bgColor, 'theme', None)}, tint: {getattr(f.bgColor, 'tint', None)}")
            except Exception as e:
                print(f"[DEBUG] ç²å–å¡«å……è©³æƒ…æ™‚å‡ºéŒ¯: {e}")

            # æª¢æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šçš„å¡«å……æ¨¡å¼ï¼ˆæ¯”å¦‚ç¶²æ ¼ç·šæˆ–å…¶ä»–è¦–è¦ºæ¨™è¨˜ï¼‰
            try:
                if f and hasattr(f, 'patternType') and f.patternType:
                    # å¦‚æœæœ‰ä»»ä½•å¡«å……æ¨¡å¼ï¼Œéƒ½è¦–ç‚ºå¯èƒ½çš„æ¨™è¨˜
                    if str(f.patternType).lower() not in ['none', 'solid']:
                        print(f"[DEBUG] ğŸ” ç™¼ç¾ç‰¹æ®Šå¡«å……æ¨¡å¼: row={row}, col={col}, pattern={f.patternType}")
                        # å¯ä»¥é¸æ“‡æ€§æ¥å—æŸäº›æ¨¡å¼ä½œç‚ºæ¨™è¨˜
            except Exception as e:
                print(f"[DEBUG] æª¢æŸ¥å¡«å……æ¨¡å¼æ™‚å‡ºéŒ¯: {e}")

            # æœ‰äº›æª”æ¡ˆæœƒæŠŠ 0 æˆ–æ•¸å­—ä»¥æ¢ä»¶å¼ä¸Šè‰²ï¼ŒOpenPyXL ç„¡æ³•è©•ä¼°ï¼Œè¨˜éŒ„æç¤ºä»¥åˆ©åˆ¤æ–·
            # é€™è£¡åƒ…åœ¨åµæ¸¬å¤±æ•—æ™‚è¼¸å‡ºä¸€æ¬¡ç°¡å–®èªªæ˜ï¼ˆé¿å…åˆ·å±ï¼‰
            return False
        except Exception as e:
            print(f"[DEBUG] Error checking yellow highlight: {e}")
            return False

    def _parse_date_value(self, val, ref_year):
        """å°‡å„ç¨®æ—¥æœŸè¡¨ç¤ºï¼ˆExcelåºè™Ÿ/å­—ä¸²/æ—¥æœŸç‰©ä»¶ï¼‰è½‰ç‚º dateã€‚"""
        from datetime import datetime, timedelta, date
        try:
            if isinstance(val, datetime):
                return val.date()
            if isinstance(val, (int, float)):
                base = datetime(1899, 12, 30)
                return (base + timedelta(days=float(val))).date()
            s = str(val).strip()
            if not s:
                return None
            # å˜—è©¦å¸¸è¦‹æ ¼å¼ï¼š1-Aug, 01/08, 01/08/2025, Aug-01, 1 Aug
            try:
                from dateutil.parser import parse
                dt = parse(
    s,
    fuzzy=True,
    dayfirst=False,
    default=datetime(
        ref_year,
        1,
         1))
                return dt.date()
            except Exception:
                # ç°¡å–®æ­£å‰‡å›é€€
                import re
                m = re.search(
    r"(\d{1,2})[-/ ]([A-Za-z]{3,}|\d{1,2})(?:[-/ ](\d{2,4}))?", s)
                if m:
                    day = int(m.group(1))
                    mon = m.group(2)
                    year = int(m.group(3)) if m.group(3) else ref_year
                    month_map = {
                        'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6,
                        'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
                    }
                    if mon.isalpha():
                        mon = month_map.get(mon[:3].title())
                    else:
                        mon = int(mon)
                    return datetime(year, mon, day).date()
        except Exception:
            return None
        return None

    def check_file_has_yellow_highlight(
    self, filepath, this_week_start, this_week_end):
        """æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜çš„å–®å…ƒæ ¼"""
        try:
            print(f"[DEBUG] é–‹å§‹æª¢æŸ¥æª”æ¡ˆ: {filepath}")
            wb = openpyxl.load_workbook(filepath, data_only=True)
            print(f"[DEBUG] ğŸ“‹ æ–‡ä»¶ {os.path.basename(filepath)} åŒ…å«å·¥ä½œè¡¨: {', '.join(wb.sheetnames)}")
            for sheet_name in wb.sheetnames:
                print(f"[DEBUG] ğŸ” æª¢æŸ¥å·¥ä½œè¡¨: {sheet_name}")
                ws = wb[sheet_name]

                # ç‚ºæ¯å€‹å·¥ä½œè¡¨é‡æ–°åˆå§‹åŒ–æ—¥æœŸåˆ—é›†åˆï¼ˆå› ç‚ºä¸åŒå·¥ä½œè¡¨å¯èƒ½æœ‰ä¸åŒçš„æ—¥æœŸåˆ—ï¼‰
                sheet_this_week_columns = set()
                
                # æœå°‹æ‰€æœ‰è¡Œï¼Œæ”¶é›†æ‰€æœ‰æœ¬é€±çš„æ—¥æœŸæ¬„ä½ï¼ˆå¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒè¡Œï¼‰
                for row in range(1, min(200, ws.max_row + 1)):
                    # åœ¨æ¯ä¸€è¡Œä¸­å°‹æ‰¾æœ¬é€±çš„æ—¥æœŸæ¬„ä½
                    for col in range(5, 30):  # æ“´å¤§æœå°‹ç¯„åœåˆ° E~AD æ¬„
                        date_cell = ws.cell(row=row, column=col)
                        if date_cell.value:
                            try:
                                from datetime import datetime
                                # å˜—è©¦è§£ææ—¥æœŸ
                                if isinstance(date_cell.value, datetime):
                                    cell_date = date_cell.value.date()
                                elif isinstance(date_cell.value, str):
                                    # å˜—è©¦è§£æå­—ç¬¦ä¸²æ—¥æœŸï¼Œå¦‚ "1-Aug", "2-Aug" ç­‰
                                    import re
                                    date_match = re.search(
                                        r'(\d+)-(\w+)', str(date_cell.value))
                                    if date_match:
                                        day = int(date_match.group(1))
                                        month_str = date_match.group(2)
                                        # ç°¡å–®çš„æœˆä»½æ˜ å°„
                                        month_map = {
                                            'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6,
                                            'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
                                        }
                                        if month_str in month_map:
                                            month = month_map[month_str]
                                            # æ ¹æ®æœˆä»½åˆ¤æ–­å¹´ä»½ï¼šå¦‚æœæœˆä»½å°äºå½“å‰æœˆä»½ï¼Œå¯èƒ½æ˜¯ä¸‹ä¸€å¹´
                                            current_month = this_week_start.month
                                            if month < current_month:
                                                year = this_week_start.year + 1
                                            else:
                                                year = this_week_start.year
                                            cell_date = datetime(
                                                year, month, day).date()
                                        else:
                                            continue
                                    else:
                                        continue
                                else:
                                    continue

                                # æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ¬é€±ç¯„åœå…§
                                if this_week_start.date() <= cell_date <= this_week_end.date():
                                    sheet_this_week_columns.add(col)
                                    print(
    f"[DEBUG] æ‰¾åˆ°æœ¬é€±æ—¥æœŸæ¬„ä½: ç¬¬{row}è¡Œç¬¬{col}æ¬„, æ—¥æœŸ: {cell_date}")
                            except Exception as e:
                                continue

                if not sheet_this_week_columns:
                    continue

                print(f"[DEBUG] å·¥ä½œè¡¨ {sheet_name} æœ¬é€±æ—¥æœŸæ¬„ä½ç¸½è¨ˆ: {sorted(sheet_this_week_columns)}")

                # æª¢æŸ¥æ‰€æœ‰æœ¬é€±æ—¥æœŸæ¬„ä½ä¸‹æ–¹çš„ç”¢å“è¡Œæ˜¯å¦æœ‰é»ƒè‰²æ¨™è¨˜
                # æª¢æŸ¥ç¯„åœå¾ç¬¬1è¡Œåˆ°æœ€å¾Œä¸€è¡Œï¼Œå°‹æ‰¾ç”¢å“è¡Œ
                found_yellow_in_sheet = False
                for check_row in range(1, min(200, ws.max_row + 1)):
                    # æª¢æŸ¥æ˜¯å¦ç‚ºç”¢å“è¡Œï¼ˆé€šå¸¸æœ‰ç”¢å“åç¨±ï¼‰
                    product_name = ws.cell(
                        row=check_row, column=5).value  # E æ¬„ç”¢å“åç¨±
                    if not product_name or str(
                        product_name).strip() == "":
                        continue

                    print(
                        f"[DEBUG] æª¢æŸ¥ç”¢å“è¡Œ: {check_row}, ç”¢å“: {product_name}")

                    # æª¢æŸ¥æ‰€æœ‰æœ¬é€±çš„æ—¥æœŸæ¬„ä½ï¼ˆå³ä½¿æ²’æœ‰è¼¸å…¥æ•¸å­—ï¼Œåªè¦æ¨™é»ƒå°±ç´å…¥ï¼‰
                    for col in sorted(sheet_this_week_columns):
                        if self.has_yellow_highlight(ws, check_row, col):
                            cell_value = ws.cell(
                                row=check_row, column=col).value
                            print(
                                f"[DEBUG] âœ… åœ¨æª”æ¡ˆ {filepath} å·¥ä½œè¡¨ {sheet_name} æ‰¾åˆ°æœ¬é€±é»ƒè‰²æ¨™è¨˜ (row={check_row}, col={col}, å€¼={cell_value})!")
                            found_yellow_in_sheet = True
                            break
                    if found_yellow_in_sheet:
                        break
                
                if found_yellow_in_sheet:
                                wb.close()
                                return True

            wb.close()
            print(f"[DEBUG] âŒ åœ¨æª”æ¡ˆ {filepath} ä¸­æ²’æœ‰æ‰¾åˆ°é»ƒè‰²æ¨™è¨˜")
            return False
        except Exception as e:
            print(
    f"[DEBUG] Error checking yellow highlight in {filepath}: {e}")
            return False

    def _analyze_file_skip_reason(
    self,
    filepath,
    start_of_period,
     end_of_period):
        """åˆ†æç‚ºä½•æœªæª¢å‡ºé»ƒè‰²æ¨™è¨˜ï¼Œå›å‚³ç°¡æ½”åŸå› å­—ä¸²ã€‚"""
        import openpyxl
        from datetime import datetime
        try:
            wb = openpyxl.load_workbook(filepath, data_only=True)
            any_week_cols = False
            any_product_rows = False
            any_numeric_under_week = False
            for sheet_name in wb.sheetnames:
                ws = wb[sheet_name]
                if hasattr(ws, 'sheet_state') and ws.sheet_state != "visible":
                    continue
                week_cols = []
                date_row = None
                for row in range(1, min(50, ws.max_row + 1)):
                    for col in range(6, 25):
                        val = ws.cell(row=row, column=col).value
                        d = self._parse_date_value(val, start_of_period.year)
                        if d and start_of_period.date() <= d <= end_of_period.date():
                            week_cols.append(col)
                    if week_cols:
                        date_row = row
                        any_week_cols = True
                        break
                if not week_cols:
                    continue
                # æƒç”¢å“åˆ—
                for r in range((date_row or 1) + 1,
                               min((date_row or 1) + 80, ws.max_row + 1)):
                    prod = ws.cell(row=r, column=5).value
                    if prod and str(prod).strip() != "":
                        any_product_rows = True
                        for c in week_cols:
                            v = ws.cell(row=r, column=c).value
                            try:
                                if isinstance(
    v, (int, float)) and float(v) != 0:
                                    any_numeric_under_week = True
                                    raise StopIteration
                                if isinstance(v, str) and v.strip() != "":
                                    if v.replace(
    '.', '', 1).isdigit() and float(v) != 0:
                                        any_numeric_under_week = True
                                        raise StopIteration
                            except StopIteration:
                                break
                        if any_numeric_under_week:
                            break
                if any_numeric_under_week:
                    break
        except Exception:
            return "æª”æ¡ˆè®€å–æˆ–åˆ†æå¤±æ•—"
        finally:
            try:
                wb.close()
            except Exception:
                pass
        if not any_week_cols:
            return "æœªåµæ¸¬åˆ°æœ¬é€±æ—¥æœŸæ¬„"
        if not any_product_rows:
            return "æœªæ‰¾åˆ°ç”¢å“è¡Œ"
        if not any_numeric_under_week:
            return "æœ¬é€±æ—¥æœŸä¸‹æœªç™¼ç¾æ•¸é‡"
        return "å­˜åœ¨æ•¸é‡ä½†æœªæ¨™é»ƒ"

    def run_automation(
    self,
    source_folder,
    supplier_folder,
    log_callback=None,
     mapping_callback=None):
        from datetime import datetime, timedelta
        import os
        import openpyxl
        import xlwings as xw
        import traceback

        now = datetime.now()
        today = now.date()
        this_monday = today - timedelta(days=today.weekday())
        this_sunday = this_monday + timedelta(days=6)  # æœ¬å‘¨æ—¥
        start_of_period = datetime.combine(this_monday, datetime.min.time())
        end_of_period = datetime.combine(this_sunday, datetime.max.time())
        save_path = os.path.join(
    source_folder, f"yellow_highlight_order_log_{
        now.strftime('%Y%m%d_%H%M%S')}.txt")
        log_lines = [
            f"ğŸ¯ Amendment Order Integration Log\n",
            f"Scan Start Time: {now}\n",
            f"Target Week: {
    start_of_period.strftime('%Y-%m-%d')} to {
        end_of_period.strftime('%Y-%m-%d')}\n"
        ]

        def log(message, include_timestamp=True):
            timestamp = datetime.now().strftime("%H:%M:%S") if include_timestamp else ""
            log_line = f"[{timestamp}] {message}" if include_timestamp else message
            log_lines.append(log_line + "\n")
            if log_callback:
                log_callback(log_line + "\n")

        files = [f for f in os.listdir(source_folder) if f.endswith(
            (".xlsx", ".xls")) and not f.startswith("~$")]
        total_files = len(files)
        if total_files == 0:
            log("æœªæ‰¾åˆ°Excelæ–‡ä»¶\nNo Excel files found in source folder. Exiting.")
            return False, "åœ¨æºæ–‡ä»¶å¤¹ä¸­æœªæ‰¾åˆ°Excelæ–‡ä»¶"
        log(f"æ‰¾åˆ° {total_files} ä¸ªExcelæ–‡ä»¶\nFound {total_files} Excel files")
        log(f"ç›®æ ‡å‘¨æœŸ: {start_of_period.strftime('%Y-%m-%d')} åˆ° {end_of_period.strftime('%Y-%m-%d')}")
        log(f"ğŸ” å°ˆæ³¨æ–¼æœ¬é€±è¨‚å–®ï¼Œå¿½ç•¥å…¶ä»–é€±æœŸ")

        # 1. æ‰¾å‡ºæ‰€æœ‰æœ‰é»ƒè‰²æ¨™è¨˜çš„ (é–€å¸‚, å» å•†) sheet
        supplier_to_outlets = {}  # supplier: set(outlet)
        outlet_to_suppliers = {}  # outlet: set(supplier) - ç”¨äºæ˜¾ç¤ºæ¯ä¸ªé—¨å¸‚çš„æ”¹å•è¯¦æƒ…
        for filename in files:
            filepath = os.path.join(source_folder, filename)
            print(f"[DEBUG] ğŸ” è™•ç†æ–‡ä»¶: {filename}")
            try:
                # ä½¿ç”¨ä¿®å¾©å¾Œçš„æ–¹æ³•æª¢æŸ¥æª”æ¡ˆæ˜¯å¦æœ‰æœ¬é€±çš„é»ƒè‰²æ¨™è¨˜
                if self.check_file_has_yellow_highlight(
                    filepath, start_of_period, end_of_period):
                    wb = openpyxl.load_workbook(filepath, data_only=True)
                    print(f"[DEBUG] ğŸ“‹ æ–‡ä»¶ {filename} åŒ…å«å·¥ä½œè¡¨: {', '.join(wb.sheetnames)}")
                    found_yellow_in_file = False
                    for sheetname in wb.sheetnames:
                        print(f"[DEBUG] ğŸ” æª¢æŸ¥å·¥ä½œè¡¨: {sheetname}")
                        ws = wb[sheetname]
                        # è·³ééš±è— sheet
                        if hasattr(
    ws, 'sheet_state') and ws.sheet_state != "visible":
                            print(f"[DEBUG] âš ï¸ è·³ééš±è—å·¥ä½œè¡¨: {sheetname}")
                            continue
                        # ç›´æ¥æœå°‹æ‰€æœ‰è¡Œï¼Œå°‹æ‰¾æœ¬é€±çš„æ—¥æœŸå’Œé»ƒè‰²æ¨™è¨˜ï¼ˆèˆ‡æª”æ¡ˆç´šæª¢æ¸¬åŒæ¨£çš„å¯¬é¬†ç¯„åœï¼‰
                        found_yellow_in_sheet = False
                        # æœå°‹æ‰€æœ‰è¡Œï¼Œæ”¶é›†æ‰€æœ‰æœ¬é€±çš„æ—¥æœŸæ¬„ä½ï¼ˆå¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒè¡Œï¼‰
                        sheet_this_week_columns = set()
                        
                        # æ”¶é›†æœ¬å‘¨æ—¥æœŸåˆ—
                        for row in range(1, min(200, ws.max_row + 1)):
                            # åœ¨æ¯ä¸€è¡Œä¸­å°‹æ‰¾æœ¬é€±çš„æ—¥æœŸæ¬„ä½
                            for col in range(5, 30):  # E~AD æ¬„
                                date_cell = ws.cell(row=row, column=col)
                                if date_cell.value:
                                    try:
                                        from datetime import datetime
                                        # å˜—è©¦è§£ææ—¥æœŸ
                                        if isinstance(
                                            date_cell.value, datetime):
                                            cell_date = date_cell.value.date()
                                        elif isinstance(date_cell.value, str):
                                            # å˜—è©¦è§£æå­—ç¬¦ä¸²æ—¥æœŸï¼Œå¦‚ "1-Aug", "2-Aug" ç­‰
                                            import re
                                            date_match = re.search(
                                                r'(\d+)-(\w+)', str(date_cell.value))
                                            if date_match:
                                                day = int(date_match.group(1))
                                                month_str = date_match.group(2)
                                                # ç°¡å–®çš„æœˆä»½æ˜ å°„
                                                month_map = {
                                                    'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6,
                                                    'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
                                                }
                                                if month_str in month_map:
                                                    month = month_map[month_str]
                                                    # æ ¹æ®æœˆä»½åˆ¤æ–­å¹´ä»½ï¼šå¦‚æœæœˆä»½å°äºå½“å‰æœˆä»½ï¼Œå¯èƒ½æ˜¯ä¸‹ä¸€å¹´
                                                    current_month = start_of_period.month
                                                    if month < current_month:
                                                        year = start_of_period.year + 1
                                                    else:
                                                        year = start_of_period.year
                                                    cell_date = datetime(
                                                        year, month, day).date()
                                                else:
                                                    continue
                                            else:
                                                continue
                                        else:
                                            continue

                                        # æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ¬é€±ç¯„åœå…§
                                        if start_of_period.date() <= cell_date <= end_of_period.date():
                                            sheet_this_week_columns.add(col)
                                            print(
    f"[DEBUG] ğŸ“… æ‰¾åˆ°æœ¬é€±æ—¥æœŸ: {cell_date} åœ¨åˆ— {col}")
                                        else:
                                            print(
    f"[DEBUG] âš ï¸ è·³ééæœ¬é€±æ—¥æœŸ: {cell_date} åœ¨åˆ— {col}")
                                    except Exception as e:
                                        continue

                        # å¦‚æœæˆ‘å€‘åˆ°é”é€™è£¡ï¼Œèªªæ˜å·²ç¶“æª¢æŸ¥äº†æ‰€æœ‰è¡Œ
                        # æª¢æŸ¥æ˜¯å¦æ‰¾åˆ°äº†ä»»ä½•æœ¬å‘¨æ—¥æœŸåˆ—
                        if not sheet_this_week_columns:
                            print(f"[DEBUG] âŒ å·¥ä½œè¡¨ {sheetname} æœªæ‰¾åˆ°ä»»ä½•æœ¬é€±æ—¥æœŸæ¬„ä½")
                            continue

                        print(f"[DEBUG] å·¥ä½œè¡¨ {sheetname} æœ¬é€±æ—¥æœŸæ¬„ä½ç¸½è¨ˆ: {sorted(sheet_this_week_columns)}")

                        # æ‰¾åˆ°æœ¬å‘¨æ—¥æœŸæ‰€åœ¨çš„è¡Œï¼Œç„¶ååªæ£€æŸ¥è¯¥è¡Œä»¥ä¸‹çš„100è¡Œ
                        this_week_date_rows = set()
                        for row in range(1, min(200, ws.max_row + 1)):
                            for col in range(5, 30):  # E~AD æ¬„
                                date_cell = ws.cell(row=row, column=col)
                                if date_cell.value:
                                    try:
                                        from datetime import datetime
                                        # å˜—è©¦è§£ææ—¥æœŸ
                                        if isinstance(date_cell.value, datetime):
                                            cell_date = date_cell.value.date()
                                        elif isinstance(date_cell.value, str):
                                            import re
                                            date_match = re.search(r'(\d+)-(\w+)', str(date_cell.value))
                                            if date_match:
                                                day = int(date_match.group(1))
                                                month_str = date_match.group(2)
                                                month_map = {
                                                    'Jan': 1, 'Feb': 2, 'Mar': 3, 'Apr': 4, 'May': 5, 'Jun': 6,
                                                    'Jul': 7, 'Aug': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dec': 12
                                                }
                                                if month_str in month_map:
                                                    month = month_map[month_str]
                                                    current_month = start_of_period.month
                                                    if month < current_month:
                                                        year = start_of_period.year + 1
                                                    else:
                                                        year = start_of_period.year
                                                    cell_date = datetime(year, month, day).date()
                                                else:
                                                    continue
                                            else:
                                                continue
                                        else:
                                            continue

                                        # æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æœ¬é€±ç¯„åœå…§
                                        if start_of_period.date() <= cell_date <= end_of_period.date():
                                            this_week_date_rows.add(row)
                                            print(f"[DEBUG] ğŸ“… æ‰¾åˆ°æœ¬é€±æ—¥æœŸè¡Œ: {row}, æ—¥æœŸ: {cell_date}")
                                    except Exception as e:
                                        continue

                        if not this_week_date_rows:
                            print(f"[DEBUG] âŒ å·¥ä½œè¡¨ {sheetname} æœªæ‰¾åˆ°ä»»ä½•æœ¬é€±æ—¥æœŸè¡Œ")
                            continue

                        # æ‰¾åˆ°æœ€æ—©çš„æœ¬å‘¨æ—¥æœŸè¡Œ
                        start_row = min(this_week_date_rows)
                        end_row = min(start_row + 100, ws.max_row + 1)
                        print(f"[DEBUG] æª¢æŸ¥ç¯„åœ: ç¬¬{start_row}è¡Œåˆ°ç¬¬{end_row}è¡Œ")

                        # åªæª¢æŸ¥æœ¬å‘¨æ—¥æœŸè¡Œä»¥ä¸‹çš„100è¡Œ
                        for check_row in range(start_row, end_row):
                                # æª¢æŸ¥æ˜¯å¦ç‚ºç”¢å“è¡Œï¼ˆé€šå¸¸æœ‰ç”¢å“åç¨±ï¼‰
                            product_name = ws.cell(row=check_row, column=5).value  # E æ¬„ç”¢å“åç¨±
                            if not product_name or str(product_name).strip() == "":
                                    continue

                            print(f"[DEBUG] æª¢æŸ¥ç”¢å“è¡Œ: {check_row}, ç”¢å“: {product_name}")

                            # æª¢æŸ¥æœ¬é€±çš„æ—¥æœŸæ¬„ä½ï¼ˆå³ä½¿æ²’æœ‰è¼¸å…¥æ•¸å­—ï¼Œåªè¦æ¨™é»ƒå°±ç´å…¥ï¼‰
                            for col in sorted(sheet_this_week_columns):
                                if self.has_yellow_highlight(ws, check_row, col):
                                    print(f"[DEBUG] ğŸŸ¡ åœ¨å·¥ä½œè¡¨ {sheetname} ç¬¬{check_row}è¡Œç¬¬{col}æ¬„æ‰¾åˆ°é»ƒè‰²æ¨™è¨˜")
                                    found_yellow_in_sheet = True
                                    found_yellow_in_file = True
                                    break
                            if found_yellow_in_sheet:
                                break

                        if found_yellow_in_sheet:
                            # æ­£ç¢ºé‚è¼¯ï¼šæ–‡ä»¶åæ˜¯é–€å¸‚åç¨±ï¼Œå·¥ä½œè¡¨åæ˜¯ä¾›æ‡‰å•†åç¨±
                            outlet_name = filename.split("_Amendment_")[
                                                         0] if "_Amendment_" in filename else filename
                            supplier_name = sheetname
                            supplier_to_outlets.setdefault(
                                supplier_name, set()).add(filepath)
                            # è®°å½•é—¨å¸‚åˆ°ä¾›åº”å•†çš„æ˜ å°„
                            outlet_to_suppliers.setdefault(
                                outlet_name, set()).add(supplier_name)
                            log(f"âœ… {filename} (é–€å¸‚: {outlet_name}) ç™¼ç¾æœ¬é€±é»ƒè‰²æ¨™è¨˜: {sheetname} (ä¾›æ‡‰å•†)")
                            print(
    f"[DEBUG] ğŸ” è©³ç´°ä¿¡æ¯: å·¥ä½œè¡¨={sheetname}, é–€å¸‚={outlet_name}, ä¾›æ‡‰å•†={supplier_name}")
                            print(f"[DEBUG] ğŸ¯ å·¥ä½œè¡¨ {sheetname} è¢«æ¨™è¨˜ç‚ºæœ‰é»ƒè‰²æ¨™è¨˜")
                            # ä¸è¦breakï¼Œç»§ç»­æ£€æŸ¥å…¶ä»–å·¥ä½œè¡¨ï¼Œå› ä¸ºä¸€ä¸ªæ–‡ä»¶å¯èƒ½æœ‰å¤šä¸ªä¾›åº”å•†çš„é»„è‰²æ ‡è®°
                        else:
                            print(f"[DEBUG] âŒ å·¥ä½œè¡¨ {sheetname} æœªç™¼ç¾é»ƒè‰²æ¨™è¨˜")

                    if found_yellow_in_file:
                        wb.close()
                    else:
                        # æ²’æœ‰æ‰¾åˆ°é»ƒè‰²æ¨™è¨˜ï¼Œè·³éæ­¤æ–‡ä»¶
                        reason = self._analyze_file_skip_reason(
                            filepath, start_of_period, end_of_period)
                        print(f"[DEBUG] âŒ æ–‡ä»¶ {filename} æ²’æœ‰é»ƒè‰²æ¨™è¨˜ï¼ŒåŸå› : {reason}")
                        log(f"â­ï¸ {filename} æ²’æœ‰æœ¬é€±é»ƒè‰²æ¨™è¨˜ï¼Œè·³éï¼ˆåŸå› ï¼š{reason}ï¼‰")
            except Exception as e:
                print(f"[DEBUG] âŒ æª¢æŸ¥æ–‡ä»¶ {filename} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
                log(f"âŒ æª¢æŸ¥ {filename} ç™¼ç”ŸéŒ¯èª¤: {e}")
        log("")
        log(f"ğŸ“Š çµ±è¨ˆçµæœ:")
        log(f"   - ç¸½æª”æ¡ˆæ•¸: {len(files)}")
        log(f"   - æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†: {len(supplier_to_outlets)}")
        log("")
        if not supplier_to_outlets:
            log("âŒ æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†")
            return False, "æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰é»ƒè‰²æ¨™è¨˜çš„å» å•†"

        # æ·»åŠ è©³ç´°çš„ä¾›æ‡‰å•†å’Œæ–‡ä»¶åˆ—è¡¨
        log(f"ğŸ“‹ å‘ç°é»„è‰²æ ‡è®°çš„ä¾›åº”å•†:")
        for supplier, file_paths in supplier_to_outlets.items():
            log(f"   - {supplier}: {len(file_paths)} ä¸ªæ–‡ä»¶")
            for file_path in sorted(file_paths):
                filename = os.path.basename(file_path)
                log(f"     ğŸ“„ {filename}")
        log("")

        # æ·»åŠ é—¨å¸‚æ”¹å•è¯¦æƒ…
        log(f"ğŸª é—¨å¸‚æ”¹å•è¯¦æƒ…:")
        for outlet, suppliers in sorted(outlet_to_suppliers.items()):
            supplier_list = ", ".join(sorted(suppliers))
            log(f"   {outlet} - {supplier_list}")
        log("")

        log(f"ğŸ“‹ æº–å‚™æ•´åˆä»¥ä¸‹å» å•†:")
        for supplier in supplier_to_outlets:
            log(f"   - {supplier}")
        log("")
        # 2. ä»¥å» å•†ç‚ºå–®ä½åˆä½µæ‰€æœ‰æœ‰é»ƒè‰²æ¨™è¨˜çš„é–€å¸‚çš„è©²å» å•† sheetï¼ˆç”¨ xlwings è¤‡è£½ sheetï¼Œä¿ç•™æ ¼å¼/å…¬å¼ï¼‰
        supplier_files = []
        for supplier, filelist in supplier_to_outlets.items():
            try:
                # ç”Ÿæˆæœˆä»½-æ˜ŸæœŸæ ¼å¼çš„æ–‡ä»¶å
                month_abbr = now.strftime('%b')
                week_in_month = ((now.day - 1) // 7) + 1
                supplier_path = os.path.join(
                    supplier_folder, f"{supplier}_Amendment_{month_abbr}_Week_{week_in_month}.xlsx")
                # å…ˆå»ºç«‹ç©ºæª”æ¡ˆ
                if not os.path.exists(supplier_path):
                    from openpyxl import Workbook
                    wb = Workbook()
                    wb.save(supplier_path)
                app = xw.App(visible=False)
                try:
                    wb_dest = app.books.open(supplier_path)
                    for src_file in filelist:
                        try:
                            wb_src = app.books.open(src_file)
                            if supplier in [sht.name for sht in wb_src.sheets]:
                                sht = wb_src.sheets[supplier]
                                # å¾æ–‡ä»¶åä¸­æå–é–€å¸‚åç¨±
                                filename = os.path.splitext(
                                    os.path.basename(src_file))[0]
                                if "_Amendment_" in filename:
                                    outlet_name = filename.split(
                                        "_Amendment_")[0]
                                else:
                                    outlet_name = filename
                                # ç›®æ¨™å·¥ä½œè¡¨åæ‡‰è©²æ˜¯é–€å¸‚åç¨±
                                dest_sheet_name = outlet_name
                                # åˆªé™¤åŒååˆ†é ï¼ˆä½†è¦ç¢ºä¿è‡³å°‘ä¿ç•™ä¸€å€‹å·¥ä½œè¡¨ï¼‰
                                sheets_to_delete = []
                                for s in wb_dest.sheets:
                                    if s.name == dest_sheet_name:
                                        sheets_to_delete.append(s)
                                
                                # åªæœ‰åœ¨æœ‰å¤šå€‹å·¥ä½œè¡¨æ™‚æ‰åˆªé™¤
                                if len(wb_dest.sheets) > 1:
                                    for s in sheets_to_delete:
                                        s.delete()
                                sht.api.Copy(Before=wb_dest.sheets[0].api)
                                # æª¢æŸ¥æ–°è¤‡è£½çš„å·¥ä½œè¡¨åç¨±æ˜¯å¦è¡çªï¼Œå¦‚æœè¡çªå‰‡æ·»åŠ å¾Œç¶´
                                new_sheet = wb_dest.sheets[0]
                                original_name = dest_sheet_name
                                counter = 1
                                while any(s.name == dest_sheet_name for s in wb_dest.sheets if s != new_sheet):
                                    dest_sheet_name = f"{original_name}_{counter}"
                                    counter += 1
                                new_sheet.name = dest_sheet_name
                            else:
                                # å¦‚æœåªæœ‰ä¸€å€‹å·¥ä½œè¡¨ï¼Œç›´æ¥è¤‡è£½ä¸¦é‡å‘½å
                                sht.api.Copy(Before=wb_dest.sheets[0].api)
                                # æª¢æŸ¥æ–°è¤‡è£½çš„å·¥ä½œè¡¨åç¨±æ˜¯å¦è¡çªï¼Œå¦‚æœè¡çªå‰‡æ·»åŠ å¾Œç¶´
                                new_sheet = wb_dest.sheets[0]
                                original_name = dest_sheet_name
                                counter = 1
                                while any(s.name == dest_sheet_name for s in wb_dest.sheets if s != new_sheet):
                                    dest_sheet_name = f"{original_name}_{counter}"
                                    counter += 1
                                new_sheet.name = dest_sheet_name
                                log(
    f"    ğŸ“‹ å·²è¤‡è£½ä¾›æ‡‰å•† {supplier} å·¥ä½œè¡¨åˆ°é–€å¸‚ {dest_sheet_name} å·¥ä½œè¡¨")
                            wb_src.close()
                        except Exception as e:
                            log(
    f"    âŒ Failed to copy {supplier} in {
        os.path.basename(src_file)}: {
            str(e)}\n{
                traceback.format_exc()}")
                    # åˆªé™¤ç©ºç™½çš„ Sheetï¼ˆå¦‚æœå­˜åœ¨ä¸”æœ‰å…¶ä»–å·¥ä½œè¡¨ï¼‰
                    try:
                        if len(wb_dest.sheets) > 1:  # ç¢ºä¿ä¸æ˜¯å”¯ä¸€çš„å·¥ä½œè¡¨
                            sheets_to_delete = []
                            for sheet in wb_dest.sheets:
                                if sheet.name in ['Sheet', 'Sheet1']:
                                    # æª¢æŸ¥å·¥ä½œè¡¨æ˜¯å¦çœŸçš„æ˜¯ç©ºç™½çš„
                                    is_empty = True
                                    try:
                                        if sheet.used_range is not None:
                                            # æª¢æŸ¥ used_range ä¸­æ˜¯å¦æœ‰å¯¦éš›æ•¸æ“š
                                            for row in sheet.used_range.rows:
                                                for cell in row:
                                                    if cell.value is not None and str(
                                                        cell.value).strip() != "":
                                                        is_empty = False
                                                        break
                                                if not is_empty:
                                                    break
                                    except:
                                        # å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œå‡è¨­ä¸æ˜¯ç©ºç™½çš„
                                        is_empty = False

                                    if is_empty:
                                        sheets_to_delete.append(sheet)

                            # åˆªé™¤ç©ºç™½å·¥ä½œè¡¨
                            for sheet in sheets_to_delete:
                                sheet.delete()
                                log(f"  ğŸ—‘ï¸ å·²åˆªé™¤ç©ºç™½å·¥ä½œè¡¨: {sheet.name}")

                    except Exception as e:
                        # é™é»˜å¤„ç†åˆ é™¤ç©ºç™½å·¥ä½œè¡¨æ—¶çš„é”™è¯¯ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        pass

                    wb_dest.save()
                    wb_dest.close()
                    supplier_files.append(os.path.basename(supplier_path))
                    log(f"  âœ… å·²æ•´åˆ: {os.path.basename(supplier_path)}")
                finally:
                    app.quit()
            except Exception as e:
                log(f"âŒ æ•´åˆ {supplier} ç™¼ç”ŸéŒ¯èª¤: {e}\n{traceback.format_exc()}")
        result_text = f"\nğŸ¯ æœ¬é€±è¨‚å–®æ•´åˆå®Œæˆ / Amendment Order Integration Complete:\n"
        result_text += f"ğŸ“¦ å·²è™•ç†ä¾›æ‡‰å•†æ–‡ä»¶: {len(supplier_files)}\n"
        result_text += f"ğŸ“… ç›®æ¨™é€±æœŸ: {
    this_monday.strftime('%Y-%m-%d')} åˆ° {
        this_sunday.strftime('%Y-%m-%d')}\n\n"
        result_text += "ğŸ“‹ ä¾›æ‡‰å•†æ–‡ä»¶åˆ—è¡¨:\n" + \
            "\n".join([f"  âœ… {file}" for file in supplier_files])
        log(result_text)
        try:
            with open(save_path, "w", encoding="utf-8") as logfile:
                logfile.writelines(log_lines)
            log(f"\nLog saved at: {save_path}")
            return True, f"Amendment Order æ•´åˆå®Œæˆï¼\n\næ—¥å¿—æ–‡ä»¶ä¿å­˜è‡³:\n{save_path}\n\n{result_text}"
        except Exception as e:
            log(f"âŒ Failed to write log file: {e}")
            return False, f"Amendment Order æ•´åˆå®Œæˆä½†æ—¥å¿—ä¿å­˜å¤±è´¥:\n{str(e)}"

# ========== ä¸»åº”ç”¨ç¨‹åº ==========


class SushiExpressApp(ctk.CTk):
    """ä¸»åº”ç”¨ç¨‹åº"""

    def __init__(self):
        super().__init__()
        self.title(f"Sushi Express Automation Tool v{VERSION}")
        self.geometry("1400x900")
        self.minsize(1200, 800)
        self.configure(fg_color=DARK_BG)
        self.iconbitmap(resource_path("SELOGO22 - 01.ico"))
        self.protocol("WM_DELETE_WINDOW", self._on_close)
        # åˆå§‹åŒ–æ‰€æœ‰ç”¨åˆ°çš„ StringVar
        self.download_folder_var = ctk.StringVar()
        self.config_file_var = ctk.StringVar()
        self.checklist_folder_var = ctk.StringVar()
        self.master_config_var = ctk.StringVar()
        self.folder_vars = {}
        self.master_file_var = ctk.StringVar()
        self.output_folder_var = ctk.StringVar()
        self.email_supplier_folder_var = ctk.StringVar()
        self.email_master_config_var = ctk.StringVar()
        self.demerit_file_var = ctk.StringVar()
        self.progress_popup = None
        self.mapping_popup = None
        self.outlet_config_var = ctk.StringVar()
        self.email_dialogs = []
        self.current_function = None
        self.nav_buttons = {}
        self.selected_outlook_account_idx = None
        self.checklist_search_var = ctk.StringVar()
        self._setup_ui()
        self.show_login()

    def _setup_ui(self):
        self.main_container = ctk.CTkFrame(self, fg_color="transparent")
        self.main_container.pack(fill="both", expand=True, padx=20, pady=20)

        # å·¦å´å°èˆªæ¬„
        self.nav_frame = ctk.CTkFrame(
            self.main_container,
            fg_color=DARK_PANEL,
            corner_radius=24,
            width=300
        )
        self.nav_frame.pack(side="left", fill="y", padx=(0, 10), pady=10)
        self.nav_frame.pack_propagate(False)

        # åŠ å…¥ LOGO
        logo_img = load_image(LOGO_PATH, max_size=(220, 80))
        if logo_img:
            logo_label = ctk.CTkLabel(self.nav_frame, image=logo_img, text="")
            logo_label.image = logo_img  # é˜²æ­¢è¢«åƒåœ¾å›æ”¶
            logo_label.pack(pady=(18, 8))

        nav_title = ctk.CTkLabel(
            self.nav_frame,
            text="åŠŸèƒ½èœå•\nFunction Menu",
            font=FONT_TITLE,
            text_color=ACCENT_BLUE,
            justify="center"
        )
        nav_title.pack(pady=20)
        ctk.CTkFrame(
    self.nav_frame,
    height=2,
    fg_color=ACCENT_BLUE).pack(
        fill="x",
        padx=20,
         pady=10)

        # æŒ‰éˆ•å®¹å™¨
        self.button_container = ctk.CTkFrame(
    self.nav_frame, fg_color="transparent")
        self.button_container.pack(fill="both", expand=True, padx=10, pady=10)

        # å³å´å…§å®¹å€
        self.content_container = ctk.CTkFrame(
            self.main_container,
            fg_color=DARK_PANEL,
            corner_radius=24
        )
        self.content_container.pack(
    side="right",
    fill="both",
    expand=True,
    padx=10,
     pady=10)
        self.content_container.pack_propagate(False)

        # å³å´å…§å®¹å€çš„æ¨™é¡Œå€åŸŸ
        self.content_header = ctk.CTkFrame(
    self.content_container, fg_color="transparent")
        self.content_header.pack(fill="x", padx=20, pady=20)

        self.function_title = ctk.CTkLabel(
            self.content_header,
            text="",
            font=FONT_TITLE,
            text_color=ACCENT_BLUE
        )
        self.function_title.pack(side="left")

        self.function_subtitle = ctk.CTkLabel(
            self.content_header,
            text="",
            font=FONT_SUB,
            text_color=TEXT_COLOR
        )
        self.function_subtitle.pack(side="left", padx=20)

        # å³ä¾§å†…å®¹åŒºçš„ä¸»ä½“
        self.content_body = ctk.CTkFrame(
    self.content_container, fg_color="transparent")
        self.content_body.pack(fill="both", expand=True, padx=20, pady=20)

        # æ·»åŠ è¿”å›ä¸»èœå•æŒ‰é’®
        back_frame = ctk.CTkFrame(
    self.content_container,
     fg_color="transparent")
        back_frame.pack(fill="x", padx=20, pady=10)
        ctk.CTkButton(
            back_frame,
            text="è¿”å›ä¸»èœå•\nBack to Main Menu",
            command=self.show_main_menu,
            fg_color=ACCENT_PURPLE,
            hover_color=BTN_HOVER
        ).pack(side="right")

    def _on_close(self):
        print("on_close called")
        self.destroy()

    def show_login(self):
        """æ˜¾ç¤ºç™»å½•ç•Œé¢"""
        for w in self.content_container.winfo_children():
            if w != self.content_header and w != self.content_body:
                w.destroy()

        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # åˆ›å»ºç™»å½•ç•Œé¢
        login_frame = ctk.CTkFrame(
            self.content_body,
            fg_color=DARK_PANEL,
            corner_radius=24,
            width=450,
            height=400
        )
        login_frame.place(relx=0.5, rely=0.5, anchor="center")

        self.pwd_entry = ctk.CTkEntry(
            login_frame,
            show="*",
            font=FONT_MID,  # æ”¹æˆè¼ƒå°å­—é«”
            width=300,
            placeholder_text=t("password"),
            fg_color=ENTRY_BG,
            height=45
        )
        self.pwd_entry.pack(pady=(40, 20))
        self.pwd_entry.bind("<Return>", lambda e: self._try_login())

        ctk.CTkButton(
            login_frame,
            text=t("login_btn"),
            command=self._try_login,
            width=200,
            font=FONT_BIGBTN
        ).pack(pady=(0, 20))

        ctk.CTkLabel(
            login_frame,
            text=f"Version {VERSION} | {DEVELOPER}",
            font=FONT_MID,
            text_color="#64748B"
        ).pack(side="bottom", pady=10)

        # è®¾ç½®æ ‡é¢˜
        self.function_title.configure(
    text="ç³»ç»Ÿç™»å½•\nSystem Login", font=FONT_TITLE)
        self.function_subtitle.configure(
    text="è¯·è¾“å…¥å¯†ç é€²å…¥ç³»ç»Ÿ\nPlease enter password to access the system",
     font=FONT_MID)

    def _try_login(self):
        """å°è¯•ç™»å½•"""
        if self.pwd_entry.get() == PASSWORD:
            self.show_main_menu()
        else:
            messagebox.showerror(t("error"), t("incorrect_pw"))

    def show_main_menu(self):
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®æ ‡é¢˜
        self.function_title.configure(text="é¸æ“‡åŠŸèƒ½åˆ†é¡\nSelect Function Category")
        self.function_subtitle.configure(
    text="è«‹é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„åŠŸèƒ½åˆ†é¡\nPlease select the function category you want to use")

        # åˆ›å»ºåŠŸèƒ½é€‰æ‹©ç•Œé¢
        self._create_function_category_selection()

        # æ¸…ç©ºå·¦ä¾§å¯¼èˆªï¼Œæ˜¾ç¤ºç®€å•çš„logoå’Œæ ‡é¢˜
        self._create_simple_navigation()

    def _create_function_category_selection(self):
        """åˆ›å»ºåŠŸèƒ½åˆ†ç±»é€‰æ‹©ç•Œé¢ - ä¸‰åˆ—å¸ƒå±€"""
        # ä¸»å®¹å™¨ - å‡å°‘ä¸Šä¸‹è¾¹è·
        main_container = ctk.CTkFrame(
    self.content_body, fg_color="transparent")
        main_container.pack(fill="both", expand=True, padx=20, pady=10)

        # æ¬¢è¿æ ‡é¢˜åŒºåŸŸ - å‡å°‘ä¸‹è¾¹è·
        welcome_frame = ctk.CTkFrame(main_container, fg_color="transparent")
        welcome_frame.pack(fill="x", pady=(0, 15))

        welcome_title = ctk.CTkLabel(
            welcome_frame,
            text=t("main_title"),
            font=("Microsoft YaHei", 16, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color=ACCENT_BLUE,
            justify="center"
        )
        welcome_title.pack(pady=(0, 5))

        # åŠŸèƒ½åˆ†ç±»å®¹å™¨ - ä¸‰åˆ—å¸ƒå±€ï¼Œå‡å°‘ä¸Šä¸‹è¾¹è·
        categories_container = ctk.CTkFrame(
    main_container, fg_color="transparent")
        categories_container.pack(fill="both", expand=True, pady=10)

        # å·¦ä¾§ - è®¢å•åŠŸèƒ½
        left_frame = ctk.CTkFrame(categories_container, fg_color="transparent")
        left_frame.pack(side="left", fill="both", expand=True, padx=(0, 10))

        self._create_ordering_category_card(left_frame)

        # ä¸­é—´ - æœˆç»“åŠŸèƒ½
        middle_frame = ctk.CTkFrame(categories_container, fg_color="transparent")
        middle_frame.pack(side="left", fill="both", expand=True, padx=(0, 10))

        self._create_monthend_category_card(middle_frame)

        # å³ä¾§ - æ•°æ®åˆ†æåŠŸèƒ½
        right_frame = ctk.CTkFrame(categories_container, fg_color="transparent")
        right_frame.pack(side="right", fill="both", expand=True, padx=(10, 0))

        self._create_data_analysis_category_card(right_frame)

        # åº•éƒ¨é€€å‡ºæŒ‰é’® - å‡å°‘ä¸Šè¾¹è·
        exit_frame = ctk.CTkFrame(main_container, fg_color="transparent")
        exit_frame.pack(fill="x", pady=(15, 0))  # å‡å°‘ä¸Šè¾¹è·

        exit_btn = ctk.CTkButton(
            exit_frame,
            text=t("exit_system"),
            command=self._on_close,
            fg_color="#64748b",
            hover_color="#475569",
            font=("Microsoft YaHei", 12, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="white",
            width=160,  # ç¨å¾®ç¼©å°å®½åº¦
            height=45,  # ç¨å¾®ç¼©å°é«˜åº¦
            corner_radius=10
        )
        exit_btn.pack()

    def _create_data_analysis_category_card(self, parent):
        """åˆ›å»ºæ•°æ®åˆ†æåŠŸèƒ½åˆ†ç±»å¡ç‰‡"""
        # å¡ç‰‡å®¹å™¨ - åŠ å¤§å°ºå¯¸
        card = ctk.CTkFrame(
            parent,
            fg_color="#7c3aed",
            corner_radius=25,
            border_width=4,
            border_color="#8b5cf6"
        )
        card.pack(fill="both", expand=True, padx=5, pady=5)

        # å›¾æ ‡ - ç¼©å°é—´è·
        icon_label = ctk.CTkLabel(
            card,
            text="ğŸ“ˆ",
            font=("Microsoft YaHei", 48),  # ç¨å¾®ç¼©å°å›¾æ ‡
            text_color="white"
        )
        icon_label.pack(pady=(20, 8))  # å‡å°‘ä¸Šä¸‹è¾¹è·

        # æ ‡é¢˜ - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°é—´è·
        title_label = ctk.CTkLabel(
            card,
            text="æ•¸æ“šåˆ†æ\nData Analysis",
            font=("Microsoft YaHei", 20, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="white",
            justify="center"
        )
        title_label.pack(pady=(0, 12))  # å‡å°‘ä¸‹è¾¹è·

        # åŠŸèƒ½åˆ—è¡¨ - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°è¡Œé—´è·
        features_text = (
            "ğŸ“Š POS æ•¸æ“šåˆ†æ\n    POS Data Analysis\n"
            "ğŸ“ˆ éŠ·å”®è¶¨å‹¢åˆ†æ\n    Sales Trend Analysis\n"
            "ğŸ’° æˆæœ¬æ•ˆç›Šåˆ†æ\n    Cost-Benefit Analysis\n"
            "ğŸ“‹ å ±è¡¨ç”Ÿæˆå·¥å…·\n    Report Generation Tools\n"
            "ğŸ” æ•¸æ“šæŒ–æ˜åŠŸèƒ½\n    Data Mining Features"
        )

        features_label = ctk.CTkLabel(
            card,
            text=features_text,
            font=("Microsoft YaHei", 14, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="#ffffff",
            justify="center"
        )
        features_label.pack(pady=(0, 15))  # å‡å°‘ä¸‹è¾¹è·

        # è¿›å…¥æŒ‰é’® - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°å°ºå¯¸å’Œé—´è·
        enter_btn = ctk.CTkButton(
            card,
            text="é€²å…¥æ•¸æ“šåˆ†æ\nEnter Data Analysis",
            command=self._pos_data_analysis,
            fg_color="white",
            hover_color="#f1f5f9",
            font=("Microsoft YaHei", 14, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="#7c3aed",
            width=220,  # ç¼©å°å®½åº¦
            height=50,  # ç¼©å°é«˜åº¦
            corner_radius=12
        )
        enter_btn.pack(pady=(0, 20))  # å‡å°‘ä¸‹è¾¹è·

    def _create_ordering_category_card(self, parent):
        """åˆ›å»ºè®¢å•åŠŸèƒ½åˆ†ç±»å¡ç‰‡"""
        # å¡ç‰‡å®¹å™¨ - åŠ å¤§å°ºå¯¸
        card = ctk.CTkFrame(
            parent,
            fg_color="#1e3a8a",
            corner_radius=25,
            border_width=4,
            border_color="#3b82f6"
        )
        card.pack(fill="both", expand=True, padx=5, pady=5)

        # å›¾æ ‡ - ç¼©å°é—´è·
        icon_label = ctk.CTkLabel(
            card,
            text="ğŸ“‹",
            font=("Microsoft YaHei", 48),  # ç¨å¾®ç¼©å°å›¾æ ‡
            text_color="white"
        )
        icon_label.pack(pady=(20, 8))  # å‡å°‘ä¸Šä¸‹è¾¹è·

        # æ ‡é¢˜ - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°é—´è·
        title_label = ctk.CTkLabel(
            card,
            text=t("ordering_function"),
            font=("Microsoft YaHei", 20, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="white",
            justify="center"
        )
        title_label.pack(pady=(0, 12))  # å‡å°‘ä¸‹è¾¹è·

        # åŠŸèƒ½åˆ—è¡¨ - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°è¡Œé—´è·
        features_text = (
            "ğŸ“§ Outlookè¨‚å–®ä¸‹è¼‰\n    Outlook Order Download\n"
            "ğŸ”„ è¨‚å–®è‡ªå‹•æ•´åˆ\n    Order Automation\n"
            "ğŸ“‹ æ¯é€±è¨‚å–®æª¢æŸ¥è¡¨\n    Weekly Order Checklist\n"
            "ğŸ“¤ ç™¼é€éƒµä»¶\n    Send Emails\n"
            "ğŸ“¦ ç‡Ÿé‹ç”¨å“\n    Operation Supplies"
        )

        features_label = ctk.CTkLabel(
            card,
            text=features_text,
            font=("Microsoft YaHei", 14, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="#ffffff",
            justify="center"
        )
        features_label.pack(pady=(0, 15))  # å‡å°‘ä¸‹è¾¹è·

        # è¿›å…¥æŒ‰é’® - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°å°ºå¯¸å’Œé—´è·
        enter_btn = ctk.CTkButton(
            card,
            text="é€²å…¥è¨‚å–®åŠŸèƒ½\nEnter Ordering Function",
            command=self.show_ordering_functions,
            fg_color="white",
            hover_color="#f1f5f9",
            font=("Microsoft YaHei", 14, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="#1e3a8a",
            width=220,  # ç¼©å°å®½åº¦
            height=50,  # ç¼©å°é«˜åº¦
            corner_radius=12
        )
        enter_btn.pack(pady=(0, 20))  # å‡å°‘ä¸‹è¾¹è·

    def _create_monthend_category_card(self, parent):
        """åˆ›å»ºæœˆç»“åŠŸèƒ½åˆ†ç±»å¡ç‰‡"""
        # å¡ç‰‡å®¹å™¨ - åŠ å¤§å°ºå¯¸
        card = ctk.CTkFrame(
            parent,
            fg_color="#c2410c",
            corner_radius=25,
            border_width=4,
            border_color="#ea580c"
        )
        card.pack(fill="both", expand=True, padx=5, pady=5)

        # å›¾æ ‡ - ç¼©å°é—´è·
        icon_label = ctk.CTkLabel(
            card,
            text="ğŸ“Š",
            font=("Microsoft YaHei", 48),  # ç¨å¾®ç¼©å°å›¾æ ‡
            text_color="white"
        )
        icon_label.pack(pady=(20, 8))  # å‡å°‘ä¸Šä¸‹è¾¹è·

        # æ ‡é¢˜ - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°é—´è·
        title_label = ctk.CTkLabel(
            card,
            text=t("monthend_function"),
            font=("Microsoft YaHei", 20, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="white",
            justify="center"
        )
        title_label.pack(pady=(0, 12))  # å‡å°‘ä¸‹è¾¹è·

        # åŠŸèƒ½åˆ—è¡¨ - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°è¡Œé—´è·
        features_text = (
            "ğŸ“Š æœˆåº¦éŠ·å”®å ±è¡¨ç”Ÿæˆ\n    Monthly Sales Report\n"
            "ğŸ“ˆ ä¾›æ‡‰å•†å°è³¬å–®è™•ç†\n    Supplier Statement Processing\n"
            "ğŸ’° æˆæœ¬åˆ†æèˆ‡æ ¸ç®—\n    Cost Analysis & Accounting\n"
            "ğŸ“‹ åº«å­˜ç›¤é»æ•´ç†\n    Inventory Count Organization\n"
            "ğŸ”„ è‡ªå‹•åŒ–æœˆçµæµç¨‹\n    Automated Month-end Process"
        )

        features_label = ctk.CTkLabel(
            card,
            text=features_text,
            font=("Microsoft YaHei", 14, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="#ffffff",
            justify="center"
        )
        features_label.pack(pady=(0, 15))  # å‡å°‘ä¸‹è¾¹è·

        # è¿›å…¥æŒ‰é’® - ä¸­è‹±æ–‡å¯¹ç…§ï¼Œç¼©å°å°ºå¯¸å’Œé—´è·
        enter_btn = ctk.CTkButton(
            card,
            text=t("enter_monthend"),
            command=self.show_monthend_functions,
            fg_color="white",
            hover_color="#f1f5f9",
            font=("Microsoft YaHei", 14, "bold"),  # ç¨å¾®ç¼©å°å­—ä½“
            text_color="#c2410c",
            width=220,  # ç¼©å°å®½åº¦
            height=50,  # ç¼©å°é«˜åº¦
            corner_radius=12
        )
        enter_btn.pack(pady=(0, 20))  # å‡å°‘ä¸‹è¾¹è·

    def _create_simple_navigation(self):
        """åˆ›å»ºç®€åŒ–çš„å¯¼èˆªæ ï¼ˆåªæ˜¾ç¤ºlogoå’Œæ ‡é¢˜ï¼‰"""
        for widget in self.button_container.winfo_children():
            widget.destroy()

        # ç®€å•çš„æ ‡é¢˜
        simple_title = ctk.CTkLabel(
            self.button_container,
            text=t("function_selection"),
            font=("Microsoft YaHei", 14, "bold"),
            text_color=ACCENT_BLUE,
            justify="center"
        )
        simple_title.pack(pady=50)

    def show_ordering_functions(self):
        """æ˜¾ç¤ºè®¢å•åŠŸèƒ½ç•Œé¢"""
        # è®¾ç½®æ ‡é¢˜
        self.function_title.configure(text=t("ordering_function_title"))
        self.function_subtitle.configure(
    text="è«‹é¸æ“‡æ‚¨éœ€è¦çš„è¨‚å–®åŠŸèƒ½\nPlease select the ordering function you need")

        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # åˆ›å»ºè®¢å•åŠŸèƒ½é€‰æ‹©ç•Œé¢ï¼ˆæ˜¾ç¤ºåŠŸèƒ½æŒ‰é’®ï¼‰
        self._create_ordering_function_buttons()

        # åˆ›å»ºè®¢å•åŠŸèƒ½å¯¼èˆªï¼ˆå·¦ä¾§æ˜¾ç¤ºåŠŸèƒ½åˆ—è¡¨ï¼‰
        self._create_ordering_navigation()

    def show_monthend_functions(self):
        """æ˜¾ç¤ºæœˆç»“åŠŸèƒ½ç•Œé¢"""
        # è®¾ç½®æ ‡é¢˜
        self.function_title.configure(text=t("monthend_function_title"))
        self.function_subtitle.configure(text=t("monthend_related"))

        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # æ˜¾ç¤ºæœˆç»“åŠŸèƒ½è¯´æ˜
        self._create_monthend_function_buttons()

        # åˆ›å»ºæœˆç»“åŠŸèƒ½å¯¼èˆª
        self._create_monthend_navigation()

    def show_data_analysis_functions(self):
        """æ˜¾ç¤ºæ•°æ®åˆ†æåŠŸèƒ½"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()
        self._create_data_analysis_function_buttons()
        self._create_data_analysis_navigation()

    def _create_data_analysis_function_buttons(self):
        """åˆ›å»ºæ•°æ®åˆ†æåŠŸèƒ½æŒ‰é’®"""
        # æ ‡é¢˜
        title_label = ctk.CTkLabel(
            self.content_body,
            text="ğŸ“ˆ æ•¸æ“šåˆ†æåŠŸèƒ½ / Data Analysis Functions",
            font=("Microsoft YaHei", 24, "bold"),
            text_color=ACCENT_BLUE
        )
        title_label.pack(pady=(20, 30))

        # åŠŸèƒ½æŒ‰é’®å®¹å™¨
        buttons_frame = ctk.CTkFrame(self.content_body, fg_color="transparent")
        buttons_frame.pack(fill="both", expand=True, padx=50)

        # ç¬¬ä¸€è¡ŒæŒ‰é’®
        row1_frame = ctk.CTkFrame(buttons_frame, fg_color="transparent")
        row1_frame.pack(fill="x", pady=10)

        # POS æ•°æ®åˆ†æ
        pos_btn = ctk.CTkButton(
            row1_frame,
            text="ğŸ“Š POS æ•¸æ“šåˆ†æ\nPOS Data Analysis",
            command=self._pos_data_analysis,
            font=("Microsoft YaHei", 16, "bold"),
            fg_color=ACCENT_BLUE,
            hover_color=BTN_HOVER,
            width=300,
            height=80,
            corner_radius=15
        )
        pos_btn.pack(side="left", padx=10)

        # é”€å”®è¶‹åŠ¿åˆ†æ
        trend_btn = ctk.CTkButton(
            row1_frame,
            text="ğŸ“ˆ éŠ·å”®è¶¨å‹¢åˆ†æ\nSales Trend Analysis",
            command=self._sales_trend_analysis,
            font=("Microsoft YaHei", 16, "bold"),
            fg_color=ACCENT_GREEN,
            hover_color="#059669",
            width=300,
            height=80,
            corner_radius=15
        )
        trend_btn.pack(side="left", padx=10)

        # ç¬¬äºŒè¡ŒæŒ‰é’®
        row2_frame = ctk.CTkFrame(buttons_frame, fg_color="transparent")
        row2_frame.pack(fill="x", pady=10)

        # æˆæœ¬æ•ˆç›Šåˆ†æ
        cost_btn = ctk.CTkButton(
            row2_frame,
            text="ğŸ’° æˆæœ¬æ•ˆç›Šåˆ†æ\nCost-Benefit Analysis",
            command=self._cost_benefit_analysis,
            font=("Microsoft YaHei", 16, "bold"),
            fg_color=ACCENT_PURPLE,
            hover_color="#7c3aed",
            width=300,
            height=80,
            corner_radius=15
        )
        cost_btn.pack(side="left", padx=10)

        # æŠ¥è¡¨ç”Ÿæˆå·¥å…·
        report_btn = ctk.CTkButton(
            row2_frame,
            text="ğŸ“‹ å ±è¡¨ç”Ÿæˆå·¥å…·\nReport Generation Tools",
            command=self._report_generation,
            font=("Microsoft YaHei", 16, "bold"),
            fg_color=ACCENT_RED,
            hover_color="#dc2626",
            width=300,
            height=80,
            corner_radius=15
        )
        report_btn.pack(side="left", padx=10)

    def _create_data_analysis_navigation(self):
        """åˆ›å»ºæ•°æ®åˆ†æå¯¼èˆª"""
        nav_frame = ctk.CTkFrame(self.content_body, fg_color="transparent")
        nav_frame.pack(fill="x", pady=20)

        back_btn = ctk.CTkButton(
            nav_frame,
            text="â† è¿”å›ä¸»é¸å–® / Back to Main Menu",
            command=self._show_main_menu,
            font=("Microsoft YaHei", 14, "bold"),
            fg_color="#64748b",
            hover_color="#475569",
            width=200,
            height=40,
            corner_radius=10
        )
        back_btn.pack(side="left")

    def _pos_data_analysis(self):
        """POS æ•°æ®åˆ†æåŠŸèƒ½"""
        try:
            import multiprocessing
            import pos_analysis_tool  # ç¡®ä¿è¯¥æ¨¡å—è¢«æ‰“åŒ…å¹¶å¯ç›´æ¥è°ƒç”¨

            # Windows/æ‰“åŒ…ç¯å¢ƒä¸‹ï¼Œç¡®ä¿ freeze_support å¯ç”¨ï¼ˆæ”¾è¿™é‡Œä¹Ÿå¯æ”¾æ¨¡å—é¡¶å±‚ï¼‰
            try:
                multiprocessing.freeze_support()
            except Exception:
                pass

            # ç”¨å­è¿›ç¨‹å¼€å¯ pos_analysis_tool çš„ GUIï¼Œé¿å…åœ¨åŒä¸€è¿›ç¨‹é‡Œå¼€ç¬¬äºŒä¸ª Tk mainloop
            p = multiprocessing.Process(
                target=pos_analysis_tool.main,  # è¦æ±‚ pos_analysis_tool.py é‡Œæœ‰ main()
                name="POSAnalysisTool"
            )
            p.daemon = False
            p.start()
            print("POSæ•¸æ“šåˆ†æå·¥å…·å·²å•Ÿå‹• (PID=", p.pid, ")")
        except Exception as e:
            from tkinter import messagebox
            messagebox.showerror("éŒ¯èª¤", f"å•Ÿå‹•POSæ•¸æ“šåˆ†æå·¥å…·å¤±æ•—ï¼š\n{e}")

    def _sales_trend_analysis(self):
        """é”€å”®è¶‹åŠ¿åˆ†æåŠŸèƒ½"""
        messagebox.showinfo("åŠŸèƒ½é–‹ç™¼ä¸­", "éŠ·å”®è¶¨å‹¢åˆ†æåŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...\nSales Trend Analysis feature is under development...")

    def _cost_benefit_analysis(self):
        """æˆæœ¬æ•ˆç›Šåˆ†æåŠŸèƒ½"""
        messagebox.showinfo("åŠŸèƒ½é–‹ç™¼ä¸­", "æˆæœ¬æ•ˆç›Šåˆ†æåŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...\nCost-Benefit Analysis feature is under development...")

    def _report_generation(self):
        """æŠ¥è¡¨ç”Ÿæˆå·¥å…·åŠŸèƒ½"""
        messagebox.showinfo("åŠŸèƒ½é–‹ç™¼ä¸­", "å ±è¡¨ç”Ÿæˆå·¥å…·åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­...\nReport Generation Tools feature is under development...")

    def _create_ordering_function_buttons(self):
        """åˆ›å»ºè®¢å•åŠŸèƒ½æŒ‰é’®ç•Œé¢ï¼ˆå³ä¾§å†…å®¹åŒºæ˜¾ç¤ºåŠŸèƒ½è¯´æ˜ï¼‰"""
        # ä¸»å®¹å™¨
        content_frame = ctk.CTkFrame(self.content_body, fg_color="transparent")
        content_frame.pack(fill="both", expand=True, padx=50, pady=50)

        # åŠŸèƒ½è¯´æ˜æ–‡æœ¬ - ä¸­è‹±æ–‡å¯¹ç…§
        description_text = (
            "è¨‚å–®åŠŸèƒ½åŒ…å«æ—¥å¸¸è¨‚å–®è™•ç†çš„æ‰€æœ‰å·¥å…·\n"
            "Ordering functions include all tools for daily order processing\n\n"
            "è«‹å¾å·¦å´é¸æ“‡æ‚¨éœ€è¦çš„åŠŸèƒ½ï¼š\n"
            "Please select the function you need from the left sidebar:\n\n"
            "ğŸ“§ Outlookè¨‚å–®ä¸‹è¼‰\n    Outlook Order Download - å¾éƒµä»¶ä¸‹è¼‰è¨‚å–®æ–‡ä»¶\n\n"
            "ğŸ”„ è¨‚å–®è‡ªå‹•æ•´åˆ\n    Order Automation - è‡ªå‹•æ•´ç†å’Œåˆä½µè¨‚å–®\n\n"
            "ğŸ“‹ æ¯é€±è¨‚å–®æª¢æŸ¥è¡¨\n    Weekly Order Checklist - ç”Ÿæˆæ¯é€±è¨‚å–®æª¢æŸ¥æ¸…å–®\n\n"
            "ğŸ“¤ ç™¼é€éƒµä»¶\n    Send Emails - ç™¼é€è™•ç†å®Œæˆçš„è¨‚å–®\n\n"
            "ğŸ“¦ ç‡Ÿé‹ç”¨å“\n    Operation Supplies - ç®¡ç†ç‡Ÿé‹ç›¸é—œç”¨å“è¨‚å–®"
        )

        description_label = ctk.CTkLabel(
            content_frame,
            text=description_text,
            font=("Microsoft YaHei", 14),
            text_color=TEXT_COLOR,
            justify="left"
        )
        description_label.pack(expand=True, pady=50)

    def _create_monthend_function_buttons(self):
        """åˆ›å»ºæœˆç»“åŠŸèƒ½æŒ‰é’®ç•Œé¢ï¼ˆå³ä¾§å†…å®¹åŒºæ˜¾ç¤ºåŠŸèƒ½è¯´æ˜ï¼‰"""
        # ä¸»å®¹å™¨
        content_frame = ctk.CTkFrame(self.content_body, fg_color="transparent")
        content_frame.pack(fill="both", expand=True, padx=50, pady=50)

        # åŠŸèƒ½è¯´æ˜æ–‡æœ¬ - ä¸­è‹±æ–‡å¯¹ç…§
        description_text = (
            "æœˆçµåŠŸèƒ½åŒ…å«æœˆåº¦çµç®—å’Œå ±è¡¨ç›¸é—œå·¥å…·\n"
            "Monthend functions include monthly closing and reporting tools\n\n"
            "å¯ç”¨åŠŸèƒ½ï¼š\n"
            "Available features:\n\n"
            "ğŸ“¥ æœˆçµæ–‡ä»¶ä¸‹è¼‰\n    Month-end File Download - å¾ Outlook ä¸‹è¼‰ SOA/Invoice ç­‰æœˆçµæ–‡ä»¶\n\n"
            "å³å°‡æ¨å‡ºçš„åŠŸèƒ½ï¼š\n"
            "Coming soon features:\n\n"
            "ğŸ“Š æœˆåº¦éŠ·å”®å ±è¡¨ç”Ÿæˆ\n    Monthly Sales Report - è‡ªå‹•ç”Ÿæˆæœˆåº¦éŠ·å”®åˆ†æå ±è¡¨\n\n"
            "ğŸ“ˆ ä¾›æ‡‰å•†å°è³¬å–®è™•ç†\n    Supplier Statement Processing - è™•ç†å’Œæ ¸å°ä¾›æ‡‰å•†æœˆåº¦å°è³¬å–®\n\n"
            "ğŸ’° æˆæœ¬åˆ†æèˆ‡æ ¸ç®—\n    Cost Analysis & Accounting - é€²è¡Œæœˆåº¦æˆæœ¬åˆ†æå’Œæ ¸ç®—\n\n"
            "ğŸ“‹ åº«å­˜ç›¤é»æ•´ç†\n    Inventory Count Organization - æœˆæœ«åº«å­˜ç›¤é»æ•¸æ“šæ•´ç†\n\n"
            "ğŸ”„ è‡ªå‹•åŒ–æœˆçµæµç¨‹\n    Automated Month-end Process - ä¸€éµå®Œæˆæœˆçµç›¸é—œæ“ä½œ\n\n"
            "é€™äº›åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼\n"
            "These features are under development, stay tuned!"
        )

        description_label = ctk.CTkLabel(
            content_frame,
            text=description_text,
            font=("Microsoft YaHei", 14),
            text_color=TEXT_COLOR,
            justify="left"
        )
        description_label.pack(expand=True, pady=50)

    def _create_ordering_navigation(self):
        """åˆ›å»ºè®¢å•åŠŸèƒ½å¯¼èˆªæ ï¼ˆå·¦ä¾§æ˜¾ç¤ºåŠŸèƒ½åˆ—è¡¨ï¼‰"""
        for widget in self.button_container.winfo_children():
            widget.destroy()

        # å¯¼èˆªå®¹å™¨
        nav_container = ctk.CTkFrame(
    self.button_container,
     fg_color="transparent")
        nav_container.pack(fill="both", expand=True, pady=10)

        # å½“å‰åˆ†ç±»æ ‡é¢˜
        current_title = ctk.CTkLabel(
            nav_container,
            text=t("ordering_function_title"),
            font=("Microsoft YaHei", 14, "bold"),
            text_color="#3b82f6",
            justify="center"
        )
        current_title.pack(pady=(0, 20))

        # è®¢å•åŠŸèƒ½åˆ—è¡¨ - ä¸­è‹±æ–‡å¯¹ç…§
        ordering_functions = [
            (t("outlook_order_download"), "download_title",
             self.show_download_ui, "#3b82f6"),
            (t("order_automation"), "automation_title",
             self.show_automation_ui, "#10b981"),
            (t("weekly_order_checklist"), "checklist_title",
             self.show_checklist_ui, "#8b5cf6"),
            (t("send_emails"), "send_emails",
             self.show_email_sending_ui, "#ef4444"),
            (t("operation_supplies"), "operation_supplies",
             self.show_operation_supplies_ui, "#f97316")
        ]

        # åˆå§‹åŒ–æŒ‰é’®å­—å…¸
        if not hasattr(self, 'nav_buttons'):
            self.nav_buttons = {}

        # åˆ›å»ºè®¢å•åŠŸèƒ½æŒ‰é’®
        self._create_ordering_button(
    nav_container,
    t("outlook_order_download"),
    "download_title",
    self.show_download_ui,
     "#3b82f6")
        self._create_ordering_button(
    nav_container,
    t("order_automation"),
    "automation_title",
    self.show_automation_ui,
     "#10b981")
        self._create_ordering_button(
    nav_container,
    t("weekly_order_checklist"),
    "checklist_title",
    self.show_checklist_ui,
     "#8b5cf6")
        self._create_ordering_button(
    nav_container,
    t("send_emails"),
    "send_emails",
    self.show_email_sending_ui,
     "#ef4444")
        self._create_ordering_button(
    nav_container,
    t("operation_supplies"),
    "operation_supplies",
    self.show_operation_supplies_ui,
     "#f97316")

        # åˆ†éš”çº¿
        ctk.CTkFrame(
    nav_container,
    height=2,
    fg_color="#444444").pack(
        fill="x",
        padx=10,
         pady=15)

        # åˆ‡æ¢åˆ°æœˆç»“åŠŸèƒ½æŒ‰é’®
        switch_btn = ctk.CTkButton(
            nav_container,
            text=t("monthend_function_nav"),
            command=self.show_monthend_functions,
            fg_color="#ea580c",
            hover_color="#dc2626",
            font=("Microsoft YaHei", 13, "bold"),  # ä»11å¢åŠ åˆ°13
            text_color="white",
            width=220,
            height=45,
            corner_radius=8
        )
        switch_btn.pack(pady=5, padx=5, fill="x")

        # è¿”å›ä¸»èœå•æŒ‰é’®
        back_btn = ctk.CTkButton(
            nav_container,
            text=t("back_to_main"),
            command=self.show_main_menu,
            fg_color="#64748b",
            hover_color="#475569",
            font=("Microsoft YaHei", 13, "bold"),  # ä»11å¢åŠ åˆ°13
            text_color="white",
            width=220,
            height=40,
            corner_radius=8
        )
        back_btn.pack(pady=3, padx=5, fill="x")

        # é€€å‡ºæŒ‰é’®
        exit_btn = ctk.CTkButton(
            nav_container,
            text=t("exit_system"),
            command=self._on_close,
            fg_color="#64748b",
            hover_color="#475569",
            font=("Microsoft YaHei", 12, "bold"),  # ä»10å¢åŠ åˆ°12ï¼Œå¹¶æ·»åŠ bold
            text_color="white",
            width=220,
            height=35,
            corner_radius=8
        )
        exit_btn.pack(pady=(10, 0), padx=5, fill="x")

    def _create_ordering_button(self, parent, text, func_key, command, color):
        """åˆ›å»ºè®¢å•åŠŸèƒ½æŒ‰é’®"""
        btn = ctk.CTkButton(
            parent,
            text=text,
            command=command,  # ç›´æ¥ä½¿ç”¨å‘½ä»¤ï¼Œä¸éœ€è¦åŒ…è£…
            fg_color=DARK_PANEL,
            hover_color=color,
            border_width=2,
            border_color=color,
            font=("Microsoft YaHei", 13, "bold"),  # ä»10å¢åŠ åˆ°13
            text_color=TEXT_COLOR,
            width=220,
            height=50,
            corner_radius=8
        )
        btn.pack(pady=4, padx=5, fill="x")
        self.nav_buttons[func_key] = btn

    def _create_monthend_navigation(self):
        """åˆ›å»ºæœˆç»“åŠŸèƒ½å¯¼èˆªæ ï¼ˆå·¦ä¾§æ˜¾ç¤ºåŠŸèƒ½åˆ—è¡¨ï¼‰"""
        for widget in self.button_container.winfo_children():
            widget.destroy()

        # å¯¼èˆªå®¹å™¨
        nav_container = ctk.CTkFrame(
    self.button_container,
     fg_color="transparent")
        nav_container.pack(fill="both", expand=True, pady=10)

        # å½“å‰åˆ†ç±»æ ‡é¢˜ï¼ˆèˆ‡è¨‚å–®åŠŸèƒ½ä¸€è‡´çš„æ¨£å¼ï¼‰
        current_title = ctk.CTkLabel(
            nav_container,
            text=t("month_end_function"),
            font=("Microsoft YaHei", 14, "bold"),
            text_color=ACCENT_BLUE,
            justify="center"
        )
        current_title.pack(pady=(0, 10))

        # æœˆçµåŠŸèƒ½åˆ—è¡¨ï¼ˆåŒ…å«å·²å•Ÿç”¨èˆ‡é å‘Šï¼‰
        monthend_functions = [
            (t("monthend_download"), "monthend_download",
             self.show_monthend_download_ui, "#3b82f6", True),  # è“è‰²
            (t("monthly_order_summary"), "monthly_order_summary",
             self.show_monthend_monthly_summary_ui, "#10b981", True),  # ç»¿è‰²
            (t("supplier_statement"), "supplier_statement",
             self.show_monthend_placeholder, "#dc2626", True),  # æ·±çº¢è‰²ï¼Œè®¾ç½®ä¸ºå¯ç”¨
            (t("monthly_sales_report"), "monthly_sales_report",
             self.show_monthend_placeholder, "#ef4444", False),  # çº¢è‰²
            (t("cost_analysis"), "cost_analysis",
             self.show_monthend_placeholder, "#b91c1c", False),  # æš—çº¢è‰²
            (t("inventory_count"), "inventory_count",
             self.show_monthend_placeholder, "#991b1b", False),  # æ›´æš—çº¢è‰²
        ]

        for text, func_key, command, color, is_active in monthend_functions:
            if is_active:
                # å·²å¯ç”¨çš„åŠŸèƒ½ - ä½¿ç”¨æ·±è‰²èƒŒæ™¯ + å½©è‰²è¾¹æ¡†
                if func_key == "supplier_statement":
                    # ä¾›åº”å•†å¯¹è´¦å•åŠŸèƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
                    btn = NavigationButton(
                        nav_container,
                        text=text,
                        command=lambda fk=func_key: self._select_monthend_function(
                            fk),
                        fg_color=DARK_PANEL,  # æ·±è‰²èƒŒæ™¯
                        anchor="center",
                        border_width=2,       # 2åƒç´ è¾¹æ¡†
                        border_color="#8b5cf6",  # ç´«è‰²è¾¹æ¡†ï¼Œä¸ä½¿ç”¨çº¢è‰²
                        corner_radius=10,
                        font=FONT_BIGBTN,
                        text_color=get_contrast_color(DARK_PANEL),  # è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
                        height=45
                    )
                else:
                    btn = NavigationButton(
                        nav_container,
                        text=text,
                        command=lambda c=command: c(),
                        fg_color=DARK_PANEL,  # æ·±è‰²èƒŒæ™¯
                        anchor="center",
                        border_width=2,       # 2åƒç´ è¾¹æ¡†
                        border_color=color,   # å½©è‰²è¾¹æ¡†
                        corner_radius=10,
                        font=FONT_BIGBTN,
                        text_color=get_contrast_color(DARK_PANEL),  # è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
                        height=45
                    )
            else:
                # æœªå¼€æ”¾çš„åŠŸèƒ½ - ä½¿ç”¨æ·±è‰²èƒŒæ™¯ + çº¢è‰²è¾¹æ¡†
                btn = NavigationButton(
                    nav_container,
                    text=f"{text}\n{t('coming_soon')}",
                    command=lambda c=command: c(),
                    fg_color=DARK_PANEL,  # æ·±è‰²èƒŒæ™¯
                    anchor="center",
                    border_width=2,       # 2åƒç´ è¾¹æ¡†
                    border_color="#dc2626",  # çº¢è‰²è¾¹æ¡†
                    corner_radius=10,
                    font=FONT_BIGBTN,
                    text_color=get_contrast_color(DARK_PANEL),  # è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
                height=45
            )
            btn.pack(fill="x", pady=4, padx=10)

        # åˆ†éš”çº¿
        ctk.CTkFrame(
    nav_container,
    height=2,
    fg_color="#444444").pack(
        fill="x",
        padx=10,
         pady=15)

        # åˆ‡æ¢åˆ°è®¢å•åŠŸèƒ½æŒ‰é’®
        switch_btn = ctk.CTkButton(
            nav_container,
            text=t("ordering_function_title"),
            command=self.show_ordering_functions,
            fg_color="#3b82f6",
            hover_color="#1d4ed8",
            font=("Microsoft YaHei", 13, "bold"),  # ä»11å¢åŠ åˆ°13
            text_color="white",
            width=220,
            height=45,
            corner_radius=8
        )
        switch_btn.pack(pady=5, padx=5, fill="x")

        # è¿”å›ä¸»èœå•æŒ‰é’®
        back_btn = ctk.CTkButton(
            nav_container,
            text=t("back_to_main"),
            command=self.show_main_menu,
            fg_color="#64748b",
            hover_color="#475569",
            font=("Microsoft YaHei", 13, "bold"),  # ä»11å¢åŠ åˆ°13
            text_color="white",
            width=220,
            height=40,
            corner_radius=8
        )
        back_btn.pack(pady=3, padx=5, fill="x")

        # é€€å‡ºæŒ‰é’®
        exit_btn = ctk.CTkButton(
            nav_container,
            text=t("exit_system"),
            command=self._on_close,
            fg_color="#64748b",
            hover_color="#475569",
            font=("Microsoft YaHei", 13, "bold"),  # ä»10å¢åŠ åˆ°12ï¼Œå¹¶æ·»åŠ bold
            text_color="white",
            width=220,
            height=35,
            corner_radius=8
        )
        exit_btn.pack(pady=(10, 0), padx=5, fill="x")

    def _select_monthend_function(self, func_key):
        """é€‰æ‹©æœˆç»“åŠŸèƒ½"""
        if func_key == "supplier_statement":
            # è®¾ç½®å½“å‰åŠŸèƒ½å¹¶æ˜¾ç¤ºå‚å•†é€‰æ‹©ç•Œé¢
            self.current_function = func_key
            self.show_supplier_selection_ui()
        else:
            # å…¶ä»–åŠŸèƒ½ä½¿ç”¨é»˜è®¤å¤„ç†
            pass

    def _select_demerit_file(self):
        """é€‰æ‹©æ‰£åˆ†æ–‡ä»¶"""
        from tkinter import filedialog
        f = filedialog.askopenfilename(
            title="é€‰æ‹©æ‰£åˆ†æ–‡ä»¶ / Select Demerit File",
            filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")]
        )
        if f:
            self.demerit_file_var.set(f)

    def _run_auto_f5_deduction(self):
        """è‡ªåŠ¨æ‰£åˆ†ï¼šæ£€æŸ¥å‘¨ä¸‰12ç‚¹åçš„è®¢å•"""
        from datetime import datetime, timedelta
        import os
        from tkinter import messagebox
        import pandas as pd
        
        # æ£€æŸ¥æ‰£åˆ†æ–‡ä»¶
        demerit_file = self.demerit_file_var.get()
        if not demerit_file:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆé€‰æ‹©æ‰£åˆ†æ–‡ä»¶ï¼")
            return
        
        folder = self.download_folder_var.get()
        if not folder:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆé€‰æ‹©ä¸‹è½½æ–‡ä»¶å¤¹ï¼")
            return
        
        # æ£€æŸ¥é‚®ä»¶æ—¥å¿—æ–‡ä»¶ - æ™ºèƒ½æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶å¤¹
        today = datetime.now()
        week_no = today.isocalendar()[1]
        possible_paths = []
        
        # æ–¹æ³•1ï¼šæ£€æŸ¥æœˆä»½-Weekæ ¼å¼çš„æ–‡ä»¶å¤¹
        for week_offset in range(0, 4):  # æ£€æŸ¥å½“å‰å‘¨å’Œå‰3å‘¨
            check_week = week_no - week_offset
            # è®¡ç®—å¯¹åº”æ—¥æœŸçš„æœˆä»½å’Œæ˜ŸæœŸ
            check_date = today - timedelta(weeks=week_offset)
            month_name = check_date.strftime('%b').title()  # ç¡®ä¿é¦–å­—æ¯å¤§å†™ï¼Œä¾‹å¦‚: Aug, Sep
            week_of_month = get_week_of_month(check_date)
            check_path = os.path.join(folder, f"{month_name} - Week {week_of_month}")
            if os.path.exists(check_path):
                possible_paths.append(check_path)
        
        # æ–¹æ³•2ï¼šæ£€æŸ¥Weekly Order/Augæ ¼å¼çš„æ–‡ä»¶å¤¹
        aug_path = os.path.join(folder, "Weekly Order", "Aug")
        if os.path.exists(aug_path):
            possible_paths.append(aug_path)
        
        # æ–¹æ³•3ï¼šæ£€æŸ¥ç›´æ¥åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„é‚®ä»¶æ—¥å¿—
        if os.path.exists(os.path.join(folder, "email_bodies_log.txt")):
            possible_paths.append(folder)
        
        # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨å½“å‰å‘¨æ•°
        if not possible_paths:
            month_name = today.strftime('%b').title()
            week_of_month = get_week_of_month(today)
            save_path = os.path.join(folder, f"{month_name} - Week {week_of_month}")
            possible_paths = [save_path]
        
        # æŸ¥æ‰¾åŒ…å«é‚®ä»¶æ—¥å¿—çš„æ–‡ä»¶å¤¹
        log_file = None
        for path in possible_paths:
            temp_log = os.path.join(path, "email_bodies_log.txt")
            if os.path.exists(temp_log):
                log_file = temp_log
                break
        
        if not log_file:
            # æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            debug_info = f"åœ¨ä»¥ä¸‹è·¯å¾„ä¸­æœªæ‰¾åˆ°email_bodies_log.txtï¼š\n"
            for path in possible_paths:
                debug_info += f"- {path}\n"
            debug_info += f"\nè¯·ç¡®è®¤é‚®ä»¶æ—¥å¿—æ–‡ä»¶å­˜åœ¨ï¼"
            messagebox.showinfo("ä¿¡æ¯", debug_info)
            return
        
        # æ˜¾ç¤ºæ‰¾åˆ°çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆè°ƒè¯•ä¿¡æ¯ï¼‰
        print(f"[DEBUG] æ‰¾åˆ°é‚®ä»¶æ—¥å¿—æ–‡ä»¶: {log_file}")
        messagebox.showinfo("è°ƒè¯•ä¿¡æ¯", f"æ‰¾åˆ°é‚®ä»¶æ—¥å¿—æ–‡ä»¶:\n{log_file}")
        
        try:
            # è¯»å–æ‰£åˆ†æ–‡ä»¶ï¼Œè·å–å·²æ‰£åˆ†çš„è®°å½•
            demerit_df = pd.read_excel(demerit_file, sheet_name=None)
            outlet_sheets = [sheet for sheet in demerit_df.keys() if sheet not in 
                           ["Point Deduction Overview", "OPS Demerit Point Scoring", "Data - DO NOT EDIT", "Demerit System"]]
            
            # æ£€æŸ¥æ‰€æœ‰é—¨å¸‚çš„å·²æ‰£åˆ†è®°å½•
            existing_deductions = set()
            for sheet_name in outlet_sheets:
                if sheet_name in demerit_df:
                    df = demerit_df[sheet_name]
                    if len(df.columns) >= 3:  # ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
                        # æ£€æŸ¥Categoryå’ŒDescriptionåˆ—
                        for _, row in df.iterrows():
                            if pd.notna(row.iloc[1]) and pd.notna(row.iloc[2]):  # Båˆ—å’ŒCåˆ—
                                category = str(row.iloc[1]).strip()
                                description = str(row.iloc[2]).strip()
                                if category and description:
                                    existing_deductions.add(f"{category}: {description}")
            
            # è¯»å–é‚®ä»¶æ—¥å¿—ï¼Œæ£€æŸ¥å‘¨ä¸‰12ç‚¹åçš„è®¢å•
            late_orders = []
            try:
                with open(log_file, "r", encoding="utf-8") as f:
                    content = f.read()
                
                print(f"[DEBUG] é‚®ä»¶æ—¥å¿—å†…å®¹é•¿åº¦: {len(content)} å­—ç¬¦")
                print(f"[DEBUG] é‚®ä»¶æ—¥å¿—å‰200å­—ç¬¦: {content[:200]}")
                
                # è§£æé‚®ä»¶å†…å®¹
                email_blocks = content.split("â€”â€”â€” é‚®ä»¶")
                # print(f"[DEBUG] æ‰¾åˆ° {len(email_blocks)} ä¸ªé‚®ä»¶å—")
                
                for i, block in enumerate(email_blocks[1:], 1):  # è·³è¿‡ç¬¬ä¸€ä¸ªç©ºå—
                    lines = block.strip().splitlines()
                    if len(lines) < 3:
                        continue
                    
                    # æå–é‚®ä»¶æ—¶é—´ã€ä¸»é¢˜å’Œå‘ä»¶äºº
                    subject_line = ""
                    sender_line = ""
                    email_time = None
                    
                    for line in lines:
                        if line.startswith("[ä¸»é¢˜]"):
                            subject_line = line
                        elif line.startswith("[å‘ä»¶äºº]"):
                            sender_line = line
                        elif line.startswith("[æ—¶é—´]") or line.startswith("[å‘é€æ—¶é—´]"):
                            # å°è¯•è§£æé‚®ä»¶æ—¶é—´
                            try:
                                # ä¿®å¤ï¼šæå–å®Œæ•´çš„æ—¶é—´å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬æ—¥æœŸ
                                time_str = line.replace("[æ—¶é—´]", "").replace("[å‘é€æ—¶é—´]", "").strip()
                                print(f"[DEBUG] é‚®ä»¶{i} æ—¶é—´å­—ç¬¦ä¸²: '{time_str}'")
                                
                                # æ”¯æŒå¤šç§æ—¶é—´æ ¼å¼
                                for fmt in ["%Y-%m-%d %H:%M:%S", "%Y-%m-%d %H:%M", "%Y-%m-%d", "%d/%m/%Y %H:%M"]:
                                    try:
                                        email_time = datetime.strptime(time_str, fmt)
                                        # print(f"[DEBUG] é‚®ä»¶{i} è§£ææˆåŠŸ: {email_time} (æ ¼å¼: {fmt})")
                                        break
                                    except:
                                        continue
                                
                                if not email_time:
                                    print(f"[DEBUG] é‚®ä»¶{i} æ—¶é—´è§£æå¤±è´¥: '{time_str}'")
                            except Exception as e:
                                print(f"[DEBUG] é‚®ä»¶{i} æ—¶é—´è§£æå¼‚å¸¸: {e}")
                    
                    # æ£€æŸ¥é‚®ä»¶æ—¶é—´æ˜¯å¦åœ¨å‘¨ä¸‰12ç‚¹å
                    if email_time:
                        # è®¡ç®—é‚®ä»¶å‘é€æ—¶é—´æ˜¯å¦åœ¨å‘¨ä¸‰12ç‚¹å
                        email_weekday = email_time.weekday()  # 0=Monday, 2=Wednesday
                        email_hour = email_time.hour
                        
                        # æ£€æŸ¥æ˜¯å¦åº”è¯¥æ’é™¤æ­¤é‚®ä»¶ï¼ˆä½¿ç”¨ä¸ Weekly Order Downloader ç›¸åŒçš„æ’é™¤é€»è¾‘ï¼‰
                        should_exclude = False
                        if subject_line:
                            subject_lower = subject_line.lower()
                            
                            # å®šä¹‰æ’é™¤å…³é”®å­—ï¼ˆä¸ Weekly Order Downloader ä¿æŒä¸€è‡´ï¼‰
                            exclude_keywords = [
                                'amendment', 'amend', 'ament', 'admentmend', 'adment', 'amendmend', 'amendement',
                                'assets', 'uniform', 'asset', 'uniforms', 'request form', 'outlet assets &', 'outlet assets and',
                                'uniform request', 'assets request', 'assets & uniform', 'assets and uniform',
                                'invoice', 'payment', 'receipt', 'confirmation', 'delivery note',
                                'siahuat', 'siah', 'uat', 'æ€è¯é”', 'siah uat',
                                'monthly', 'month', 'æœˆ', 'æœˆåº¦'
                            ]
                            
                            # æ£€æŸ¥ä¸»æ—¨æ˜¯å¦åŒ…å«æ’é™¤å…³é”®å­—
                            has_exclude_keywords = any(keyword in subject_lower for keyword in exclude_keywords)
                            if has_exclude_keywords:
                                should_exclude = True
                                print(f"[DEBUG] é‚®ä»¶{i} è¢«æ’é™¤: åŒ…å«æ’é™¤å…³é”®å­—")
                        
                        if should_exclude:
                            continue  # è·³è¿‡è¿™ä¸ªé‚®ä»¶
                        
                        # æ„å»ºå®Œæ•´çš„è®¢å•ä¿¡æ¯ï¼ŒåŒ…å«å‘ä»¶äºº
                        order_info = f"é‚®ä»¶æ—¶é—´: {email_time.strftime('%Y-%m-%d %H:%M')} - {subject_line}"
                        if sender_line:
                            order_info += f" - {sender_line}"
                        
                        if email_weekday == 2 and email_hour >= 12:  # å‘¨ä¸‰ä¸”12ç‚¹å
                            # æ£€æŸ¥æ˜¯å¦å·²ç»æ‰£è¿‡åˆ†
                            deduction_key = "Order Lateness: å‘¨ä¸‰12ç‚¹åæäº¤è®¢å•"
                            if deduction_key not in existing_deductions:
                                late_orders.append(order_info)
                            else:
                                late_orders.append(order_info + " (å·²æ‰£åˆ†)")
                        elif email_weekday == 3:  # å‘¨å››çš„è®¢å•
                            print(f"[DEBUG] é‚®ä»¶{i} ç¬¦åˆæ¡ä»¶: å‘¨å››")
                            # æ£€æŸ¥æ˜¯å¦å·²ç»æ‰£è¿‡åˆ†
                            deduction_key = "Order Lateness: å‘¨ä¸‰12ç‚¹åæäº¤è®¢å•"
                            if deduction_key not in existing_deductions:
                                late_orders.append(order_info)
                            else:
                                late_orders.append(order_info + " (å·²æ‰£åˆ†)")
                        elif email_weekday == 4:  # å‘¨äº”çš„è®¢å•
                            print(f"[DEBUG] é‚®ä»¶{i} ç¬¦åˆæ¡ä»¶: å‘¨äº”")
                            # æ£€æŸ¥æ˜¯å¦å·²ç»æ‰£è¿‡åˆ†
                            deduction_key = "Order Lateness: å‘¨ä¸‰12ç‚¹åæäº¤è®¢å•"
                            if deduction_key not in existing_deductions:
                                late_orders.append(order_info)
                            else:
                                late_orders.append(order_info + " (å·²æ‰£åˆ†)")
                        elif email_weekday == 5:  # å‘¨å…­çš„è®¢å•
                            print(f"[DEBUG] é‚®ä»¶{i} ç¬¦åˆæ¡ä»¶: å‘¨å…­")
                            # æ£€æŸ¥æ˜¯å¦å·²ç»æ‰£è¿‡åˆ†
                            deduction_key = "Order Lateness: å‘¨ä¸‰12ç‚¹åæäº¤è®¢å•"
                            if deduction_key not in existing_deductions:
                                late_orders.append(order_info)
                            else:
                                late_orders.append(order_info + " (å·²æ‰£åˆ†)")
                        # æ³¨æ„ï¼šå‘¨æ—¥(6)ã€å‘¨ä¸€(0)ã€å‘¨äºŒ(1)çš„è®¢å•ä¸ç®—è¿Ÿäº¤ï¼Œå› ä¸ºæ˜¯æ–°çš„ä¸€å‘¨
                        # åªæœ‰å‘¨ä¸‰12ç‚¹åã€å‘¨å››ã€å‘¨äº”ã€å‘¨å…­çš„è®¢å•æ‰ç®—è¿Ÿäº¤
                    
                    # å¦‚æœæ²¡æœ‰æ—¶é—´ä¿¡æ¯ï¼Œæ£€æŸ¥ä¸»é¢˜ä¸­æ˜¯å¦åŒ…å«ç›¸å…³å…³é”®è¯
                    elif not email_time and ("å‘¨ä¸‰" in subject_line or "wednesday" in subject_line.lower() or 
                                           "å‘¨å››" in subject_line or "thursday" in subject_line.lower() or
                                           "å‘¨äº”" in subject_line or "friday" in subject_line.lower()):
                        
                        # æ£€æŸ¥æ˜¯å¦åº”è¯¥æ’é™¤æ­¤é‚®ä»¶ï¼ˆä½¿ç”¨ä¸ Weekly Order Downloader ç›¸åŒçš„æ’é™¤é€»è¾‘ï¼‰
                        should_exclude = False
                        if subject_line:
                            subject_lower = subject_line.lower()
                            
                            # å®šä¹‰æ’é™¤å…³é”®å­—ï¼ˆä¸ Weekly Order Downloader ä¿æŒä¸€è‡´ï¼‰
                            exclude_keywords = [
                                'amendment', 'amend', 'ament', 'admentmend', 'adment', 'amendmend', 'amendement',
                                'assets', 'uniform', 'asset', 'uniforms', 'request form', 'outlet assets &', 'outlet assets and',
                                'uniform request', 'assets request', 'assets & uniform', 'assets and uniform',
                                'invoice', 'payment', 'receipt', 'confirmation', 'delivery note',
                                'siahuat', 'siah', 'uat', 'æ€è¯é”', 'siah uat',
                                'monthly', 'month', 'æœˆ', 'æœˆåº¦'
                            ]
                            
                            # æ£€æŸ¥ä¸»æ—¨æ˜¯å¦åŒ…å«æ’é™¤å…³é”®å­—
                            has_exclude_keywords = any(keyword in subject_lower for keyword in exclude_keywords)
                            if has_exclude_keywords:
                                should_exclude = True
                                print(f"[DEBUG] é‚®ä»¶{i} è¢«æ’é™¤(æ— æ—¶é—´): åŒ…å«æ’é™¤å…³é”®å­—")
                        
                        if should_exclude:
                            continue  # è·³è¿‡è¿™ä¸ªé‚®ä»¶
                        
                        # æ„å»ºè®¢å•ä¿¡æ¯ï¼ŒåŒ…å«å‘ä»¶äºº
                        order_info = f"é‚®ä»¶ä¸»é¢˜(æ— æ—¶é—´): {subject_line}"
                        if sender_line:
                            order_info += f" - {sender_line}"
                        
                        # æ£€æŸ¥æ˜¯å¦å·²ç»æ‰£è¿‡åˆ†
                        deduction_key = "Order Lateness: å‘¨ä¸‰12ç‚¹åæäº¤è®¢å•"
                        if deduction_key not in existing_deductions:
                            late_orders.append(order_info)
                        else:
                            late_orders.append(order_info + " (å·²æ‰£åˆ†)")
            
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"è¯»å–é‚®ä»¶æ—¥å¿—å¤±è´¥: {e}")
                return
            
            print(f"[DEBUG] æœ€ç»ˆæ‰¾åˆ°çš„è¿Ÿäº¤è®¢å•æ•°é‡: {len(late_orders)}")
            for order in late_orders:
                print(f"[DEBUG] è¿Ÿäº¤è®¢å•: {order}")
            
            # æ˜¾ç¤ºç»“æœå¹¶ç›´æ¥æ˜¾ç¤ºæ‰£åˆ†ç¡®è®¤ç•Œé¢
            if late_orders:
                # ç»Ÿè®¡éœ€è¦æ‰£åˆ†çš„æ•°é‡
                need_deduction = [order for order in late_orders if "(å·²æ‰£åˆ†)" not in order]
                if need_deduction:
                    # ç›´æ¥æ˜¾ç¤ºæ‰£åˆ†ç¡®è®¤ç•Œé¢ï¼Œä¸æ˜¾ç¤ºä¸­é—´çš„ä¿¡æ¯æ¡†
                    self._show_deduction_confirmation_ui(need_deduction, demerit_file, outlet_sheets)
                else:
                    messagebox.showinfo("æ‰£åˆ†æ£€æŸ¥", "æ‰€æœ‰è®¢å•éƒ½å·²æ‰£åˆ†ã€‚")
            else:
                messagebox.showinfo("æ‰£åˆ†æ£€æŸ¥", "æœªå‘ç°å‘¨ä¸‰12ç‚¹åçš„è¿Ÿäº¤è®¢å•ã€‚")
                
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"è¯»å–æ‰£åˆ†æ–‡ä»¶å¤±è´¥: {e}")
            return
    
    def _show_deduction_confirmation_ui(self, need_deduction, demerit_file, outlet_sheets):
        """æ˜¾ç¤ºæ‰£åˆ†ç¡®è®¤ç•Œé¢ - è®©ç”¨æˆ·é€‰æ‹©è¦æ‰£åˆ†çš„è®¢å•å’Œè¾“å…¥å½•å…¥äºº"""
        import tkinter as tk
        from tkinter import messagebox
        from datetime import datetime
        import openpyxl
        
        # åˆ›å»ºæ‰£åˆ†ç¡®è®¤çª—å£
        confirmation_window = tk.Toplevel(self)
        confirmation_window.title("æ‰£åˆ†ç¡®è®¤ / Deduction Confirmation")
        confirmation_window.geometry("1300x900")  # å¢åŠ çª—å£å¤§å°
        confirmation_window.configure(bg="#1e293b")  # ä½¿ç”¨ä¸ä¸»ç¨‹åºç›¸åŒçš„æ·±è‰²èƒŒæ™¯
        
        # å±…ä¸­æ˜¾ç¤ºçª—å£
        confirmation_window.update_idletasks()
        x = (confirmation_window.winfo_screenwidth() // 2) - (800 // 2)
        y = (confirmation_window.winfo_screenheight() // 2) - (1000 // 2)
        confirmation_window.geometry(f"1300x1000+{x}+{y}")
        
        # ä¸»å®¹å™¨
        main_container = tk.Frame(confirmation_window, bg="#1e293b")
        main_container.pack(expand=True, fill="both", padx=50, pady=40)  # å¢åŠ è¾¹è·
        
        # æ ‡é¢˜ - ä½¿ç”¨æ¸å˜æ•ˆæœ
        title_frame = tk.Frame(main_container, bg="#1e293b")
        title_frame.pack(fill="x", pady=(0, 30))
        
        title_label = tk.Label(
            title_frame,
            text="æ‰£åˆ†ç¡®è®¤ / Deduction Confirmation",
            font=("Microsoft YaHei", 22, "bold"),  # å¢å¤§å­—ä½“
            bg="#1e293b",
            fg="#60a5fa"  # ä½¿ç”¨è“è‰²çªå‡ºæ ‡é¢˜
        )
        title_label.pack()
        
        # å‰¯æ ‡é¢˜
        subtitle_label = tk.Label(
            title_frame,
            text="è¯·é€‰æ‹©éœ€è¦æ‰£åˆ†çš„è®¢å•å¹¶è¾“å…¥å½•å…¥äººä¿¡æ¯",
            font=("Microsoft YaHei", 12),
            bg="#1e293b",
            fg="#94a3b8"
        )
        subtitle_label.pack(pady=(5, 0))
        
        # å½•å…¥äººè¾“å…¥æ¡† - ç¾åŒ–è®¾è®¡
        entry_person_frame = tk.Frame(main_container, bg="#1e293b")
        entry_person_frame.pack(fill="x", pady=(0, 25))
        
        # å½•å…¥äººæ ‡ç­¾
        entry_label = tk.Label(
            entry_person_frame,
            text="å½•å…¥äºº / Entry Person:",
            font=("Microsoft YaHei", 16, "bold"),  # å¢å¤§å­—ä½“
            bg="#1e293b",
            fg="#fbbf24"  # ä½¿ç”¨é»„è‰²çªå‡º
        )
        entry_label.pack(anchor="w", pady=(0, 8))
        
        # å½•å…¥äººè¾“å…¥æ¡†å®¹å™¨
        entry_input_frame = tk.Frame(entry_person_frame, bg="#1e293b")
        entry_input_frame.pack(fill="x")
        
        entry_person_var = tk.StringVar()
        entry_person_entry = tk.Entry(
            entry_input_frame,
            textvariable=entry_person_var,
            font=("Microsoft YaHei", 14),  # å¢å¤§å­—ä½“
            bg="#475569",  # æ›´æ·±çš„èƒŒæ™¯è‰²
            fg="#f8fafc",  # æ›´äº®çš„æ–‡å­—è‰²
            insertbackground="#fbbf24",  # å…‰æ ‡é¢œè‰²
            width=45,  # å¢åŠ å®½åº¦
            relief="flat",  # æ‰å¹³åŒ–è®¾è®¡
            bd=0  # æ— è¾¹æ¡†
        )
        entry_person_entry.pack(side="left", pady=(0, 0))
        
        # è¾“å…¥æ¡†æç¤º
        entry_hint = tk.Label(
            entry_input_frame,
            text="è¯·è¾“å…¥æ‚¨çš„å§“åæˆ–å‘˜å·¥ID",
            font=("Microsoft YaHei", 10),
            bg="#1e293b",
            fg="#64748b"
        )
        entry_hint.pack(side="left", padx=(10, 0), pady=(0, 0))
        
        # è®¢å•é€‰æ‹©è¯´æ˜ - ç¾åŒ–è®¾è®¡
        instruction_frame = tk.Frame(main_container, bg="#1e293b")
        instruction_frame.pack(fill="x", pady=(0, 15))
        
        instruction_label = tk.Label(
            instruction_frame,
            text="è¯·é€‰æ‹©éœ€è¦æ‰£åˆ†çš„è®¢å•ï¼ˆå‹¾é€‰è¡¨ç¤ºè¦æ‰£åˆ†ï¼‰ï¼š",
            font=("Microsoft YaHei", 14, "bold"),  # å¢å¤§å­—ä½“
            bg="#1e293b",
            fg="#10b981"  # ä½¿ç”¨ç»¿è‰²çªå‡º
        )
        instruction_label.pack(anchor="w")
        
        # è®¢å•æ•°é‡æ˜¾ç¤º
        order_count_label = tk.Label(
            instruction_frame,
            text=f"å…±å‘ç° {len(need_deduction)} ä¸ªè¿Ÿäº¤è®¢å•",
            font=("Microsoft YaHei", 11),
            bg="#1e293b",
            fg="#94a3b8"
        )
        order_count_label.pack(anchor="w", pady=(3, 0))
        
        # åˆ›å»ºæ»šåŠ¨æ¡†æ¶æ¥å®¹çº³è®¢å•åˆ—è¡¨ - ç¾åŒ–è®¾è®¡
        list_container = tk.Frame(main_container, bg="#1e293b")
        list_container.pack(fill="both", expand=True, pady=(0, 20))
        
        # åˆ—è¡¨æ ‡é¢˜æ 
        list_header = tk.Frame(list_container, bg="#334155", relief="flat")
        list_header.pack(fill="x", pady=(0, 5))
        
        # æ ‡é¢˜æ æ ‡ç­¾
        tk.Label(
            list_header,
            text="è®¢å•åˆ—è¡¨ / Order List",
            font=("Microsoft YaHei", 12, "bold"),
            bg="#334155",
            fg="#f8fafc"
        ).pack(side="left", padx=15, pady=8)
        
        # æ»šåŠ¨åŒºåŸŸ
        canvas = tk.Canvas(list_container, bg="#1e293b", highlightthickness=0, height=400)
        scrollbar = tk.Scrollbar(list_container, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg="#1e293b")
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        # ç»‘å®šé¼ æ ‡æ»šè½®äº‹ä»¶ï¼Œä¿®å¤æ»šåŠ¨é—®é¢˜
        def _on_mousewheel(event):
            canvas.yview_scroll(int(-1*(event.delta/120)), "units")
        
        # ç»‘å®šæ»šè½®äº‹ä»¶åˆ°ç”»å¸ƒ
        canvas.bind("<MouseWheel>", _on_mousewheel)
        
        # ç»‘å®šæ»šè½®äº‹ä»¶åˆ°æ»šåŠ¨æ¡†æ¶
        scrollable_frame.bind("<MouseWheel>", _on_mousewheel)
        
        # ç»‘å®šæ»šè½®äº‹ä»¶åˆ°æ‰€æœ‰å­ç»„ä»¶
        def bind_mousewheel_to_children(widget):
            widget.bind("<MouseWheel>", _on_mousewheel)
            for child in widget.winfo_children():
                bind_mousewheel_to_children(child)
        
        bind_mousewheel_to_children(scrollable_frame)
        
        # è®¢å•é€‰æ‹©å˜é‡
        order_vars = {}
        
        # ä»é…ç½®æ–‡ä»¶è¯»å–é—¨å¸‚æ˜ å°„çš„å‡½æ•°ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
        def get_outlet_from_order(order_text):
            """ä»è®¢å•æ–‡æœ¬ä¸­æå–é—¨å¸‚åç§°ï¼Œä¼˜å…ˆæ ¹æ®å‘ä»¶äººè¯†åˆ«"""
            try:
                # è·å–é…ç½®æ–‡ä»¶è·¯å¾„
                config_file = self.config_file_var.get()
                print(f"[DEBUG] é…ç½®æ–‡ä»¶è·¯å¾„: {config_file}")
                
                if config_file and os.path.exists(config_file):
                    print(f"[DEBUG] é…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œå¼€å§‹è¯»å–...")
                    import pandas as pd
                    # è¯»å–OUTLETå·¥ä½œè¡¨
                    df = pd.read_excel(config_file, sheet_name="OUTLET")
                    print(f"[DEBUG] æˆåŠŸè¯»å–OUTLETå·¥ä½œè¡¨ï¼Œå…±{len(df)}è¡Œ")
                    
                    # æ„å»ºé—¨å¸‚æ˜ å°„å­—å…¸ - ä½¿ç”¨æœ‰åºå­—å…¸ä¿æŒä¼˜å…ˆçº§
                    from collections import OrderedDict
                    outlet_mapping = OrderedDict()
                    
                    # ç¬¬ä¸€è½®ï¼šæ·»åŠ å®Œæ•´åç§°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                    for _, row in df.iterrows():
                        short_name = str(row['Short Name']).strip().upper()
                        full_name = str(row['Outlet Full Name']).strip().lower()
                        email_name = str(row['Name in Email']).strip().lower()
                        
                        print(f"[DEBUG] è¡Œæ•°æ®: Short='{short_name}', Full='{full_name}', Email='{email_name}'")
                        
                        # åªæ·»åŠ æœ‰æ•ˆçš„å®Œæ•´åç§°ï¼Œç›´æ¥ä½¿ç”¨Short Nameä½œä¸ºå€¼
                        if short_name and short_name != 'nan':
                            if full_name and full_name != 'nan':
                                outlet_mapping[full_name] = short_name
                            if email_name and email_name != 'nan':
                                outlet_mapping[email_name] = short_name
                    
                    # ç¬¬äºŒè½®ï¼šæ·»åŠ å•è¯å˜ä½“ï¼ˆè¾ƒä½ä¼˜å…ˆçº§ï¼‰
                    for _, row in df.iterrows():
                        short_name = str(row['Short Name']).strip().upper()
                        full_name = str(row['Outlet Full Name']).strip().lower()
                        
                        if short_name and short_name != 'nan' and full_name and full_name != 'nan':
                            # åªå¯¹å®Œæ•´çš„é—¨å¸‚åç§°æ·»åŠ å•è¯å˜ä½“
                            if ' ' in full_name:
                                words = full_name.split()
                                for word in words:
                                    if len(word) >= 3:  # åªæ·»åŠ é•¿åº¦>=3çš„å•è¯ï¼Œé¿å…é€šç”¨è¯
                                        # æ£€æŸ¥è¿™ä¸ªå•è¯æ˜¯å¦å·²ç»è¢«æ›´å…·ä½“çš„åç§°ä½¿ç”¨
                                        if word not in outlet_mapping:
                                            outlet_mapping[word] = short_name
                    
                    # ä¸å†ä½¿ç”¨ç¡¬ç¼–ç çš„åˆ«åæ˜ å°„ï¼Œå®Œå…¨ä¾èµ–é…ç½®æ–‡ä»¶
                    
                    print(f"[DEBUG] æ„å»ºçš„é—¨å¸‚æ˜ å°„: {outlet_mapping}")
                    
                    # ä¼˜å…ˆå°è¯•ä»å‘ä»¶äººè¯†åˆ«é—¨å¸‚
                    if "[å‘ä»¶äºº]" in order_text:
                        sender_part = order_text.split("[å‘ä»¶äºº]")[1].strip()
                        print(f"[DEBUG] å‘ä»¶äºº: '{sender_part}'")
                        
                        # å°è¯•åŒ¹é…å‘ä»¶äºº - ä¼˜å…ˆåŒ¹é…æ›´é•¿çš„åç§°
                        sender_lower = sender_part.lower()
                        best_match = None
                        best_match_length = 0
                        
                        for key, value in outlet_mapping.items():
                            if key in sender_lower and key != 'nan':
                                if len(key) > best_match_length:
                                    best_match = (key, value)
                                    best_match_length = len(key)
                        
                        if best_match:
                            key, value = best_match
                            print(f"[DEBUG] å‘ä»¶äººåŒ¹é…æˆåŠŸ: '{key}' -> '{value}' (é•¿åº¦: {len(key)})")
                            return value
                    
                    # å¦‚æœå‘ä»¶äººåŒ¹é…å¤±è´¥ï¼Œå°è¯•ä»ä¸»é¢˜è¯†åˆ«
                    if "[ä¸»é¢˜]" in order_text:
                        # å¤„ç†æ–°æ ¼å¼ï¼šæå–ä¸»é¢˜ä½†æ’é™¤å‘ä»¶äººéƒ¨åˆ†
                        if " - [å‘ä»¶äºº]" in order_text:
                            subject = order_text.split("[ä¸»é¢˜]")[1].split(" - [å‘ä»¶äºº]")[0].strip()
                        else:
                            subject = order_text.split("[ä¸»é¢˜]")[1].strip()
                        
                        print(f"[DEBUG] ä¸»é¢˜: '{subject}'")
                        
                        # å°†ä¸»é¢˜è½¬æ¢ä¸ºå°å†™è¿›è¡ŒåŒ¹é…
                        subject_lower = subject.lower()
                        
                        # å°è¯•åŒ¹é…é—¨å¸‚åç§° - ä¼˜å…ˆåŒ¹é…æ›´é•¿çš„åç§°
                        best_match = None
                        best_match_length = 0
                        
                        for key, value in outlet_mapping.items():
                            if key in subject_lower and key != 'nan':
                                if len(key) > best_match_length:
                                    best_match = (key, value)
                                    best_match_length = len(key)
                        
                        if best_match:
                            key, value = best_match
                            print(f"[DEBUG] ä¸»é¢˜åŒ¹é…æˆåŠŸ: '{key}' -> '{value}' (é•¿åº¦: {len(key)})")
                            return value
                
            except Exception as e:
                print(f"[é”™è¯¯] è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
                import traceback
                traceback.print_exc()
            
            # å¦‚æœéƒ½åŒ¹é…å¤±è´¥ï¼Œå°è¯•ä»å‘ä»¶äººæå–æ ‡è¯†ç¬¦
            print(f"[DEBUG] ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼Œä»å‘ä»¶äººæå–æ ‡è¯†ç¬¦")
            if "[å‘ä»¶äºº]" in order_text:
                sender_part = order_text.split("[å‘ä»¶äºº]")[1].strip()
                print(f"[DEBUG] å¤‡ç”¨æ–¹æ¡ˆ - å‘ä»¶äºº: '{sender_part}'")
                
                # å°è¯•ä»å‘ä»¶äººåç§°ä¸­æå–æ ‡è¯†ç¬¦
                # ç§»é™¤å¸¸è§çš„åç¼€å¦‚ "SMRT", "Mall", "Centre" ç­‰
                sender_clean = sender_part.lower()
                common_suffixes = [' smrt', ' mall', ' centre', ' center', ' plaza', ' point', ' gogo']
                for suffix in common_suffixes:
                    if sender_clean.endswith(suffix):
                        sender_clean = sender_clean[:-len(suffix)].strip()
                        break
                
                # æå–å‰å‡ ä¸ªå•è¯çš„é¦–å­—æ¯æˆ–ä½¿ç”¨å·²çŸ¥æ˜ å°„
                words = sender_clean.split()
                if len(words) >= 2:
                    # å¯¹äºå¤šè¯åç§°ï¼Œå°è¯•æå–é¦–å­—æ¯
                    result = ''.join([word[0].upper() for word in words[:2]])
                    print(f"[DEBUG] å¤‡ç”¨ç»“æœï¼ˆé¦–å­—æ¯ï¼‰: '{result}'")
                    return result
                elif len(words) == 1:
                    # å¯¹äºå•è¯åç§°ï¼Œä½¿ç”¨å‰3ä¸ªå­—ç¬¦
                    result = words[0][:3].upper()
                    print(f"[DEBUG] å¤‡ç”¨ç»“æœï¼ˆå‰3å­—ç¬¦ï¼‰: '{result}'")
                    return result
            
            # æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šä»ä¸»é¢˜æå–
            if "[ä¸»é¢˜]" in order_text:
                # å¤„ç†æ–°æ ¼å¼ï¼šæå–ä¸»é¢˜ä½†æ’é™¤å‘ä»¶äººéƒ¨åˆ†
                if " - [å‘ä»¶äºº]" in order_text:
                    subject = order_text.split("[ä¸»é¢˜]")[1].split(" - [å‘ä»¶äºº]")[0].strip()
                else:
                    subject = order_text.split("[ä¸»é¢˜]")[1].strip()
                
                # å°è¯•æå–é—¨å¸‚ä»£ç ï¼ˆé€šå¸¸åœ¨å¼€å¤´ï¼‰
                words = subject.split()
                if words:
                    # æŸ¥æ‰¾åŒ…å«é—¨å¸‚ä»£ç çš„å•è¯ï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªæˆ–ç¬¬äºŒä¸ªå•è¯ï¼‰
                    for word in words[:2]:  # åªæ£€æŸ¥å‰ä¸¤ä¸ªå•è¯
                        clean_word = word.strip('-_').upper()
                        if len(clean_word) >= 2 and len(clean_word) <= 4:  # é—¨å¸‚ä»£ç é€šå¸¸æ˜¯2-4ä¸ªå­—ç¬¦
                            print(f"[DEBUG] å¤‡ç”¨ç»“æœï¼ˆä¸»é¢˜ï¼‰: '{clean_word}'")
                            return clean_word
            
            return "UNKNOWN"
        
        # æ·»åŠ è®¢å•é€‰æ‹©æ¡† - ç¾åŒ–è®¾è®¡
        for i, order in enumerate(need_deduction):
            # äº¤æ›¿è¡Œé¢œè‰²
            row_color = "#1e293b" if i % 2 == 0 else "#334155"
            
            order_frame = tk.Frame(scrollable_frame, bg=row_color, relief="flat")
            order_frame.pack(fill="x", pady=1)
            
            # å¤é€‰æ¡† - ç¾åŒ–
            var = tk.BooleanVar(value=True)  # é»˜è®¤å…¨éƒ¨é€‰ä¸­
            order_vars[order] = var
            
            checkbox = tk.Checkbutton(
                order_frame,
                variable=var,
                bg=row_color,
                fg="#ffffff",
                selectcolor=row_color,  # é€‰ä¸­æ—¶ä½¿ç”¨è¡ŒèƒŒæ™¯è‰²
                activebackground=row_color,
                activeforeground="#ffffff",
                font=("Arial", 14, "bold"),  # ä½¿ç”¨Arialå­—ä½“æ˜¾ç¤ºå‹¾é€‰æ ‡è®°
                relief="flat",
                bd=0,
                indicatoron=True,
                cursor="hand2",
                highlightthickness=0  # ç§»é™¤ç„¦ç‚¹é«˜äº®
            )
            checkbox.pack(side="left", padx=(15, 12), pady=4)  # é€‚ä¸­çš„è¾¹è·
            
            # æ·»åŠ é€‰ä¸­çŠ¶æ€çš„è§†è§‰åé¦ˆ
            def update_checkbox_style():
                # ä¿æŒç®€æ´ï¼Œåªæ”¹å˜èƒŒæ™¯è‰²
                checkbox.config(
                    bg=row_color,  # å§‹ç»ˆä½¿ç”¨è¡ŒèƒŒæ™¯è‰²
                    selectcolor=row_color,  # é€‰ä¸­æŒ‡ç¤ºå™¨ä¹Ÿä½¿ç”¨è¡ŒèƒŒæ™¯è‰²
                    activebackground=row_color  # æ¿€æ´»æ—¶ä¹Ÿä½¿ç”¨è¡ŒèƒŒæ™¯è‰²
                )
            
            # ç»‘å®šå˜é‡å˜åŒ–äº‹ä»¶
            var.trace("w", lambda *args: update_checkbox_style())
            # åˆå§‹åŒ–æ ·å¼
            update_checkbox_style()
            
            # è®¢å•ä¿¡æ¯æ ‡ç­¾ - ç¾åŒ–
            order_label = tk.Label(
                order_frame,
                text=order,
                font=("Microsoft YaHei", 11),
                bg=row_color,
                fg="#f8fafc",
                anchor="w",
                justify="left"
            )
            order_label.pack(side="left", fill="x", expand=True, padx=(0, 10), pady=8)
            
            # é—¨å¸‚åç§°æ ‡ç­¾ - æ˜¾ç¤ºåœ¨å³ä¾§
            outlet_name = get_outlet_from_order(order)
            outlet_label = tk.Label(
                order_frame,
                text=f"[{outlet_name}]",
                font=("Microsoft YaHei", 11, "bold"),
                bg=row_color,
                fg="#10b981",  # ç»¿è‰²æ˜¾ç¤ºé—¨å¸‚åç§°
                anchor="e",
                justify="right"
            )
            outlet_label.pack(side="right", padx=(0, 15), pady=8)
        
        # æ”¾ç½®æ»šåŠ¨ç»„ä»¶
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # æŒ‰é’®æ¡†æ¶ - ç¾åŒ–è®¾è®¡
        button_frame = tk.Frame(main_container, bg="#1e293b")
        button_frame.pack(fill="x", pady=(25, 0))
        
        # å·¦ä¾§æŒ‰é’®ç»„
        left_buttons = tk.Frame(button_frame, bg="#1e293b")
        left_buttons.pack(side="left")
        
        # å…¨é€‰/å–æ¶ˆå…¨é€‰æŒ‰é’® - ç¾åŒ–
        select_all_var = tk.BooleanVar(value=True)
        
        def toggle_select_all():
            select_all = select_all_var.get()
            for var in order_vars.values():
                var.set(select_all)
            select_all_var.set(not select_all)
            # æ›´æ–°æŒ‰é’®æ–‡æœ¬
            if select_all:
                select_all_btn.config(text="å–æ¶ˆå…¨é€‰ / Deselect All")
            else:
                select_all_btn.config(text="å…¨é€‰ / Select All")
        
        select_all_btn = tk.Button(
            left_buttons,
            text="å–æ¶ˆå…¨é€‰ / Deselect All",  # åˆå§‹çŠ¶æ€ä¸ºå…¨é€‰ï¼Œæ‰€ä»¥æ˜¾ç¤ºå–æ¶ˆå…¨é€‰
            command=toggle_select_all,
            font=("Microsoft YaHei", 12, "bold"),
            bg="#6366f1",  # ä½¿ç”¨é›è“è‰²
            fg="white",
            padx=25,
            pady=10,
            relief="raised",  # æ”¹ä¸ºå‡¸èµ·æ•ˆæœ
            bd=3,  # å¢åŠ è¾¹æ¡†å®½åº¦
            cursor="hand2",  # é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ‰‹å‹
            activebackground="#4f46e5",  # ç‚¹å‡»æ—¶çš„é¢œè‰²
            activeforeground="white"  # ç‚¹å‡»æ—¶çš„æ–‡å­—é¢œè‰²
        )
        select_all_btn.pack(side="left", padx=(0, 15))
        
        # ç¡®è®¤æ‰£åˆ†æŒ‰é’®
        def confirm_deduction():
            # è·å–å½•å…¥äºº
            entry_person = entry_person_var.get().strip()
            if not entry_person:
                messagebox.showwarning("è­¦å‘Š", "è¯·è¾“å…¥å½•å…¥äººä¿¡æ¯ï¼")
                return
            
            # è·å–é€‰ä¸­çš„è®¢å•
            selected_orders = [order for order, var in order_vars.items() if var.get()]
            if not selected_orders:
                messagebox.showwarning("è­¦å‘Š", "è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¢å•è¿›è¡Œæ‰£åˆ†ï¼")
                return
            
            # æ‰§è¡Œæ‰£åˆ†
            try:
                wb = openpyxl.load_workbook(demerit_file)
                deduction_count = 0
                
                # æœ¬åœ°é—¨å¸‚æå–å‡½æ•°
                def extract_outlet_from_subject(subject_or_sender):
                    """ä»é‚®ä»¶ä¸»é¢˜æˆ–å‘ä»¶äººä¸­æå–é—¨å¸‚åç§°ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶æ˜ å°„"""
                    try:
                        # è·å–é…ç½®æ–‡ä»¶è·¯å¾„
                        config_file = self.config_file_var.get()
                        if config_file and os.path.exists(config_file):
                            import pandas as pd
                            # è¯»å–OUTLETå·¥ä½œè¡¨
                            df = pd.read_excel(config_file, sheet_name="OUTLET")
                            
                            # æ„å»ºé—¨å¸‚æ˜ å°„å­—å…¸ - ä½¿ç”¨æœ‰åºå­—å…¸ä¿æŒä¼˜å…ˆçº§
                            from collections import OrderedDict
                            outlet_mapping = OrderedDict()
                            
                            # ç¬¬ä¸€è½®ï¼šæ·»åŠ å®Œæ•´åç§°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                            for _, row in df.iterrows():
                                short_name = str(row['Short Name']).strip().upper()
                                full_name = str(row['Outlet Full Name']).strip().lower()
                                email_name = str(row['Name in Email']).strip().lower()
                                
                                # åªæ·»åŠ æœ‰æ•ˆçš„å®Œæ•´åç§°ï¼Œç›´æ¥ä½¿ç”¨Short Nameä½œä¸ºå€¼
                                if short_name and short_name != 'nan':
                                    if full_name and full_name != 'nan':
                                        outlet_mapping[full_name] = short_name
                                    if email_name and email_name != 'nan':
                                        outlet_mapping[email_name] = short_name
                            
                            # ç¬¬äºŒè½®ï¼šæ·»åŠ å•è¯å˜ä½“ï¼ˆè¾ƒä½ä¼˜å…ˆçº§ï¼‰
                            for _, row in df.iterrows():
                                short_name = str(row['Short Name']).strip().upper()
                                full_name = str(row['Outlet Full Name']).strip().lower()
                                
                                if short_name and short_name != 'nan' and full_name and full_name != 'nan':
                                    # åªå¯¹å®Œæ•´çš„é—¨å¸‚åç§°æ·»åŠ å•è¯å˜ä½“
                                    if ' ' in full_name:
                                        words = full_name.split()
                                        for word in words:
                                            if len(word) >= 3:  # åªæ·»åŠ é•¿åº¦>=3çš„å•è¯ï¼Œé¿å…é€šç”¨è¯
                                                # æ£€æŸ¥è¿™ä¸ªå•è¯æ˜¯å¦å·²ç»è¢«æ›´å…·ä½“çš„åç§°ä½¿ç”¨
                                                if word not in outlet_mapping:
                                                    outlet_mapping[word] = short_name
                            
                            # ç¬¬ä¸‰è½®ï¼šæ·»åŠ ä¸€äº›å¸¸è§çš„åˆ«åæ˜ å°„
                            common_aliases = {
                                'poiz centre': 'TPC',
                                'poiz': 'TPC',
                                'junction 8': 'J8',
                                'j8': 'J8',
                                'paya lebar quarter': 'PLQ',
                                'paya': 'PLQ',
                                'woodlands': 'WL',
                                'woodland': 'WL',
                                'west mall': 'WSM',
                                'west': 'WSM',
                                'toa payoh': 'TPY',
                                'toa': 'TPY',
                                'oasis gogo': 'OAS',
                                'oasis': 'OAS',
                                'canberra plaza': 'CBP',
                                'canberra': 'CBP',
                                'grantral mall': 'GTM',
                                'grantral': 'GTM'
                            }
                            
                            # æ·»åŠ åˆ«åæ˜ å°„ï¼Œä½†ä¸è¦è¦†ç›–å·²æœ‰çš„æ˜ å°„
                            for alias, short_code in common_aliases.items():
                                if alias not in outlet_mapping:
                                    outlet_mapping[alias] = short_code
                            
                            # å°è¯•åŒ¹é… - ä¼˜å…ˆåŒ¹é…æ›´é•¿çš„åç§°
                            text_lower = subject_or_sender.lower()
                            best_match = None
                            best_match_length = 0
                            
                            for key, value in outlet_mapping.items():
                                if key in text_lower and key != 'nan':
                                    if len(key) > best_match_length:
                                        best_match = (key, value)
                                        best_match_length = len(key)
                            
                            if best_match:
                                key, value = best_match
                                return value
                    
                    except Exception as e:
                        print(f"[é”™è¯¯] è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
                    
                    # å¦‚æœéƒ½åŒ¹é…å¤±è´¥ï¼Œæå–ç¬¬ä¸€ä¸ªå•è¯ä½œä¸ºå¤‡ç”¨
                    words = subject_or_sender.split()
                    if words:
                        first_word = words[0].strip('-_').upper()
                        if len(first_word) >= 2:
                            return first_word
                    
                    return "UNKNOWN"
                
                # è§£æé€‰ä¸­çš„è®¢å•ï¼Œæå–é—¨å¸‚ä¿¡æ¯å’Œæ—¶é—´
                order_details = []
                for order in selected_orders:
                    # è§£æè®¢å•ä¿¡æ¯ï¼šé‚®ä»¶æ—¶é—´: 2025-08-20 17:50 - [ä¸»é¢˜] West mall weekly order week 4 AUGUST 2025 - [å‘ä»¶äºº] Grantral Mall
                    if "é‚®ä»¶æ—¶é—´:" in order and "[ä¸»é¢˜]" in order:
                        # æå–æ—¶é—´ - ä½¿ç”¨æ›´ç²¾ç¡®çš„åˆ†å‰²æ–¹æ³•
                        temp = order.split("é‚®ä»¶æ—¶é—´:")[1].strip()
                        if " - [ä¸»é¢˜]" in temp:
                            time_part = temp.split(" - [ä¸»é¢˜]")[0].strip()
                        else:
                            time_part = temp.split("-")[0].strip()  # å¤‡ç”¨æ–¹æ³•
                        
                        # æå–ä¸»é¢˜
                        if " - [å‘ä»¶äºº]" in order:
                            # æ–°æ ¼å¼ï¼šåŒ…å«å‘ä»¶äººä¿¡æ¯
                            subject_part = order.split("[ä¸»é¢˜]")[1].split(" - [å‘ä»¶äºº]")[0].strip()
                            sender_part = order.split("[å‘ä»¶äºº]")[1].strip()
                        else:
                            # æ—§æ ¼å¼ï¼šåªæœ‰ä¸»é¢˜
                            subject_part = order.split("[ä¸»é¢˜]")[1].strip()
                            sender_part = ""
                        
                        print(f"[DEBUG] åŸå§‹è®¢å•: {order}")
                        print(f"[DEBUG] æå–çš„æ—¶é—´: '{time_part}'")
                        print(f"[DEBUG] æå–çš„ä¸»é¢˜: '{subject_part}'")
                        print(f"[DEBUG] æå–çš„å‘ä»¶äºº: '{sender_part}'")
                        
                        # ä¼˜å…ˆä»å‘ä»¶äººæå–é—¨å¸‚åç§°ï¼Œç„¶åæ‰æ˜¯ä¸»é¢˜
                        if sender_part:
                            outlet_name = extract_outlet_from_subject(sender_part)
                            print(f"[DEBUG] ä»å‘ä»¶äººè¯†åˆ«é—¨å¸‚: {sender_part} â†’ {outlet_name}")
                        else:
                            outlet_name = extract_outlet_from_subject(subject_part)
                            print(f"[DEBUG] ä»ä¸»é¢˜è¯†åˆ«é—¨å¸‚: {subject_part} â†’ {outlet_name}")
                        
                        order_details.append({
                            'time': time_part,
                            'subject': subject_part,
                            'outlet': outlet_name,
                            'full_order': order
                        })
                
                # æŒ‰é—¨å¸‚åˆ†ç»„æ‰£åˆ†
                outlet_deductions = {}
                for detail in order_details:
                    outlet = detail['outlet']
                    if outlet not in outlet_deductions:
                        outlet_deductions[outlet] = []
                    outlet_deductions[outlet].append(detail)
                
                print(f"[DEBUG] é—¨å¸‚åˆ†ç»„ç»“æœ:")
                for outlet, orders in outlet_deductions.items():
                    print(f"  {outlet}: {len(orders)} ä¸ªè®¢å•")
                
                # ä¸ºæ¯ä¸ªé—¨å¸‚æ·»åŠ æ‰£åˆ†è®°å½•
                for outlet, orders in outlet_deductions.items():
                    # æŸ¥æ‰¾å¯¹åº”çš„é—¨å¸‚å·¥ä½œè¡¨
                    sheet_found = False
                    matched_sheet = None
                    
                    print(f"[DEBUG] ä¸ºé—¨å¸‚ {outlet} æŸ¥æ‰¾å·¥ä½œè¡¨...")
                    print(f"[DEBUG] å¯ç”¨å·¥ä½œè¡¨: {outlet_sheets}")
                    
                    # å°è¯•å¤šç§åŒ¹é…æ–¹å¼
                    best_match = None
                    best_match_score = 0
                    
                    for sheet_name in outlet_sheets:
                        sheet_upper = sheet_name.upper()
                        outlet_upper = outlet.upper()
                        
                        # 1. ç²¾ç¡®åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                        if sheet_upper == outlet_upper:
                            best_match = sheet_name
                            best_match_score = 100
                            break
                        
                        # 2. é—¨å¸‚ä»£ç åŒ…å«åœ¨å·¥ä½œè¡¨åä¸­ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰
                        elif outlet_upper in sheet_upper:
                            score = len(outlet_upper) / len(sheet_upper) * 50
                            if score > best_match_score:
                                best_match = sheet_name
                                best_match_score = score
                        
                        # 3. å·¥ä½œè¡¨ååŒ…å«åœ¨é—¨å¸‚ä»£ç ä¸­ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼Œä½†è¦é¿å…é”™è¯¯åŒ¹é…ï¼‰
                        elif sheet_upper in outlet_upper:
                            # åªæœ‰å½“å·¥ä½œè¡¨åé•¿åº¦ >= é—¨å¸‚ä»£ç é•¿åº¦çš„80%æ—¶æ‰è€ƒè™‘
                            if len(sheet_upper) >= len(outlet_upper) * 0.8:
                                score = len(sheet_upper) / len(outlet_upper) * 30
                                if score > best_match_score:
                                    best_match = sheet_name
                                    best_match_score = score
                    
                    if best_match:
                        matched_sheet = best_match
                    
                    if matched_sheet and matched_sheet in wb.sheetnames:
                        sheet_found = True
                        print(f"[DEBUG] åŒ¹é…åˆ°å·¥ä½œè¡¨: {outlet} â†’ {matched_sheet}")
                        ws = wb[matched_sheet]
                        
                        # æ‰¾åˆ°ä¸‹ä¸€ä¸ªç©ºè¡Œ
                        next_row = 3
                        while next_row <= ws.max_row:
                            if (ws[f'A{next_row}'].value is None and 
                                ws[f'B{next_row}'].value is None and 
                                ws[f'C{next_row}'].value is None and
                                ws[f'D{next_row}'].value is None and
                                ws[f'E{next_row}'].value is None and
                                ws[f'F{next_row}'].value is None and
                                ws[f'G{next_row}'].value is None and
                                ws[f'H{next_row}'].value is None):
                                break
                            next_row += 1
                        
                        if next_row > ws.max_row:
                            next_row = ws.max_row + 1
                        
                        # æ„å»ºNoteså†…å®¹ï¼šåªæ˜¾ç¤ºé‚®ä»¶å‘é€çš„æ—¶é—´
                        time_list = []
                        for order_detail in orders:
                            time_list.append(order_detail['time'])
                        notes_content = f"é‚®ä»¶å‘é€æ—¶é—´: {'; '.join(time_list)}"
                        
                        # æ·»åŠ æ‰£åˆ†è®°å½•
                        ws[f'A{next_row}'] = datetime.now().strftime("%Y-%m-%d")
                        ws[f'B{next_row}'] = "Weekly Order"
                        ws[f'C{next_row}'] = "Order Lateness: å‘¨ä¸‰12ç‚¹åæäº¤è®¢å•"
                        ws[f'D{next_row}'] = entry_person
                        ws[f'E{next_row}'] = 10
                        ws[f'F{next_row}'] = f"{next_row-2}"
                        ws[f'G{next_row}'] = entry_person
                        ws[f'H{next_row}'] = notes_content
                        
                        deduction_count += 1
                    
                    if not sheet_found:
                        print(f"[è­¦å‘Š] æœªæ‰¾åˆ°é—¨å¸‚ {outlet} å¯¹åº”çš„å·¥ä½œè¡¨")
                
                # ä¿å­˜æ–‡ä»¶
                wb.save(demerit_file)
                wb.close()
                
                messagebox.showinfo("æ‰£åˆ†æˆåŠŸ", 
                                  f"âœ… æ‰£åˆ†å®Œæˆï¼\n\n"
                                  f"å·²ä¸º {deduction_count} ä¸ªé—¨å¸‚æ·»åŠ æ‰£åˆ†è®°å½•\n"
                                  f"å½•å…¥äºº: {entry_person}\n"
                                  f"æ‰£åˆ†è®¢å•æ•°é‡: {len(selected_orders)} ä¸ª\n\n"
                                  f"æ‰£åˆ†è®°å½•å·²ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚")
                
                confirmation_window.destroy()
                
            except Exception as e:
                messagebox.showerror("æ‰£åˆ†å¤±è´¥", f"âŒ æ‰£åˆ†å¤±è´¥: {e}\n\nè¯·æ£€æŸ¥æ‰£åˆ†æ–‡ä»¶æ˜¯å¦è¢«å…¶ä»–ç¨‹åºå ç”¨ã€‚")
                
                # ä¿å­˜æ–‡ä»¶
                wb.save(demerit_file)
                wb.close()
                
                messagebox.showinfo("æ‰£åˆ†æˆåŠŸ", 
                                  f"âœ… æ‰£åˆ†å®Œæˆï¼\n\n"
                                  f"å·²ä¸º {deduction_count} ä¸ªé—¨å¸‚æ·»åŠ æ‰£åˆ†è®°å½•\n"
                                  f"å½•å…¥äºº: {entry_person}\n"
                                  f"æ‰£åˆ†è®¢å•æ•°é‡: {len(selected_orders)} ä¸ª\n\n"
                                  f"æ‰£åˆ†è®°å½•å·²ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚")
                
                confirmation_window.destroy()
                
            except Exception as e:
                messagebox.showerror("æ‰£åˆ†å¤±è´¥", f"âŒ æ‰£åˆ†å¤±è´¥: {e}\n\nè¯·æ£€æŸ¥æ‰£åˆ†æ–‡ä»¶æ˜¯å¦è¢«å…¶ä»–ç¨‹åºå ç”¨ã€‚")
        
        confirm_btn = tk.Button(
            left_buttons,
            text="ç¡®è®¤æ‰£åˆ† / Confirm Deduction",
            command=confirm_deduction,
            font=("Microsoft YaHei", 16, "bold"),  # å¢å¤§å­—ä½“
            bg="#dc2626",  # çº¢è‰²
            fg="white",
            padx=35,
            pady=12,
            relief="raised",  # æ”¹ä¸ºå‡¸èµ·æ•ˆæœ
            bd=4,  # å¢åŠ è¾¹æ¡†å®½åº¦
            cursor="hand2",  # é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ‰‹å‹
            activebackground="#b91c1c",  # ç‚¹å‡»æ—¶çš„é¢œè‰²
            activeforeground="white"  # ç‚¹å‡»æ—¶çš„æ–‡å­—é¢œè‰²
        )
        confirm_btn.pack(side="left", padx=(0, 15))
        
        # å³ä¾§æŒ‰é’®
        right_buttons = tk.Frame(button_frame, bg="#1e293b")
        right_buttons.pack(side="right")
        
        # å–æ¶ˆæŒ‰é’® - ç¾åŒ–
        cancel_btn = tk.Button(
            right_buttons,
            text="å–æ¶ˆ / Cancel",
            command=confirmation_window.destroy,
            font=("Microsoft YaHei", 12, "bold"),
            bg="#6b7280",  # ç°è‰²
            fg="white",
            padx=25,
            pady=10,
            relief="raised",  # æ”¹ä¸ºå‡¸èµ·æ•ˆæœ
            bd=3,  # å¢åŠ è¾¹æ¡†å®½åº¦
            cursor="hand2",  # é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ‰‹å‹
            activebackground="#4b5563",  # ç‚¹å‡»æ—¶çš„é¢œè‰²
            activeforeground="white"  # ç‚¹å‡»æ—¶çš„æ–‡å­—é¢œè‰²
        )
        cancel_btn.pack()
        
        # è®¾ç½®ç„¦ç‚¹åˆ°å½•å…¥äººè¾“å…¥æ¡†
        entry_person_entry.focus()
    
    def _show_manual_f5_deduction(self):
        """æ˜¾ç¤ºæ‰‹åŠ¨æ‰£åˆ†ç•Œé¢"""
        from tkinter import messagebox
        import tkinter as tk
        import pandas as pd
        from datetime import datetime
        
        # æ£€æŸ¥æ‰£åˆ†æ–‡ä»¶
        demerit_file = self.demerit_file_var.get()
        if not demerit_file:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆé€‰æ‹©æ‰£åˆ†æ–‡ä»¶ï¼")
            return
        
        # åˆ›å»ºæ‰‹åŠ¨æ‰£åˆ†çª—å£
        deduction_window = tk.Toplevel(self)
        deduction_window.title("æ‰‹åŠ¨æ‰£åˆ† / Manual Deduction")
        deduction_window.geometry("1100x900")  # è¿›ä¸€æ­¥å¢åŠ çª—å£å¤§å°
        deduction_window.configure(bg="#1e293b")  # ä½¿ç”¨ä¸ä¸»ç¨‹åºç›¸åŒçš„æ·±è‰²èƒŒæ™¯
        
        # å±…ä¸­æ˜¾ç¤ºçª—å£
        deduction_window.update_idletasks()
        x = (deduction_window.winfo_screenwidth() // 2) - (1100 // 2)
        y = (deduction_window.winfo_screenheight() // 2) - (900 // 2)
        deduction_window.geometry(f"1100x900+{x}+{y}")
        
        # ä¸»å®¹å™¨
        main_container = tk.Frame(deduction_window, bg="#1e293b")
        main_container.pack(expand=True, fill="both", padx=60, pady=50)
        
        # æ ‡é¢˜
        title_label = tk.Label(
            main_container,
            text="æ‰‹åŠ¨æ‰£åˆ†ç³»ç»Ÿ / Manual Deduction System",
            font=("Microsoft YaHei", 18, "bold"),  # ä»22å‡å°åˆ°18
            bg="#1e293b",
            fg="#3b82f6"  # ä½¿ç”¨ä¸»ç¨‹åºçš„è“è‰²
        )
        title_label.pack(pady=(0, 25))  # ä»40å‡å°åˆ°25
        
        # é—¨å¸‚é€‰æ‹©
        outlet_frame = tk.Frame(main_container, bg="#1e293b")
        outlet_frame.pack(pady=12, fill="x")  # ä»20å‡å°åˆ°12
        
        tk.Label(
            outlet_frame,
            text="é€‰æ‹©é—¨å¸‚ / Select Outlet:",
            font=("Microsoft YaHei", 13, "bold"),  # ä»16å‡å°åˆ°13
            bg="#1e293b",
            fg="#e2e8f0"  # æµ…è‰²æ–‡å­—
        ).pack(anchor="w")
        
        # è¯»å–æ‰£åˆ†æ–‡ä»¶è·å–é—¨å¸‚åˆ—è¡¨
        try:
            demerit_df = pd.read_excel(demerit_file, sheet_name=None)
            outlet_sheets = [sheet for sheet in demerit_df.keys() if sheet not in 
                           ["Point Deduction Overview", "OPS Demerit Point Scoring", "Data - DO NOT EDIT", "Demerit System"]]
        except:
            # å¦‚æœæ‰£åˆ†æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œä»é…ç½®æ–‡ä»¶è¯»å–é—¨å¸‚åˆ—è¡¨
            try:
                config_file = self.config_file_var.get()
                if config_file and os.path.exists(config_file):
                    config_df = pd.read_excel(config_file, sheet_name="OUTLET")
                    outlet_sheets = [str(row['Short Name']).strip().upper() for _, row in config_df.iterrows() 
                                   if str(row['Short Name']).strip().upper() != 'NAN']
                else:
                    outlet_sheets = []
            except:
                outlet_sheets = []
        
        outlet_var = tk.StringVar(value=outlet_sheets[0] if outlet_sheets else "")
        outlet_menu = tk.OptionMenu(outlet_frame, outlet_var, *outlet_sheets)
        outlet_menu.config(
            font=("Microsoft YaHei", 12),  # ä»14å‡å°åˆ°12
            width=35,  # ä»40å‡å°åˆ°35
            bg="#334155",  # æ·±è‰²èƒŒæ™¯
            fg="#e2e8f0",  # æµ…è‰²æ–‡å­—
            activebackground="#475569",
            activeforeground="#ffffff",
            relief="flat",
            bd=0
        )
        outlet_menu.pack(pady=6, anchor="w")  # ä»10å‡å°åˆ°6
        
        # Categoryé€‰æ‹©
        category_frame = tk.Frame(main_container, bg="#1e293b")
        category_frame.pack(pady=12, fill="x")  # ä»20å‡å°åˆ°12
        
        tk.Label(
            category_frame,
            text="é€‰æ‹©ç±»åˆ« / Select Category:",
            font=("Microsoft YaHei", 13, "bold"),  # ä»16å‡å°åˆ°13
            bg="#1e293b",
            fg="#e2e8f0"
        ).pack(anchor="w")
        
        # ä»æ‰£åˆ†æ–‡ä»¶è¯»å–å¯ç”¨çš„Category
        try:
            if "OPS Demerit Point Scoring" in demerit_df:
                scoring_df = demerit_df["OPS Demerit Point Scoring"]
                available_categories = set()
                for _, row in scoring_df.iterrows():
                    if pd.notna(row.iloc[1]):  # Båˆ—
                        category = str(row.iloc[1]).strip()
                        if category:
                            available_categories.add(category)
                
                if not available_categories:
                    available_categories = ["Weekly Order", "Weekly Amendment", "Invoice Submission", "Chef Issue", "Operations", "Customer Feedback Issue"]
            else:
                available_categories = ["Weekly Order", "Weekly Amendment", "Invoice Submission", "Chef Issue", "Operations", "Customer Feedback Issue"]
        except:
            available_categories = ["Weekly Order", "Weekly Amendment", "Invoice Submission", "Chef Issue", "Operations", "Customer Feedback Issue"]
        
        category_var = tk.StringVar(value=sorted(available_categories)[0] if available_categories else "")
        category_menu = tk.OptionMenu(category_frame, category_var, *sorted(available_categories))
        category_menu.config(
            font=("Microsoft YaHei", 12),  # ä»14å‡å°åˆ°12
            width=35,  # ä»40å‡å°åˆ°35
            bg="#334155",
            fg="#e2e8f0",
            activebackground="#475569",
            activeforeground="#ffffff",
            relief="flat",
            bd=0
        )
        category_menu.pack(pady=6, anchor="w")  # ä»10å‡å°åˆ°6
        
        # Descriptioné€‰æ‹©
        description_frame = tk.Frame(main_container, bg="#1e293b")
        description_frame.pack(pady=12, fill="x")  # ä»20å‡å°åˆ°12
        
        tk.Label(
            description_frame,
            text="é€‰æ‹©æè¿° / Select Description:",
            font=("Microsoft YaHei", 13, "bold"),  # ä»16å‡å°åˆ°13
            bg="#1e293b",
            fg="#e2e8f0"
        ).pack(anchor="w")
        
        # æ ¹æ®é€‰æ‹©çš„Categoryæ›´æ–°Descriptioné€‰é¡¹
        def update_description_options(*args):
            try:
                if "OPS Demerit Point Scoring" in demerit_df:
                    scoring_df = demerit_df["OPS Demerit Point Scoring"]
                    available_descriptions = []
                    
                    # é¦–å…ˆå°è¯•æ ¹æ®CategoryåŒ¹é…Description
                    for _, row in scoring_df.iterrows():
                        if pd.notna(row.iloc[1]) and pd.notna(row.iloc[2]):  # Båˆ—å’ŒCåˆ—
                            category = str(row.iloc[1]).strip()
                            description = str(row.iloc[2]).strip()
                            if category == category_var.get() and description:
                                available_descriptions.append(description)
                    
                    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”Categoryçš„Descriptionï¼Œæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„
                    if not available_descriptions:
                        for _, row in scoring_df.iterrows():
                            if pd.notna(row.iloc[2]):  # Cåˆ—
                                description = str(row.iloc[2]).strip()
                                if description and description not in available_descriptions:
                                    available_descriptions.append(description)
                    
                    # å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œæ·»åŠ é»˜è®¤é€‰é¡¹
                    if not available_descriptions:
                        available_descriptions = ["Order Lateness", "Order Wrong Data", "Amendment Lateness", "Other", "Late Submission", "Incorrect Information", "Missing Data", "Quality Issue"]
                else:
                    available_descriptions = ["Order Lateness", "Order Wrong Data", "Amendment Lateness", "Other", "Late Submission", "Incorrect Information", "Missing Data", "Quality Issue"]
                
                # æ›´æ–°Descriptionèœå•
                description_menu['menu'].delete(0, 'end')
                for desc in available_descriptions:
                    description_menu['menu'].add_command(
                        label=desc,
                        command=lambda d=desc: description_var.set(d)
                    )
                if available_descriptions:
                    description_var.set(available_descriptions[0])
                    
            except Exception as e:
                print(f"æ›´æ–°Descriptioné€‰é¡¹å¤±è´¥: {e}")
        
        # ç»‘å®šCategoryé€‰æ‹©äº‹ä»¶
        category_var.trace('w', update_description_options)
        
        description_var = tk.StringVar()
        description_menu = tk.OptionMenu(description_frame, description_var, "")
        description_menu.config(
            font=("Microsoft YaHei", 12),  # ä»14å‡å°åˆ°12
            width=35,  # ä»40å‡å°åˆ°35
            bg="#334155",
            fg="#e2e8f0",
            activebackground="#475569",
            activeforeground="#ffffff",
            relief="flat",
            bd=0
        )
        description_menu.pack(pady=6, anchor="w")  # ä»10å‡å°åˆ°6
        
        # æ‰£åˆ†åˆ†æ•°ï¼ˆå›ºå®š10åˆ†ï¼‰
        score_frame = tk.Frame(main_container, bg="#1e293b")
        score_frame.pack(pady=12, fill="x")  # ä»20å‡å°åˆ°12
        
        tk.Label(
            score_frame,
            text="æ‰£åˆ†åˆ†æ•° / Deduction Score: 10 (å›ºå®š)",
            font=("Microsoft YaHei", 13, "bold"),  # ä»16å‡å°åˆ°13
            bg="#1e293b",
            fg="#10b981"  # ç»¿è‰²æ˜¾ç¤ºå›ºå®šåˆ†æ•°
        ).pack(anchor="w")
        
        # å‘˜å·¥ID/å§“å
        employee_frame = tk.Frame(main_container, bg="#1e293b")
        employee_frame.pack(pady=12, fill="x")  # ä»20å‡å°åˆ°12
        
        tk.Label(
            employee_frame,
            text="å‘˜å·¥ID/å§“å / Employee ID/Name:",
            font=("Microsoft YaHei", 13, "bold"),  # ä»16å‡å°åˆ°13
            bg="#1e293b",
            fg="#e2e8f0"
        ).pack(anchor="w")
        
        employee_var = tk.StringVar()
        employee_entry = tk.Entry(
            employee_frame, 
            textvariable=employee_var, 
            font=("Microsoft YaHei", 12),  # ä»14å‡å°åˆ°12
            width=35,  # ä»40å‡å°åˆ°35
            bg="#334155",
            fg="#e2e8f0",
            insertbackground="#e2e8f0",
            relief="flat",
            bd=0
        )
        employee_entry.pack(pady=6, anchor="w")  # ä»10å‡å°åˆ°6
        
        # å¤‡æ³¨è¾“å…¥
        note_frame = tk.Frame(main_container, bg="#1e293b")
        note_frame.pack(pady=12, fill="x")  # ä»20å‡å°åˆ°12
        
        tk.Label(
            note_frame,
            text="å¤‡æ³¨ / Notes:",
            font=("Microsoft YaHei", 13, "bold"),  # ä»16å‡å°åˆ°13
            bg="#1e293b",
            fg="#e2e8f0"
        ).pack(anchor="w")
        
        note_text = tk.Text(
            note_frame, 
            height=4,  # ä»5å‡å°åˆ°4
            width=60,  # ä»70å‡å°åˆ°60
            font=("Microsoft YaHei", 12),  # ä»14å‡å°åˆ°12
            bg="#334155",
            fg="#e2e8f0",
            insertbackground="#e2e8f0",
            relief="flat",
            bd=0
        )
        note_text.pack(pady=6, anchor="w")  # ä»10å‡å°åˆ°6
        
        # æ‰£åˆ†æŒ‰é’®
        def apply_deduction():
            outlet = outlet_var.get()
            category = category_var.get()
            description = description_var.get()
            employee = employee_var.get()
            note = note_text.get("1.0", "end-1c")
            
            if not outlet:
                messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©é—¨å¸‚ï¼")
                return
            if not category:
                messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©ç±»åˆ«ï¼")
                return
            if not description:
                messagebox.showwarning("è­¦å‘Š", "è¯·é€‰æ‹©æè¿°ï¼")
                return
            if not employee.strip():
                messagebox.showwarning("è­¦å‘Š", "è¯·è¾“å…¥å‘˜å·¥ID/å§“åï¼")
                return
            if not note.strip():
                messagebox.showwarning("è­¦å‘Š", "è¯·è¾“å…¥æ‰£åˆ†å¤‡æ³¨ï¼")
                return
            
            try:
                # è¯»å–æ‰£åˆ†æ–‡ä»¶
                demerit_df = pd.read_excel(demerit_file, sheet_name=None)
                
                # è·å–é—¨å¸‚å·¥ä½œè¡¨
                if outlet not in demerit_df:
                    messagebox.showerror("é”™è¯¯", f"æ‰¾ä¸åˆ°é—¨å¸‚ {outlet} çš„å·¥ä½œè¡¨ï¼")
                    return
                
                outlet_df = demerit_df[outlet]
                
                # å‡†å¤‡æ–°æ•°æ®ï¼ˆå›ºå®š10åˆ†ï¼‰
                new_data = {
                    'A': datetime.now().strftime("%Y-%m-%d"),  # æ—¥æœŸ
                    'B': category,  # Category
                    'C': description,  # Description
                    'D': employee,  # å‘˜å·¥ID/å§“å
                    'E': 10,  # æ‰£åˆ†åˆ†æ•°ï¼ˆå›ºå®š10åˆ†ï¼‰
                    'F': f"{len(outlet_df) + 1}",  # æ‰£åˆ†ç¼–å·
                    'G': "System",  # å½•å…¥äºº
                    'H': note  # å¤‡æ³¨
                }
                
                # ä½¿ç”¨pandasçš„appendæ–¹æ³•æ·»åŠ æ–°è¡Œï¼Œè¿™æ ·æ›´å®‰å…¨
                new_row_df = pd.DataFrame([new_data])
                outlet_df = pd.concat([outlet_df, new_row_df], ignore_index=True)
                
                # ä¿å­˜æ–‡ä»¶ - ä½¿ç”¨openpyxlç›´æ¥æ“ä½œï¼Œä¿ç•™å…¬å¼å’Œæ ¼å¼
                try:
                    # è¯»å–ç°æœ‰çš„Excelæ–‡ä»¶
                    from openpyxl import load_workbook
                    wb = load_workbook(demerit_file)
                    
                    # è·å–æˆ–åˆ›å»ºå·¥ä½œè¡¨
                    if outlet in wb.sheetnames:
                        ws = wb[outlet]
                    else:
                        ws = wb.create_sheet(outlet)
                    
                    # æ‰¾åˆ°ä¸‹ä¸€ä¸ªç©ºè¡Œ - ä»ç¬¬3è¡Œå¼€å§‹æŸ¥æ‰¾ï¼ˆè·³è¿‡æ ‡é¢˜è¡Œï¼‰
                    next_row = 3  # ä»ç¬¬3è¡Œå¼€å§‹ï¼Œå› ä¸ºç¬¬1-2è¡Œæ˜¯æ ‡é¢˜
                    
                    # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå®Œå…¨ç©ºçš„è¡Œ
                    while next_row <= ws.max_row:
                        # æ£€æŸ¥Aåˆ—åˆ°Håˆ—æ˜¯å¦éƒ½ä¸ºç©º
                        if (ws[f'A{next_row}'].value is None and 
                            ws[f'B{next_row}'].value is None and 
                            ws[f'C{next_row}'].value is None and
                            ws[f'D{next_row}'].value is None and
                            ws[f'E{next_row}'].value is None and
                            ws[f'F{next_row}'].value is None and
                            ws[f'G{next_row}'].value is None and
                            ws[f'H{next_row}'].value is None):
                            break
                        next_row += 1
                    
                    # å¦‚æœæ²¡æ‰¾åˆ°ç©ºè¡Œï¼Œå°±åœ¨æœ€åæ·»åŠ æ–°è¡Œ
                    if next_row > ws.max_row:
                        next_row = ws.max_row + 1
                    
                    # å†™å…¥æ–°æ•°æ®
                    ws[f'A{next_row}'] = new_data['A']  # æ—¥æœŸ
                    ws[f'B{next_row}'] = new_data['B']  # Category
                    ws[f'C{next_row}'] = new_data['C']  # Description
                    ws[f'D{next_row}'] = new_data['D']  # å‘˜å·¥ID/å§“å
                    ws[f'E{next_row}'] = new_data['E']  # æ‰£åˆ†åˆ†æ•°
                    ws[f'F{next_row}'] = new_data['F']  # æ‰£åˆ†ç¼–å·
                    ws[f'G{next_row}'] = new_data['G']  # å½•å…¥äºº
                    ws[f'H{next_row}'] = new_data['H']  # å¤‡æ³¨
                    
                    # ä¿å­˜æ–‡ä»¶
                    wb.save(demerit_file)
                    wb.close()
                    
                except Exception as e:
                    # å¦‚æœopenpyxlå¤±è´¥ï¼Œå›é€€åˆ°pandasæ–¹æ³•
                    print(f"openpyxlä¿å­˜å¤±è´¥ï¼Œä½¿ç”¨pandasæ–¹æ³•: {e}")
                    with pd.ExcelWriter(demerit_file, engine='openpyxl', mode='w') as writer:
                        for sheet_name, df in demerit_df.items():
                            df.to_excel(writer, sheet_name=sheet_name, index=False)
                
                result_text = f"æ‰£åˆ†å·²æˆåŠŸåº”ç”¨ï¼š\n\n"
                result_text += f"é—¨å¸‚: {outlet}\n"
                result_text += f"ç±»åˆ«: {category}\n"
                result_text += f"æè¿°: {description}\n"
                result_text += f"æ‰£åˆ†åˆ†æ•°: 10\n"
                result_text += f"å‘˜å·¥: {employee}\n"
                result_text += f"å¤‡æ³¨: {note}\n\n"
                result_text += "æ‰£åˆ†è®°å½•å·²ä¿å­˜åˆ°æ‰£åˆ†æ–‡ä»¶ä¸­ã€‚"
                
                messagebox.showinfo("æ‰£åˆ†æˆåŠŸ", result_text)
                deduction_window.destroy()
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"ä¿å­˜æ‰£åˆ†è®°å½•å¤±è´¥: {e}")
        
        # æŒ‰é’®å®¹å™¨ - å±…ä¸­å¸ƒå±€
        button_container = tk.Frame(main_container, bg="#1e293b")
        button_container.pack(pady=25, fill="x")  # ä»40å‡å°åˆ°25
        
        # æŒ‰é’®æ¡†æ¶ - ç”¨äºå±…ä¸­æŒ‰é’®
        button_frame = tk.Frame(button_container, bg="#1e293b")
        button_frame.pack(expand=True)
        
        apply_btn = tk.Button(
            button_frame,
            text="åº”ç”¨æ‰£åˆ† / Apply Deduction",
            command=apply_deduction,
            font=("Microsoft YaHei", 14, "bold"),  # ä»16å‡å°åˆ°14
            bg="#dc2626",  # çº¢è‰²æŒ‰é’®
            fg="white",
            padx=35,  # ä»40å‡å°åˆ°35
            pady=12,  # ä»15å‡å°åˆ°12
            relief="flat",
            bd=0,
            cursor="hand2"
        )
        apply_btn.pack(side="left", padx=(0, 25))  # ä»30å‡å°åˆ°25
        
        cancel_btn = tk.Button(
            button_frame,
            text="å–æ¶ˆ / Cancel",
            command=deduction_window.destroy,
            font=("Microsoft YaHei", 14, "bold"),  # ä»16å‡å°åˆ°14
            bg="#64748b",  # ç°è‰²æŒ‰é’®
            fg="white",
            padx=35,  # ä»40å‡å°åˆ°35
            pady=12,  # ä»15å‡å°åˆ°12
            relief="flat",
            bd=0,
            cursor="hand2"
        )
        cancel_btn.pack(side="left")
        
        # åˆå§‹åŒ–Descriptioné€‰é¡¹
        update_description_options()

    def _select_ordering_function(self, command):
        """é€‰æ‹©è®¢å•åŠŸèƒ½"""
        command()

    def _get_hover_color(self, color):
        """è·å–æ‚¬åœé¢œè‰²"""
        hover_colors = {
            "#3b82f6": "#1d4ed8",
            "#10b981": "#059669",
            "#8b5cf6": "#7c3aed",
            "#ef4444": "#dc2626",
            "#f97316": "#ea580c"
        }
        return hover_colors.get(color, color)

    def _create_navigation_buttons(self):
        for widget in self.button_container.winfo_children():
            widget.destroy()
        inner_frame = ctk.CTkFrame(
    self.button_container,
     fg_color="transparent")
        inner_frame.pack(expand=True)

        # è®¢å•åŠŸèƒ½åˆ†ç±»
        ordering_frame = ctk.CTkFrame(inner_frame, fg_color="transparent")
        ordering_frame.pack(fill="x", pady=(0, 20))

        # è®¢å•åŠŸèƒ½æ ‡é¢˜
        ordering_title = ctk.CTkLabel(
            ordering_frame,
            text="ğŸ“‹ è¨‚å–®åŠŸèƒ½\nOrdering Function",
            font=("Microsoft YaHei", 14, "bold"),
            text_color=ACCENT_BLUE,
            justify="center"
        )
        ordering_title.pack(pady=(0, 10))

        # è®¢å•åŠŸèƒ½æŒ‰é’®
        ordering_functions = [
            ("download_title", self.show_download_ui, ACCENT_BLUE),
            ("automation_title", self.show_automation_ui, ACCENT_GREEN),
            ("checklist_title", self.show_checklist_ui, ACCENT_PURPLE),
            ("send_emails", self.show_email_sending_ui, ACCENT_RED),
            ("operation_supplies", self.show_operation_supplies_ui, "#F97316")
        ]

        for func_key, command, color in ordering_functions:
            btn = NavigationButton(
                ordering_frame,
                text=t(func_key),
                command=lambda c=command, k=func_key: self._select_function(
                    c, k),
                fg_color=DARK_PANEL,
                anchor="center",
                border_width=2,
                border_color=color,
                corner_radius=10,
                font=FONT_BIGBTN,
                text_color=get_contrast_color(DARK_PANEL),
                height=45
            )
            btn.pack(fill="x", pady=4, padx=10)
            self.nav_buttons[func_key] = btn

        # æœˆç»“åŠŸèƒ½åˆ†ç±»
        monthend_frame = ctk.CTkFrame(inner_frame, fg_color="transparent")
        monthend_frame.pack(fill="x", pady=(20, 20))

        # æœˆç»“åŠŸèƒ½æ ‡é¢˜
        monthend_title = ctk.CTkLabel(
            monthend_frame,
            text="ğŸ“Š æœˆçµåŠŸèƒ½\nMonthend Closing Function",
            font=("Microsoft YaHei", 14, "bold"),
            text_color="#FF6B35",
            justify="center"
        )
        monthend_title.pack(pady=(0, 10))

        # æœˆç»“åŠŸèƒ½æŒ‰é’®ï¼ˆæš‚æ—¶ä¸ºå ä½ç¬¦ï¼‰
        monthend_functions = [
            ("monthend_placeholder", self.show_monthend_placeholder, "#FF6B35")
        ]

        for func_key, command, color in monthend_functions:
            btn = NavigationButton(
                monthend_frame,
                text="å³å°‡æ¨å‡º\nComing Soon",
                command=command,
                fg_color=DARK_PANEL,
                anchor="center",
                border_width=2,
                border_color=color,
                corner_radius=10,
                font=FONT_BIGBTN,
                text_color="#888888",
                height=45
            )
            btn.pack(fill="x", pady=4, padx=10)
            self.nav_buttons[func_key] = btn

        # ç³»ç»ŸåŠŸèƒ½åˆ†ç±»
        system_frame = ctk.CTkFrame(inner_frame, fg_color="transparent")
        system_frame.pack(fill="x", pady=(20, 0))

        # ç³»ç»ŸåŠŸèƒ½æŒ‰é’®
        system_functions = [
            ("theme_selection", self.show_theme_selection, "#8b5cf6"),
            ("exit_system", self._on_close, "#64748B")
        ]

        for func_key, command, color in system_functions:
            btn = NavigationButton(
                system_frame,
                text=t(func_key),
                command=command,
                fg_color=DARK_PANEL,
                anchor="center",
                border_width=2,
                border_color=color,
                corner_radius=10,
                font=FONT_BIGBTN,
                text_color=get_contrast_color(DARK_PANEL),
                height=45
            )
            btn.pack(fill="x", pady=4, padx=10)
            self.nav_buttons[func_key] = btn
        # ç”¨æˆ·æŒ‡å—æŒ‰é’®
        help_btn = NavigationButton(
            system_frame,
            text="ç”¨æˆ·æŒ‡å—\nUser Guide",
            command=self.show_user_guide,
            fg_color=ACCENT_PURPLE,
            anchor="center",
            border_width=2,
            border_color=ACCENT_PURPLE,
            corner_radius=10,
            font=FONT_BIGBTN,
            text_color=get_contrast_color(ACCENT_PURPLE),
            height=45
        )
        help_btn.pack(fill="x", pady=4, padx=10)

    def show_theme_selection(self):
        """æ˜¾ç¤ºä¸»é¢˜é€‰æ‹©ç•Œé¢"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()
        self._create_theme_selection_ui()

    def _create_theme_selection_ui(self):
        """åˆ›å»ºä¸»é¢˜é€‰æ‹©ç•Œé¢"""
        # ä¸»å®¹å™¨
        main_container = ctk.CTkFrame(
            self.content_body, 
            fg_color=get_current_theme().dark_panel,
            corner_radius=30,
            width=1000,
            height=750
        )
        main_container.pack(expand=True, pady=50)
        main_container.pack_propagate(False)

        # è£…é¥°æ¡
        decoration_frame = ctk.CTkFrame(
            main_container,
            fg_color=get_current_theme().accent_blue,
            height=8,
            corner_radius=0
        )
        decoration_frame.pack(fill="x")

        # æ ‡é¢˜åŒºåŸŸ
        title_frame = ctk.CTkFrame(main_container, fg_color="transparent")
        title_frame.pack(fill="x", padx=40, pady=30)

        title_label = ctk.CTkLabel(
            title_frame,
            text="ğŸ¨ ä¸»é¡Œé¸æ“‡",
            font=("Microsoft YaHei", 36, "bold"),
            text_color=get_current_theme().accent_blue
        )
        title_label.pack(pady=(0, 10))

        subtitle_label = ctk.CTkLabel(
            title_frame,
            text="é¸æ“‡æ‚¨å–œæ­¡çš„ç³»çµ±é¡è‰²ä¸»é¡Œ",
            font=("Microsoft YaHei", 18),
            text_color=get_current_theme().text_color
        )
        subtitle_label.pack()

        # ä¸»é¢˜é€‰æ‹©åŒºåŸŸ
        theme_container = ctk.CTkScrollableFrame(
            main_container,
            fg_color="transparent",
            width=900,
            height=500
        )
        theme_container.pack(fill="both", expand=True, padx=40, pady=20)

        # åˆ›å»ºä¸»é¢˜æŒ‰é’®
        self._create_modern_theme_buttons(theme_container)

        # åº•éƒ¨æŒ‰é’®åŒºåŸŸ
        btn_container = ctk.CTkFrame(main_container, fg_color="transparent")
        btn_container.pack(fill="x", padx=40, pady=20)

        confirm_btn = ctk.CTkButton(
            btn_container,
            text="ç¢ºèªé¸æ“‡",
            command=self._apply_theme_and_login,
            font=("Microsoft YaHei", 16, "bold"),
            fg_color=get_current_theme().accent_blue,
            hover_color=get_current_theme().btn_hover,
            width=200,
            height=50,
            corner_radius=25
        )
        confirm_btn.pack()

    def _create_modern_theme_buttons(self, parent):
        """åˆ›å»ºç°ä»£åŒ–ä¸»é¢˜æŒ‰é’®"""
        current_theme = get_current_theme()
        canvas = ctk.CTkCanvas(parent, bg=current_theme.dark_panel, highlightthickness=0)
        canvas.pack(fill="both", expand=True)

        # åˆ›å»ºä¸»é¢˜ç½‘æ ¼
        themes_per_row = 2
        theme_width = 400
        theme_height = 200
        padding = 20

        for i, (theme_key, theme) in enumerate(THEMES.items()):
            row = i // themes_per_row
            col = i % themes_per_row
            
            x = col * (theme_width + padding) + padding
            y = row * (theme_height + padding) + padding
            
            is_selected = theme_key == CURRENT_THEME
            
            # ä¸»é¢˜é¢„è§ˆå¡ç‰‡
            theme_preview = ctk.CTkFrame(
                parent,
                fg_color=theme.dark_panel,
                corner_radius=20,
                width=theme_width,
                height=theme_height,
                border_width=4 if is_selected else 2,
                border_color=theme.accent_blue if is_selected else theme.dark_panel
            )
            theme_preview.place(x=x, y=y)
            theme_preview.pack_propagate(False)

            # ä¸»é¢˜åç§°
            name_label = ctk.CTkLabel(
                theme_preview,
                text=theme.name,
                font=("Microsoft YaHei", 18, "bold"),
                text_color=theme.text_color
            )
            name_label.pack(pady=20)

            # ä¸»é¢˜æè¿°
            desc_label = ctk.CTkLabel(
                theme_preview,
                text=theme.description,
                font=("Microsoft YaHei", 12),
                text_color=theme.text_color,
                wraplength=350
            )
            desc_label.pack(pady=(0, 20))

            # é¢œè‰²é¢„è§ˆ
            color_preview = ctk.CTkFrame(
                theme_preview,
                fg_color="transparent",
                height=60
            )
            color_preview.pack(fill="x", padx=20, pady=(0, 20))

            # æ˜¾ç¤ºä¸»è¦é¢œè‰²
            colors = [theme.accent_blue, theme.accent_green, theme.accent_red, theme.accent_purple]
            for j, color in enumerate(colors):
                color_btn = ctk.CTkFrame(
                    color_preview,
                    fg_color=color,
                    width=40,
                    height=40,
                    corner_radius=20
                )
                color_btn.place(x=j * 50, y=10)

            # é€‰æ‹©æŒ‰é’®
            select_btn = ctk.CTkButton(
                theme_preview,
                text="é¸æ“‡æ­¤ä¸»é¡Œ" if not is_selected else "âœ“ å·²é¸æ“‡",
                command=lambda t=theme_key: self._select_theme(t),
                fg_color=theme.accent_blue if not is_selected else theme.accent_green,
                hover_color=theme.btn_hover,
                font=("Microsoft YaHei", 14, "bold"),
                text_color="white",
                width=150,
                height=35,
                corner_radius=15
            )
            select_btn.pack(pady=(0, 20))

            # é¼ æ ‡æ‚¬åœæ•ˆæœ
            def on_enter(e, frame=theme_preview, theme=theme, selected=is_selected, theme_key=theme_key):
                if not selected:
                    frame.configure(border_color=theme.accent_blue, border_width=3)

            def on_leave(e, frame=theme_preview, theme=theme, selected=is_selected, theme_key=theme_key):
                if selected:
                    frame.configure(border_color=theme.accent_blue, border_width=4)
                else:
                    # å¯¹äºäº®è‰²ä¸»é¢˜ï¼Œä½¿ç”¨æ›´æ˜æ˜¾çš„è¾¹æ¡†é¢œè‰²
                    if theme_key == "bright_light":
                        frame.configure(border_color="#cbd5e1", border_width=2)
                    else:
                        frame.configure(border_color=theme.dark_panel, border_width=2)

            theme_preview.bind("<Enter>", on_enter)
            theme_preview.bind("<Leave>", on_leave)

    def _select_theme(self, theme_key):
        """é€‰æ‹©ä¸»é¢˜"""
        global CURRENT_THEME
        CURRENT_THEME = theme_key
        self._create_theme_selection_ui()  # åˆ·æ–°ç•Œé¢

    def _apply_theme_and_login(self):
        """åº”ç”¨ä¸»é¢˜å¹¶ç™»å½•"""
        save_theme_config()
        self._apply_theme()
        self._show_main_menu()

    def _apply_theme(self):
        """åº”ç”¨å½“å‰ä¸»é¢˜"""
        theme = get_current_theme()
        
        # æ›´æ–°å…¨å±€é¢œè‰²å˜é‡
        global DARK_BG, DARK_PANEL, ACCENT_BLUE, BTN_HOVER, ACCENT_GREEN, ACCENT_RED, ACCENT_PURPLE
        DARK_BG = theme.dark_bg
        DARK_PANEL = theme.dark_panel
        ACCENT_BLUE = theme.accent_blue
        BTN_HOVER = theme.btn_hover
        ACCENT_GREEN = theme.accent_green
        ACCENT_RED = theme.accent_red
        ACCENT_PURPLE = theme.accent_purple

        # æ›´æ–°ä¸»çª—å£èƒŒæ™¯
        self.configure(fg_color=DARK_BG)
        
        # æ›´æ–°å¯¼èˆªæ 
        if hasattr(self, 'nav_frame'):
            self.nav_frame.configure(fg_color=DARK_PANEL)
        
        # æ›´æ–°å†…å®¹åŒºåŸŸ
        if hasattr(self, 'content_body'):
            self.content_body.configure(fg_color=DARK_BG)
        
        # æ›´æ–°å†…å®¹å®¹å™¨
        if hasattr(self, 'content_container'):
            self.content_container.configure(fg_color=DARK_PANEL)
        
        # æ›´æ–°ä¸»é¢˜é€‰æ‹©å™¨æŒ‰é’®é¢œè‰²
        if hasattr(self, 'theme_btn'):
            self.theme_btn.configure(
                fg_color=ACCENT_BLUE,
                hover_color=BTN_HOVER
            )
        
        # å¦‚æœæœ‰æ¸å˜ä¸»é¢˜ï¼Œåº”ç”¨æ¸å˜èƒŒæ™¯
        if theme.gradient_colors and len(theme.gradient_colors) >= 2:
            self._apply_gradient_background(theme.gradient_colors)
        else:
            self._remove_gradient_background()

    def _apply_gradient_background(self, gradient_colors):
        """åº”ç”¨æ¸å˜èƒŒæ™¯"""
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸å˜èƒŒæ™¯çš„å®ç°
        pass

    def _remove_gradient_background(self):
        """ç§»é™¤æ¸å˜èƒŒæ™¯"""
        # è¿™é‡Œå¯ä»¥æ·»åŠ ç§»é™¤æ¸å˜èƒŒæ™¯çš„å®ç°
        pass

    def show_monthend_placeholder(self):
        """æ˜¾ç¤ºæœˆç»“åŠŸèƒ½å ä½ç¬¦ç•Œé¢"""
        # æ£€æŸ¥å½“å‰é€‰ä¸­çš„åŠŸèƒ½
        if hasattr(
    self,
     'current_function') and self.current_function == 'supplier_statement':
            # å¦‚æœæ˜¯ä¾›åº”å•†å¯¹è´¦å•åŠŸèƒ½ï¼Œæ˜¾ç¤ºå‚å•†é€‰æ‹©ç•Œé¢
            self.show_supplier_selection_ui()
        else:
            # å…¶ä»–åŠŸèƒ½æ˜¾ç¤ºå ä½ç¬¦ç•Œé¢
            self._show_general_placeholder()

    def _show_general_placeholder(self):
        """æ˜¾ç¤ºé€šç”¨å ä½ç¬¦ç•Œé¢"""
        # åˆ›å»ºå ä½ç¬¦ç•Œé¢
        placeholder_frame = ctk.CTkFrame(
    self.content_body, fg_color="transparent")
        placeholder_frame.pack(fill="both", expand=True, padx=50, pady=50)

        # ä¸»è¦å†…å®¹å®¹å™¨
        content_frame = ctk.CTkFrame(
    placeholder_frame,
    fg_color=DARK_PANEL,
     corner_radius=20)
        content_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # å›¾æ ‡å’Œæ ‡é¢˜
        icon_label = ctk.CTkLabel(
            content_frame,
            text="ğŸš§",
            font=("Microsoft YaHei", 64),
            text_color="#FF6B35"
        )
        icon_label.pack(pady=(40, 20))

        title_label = ctk.CTkLabel(
            content_frame,
            text="æœˆçµåŠŸèƒ½é–‹ç™¼ä¸­\nMonthend Closing Function Under Development",
            font=("Microsoft YaHei", 24, "bold"),
            text_color="#FF6B35",
            justify="center"
        )
        title_label.pack(pady=(0, 30))

        # åŠŸèƒ½é¢„è§ˆ
        preview_text = (
            "å³å°‡æ¨å‡ºçš„æœˆçµåŠŸèƒ½å°‡åŒ…æ‹¬ï¼š\n"
            "Upcoming Monthend Closing features will include:\n\n"
            "ğŸ“Š æœˆåº¦éŠ·å”®å ±è¡¨ç”Ÿæˆ\n"
            "   Monthly Sales Report Generation\n\n"
            "ğŸ“ˆ ä¾›æ‡‰å•†å°è³¬å–®è™•ç†\n"
            "   Supplier Statement Processing\n\n"
            "ğŸ’° æˆæœ¬åˆ†æèˆ‡æ ¸ç®—\n"
            "   Cost Analysis & Accounting\n\n"
            "ğŸ“‹ åº«å­˜ç›¤é»æ•´ç†\n"
            "   Inventory Count Organization\n\n"
            "ğŸ”„ è‡ªå‹•åŒ–æœˆçµæµç¨‹\n"
            "   Automated Month-end Process"
        )

        preview_label = ctk.CTkLabel(
            content_frame,
            text=preview_text,
            font=("Microsoft YaHei", 14),
            text_color=TEXT_COLOR,
            justify="center"
        )
        preview_label.pack(pady=(0, 40))

        # è”ç³»ä¿¡æ¯
        contact_frame = ctk.CTkFrame(
    content_frame,
    fg_color="#2d2d2d",
     corner_radius=10)
        contact_frame.pack(fill="x", padx=40, pady=(0, 40))

        contact_label = ctk.CTkLabel(
            contact_frame,
            text="å¦‚æœ‰åŠŸèƒ½éœ€æ±‚å»ºè­°ï¼Œè«‹è¯ç¹«é–‹ç™¼åœ˜éšŠ\nFor feature requests, please contact the development team",
            font=("Microsoft YaHei", 12),
            text_color="#cccccc",
            justify="center"
        )
        contact_label.pack(pady=20)

    def show_supplier_selection_ui(self):
        """æ˜¾ç¤ºå‚å•†é€‰æ‹©ç•Œé¢"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®åŠŸèƒ½æ ‡é¢˜
        self.function_title.configure(
    text="ğŸ­ å» å•†é¸æ“‡ç³»çµ±\nSupplier Selection System")
        self.function_subtitle.configure(
    text="é¸æ“‡å» å•†ä»¥é€²è¡Œ SOA æ ¸å°\nSelect supplier for SOA reconciliation")

        # åˆ›å»ºå‚å•†é€‰æ‹©ç•Œé¢
        self._create_supplier_selection_content(self.content_body)

    def show_soa_reconciliation_ui(self):
        """æ˜¾ç¤ºSOAæ ¸å¯¹ç•Œé¢ - å·²å¼ƒç”¨ï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹"""
        # ç›´æ¥è·³è½¬åˆ°å‚å•†é€‰æ‹©ç•Œé¢
        self.show_supplier_selection_ui()

    def show_monthend_download_ui(self):
        """æ˜¾ç¤ºæœˆç»“æ–‡ä»¶ä¸‹è½½ç•Œé¢"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®åŠŸèƒ½æ ‡é¢˜
        self.function_title.configure(text="ğŸ“¥ æœˆçµæ–‡ä»¶ä¸‹è¼‰\nMonth-end File Download")
        self.function_subtitle.configure(
    text="å¾ Outlook ä¸‹è¼‰ SOA/Invoice ç­‰æœˆçµæ–‡ä»¶\nDownload SOA/Invoice and other month-end files from Outlook")

        # ç›´æ¥æ„å»ºæœˆç»“æ–‡ä»¶ä¸‹è½½ç•Œé¢
        self._create_monthend_download_content(self.content_body)

    def _create_monthend_download_content(self, parent):
        """åˆ›å»ºæœˆç»“ä¸‹è½½ç•Œé¢å†…å®¹"""
        # åˆ›å»ºUIæ¡†æ¶
        ui = MonthEndDownloadUI(parent)
        ui.pack(fill="both", expand=True)

        return ui

    def _create_supplier_selection_content(self, parent):
        """åˆ›å»ºå‚å•†é€‰æ‹©ç•Œé¢å†…å®¹"""
        # ä¸»å®¹å™¨
        main_frame = ctk.CTkFrame(parent, fg_color="transparent")
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # æ ‡é¢˜å’Œè¯´æ˜
        title_frame = ctk.CTkFrame(
    main_frame,
    fg_color=DARK_PANEL,
     corner_radius=12)
        title_frame.pack(fill="x", pady=(0, 20))

        ctk.CTkLabel(
            title_frame,
            text="ğŸ­ é¸æ“‡å» å•†é€²è¡Œ SOA æ ¸å°\nSelect Supplier for SOA Reconciliation",
            font=("Microsoft YaHei", 18, "bold"),
            text_color=ACCENT_BLUE
        ).pack(pady=20)

        ctk.CTkLabel(
            title_frame,
            text="è«‹é¸æ“‡æ‚¨è¦é€²è¡Œ SOA æ ¸å°çš„å» å•†\nPlease select the supplier you want to reconcile SOA for",
            font=("Microsoft YaHei", 12),
            text_color="#cccccc"
        ).pack(pady=(0, 20))

        # å‚å•†é€‰æ‹©å®¹å™¨
        suppliers_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        suppliers_frame.pack(fill="both", expand=True)

        # å‚å•†æŒ‰é’®ç½‘æ ¼å®¹å™¨
        grid_frame = ctk.CTkFrame(suppliers_frame, fg_color="transparent")
        grid_frame.pack(expand=True)

        # Siahuat æŒ‰é’®
        siahuat_btn = ctk.CTkButton(
            grid_frame,
            text="ğŸ¢ Siahuat æ ¸å°\nSiahuat Reconciliation",
            font=("Microsoft YaHei", 15, "bold"),
            fg_color=ACCENT_BLUE,
            hover_color="#0056b3",
            text_color="white",
            corner_radius=15,
            width=280,
            height=140,
            command=self._open_siahuat_window
        )
        siahuat_btn.grid(row=0, column=0, padx=30, pady=30)

        # Monthend Consolidate æŒ‰é’®
        monthend_btn = ctk.CTkButton(
            grid_frame,
            text="ğŸ“Š å¤šå» å•†æœˆçµæª¢æŸ¥\nMulti-Vendor Month-End Check",
            font=("Microsoft YaHei", 15, "bold"),
            fg_color=ACCENT_GREEN,
            hover_color="#047857",
            text_color="white",
            corner_radius=15,
            width=280,
            height=140,
            command=self._open_monthend_consolidate_window
        )
        monthend_btn.grid(row=0, column=1, padx=30, pady=30)

        # åº•éƒ¨è¯´æ˜
        info_frame = ctk.CTkFrame(
    main_frame,
    fg_color=DARK_PANEL,
     corner_radius=12)
        info_frame.pack(fill="x", pady=(20, 0))

        ctk.CTkLabel(
            info_frame,
            text="â„¹ï¸ é¸æ“‡ç›¸æ‡‰çš„åŠŸèƒ½é€²è¡Œ SOA æ ¸å°\nSelect the appropriate function for SOA reconciliation",
            font=("Microsoft YaHei", 11),
            text_color="#888888"
        ).pack(pady=15)

    def _open_siahuat_window(self):
        """æ‰“å¼€Siahuatä¸“ç”¨çš„SOAæ ¸å¯¹çª—å£"""
        # åˆ›å»ºæ–°çš„å¼¹çª—
        siahuat_window = SiahuatSOAWindow(self)
        siahuat_window.grab_set()  # æ¨¡æ€çª—å£

    def _open_monthend_consolidate_window(self):
        """æ‰“å¼€å¤šå» å•†æœˆçµæª¢æŸ¥åŠŸèƒ½çª—å£"""
        # åˆ›å»ºæ–°çš„å¼¹çª—
        monthend_window = ctk.CTkToplevel(self)
        monthend_window.title("å¤šå» å•†æœˆçµæª¢æŸ¥åŠŸèƒ½ / Multi-Vendor Month-End Check")
        monthend_window.geometry("1600x1000")
        
        # çª—å£å±…ä¸­é¡¯ç¤º
        monthend_window.update_idletasks()
        x = (monthend_window.winfo_screenwidth() - 1600) // 2
        y = (monthend_window.winfo_screenheight() - 1000) // 2
        monthend_window.geometry(f"1600x1000+{x}+{y}")
        
        monthend_window.grab_set()  # æ¨¡æ€çª—å£
        
        # ç›´æ¥å‰µå»ºçµ±ä¸€çš„å¤šå» å•†æœˆçµæª¢æŸ¥UI
        vendor_ui = SOAReconciliationUI(monthend_window)
        vendor_ui.pack(fill="both", expand=True)
    
    def _create_vendor_selection_ui(self, parent):
        """å‰µå»ºå» å•†é¸æ“‡ç•Œé¢"""
        # ä¸»æ¡†æ¶
        main_frame = ctk.CTkFrame(parent, fg_color=DARK_PANEL, corner_radius=20)
        main_frame.pack(fill="both", expand=True, padx=25, pady=(10, 15))
        
        # æ¨™é¡Œ
        title_frame = ctk.CTkFrame(main_frame, fg_color='transparent')
        title_frame.pack(fill='x', padx=25, pady=(20, 25))
        
        ctk.CTkLabel(
            title_frame,
            text="ğŸŒŸ æœˆçµæª¢æŸ¥ç³»çµ±",
            font=("Microsoft YaHei", 22, "bold"),
            text_color=ACCENT_GREEN
        ).pack(anchor='center')
        
        ctk.CTkLabel(
            title_frame,
            text="Month-End Check System",
            font=("Segoe UI", 14),
            text_color=TEXT_COLOR
        ).pack(anchor='center', pady=(5, 0))
        
        # å» å•†é¸æ“‡å€åŸŸ
        vendor_frame = ctk.CTkFrame(main_frame, fg_color='transparent')
        vendor_frame.pack(fill='both', expand=True, padx=25, pady=(0, 20))
        
        ctk.CTkLabel(
            vendor_frame,
            text="è«‹é¸æ“‡å» å•† / Select Vendor",
            font=("Microsoft YaHei", 16, "bold"),
            text_color=TEXT_COLOR
        ).pack(pady=(0, 20))
        
        # å» å•†æŒ‰éˆ•å®¹å™¨
        button_frame = ctk.CTkFrame(vendor_frame, fg_color='transparent')
        button_frame.pack(expand=True)
        
        # Oriental æŒ‰éˆ•
        oriental_btn = ctk.CTkButton(
            button_frame,
            text="ğŸœ Oriental\næœˆçµæª¢æŸ¥",
            font=("Microsoft YaHei", 16, "bold"),
            fg_color=ACCENT_BLUE,
            hover_color="#1d4ed8",
            text_color="white",
            corner_radius=15,
            width=200,
            height=100,
            command=lambda: self._open_vendor_check_window(parent, "Oriental")
        )
        oriental_btn.pack(side='left', padx=20, pady=20)
        
        # Aries Fresh æŒ‰éˆ•
        aries_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ¥¬ Aries Fresh\næœˆçµæª¢æŸ¥",
            font=("Microsoft YaHei", 16, "bold"),
            fg_color=ACCENT_GREEN,
            hover_color="#047857",
            text_color="white",
            corner_radius=15,
            width=200,
            height=100,
            command=lambda: self._open_vendor_check_window(parent, "Aries Fresh")
        )
        aries_btn.pack(side='left', padx=20, pady=20)

    def _open_vendor_check_window(self, parent, vendor):
        """æ‰“é–‹çµ±ä¸€çš„å¤šå» å•†æœˆçµæª¢æŸ¥çª—å£"""
        # æ¸…ç©ºçˆ¶çª—å£
        for widget in parent.winfo_children():
            widget.destroy()
        
        # å‰µå»ºçµ±ä¸€çš„å¤šå» å•†æœˆçµæª¢æŸ¥UI
        vendor_ui = SOAReconciliationUI(parent)
        vendor_ui.pack(fill="both", expand=True)

    def _create_soa_reconciliation_content(self, parent):
        """åˆ›å»ºSOAæ ¸å¯¹ç•Œé¢å†…å®¹ - å·²å¼ƒç”¨ï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹"""
        # åˆ›å»ºUIæ¡†æ¶
        ui = SOAReconciliationUI(parent)
        ui.pack(fill="both", expand=True)

        return ui

    def _select_function(self, command, func_key):
        """é€‰æ‹©åŠŸèƒ½"""
        # å–æ¶ˆä¹‹å‰é€‰ä¸­çš„æŒ‰é’®
        if hasattr(
    self,
     'current_function') and self.current_function and self.current_function in self.nav_buttons:
            if hasattr(self.nav_buttons[self.current_function], 'deselect'):
                self.nav_buttons[self.current_function].deselect()

        # é€‰ä¸­å½“å‰æŒ‰é’®
        if func_key in self.nav_buttons and hasattr(
            self.nav_buttons[func_key], 'select'):
            self.nav_buttons[func_key].select()
        self.current_function = func_key

        # æ‰§è¡ŒåŠŸèƒ½
        command()

    def _show_function_ui(self, title_key, subtitle_key, content_callback):
        """æ˜¾ç¤ºåŠŸèƒ½ç•Œé¢"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®æ ‡é¢˜
        self.function_title.configure(text=title_key)
        # å‰¯æ¨™é¡Œçµ±ä¸€æ”¾å¤§
        if isinstance(subtitle_key, tuple):
            text = subtitle_key[0]
        else:
            text = subtitle_key
        self.function_subtitle.configure(text=text, font=FONT_TITLE)

        # åˆ›å»ºå†…å®¹æ¡†æ¶
        content_frame = ctk.CTkFrame(self.content_body, fg_color="transparent")
        content_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # æ„å»ºåŠŸèƒ½UI
        content_callback(content_frame)

    # ä¸‹é¢æ˜¯å„ä¸ªåŠŸèƒ½ç•Œé¢çš„ä¿®æ”¹ï¼Œåªéœ€è¦å°†åŸæ¥çš„show_xxx_uiæ–¹æ³•æ”¹ä¸ºä½¿ç”¨_show_function_ui

    def show_download_ui(self):
        """æ˜¾ç¤ºä¸‹è½½ç•Œé¢"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®åŠŸèƒ½æ ‡é¢˜
        self.function_title.configure(text=t("download_title"))
        self.function_subtitle.configure(text=t("download_desc"))

        def build(c):
            self.download_folder_var = ctk.StringVar()
            self.config_file_var = ctk.StringVar()

            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(fill="both", expand=True, padx=50, pady=20)

            # ä¸‹è½½æ–‡ä»¶å¤¹
            row1 = ctk.CTkFrame(form_frame)
            row1.pack(fill="x", pady=15)
            ctk.CTkLabel(
    row1,
    text="ä¸‹è½½æ–‡ä»¶å¤¹\nDownload Folder:",
    font=FONT_MID,
    anchor="w",
    justify="left").pack(
        side="left",
         padx=10)
            ctk.CTkEntry(
    row1,
    textvariable=self.download_folder_var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
            browse_btn = ctk.CTkButton(
                row1,
                text="æµè§ˆ...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=self._select_download_folder,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn.pack(side="left", padx=5)

            # åˆ†åº—é…ç½®æ–‡ä»¶
            row2 = ctk.CTkFrame(form_frame)
            row2.pack(fill="x", pady=15)
            ctk.CTkLabel(
    row2,
    text="åˆ†åº—é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰\nOutlet Config (Optional):",
    font=FONT_MID,
    anchor="w",
    justify="left").pack(
        side="left",
         padx=10)
            ctk.CTkEntry(
    row2,
    textvariable=self.config_file_var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
            browse_btn2 = ctk.CTkButton(
                row2,
                text="æµè§ˆ...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=self._select_config_file,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn2.pack(side="left", padx=5)
            # ä¸‹è¼‰æŒ‰éˆ•å€åŸŸ - ä½¿ç”¨ç¶²æ ¼ä½ˆå±€
            btn_container = ctk.CTkFrame(c, fg_color="transparent")
            btn_container.pack(pady=30, padx=20)
            
            # ç¬¬ä¸€è¡Œï¼šä¸»è¦ä¸‹è¼‰åŠŸèƒ½
            top_row = ctk.CTkFrame(btn_container, fg_color="transparent")
            top_row.pack(fill="x", pady=(0, 15))
            
            # é–‹å§‹ä¸‹è¼‰æŒ‰éˆ•ï¼ˆå·¦ï¼‰
            GlowButton(
                top_row,
                text="é–‹å§‹ä¸‹è¼‰\nStart Download",
                command=self._run_download,
                glow_color=ACCENT_BLUE,
                width=280,
                height=60
            ).pack(side="left", padx=(0, 15), expand=True, fill="both")

            # Amendment ä¸‹è¼‰æŒ‰éˆ•ï¼ˆå³ï¼‰
            GlowButton(
                top_row,
                text="ä¸‹è¼‰ Amendment\nDownload Amendments",
                command=self._run_download_amendments,
                glow_color="#ef4444",
                width=280,
                height=60
            ).pack(side="left", padx=(0, 0), expand=True, fill="both")
            
            # ç¬¬äºŒè¡Œï¼šSiahuat è¨‚å–®ä¸‹è¼‰ï¼ˆè·¨è¶Šå…©åˆ—ï¼‰
            bottom_row = ctk.CTkFrame(btn_container, fg_color="transparent")
            bottom_row.pack(fill="x")
            
            # Siahuat è¨‚å–®ä¸‹è¼‰æŒ‰éˆ•ï¼ˆè·¨è¶Šæ•´è¡Œï¼‰
            GlowButton(
                bottom_row,
                text="ğŸ¢ ä¸‹è¼‰ Siahuat è¨‚å–®\nDownload Siahuat Orders",
                command=self._run_download_siahuat,
                glow_color="#FF6B35",
                width=575,
                height=60
            ).pack(expand=True, fill="x")
            
            # æ‰£åˆ†åŠŸèƒ½æŒ‰é’®
            f5_frame = ctk.CTkFrame(c, fg_color="transparent")
            f5_frame.pack(fill="both", expand=True, padx=50, pady=20)
            
            # æ‰£åˆ†åŠŸèƒ½æ ‡é¢˜
            f5_title = ctk.CTkLabel(
                f5_frame,
                text="æ‰£åˆ†åŠŸèƒ½ / Deduction Function",
                font=("Microsoft YaHei", 16, "bold"),
                text_color="#dc2626"
            )
            f5_title.pack(pady=(0, 15))
            
            # æ‰£åˆ†æ–‡ä»¶é€‰æ‹© - ä¸ä¸Šé¢çš„ä¸‹è½½æ–‡ä»¶å¤¹å¸ƒå±€å®Œå…¨ä¸€è‡´
            demerit_file_frame = ctk.CTkFrame(f5_frame, fg_color="transparent")
            demerit_file_frame.pack(fill="x", pady=15)

            ctk.CTkLabel(
                demerit_file_frame,
                text="æ‰£åˆ†æ–‡ä»¶\nDemerit File:",
                font=FONT_MID,
                anchor="w",
                justify="left"
            ).pack(side="left", padx=10)

            ctk.CTkEntry(
                demerit_file_frame,
                textvariable=self.demerit_file_var,
                font=FONT_MID,
                state="readonly",
                width=400
            ).pack(
                side="left",
                expand=True,
                fill="x",
                padx=5
            )

            demerit_browse_btn = ctk.CTkButton(
                demerit_file_frame,
                text="æµè§ˆ...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=self._select_demerit_file,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            demerit_browse_btn.pack(side="left", padx=5)
            
            # F5æ‰£åˆ†æŒ‰é’®è¡Œ - å±…ä¸­å¸ƒå±€
            f5_btn_frame = ctk.CTkFrame(f5_frame, fg_color="transparent")
            f5_btn_frame.pack(fill="x")
            
            # æŒ‰é’®å®¹å™¨ - ç”¨äºå±…ä¸­æŒ‰é’®
            button_center_frame = ctk.CTkFrame(f5_btn_frame, fg_color="transparent")
            button_center_frame.pack(expand=True)
            
            # è‡ªåŠ¨æ‰£åˆ†æŒ‰é’®ï¼ˆæ£€æŸ¥å‘¨ä¸‰12ç‚¹åçš„è®¢å•ï¼‰
            auto_f5_btn = ctk.CTkButton(
                button_center_frame,
                text="è‡ªåŠ¨æ‰£åˆ†\nAuto Deduction\n(æ£€æŸ¥å‘¨ä¸‰12ç‚¹åè®¢å•)",
                command=self._run_auto_f5_deduction,
                fg_color="#dc2626",
                hover_color="#b91c1c",
                width=300,
                height=50,
                font=("Microsoft YaHei", 12, "bold"),
                text_color="white",
                corner_radius=8
            )
            auto_f5_btn.pack(side="left", padx=(0, 10), pady=5)
            
            # æ‰‹åŠ¨æ‰£åˆ†æŒ‰é’®
            manual_f5_btn = ctk.CTkButton(
                button_center_frame,
                text="æ‰‹åŠ¨æ‰£åˆ†\nManual Deduction",
                command=self._show_manual_f5_deduction,
                fg_color="#ea580c",
                hover_color="#c2410c",
                width=300,
                height=50,
                font=("Microsoft YaHei", 12, "bold"),
                text_color="white",
                corner_radius=8
            )
            manual_f5_btn.pack(side="left", padx=(10, 0), pady=5)
            
            # ç¡®ä¿"æŸ¥çœ‹é‚®ä»¶å†…å®¹"æŒ‰é’®å§‹ç»ˆæ˜¾ç¤ºï¼Œä¸”æ›´å¤§

            def show_extracted_bodies():
                from tkinter import messagebox
                import os
                import tkinter as tk
                folder = self.download_folder_var.get()
                today = datetime.now()
                month_name = today.strftime('%b').title()
                week_of_month = get_week_of_month(today)
                save_path = os.path.join(folder, f"{month_name} - Week {week_of_month}")
                log_file = os.path.join(save_path, "email_bodies_log.txt")
                bodies = getattr(OutlookDownloader, 'extracted_bodies', [])
                if not bodies and os.path.exists(log_file):
                    with open(log_file, "r", encoding="utf-8") as f:
                        content = f.read()
                    bodies = content.split("\n\nâ€”â€”â€” é‚®ä»¶ ") if content else []
                    if bodies and not bodies[0].startswith("â€”â€”â€” é‚®ä»¶ "):
                        bodies[0] = "â€”â€”â€” é‚®ä»¶ 1 â€”â€”â€”\n" + bodies[0]
                    bodies = [
    b if b.startswith("â€”â€”â€” é‚®ä»¶ ") else "â€”â€”â€” é‚®ä»¶ " +
     b for b in bodies]
                if not bodies:
                    messagebox.showinfo("æ— å†…å®¹", "è¯·å…ˆä¸‹è½½é‚®ä»¶ï¼Œå†æŸ¥çœ‹é‚®ä»¶å†…å®¹ï¼")
                    return
                # æœç´¢åŠŸèƒ½
                win = tk.Toplevel(self)
                win.title("é‚®ä»¶å†…å®¹æå–ç»“æœ/Extracted Email Bodies")
                win.geometry("900x700")
                search_var = tk.StringVar()

                def filter_bodies(keyword):
                    keyword = keyword.lower().strip()
                    if not keyword:
                        return bodies
                    result = []
                    for b in bodies:
                        if keyword in b.lower():
                            result.append(b)
                    return result
                # ç¾åŒ–é¡¯ç¤º
                from tkinter import scrolledtext
                text_widget = scrolledtext.ScrolledText(win, wrap="word", font=(
                    "Microsoft JhengHei", 15), bg="#f1f5f9", fg="#22292f")
                text_widget.pack(
    fill="both",
    expand=True,
    padx=10,
    pady=(
        50,
         10))

                def update_display():
                    filtered = filter_bodies(search_var.get())
                    pretty = []
                    for idx, b in enumerate(filtered, 1):
                        lines = b.split("\n")
                        # ä¸»é¡Œ/ç™¼ä»¶äººåŠ ç²—ï¼Œæ­£æ–‡åˆ†éš”ç·š
                        pretty.append(f"\n{'=' * 40}\n")
                        for l in lines:
                            if l.startswith("[å‘ä»¶äºº]") or l.startswith("[ä¸»é¢˜]"):
                                pretty.append(f"{l}\n")
                            elif l.startswith("[å†…å®¹]"):
                                pretty.append(f"\n{l}\n{'-' * 30}\n")
                            else:
                                pretty.append(f"{l}\n")
                    pretty_text = "".join(pretty)
                    text_widget.delete("1.0", "end")
                    text_widget.insert("1.0", pretty_text)

                def on_search(*args):
                    update_display()
                search_var.trace_add("write", on_search)
                search_entry = tk.Entry(
    win, textvariable=search_var, font=(
        "Microsoft JhengHei", 14))
                search_entry.place(x=10, y=10, width=400, height=32)
                search_entry.insert(0, "è¾“å…¥å…³é”®å­—æœç´¢/Type to search...")

                def on_focus_in(event):
                    if search_entry.get() == "è¾“å…¥å…³é”®å­—æœç´¢/Type to search...":
                        search_entry.delete(0, "end")
                search_entry.bind("<FocusIn>", on_focus_in)
                # æ”¯æŒå¤åˆ¶

                def copy_all():
                    import pyperclip
                    pretty = text_widget.get("1.0", "end-1c")
                    pyperclip.copy(pretty)
                    messagebox.showinfo("å¤åˆ¶æˆåŠŸ", "å·²å¤åˆ¶å…¨éƒ¨é‚®ä»¶å†…å®¹ï¼")
                # ç¾åŒ– Copy All æŒ‰éˆ•ï¼ˆå°å·§ã€åœ“è§’ã€äº®ç¶ ã€hover æ·±ç¶ ã€å­—é«”é©ä¸­ï¼‰

                def on_enter(e):
                    btn.config(bg="#16a34a")

                def on_leave(e):
                    btn.config(bg="#22c55e")
                btn = tk.Button(
                    win,
                    text="å¤åˆ¶å…¨éƒ¨å†…å®¹\nCopy All",
                    command=copy_all,
                    bg="#22c55e",
                    fg="#fff",
                    font=("Microsoft JhengHei", 16, "bold"),
                    relief="ridge",
                    bd=2,
                    activebackground="#16a34a",
                    activeforeground="#fff",
                    cursor="hand2",
                    highlightthickness=1,
                    highlightbackground="#22d3ee"
                )
                btn.place(x=420, y=10, width=140, height=32)
                btn.bind("<Enter>", on_enter)
                btn.bind("<Leave>", on_leave)
                # èª¿æ•´æ­£æ–‡å­—é«”ç‚º14
                text_widget.config(font=("Microsoft JhengHei", 14))
                update_display()

        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # ç›´æ¥æ„å»ºä¸‹è½½ç•Œé¢
        build(self.content_body)

    def show_checklist_ui(self):
        """æ˜¾ç¤ºæ£€æŸ¥è¡¨ç•Œé¢"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®åŠŸèƒ½æ ‡é¢˜
        self.function_title.configure(text=t("checklist_title"))
        self.function_subtitle.configure(text=t("checklist_desc"))

        # ç›´æ¥æ„å»ºæ£€æŸ¥è¡¨ç•Œé¢
        def build(c):
            self.checklist_folder_var = ctk.StringVar()
            self.master_config_var = ctk.StringVar()

            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(fill="both", expand=True, padx=50, pady=5)
            # è®¢å•æ–‡ä»¶å¤¹
            row1 = ctk.CTkFrame(form_frame)
            row1.pack(fill="x", pady=5)
            ctk.CTkLabel(
    row1,
    text="è¨‚å–®æ–‡ä»¶å¤¾\nOrder Folder:",
    font=FONT_BIGBTN).pack(
        side="left",
         padx=10)
            ctk.CTkEntry(
    row1,
    textvariable=self.checklist_folder_var,
    font=FONT_MID,
    state="readonly",
    width=250).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            checklist_browse_btn = ctk.CTkButton(
                row1,
                text=str(t("browse")),
                font=("Microsoft YaHei", 11, "bold"),
                command=self._select_checklist_folder,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            checklist_browse_btn.pack(side="left", padx=5)
            # ç»Ÿä¸€é…ç½®æ–‡ä»¶
            row3 = ctk.CTkFrame(form_frame)
            row3.pack(fill="x", pady=5)
            ctk.CTkLabel(
    row3,
    text="çµ±ä¸€é…ç½®æ–‡ä»¶\nMaster Config (Excel):",
    font=FONT_BIGBTN).pack(
        side="left",
         padx=10)
            ctk.CTkEntry(
    row3,
    textvariable=self.master_config_var,
    font=FONT_MID,
    state="readonly",
    width=250).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            checklist_config_browse_btn = ctk.CTkButton(
                row3,
                text="ç€è¦½...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_config_file(
                    self.master_config_var, [("Excel files", "*.xlsx")]),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            checklist_config_browse_btn.pack(side="left", padx=5)
            # æœç´¢å€ï¼ˆæ°¸é é¡¯ç¤ºï¼‰
            search_frame = ctk.CTkFrame(c, fg_color="transparent")
            search_frame.pack(fill="x", pady=5)
            # ç§»é™¤æœå°‹ç¯„åœä¸‹æ‹‰é¸å–®
            # if not hasattr(self, 'checklist_search_scope_var'):
            #     self.checklist_search_scope_var = ctk.StringVar(value="å…¨éƒ¨")
            # scope_options = ["å…¨éƒ¨", "ä¾›æ‡‰å•†", "åˆ†åº—"]
            # scope_menu = ctk.CTkOptionMenu(search_frame, variable=self.checklist_search_scope_var, values=scope_options, width=90, font=FONT_MID)
            # scope_menu.pack(side="left", padx=4)
            # Supplier ä¸‹æ‹‰é¸å–®
            if not hasattr(self, 'checklist_supplier_filter_var'):
                self.checklist_supplier_filter_var = ctk.StringVar(value="å…¨éƒ¨")
            if not hasattr(self, 'checklist_outlet_filter_var'):
                self.checklist_outlet_filter_var = ctk.StringVar(value="å…¨éƒ¨")

            def get_unique_suppliers():
                return ["å…¨éƒ¨"] + sorted(list({row["supplier"] for row in getattr(
                    self, '_checklist_table_data', []) if row["supplier"]}))

            def get_unique_outlets():
                return ["å…¨éƒ¨"] + sorted(list({row["outlet"] for row in getattr(
                    self, '_checklist_table_data', []) if row["outlet"]}))
            ctk.CTkLabel(
    search_frame,
    text="Supplier",
    font=(
        "Microsoft JhengHei",
        16,
        "bold"),
        text_color="#3b82f6").pack(
            side="left",
            padx=(
                0,
                 2))
            self.supplier_menu = ctk.CTkOptionMenu(
                search_frame, variable=self.checklist_supplier_filter_var, values=get_unique_suppliers(), width=140, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#3b82f6", button_color="#3b82f6", button_hover_color="#2563eb", text_color="#fff", corner_radius=16,
                command=lambda _: self._filter_checklist_table())
            self.supplier_menu.pack(side="left", padx=4)
            ctk.CTkLabel(
    search_frame,
    text="Outlet",
    font=(
        "Microsoft JhengHei",
        16,
        "bold"),
        text_color="#3b82f6").pack(
            side="left",
            padx=(
                10,
                 2))
            self.outlet_menu = ctk.CTkOptionMenu(
                search_frame, variable=self.checklist_outlet_filter_var, values=get_unique_outlets(), width=140, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#3b82f6", button_color="#3b82f6", button_hover_color="#2563eb", text_color="#fff", corner_radius=16,
                command=lambda _: self._filter_checklist_table())
            self.outlet_menu.pack(side="left", padx=4)
            ctk.CTkLabel(
    search_frame,
    text="æœç´¢/Filter:",
    font=(
        "Microsoft JhengHei",
        15,
        "bold"),
        text_color="#3b82f6").pack(
            side="left",
             padx=6)
            if not hasattr(self, 'checklist_search_var'):
                self.checklist_search_var = ctk.StringVar()
            search_entry = ctk.CTkEntry(
    search_frame,
    textvariable=self.checklist_search_var,
    font=(
        "Microsoft JhengHei",
        14),
        width=180,
        corner_radius=10,
        border_width=2,
         border_color="#3b82f6")
            search_entry.pack(side="left", padx=4)
            search_entry.bind("<KeyRelease>",
     lambda e: self._filter_checklist_table())

            def set_search_keyword(keyword):
                self.checklist_search_var.set(keyword)
                self._filter_checklist_table()
            ctk.CTkButton(
                search_frame, text="Missing", width=90, height=34, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#2563eb", hover_color="#60a5fa", text_color="#fff", corner_radius=16, border_width=2, border_color="#fff",
                command=lambda: self._search_missing_orders()
            ).pack(side="left", padx=6)
            ctk.CTkButton(
                search_frame, text="Mismatch", width=100, height=34, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#f59e42", hover_color="#fbbf24", text_color="#fff", corner_radius=16, border_width=2, border_color="#fff",
                command=lambda: set_search_keyword("mismatch")
            ).pack(side="left", padx=6)
            # æ–°å¢å…©å€‹å¿«é€Ÿæœå°‹æŒ‰éˆ•
            ctk.CTkButton(
                search_frame, text="X å¯¦éš›å¹¶æ²’æœ‰è¨‚å–®", width=160, height=34, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#0ea5e9", hover_color="#38bdf8", text_color="#fff", corner_radius=16, border_width=2, border_color="#fff",
                command=lambda: self._search_crosscheck_email_no_actual()
            ).pack(side="left", padx=6)
            ctk.CTkButton(
                search_frame, text="X Email å¹¶æ²’æœ‰ä¸‹å–®", width=170, height=34, font=("Microsoft JhengHei", 15, "bold"),
                fg_color="#10b981", hover_color="#34d399", text_color="#fff", corner_radius=16, border_width=2, border_color="#fff",
                command=lambda: self._search_crosscheck_actual_no_email()
            ).pack(side="left", padx=6)
            # è¡¨æ ¼å€ï¼ˆæ°¸é é¡¯ç¤ºï¼Œæ²’è³‡æ–™æ™‚é¡¯ç¤ºç©ºè¡¨æ ¼ï¼‰
            table_frame = ctk.CTkFrame(c, fg_color="transparent")
            table_frame.pack(fill="both", expand=True, padx=10, pady=10)
            import tkinter.ttk as ttk
            style = ttk.Style()
            style.theme_use('default')
            style.configure(
    "Custom.Treeview",
    background="#1e293b",
    fieldbackground="#1e293b",
    foreground="#e2e8f0",
    rowheight=28,
    font=(
        "Microsoft JhengHei",
         12))
            style.configure(
    "Custom.Treeview.Heading",
    background="#334155",
    foreground="#60a5fa",
    font=(
        "Microsoft JhengHei",
        13,
         "bold"))
            style.map("Custom.Treeview", background=[('selected', '#334155')])
            if not hasattr(self, 'checklist_table'):
                self.checklist_table = None
            self.checklist_table = ttk.Treeview(
                table_frame,
                columns=("supplier", "outlet", "cover_status", "remark"),
                show="headings",
                height=8,
                style="Custom.Treeview"
            )
            col_labels = [
                ("supplier", "ä¾›æ‡‰å•†/Supplier"),
                ("outlet", "åˆ†åº—/Outlet"),
                ("cover_status", "è¦†è“‹ç‹€æ…‹/Cover"),
                ("remark", "å‚™è¨»/Remark")
            ]
            for col, label in col_labels:
                self.checklist_table.heading(col, text=label)
                self.checklist_table.column(
    col, width=140 if col != "remark" else 300, anchor="center")
            self.checklist_table.pack(fill="both", expand=True)
            self.checklist_table.bind(
    "<Double-1>", self._on_checklist_row_double_click)
            # è¤‡è£½/åŒ¯å‡ºæŒ‰éˆ•ï¼ˆæ°¸é é¡¯ç¤ºï¼‰
            btn_frame = ctk.CTkFrame(c, fg_color="transparent")
            btn_frame.pack(pady=10)
            btns = [
                ("F5ä¿®æ­£æ‰£åˆ†\nF5 Fix & Deduct", self._fix_f5_mismatch, "#dc2626"),
                ("æŸ¥çœ‹å¿…è¦é–€å¸‚\nView Required Outlets",
                 self._show_required_outlets_window, "#8b5cf6"),
                ("äº¤å‰æª¢æŸ¥\nCross Check", self._run_cross_check_and_update_remarks, "#f59e42"),
            ]
            for txt, cmd, color in btns:
                GlowButton(
                    btn_frame,
                    text=txt,
                    command=cmd,
                    width=90,
                    height=28,
                    glow_color=color
                ).pack(side="left", padx=4, pady=2)
            for col in range(2):
                btn_frame.grid_columnconfigure(col, weight=1)
            # Run Check æŒ‰éˆ•ï¼ˆå¤§ã€ä¸­æ–‡åœ¨ä¸Šè‹±æ–‡åœ¨ä¸‹ï¼Œç½®ä¸­ï¼Œæ°¸é é¡¯ç¤ºï¼‰
            run_btn_frame = ctk.CTkFrame(c, fg_color="transparent")
            run_btn_frame.pack(fill="x", pady=15)
            GlowButton(
                run_btn_frame,
                text="åŸ·è¡Œæª¢æŸ¥\nRun Check",
                command=self._run_enhanced_checklist,
                width=200,
                height=56,
                glow_color="#a78bfa"
            ).pack(anchor="center")
            # åˆå§‹åŒ–è¡¨æ ¼æ•¸æ“š
            if not hasattr(self, '_checklist_table_data'):
                self._checklist_table_data = []
            self._refresh_checklist_table()

        # è°ƒç”¨buildå‡½æ•°æ„å»ºç•Œé¢
        build(self.content_body)

    def _run_enhanced_checklist(self):
        folder = self.checklist_folder_var.get()
        master_config = self.master_config_var.get()
        if not folder or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
        config_mgr = UnifiedConfigManager(master_config)
        checker = EnhancedOrderChecker(config_mgr)
        table = checker.run_checklist(folder, as_table=True)
        self._checklist_table_data = table
        self._refresh_checklist_table()
        # è‡ªåŠ¨æ‰§è¡Œäº¤å‰æ£€æŸ¥å¹¶ç›´æ¥å°†ç»“æœå†™å…¥ä¸»è¡¨çš„å¤‡æ³¨ï¼Œæ— éœ€é¢å¤–å¼¹çª—
        try:
            result = self._run_cross_check_email_log()
            if result:
                cross_check_data, _email_content = result
                self._update_checklist_remarks(cross_check_data)
        except Exception:
            # äº¤å‰æ£€æŸ¥å¤±è´¥æ—¶ä¸é˜»æ–­ä¸»æµç¨‹
            pass

    def _refresh_checklist_table(self):
        # æ¸…ç©ºè¡¨æ ¼
        for row in self.checklist_table.get_children():
            self.checklist_table.delete(row)
        # æ’å…¥æ•¸æ“š
        for row in self._checklist_table_data:
            values = (
    row["supplier"],
    row["outlet"],
    row["cover_status"],
     row["remark"])
            self.checklist_table.insert("", "end", values=values)

    def _filter_checklist_table(self):
        keyword = self.checklist_search_var.get().lower()
        scope = getattr(self, 'checklist_search_scope_var', None)
        scope_val = scope.get() if scope else "å…¨éƒ¨"
        supplier_val = getattr(self, 'checklist_supplier_filter_var', None)
        supplier_selected = supplier_val.get() if supplier_val else "å…¨éƒ¨"
        outlet_val = getattr(self, 'checklist_outlet_filter_var', None)
        outlet_selected = outlet_val.get() if outlet_val else "å…¨éƒ¨"

        def normalize(text):
            import re
            return re.sub(r'[^a-zA-Z0-9]', '', str(text)).lower()
        norm_keyword = normalize(keyword)

        def row_match(row):
            # ä¾›æ‡‰å•†/é–€å¸‚ä¸‹æ‹‰é¸å–®
            if supplier_selected != "å…¨éƒ¨" and row["supplier"] != supplier_selected:
                return False
            if outlet_selected != "å…¨éƒ¨" and row["outlet"] != outlet_selected:
                return False
            # æœå°‹ç¯„åœ
            if not norm_keyword:
                return True
            if scope_val == "å…¨éƒ¨":
                # ä¾›æ‡‰å•†ã€åˆ†åº—ç”¨è¦ç¯„åŒ–æ¯”å°ï¼›ç‹€æ…‹èˆ‡å‚™è¨»ç”¨å°å¯«åŒ…å«ï¼ˆä¿ç•™ç©ºç™½èˆ‡ä¸­æ–‡å­—ï¼‰
                return (
                    norm_keyword in normalize(row["supplier"]) or
                    norm_keyword in normalize(row["outlet"]) or
                    (keyword in str(row["cover_status"]).lower()) or
                    (keyword in str(row["remark"]).lower())
                )
            elif scope_val == "ä¾›æ‡‰å•†":
                return norm_keyword in normalize(row["supplier"]) 
            elif scope_val == "åˆ†åº—":
                return norm_keyword in normalize(row["outlet"])
            return True
        filtered = [
    row for row in self._checklist_table_data if row_match(row)]
        for row in self.checklist_table.get_children():
            self.checklist_table.delete(row)
        for row in filtered:
            values = (
    row["supplier"],
    row["outlet"],
    row["cover_status"],
     row["remark"])
            self.checklist_table.insert("", "end", values=values)
        # å‹•æ…‹åˆ·æ–°ä¸‹æ‹‰é¸å–®å…§å®¹
        if hasattr(self, 'supplier_menu'):
            current = self.checklist_supplier_filter_var.get()
            suppliers = ["å…¨éƒ¨"] + sorted(list({row["supplier"]
                                        for row in self._checklist_table_data if row["supplier"]}))
            self.supplier_menu.configure(values=suppliers)
            if current not in suppliers:
                self.checklist_supplier_filter_var.set("å…¨éƒ¨")
        if hasattr(self, 'outlet_menu'):
            current = self.checklist_outlet_filter_var.get()
            outlets = ["å…¨éƒ¨"] + sorted(list({row["outlet"]
                                      for row in self._checklist_table_data if row["outlet"]}))
            self.outlet_menu.configure(values=outlets)
            if current not in outlets:
                self.checklist_outlet_filter_var.set("å…¨éƒ¨")

    def _copy_checklist_table(self):
        import pyperclip
        rows = ["\t".join(["ä¾›åº”å•†", "åˆ†åº—", "è¦†è“‹ç‹€æ…‹", "å‚™è¨»"])]
        for row in self._checklist_table_data:
            rows.append("\t".join([str(row["supplier"]), str(
                row["outlet"]), str(row["cover_status"]), str(row["remark"])]))
        pyperclip.copy("\n".join(rows))
        messagebox.showinfo("è¤‡è£½æˆåŠŸ", "å ±è¡¨å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼")

    def _fix_f5_mismatch(self):
        """F5 ä¿®æ­£å’Œè‡ªå‹•æ‰£åˆ†åŠŸèƒ½"""
        from tkinter import messagebox

        # æª¢æŸ¥æ˜¯å¦æœ‰ checklist æ•¸æ“š
        if not hasattr(
    self,
     '_checklist_table_data') or not self._checklist_table_data:
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆåŸ·è¡Œæª¢æŸ¥ä»¥ç²å–æ•¸æ“šã€‚")
            return

        # æ‰¾å‡ºæ‰€æœ‰ mismatch è¨˜éŒ„
        mismatch_records = []
        for record in self._checklist_table_data:
            if "mismatch" in record.get("remark", "").lower():
                mismatch_records.append(record)

        if not mismatch_records:
            messagebox.showinfo("æç¤º", "æ²’æœ‰ç™¼ç¾ mismatch éŒ¯èª¤éœ€è¦ä¿®æ­£ã€‚")
            return

        # æ‰“é–‹ F5 ä¿®æ­£å’Œè‡ªå‹•æ‰£åˆ†çª—å£ï¼ˆåŒ…å«æ–‡ä»¶é¸æ“‡åŠŸèƒ½ï¼‰
        F5FixAndDeductWithFileWindow(self, mismatch_records)

    def _on_checklist_row_double_click(self, event):
        item = self.checklist_table.selection()
        if not item:
            return
        values = self.checklist_table.item(item[0], "values")
        supplier = values[0]
        outlet = values[1]
        cover_status = values[2]
        remark = values[3]

        # æª¢æŸ¥æ˜¯å¦ç‚º mismatch éŒ¯èª¤
        if "mismatch" in remark.lower():
            self._show_mismatch_correction_dialog(
                supplier, outlet, cover_status, remark)
        else:
            detail = f"ä¾›åº”å•†: {supplier}\nåˆ†åº—: {outlet}\nè¦†è“‹ç‹€æ…‹: {cover_status}\nå‚™è¨»: {remark}"
            ScrollableMessageBox(self, "è¯¦ç»†ä¿¡æ¯", detail)

    def _show_mismatch_correction_dialog(
    self, supplier, outlet, cover_status, remark):
        """é¡¯ç¤º mismatch ä¿®æ­£å°è©±æ¡†"""
        dialog = MismatchCorrectionDialog(
    self, supplier, outlet, cover_status, remark)
        self.wait_window(dialog)

    def show_automation_ui(self):
        """æ˜¾ç¤ºè‡ªåŠ¨åŒ–ç•Œé¢"""
        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®åŠŸèƒ½æ ‡é¢˜
        self.function_title.configure(text=t("automation_title"))
        self.function_subtitle.configure(text=t("automation_desc"))

        def build(c):
            import os
            import traceback
            from datetime import datetime, timedelta
            import openpyxl
            self.folder_vars = {}
            self.master_config_var = ctk.StringVar()

            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(
    side="top",
    fill="x",
    expand=False,
    padx=30,
     pady=10)
            # åªä¿ç•™ä¸€çµ„ Supplier Folder æ¬„ä½
            folders = [
                ("source_folder", "ä¾†æºè³‡æ–™å¤¾\nSource Folder (Weekly Orders)"),
                ("supplier_folder", "ä¾›æ‡‰å•†æ–‡ä»¶å¤¾\nSupplier Folder")
            ]
            for key, label in folders:
                row = ctk.CTkFrame(form_frame)
                row.pack(fill="x", pady=8)
                var = ctk.StringVar()
                self.folder_vars[key] = var
                ctk.CTkLabel(
    row,
    text=label,
    font=(
        "Microsoft JhengHei",
        12,
        "bold"),
        anchor="w",
        justify="left").pack(
            side="left",
             padx=8)
                ctk.CTkEntry(
    row,
    textvariable=var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
                # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
                automation_browse_btn = ctk.CTkButton(
                    row,
                    text="ç€è¦½...\nBrowse...",
                    font=("Microsoft YaHei", 11, "bold"),
                    command=lambda k=key: self._select_folder(k),
                    corner_radius=8,
                    hover_color="#1976d2",
                    height=30
                )
                automation_browse_btn.pack(side="left", padx=5)
            # ç»Ÿä¸€é…ç½®æ–‡ä»¶
            row3 = ctk.CTkFrame(form_frame)
            row3.pack(fill="x", pady=8)
            ctk.CTkLabel(
    row3, text="çµ±ä¸€é…ç½®æ–‡ä»¶\nMaster Config (Excel):", font=(
        "Microsoft JhengHei", 12, "bold")).pack(
            side="left", padx=8)
            ctk.CTkEntry(
    row3,
    textvariable=self.master_config_var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•
            automation_config_browse_btn = ctk.CTkButton(
                row3,
                text=t("browse"),
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_config_file(
                    self.master_config_var, [("Excel files", "*.xlsx")]),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            automation_config_browse_btn.pack(side="left", padx=5)
            # é–‹å§‹è‡ªå‹•åŒ–æŒ‰éˆ•
            btn_frame = ctk.CTkFrame(form_frame, fg_color="transparent")
            btn_frame.pack(pady=(15, 0))

            # å‰µå»ºæ°´å¹³æ’åˆ—çš„æŒ‰éˆ•å®¹å™¨
            button_row = ctk.CTkFrame(btn_frame, fg_color="transparent")
            button_row.pack(anchor="center")

            # å·¦é‚ŠæŒ‰éˆ•ï¼šAmendment Order æ•´åˆæ”¹å–®
            GlowButton(
                button_row,
                text="æ•´åˆæ”¹å–®\nAmendment Order",
                command=self._run_yellow_highlighted_automation,
                width=280,
                height=50,
                glow_color="#f59e0b",
                corner_radius=18
            ).pack(side="left", padx=(0, 10))

            # å³é‚ŠæŒ‰éˆ•ï¼šConsolidate Order æ•´åˆè¨‚å–®
            GlowButton(
                button_row,
                text="æ•´åˆè¨‚å–®\nConsolidate Order",
                command=self._run_enhanced_automation,
                width=280,
                height=50,
                glow_color="#22c55e",
                corner_radius=18
            ).pack(side="left")
            # ========== è£œå–®å€å¡Šï¼ˆç§»åˆ°ä¸Šé¢ï¼‰ ==========
            append_frame = ctk.CTkFrame(
    c, fg_color=DARK_PANEL, corner_radius=16)
            append_frame.pack(
    side="top",
    fill="x",
    expand=False,
    padx=30,
    pady=(
        8,
         0))
            ctk.CTkLabel(
                append_frame,
                text="è£œåŠ é–€å¸‚è¨‚å–®\nAppend Outlet Order",
                font=("Microsoft JhengHei", 12, "bold"),
                text_color=ACCENT_BLUE,
                anchor="w",
                justify="left"
            ).pack(anchor="w", padx=8, pady=(8, 3))
            # é¸æ“‡è¦è£œçš„é–€å¸‚è¨‚å–®æª”æ¡ˆï¼ˆå¯å¤šé¸ï¼‰
            self.append_outlet_files_var = ctk.StringVar()
            # ===== æª”æ¡ˆæ¸…å–®é¡¯ç¤ºå€ =====

            def select_append_files():
                from tkinter import filedialog
                files = filedialog.askopenfilenames(
                    title="é¸æ“‡è¦è£œçš„é–€å¸‚è¨‚å–®/Select Outlet Order Files",
                    filetypes=[("Excel files", "*.xlsx")]
                )
                if files:
                    # é¡¯ç¤ºæ–‡ä»¶åè€Œä¸æ˜¯å®Œæ•´è·¯å¾‘ï¼Œç”¨åˆ†è™Ÿåˆ†éš”
                    file_names = [os.path.basename(f) for f in files]
                    self.append_outlet_files_var.set(";".join(file_names))
                    # ä¿å­˜å®Œæ•´è·¯å¾‘ä¾›å¾ŒçºŒä½¿ç”¨
                    self.append_outlet_full_paths = files
            rowa = ctk.CTkFrame(append_frame)
            rowa.pack(fill="x", pady=3)
            ctk.CTkLabel(
    rowa,
    text="é¸æ“‡è¦è£œçš„é–€å¸‚è¨‚å–®æª”æ¡ˆ\nSelect Outlet Order Files:",
    font=(
        "Microsoft JhengHei",
        11)).pack(
            side="left",
             padx=8)
            ctk.CTkEntry(
    rowa,
    textvariable=self.append_outlet_files_var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•ï¼ˆçµ±ä¸€æ¨£å¼ï¼‰
            browse_btn_a = ctk.CTkButton(
                rowa,
                text="æµè§ˆ...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=select_append_files,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_a.pack(side="left", padx=5)
            # é¸æ“‡å·²æ•´åˆçš„Supplieræª”æ¡ˆè³‡æ–™å¤¾
            self.append_supplier_folder_var = ctk.StringVar()
            rowb = ctk.CTkFrame(append_frame)
            rowb.pack(fill="x", pady=3)
            ctk.CTkLabel(
    rowb,
    text="é¸æ“‡å·²æ•´åˆçš„Supplieræª”æ¡ˆè³‡æ–™å¤¾\nSelect Supplier Folder:",
    font=(
        "Microsoft JhengHei",
        11)).pack(
            side="left",
             padx=8)
            ctk.CTkEntry(
    rowb,
    textvariable=self.append_supplier_folder_var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            # ç¾åŒ–çš„ç€è¦½æŒ‰éˆ•

            def select_append_supplier_folder():
                from tkinter import filedialog
                folder = filedialog.askdirectory(
    title="é¸æ“‡å·²æ•´åˆçš„Supplierè³‡æ–™å¤¾/Select Integrated Supplier Folder")
                if folder:
                    self.append_supplier_folder_var.set(folder)
            browse_btn_b = ctk.CTkButton(
                rowb,
                text="æµè§ˆ...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=select_append_supplier_folder,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_b.pack(side="left", padx=5)
            # è£œå–®ä¸»æŒ‰éˆ•ï¼ˆGlowButton æ¨£å¼ï¼Œèˆ‡ Summary/Automation ä¸€è‡´ï¼‰
            # è£œå–®ä¸»æŒ‰éˆ•ï¼ˆGlowButton æ¨£å¼ï¼Œèˆ‡ Summary/Automation ä¸€è‡´ï¼‰
            # å…¨æ–°è£œå–®æµç¨‹ï¼šè¦†è“‹æ•´å€‹å» å•†sheet
            GlowButton(
                append_frame,
                text="è£œåŠ é–€å¸‚è¨‚å–®\nAppend Outlet Order",
                command=self.run_new_append_orders,
                width=300,
                height=40,
                glow_color=ACCENT_BLUE,
                corner_radius=18
            ).pack(pady=(8, 0))

            # ========== ç”¢ç”Ÿ Summary å€å¡Š ==========
            summary_frame = ctk.CTkFrame(
    c, fg_color=DARK_PANEL, corner_radius=16)
            summary_frame.pack(
    side="top",
    fill="x",
    expand=False,
    padx=30,
    pady=(
        8,
         0))
            ctk.CTkLabel(
    summary_frame,
    text="ç”¢ç”Ÿ Summary Sheet\nGenerate Summary Sheet",
    font=(
        "Microsoft JhengHei",
        12,
        "bold"),
        text_color=ACCENT_GREEN,
        anchor="w",
        justify="left").pack(
            anchor="w",
            padx=8,
            pady=(
                8,
                 3))
            self.summary_supplier_files_var = ctk.StringVar()

            def select_summary_files():
                from tkinter import filedialog
                files = filedialog.askopenfilenames(
    title="é¸æ“‡è¦ç”¢ç”Ÿ Summary çš„ Supplier æª”æ¡ˆ/Select Supplier Files",
    filetypes=[
        ("Excel files",
         "*.xlsx")])
                if files:
                    self.summary_supplier_files_var.set(";".join(files))
            row_sum = ctk.CTkFrame(summary_frame)
            row_sum.pack(fill="x", pady=3)
            ctk.CTkLabel(
    row_sum,
    text="é¸æ“‡ Supplier æª”æ¡ˆ\nSelect Supplier Files:",
    font=(
        "Microsoft JhengHei",
        11)).pack(
            side="left",
             padx=8)
            ctk.CTkEntry(
    row_sum,
    textvariable=self.summary_supplier_files_var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            browse_btn_sum = ctk.CTkButton(
                row_sum,
                text="æµè§ˆ...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=select_summary_files,
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_sum.pack(side="left", padx=5)

            import re
            from dateutil.parser import parse

            def create_supplier_summary(filepath):
                print("[DEBUG] é–‹å§‹ç”¢ç”Ÿ summary (ç”¢å“å+å…¬å¼è¡Œæ•¸é‡ä¸»æµç¨‹)...")
                import openpyxl
                from openpyxl.styles import Alignment, Font, PatternFill, Border, Side
                from openpyxl.utils import get_column_letter
                from datetime import datetime, timedelta

                # ç‚ºäº†é¿å…å¤–éƒ¨å¼•ç”¨éŒ¯èª¤ï¼Œæˆ‘å€‘å°‡ä½¿ç”¨è¨ˆç®—å€¼è€Œä¸æ˜¯å…¬å¼
                print("[DEBUG] ä½¿ç”¨è¨ˆç®—å€¼æ–¹å¼é¿å…å¤–éƒ¨å¼•ç”¨éŒ¯èª¤...")

                def safe_save_workbook(workbook, file_path):
                    """å®‰å…¨ä¿å­˜å·¥ä½œç°¿ï¼Œä½¿ç”¨å…¨å±€å®‰å…¨ä¿å­˜å‡½æ•¸"""
                    return safe_save_excel_workbook(workbook, file_path)
                # å–å¾—ä¸‹é€±ä¸€åˆ°ä¸‹é€±æ—¥æ—¥æœŸ
                today = datetime.now().date()
                this_monday = today - timedelta(days=today.weekday())
                next_monday = this_monday + timedelta(days=7)
                next_sunday = next_monday + timedelta(days=6)
                week_dates = [(next_monday + timedelta(days=i))
                               for i in range(7)]  # åŒ…å«é€±æ—¥
                week_days = [d.strftime('%a') for d in week_dates]
                week_dates_str = [d.strftime('%d-%b') for d in week_dates]
                wb = openpyxl.load_workbook(
    filepath, data_only=True, keep_links=False)
                product_map = {}  # (eng, chi) -> {short: (full, [qtys...])}
                all_outlets = set()
                for sheet in wb.sheetnames:
                    if sheet in ("Sheet", "Summary"):
                        continue
                    ws = wb[sheet]
                    if ws.sheet_state != "visible":
                        continue
                    short_name = sheet
                    full_name = ws["F5"].value if ws["F5"].value else sheet
                    all_outlets.add((short_name, full_name))
                    last_row = ws.max_row
                    row = 1
                    while row <= last_row:
                        val = ws.cell(row=row, column=2).value  # Bæ¬„
                        if val and "description" in str(val).strip().lower():
                            date_row_idx = row  # æ—¥æœŸåˆ—å’Œ Description åŒä¸€è¡Œ
                            date_cols = list(range(6, 13))  # F~L (åŒ…å«é€±æ—¥)
                            # è§£ææ—¥æœŸåˆ—
                            date_vals = []
                            for col in date_cols:
                                cell_val = ws.cell(
    row=date_row_idx, column=col).value
                                try:
                                    if isinstance(cell_val, str):
                                        date_val = datetime.strptime(
                                            cell_val.strip(), "%d-%b")
                                        date_val = date_val.replace(
                                            year=next_monday.year)
                                        date_vals.append(date_val.date())
                                    elif isinstance(cell_val, datetime):
                                        date_vals.append(cell_val.date())
                                    else:
                                        date_vals.append(None)
                                except Exception:
                                    date_vals.append(None)
                            print(
    f"[DEBUG] sheet={sheet}, row={row}, date_row_idx={date_row_idx}, date_vals={date_vals}, next_monday={next_monday}, next_sunday={next_sunday}")
                            # åˆ¤æ–·é€™ä¸€å€å¡Šæ˜¯å¦å±¬æ–¼ä¸‹é€±
                            if not any(
    d and next_monday <= d <= next_sunday for d in date_vals):
                                row += 1
                                continue
                            # ç”¢å“è¡Œå¾ row+1 é–‹å§‹ï¼Œç›´åˆ°é‡åˆ°ç©ºç™½æˆ– sub-total
                            prod_row = row + 1
                            while prod_row <= last_row:
                                eng = ws.cell(row=prod_row, column=2).value
                                chi = ws.cell(row=prod_row, column=3).value
                                if not eng or str(eng).strip() == "" or str(
                                    eng).strip().lower().startswith("="):
                                    break
                                if "sub-total" in str(eng).lower():
                                    prod_row += 1
                                    continue
                                qtys = []
                                # å‹•æ…‹ç¢ºå®šé€™å€‹å» å•†çš„æ—¥æœŸç¯„åœ
                                valid_dates = [
    d for d in date_vals if d and next_monday <= d <= next_sunday]
                                # é è¨­7å¤©ï¼Œä½†æ ¹æ“šå¯¦éš›æ—¥æœŸèª¿æ•´
                                max_days = len(
                                    valid_dates) if valid_dates else 7

                                for idx, col in enumerate(date_cols):
                                    val = ws.cell(
    row=prod_row, column=col).value
                                    if date_vals[idx] and next_monday <= date_vals[idx] <= next_sunday:
                                        try:
                                            if val is None or (isinstance(
                                                val, str) and val.strip() == ""):
                                                qty = 0.0
                                            else:
                                                qty = float(val)
                                        except Exception:
                                            qty = 0.0
                                        qtys.append(qty)
                                    else:
                                        qtys.append(0.0)

                                # å¦‚æœé€™å€‹å» å•†åªæœ‰6å¤©è³‡æ–™ï¼Œç¢ºä¿qtysé™£åˆ—é•·åº¦ç‚º6
                                if len(valid_dates) == 6:
                                    qtys = qtys[:6]  # åªä¿ç•™å‰6å¤©çš„è³‡æ–™
                                key = (eng, chi)
                                if key not in product_map:
                                    product_map[key] = {}
                                product_map[key][short_name] = (
                                    full_name, qtys)
                                prod_row += 1
                            row = prod_row
                        else:
                            row += 1
                # å»ºç«‹ summary sheet ... (å¾ŒçºŒä¸è®Š)
                # å»ºç«‹ summary sheet
                if "Summary" in wb.sheetnames:
                    del wb["Summary"]
                ws_sum = wb.create_sheet("Summary")
                # æ¨£å¼
                header_fill = PatternFill("solid", fgColor="B7B7E1")
                date_fill = PatternFill("solid", fgColor="C6E0B4")
                center = Alignment(horizontal="center", vertical="center")
                bold = Font(bold=True)
                thin = Side(border_style="thin", color="000000")
                border = Border(left=thin, right=thin, top=thin, bottom=thin)
                # å¯«å…¥æ¯å€‹ç”¢å“å€å¡Šï¼Œæ©«å‘æ’åˆ—ï¼Œæœ€å¤š3å€‹ä¸€æ’ï¼Œè¶…éè‡ªå‹•æ›è¡Œ
                col_offset = 2
                row_offset = 2
                products = list(product_map.items())
                max_per_row = 3
                for idx, ((eng, chi), outlet_map) in enumerate(products):
                    block_idx = idx % max_per_row
                    block_row = idx // max_per_row
                    start_col = col_offset + block_idx * 9
                    start_row = row_offset + block_row * \
                        (len(all_outlets) + 7)  # 7: æ¨™é¡Œ+æ¬„+æ—¥æœŸ+TOTAL+ç©ºç™½
                    # å‹•æ…‹ç¢ºå®šé€™å€‹ç”¢å“å€å¡Šçš„å¯¦éš›å¤©æ•¸
                    actual_days = 7  # é è¨­7å¤©
                    for short, full in sorted(all_outlets):
                        qtys = outlet_map.get(short, (full, [0] * 7))[1]
                        if qtys and len(qtys) == 6:  # å¦‚æœç™¼ç¾æœ‰6å¤©çš„è³‡æ–™
                            actual_days = 6
                            break

                    # æ¨™é¡Œåˆä½µï¼ˆæ ¹æ“šå¯¦éš›å¤©æ•¸èª¿æ•´ï¼‰
                    merge_end_col = start_col + actual_days + \
                        1  # +1 æ˜¯å› ç‚ºæœ‰ Short Name å’Œ Full Name å…©æ¬„
                    ws_sum.merge_cells(
    start_row=start_row,
    start_column=start_col,
    end_row=start_row,
     end_column=merge_end_col)
                    ws_sum.cell(
    row=start_row,
    column=start_col,
     value=eng).fill = header_fill
                    ws_sum.cell(
    row=start_row,
    column=start_col,
     value=eng).font = bold
                    ws_sum.cell(
    row=start_row,
    column=start_col,
     value=eng).alignment = center
                    ws_sum.merge_cells(
    start_row=start_row + 1,
    start_column=start_col,
    end_row=start_row + 1,
     end_column=merge_end_col)
                    ws_sum.cell(
    row=start_row + 1,
    column=start_col,
     value=chi).fill = header_fill
                    ws_sum.cell(
    row=start_row + 1,
    column=start_col,
     value=chi).font = bold
                    ws_sum.cell(
    row=start_row + 1,
    column=start_col,
     value=chi).alignment = center
                    # æ¬„æ¨™é¡Œ
                    ws_sum.cell(
    row=start_row + 2,
    column=start_col,
     value="Short Name").font = bold
                    ws_sum.cell(
    row=start_row + 2,
    column=start_col + 1,
     value="Full Name").font = bold
                    # Full Name æ¬„å¯¬
                    ws_sum.column_dimensions[get_column_letter(
                        start_col + 1)].width = 34.71
                    # æ ¹æ“šå¯¦éš›å¤©æ•¸ç”Ÿæˆæ—¥æœŸæ¨™é¡Œ
                    for i in range(actual_days):
                        c = start_col + 2 + i
                        if i < len(week_days) and i < len(week_dates_str):
                            wd = week_days[i]
                            dt = week_dates_str[i]
                        ws_sum.cell(
    row=start_row + 2,
    column=c,
     value=wd).fill = date_fill
                        ws_sum.cell(
    row=start_row + 3,
    column=c,
     value=dt).fill = date_fill
                        ws_sum.cell(row=start_row + 2, column=c,
                                    value=wd).alignment = center
                        ws_sum.cell(row=start_row + 3, column=c,
                                    value=dt).alignment = center
                    ws_sum.cell(
    row=start_row + 3,
    column=start_col,
     value="").fill = date_fill
                    ws_sum.cell(
    row=start_row + 3,
    column=start_col + 1,
     value="").fill = date_fill
                    # åˆ†åº—è³‡æ–™ï¼ˆæ‰€æœ‰åˆ†åº—éƒ½åˆ—å‡ºï¼Œæ²’æ•¸é‡å¡«0ï¼‰
                    row_idx = start_row + 4
                    for short, full in sorted(all_outlets):
                        qtys = outlet_map.get(
    short, (full, [0] * 7))[1]  # é è¨­7å¤©
                        if all(q == 0 or q == None for q in qtys):
                            continue  # è·³éå…¨ç‚º0çš„åˆ†åº—
                        ws_sum.cell(row=row_idx, column=start_col, value=short)
                        ws_sum.cell(
    row=row_idx, column=start_col + 1, value=full)
                        for i, qty in enumerate(qtys):
                            ws_sum.cell(
    row=row_idx,
    column=start_col + 2 + i,
    value=(
        qty if qty not in (
            0,
             None) else ''))
                        row_idx += 1
                    # TOTAL è¡Œ
                    ws_sum.cell(
    row=row_idx,
    column=start_col,
     value="TOTAL").font = bold
                    # å‹•æ…‹ç¢ºå®šé€™å€‹ç”¢å“å€å¡Šçš„å¯¦éš›å¤©æ•¸
                    actual_days = 7  # é è¨­7å¤©
                    for short, full in sorted(all_outlets):
                        qtys = outlet_map.get(short, (full, [0] * 7))[1]
                        if qtys and len(qtys) == 6:  # å¦‚æœç™¼ç¾æœ‰6å¤©çš„è³‡æ–™
                            actual_days = 6
                            break

                    for i in range(actual_days):  # æ ¹æ“šå¯¦éš›å¤©æ•¸
                        # è¨ˆç®—è©²åˆ—çš„ç¸½å’Œï¼Œé¿å…ä½¿ç”¨å…¬å¼ä»¥é˜²æ­¢å¤–éƒ¨å¼•ç”¨éŒ¯èª¤
                        total_value = 0
                        for short, full in sorted(all_outlets):
                            qtys = outlet_map.get(short, (full, [0] * 7))[1]
                            if qtys and not all(
    q == 0 or q == None for q in qtys):
                                if i < len(qtys):
                                    qty = qtys[i]
                                    if isinstance(
    qty, (int, float)) and qty > 0:
                                        total_value += qty

                        ws_sum.cell(
    row=row_idx,
    column=start_col + 2 + i,
     value=total_value)
                        ws_sum.cell(
    row=row_idx, column=start_col + 2 + i).font = bold
                        ws_sum.cell(
    row=row_idx,
    column=start_col +
    2 +
     i).alignment = center
                    # æ ¼å¼åŒ–å€å¡Š
                    for r in range(start_row, row_idx + 1):
                        for c in range(
    start_col,
     start_col + actual_days + 2):  # +2 æ˜¯å› ç‚ºæœ‰ Short Name å’Œ Full Name å…©æ¬„
                            ws_sum.cell(row=r, column=c).border = border
                # ä½¿ç”¨å®‰å…¨çš„æ–¹æ³•å°‡ Summary ç§»åˆ°ç¬¬ä¸€å€‹ä½ç½®
                print(f"[DEBUG] é‡æ–°æ’åˆ—å·¥ä½œè¡¨é †åº...")
                try:
                    # ç²å–æ‰€æœ‰å·¥ä½œè¡¨åç¨±
                    sheet_names = wb.sheetnames
                    # ç§»é™¤ Summary å·¥ä½œè¡¨
                    if "Summary" in sheet_names:
                        sheet_names.remove("Summary")
                    # å°‡ Summary æ”¾åœ¨ç¬¬ä¸€ä½
                    new_order = ["Summary"] + sheet_names
                    
                    # ä½¿ç”¨ openpyxl çš„å®‰å…¨æ–¹æ³•é‡æ–°æ’åˆ—
                    wb._sheets.sort(key=lambda x: new_order.index(x.title) if x.title in new_order else 999)
                    print(f"[DEBUG] å·¥ä½œè¡¨é‡æ–°æ’åˆ—å®Œæˆ")
                except Exception as reorder_error:
                    print(f"[DEBUG] å·¥ä½œè¡¨é‡æ–°æ’åˆ—å¤±æ•—ï¼Œç¹¼çºŒä¿å­˜: {reorder_error}")

                # ç¸½æ˜¯ä½¿ç”¨å®‰å…¨ä¿å­˜æ–¹æ³•ï¼Œé¿å…å‘½åç¯„åœå•é¡Œ
                print(f"[DEBUG] ä½¿ç”¨å®‰å…¨ä¿å­˜æ–¹æ³•é¿å…å‘½åç¯„åœå•é¡Œ...")
                safe_save_workbook(wb, filepath)
                print(f"[DEBUG] å·²å¯«å…¥ Summary sheet: {filepath}")

            def run_generate_summary():
                from tkinter import messagebox
                import traceback
                import tempfile
                import shutil
                import os

                file_list = self.summary_supplier_files_var.get().split(";")
                file_list = [f for f in file_list if f.strip()]
                if not file_list:
                    messagebox.showwarning(
    "æœªé¸æ“‡æª”æ¡ˆ", "è«‹å…ˆé¸æ“‡è¦ç”¢ç”Ÿ Summary çš„ Supplier æª”æ¡ˆï¼")
                    return
                for file_path in file_list:
                    try:
                        print(f"[DEBUG] å˜—è©¦è®€å–: {file_path}")
                        # xlwings åªèƒ½è™•ç†æœªåŠ å¯†çš„ xlsx
                        # è‹¥åŠ å¯†ï¼Œå…ˆè§£å¯†åˆ°æš«å­˜æª”
                        tmp_path = None
                        try:
                            create_supplier_summary(file_path)
                        except Exception as e:
                            print(f"[DEBUG] ç›´æ¥è™•ç†å¤±æ•—ï¼Œå˜—è©¦è§£å¯†: {e}")
                            try:
                                import msoffcrypto
                            except ImportError:
                                messagebox.showerror(
                                    "ç¼ºå°‘è§£å¯†æ¨¡çµ„",
                                    "æª”æ¡ˆå¯èƒ½å·²åŠ å¯†ä¸”æœªå®‰è£è§£å¯†å¥—ä»¶ã€‚è«‹å…ˆå®‰è£ msoffcrypto-tool:\n\n pip install msoffcrypto-tool"
                                )
                                continue
                            try:
                                with open(file_path, "rb") as f:
                                    office_file = msoffcrypto.OfficeFile(f)
                                    office_file.load_key(password="Apple")
                                    with tempfile.NamedTemporaryFile(delete=False, suffix=".xlsx") as tmp:
                                        office_file.decrypt(tmp)
                                        tmp_path = tmp.name
                                create_supplier_summary(tmp_path)
                                # è¦†è“‹åŸæª”
                                shutil.copyfile(tmp_path, file_path)
                                os.remove(tmp_path)
                            except Exception as de:
                                messagebox.showerror(
    "è§£å¯†å¤±æ•—", f"ç„¡æ³•è§£å¯†æˆ–è™•ç†æª”æ¡ˆï¼š{file_path}\n{de}")
                                continue
                        print(f"[DEBUG] å·²å¯«å…¥: {file_path}")
                    except Exception as e:
                        import traceback
                        messagebox.showerror(
    "éŒ¯èª¤", f"è™•ç†æª”æ¡ˆ {file_path} æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š\n{
        str(e)}\n{
            traceback.format_exc()}")
                        print(f"[DEBUG] ç™¼ç”ŸéŒ¯èª¤: {e}")
                        continue
                messagebox.showinfo("å®Œæˆ", "Summary å·²æˆåŠŸç”¢ç”Ÿä¸¦æ’å…¥åˆ°æ‰€é¸æª”æ¡ˆï¼")

            GlowButton(
                summary_frame,
                text="ç”¢ç”Ÿ Summary\nGenerate Summary",
                command=run_generate_summary,
                width=300,
                height=40,
                glow_color="#8B5CF6"  # æ”¹ç‚ºæ›´å¥½çœ‹çš„ç´«è‰²
            ).pack(pady=(8, 0))

        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # ç›´æ¥æ„å»ºè‡ªåŠ¨åŒ–ç•Œé¢
        build(self.content_body)

    def _is_valid_date_for_append(
    self,
    cell_value,
    next_week_start,
     next_week_end):
        """æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ä¸‹å‘¨æ—¥æœŸï¼ˆç”¨äºè¡¥å•åŠŸèƒ½ï¼‰"""
        try:
            if isinstance(cell_value, (int, float)):
                # Excelæ—¥æœŸä»1900å¹´1æœˆ1æ—¥å¼€å§‹è®¡ç®—
                base_date = datetime(1900, 1, 1)
                # å‡å»2æ˜¯å› ä¸ºExcelçš„æ—¥æœŸç³»ç»Ÿæœ‰ä¸ªbugï¼ˆ1900å¹´è¢«è®¤ä¸ºæ˜¯é—°å¹´ï¼‰
                parsed = base_date + timedelta(days=int(cell_value) - 2)
                return next_week_start <= parsed.date() <= next_week_end
            elif isinstance(cell_value, str):
                sval = cell_value.strip()
                # åŒ¹é… "18-Aug" æ ¼å¼
                if re.match(r"^\d{1,2}-[A-Za-z]{3,}$", sval):
                    # æ·»åŠ å½“å‰å¹´ä»½
                    year = next_week_start.year
                    sval = f"{sval}-{year}"
                    parsed = datetime.strptime(sval, "%d-%b-%Y")
                    return next_week_start <= parsed.date() <= next_week_end
                # åŒ¹é… "18-Aug-2025" æ ¼å¼
                elif re.match(r"^\d{1,2}-[A-Za-z]{3,}-\d{4}$", sval):
                    parsed = datetime.strptime(sval, "%d-%b-%Y")
                    return next_week_start <= parsed.date() <= next_week_end
                # åŒ¹é… "2025-08-18" æ ¼å¼
                elif re.match(r"^\d{4}-\d{2}-\d{2}$", sval):
                    parsed = datetime.strptime(sval, "%Y-%m-%d")
                    return next_week_start <= parsed.date() <= next_week_end
            return False
        except Exception as e:
            print(f"æ—¥æœŸè§£æå¤±è´¥: {cell_value}, é”™è¯¯: {e}")
            return False

    def _show_append_results(self, results):
        """æ˜¾ç¤ºè¡¥å•è¯¦ç»†ç»“æœçª—å£"""
        # åˆ›å»ºç»“æœçª—å£
        result_window = ctk.CTkToplevel(self)
        result_window.title("è£œå–®çµæœè©³æƒ… / Append Order Results")
        result_window.geometry("800x800")
        result_window.resizable(True, True)
        result_window.attributes('-topmost', True)  # è®¾ç½®çª—å£ç½®é¡¶

        # è®¾ç½®çª—å£å›¾æ ‡
        try:
            result_window.iconbitmap("SELOGO22 - 01.ico")
        except:
            pass

        # ä¸»æ ‡é¢˜
        title_label = ctk.CTkLabel(
            result_window,
            text="ğŸ“‹ è£œå–®çµæœè©³æƒ…\nAppend Order Results",
            font=("Microsoft YaHei", 24, "bold"),
            text_color=ACCENT_BLUE,
            justify="center"
        )
        title_label.pack(pady=(20, 10))

        # ä¸‹å‘¨æ—¥æœŸèŒƒå›´
        date_label = ctk.CTkLabel(
            result_window,
            text=f"ğŸ“… ä¸‹å‘¨æ—¥æœŸèŒƒå›´ / Next Week Range: {results['next_week_range']}",
            font=("Microsoft YaHei", 16),
            text_color="#64748b",
            justify="center"
        )
        date_label.pack(pady=(0, 20))

        # åˆ›å»ºæ»šåŠ¨æ¡†æ¶
        scroll_frame = ctk.CTkScrollableFrame(
            result_window, width=750, height=400)
        scroll_frame.pack(fill="both", expand=True, padx=20, pady=(0, 20))

        # æ˜¾ç¤ºå¤„ç†ç»“æœ
        if results['processed_files']:
            for file_result in results['processed_files']:
                # æ–‡ä»¶æ ‡é¢˜
                file_title = ctk.CTkLabel(
                    scroll_frame,
                    text=f"ğŸ“ {file_result['file']}",
                    font=("Microsoft YaHei", 18, "bold"),
                    text_color="#3b82f6",
                    justify="left"
                )
                file_title.pack(anchor="w", pady=(15, 5))

                # æˆåŠŸå¤„ç†çš„ä¾›åº”å•†
                if file_result['suppliers']:
                    success_label = ctk.CTkLabel(
                        scroll_frame,
                        text="âœ… æˆåŠŸè¡¥å•çš„ä¾›åº”å•† / Successfully Appended Suppliers:",
                        font=("Microsoft YaHei", 14, "bold"),
                        text_color="#22c55e",
                        justify="left"
                    )
                    success_label.pack(anchor="w", pady=(5, 2))

                    for supplier in file_result['suppliers']:
                        supplier_label = ctk.CTkLabel(
                            scroll_frame,
                            text=f"   â€¢ {supplier}",
                            font=("Microsoft YaHei", 12),
                            text_color="#22c55e",
                            justify="left"
                        )
                        supplier_label.pack(anchor="w", padx=20)

                # è·³è¿‡çš„ä¾›åº”å•†
                if file_result['skipped']:
                    skip_label = ctk.CTkLabel(
                        scroll_frame,
                        text="â­ï¸ è·³è¿‡çš„ä¾›åº”å•†ï¼ˆæ— ä¸‹å‘¨è®¢å•ï¼‰/ Skipped Suppliers (No Next Week Orders):",
                        font=("Microsoft YaHei", 14, "bold"),
                        text_color="#f59e0b",
                        justify="left"
                    )
                    skip_label.pack(anchor="w", pady=(10, 2))

                    for supplier in file_result['skipped']:
                        supplier_label = ctk.CTkLabel(
                            scroll_frame,
                            text=f"   â€¢ {supplier}",
                            font=("Microsoft YaHei", 12),
                            text_color="#f59e0b",
                            justify="left"
                        )
                        supplier_label.pack(anchor="w", padx=20)

                # åˆ†éš”çº¿
                separator = ctk.CTkFrame(
    scroll_frame, height=2, fg_color="#e2e8f0")
                separator.pack(fill="x", pady=15)

        # æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if results['errors']:
            error_title = ctk.CTkLabel(
                scroll_frame,
                text="âŒ å¤„ç†é”™è¯¯ / Processing Errors:",
                font=("Microsoft YaHei", 14, "bold"),
                text_color="#ef4444",
                justify="left"
            )
            error_title.pack(anchor="w", pady=(15, 5))

            for error in results['errors']:
                error_label = ctk.CTkLabel(
                    scroll_frame,
                    text=f"   â€¢ {error}",
                    font=("Microsoft YaHei", 12),
                    text_color="#ef4444",
                    justify="left"
                )
                error_label.pack(anchor="w", padx=20)

        # å¦‚æœæ²¡æœ‰å¤„ç†ä»»ä½•æ–‡ä»¶
        if not results['processed_files'] and not results['errors']:
            no_result_label = ctk.CTkLabel(
                scroll_frame,
                text="ğŸ“­ æ²¡æœ‰å¤„ç†ä»»ä½•æ–‡ä»¶ / No files processed",
                font=("Microsoft YaHei", 12),
                text_color="#64748b",
                justify="center"
            )
            no_result_label.pack(pady=50)

        # ç»Ÿè®¡ä¿¡æ¯
        total_processed = sum(len(fr['suppliers'])
                              for fr in results['processed_files'])
        total_skipped = sum(len(fr['skipped'])
                            for fr in results['processed_files'])
        total_errors = len(results['errors'])

        stats_frame = ctk.CTkFrame(
    result_window,
    fg_color="#f8fafc",
     corner_radius=10)
        stats_frame.pack(fill="x", padx=20, pady=(0, 20))

        stats_text = f"ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ / Statistics:\n"
        stats_text += f"   â€¢ æˆåŠŸè¡¥å•: {total_processed} ä¸ªä¾›åº”å•†\n"
        stats_text += f"   â€¢ è·³è¿‡å¤„ç†: {total_skipped} ä¸ªä¾›åº”å•†\n"
        stats_text += f"   â€¢ å¤„ç†é”™è¯¯: {total_errors} ä¸ª\n"
        stats_text += f"   â€¢ å¤„ç†æ–‡ä»¶: {len(results['processed_files'])} ä¸ª"

        stats_label = ctk.CTkLabel(
            stats_frame,
            text=stats_text,
            font=("Microsoft YaHei", 14),
            text_color="#374151",
            justify="left"
        )
        stats_label.pack(pady=15, padx=15)

        # æŒ‰é’®æ¡†æ¶
        button_frame = ctk.CTkFrame(result_window, fg_color="transparent")
        button_frame.pack(fill="x", padx=20, pady=(0, 20))

        # å…³é—­æŒ‰é’®
        ctk.CTkButton(
            button_frame,
            text="é—œé–‰ / Close",
            command=result_window.destroy,
            fg_color=ACCENT_BLUE,
            font=FONT_MID
        ).pack(side="right")

        # è®¾ç½®çª—å£å±…ä¸­
        result_window.update_idletasks()
        x = (result_window.winfo_screenwidth() // 2) - \
             (result_window.winfo_width() // 2)
        y = (result_window.winfo_screenheight() // 2) - \
             (result_window.winfo_height() // 2)
        result_window.geometry(f"+{x}+{y}")

    def run_new_append_orders(self):
        """
        Append Outlet Order (new):
        - For each selected outlet weekly-order file and each vendor sheet inside it,
          if the sheet has next-week orders (>0 in any next-week date column),
          then overwrite the entire vendor sheet in the supplier file.
        - If the supplier file does not exist, create a new file using the same naming
          style as Order Automation: "{Vendor}_Week_{weekNo}.xlsx" inside selected
          supplier folder.
        - ä½¿ç”¨ xlwings é¿å…å¤–éƒ¨é“¾æ¥å¼•ç”¨è¢«æ ‡è®°ä¸º "repaired"
        """
        import os
        from datetime import datetime, timedelta
        from tkinter import messagebox
        from openpyxl import load_workbook, Workbook
        from openpyxl.utils import column_index_from_string
        import re
        from copy import copy as _copy

        # Read inputs from the Append Outlet Order area
        outlet_files_raw = getattr(self, 'append_outlet_files_var', None)
        supplier_folder_var = getattr(self, 'append_supplier_folder_var', None)
        supplier_folder = supplier_folder_var.get().strip() if supplier_folder_var else ''

        # Prefer full paths captured during file selection
        outlet_files_full = list(
    getattr(
        self,
        'append_outlet_full_paths',
         [])) or []
        if not outlet_files_full and outlet_files_raw:
            raw = outlet_files_raw.get().strip()
            if raw:
                outlet_files_full = [p for p in raw.split(';') if p]

        if not outlet_files_full:
            messagebox.showerror(
    'éŒ¯èª¤', 'è«‹å…ˆé¸æ“‡é–€å¸‚é€±å–®æª”æ¡ˆ (Select Outlet Order Files)')
            return
        if not supplier_folder or not os.path.isdir(supplier_folder):
            messagebox.showerror('éŒ¯èª¤', 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾›æ‡‰å•†è³‡æ–™å¤¾ (Select Supplier Folder)')
            return

        outlet_files = [
    p for p in outlet_files_full if p and os.path.isfile(p)]
        if not outlet_files:
            messagebox.showerror('éŒ¯èª¤', 'æ‰¾ä¸åˆ°ä»»ä½•æœ‰æ•ˆçš„é–€å¸‚é€±å–®æª”æ¡ˆ')
            return

        # Compute next-week range and unified Month_WeekX naming based on next
        # Monday
        today = datetime.now().date()
        next_monday = today + timedelta(days=(7 - today.weekday()))
        next_sunday = next_monday + timedelta(days=6)
        month_abbr = next_monday.strftime('%b')
        week_in_month = ((next_monday.day - 1) // 7) + 1
        name_suffix = f"{month_abbr}_Week_{week_in_month}"

        def parse_date(value, ws_ctx=None):
            if value is None:
                return None
            # datetime or date
            if hasattr(
    value,
    'year') and hasattr(
        value,
        'month') and hasattr(
            value,
             'day'):
                return value.date() if hasattr(value, 'hour') else value
            # Excel serial
            if isinstance(value, (int, float)):
                try:
                    return datetime.fromordinal(
    datetime(
        1900,
        1,
        1).toordinal() +
        int(value) -
         2).date()
                except Exception:
                    return None
            # String date
            if isinstance(value, str):
                s = value.strip()
                # handle simple Excel-like formulas used in headers, e.g.
                # "=+J25+1" or "=J25+1"
                if s.startswith('='):
                    s2 = s.lstrip('=')
                    s2 = s2[1:] if s2.startswith('+') else s2
                    # 1) direct date string after '=' (rare but possible)
                    try:
                        from dateutil.parser import parse as dtparse
                        maybe = dtparse(s2)
                        return maybe.date()
                    except Exception:
                        pass
                    # 2) reference like J25+1 / J25-1
                    m = re.match(r"^([A-Z]+)(\d+)([+\-]\d+)?$", s2)
                    if m:
                        col_letters = m.group(1)
                        row_num = int(m.group(2))
                        offs = int(m.group(3) or 0)
                        try:
                            col_idx = column_index_from_string(col_letters)
                            if ws_ctx is None:
                                return None
                            base_val = ws_ctx.cell(
    row=row_num, column=col_idx).value
                            base_date = parse_date(base_val)
                            if base_date is not None:
                                return base_date + timedelta(days=offs)
                        except Exception:
                            return None
                    # 3) DATE(y,m,d)
                    m = re.match(
    r"^DATE\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)\)$", s2, re.I)
                    if m:
                        try:
                            y, mth, d = int(
    m.group(1)), int(
        m.group(2)), int(
            m.group(3))
                            return datetime(y, mth, d).date()
                        except Exception:
                            return None
                try:
                    from dateutil.parser import parse as dtparse
                    return dtparse(s).date()
                except Exception:
                    return None
            return None

        replaced, created, skipped, errors = [], [], [], []
        results = {
            'processed_files': [],
            'errors': errors,
            'next_week_range': f"{next_monday.strftime('%Y-%m-%d')} è‡³ {next_sunday.strftime('%Y-%m-%d')}"
        }

        def copy_sheet_fully(src_ws, src_ws_formula, dst_ws):
            """å¤åˆ¶å·¥ä½œè¡¨ï¼Œä¿æŒå®Œæ•´æ ¼å¼å’Œå…¬å¼ï¼Œé¿å…å¤–éƒ¨é“¾æ¥å¼•ç”¨é—®é¢˜"""
            # ç›´æ¥ä½¿ç”¨ openpyxl æ–¹æ³•å¤åˆ¶ï¼Œå› ä¸º xlwings åœ¨è¿™é‡Œä¸é€‚ç”¨
            fallback_copy_sheet_fully(src_ws, src_ws_formula, dst_ws)
        
        def clean_external_links(workbook):
            """æ¸…ç†å·¥ä½œç°¿ä¸­çš„å¤–éƒ¨é“¾æ¥å¼•ç”¨"""
            try:
                # ç§»é™¤å¤–éƒ¨é“¾æ¥
                if hasattr(workbook, '_external_links'):
                    workbook._external_links.clear()
                # ç§»é™¤å¤–éƒ¨å¼•ç”¨
                if hasattr(workbook, '_external_references'):
                    workbook._external_references.clear()
                # è®¾ç½®å±æ€§æ¥å¿½ç•¥å¤–éƒ¨é“¾æ¥
                if hasattr(workbook, 'keep_links'):
                    workbook.keep_links = False
            except Exception:
                pass
            return workbook
        
        def fallback_copy_sheet_fully(src_ws, src_ws_formula, dst_ws):
            """å›é€€çš„ openpyxl å¤åˆ¶æ–¹æ³•"""
            from openpyxl.utils.cell import coordinate_to_tuple
            
            # copy cell values/formulas and styles
            for row in src_ws_formula.iter_rows():
                for cell_formula in row:
                    r, c = cell_formula.row, cell_formula.column
                    dst_cell = dst_ws.cell(row=r, column=c)
                    dst_cell.value = cell_formula.value
                    src_cell = src_ws.cell(row=r, column=c)
                    try:
                        if src_cell.font:
                            dst_cell.font = _copy(src_cell.font)
                        if src_cell.fill:
                            dst_cell.fill = _copy(src_cell.fill)
                        if src_cell.border:
                            dst_cell.border = _copy(src_cell.border)
                        if src_cell.alignment:
                            dst_cell.alignment = _copy(src_cell.alignment)
                        if src_cell.number_format:
                            dst_cell.number_format = src_cell.number_format
                    except Exception:
                        pass
            # merged cells
            try:
                for m in src_ws_formula.merged_cells.ranges:
                    dst_ws.merge_cells(str(m))
            except Exception:
                pass
            # column widths and hidden state
            try:
                for col_letter, dim in src_ws.column_dimensions.items():
                    tgt_dim = dst_ws.column_dimensions[col_letter]
                    if getattr(dim, 'width', None) is not None:
                        tgt_dim.width = dim.width
                    if hasattr(dim, 'hidden') and dim.hidden is not None:
                        tgt_dim.hidden = dim.hidden
                    if hasattr(
    dim, 'outlineLevel') and getattr(
        dim, 'outlineLevel', None):
                        tgt_dim.outlineLevel = dim.outlineLevel
            except Exception:
                pass
            # row heights and hidden state
            try:
                for idx, dim in src_ws.row_dimensions.items():
                    tgt = dst_ws.row_dimensions[idx]
                    if getattr(dim, 'height', None) is not None:
                        tgt.height = dim.height
                    if hasattr(dim, 'hidden') and dim.hidden is not None:
                        tgt.hidden = dim.hidden
                    if hasattr(
    dim, 'outlineLevel') and getattr(
        dim, 'outlineLevel', None):
                        tgt_dim.outlineLevel = dim.outlineLevel
            except Exception:
                pass
            # å›ºå®šè¨­å®šå‡çµçª—æ ¼ç‚º A9
            try:
                dst_ws.freeze_panes = "A9"
                print(f"[DEBUG] Append: è¨­å®šå›ºå®šå‡çµçª—æ ¼ A9")
            except Exception as freeze_error:
                print(f"[DEBUG] Append: è¨­å®šå‡çµçª—æ ¼å¤±æ•—: {freeze_error}")
                pass
            try:
                if getattr(
    src_ws,
    'auto_filter',
     None) and src_ws.auto_filter.ref:
                    dst_ws.auto_filter.ref = src_ws.auto_filter.ref
            except Exception:
                pass

        for src_path in outlet_files:
            try:
                # ä½¿ç”¨ openpyxl åŠ è½½æ–‡ä»¶ï¼Œæ·»åŠ å¤šä¸ªå‚æ•°æ¥é¿å…å¤–éƒ¨é“¾æ¥å¼•ç”¨é—®é¢˜
                wb_src = load_workbook(src_path, data_only=True, keep_links=False, read_only=False)
                wb_src_formula = load_workbook(src_path, data_only=False, keep_links=False, read_only=False)
                
                # æ¸…ç†å¤–éƒ¨é“¾æ¥å¼•ç”¨
                wb_src = clean_external_links(wb_src)
                wb_src_formula = clean_external_links(wb_src_formula)
                src_basename = os.path.basename(src_path)
                # Derive outlet short code from filename, e.g.,
                # "WL_WeeklyOrder_33.xlsx" -> "WL"
                m_code = re.match(
    r"^([A-Za-z0-9]+)[ _-]?WeeklyOrder", src_basename, re.I)
                outlet_code = (m_code.group(1).upper() if m_code else '')
                file_result = {
    'file': src_basename,
    'suppliers': [],
     'skipped': []}
                for vendor in wb_src.sheetnames:
                    ws = wb_src[vendor]
                    ws_form = wb_src_formula[vendor]
                    # skip hidden sheets
                    try:
                        if hasattr(
    ws, 'sheet_state') and ws.sheet_state != 'visible':
                            continue
                    except Exception:
                        pass

                    # 1) Find ALL weekday rows (Mon..Sun) and use each
                    # following row as a candidate date row
                    week_days = {
    'mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'}
                    max_col = ws.max_column
                    weekday_rows = []
                    for r in range(1, min(400, ws.max_row) + 1):
                        row_vals = [str(ws.cell(row=r, column=c).value or '').strip(
                        ).lower() for c in range(1, min(60, max_col) + 1)]
                        if any('mon' in v for v in row_vals):
                            hits = sum(any(day in v for v in row_vals) for day in [
                                       'mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'])
                            if hits >= 3:
                                weekday_rows.append(r)
                    if not weekday_rows:
                        skipped.append(f"{vendor} (æœªæ‰¾åˆ°æ˜ŸæœŸåˆ—)")
                        file_result['skipped'].append(f"{vendor} (æœªæ‰¾åˆ°æ˜ŸæœŸåˆ—)")
                        continue

                    # 2) Identify next-week date columns from any candidate
                    # date row
                    next_week_cols = []
                    for wr in weekday_rows:
                        date_row = wr + 1
                        cols = []
                        for c in range(1, max_col + 1):
                            raw = ws.cell(row=date_row, column=c).value
                            d = parse_date(raw, ws)
                            if d is None:
                                raw_formula = ws_form.cell(
                                    row=date_row, column=c).value
                                if isinstance(raw_formula, str):
                                    d = parse_date(raw_formula, ws)
                            if d and next_monday <= d <= next_sunday:
                                cols.append(c)
                        if cols:
                            next_week_cols = cols
                            break
                    if not next_week_cols:
                        skipped.append(f"{vendor} (ç„¡ä¸‹é€±æ—¥æœŸ)")
                        file_result['skipped'].append(f"{vendor} (ç„¡ä¸‹é€±æ—¥æœŸ)")
                        continue

                    # 3) Verify there is any >0 quantity beneath these columns
                    # (scan a generous range)
                    has_qty = False
                    start_row = min(wr + 2, ws.max_row)  # row after date row
                    for r in range(
    start_row, min(
        ws.max_row, start_row + 120) + 1):
                        for c in next_week_cols:
                            val = ws.cell(row=r, column=c).value
                            try:
                                if float(val) > 0:
                                    has_qty = True
                                    break
                            except Exception:
                                pass
                        if has_qty:
                            break
                    if not has_qty:
                        skipped.append(f"{vendor} (ä¸‹é€±åˆ—ç„¡æ•¸é‡)")
                        file_result['skipped'].append(f"{vendor} (ä¸‹é€±åˆ—ç„¡æ•¸é‡)")
                        continue

                    # 4) Find or create supplier file
                    target_file = None
                    vendor_lower = vendor.lower()
                    for name in os.listdir(supplier_folder):
                        if name.lower().endswith('.xlsx') and vendor_lower in name.lower():
                            target_file = os.path.join(supplier_folder, name)
                            break
                    desired_path = os.path.join(
    supplier_folder, f"{vendor}_{name_suffix}.xlsx")
                    if target_file is None:
                        target_file = desired_path
                        try:
                            wb_new = Workbook()
                            if 'Sheet' in wb_new.sheetnames:
                                del wb_new['Sheet']
                            wb_new.save(target_file)
                            created.append(os.path.basename(target_file))
                        except Exception as ce:
                            errors.append(f"å»ºç«‹æª”æ¡ˆå¤±æ•— {vendor}: {ce}")
                            continue
                    else:
                        # rename existing file to desired naming if different
                        try:
                            if os.path.normcase(
                                target_file) != os.path.normcase(desired_path):
                                if not os.path.exists(desired_path):
                                    os.replace(target_file, desired_path)
                                target_file = desired_path
                        except Exception:
                            pass

                    # 5) Overwrite entire vendor sheet in target supplier file
                    try:
                        wb_dst = load_workbook(target_file, keep_links=False)
                        # æ¸…ç†ç›®æ ‡å·¥ä½œç°¿çš„å¤–éƒ¨é“¾æ¥å¼•ç”¨
                        wb_dst = clean_external_links(wb_dst)
                        # Sheet name should be outlet code (WL, 313, etc.) same
                        # as Order Automation
                        # å¦‚æœæ²’æœ‰è§£æå‡ºé–€å¸‚ä»£ç¢¼ï¼Œä½¿ç”¨æª”æ¡ˆåå‰ç¶´ä½œç‚ºå‚™é¸
                        if not outlet_code:
                            # å˜—è©¦å¾æª”æ¡ˆåæå–æ›´é€šç”¨çš„å‰ç¶´
                            name_parts = src_basename.replace('.xlsx', '').split('_')
                            outlet_code = name_parts[0] if name_parts else 'Outlet'
                        tab_name = outlet_code
                        if tab_name in wb_dst.sheetnames:
                            del wb_dst[tab_name]
                        ws_new = wb_dst.create_sheet(tab_name)
                        copy_sheet_fully(ws, ws_form, ws_new)
                        try:
                            wb_dst.calculation_properties.fullCalcOnLoad = True
                        except Exception:
                            pass
                        # ä½¿ç”¨å®‰å…¨å„²å­˜æ–¹å¼ï¼Œé¿å… Named range éŒ¯èª¤
                        safe_save_excel_workbook(wb_dst, target_file)
                        replaced.append(f"{vendor} <- {src_basename}")
                        if tab_name != vendor:
                            file_result['suppliers'].append(
                                f"{vendor} â†’ {tab_name} @ {os.path.basename(target_file)}")
                        else:
                            file_result['suppliers'].append(
                                f"{vendor} @ {os.path.basename(target_file)}")
                    except Exception as we:
                        errors.append(f"è¦†è“‹å¤±æ•— {vendor}: {we}")
                        file_result['skipped'].append(f"{vendor} (è¦†è“‹å¤±æ•—)")
                        continue
            except Exception as e:
                errors.append(f"è®€å–ä¾†æºå¤±æ•— {os.path.basename(src_path)}: {e}")
            finally:
                if file_result['suppliers'] or file_result['skipped']:
                    results['processed_files'].append(file_result)

        # Show beautified results window
        try:
            self._show_append_results(results)
        except Exception:
            # Fallback simple message
            report = []
            report.append(f"æˆåŠŸè¦†è“‹ sheetï¼š{len(replaced)}")
            for it in replaced:
                report.append(f"- {it}")
            if created:
                report.append(f"\næ–°å»ºæª”æ¡ˆï¼š{len(created)}")
                for it in created:
                    report.append(f"- {it}")
            if skipped:
                report.append(f"\nè·³éï¼š{len(skipped)}")
                for it in skipped:
                    report.append(f"- {it}")
            if errors:
                report.append(f"\néŒ¯èª¤ï¼š{len(errors)}")
                for it in errors:
                    report.append(f"- {it}")
            messagebox.showinfo('è£œå–®å®Œæˆ', "\n".join(report))

    def show_monthend_monthly_summary_ui(self):
        """æœˆçµ > è¨‚å–®æœˆåº¦å½™ç¸½ï¼šå¯é¸å¤šå€‹ Excel æª”æ¡ˆæ•´åˆæ•¸é‡ä¸¦è¼¸å‡º"""
        def build(c):
            import os
            import openpyxl
            from openpyxl.styles import Alignment, Font, PatternFill, Border, Side
            from openpyxl.utils import get_column_letter
            from tkinter import messagebox

            # ç‹€æ…‹è®Šæ•¸
            self.monthsum_files_var = ctk.StringVar()
            self.monthsum_output_var = ctk.StringVar(
                value=os.path.join(os.path.expanduser('~'), 'Downloads'))
            self.monthsum_config_var = ctk.StringVar()

            # é¸æª”/é¸è³‡æ–™å¤¾
            def pick_files():
                from tkinter import filedialog
                files = filedialog.askopenfilenames(
                    title="é¸æ“‡è¦æ•´åˆçš„è¨‚å–®æª”æ¡ˆ", filetypes=[("Excel files", "*.xlsx;*.xlsm")])
                if files:
                    self.monthsum_files_var.set(";".join(files))

            def pick_output_folder():
                from tkinter import filedialog
                d = filedialog.askdirectory()
                if d:
                    self.monthsum_output_var.set(d)

            # ä»‹é¢
            form = ctk.CTkFrame(c, fg_color=DARK_PANEL, corner_radius=16)
            form.pack(fill="x", padx=30, pady=10)

            row1 = ctk.CTkFrame(form, fg_color='transparent')
            row1.pack(fill='x', pady=6)
            ctk.CTkLabel(
    row1,
    text="é¸æ“‡å¤šå€‹ Excel æª”æ¡ˆ\nSelect multiple Excel files",
    font=FONT_MID).pack(
        side='left',
         padx=8)
            ctk.CTkEntry(
    row1,
    textvariable=self.monthsum_files_var,
    state='readonly').pack(
        side='left',
        fill='x',
        expand=True,
         padx=6)
            ctk.CTkButton(
    row1,
    text='ç€è¦½...\nBrowse...',
    command=pick_files,
    corner_radius=8,
    hover_color="#1976d2").pack(
        side='left',
         padx=4)

            row2 = ctk.CTkFrame(form, fg_color='transparent')
            row2.pack(fill='x', pady=6)
            ctk.CTkLabel(
    row2,
    text="è¼¸å‡ºè³‡æ–™å¤¾\nOutput folder",
    font=FONT_MID).pack(
        side='left',
         padx=8)
            ctk.CTkEntry(
    row2, textvariable=self.monthsum_output_var).pack(
        side='left', fill='x', expand=True, padx=6)
            ctk.CTkButton(
    row2,
    text='é¸æ“‡...\nChoose...',
    command=pick_output_folder,
    corner_radius=8,
    hover_color="#1976d2").pack(
        side='left',
         padx=4)

            row2b = ctk.CTkFrame(form, fg_color='transparent')
            row2b.pack(fill='x', pady=6)
            ctk.CTkLabel(
    row2b,
    text="é…ç½®æª”ï¼ˆå« Outletsï¼‰\nConfig file (with Outlets)",
    font=FONT_MID).pack(
        side='left',
         padx=8)
            ctk.CTkEntry(
    row2b,
    textvariable=self.monthsum_config_var,
    state='readonly').pack(
        side='left',
        fill='x',
        expand=True,
         padx=6)
            ctk.CTkButton(
    row2b,
    text='ç€è¦½...\nBrowse...',
    command=lambda: self._select_config_file(
        self.monthsum_config_var,
        [
            ("Excel files",
            "*.xlsx;*.xls")]),
            corner_radius=8,
            hover_color="#1976d2").pack(
                side='left',
                 padx=4)

            # æ·»åŠ æ¨¡å¼é€‰æ‹©
            mode_frame = ctk.CTkFrame(form, fg_color='transparent')
            mode_frame.pack(fill='x', pady=6)
            ctk.CTkLabel(
                mode_frame,
                text="é¸æ“‡æ¨¡å¼\nSelect Mode",
                font=FONT_MID).pack(side='left', padx=8)
            
            self.monthsum_mode_var = ctk.StringVar(value="monthly_order")
            ctk.CTkRadioButton(
                mode_frame,
                text="æœˆåº¦è¨‚å–®å½™ç¸½\nMonthly Order Summary",
                variable=self.monthsum_mode_var,
                value="monthly_order",
                font=FONT_SMALL).pack(side='left', padx=8)
            ctk.CTkRadioButton(
                mode_frame,
                text="ç›¤é»å½™ç¸½\nStocktake Summary",
                variable=self.monthsum_mode_var,
                value="stocktake",
                font=FONT_SMALL).pack(side='left', padx=8)

            ctk.CTkLabel(
    form,
    text="æ•´åˆå¤šå€‹æª”æ¡ˆï¼Œä¾å„æ—¥å¯¦éš›è¨‚è³¼æ—¥æœŸæ­¸å…¥å°æ‡‰ã€å¹´-æœˆã€ï¼Œæ¯å€‹ç”¢å“ä¸€å€‹å·¥ä½œè¡¨ï¼Œåˆ—å‡ºå„é–€å¸‚æŒ‰æœˆä»½çš„å½™ç¸½ã€‚\nMerge multiple files. Group orders into Year-Month by actual order dates. One sheet per product with Outlets Ã— Months.",
    text_color=ACCENT_GREEN,
    wraplength=800,
    justify='left').pack(
        anchor='w',
        padx=8,
        pady=(
            0,
             8))

            # è§£æèˆ‡è¼¸å‡º
            def _normalize(s: str) -> str:
                import re
                return re.sub(r"[^a-z0-9]", "", (s or "").lower())

            def _load_outlet_mapping(cfg_path: str):
                mapping = []  # [(short, norm_address)]
                if not cfg_path:
                    return mapping
                try:
                    cfg = UnifiedConfigManager(cfg_path)
                    for o in getattr(cfg, 'outlets', []) or []:
                        short = str(o.get('code') or o.get('short')
                                    or o.get('Short Name') or '').strip()
                        addr = str(o.get('address') or '').strip()
                        if short and addr:
                            mapping.append((short, _normalize(addr)))
                except Exception as e:
                    print('[MonthlySummary] load config failed:', e)
                return mapping

            outlet_mapping_cache = None

            def _match_short_by_address(ws, wb):
                nonlocal outlet_mapping_cache
                if outlet_mapping_cache is None:
                    outlet_mapping_cache = _load_outlet_mapping(
                        self.monthsum_config_var.get())
                # å–å ±è¡¨æŠ¬é ­å€çš„åç¨±èˆ‡åœ°å€ï¼ˆF5~F8 å¸¸è¦‹ï¼‰
                try:
                    header_vals = [str(ws.cell(row=r, column=6).value or '')
                                       for r in range(4, 9)]
                except Exception:
                    header_vals = []
                header_text = " ".join(v for v in header_vals if v).strip()
                norm_header = _normalize(header_text)
                if not norm_header:
                    return None
                # æœ€é•·å­å­—ä¸²åŒ¹é…
                best = None
                best_len = 0
                for short, norm_addr in outlet_mapping_cache:
                    if not norm_addr:
                        continue
                    if norm_addr in norm_header or norm_header in norm_addr:
                        score = len(norm_addr)
                        if score > best_len:
                            best = short
                            best_len = score
                return best

            def parse_one_file(
    path: str,
    acc_by_prod: dict,
    acc_amt_by_prod: dict,
    months_set: set,
     outlets_set: set):
                from datetime import datetime
                wb = openpyxl.load_workbook(path, data_only=True)
                try:
                    for sheet in wb.sheetnames:
                        if sheet in (
    "Sheet",
    "Summary",
    "Data",
    "Raw Sheet",
    "Sales Category",
    "Freshening",
    "Legacy",
     "Unikleen"):
                            continue
                        ws = wb[sheet]
                        last_row = ws.max_row
                        # å…ˆç”¨åœ°å€å° config åŒ¹é… short nameï¼Œæ‰¾ä¸åˆ°å†å›é€€ç”¨å·¥ä½œè¡¨å
                        outlet_short = _match_short_by_address(ws, wb) or sheet
                        outlets_set.add(outlet_short)
                        row = 1
                        while row <= last_row:
                            val = ws.cell(row=row, column=2).value
                            if val and "description" in str(val).lower():
                                date_row_idx = row
                                date_cols = list(range(6, 13))  # F~L
                                # è§£ææ—¥æœŸ
                                date_vals = []
                                for col in date_cols:
                                    cell_val = ws.cell(
    row=date_row_idx, column=col).value
                                    if isinstance(cell_val, str):
                                        try:
                                            # å¯èƒ½æ˜¯ "01-Jul"
                                            # é€™ç¨®ï¼Œå¹´åˆ†ä»¥å¯¦éš›ç•¶å¹´æ¨ä¼°æ„ç¾©ä¸å¤§ï¼›é€™è£¡åªç‚ºäº†å–å¾—æœˆæ—¥
                                            parsed = datetime.strptime(
                                                cell_val.strip(), "%d-%b")
                                            # ä¸è¨­å®šå¹´ä»½ï¼Œç¨å¾ŒæŒ‰å¯¦éš›æœˆä»½è™•ç†
                                            date_vals.append(
                                                (None, parsed.month, parsed.day))
                                        except Exception:
                                            date_vals.append(None)
                                    elif isinstance(cell_val, datetime):
                                        date_vals.append(
    (cell_val.year, cell_val.month, cell_val.day))
                                    else:
                                        date_vals.append(None)

                                # ç”¢å“è¡Œ
                                prod_row = row + 1
                                while prod_row <= last_row:
                                    eng = ws.cell(row=prod_row, column=2).value
                                    chi = ws.cell(row=prod_row, column=3).value
                                    if not eng or str(eng).strip() == "" or str(
                                        eng).strip().startswith("="):
                                        break
                                    if "sub-total" in str(eng).lower():
                                        prod_row += 1
                                        continue

                                    # å–å¾—å–®åƒ¹ï¼ˆå‡è¨­åƒ¹æ ¼åœ¨ç¬¬4æ¬„ï¼Œå¯èƒ½å« $ ç¬¦è™Ÿï¼‰
                                    raw_price = ws.cell(
                                        row=prod_row, column=4).value
                                    price = 0.0
                                    try:
                                        if isinstance(raw_price, (int, float)):
                                            price = float(raw_price)
                                        elif isinstance(raw_price, str):
                                            price = float(
    raw_price.replace(
        '$', '').replace(
            ' ', ''))
                                    except Exception:
                                        price = 0.0

                                    # é€æ—¥ç´¯åŠ åˆ°å°æ‡‰æœˆä»½ï¼ˆå¹´-æœˆï¼‰
                                    for idx, col in enumerate(date_cols):
                                        qv = ws.cell(
    row=prod_row, column=col).value
                                        if qv in (None, ""):
                                            continue
                                        try:
                                            qf = float(qv)
                                        except Exception:
                                            continue
                                        dv = date_vals[idx]
                                        if not dv:
                                            continue
                                        # æ¨å®šå¹´æœˆï¼šè‹¥ç¼ºå¹´ï¼Œä½¿ç”¨æ–‡ä»¶å¯èƒ½å¹´ä»½è³‡è¨Šä¸è¶³ï¼›æ¡å–ç°¡å–®ç­–ç•¥ï¼š
                                        # è‹¥å·¥ä½œç°¿å±¬æ€§æœ‰
                                        # 'Properties.created'ï¼Œå–å…¶å¹´ï¼Œå¦å‰‡ç”¨ç•¶å‰å¹´ä»½
                                        y, m, _ = dv
                                        if y is None:
                                            try:
                                                y = (
    wb.properties.created.year if wb.properties and wb.properties.created else datetime.now().year)
                                            except Exception:
                                                y = datetime.now().year
                                        ym = f"{y:04d}-{m:02d}"
                                        months_set.add(ym)

                                        key = (
    str(eng).strip(), str(chi).strip() if chi else "")
                                        if key not in acc_by_prod:
                                            acc_by_prod[key] = {}
                                        if outlet_short not in acc_by_prod[key]:
                                            acc_by_prod[key][outlet_short] = {}
                                        acc_by_prod[key][outlet_short][ym] = acc_by_prod[key][outlet_short].get(
                                            ym, 0.0) + qf

                                        # é‡‘é¡å½™ç¸½
                                        if key not in acc_amt_by_prod:
                                            acc_amt_by_prod[key] = {}
                                        if outlet_short not in acc_amt_by_prod[key]:
                                            acc_amt_by_prod[key][outlet_short] = {
                                                }
                                        acc_amt_by_prod[key][outlet_short][ym] = acc_amt_by_prod[key][outlet_short].get(
                                            ym, 0.0) + (qf * price)
                                    prod_row += 1
                                row = prod_row
                            else:
                                row += 1
                finally:
                    wb.close()

            def parse_stocktake_file(
                path: str,
                acc_by_prod: dict,
                months_set: set,
                outlets_set: set):
                """è§£æStocktakeæ–‡ä»¶ï¼šä»A47-64è¯»å–äº§å“åç§°ï¼ŒF47-F64è¯»å–æ•°æ®"""
                from datetime import datetime
                wb = openpyxl.load_workbook(path, data_only=True)
                try:
                    for sheet in wb.sheetnames:
                        if sheet in ("Sheet", "Summary", "Data", "Raw Sheet", "Sales Category", 
                                   "Image", "Freshening", "Legacy", "Unikleen"):
                            continue
                        
                        ws = wb[sheet]
                        outlet_short = sheet  # ä½¿ç”¨sheetåä½œä¸ºåº—å
                        outlets_set.add(outlet_short)
                        
                        # æ™ºèƒ½è¯†åˆ«èµ·å§‹è¡Œï¼šæŸ¥æ‰¾"Dip-Off Distaining Powder"
                        start_row = None
                        for search_row in range(40, 70):  # åœ¨40-70è¡ŒèŒƒå›´å†…æœç´¢
                            cell_value = ws.cell(row=search_row, column=1).value
                            if cell_value and "Dip-Off Distaining Powder" in str(cell_value):
                                start_row = search_row
                                break
                        
                        # å¦‚æœæ‰¾ä¸åˆ°ï¼Œä½¿ç”¨é»˜è®¤çš„47è¡Œ
                        if start_row is None:
                            start_row = 47
                        
                        # ä»è¯†åˆ«åˆ°çš„èµ·å§‹è¡Œå¼€å§‹è¯»å–äº§å“æ•°æ®ï¼ˆè¯»å–18è¡Œæ•°æ®ï¼‰
                        for row in range(start_row, start_row + 18):
                            product_name = ws.cell(row=row, column=1).value  # Aåˆ—
                            stocktake_qty = ws.cell(row=row, column=6).value  # Fåˆ—
                            
                            if not product_name or str(product_name).strip() == "":
                                continue
                                
                            try:
                                qty = float(stocktake_qty) if stocktake_qty is not None else 0.0
                            except (ValueError, TypeError):
                                qty = 0.0
                            
                            if qty == 0:
                                continue
                            
                            # ä»æ–‡ä»¶åè§£ææœˆä»½
                            filename = os.path.basename(path)
                            month_year = None
                            
                            # å°è¯•ä»æ–‡ä»¶åè§£ææœˆä»½
                            import re
                            month_patterns = [
                                r'(\w+)\s*(\d{4})',  # Sep 2025, September 2025
                                r'(\d{1,2})[.-]\s*(\w+)\s*(\d{4})',  # 9-Sep-2025, 9. September 2025
                                r'(\w+)\'(\d{2})',  # Sep'25
                            ]
                            
                            for pattern in month_patterns:
                                match = re.search(pattern, filename, re.IGNORECASE)
                                if match:
                                    try:
                                        if len(match.groups()) == 2:
                                            month_str, year_str = match.groups()
                                            if len(year_str) == 2:
                                                year_str = '20' + year_str
                                            month_year = f"{year_str}-{_parse_month(month_str):02d}"
                                        elif len(match.groups()) == 3:
                                            day, month_str, year_str = match.groups()
                                            month_year = f"{year_str}-{_parse_month(month_str):02d}"
                                        break
                                    except:
                                        continue
                            
                            # å¦‚æœæ— æ³•ä»æ–‡ä»¶åè§£æï¼Œä½¿ç”¨å½“å‰æœˆä»½
                            if not month_year:
                                now = datetime.now()
                                month_year = f"{now.year:04d}-{now.month:02d}"
                            
                            months_set.add(month_year)
                            
                            # å­˜å‚¨æ•°æ®
                            key = (str(product_name).strip(), "")
                            if key not in acc_by_prod:
                                acc_by_prod[key] = {}
                            if outlet_short not in acc_by_prod[key]:
                                acc_by_prod[key][outlet_short] = {}
                            acc_by_prod[key][outlet_short][month_year] = acc_by_prod[key][outlet_short].get(month_year, 0.0) + qty
                            
                finally:
                    wb.close()
            
            def _parse_month(month_str):
                """è§£ææœˆä»½å­—ç¬¦ä¸²ä¸ºæ•°å­—"""
                month_map = {
                    'jan': 1, 'january': 1,
                    'feb': 2, 'february': 2,
                    'mar': 3, 'march': 3,
                    'apr': 4, 'april': 4,
                    'may': 5,
                    'jun': 6, 'june': 6,
                    'jul': 7, 'july': 7,
                    'aug': 8, 'august': 8,
                    'sep': 9, 'september': 9,
                    'oct': 10, 'october': 10,
                    'nov': 11, 'november': 11,
                    'dec': 12, 'december': 12
                }
                return month_map.get(month_str.lower(), 1)

            def export_summary(
    acc_by_prod: dict,
    acc_amt_by_prod: dict,
    months_sorted: list,
    outlets_sorted: list,
     out_path: str):
                from datetime import datetime
                wb = openpyxl.Workbook()
                # ç§»é™¤é è¨­å·¥ä½œè¡¨ï¼Œæ”¹ç”±ç¬¬ä¸€å€‹ç”¢å“å»ºç«‹
                if wb.sheetnames:
                    del wb[wb.sheetnames[0]]

                header_fill = PatternFill("solid", fgColor="BDD7EE")
                bold = Font(bold=True)
                center = Alignment(horizontal='center', vertical='center')

                def ym_to_label(ym: str) -> str:
                    y, m = ym.split('-')
                    dt = datetime(int(y), int(m), 1)
                    return dt.strftime('%b-%y')

                # ç‚ºæ¯å€‹ç”¢å“å»ºç«‹ä¸€å€‹å·¥ä½œè¡¨ï¼šåˆ— = é–€å¸‚ï¼Œæ¬„ = æœˆä»½
                for (
    eng,
    chi) in sorted(
        acc_by_prod.keys(),
         key=lambda x: x[0]):
                    # å·¥ä½œè¡¨åç¨±é™åˆ¶é•·åº¦èˆ‡éæ³•å­—å…ƒ
                    raw_name = eng if eng else 'Product'
                    sheet_name = raw_name[:31] if len(
                        raw_name) > 31 else raw_name
                    if sheet_name in wb.sheetnames:
                        base = sheet_name[:28]
                        idx = 1
                        while f"{base}_{idx}" in wb.sheetnames:
                            idx += 1
                        sheet_name = f"{base}_{idx}"
                    ws = wb.create_sheet(sheet_name)

                    # Header
                    ws.cell(row=1, column=1, value='Outlet').font = bold
                    ws.cell(row=1, column=1).fill = header_fill
                    # æœˆä»½æ¬„
                    for j, ym in enumerate(months_sorted, start=2):
                        ws.cell(
    row=1, column=j, value=ym_to_label(ym)).font = bold
                        ws.cell(row=1, column=j).alignment = center
                        ws.cell(row=1, column=j).fill = header_fill

                    # é€é–€å¸‚å¡«å€¼
                    prod_map = acc_by_prod[(eng, chi)]  # {outlet: {ym: qty}}
                    for i, outlet in enumerate(outlets_sorted, start=2):
                        ws.cell(row=i, column=1, value=outlet)
                        ym_map = prod_map.get(outlet, {})
                        for j, ym in enumerate(months_sorted, start=2):
                            val = ym_map.get(ym)
                            if val not in (None, 0):
                                ws.cell(row=i, column=j, value=val)

                # ç¸½è¡¨ï¼ˆæ•¸é‡ï¼‰
                ws_sum_qty = wb.create_sheet('All Products - Qty')
                ws_sum_qty.cell(row=1, column=1, value='Outlet').font = bold
                ws_sum_qty.cell(row=1, column=1).fill = header_fill
                for j, ym in enumerate(months_sorted, start=2):
                    ws_sum_qty.cell(
    row=1, column=j, value=ym_to_label(ym)).font = bold
                    ws_sum_qty.cell(row=1, column=j).alignment = center
                    ws_sum_qty.cell(row=1, column=j).fill = header_fill
                for i, outlet in enumerate(outlets_sorted, start=2):
                    ws_sum_qty.cell(row=i, column=1, value=outlet)
                    for j, ym in enumerate(months_sorted, start=2):
                        total = 0.0
                        for key in acc_by_prod.keys():
                            total += acc_by_prod[key].get(outlet,
                                                          {}).get(ym, 0.0)
                        if total not in (None, 0):
                            ws_sum_qty.cell(row=i, column=j, value=total)

                # ç¸½è¡¨ï¼ˆé‡‘é¡ï¼‰
                ws_sum_amt = wb.create_sheet('All Products - Amount')
                ws_sum_amt.cell(row=1, column=1, value='Outlet').font = bold
                ws_sum_amt.cell(row=1, column=1).fill = header_fill
                for j, ym in enumerate(months_sorted, start=2):
                    ws_sum_amt.cell(
    row=1, column=j, value=ym_to_label(ym)).font = bold
                    ws_sum_amt.cell(row=1, column=j).alignment = center
                    ws_sum_amt.cell(row=1, column=j).fill = header_fill
                for i, outlet in enumerate(outlets_sorted, start=2):
                    ws_sum_amt.cell(row=i, column=1, value=outlet)
                    for j, ym in enumerate(months_sorted, start=2):
                        total_amt = 0.0
                        for key in acc_amt_by_prod.keys():
                            total_amt += acc_amt_by_prod[key].get(
                                outlet, {}).get(ym, 0.0)
                        if total_amt not in (None, 0):
                            ws_sum_amt.cell(row=i, column=j, value=total_amt)

                wb.save(out_path)

            def run_merge():
                files = [
    f for f in self.monthsum_files_var.get().split(';') if f.strip()]
                if not files:
                    messagebox.showwarning('æª”æ¡ˆ', 'è«‹é¸æ“‡è¦æ•´åˆçš„ Excel æª”æ¡ˆ')
                    return
                os.makedirs(self.monthsum_output_var.get(), exist_ok=True)
                acc_by_prod = {}
                acc_amt_by_prod = {}
                months_set = set()
                outlets_set = set()
                
                mode = self.monthsum_mode_var.get()
                
                for fp in files:
                    try:
                        if mode == "stocktake":
                            parse_stocktake_file(fp, acc_by_prod, months_set, outlets_set)
                        else:  # monthly_order
                            parse_one_file(fp, acc_by_prod, acc_amt_by_prod, months_set, outlets_set)
                    except Exception as e:
                        messagebox.showerror('éŒ¯èª¤', f'è™•ç†æª”æ¡ˆå¤±æ•—ï¼š\n{fp}\n{e}')
                        return
                
                # æ ¹æ®æ¨¡å¼é€‰æ‹©è¾“å‡ºæ–‡ä»¶å
                if mode == "stocktake":
                    out_file = os.path.join(self.monthsum_output_var.get(), 'Stocktake_Summary.xlsx')
                else:
                    out_file = os.path.join(self.monthsum_output_var.get(), 'Monthly_Order_Summary.xlsx')
                
                try:
                    # sort months by YYYY-MM
                    months_sorted = sorted(months_set)
                    outlets_sorted = sorted(outlets_set)
                    
                    if mode == "stocktake":
                        # å¯¹äºstocktakeæ¨¡å¼ï¼Œä¸éœ€è¦é‡‘é¢æ•°æ®
                        export_summary(acc_by_prod, {}, months_sorted, outlets_sorted, out_file)
                    else:
                        export_summary(acc_by_prod, acc_amt_by_prod, months_sorted, outlets_sorted, out_file)
                except Exception as e:
                    messagebox.showerror('éŒ¯èª¤', f'è¼¸å‡ºå¤±æ•—ï¼š{e}')
                    return
                messagebox.showinfo('å®Œæˆ', f'å·²è¼¸å‡ºï¼š\n{out_file}')

            try:
                GlowButton(
    form,
    text='é–‹å§‹æ•´åˆ\nMerge',
    command=run_merge,
    width=280,
    height=40,
    glow_color=ACCENT_GREEN,
    corner_radius=18).pack(
        pady=(
            6,
             2))
            except Exception:
                ctk.CTkButton(
    form,
    text='é–‹å§‹æ•´åˆ\nMerge',
    fg_color=ACCENT_GREEN,
    command=run_merge,
    height=36).pack(
        pady=(
            6,
             2))

            # ========== é‡‘é¡æ•´åˆï¼ˆä»¥å» å•†ç‚ºä¸»ï¼‰ ==========
            amt_frame = ctk.CTkFrame(c, fg_color=DARK_PANEL, corner_radius=16)
            amt_frame.pack(fill="x", padx=30, pady=10)
            ctk.CTkLabel(
    amt_frame,
    text="æ•´åˆé‡‘é¡ï¼ˆTTLï¼‰ï¼ä»¥å» å•†ç‚ºä¸»\nMerge Amounts (TTL) by Supplier",
    font=FONT_MID,
    text_color=ACCENT_GREEN).pack(
        anchor='w',
        padx=8,
        pady=(
            10,
             2))
            ctk.CTkLabel(
    amt_frame,
    text="æœˆä»½å°‡å¾æª”åæˆ–è·¯å¾‘è§£æï¼Œä¾‹å¦‚ï¼šJul'25ã€September 2024ã€7. July 2025ã€‚\nMonths parsed from filename/path, e.g., Jul'25, September 2024, 7. July 2025.",
    font=(
        "Microsoft JhengHei",
        11),
        text_color="#9CA3AF",
        justify='left',
        wraplength=900).pack(
            anchor='w',
            padx=8,
            pady=(
                0,
                 6))

            self.monthamt_files_var = ctk.StringVar()

            def pick_amt_files():
                from tkinter import filedialog
                files = filedialog.askopenfilenames(
    title="é¸æ“‡å«å» å•†å·¥ä½œè¡¨çš„å½™ç¸½æª” (å« TTL æ¬„)", filetypes=[
        ("Excel files", "*.xlsx;*.xlsm")])
                if files:
                    self.monthamt_files_var.set(";".join(files))

            row_amt = ctk.CTkFrame(amt_frame, fg_color='transparent')
            row_amt.pack(fill='x', pady=6)
            ctk.CTkLabel(
    row_amt,
    text="é¸æ“‡å¤šå€‹ Excel æª”æ¡ˆ\nSelect multiple Excel files",
    font=FONT_MID).pack(
        side='left',
         padx=8)
            ctk.CTkEntry(
    row_amt,
    textvariable=self.monthamt_files_var,
    state='readonly').pack(
        side='left',
        fill='x',
        expand=True,
         padx=6)
            ctk.CTkButton(
    row_amt,
    text='ç€è¦½...\nBrowse...',
    command=pick_amt_files,
    corner_radius=8,
    hover_color="#1976d2").pack(
        side='left',
         padx=4)

            def parse_month_from_filename(path: str) -> str:
                """å¾æª”åæˆ–è·¯å¾‘è¾¨è­˜æœˆä»½ï¼Œæ”¯æ´ï¼š
                - Jan, January, Jul, July, Sep, Sept, September ç­‰
                - å¹´ä»½å¯ç‚º '24 æˆ– 2024ï¼›æ”¯æ´ ASCII ' èˆ‡ Unicode â€™
                - ä¹Ÿèƒ½åŒ¹é…åƒ "7. July 2025" é€™ç¨®æ ¼å¼
                å›å‚³ YYYY-MM æˆ– None
                """
                import os
                import re
                text = os.path.normpath(path)
                text = text.replace("\u2019", "'")  # å°‡ Unicode å³å¼•è™Ÿæ­£è¦åŒ–
                text_low = text.lower()
                # æœˆä»½å°ç…§
                month_names = {
                    'jan': 1, 'january': 1,
                    'feb': 2, 'february': 2,
                    'mar': 3, 'march': 3,
                    'apr': 4, 'april': 4,
                    'may': 5,
                    'jun': 6, 'june': 6,
                    'jul': 7, 'july': 7,
                    'aug': 8, 'august': 8,
                    'sep': 9, 'sept': 9, 'september': 9,
                    'oct': 10, 'october': 10,
                    'nov': 11, 'november': 11,
                    'dec': 12, 'december': 12,
                }
                # å»ºç«‹æœˆåæ­£å‰‡ï¼ˆé•·çŸ­çš†å¯ï¼‰
                month_regex = r"jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t|tember)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?"
                # å…ˆå˜—è©¦ï¼š<month> [' ]? <year>
                m = re.search(
                    rf"({month_regex})\s*[' ]?\s*(20\d{{2}}|\d{{2}})", text_low)
                if not m:
                    # æ¬¡è¦ï¼š<num>. <month> <year>
                    m = re.search(
    rf"\b\d{{1,2}}\.?\s*({month_regex})\s*(20\d{{2}}|\d{{2}})", text_low)
                if not m:
                    return None
                mon_key = m.group(1)
                yr = m.group(2)
                mm = month_names.get(mon_key, None)
                if not mm:
                    return None
                yy = int(yr)
                if yy < 100:
                    yy += 2000
                return f"{yy:04d}-{mm:02d}"

            def find_headers(ws):
                """åœ¨å‰å¹¾åè¡Œå°‹æ‰¾è¡¨é ­ï¼Œå›å‚³ (header_row_idx, col_outlet, col_ttl)
                æ›´å¯¬é¬†ï¼šæ”¯æ´ 'outlet'/'outlets'ï¼›'ttl' æˆ– 'total' çš†å¯ã€‚
                """
                max_r = min(40, ws.max_row)
                max_c = min(120, ws.max_column)
                # é€è¡Œæƒæï¼Œç•¶åŒä¸€è¡ŒåŒæ™‚å‡ºç¾ outlet èˆ‡ ttl/total æ‰åˆ¤å®šç‚ºè¡¨é ­
                for r in range(1, max_r + 1):
                    outlet_col = None
                    ttl_col = None
                    for cidx in range(1, max_c + 1):
                        val = ws.cell(row=r, column=cidx).value
                        if isinstance(val, str):
                            v = val.strip().lower()
                            if 'outlet' in v:
                                outlet_col = outlet_col or cidx
                            if v == 'ttl' or 'total' in v:
                                ttl_col = ttl_col or cidx
                    if outlet_col and ttl_col:
                        return r, outlet_col, ttl_col
                # è¡Œå…§æœªåŒæ™‚æ‰¾åˆ°ï¼Œå˜—è©¦å…¨è¡¨å…§é€å­—åŒ¹é…å„è‡ªæ¬„ä½
                outlet_pos = None
                ttl_pos = None
                for r in range(1, max_r + 1):
                    for cidx in range(1, max_c + 1):
                        val = ws.cell(row=r, column=cidx).value
                        if isinstance(val, str):
                            v = val.strip().lower()
                            if not outlet_pos and 'outlet' in v:
                                outlet_pos = (r, cidx)
                            if not ttl_pos and (v == 'ttl' or 'total' in v):
                                ttl_pos = (r, cidx)
                    if outlet_pos and ttl_pos:
                        # ä½¿ç”¨è¼ƒå¤§çš„ row ç•¶ header_row
                        header_row = max(outlet_pos[0], ttl_pos[0])
                        return header_row, outlet_pos[1], ttl_pos[1]
                return None, None, None

            def run_merge_amount():
                from tkinter import messagebox
                files = [
    f for f in self.monthamt_files_var.get().split(';') if f.strip()]
                if not files:
                    messagebox.showwarning('æª”æ¡ˆ', 'è«‹é¸æ“‡è¦æ•´åˆçš„ Excel æª”æ¡ˆ')
                    return
                os.makedirs(self.monthsum_output_var.get(), exist_ok=True)

                # çµæ§‹ï¼š {supplier: {outlet: {YYYY-MM: amount}}}
                sup_map = {}
                months_set = set()
                supplier_outlets = {}

                import openpyxl
                for fp in files:
                    ym = parse_month_from_filename(fp)
                    if not ym:
                        messagebox.showwarning('æª”å', f"ç„¡æ³•å¾æª”åè§£ææœˆä»½ï¼š\n{fp}")
                        continue
                    months_set.add(ym)
                    # å¯èƒ½æª”æ¡ˆè¢« Excel é–å®šï¼Œè¤‡è£½åˆ°æš«å­˜å†è®€
                    try:
                        wb = openpyxl.load_workbook(fp, data_only=True)
                        tmp_copied = None
                    except PermissionError:
                        import tempfile
                        import shutil
                        tmp = tempfile.NamedTemporaryFile(
                            delete=False, suffix='.xlsx')
                        tmp.close()
                        shutil.copyfile(fp, tmp.name)
                        wb = openpyxl.load_workbook(tmp.name, data_only=True)
                        tmp_copied = tmp.name
                    try:
                        for sheet in wb.sheetnames:
                            # å¸¸è¦‹éä¾›æ‡‰å•†å·¥ä½œè¡¨å¯æ’é™¤
                            if sheet.strip().lower() in ("data", "summary"):
                                continue
                            ws = wb[sheet]
                            header_row, col_outlet, col_ttl = find_headers(ws)
                            if not header_row:
                                continue
                            # åˆå§‹åŒ–ä¾›æ‡‰å•†ç¯€é»
                            sup_map.setdefault(sheet, {})
                            supplier_outlets.setdefault(sheet, set())
                            # æƒæè³‡æ–™åˆ—
                            for r in range(header_row + 1, ws.max_row + 1):
                                outlet = ws.cell(
    row=r, column=col_outlet).value
                                if not outlet:
                                    continue
                                outlet = str(outlet).strip()
                                supplier_outlets[sheet].add(outlet)
                                val = ws.cell(row=r, column=col_ttl).value
                                try:
                                    amt = float(val) if val not in (
                                        None, '') else 0.0
                                except Exception:
                                    amt = 0.0
                                if amt == 0:
                                    continue
                                sup_map[sheet].setdefault(outlet, {})
                                sup_map[sheet][outlet][ym] = sup_map[sheet][outlet].get(
                                    ym, 0.0) + amt
                    finally:
                        wb.close()
                        try:
                            if 'tmp_copied' in locals() and tmp_copied:
                                os.remove(tmp_copied)
                        except Exception:
                            pass

                # è¼¸å‡º
                months_sorted = sorted(months_set)
                out_file = os.path.join(
    self.monthsum_output_var.get(),
     'Monthly_Amount_BySupplier.xlsx')
                wb_out = openpyxl.Workbook()
                # é è¨­å»ºç«‹ Summaryï¼Œè‹¥å¾Œé¢æœ‰å»ºç«‹ä»»ä½•ä¾›æ‡‰å•†é å†ç§»é™¤
                ws_default = wb_out.active
                ws_default.title = 'Summary'
                from openpyxl.styles import PatternFill, Font, Alignment
                header_fill = PatternFill("solid", fgColor="BDD7EE")
                bold = Font(bold=True)
                center = Alignment(horizontal='center', vertical='center')

                # æ¯å€‹ä¾›æ‡‰å•†å»ºç«‹ä¸€é 
                created_any = False
                for supplier in sorted(sup_map.keys()):
                    ws = wb_out.create_sheet(supplier[:31])
                    ws.cell(row=1, column=1, value='Outlet').font = bold
                    ws.cell(row=1, column=1).fill = header_fill
                    for j, ym in enumerate(months_sorted, start=2):
                        ws.cell(row=1, column=j, value=ym).font = bold
                        ws.cell(row=1, column=j).alignment = center
                        ws.cell(row=1, column=j).fill = header_fill
                    outlets_sorted = sorted(
                        supplier_outlets.get(supplier, set()))
                    for i, outlet in enumerate(outlets_sorted, start=2):
                        ws.cell(row=i, column=1, value=outlet)
                        ym_map = sup_map[supplier].get(outlet, {})
                        for j, ym in enumerate(months_sorted, start=2):
                            val = ym_map.get(ym)
                            if val not in (None, 0):
                                ws.cell(row=i, column=j, value=val)
                    created_any = True

                # è‹¥æ²’æœ‰ä»»ä½•ä¾›æ‡‰å•†/è³‡æ–™ï¼Œä¿ç•™ Summary ä¸¦å¯«æ˜è¨Šæ¯ï¼›å¦å‰‡ç§»é™¤ Summary
                if created_any:
                    wb_out.remove(ws_default)
                else:
                    ws_default.cell(row=1, column=1, value='No data parsed')

                wb_out.save(out_file)
                messagebox.showinfo('å®Œæˆ', f'é‡‘é¡æ•´åˆå·²è¼¸å‡ºï¼š\n{out_file}')

            try:
                GlowButton(
    amt_frame,
    text='æ•´åˆé‡‘é¡ï¼ˆä»¥å» å•†ï¼‰\nMerge Amounts (by Supplier)',
    command=run_merge_amount,
    width=300,
    height=40,
    glow_color=(
        ACCENT_PURPLE if 'ACCENT_PURPLE' in globals() else ACCENT_BLUE),
        corner_radius=18).pack(
            pady=(
                6,
                 10))
            except Exception:
                ctk.CTkButton(
    amt_frame,
    text='æ•´åˆé‡‘é¡ï¼ˆä»¥å» å•†ï¼‰\nMerge Amounts (by Supplier)',
    fg_color=ACCENT_BLUE,
    command=run_merge_amount,
    height=36).pack(
        pady=(
            6,
             10))

        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®åŠŸèƒ½æ ‡é¢˜
        self.function_title.configure(
    text="ğŸ“Š æœˆçµæœˆåº¦å½™ç¸½\nMonth-end Monthly Order Summary")
        self.function_subtitle.configure(
    text="æ•´åˆå¤šå€‹æª”æ¡ˆï¼Œä¾å„æ—¥å¯¦éš›è¨‚è³¼æ—¥æœŸæ­¸å…¥å°æ‡‰ã€å¹´-æœˆã€\nMerge multiple files by actual order dates into Year-Month groups")

        # ç›´æ¥æ„å»ºæœˆç»“æœˆåº¦æ±‡æ€»ç•Œé¢
        build(self.content_body)

    def show_email_sending_ui(self):
        """æ˜¾ç¤ºé‚®ä»¶å‘é€ç•Œé¢"""
        def build(c):
            import os
            self.email_supplier_folder_var = ctk.StringVar()
            self.email_master_config_var = ctk.StringVar()

            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(c, fg_color="transparent")
            form_frame.pack(fill="both", expand=True, padx=30, pady=10)
            # ä¾›åº”å•†æ–‡ä»¶å¤¹
            row1 = ctk.CTkFrame(form_frame)
            row1.pack(fill="x", pady=8)
            ctk.CTkLabel(
    row1, text="ä¾›æ‡‰å•†æ–‡ä»¶å¤¾\nSupplier Folder:", font=(
        "Microsoft JhengHei", 12, "bold")).pack(
            side="left", padx=8)
            ctk.CTkEntry(
    row1,
    textvariable=self.email_supplier_folder_var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            email_browse_btn = ctk.CTkButton(
                row1,
                text="ç€è¦½...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_folder_var(
                    self.email_supplier_folder_var),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            email_browse_btn.pack(side="left", padx=5)
            # ç»Ÿä¸€é…ç½®æ–‡ä»¶
            row2 = ctk.CTkFrame(form_frame)
            row2.pack(fill="x", pady=8)
            ctk.CTkLabel(
    row2, text="çµ±ä¸€é…ç½®æ–‡ä»¶\nMaster Config (Excel):", font=(
        "Microsoft JhengHei", 12, "bold")).pack(
            side="left", padx=8)
            ctk.CTkEntry(
    row2,
    textvariable=self.email_master_config_var,
    font=FONT_MID,
    state="readonly",
    width=400).pack(
        side="left",
        expand=True,
        fill="x",
         padx=5)
            browse_btn_email_config = ctk.CTkButton(
                row2,
                text="ç€è¦½...\nBrowse...",
                font=("Microsoft YaHei", 11, "bold"),
                command=lambda: self._select_config_file(
    self.email_master_config_var, [
        ("Excel files", "*.xlsx")]),
                corner_radius=8,
                hover_color="#1976d2",
                height=30
            )
            browse_btn_email_config.pack(side="left", padx=5)
            # æ–°å¢ï¼šä¾›æ‡‰å•†é¸æ“‡å€åŸŸ
            supplier_frame = ctk.CTkFrame(form_frame)
            supplier_frame.pack(fill="x", pady=8)
            ctk.CTkLabel(
    supplier_frame,
    text="é¸æ“‡ä¾›æ‡‰å•†\nSelect Supplier:",
    font=(
        "Microsoft JhengHei",
        12,
        "bold")).pack(
            side="left",
             padx=8)
            self.supplier_combobox = ctk.CTkComboBox(
    supplier_frame, values=["è«‹å…ˆé¸æ“‡æ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶"], state="readonly", width=300)
            self.supplier_combobox.pack(side="left", padx=5)

            # ç¾åŒ–ï¼šè‡ªè¨‚ä¸»æ—¨/Custom Subject è¡Œ
            subject_option_frame = ctk.CTkFrame(
    form_frame, fg_color="#232e3c", corner_radius=14, height=48)
            subject_option_frame.pack(fill="x", pady=10, padx=2)
            subject_option_frame.pack_propagate(False)
            # å½©è‰²icon/æ¢
            accent = ctk.CTkLabel(subject_option_frame, text="â˜…", font=(
                "Segoe UI Emoji", 22), text_color="#38bdf8", width=32)
            accent.pack(side="left", padx=(12, 8), pady=0)
            self.use_custom_subject_var = ctk.BooleanVar(value=False)
            custom_subject_checkbox = ctk.CTkCheckBox(
                subject_option_frame,
                text="è‡ªè¨‚ä¸»æ—¨\nCustom Subject",
                variable=self.use_custom_subject_var,
                font=("Microsoft JhengHei", 14, "bold"),
                width=30,
                height=30,
                border_width=3,
                corner_radius=8,
                fg_color="#2563eb",
                hover_color="#1d4ed8",
                border_color="#60a5fa",
                text_color="#fff",
                checkbox_height=24,
                checkbox_width=24,
                command=lambda: self._toggle_subject_entry()
            )
            custom_subject_checkbox.pack(side="left", padx=(0, 18), pady=0)
            ctk.CTkLabel(
    subject_option_frame,
    text="éƒµä»¶ä¸»æ—¨\nEmail Subject:",
    font=(
        "Microsoft JhengHei",
        14,
        "bold"),
        text_color="#e0e7ef").pack(
            side="left",
            padx=(
                0,
                12),
                 pady=0)
            self.email_subject_var = ctk.StringVar()
            self.email_subject_entry = ctk.CTkEntry(
    subject_option_frame,
    textvariable=self.email_subject_var,
    font=(
        "Microsoft JhengHei",
        14),
        width=520,
        height=32,
        border_width=3,
        corner_radius=10,
        fg_color="#f1f5f9",
        text_color="#222",
        border_color="#38bdf8",
         state="disabled")
            self.email_subject_entry.pack(
    side="left", padx=(
        0, 18), fill="x", expand=True, pady=0)

            def _toggle_subject_entry(self=None):
                if self is None:
                    return
                if self.use_custom_subject_var.get():
                    self.email_subject_entry.configure(
    state="normal", fg_color="#fff", text_color="#222", border_color="#2563eb")
                else:
                    self.email_subject_entry.configure(
    state="disabled",
    fg_color="#f1f5f9",
    text_color="#222",
     border_color="#38bdf8")
            self._toggle_subject_entry = _toggle_subject_entry.__get__(self)

            # æ›´æ–°ä¾›æ‡‰å•†åˆ—è¡¨çš„å‡½æ•¸
            def update_supplier_list():
                folder = self.email_supplier_folder_var.get()
                master_config = self.email_master_config_var.get()
                if not folder or not master_config:
                    self.supplier_combobox.configure(values=["è«‹å…ˆé¸æ“‡æ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶"])
                    return

                try:
                    # è®€å–é…ç½®æ–‡ä»¶ä¸­çš„ä¾›æ‡‰å•†
                    wb = load_workbook(master_config, data_only=True)
                    supplier_dict = {}  # ä½¿ç”¨ dict ä¾†ä¿å­˜æ¯å€‹ä¾›æ‡‰å•†çš„ç¬¬ä¸€å€‹ email
                    if "Suppliers" in wb.sheetnames:
                        ws = wb["Suppliers"]
                        for row in ws.iter_rows(min_row=2, values_only=True):
                            if row and row[0]:
                                supplier = str(row[0]).strip()
                                if supplier not in supplier_dict:  # åªä¿å­˜æ¯å€‹ä¾›æ‡‰å•†çš„ç¬¬ä¸€å€‹ email
                                    supplier_dict[supplier] = str(
                                        row[2]).strip() if len(row) > 2 else ""
                    files = [f for f in os.listdir(folder) if f.endswith(
                        ".xlsx") and not f.startswith("~$")]
                    available_suppliers = []
                    for supplier in supplier_dict:
                        for file in files:
                            # åªè¦æª”åæœ‰å°æ‡‰å» å•†åç¨±ï¼ˆä¸é™å®š _Week_ï¼‰
                            if supplier in file and supplier not in available_suppliers:
                                available_suppliers.append(supplier)
                    if available_suppliers:
                        self.supplier_combobox.configure(
    values=sorted(available_suppliers))  # æ’åºé¡¯ç¤º
                        self.supplier_combobox.set(available_suppliers[0])
                    else:
                        self.supplier_combobox.configure(
                            values=["æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¾›æ‡‰å•†æ–‡ä»¶"])
                except Exception as e:
                    self.supplier_combobox.configure(values=[f"éŒ¯èª¤: {str(e)}"])

            # ç¶å®šæ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶è®Šæ›´äº‹ä»¶
            self.email_supplier_folder_var.trace(
    "w", lambda *args: update_supplier_list())
            self.email_master_config_var.trace(
    "w", lambda *args: update_supplier_list())

            # éƒµä»¶æ­£æ–‡bodyè¼¸å…¥æ¡†
            ctk.CTkLabel(
    form_frame,
    text="éƒµä»¶æ­£æ–‡/Email Body:",
    font=(
        "Microsoft JhengHei",
        12,
        "bold")).pack(
            anchor="w",
            padx=10,
            pady=(
                12,
                 0))
            self.email_body_textbox = ctk.CTkTextbox(
    form_frame, height=100, font=(
        "Microsoft JhengHei", 12), wrap="word")
            self.email_body_textbox.pack(fill="x", padx=10, pady=(0, 8))

            # æ¨¡æ¿æŒ‰éˆ•å€åŸŸ
            template_frame = ctk.CTkFrame(form_frame, fg_color="transparent")
            template_frame.pack(fill="x", padx=10, pady=(0, 8))

            # ä¸€èˆ¬è¨‚å–®æ¨¡æ¿æŒ‰éˆ•
            weekly_template_btn = ctk.CTkButton(
                template_frame,
                text="ä¸€èˆ¬è¨‚å–®æ¨¡æ¿\nWeekly Order Template",
                command=lambda: self._load_weekly_template(),
                fg_color="#2563eb",
                hover_color="#1d4ed8",
                font=("Microsoft YaHei", 11, "bold"),
                corner_radius=8,
                height=30
            )
            weekly_template_btn.pack(side="left", padx=(0, 8))

            # Amendment è¨‚å–®æ¨¡æ¿æŒ‰éˆ•
            amendment_template_btn = ctk.CTkButton(
                template_frame,
                text="Amendment æ¨¡æ¿\nAmendment Template",
                command=lambda: self._load_amendment_template(),
                fg_color="#dc2626",
                hover_color="#b91c1c",
                font=("Microsoft YaHei", 11, "bold"),
                corner_radius=8,
                height=30
            )
            amendment_template_btn.pack(side="left")

            # è¼‰å…¥æœ¬åœ°bodyé è¨­ - å„ªå…ˆè¼‰å…¥ weekly order æ¨¡æ¿
            default_body = "Hi Team,\n\n{month_week} order as attached.\n\nBest Regards,"

            # å„ªå…ˆå˜—è©¦è¼‰å…¥ weekly order æ¨¡æ¿
            weekly_template_path = "weekly_order_template.txt"
            legacy_body_path = "email_body.txt"  # ä¿æŒå‘å¾Œå…¼å®¹

            saved_body = None

            # é¦–å…ˆå˜—è©¦è¼‰å…¥ weekly order æ¨¡æ¿
            if os.path.exists(weekly_template_path):
                try:
                    with open(weekly_template_path, "r", encoding="utf-8") as f:
                        saved_body = f.read()
                except Exception:
                    pass

            # å¦‚æœæ²’æœ‰ weekly order æ¨¡æ¿ï¼Œå˜—è©¦è¼‰å…¥èˆŠçš„ email_body.txt
            if saved_body is None and os.path.exists(legacy_body_path):
                try:
                    with open(legacy_body_path, "r", encoding="utf-8") as f:
                        saved_body = f.read()
                except Exception:
                    pass

            # å¦‚æœæˆåŠŸè¼‰å…¥äº†æ¨¡æ¿ï¼Œæ›¿æ›è®Šæ•¸ä¸¦é¡¯ç¤º
            if saved_body is not None:
                try:
                    # æ›¿æ›æ¨¡æ¿ä¸­çš„è®Šæ•¸
                    from datetime import datetime, timedelta
                    now = datetime.now()
                    # è¨ˆç®—ä¸‹å‘¨çš„æ—¥æœŸ
                    days_until_next_monday = (7 - now.weekday()) % 7
                    if days_until_next_monday == 0:
                        days_until_next_monday = 7
                    next_monday = now + timedelta(days=days_until_next_monday)
                    month_name = next_monday.strftime("%B")
                    week_of_month = get_week_of_month(next_monday)
                    month_week = f"{month_name} - Week {week_of_month}"

                    # æ›¿æ›æ¨¡æ¿ä¸­çš„è®Šæ•¸
                    saved_body = saved_body.replace("{month_week}", month_week)

                    self.email_body_textbox.delete("1.0", "end")
                    self.email_body_textbox.insert("1.0", saved_body)
                except Exception:
                    # å¦‚æœæ›¿æ›è®Šæ•¸å¤±æ•—ï¼Œä½¿ç”¨é»˜èªæ¨¡æ¿
                    self.email_body_textbox.insert("1.0", default_body)
            else:
                # å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•æ¨¡æ¿æ–‡ä»¶ï¼Œä½¿ç”¨é»˜èªæ¨¡æ¿
                self.email_body_textbox.insert("1.0", default_body)
            # ä¿å­˜æŒ‰éˆ•åŠŸèƒ½

            def save_body():
                body = self.email_body_textbox.get("1.0", "end-1c")

                # å‰µå»ºä¿å­˜é¸é …å°è©±æ¡†
                save_dialog = ctk.CTkToplevel(self)
                save_dialog.title("ä¿å­˜éƒµä»¶æ¨¡æ¿ / Save Email Template")
                save_dialog.geometry("500x300")
                save_dialog.attributes('-topmost', True)
                save_dialog.resizable(False, False)

                # æ¨™é¡Œ
                ctk.CTkLabel(save_dialog,
                           text="é¸æ“‡è¦ä¿å­˜çš„æ¨¡æ¿é¡å‹\nSelect Template Type to Save",
                           font=("Microsoft YaHei", 16, "bold"),
                           text_color="#2563eb").pack(pady=20)

                # æŒ‰éˆ•æ¡†æ¶
                btn_frame = ctk.CTkFrame(save_dialog, fg_color="transparent")
                btn_frame.pack(pady=20, fill="x", padx=40)

                def save_weekly_template():
                    try:
                        with open("weekly_order_template.txt", "w", encoding="utf-8") as f:
                            f.write(body)
                        # å‰µå»ºç½®é ‚æˆåŠŸæç¤º
                        success_window = ctk.CTkToplevel()
                        success_window.title("ä¿å­˜æˆåŠŸ / Save Success")
                        success_window.geometry("400x150")
                        success_window.attributes('-topmost', True)
                        success_window.resizable(False, False)

                        ctk.CTkLabel(success_window,
                                   text="âœ… Weekly Order æ¨¡æ¿å·²ä¿å­˜ï¼\nâœ… Weekly Order template saved!",
                                   font=("Microsoft YaHei", 14, "bold"),
                                   text_color="#10b981").pack(pady=20)

                        def close_success():
                            success_window.destroy()
                            save_dialog.destroy()

                        ctk.CTkButton(success_window,
                                    text="ç¢ºå®š / OK",
                                    command=close_success,
                                    fg_color="#10b981",
                                    hover_color="#059669").pack(pady=10)

                        success_window.after(3000, close_success)

                    except Exception as e:
                        error_window = ctk.CTkToplevel()
                        error_window.title("ä¿å­˜å¤±æ•— / Save Failed")
                        error_window.geometry("400x150")
                        error_window.attributes('-topmost', True)
                        error_window.resizable(False, False)

                        ctk.CTkLabel(error_window,
                                   text=f"âŒ ä¿å­˜å¤±æ•—: {
    str(e)}\nâŒ Save failed: {
        str(e)}",
                                   font=("Microsoft YaHei", 12),
                                   text_color="#ef4444").pack(pady=20)

                        ctk.CTkButton(error_window,
                                    text="ç¢ºå®š / OK",
                                    command=error_window.destroy,
                                    fg_color="#ef4444").pack(pady=10)

                def save_amendment_template():
                    try:
                        with open("amendment_order_template.txt", "w", encoding="utf-8") as f:
                            f.write(body)
                        # å‰µå»ºç½®é ‚æˆåŠŸæç¤º
                        success_window = ctk.CTkToplevel()
                        success_window.title("ä¿å­˜æˆåŠŸ / Save Success")
                        success_window.geometry("400x150")
                        success_window.attributes('-topmost', True)
                        success_window.resizable(False, False)

                        ctk.CTkLabel(success_window,
                                   text="âœ… Amendment Order æ¨¡æ¿å·²ä¿å­˜ï¼\nâœ… Amendment Order template saved!",
                                   font=("Microsoft YaHei", 14, "bold"),
                                   text_color="#10b981").pack(pady=20)

                        def close_success():
                            success_window.destroy()
                            save_dialog.destroy()

                        ctk.CTkButton(success_window,
                                    text="ç¢ºå®š / OK",
                                    command=close_success,
                                    fg_color="#10b981",
                                    hover_color="#059669").pack(pady=10)

                        success_window.after(3000, close_success)

                    except Exception as e:
                        error_window = ctk.CTkToplevel()
                        error_window.title("ä¿å­˜å¤±æ•— / Save Failed")
                        error_window.geometry("400x150")
                        error_window.attributes('-topmost', True)
                        error_window.resizable(False, False)

                        ctk.CTkLabel(error_window,
                                   text=f"âŒ ä¿å­˜å¤±æ•—: {
    str(e)}\nâŒ Save failed: {
        str(e)}",
                                   font=("Microsoft YaHei", 12),
                                   text_color="#ef4444").pack(pady=20)

                        ctk.CTkButton(error_window,
                                    text="ç¢ºå®š / OK",
                                    command=error_window.destroy,
                                    fg_color="#ef4444").pack(pady=10)

                # Weekly Order ä¿å­˜æŒ‰éˆ•
                weekly_btn = ctk.CTkButton(
                    btn_frame,
                    text="ğŸ“§ ä¿å­˜ç‚º Weekly Order æ¨¡æ¿\nğŸ“§ Save as Weekly Order Template",
                    command=save_weekly_template,
                    fg_color="#2563eb",
                    hover_color="#1d4ed8",
                    font=("Microsoft YaHei", 12, "bold"),
                    height=60,
                    corner_radius=10
                )
                weekly_btn.pack(pady=10, fill="x")

                # Amendment Order ä¿å­˜æŒ‰éˆ•
                amendment_btn = ctk.CTkButton(
                    btn_frame,
                    text="ğŸ”„ ä¿å­˜ç‚º Amendment Order æ¨¡æ¿\nğŸ”„ Save as Amendment Order Template",
                    command=save_amendment_template,
                    fg_color="#dc2626",
                    hover_color="#b91c1c",
                    font=("Microsoft YaHei", 12, "bold"),
                    height=60,
                    corner_radius=10
                )
                amendment_btn.pack(pady=10, fill="x")

                # å–æ¶ˆæŒ‰éˆ•
                cancel_btn = ctk.CTkButton(
                    btn_frame,
                    text="å–æ¶ˆ / Cancel",
                    command=save_dialog.destroy,
                    fg_color="#6b7280",
                    hover_color="#4b5563",
                    font=("Microsoft YaHei", 12),
                    height=40,
                    corner_radius=10
                )
                cancel_btn.pack(pady=(20, 0), fill="x")

            # ç¾åŒ–çš„ä¿å­˜æŒ‰éˆ•
            save_btn = ctk.CTkButton(
                form_frame,
                text="ä¿å­˜éƒµä»¶æ¨¡æ¿/Save Email Template",
                command=save_body,
                fg_color=ACCENT_GREEN,
                hover_color=BTN_HOVER,
                font=("Microsoft YaHei", 11, "bold"),
                corner_radius=10,
                height=30
            )
            save_btn.pack(anchor="e", padx=10, pady=(0, 8))

            # é è¦½å’Œç™¼é€æŒ‰éˆ•
            btn_frame = ctk.CTkFrame(c, fg_color="transparent")
            btn_frame.pack(pady=15, fill="x", padx=20)
            btn_frame.grid_columnconfigure(0, weight=1)
            btn_frame.grid_columnconfigure(1, weight=1)
            # è®“æŒ‰éˆ•è‡ªé©æ‡‰å¯¬åº¦ï¼Œä¸¦åœ¨è¦–çª—çª„æ™‚è‡ªå‹•æ›è¡Œ
            send_btn = GlowButton(
                btn_frame,
                text="å–®ç¨ç™¼é€\nSend Individual",
                command=self._preview_supplier_email,
                width=200,
                height=40,
                glow_color=ACCENT_BLUE
            )
            send_btn.grid(row=0, column=0, padx=8, pady=3, sticky="ew")
            dir_btn = GlowButton(
                btn_frame,
                text="ç™¼é€ç›®éŒ„\nEmail Directory",
                command=self._show_email_directory,
                width=200,
                height=40,
                glow_color=ACCENT_RED
            )
            dir_btn.grid(row=0, column=1, padx=8, pady=3, sticky="ew")

            # ç¢ºä¿æŒ‰éˆ•åœ¨çª—å£ç¸®å°æ™‚ä¹Ÿèƒ½é¡¯ç¤º
            def on_configure(event):
                # ç•¶çª—å£å¤§å°æ”¹è®Šæ™‚ï¼Œç¢ºä¿æŒ‰éˆ•å¯è¦‹
                if event.width < 600:  # å¦‚æœçª—å£å¤ªçª„
                    send_btn.grid(row=0, column=0, padx=5, pady=3, sticky="ew")
                    dir_btn.grid(row=1, column=0, padx=5, pady=3, sticky="ew")
                else:
                    send_btn.grid(row=0, column=0, padx=8, pady=3, sticky="ew")
                    dir_btn.grid(row=0, column=1, padx=8, pady=3, sticky="ew")

            # ç¶å®šçª—å£å¤§å°æ”¹è®Šäº‹ä»¶
            c.bind("<Configure>", on_configure)

        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®åŠŸèƒ½æ ‡é¢˜
        self.function_title.configure(text=t("send_emails"))
        self.function_subtitle.configure(
    text="é€‰æ‹©ä¾›åº”å•†æ–‡ä»¶å¤¹å¹¶å‘é€é‚®ä»¶\nSelect supplier folder and send emails")

        # ç›´æ¥æ„å»ºé‚®ä»¶å‘é€ç•Œé¢
        build(self.content_body)

    def _load_weekly_template(self):
        """è¼‰å…¥ä¸€èˆ¬è¨‚å–®æ¨¡æ¿"""
        from datetime import datetime, timedelta
        now = datetime.now()

        # è¨ˆç®—ä¸‹å‘¨çš„æ—¥æœŸ
        # æ‰¾åˆ°ä¸‹é€±ä¸€ï¼šå¦‚æœä»Šå¤©æ˜¯é€±ä¸€ï¼Œä¸‹é€±ä¸€å°±æ˜¯ä»Šå¤©+7å¤©ï¼›å¦å‰‡æ‰¾åˆ°ä¸‹ä¸€å€‹é€±ä¸€
        days_until_next_monday = (7 - now.weekday()) % 7
        if days_until_next_monday == 0:
            days_until_next_monday = 7  # å¦‚æœä»Šå¤©æ˜¯é€±ä¸€ï¼Œä¸‹é€±ä¸€å°±æ˜¯7å¤©å¾Œ
        next_monday = now + timedelta(days=days_until_next_monday)

        # ä½¿ç”¨ä¸‹å‘¨ä¸€çš„æœˆä»½å’Œé€±æ•¸
        month_name = next_monday.strftime("%B")
        week_of_month = get_week_of_month(next_monday)

        # å˜—è©¦å¾ä¿å­˜çš„æ¨¡æ¿æ–‡ä»¶ä¸­è®€å–
        template_path = "weekly_order_template.txt"
        if os.path.exists(template_path):
            try:
                with open(template_path, "r", encoding="utf-8") as f:
                    weekly_template = f.read()
                # æ›¿æ›æ¨¡æ¿ä¸­çš„è®Šæ•¸
                month_week = f"{month_name} - Week {week_of_month}"
                weekly_template = weekly_template.replace(
                    "{month_week}", month_week)
            except Exception:
                # å¦‚æœè®€å–å¤±æ•—ï¼Œä½¿ç”¨é»˜èªæ¨¡æ¿
                weekly_template = f"Hi Team,\n\n{month_name} - Week {week_of_month} order as attached.\n\nBest Regards,"
        else:
            # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜èªæ¨¡æ¿
            weekly_template = f"Hi Team,\n\n{month_name} - Week {week_of_month} order as attached.\n\nBest Regards,"

        # æ›´æ–°éƒµä»¶æ­£æ–‡
        self.email_body_textbox.delete("1.0", "end")
        self.email_body_textbox.insert("1.0", weekly_template)

        # æ›´æ–°ä¸»æ—¨ï¼ˆå¦‚æœå•Ÿç”¨äº†è‡ªè¨‚ä¸»æ—¨ï¼‰
        if self.use_custom_subject_var.get():
            subject_template = f"Sushi Express Weekly Order - {{Supplier}} - {month_name} - Week {week_of_month}"
            self.email_subject_var.set(subject_template)

    def _load_amendment_template(self):
        """è¼‰å…¥ Amendment è¨‚å–®æ¨¡æ¿"""
        from datetime import datetime
        now = datetime.now()
        month_name = now.strftime("%B")
        week_of_month = get_week_of_month(now)

        # å˜—è©¦å¾ä¿å­˜çš„æ¨¡æ¿æ–‡ä»¶ä¸­è®€å–
        template_path = "amendment_order_template.txt"
        if os.path.exists(template_path):
            try:
                with open(template_path, "r", encoding="utf-8") as f:
                    amendment_template = f.read()
                # æ›¿æ›æ¨¡æ¿ä¸­çš„è®Šæ•¸ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                month_week = f"{month_name} - Week {week_of_month}"
                amendment_template = amendment_template.replace(
                    "{month_week}", month_week)
            except Exception:
                # å¦‚æœè®€å–å¤±æ•—ï¼Œä½¿ç”¨é»˜èªæ¨¡æ¿
                amendment_template = f"Hi Team,\n\nAmendment order as attached.\n\nBest Regards,"
        else:
            # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜èªæ¨¡æ¿
            amendment_template = f"Hi Team,\n\nAmendment order as attached.\n\nBest Regards,"

        # æ›´æ–°éƒµä»¶æ­£æ–‡
        self.email_body_textbox.delete("1.0", "end")
        self.email_body_textbox.insert("1.0", amendment_template)

        # æ›´æ–°ä¸»æ—¨ï¼ˆå¦‚æœå•Ÿç”¨äº†è‡ªè¨‚ä¸»æ—¨ï¼‰
        if self.use_custom_subject_var.get():
            subject_template = f"Sushi Express Amendment Order - {{Supplier}}"
            self.email_subject_var.set(subject_template)

    def _preview_supplier_email(self):
        """é è¦½é¸å®šä¾›æ‡‰å•†çš„éƒµä»¶å…§å®¹"""
        import os
        folder = self.email_supplier_folder_var.get()
        master_config = self.email_master_config_var.get()
        selected_supplier = self.supplier_combobox.get()

        if not folder or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return

        if not selected_supplier or selected_supplier in [
            "è«‹å…ˆé¸æ“‡æ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶", "æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¾›æ‡‰å•†æ–‡ä»¶"]:
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡ä¾›æ‡‰å•†")
            return

        files = [f for f in os.listdir(folder) if f.endswith(
            ".xlsx") and not f.startswith("~$")]
        
        # æŸ¥æ‰¾ä¾›åº”å•†çš„æ‰€æœ‰ç›¸å…³æ–‡ä»¶
        matched_files = find_all_supplier_files(selected_supplier, files)
        if not matched_files:
            messagebox.showerror("éŒ¯èª¤", f"æ‰¾ä¸åˆ° {selected_supplier} çš„å°æ‡‰æ–‡ä»¶")
            return
        
        # å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œä½¿ç”¨åŸæ¥çš„é€»è¾‘
        if len(matched_files) == 1:
            supplier_file = os.path.join(folder, matched_files[0])
            attachment_info = f"é™„ä»¶/Attachment: {matched_files[0]}"
        else:
            # å¤šä¸ªæ–‡ä»¶çš„æƒ…å†µ
            supplier_file = [os.path.join(folder, f) for f in matched_files]
            attachment_info = f"é™„ä»¶/Attachments ({len(matched_files)} å€‹):\n" + "\n".join([f"â€¢ {f}" for f in matched_files])

        # ç²å–éƒµä»¶å…§å®¹
        body = self.email_body_textbox.get("1.0", "end-1c")
        config_mgr = UnifiedConfigManager(master_config)
        email_sender = EmailSender(config_mgr)

        to_emails, cc_emails = email_sender.get_to_cc_emails(
            selected_supplier, master_config)
        from datetime import datetime, timedelta
        now = datetime.now()

        # è¨ˆç®—ä¸‹å‘¨çš„æ—¥æœŸ
        days_until_next_monday = (7 - now.weekday()) % 7
        if days_until_next_monday == 0:
            days_until_next_monday = 7
        next_monday = now + timedelta(days=days_until_next_monday)

        # ä½¿ç”¨ä¸‹å‘¨ä¸€çš„æœˆä»½å’Œé€±æ•¸
        month_name = next_monday.strftime("%B")
        week_of_month = get_week_of_month(next_monday)

        # è™•ç†éƒµä»¶æ­£æ–‡ä¸­çš„è®Šæ•¸æ›¿æ›
        body = body.replace("{month_week}",
     f"{month_name} - Week {week_of_month}")

        # è™•ç†ä¸»æ—¨
        subject = ""
        if self.use_custom_subject_var.get():
            custom_subject = self.email_subject_var.get().strip()
            if custom_subject:
                # æ›¿æ›ä¸»æ—¨ä¸­çš„è®Šæ•¸
                subject = custom_subject.replace(
    "{week_no}",
    str(week_of_month)).replace(
        "{Supplier}",
        selected_supplier).replace(
            "{Month}",
            month_name).replace(
                "{Week}",
                str(week_of_month)).replace(
                    "{month_week}",
                     f"{month_name} - Week {week_of_month}")
            else:
                subject = f"Sushi Express Weekly Order - {selected_supplier} - {month_name} - Week {week_of_month}"
        else:
            # æ ¹æ“š body å…§å®¹åˆ¤æ–·æ˜¯ Amendment é‚„æ˜¯ Weekly Order
            if "Amendment order" in body:
                subject = f"Sushi Express Amendment Order - {selected_supplier}"
            else:
                subject = f"Sushi Express Weekly Order - {selected_supplier} - {month_name} - Week {week_of_month}"

        self.email_subject_var.set(
    subject if self.use_custom_subject_var.get() else "")

        # å‰µå»ºé è¦½çª—å£
        preview_window = ctk.CTkToplevel(self)
        preview_window.title(f"éƒµä»¶é è¦½ - {selected_supplier}")
        preview_window.geometry("600x500")
        preview_window.resizable(True, True)
        preview_window.attributes('-topmost', True)  # è¨­ç½®è¦–çª—ç½®é ‚
        preview_window.focus_force()  # å¼·åˆ¶èšç„¦

        # éƒµä»¶ä¿¡æ¯
        info_frame = ctk.CTkFrame(preview_window)
        info_frame.pack(fill="x", padx=10, pady=10)

        ctk.CTkLabel(
    info_frame,
    text=f"ä¾›æ‡‰å•†/Supplier: {selected_supplier}",
    font=FONT_MID).pack(
        anchor="w",
        padx=10,
         pady=5)
        ctk.CTkLabel(
    info_frame,
    text=f"ä¸»æ—¨/Subject: {subject}",
    font=FONT_MID,
    wraplength=500).pack(
        anchor="w",
        padx=10,
         pady=5)

        # æ”¶ä»¶äººéƒµç®±é¡¯ç¤º
        to_emails_text = ", ".join(to_emails) if to_emails else "ç„¡"
        to_label = ctk.CTkLabel(
    info_frame,
    text=f"æ”¶ä»¶äºº/To: {to_emails_text}",
    font=FONT_MID,
     wraplength=500)
        to_label.pack(anchor="w", padx=10, pady=5)

        ctk.CTkLabel(
    info_frame,
    text=attachment_info,
    font=FONT_MID).pack(
        anchor="w",
        padx=10,
         pady=5)

        # éƒµä»¶æ­£æ–‡é è¦½ï¼ˆå¯ç·¨è¼¯ï¼‰
        ctk.CTkLabel(
    preview_window,
    text="éƒµä»¶æ­£æ–‡/Email Body (å¯ç·¨è¼¯):",
    font=FONT_MID).pack(
        anchor="w",
        padx=10,
        pady=(
            10,
             0))
        body_textbox = ctk.CTkTextbox(
    preview_window,
    height=200,
    font=FONT_MID,
     wrap="word")
        body_textbox.pack(fill="both", expand=True, padx=10, pady=10)
        body_textbox.insert("1.0", body)

        # æŒ‰éˆ•å€åŸŸ
        btn_frame = ctk.CTkFrame(preview_window)
        btn_frame.pack(fill="x", padx=10, pady=10)

        def send_this_email():
            # ç™¼é€é€™å°éƒµä»¶ï¼ˆä½¿ç”¨ç·¨è¼¯å¾Œçš„å…§å®¹ï¼‰
            edited_body = body_textbox.get("1.0", "end-1c")
            from datetime import datetime, timedelta
            now = datetime.now()

            # è¨ˆç®—ä¸‹å‘¨çš„æ—¥æœŸï¼ˆèˆ‡æ¨¡æ¿é‚è¼¯ä¸€è‡´ï¼‰
            days_until_next_monday = (7 - now.weekday()) % 7
            if days_until_next_monday == 0:
                days_until_next_monday = 7
            next_monday = now + timedelta(days=days_until_next_monday)

            # ä½¿ç”¨ä¸‹å‘¨ä¸€çš„æœˆä»½å’Œé€±æ•¸
            month_name = next_monday.strftime("%B")
            week_of_month = get_week_of_month(next_monday)
            month_week = f"{month_name} - Week {week_of_month}"

            # è™•ç†éƒµä»¶æ­£æ–‡ä¸­çš„è®Šæ•¸æ›¿æ›
            edited_body = edited_body.replace("{month_week}", month_week)

            # è™•ç†ä¸»æ—¨ä¸­çš„è®Šæ•¸æ›¿æ›
            final_subject = subject.replace(
    "{month_week}", month_week).replace(
        "{Supplier}", selected_supplier)

            mail = email_sender.send_email(
                to_emails, cc_emails, selected_supplier, edited_body,
                attachment_path=supplier_file,
                account_idx=self.selected_outlook_account_idx,
                subject=final_subject
            )
            if isinstance(mail, tuple):
                messagebox.showerror("Error", mail[1])
                return
            if not mail:
                messagebox.showerror("Error", f"æ— æ³•åˆ›å»ºé‚®ä»¶: {selected_supplier}")
                return
            # ç›´æ¥ç™¼é€ï¼Œä¸é¡¯ç¤º Outlook è¦–çª—
            try:
                mail.Send()
                show_topmost_success(
    self,
    "ç™¼é€æˆåŠŸ / Send Success",
     f"éƒµä»¶å·²ç›´æ¥ç™¼é€çµ¦ {selected_supplier}\nEmail sent successfully to {selected_supplier}")
                preview_window.destroy()
            except Exception as e:
                messagebox.showerror("ç™¼é€å¤±æ•—", f"ç™¼é€éƒµä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}")

        # ç¾åŒ–çš„ç™¼é€æŒ‰éˆ•
        send_btn = ctk.CTkButton(
            btn_frame,
            text="ç™¼é€æ­¤éƒµä»¶/Send This Email",
            command=send_this_email,
            fg_color=ACCENT_RED,
            font=("Microsoft YaHei", 12, "bold"),
            corner_radius=10,
            hover_color="#d32f2f",
            height=35
        )
        send_btn.pack(side="right", padx=5)

        # ç¾åŒ–çš„é—œé–‰æŒ‰éˆ•
        close_btn = ctk.CTkButton(
            btn_frame,
            text="é—œé–‰/Close",
            command=preview_window.destroy,
            font=("Microsoft YaHei", 12, "bold"),
            corner_radius=10,
            hover_color="#1976d2",
            height=35
        )
        close_btn.pack(side="right", padx=5)

    def _show_email_directory(self):
        """é¡¯ç¤ºéƒµä»¶ç™¼é€ç›®éŒ„"""
        import os

        folder = self.email_supplier_folder_var.get()
        master_config = self.email_master_config_var.get()

        if not folder or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return

        def destroy_window():
            """æ­£ç¢ºæ¸…ç†è¦–çª—åŠå…¶å­å…ƒä»¶"""
            try:
                # å…ˆæ¸…ç†æ‰€æœ‰è¡Œæ¡†æ¶
                for row_frame, _ in row_frames:
                    for widget in row_frame.winfo_children():
                        widget.destroy()
                    row_frame.destroy()
                row_frames.clear()

                # æ¸…ç†å…¶ä»–æ¡†æ¶å’Œå…ƒä»¶
                for widget in scroll_frame.winfo_children():
                    widget.destroy()
                scroll_frame.destroy()

                for widget in table_frame.winfo_children():
                    widget.destroy()
                table_frame.destroy()

                for widget in batch_frame.winfo_children():
                    widget.destroy()
                batch_frame.destroy()

                # æœ€å¾ŒéŠ·æ¯€è¦–çª—
                directory_window.destroy()
            except Exception as e:
                print(f"Error during window cleanup: {e}")
                # å¦‚æœæ¸…ç†éç¨‹å‡ºéŒ¯ï¼Œå¼·åˆ¶é—œé–‰è¦–çª—
                try:
                    directory_window.destroy()
                except:
                    pass

        # ç²å–æ‰€æœ‰å¯ç”¨çš„ä¾›æ‡‰å•†å’Œæ–‡ä»¶
        files = [f for f in os.listdir(folder) if f.endswith(
            ".xlsx") and not f.startswith("~$")]
        print(f"[DEBUG] æ‰¾åˆ°çš„ Excel æ–‡ä»¶: {files}")  # è°ƒè¯•ä¿¡æ¯
        master_config_path = self.email_master_config_var.get()
        config_mgr = UnifiedConfigManager(master_config_path)
        email_sender = EmailSender(config_mgr)

        # è®€å–é…ç½®æ–‡ä»¶ä¸­çš„ä¾›æ‡‰å•†ï¼Œä½¿ç”¨ dict ä¾†å»é‡è¤‡
        wb = load_workbook(master_config_path, data_only=True)
        supplier_dict = {}  # ä½¿ç”¨ dict ä¾†ä¿å­˜æ¯å€‹ä¾›æ‡‰å•†çš„ç¬¬ä¸€å€‹ email
        if "Suppliers" in wb.sheetnames:
            ws = wb["Suppliers"]
            seen_suppliers = set()  # ä½¿ç”¨ set ä¾†è¨˜éŒ„å·²è™•ç†çš„ä¾›æ‡‰å•†
            for row in ws.iter_rows(min_row=2, values_only=True):
                if row and row[0]:
                    supplier = str(row[0]).strip()
                    # æ ‡å‡†åŒ–ä¾›åº”å•†åç§°ï¼ˆå»é™¤å¤šä½™ç©ºæ ¼ï¼Œè½¬æ¢ä¸ºå°å†™è¿›è¡Œæ¯”è¾ƒï¼‰
                    supplier_normalized = supplier.lower().strip()
                    if supplier_normalized not in seen_suppliers:  # åªè™•ç†æ¯å€‹ä¾›æ‡‰å•†çš„ç¬¬ä¸€å€‹ email
                        seen_suppliers.add(supplier_normalized)
                        to_emails, cc_emails = email_sender.get_to_cc_emails(
                            supplier, master_config_path)
                        supplier_dict[supplier] = {
                            'to_emails': to_emails,
                            'cc_emails': cc_emails
                        }
                        print(f"[DEBUG] æ·»åŠ ä¾›åº”å•†: {supplier}")  # è°ƒè¯•ä¿¡æ¯
                    else:
                        print(f"[DEBUG] è·³è¿‡é‡å¤ä¾›åº”å•†: {supplier}")  # è°ƒè¯•ä¿¡æ¯

        # å‰µå»ºç›®éŒ„çª—å£
        directory_window = ctk.CTkToplevel(self)
        directory_window.title("éƒµä»¶ç™¼é€ç›®éŒ„ / Email Directory")
        directory_window.geometry("1200x800")  # åŠ å¤§è¦–çª—å°ºå¯¸
        directory_window.resizable(True, True)
        directory_window.attributes('-topmost', True)  # è¨­ç½®è¦–çª—ç½®é ‚
        directory_window.focus_force()  # å¼·åˆ¶èšç„¦

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
    directory_window,
    text="ä¾›æ‡‰å•†éƒµä»¶ç™¼é€ç›®éŒ„\nSupplier Email Directory",
     font=FONT_TITLE)
        title_label.pack(pady=10)

        # å‰µå»ºè¡¨æ ¼æ¡†æ¶
        table_frame = ctk.CTkFrame(directory_window)
        table_frame.pack(fill="both", expand=True, padx=20, pady=10)

        # è¡¨æ ¼æ¨™é¡Œï¼ˆå¢åŠ é–“è·å’ŒèƒŒæ™¯è‰²ï¼‰
        header_frame = ctk.CTkFrame(table_frame, fg_color=ACCENT_BLUE)
        header_frame.pack(fill="x", padx=10, pady=10)

        ctk.CTkLabel(
    header_frame,
    text="ä¾›æ‡‰å•†/Supplier",
    font=FONT_MID,
    width=150,
    text_color="#ffffff").pack(
        side="left",
         padx=5)
        ctk.CTkLabel(
    header_frame,
    text="æ”¶ä»¶äºº/To",
    font=FONT_MID,
    width=400,
    text_color="#ffffff").pack(
        side="left",
         padx=5)
        ctk.CTkLabel(
    header_frame,
    text="é™„ä»¶/Attachment",
    font=FONT_MID,
    width=250,
    text_color="#ffffff").pack(
        side="left",
         padx=5)
        ctk.CTkLabel(
    header_frame,
    text="æ“ä½œ/Action",
    font=FONT_MID,
    width=100,
    text_color="#ffffff").pack(
        side="left",
         padx=5)

        # æœå°‹æ¡†æ¶
        search_frame = ctk.CTkFrame(table_frame)
        search_frame.pack(fill="x", padx=10, pady=5)

        ctk.CTkLabel(
    search_frame,
    text="æœå°‹ä¾›æ‡‰å•† / Search Supplier:",
    font=FONT_MID).pack(
        side="left",
         padx=5)
        search_var = ctk.StringVar()
        search_entry = ctk.CTkEntry(
    search_frame, textvariable=search_var, width=300)
        search_entry.pack(side="left", padx=5)

        # æ»¾å‹•æ¡†æ¶
        scroll_frame = ctk.CTkScrollableFrame(table_frame)
        scroll_frame.pack(fill="both", expand=True, padx=10, pady=5)

        # å„²å­˜æ‰€æœ‰è¡Œæ¡†æ¶çš„å¼•ç”¨ï¼Œç”¨æ–¼æœå°‹éæ¿¾
        row_frames = []
        email_list = []
        supplier_check_vars = {}  # æ–°å¢ï¼šæ¯å€‹ä¾›æ‡‰å•†çš„å‹¾é¸ç‹€æ…‹
        sent_status = {}  # æ–°å¢ï¼šè¨˜éŒ„å·²ç™¼é€ç‹€æ…‹

        def filter_rows(*args):
            """æ ¹æ“šæœå°‹æ–‡å­—éæ¿¾è¡Œ"""
            search_text = search_var.get().lower()
            visible_count = 0
            for row_frame, supplier_name in row_frames:
                if search_text in supplier_name.lower():
                    row_frame.pack(fill="x", padx=5, pady=5)
                    visible_count += 1
                else:
                    row_frame.pack_forget()
            # æ›´æ–°ç¸½çµä¿¡æ¯
            summary_label.configure(
    text=f"ç¸½å…±æ‰¾åˆ° {supplier_count} å€‹ä¾›æ‡‰å•†ï¼Œé¡¯ç¤º {visible_count} å€‹")

        # ç¶å®šæœå°‹äº‹ä»¶
        search_var.trace("w", filter_rows)

        # ç¸½çµä¿¡æ¯æ¨™ç±¤ï¼ˆéœ€è¦åœ¨ filter_rows å‡½æ•¸ä¹‹å‰å®šç¾©ï¼‰
        summary_label = ctk.CTkLabel(
            directory_window, text=f"ç¸½å…±æ‰¾åˆ° 0 å€‹ä¾›æ‡‰å•†å¯ä»¥ç™¼é€éƒµä»¶", font=FONT_MID)
        summary_label.pack(pady=10)
        
        # åˆå§‹åŒ–ä¾›æ‡‰å•†è¨ˆæ•¸å™¨
        supplier_count = 0

        # åªè™•ç†æ¯å€‹ä¾›æ‡‰å•†ä¸€æ¬¡
        processed_suppliers = set()  # ä½¿ç”¨ set ä¾†è¨˜éŒ„å·²è™•ç†çš„ä¾›æ‡‰å•†
        print(f"[DEBUG] ä¾›æ‡‰å•†å­—å…¸: {list(supplier_dict.keys())}")  # è°ƒè¯•ä¿¡æ¯
        
        for supplier in supplier_dict:
            if supplier in processed_suppliers:
                continue
            processed_suppliers.add(supplier)

            # æŸ¥æ‰¾ä¾›åº”å•†çš„æ‰€æœ‰ç›¸å…³æ–‡ä»¶
            matched_files = find_all_supplier_files(supplier, files)
            print(f"[DEBUG] ä¾›æ‡‰å•† {supplier} æ‰¾åˆ°çš„æ–‡ä»¶: {matched_files}")  # è°ƒè¯•ä¿¡æ¯
            if matched_files:
                print(f"[DEBUG] ä¾›æ‡‰å•† {supplier} æœ‰åŒ¹é…æ–‡ä»¶ï¼Œé–‹å§‹å‰µå»º UI")  # è°ƒè¯•ä¿¡æ¯
                to_emails = supplier_dict[supplier]['to_emails']
                cc_emails = supplier_dict[supplier]['cc_emails']

                row_frame = ctk.CTkFrame(scroll_frame)
                row_frames.append((row_frame, supplier))
                row_frame.pack(fill="x", padx=5, pady=5)
                print(f"[DEBUG] ä¾›æ‡‰å•† {supplier} çš„ row_frame å·²å‰µå»ºä¸¦ pack")  # è°ƒè¯•ä¿¡æ¯

                var = ctk.BooleanVar(value=True)
                supplier_check_vars[supplier] = var
                check_btn = ctk.CTkCheckBox(
    row_frame, variable=var, text="", width=24)
                check_btn.pack(side="left", padx=5)
                supplier_label = ctk.CTkLabel(
    row_frame, text=supplier, font=FONT_MID, width=150)
                supplier_label.pack(side="left", padx=5)
                to_emails_text = ", ".join(to_emails) if to_emails else "ç„¡"
                to_label = ctk.CTkLabel(
    row_frame,
    text=to_emails_text,
    font=FONT_MID,
    width=400,
     wraplength=380)
                to_label.pack(side="left", padx=5)
                
                # æ˜¾ç¤ºé™„ä»¶ä¿¡æ¯
                if len(matched_files) == 1:
                    attachment_text = matched_files[0]
                else:
                    # æ˜¾ç¤ºå…·ä½“çš„æ–‡ä»¶ååˆ—è¡¨
                    attachment_text = f"{len(matched_files)} å€‹æ–‡ä»¶:\n" + "\n".join([f"â€¢ {f}" for f in matched_files])
                
                attachment_label = ctk.CTkLabel(
                    row_frame, text=attachment_text, font=FONT_MID, width=250, wraplength=200)
                attachment_label.pack(side="left", padx=5)
                status_label = ctk.CTkLabel(
    row_frame, text="", font=FONT_MID, width=40)
                status_label.pack(side="left", padx=5)
                sent_status[supplier] = status_label

                def create_send_function(supplier, to_emails, cc_emails, attachment_files):
                    def send_email():
                        body = self.email_body_textbox.get("1.0", "end-1c")
                        from datetime import datetime, timedelta
                        today = datetime.now().date()
                        this_monday = today - timedelta(days=today.weekday())
                        next_monday = this_monday + timedelta(days=7)
                        target_date = next_monday
                        month_name = target_date.strftime("%B")
                        week_of_month = get_week_of_month(target_date)
                        month_week = f"{month_name} - Week {week_of_month}"
                        body_filled = body.replace("{month_week}", month_week)

                        # è™•ç† subject - æª¢æŸ¥æ˜¯å¦ä½¿ç”¨è‡ªå®šç¾© subject
                        if self.use_custom_subject_var.get():
                            # ä½¿ç”¨è‡ªå®šç¾© subject
                            custom_subject = self.email_subject_var.get().strip()
                            if custom_subject:
                                # æ›¿æ›è‡ªå®šç¾© subject ä¸­çš„è®Šæ•¸
                                subject = custom_subject.replace(
    "{Supplier}",
    supplier).replace(
        "{Month}",
        month_name).replace(
            "{Week}",
            str(week_of_month)).replace(
                "{month_week}",
                 month_week)
                            else:
                                # å¦‚æœè‡ªå®šç¾© subject ç‚ºç©ºï¼Œä½¿ç”¨é è¨­ Weekly Order
                                subject = f"Sushi Express Weekly Order - {supplier} - {month_name} - Week {week_of_month}"
                        else:
                            # æ ¹æ“š body å…§å®¹åˆ¤æ–·æ˜¯ Amendment é‚„æ˜¯ Weekly Order
                            if "Amendment order" in body:
                                subject = f"Sushi Express Amendment Order - {supplier}"
                            else:
                                subject = f"Sushi Express Weekly Order - {supplier} - {month_name} - Week {week_of_month}"

                        # å‰µå»º EmailSender å¯¦ä¾‹
                        master_config_path = self.email_master_config_var.get()
                        config_mgr = UnifiedConfigManager(master_config_path)
                        email_sender = EmailSender(config_mgr)
                        
                        # è™•ç†å¤šå€‹é™„ä»¶æ–‡ä»¶
                        attachment_paths = [os.path.join(folder, f) for f in attachment_files]
                        mail = email_sender.send_email(
                            to_emails, cc_emails, supplier, body_filled,
                            attachment_path=attachment_paths[0] if len(attachment_paths) == 1 else attachment_paths,
                            account_idx=self.selected_outlook_account_idx,
                            subject=subject
                        )
                        if isinstance(mail, tuple):
                            # å‰µå»ºç½®é ‚çš„éŒ¯èª¤æç¤ºçª—å£
                            error_window = ctk.CTkToplevel()
                            error_window.title("éƒµä»¶å‰µå»ºå¤±æ•— / Mail Creation Failed")
                            error_window.geometry("400x150")
                            error_window.attributes('-topmost', True)  # ç½®é ‚é¡¯ç¤º
                            error_window.resizable(False, False)

                            # éŒ¯èª¤è¨Šæ¯
                            ctk.CTkLabel(error_window,
                                       text=f"âŒ éƒµä»¶å‰µå»ºå¤±æ•—: {
    mail[1]}\nâŒ Mail creation failed: {
        mail[1]}",
                                       font=("Microsoft YaHei", 12),
                                       text_color="#ef4444").pack(pady=20)

                            # ç¢ºå®šæŒ‰éˆ•
                            def close_error():
                                error_window.destroy()

                            ctk.CTkButton(error_window,
                                        text="ç¢ºå®š / OK",
                                        command=close_error,
                                        fg_color="#ef4444",
                                        hover_color="#dc2626",
                                        font=("Microsoft YaHei", 12, "bold")).pack(pady=10)

                            # å®‰å…¨æ›´æ–°ç‹€æ…‹æ¨™ç±¤
                            try:
                                status_label = sent_status.get(supplier)
                                if status_label and status_label.winfo_exists():
                                    status_label.configure(
                                        text="âœ—", text_color=ACCENT_RED)
                            except:
                                pass
                            return
                        if not mail:
                            # å‰µå»ºç½®é ‚çš„éŒ¯èª¤æç¤ºçª—å£
                            error_window = ctk.CTkToplevel()
                            error_window.title("éƒµä»¶å‰µå»ºå¤±æ•— / Mail Creation Failed")
                            error_window.geometry("400x150")
                            error_window.attributes('-topmost', True)  # ç½®é ‚é¡¯ç¤º
                            error_window.resizable(False, False)

                            # éŒ¯èª¤è¨Šæ¯
                            ctk.CTkLabel(error_window,
                                       text=f"âŒ ç„¡æ³•å‰µå»ºéƒµä»¶: {supplier}\nâŒ Cannot create mail: {supplier}",
                                       font=("Microsoft YaHei", 12),
                                       text_color="#ef4444").pack(pady=20)

                            # ç¢ºå®šæŒ‰éˆ•
                            def close_error():
                                error_window.destroy()

                            ctk.CTkButton(error_window,
                                        text="ç¢ºå®š / OK",
                                        command=close_error,
                                        fg_color="#ef4444",
                                        hover_color="#dc2626",
                                        font=("Microsoft YaHei", 12, "bold")).pack(pady=10)

                            # å®‰å…¨æ›´æ–°ç‹€æ…‹æ¨™ç±¤
                            try:
                                status_label = sent_status.get(supplier)
                                if status_label and status_label.winfo_exists():
                                    status_label.configure(
                                        text="âœ—", text_color=ACCENT_RED)
                            except:
                                pass
                            return
                        try:
                            mail.Send()
                            show_topmost_success(
    self,
    "ç™¼é€æˆåŠŸ / Send Success",
     f"éƒµä»¶å·²æˆåŠŸç™¼é€çµ¦ {supplier}\nEmail sent successfully to {supplier}")

                            # å®‰å…¨æ›´æ–°ç‹€æ…‹æ¨™ç±¤
                            try:
                                status_label = sent_status.get(supplier)
                                if status_label and status_label.winfo_exists():
                                    status_label.configure(
                                        text="âœ”", text_color=ACCENT_GREEN)
                            except:
                                pass

                            # è‡ªå‹•å–æ¶ˆå‹¾é¸
                            try:
                                if supplier in supplier_check_vars:
                                    supplier_check_vars[supplier].set(False)
                            except:
                                pass

                        except Exception as e:
                            # å‰µå»ºç½®é ‚çš„éŒ¯èª¤æç¤ºçª—å£
                            error_window = ctk.CTkToplevel()
                            error_window.title("ç™¼é€å¤±æ•— / Send Failed")
                            error_window.geometry("400x150")
                            error_window.attributes('-topmost', True)  # ç½®é ‚é¡¯ç¤º
                            error_window.resizable(False, False)

                            # éŒ¯èª¤è¨Šæ¯
                            ctk.CTkLabel(error_window,
                                       text=f"âŒ ç™¼é€å¤±æ•—: {
    str(e)}\nâŒ Send failed: {
        str(e)}",
                                       font=("Microsoft YaHei", 12),
                                       text_color="#ef4444").pack(pady=20)

                            # ç¢ºå®šæŒ‰éˆ•
                            def close_error():
                                error_window.destroy()

                            ctk.CTkButton(error_window,
                                        text="ç¢ºå®š / OK",
                                        command=close_error,
                                        fg_color="#ef4444",
                                        hover_color="#dc2626",
                                        font=("Microsoft YaHei", 12, "bold")).pack(pady=10)

                            status_label = sent_status.get(supplier)
                            if status_label:
                                status_label.configure(
                                    text="âœ—", text_color=ACCENT_RED)
                    return send_email

                # å‰µå»ºç™¼é€æŒ‰éˆ•
                print(f"[DEBUG] æ­£åœ¨ç‚º {supplier} å‰µå»ºç™¼é€æŒ‰éˆ•")  # è°ƒè¯•ä¿¡æ¯
                send_btn = ctk.CTkButton(
                    row_frame,
                    text="ç™¼é€/Send",
                    command=create_send_function(
                        supplier, to_emails, cc_emails, matched_files),
                    width=80,
                    height=30,
                    fg_color=ACCENT_RED,
                    font=("Microsoft YaHei", 11, "bold"),
                    corner_radius=8,
                    hover_color="#d32f2f"
                )
                send_btn.pack(side="right", padx=5)
                print(f"[DEBUG] {supplier} çš„ç™¼é€æŒ‰éˆ•å·²å‰µå»ºä¸¦ pack")  # è°ƒè¯•ä¿¡æ¯
                
                email_list.append({
                    'supplier': supplier,
                    'to_emails': to_emails,
                    'cc_emails': cc_emails,
                    'attachments': matched_files  # æ”¹ä¸ºå¤æ•°å½¢å¼
                })
                supplier_count += 1
                
                # å³æ™‚æ›´æ–°ç¸½çµä¿¡æ¯
                summary_label.configure(text=f"ç¸½å…±æ‰¾åˆ° {supplier_count} å€‹ä¾›æ‡‰å•†å¯ä»¥ç™¼é€éƒµä»¶")
        # æ‰¹é‡ç™¼é€æŒ‰éˆ•
        batch_frame = ctk.CTkFrame(directory_window)
        batch_frame.pack(fill="x", padx=20, pady=10)

        def batch_send_selected():
            import threading
            import time
            from tkinter import messagebox
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„ä¾›åº”å•†é€‰æ‹©
            selected_suppliers = [s for s, v in supplier_check_vars.items() if v.get()]
            if not selected_suppliers:
                messagebox.showwarning("æœªé¸æ“‡", "è«‹å…ˆå‹¾é¸è¦ç™¼é€çš„ä¾›æ‡‰å•†ï¼")
                return
            
            # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„ä¾›åº”å•†åç§°
            selected_suppliers_normalized = [s.lower().strip() for s in selected_suppliers]
            if len(selected_suppliers_normalized) != len(set(selected_suppliers_normalized)):
                messagebox.showwarning("é‡è¤‡é¸æ“‡", "æª¢æ¸¬åˆ°é‡è¤‡çš„ä¾›æ‡‰å•†é¸æ“‡ï¼Œè«‹æª¢æŸ¥å¾Œé‡æ–°é¸æ“‡ï¼")
                return
            
            # æ˜¾ç¤ºç¾åŒ–çš„ç¡®è®¤å¯¹è¯æ¡†
            def on_confirm_dialog(result):
                if not result:
                    return
                # ç»§ç»­æ‰§è¡Œé‚®ä»¶å‘é€é€»è¾‘
                self._send_emails_to_suppliers(selected_suppliers, directory_window, sent_status, email_list)
            
            # åˆ›å»ºå¹¶æ˜¾ç¤ºç¾åŒ–çš„ç¡®è®¤å¯¹è¯æ¡†
            confirm_dialog = EmailSendConfirmationDialog(
                directory_window, 
                selected_suppliers, 
                on_confirm_dialog
            )
            return
        
        # æ–°å¢ã€Œç™¼é€å‹¾é¸ã€æŒ‰éˆ•
        send_selected_btn = ctk.CTkButton(
            batch_frame,
            text="ç™¼é€å‹¾é¸éƒµä»¶\nSend Selected",
            command=batch_send_selected,
            width=200,
            height=50,
            fg_color=ACCENT_GREEN,
            font=("Microsoft YaHei", 12, "bold"),
            corner_radius=10,
            hover_color="#059669"
        )
        send_selected_btn.pack(side="right", padx=10)
    
    def _send_emails_to_suppliers(self, selected_suppliers, directory_window, sent_status=None, email_list=None):
        """å‘é€é‚®ä»¶ç»™é€‰ä¸­çš„ä¾›åº”å•†"""
        import threading
        import time
        from tkinter import messagebox
        
        folder = self.email_supplier_folder_var.get()
        master_config = self.email_master_config_var.get()
        
        if not folder or not master_config:
            messagebox.showwarning("æœªé¸æ“‡", "è«‹å…ˆé¸æ“‡ä¾›æ‡‰å•†æ–‡ä»¶å¤¾å’Œä¸»é…ç½®æ–‡ä»¶ï¼")
            return
        
        # å¦‚æœæ²’æœ‰å‚³å…¥ email_listï¼Œå‰‡é‡æ–°ç”Ÿæˆï¼ˆå‘å¾Œå…¼å®¹ï¼‰
        if email_list is None:
            email_list = []
            # å‰µå»º EmailSender å¯¦ä¾‹
            config_mgr = UnifiedConfigManager(master_config)
            email_sender = EmailSender(config_mgr)
            
            # æ‰«ææ–‡ä»¶å¤¹è·å–é‚®ä»¶åˆ—è¡¨
            for file in os.listdir(folder):
                if file.endswith('.xlsx') and not file.startswith('~'):
                    supplier_name = file.replace('.xlsx', '')
                    to_emails, cc_emails = email_sender.get_to_cc_emails(supplier_name, master_config)
                    if to_emails:
                        email_list.append({
                            'supplier': supplier_name,
                            'to_emails': to_emails,
                            'cc_emails': cc_emails,
                            'attachments': [file]
                        })
        
        # å½ˆå‡ºé€²åº¦è¦–çª—
        progress_win = ctk.CTkToplevel(directory_window)
        progress_win.title("éƒµä»¶ç™¼é€é€²åº¦/Email Send Progress")
        progress_win.geometry("600x600")
        progress_win.attributes('-topmost', True)  # è¨­ç½®ç½®é ‚
        progress_win.resizable(True, True)
        # ç§»é™¤ focus_force() é¿å… TclError
        ctk.CTkLabel(
            progress_win,
            text="éƒµä»¶ç™¼é€é€²åº¦",
            font=FONT_TITLE
        ).pack(pady=10)
        
        progress_frame = ctk.CTkScrollableFrame(progress_win)
        progress_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        progress_labels = {}
        for supplier in selected_suppliers:
            lbl = ctk.CTkLabel(
                progress_frame,
                text=f"{supplier} ...",
                font=FONT_MID
            )
            lbl.pack(anchor="w", pady=2)
            progress_labels[supplier] = lbl

        def send_all():
            success_suppliers = []
            failed_suppliers = []
            
            print(f"[DEBUG] é–‹å§‹ç™¼é€éƒµä»¶ï¼Œé¸ä¸­çš„ä¾›æ‡‰å•†: {selected_suppliers}")
            print(f"[DEBUG] å¯ç”¨çš„éƒµä»¶åˆ—è¡¨: {[e['supplier'] for e in email_list]}")

            for idx, supplier in enumerate(selected_suppliers):
                print(f"[DEBUG] è™•ç†ä¾›æ‡‰å•†: {supplier}")
                entry = next(
                    (e for e in email_list if e['supplier'] == supplier), None
                )
                if not entry:
                    print(f"[DEBUG] æ‰¾ä¸åˆ°ä¾›æ‡‰å•† {supplier} çš„éƒµä»¶è³‡æ–™")
                    progress_labels[supplier].configure(
                        text=f"{supplier} - æª”æ¡ˆ/éƒµä»¶è³‡æ–™ç¼ºå¤±", 
                        text_color=ACCENT_RED
                    )
                    failed_suppliers.append(f"{supplier} - æª”æ¡ˆ/éƒµä»¶è³‡æ–™ç¼ºå¤±")
                    continue
                
                print(f"[DEBUG] æ‰¾åˆ°ä¾›æ‡‰å•† {supplier} çš„éƒµä»¶è³‡æ–™: {entry}")
                try:
                    body = self.email_body_textbox.get("1.0", "end-1c")
                    from datetime import datetime, timedelta
                    today = datetime.now().date()
                    this_monday = today - timedelta(days=today.weekday())
                    next_monday = this_monday + timedelta(days=7)
                    target_date = next_monday
                    month_name = target_date.strftime("%B")
                    week_of_month = get_week_of_month(target_date)
                    month_week = f"{month_name} - Week {week_of_month}"
                    body_filled = body.replace("{month_week}", month_week)

                    # è™•ç† subject - æª¢æŸ¥æ˜¯å¦ä½¿ç”¨è‡ªå®šç¾© subject
                    if self.use_custom_subject_var.get():
                        # ä½¿ç”¨è‡ªå®šç¾© subject
                        custom_subject = self.email_subject_var.get().strip()
                        if custom_subject:
                            # æ›¿æ›è‡ªå®šç¾© subject ä¸­çš„è®Šæ•¸
                            subject = custom_subject.replace(
                                "{Supplier}",
                                supplier
                            ).replace(
                                "{Month}",
                                month_name
                            ).replace(
                                "{Week}",
                                str(week_of_month)
                            ).replace(
                                "{month_week}",
                                month_week
                            )
                        else:
                            # å¦‚æœè‡ªå®šç¾© subject ç‚ºç©ºï¼Œä½¿ç”¨é è¨­ Weekly Order
                            subject = f"Sushi Express Weekly Order - {supplier} - {month_name} - Week {week_of_month}"
                    else:
                        # æ ¹æ“š body å…§å®¹åˆ¤æ–·æ˜¯ Amendment é‚„æ˜¯ Weekly Order
                        if "Amendment order" in body:
                            subject = f"Sushi Express Amendment Order - {supplier}"
                        else:
                            subject = f"Sushi Express Weekly Order - {supplier} - {month_name} - Week {week_of_month}"
                    
                    # å‰µå»º EmailSender å¯¦ä¾‹
                    master_config_path = self.email_master_config_var.get()
                    config_mgr = UnifiedConfigManager(master_config_path)
                    email_sender = EmailSender(config_mgr)
                    
                    # å¤„ç†é™„ä»¶è·¯å¾„
                    if len(entry['attachments']) == 1:
                        # å•ä¸ªæ–‡ä»¶
                        attachment_path = os.path.join(folder, entry['attachments'][0])
                    else:
                        # å¤šä¸ªæ–‡ä»¶
                        attachment_path = [os.path.join(folder, f) for f in entry['attachments']]
                    
                    mail = email_sender.send_email(
                        entry['to_emails'], entry['cc_emails'], supplier, body_filled,
                        attachment_path=attachment_path,
                        account_idx=self.selected_outlook_account_idx,
                        subject=subject
                    )
                    if isinstance(mail, tuple) or not mail:
                        error_msg = mail[1] if isinstance(
                            mail, tuple) else "ç™¼é€å¤±æ•—"
                        progress_labels[supplier].configure(
                            text=f"{supplier} âœ— {error_msg}", 
                            text_color=ACCENT_RED
                        )
                        if sent_status and supplier in sent_status:
                            sent_status[supplier].configure(
                                text="âœ—", 
                                text_color=ACCENT_RED
                            )
                        failed_suppliers.append(
                            f"{supplier} - {error_msg}"
                        )
                        continue
                    try:
                        # æ£€æŸ¥æ˜¯å¦å·²ç»å‘é€è¿‡
                        if supplier in success_suppliers:
                            progress_labels[supplier].configure(
                                text=f"{supplier} âš ï¸ å·²ç™¼é€éï¼Œè·³é", 
                                text_color=ACCENT_ORANGE
                            )
                            continue
                        
                        mail.Send()
                        progress_labels[supplier].configure(
                            text=f"{supplier} âœ” å·²ç™¼é€", 
                            text_color=ACCENT_GREEN
                        )
                        if sent_status and supplier in sent_status:
                            sent_status[supplier].configure(
                                text="âœ”", 
                                text_color=ACCENT_GREEN
                            )
                        success_suppliers.append(supplier)
                    except Exception as e:
                        progress_labels[supplier].configure(
                            text=f"{supplier} âœ— {str(e)}", 
                            text_color=ACCENT_RED
                        )
                        if sent_status and supplier in sent_status:
                            sent_status[supplier].configure(
                                text="âœ—", 
                                text_color=ACCENT_RED
                            )
                        failed_suppliers.append(f"{supplier} - {str(e)}")
                except Exception as e:
                    progress_labels[supplier].configure(
                        text=f"{supplier} âœ— {str(e)}", 
                        text_color=ACCENT_RED
                    )
                    if sent_status and supplier in sent_status:
                        sent_status[supplier].configure(
                            text="âœ—", 
                            text_color=ACCENT_RED
                        )
                    failed_suppliers.append(f"{supplier} - {str(e)}")
                time.sleep(2)  # ç·©è¡ 2 ç§’

            # ç™¼é€å®Œæˆå¾Œé¡¯ç¤ºçµæœä¸¦è‡ªå‹•é—œé–‰
            def show_result_and_close():
                # æ¸…ç©ºé€²åº¦æ¨™ç±¤ï¼Œé¡¯ç¤ºçµæœæ‘˜è¦
                for supplier in selected_suppliers:
                    progress_labels[supplier].pack_forget()

                # é¡¯ç¤ºçµæœæ‘˜è¦
                ctk.CTkLabel(
                    progress_frame,
                    text="ğŸ“§ ç™¼é€å®Œæˆï¼",
                    font=FONT_TITLE,
                    text_color=ACCENT_GREEN
                ).pack(pady=10)

                if success_suppliers:
                    success_text = f"âœ… æˆåŠŸç™¼é€ ({len(success_suppliers)} å€‹):\n" + "\n".join(
                        [f"â€¢ {s}" for s in success_suppliers]
                    )
                    ctk.CTkLabel(
                        progress_frame,
                        text=success_text,
                        font=FONT_MID,
                        text_color=ACCENT_GREEN
                    ).pack(pady=5)

                if failed_suppliers:
                    failed_text = f"âŒ ç™¼é€å¤±æ•— ({len(failed_suppliers)} å€‹):\n" + "\n".join(
                        [f"â€¢ {s}" for s in failed_suppliers]
                    )
                    ctk.CTkLabel(
                        progress_frame,
                        text=failed_text,
                        font=FONT_MID,
                        text_color=ACCENT_RED
                    ).pack(pady=5)

                # 5ç§’å¾Œè‡ªå‹•é—œé–‰
                def safe_destroy():
                    try:
                        if progress_win.winfo_exists():
                            progress_win.destroy()
                    except:
                        pass
                progress_win.after(5000, safe_destroy)

            # åœ¨ä¸»ç·šç¨‹ä¸­åŸ·è¡ŒUIæ›´æ–°
            progress_win.after(0, show_result_and_close)

        threading.Thread(target=send_all).start()

    def _show_batch_result(
    self,
    success_count,
    failed_count,
     failed_suppliers):
        """é¡¯ç¤ºæ‰¹é‡ç™¼é€çµæœ"""
        from tkinter import messagebox

        result_window = ctk.CTkToplevel(self)
        result_window.title("æ‰¹é‡ç™¼é€çµæœ / Batch Send Result")
        result_window.geometry("500x400")
        result_window.resizable(True, True)
        result_window.attributes('-topmost', True)  # è¨­ç½®è¦–çª—ç½®é ‚
        result_window.focus_force()  # å¼·åˆ¶èšç„¦

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
    result_window,
    text="æ‰¹é‡ç™¼é€çµæœ\nBatch Send Result",
     font=FONT_TITLE)
        title_label.pack(pady=10)

        # çµæœæ‘˜è¦
        summary_frame = ctk.CTkFrame(result_window)
        summary_frame.pack(fill="x", padx=20, pady=10)

        ctk.CTkLabel(summary_frame, text=f"æˆåŠŸç™¼é€: {success_count} å€‹ä¾›æ‡‰å•†",
                    font=FONT_MID, text_color=ACCENT_GREEN).pack(anchor="w", padx=10, pady=5)
        ctk.CTkLabel(summary_frame, text=f"ç™¼é€å¤±æ•—: {failed_count} å€‹ä¾›æ‡‰å•†",
                    font=FONT_MID, text_color=ACCENT_RED).pack(anchor="w", padx=10, pady=5)

        # å¤±æ•—è©³æƒ…
        if failed_suppliers:
            ctk.CTkLabel(
    result_window,
    text="å¤±æ•—è©³æƒ… / Failed Details:",
    font=FONT_MID).pack(
        anchor="w",
        padx=20,
        pady=(
            10,
             0))

            # æ»¾å‹•æ¡†æ¶é¡¯ç¤ºå¤±æ•—è©³æƒ…
            scroll_frame = ctk.CTkScrollableFrame(result_window)
            scroll_frame.pack(fill="both", expand=True, padx=20, pady=10)

            for supplier in failed_suppliers:
                ctk.CTkLabel(scroll_frame, text=f"â€¢ {supplier}",
                            font=FONT_MID, text_color=ACCENT_RED).pack(anchor="w", padx=10, pady=2)

        # ç¾åŒ–çš„é—œé–‰æŒ‰éˆ•
        close_btn = ctk.CTkButton(
            result_window,
            text="é—œé–‰/Close",
            command=result_window.destroy,
            font=("Microsoft YaHei", 12, "bold"),
            corner_radius=10,
            hover_color="#1976d2",
            height=35
        )
        close_btn.pack(pady=10)

    def _send_supplier_emails(self):
        import os
        folder = self.email_supplier_folder_var.get()
        master_config = self.email_master_config_var.get()
        if not folder or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
        # é¸æ“‡Outlookå¸³è™Ÿï¼ˆåªé¸ä¸€æ¬¡ï¼‰
        if self.selected_outlook_account_idx is None:
            try:
                import win32com.client
                import pythoncom

                # åˆå§‹åŒ– COM çµ„ä»¶
                pythoncom.CoInitialize()

                outlook = win32com.client.Dispatch(
                    "Outlook.Application").GetNamespace("MAPI")
                accounts = [
    outlook.Folders.Item(
        i +
        1) for i in range(
            outlook.Folders.Count)]
                account_names = [acct.Name for acct in accounts]
                # ä½¿ç”¨ç¾åŒ–çš„å¸³è™Ÿé¸æ“‡å°è©±æ¡†
                idx = show_outlook_account_selector(self, account_names)
                if idx is None:
                    messagebox.showwarning(
    "å–æ¶ˆ/Cancelled", "æœªé¸æ“‡å¸³è™Ÿï¼Œå·²å–æ¶ˆç™¼é€/No account selected, sending cancelled.")
                    return
                self.selected_outlook_account_idx = idx
            except Exception as e:
                messagebox.showerror(
    "éŒ¯èª¤/Error", f"ç²å–Outlookå¸³è™Ÿå¤±æ•—/Failed to get Outlook accounts: {e}")
            return
        # å–å¾—bodyå…§å®¹ï¼Œä¸¦ä¿å­˜åˆ°æœ¬åœ°
        body = self.email_body_textbox.get("1.0", "end-1c")
        try:
            with open("email_body.txt", "w", encoding="utf-8") as f:
                f.write(body)
        except Exception:
            pass
        # æª¢æŸ¥æ˜¯å¦æœ‰é¸å®šçš„ä¾›æ‡‰å•†
        selected_supplier = getattr(self, 'supplier_combobox', None)
        if selected_supplier:
            selected_supplier_name = selected_supplier.get()
            if selected_supplier_name and selected_supplier_name not in [
                "è«‹å…ˆé¸æ“‡æ–‡ä»¶å¤¾å’Œé…ç½®æ–‡ä»¶", "æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¾›æ‡‰å•†æ–‡ä»¶"]:
                files = [f for f in os.listdir(folder) if f.endswith(
                    ".xlsx") and not f.startswith("~$")]
                config_mgr = UnifiedConfigManager(master_config)
                email_sender = EmailSender(config_mgr)
                matched_file = find_supplier_file(
                    selected_supplier_name, files)
                if not matched_file:
                    messagebox.showerror(
    "éŒ¯èª¤", f"æ‰¾ä¸åˆ° {selected_supplier_name} çš„å°æ‡‰æ–‡ä»¶")
                    return
                supplier_file = os.path.join(folder, matched_file)
                to_emails, cc_emails = email_sender.get_to_cc_emails(
                    selected_supplier_name, master_config)
                from datetime import datetime
                now = datetime.now()
                week_no = now.isocalendar()[1]
                body_filled = body.replace("{week_no}", str(week_no))
                subject = f"Sushi Express Weekly Order - {selected_supplier_name} - {
    now.strftime('%B')} - Week {week_no}"
                mail = email_sender.send_email(
                    to_emails, cc_emails, selected_supplier_name, body_filled,
                    attachment_path=supplier_file,
                    account_idx=self.selected_outlook_account_idx,
                    subject=subject
                )
                if isinstance(mail, tuple):
                    messagebox.showerror("Error", mail[1])
                    return
                if not mail:
                    messagebox.showerror(
    "Error", f"æ— æ³•åˆ›å»ºé‚®ä»¶: {selected_supplier_name}")
                    return
                show_topmost_success(
    self,
    "ç™¼é€æˆåŠŸ / Send Success",
     f"éƒµä»¶å·²ç™¼é€çµ¦ {selected_supplier_name}\nEmail sent successfully to {selected_supplier_name}")
                return

        # å¦‚æœæ²’æœ‰é¸å®šä¾›æ‡‰å•†ï¼Œå‰‡ç™¼é€çµ¦æ‰€æœ‰ä¾›æ‡‰å•†ï¼ˆåŸæœ‰é‚è¼¯ï¼‰
        files = [f for f in os.listdir(folder) if f.endswith(
            ".xlsx") and not f.startswith("~$")]
        config_mgr = UnifiedConfigManager(master_config)
        email_sender = EmailSender(config_mgr)
        supplier_names = set()
        wb = load_workbook(master_config, data_only=True)
        if "Suppliers" in wb.sheetnames:
            ws = wb["Suppliers"]
            for row in ws.iter_rows(min_row=2, values_only=True):
                if row and row[0]:
                    supplier_names.add(str(row[0]).strip())
        from datetime import datetime
        email_list = []
        matched_files = set()
        for sname in supplier_names:
            matched_file = find_supplier_file(sname, files)
            if not matched_file:
                continue
            matched_files.add(matched_file)
            supplier_file = os.path.join(folder, matched_file)
            to_emails, cc_emails = email_sender.get_to_cc_emails(
                sname, master_config)
            now = datetime.now()
            week_no = now.isocalendar()[1]
            body_filled = body.replace("{week_no}", str(week_no))
            subject = f"Sushi Express Weekly Order - {sname} - {
    now.strftime('%B')} - Week {week_no}"
            mail = email_sender.send_email(
                to_emails, cc_emails, sname, body_filled,
                attachment_path=supplier_file,
                account_idx=self.selected_outlook_account_idx,
                subject=subject
            )
            if isinstance(mail, tuple):
                messagebox.showerror("Error", mail[1])
                continue
            if not mail:
                messagebox.showerror("Error", f"æ— æ³•åˆ›å»ºé‚®ä»¶: {sname}")
                continue
            email_list.append((mail, sname, supplier_file))
        unmatched_files = [f for f in files if f not in matched_files]
        if unmatched_files:
            messagebox.showwarning(
    "æœªé…å°æª”æ¡ˆ",
    f"ä»¥ä¸‹æª”æ¡ˆæœªé…å°åˆ°ä»»ä½•Supplierï¼Œæœªç™¼é€éƒµä»¶ï¼š\n" +
     "\n".join(unmatched_files))
        for mail, matched_supplier, supplier_file in email_list:
            def on_confirm(success, msg, ms=matched_supplier):
                if success:
                    show_topmost_success(
    self,
    "ç™¼é€æˆåŠŸ / Send Success",
     f"{ms} éƒµä»¶å·²ç™¼é€ï¼\n{ms} Email sent successfully!")
                else:
                    messagebox.showinfo("å·²å–æ¶ˆ/Cancelled", f"{ms} éƒµä»¶æœªç™¼é€ã€‚")
            EmailConfirmationDialog(
    self,
    mail,
    matched_supplier,
    "-",
    supplier_file,
     on_confirm)

    def show_operation_supplies_ui(self):
        """æ˜¾ç¤ºè¿è¥ç”¨å“ç•Œé¢ - ç¾åŒ–ç‰ˆæœ¬"""
        def build(c):
            self.summary_file_var = ctk.StringVar()
            self.config_file_var = ctk.StringVar()
            self.output_folder_var = ctk.StringVar()

            # ä¸»å®¹å™¨ - ç´§å‡‘å¸ƒå±€
            main_container = ctk.CTkFrame(c, fg_color="transparent")
            main_container.pack(fill="both", expand=True, padx=15, pady=10)
            
            # æ–‡ä»¶é€‰æ‹©å¡ç‰‡
            file_card = ctk.CTkFrame(main_container, fg_color=DARK_PANEL, corner_radius=15)
            file_card.pack(fill="x", pady=(0, 15))

            # åˆ›å»ºè¡¨å•æ¡†æ¶
            form_frame = ctk.CTkFrame(file_card, fg_color="transparent")
            form_frame.pack(fill="x", padx=20, pady=15)

            # æ±‡æ€»æ–‡ä»¶é€‰æ‹© - ç¾åŒ–ç‰ˆæœ¬
            row1 = ctk.CTkFrame(form_frame, fg_color="transparent")
            row1.pack(fill="x", pady=8)
            
            # æ–‡ä»¶å›¾æ ‡å’Œæ ‡ç­¾
            file_label_frame = ctk.CTkFrame(row1, fg_color="transparent")
            file_label_frame.pack(side="left", padx=(0, 15))
            
            file_icon = ctk.CTkLabel(
                file_label_frame,
                text="ğŸ“Š",
                font=("Microsoft YaHei", 20)
            )
            file_icon.pack(side="left", padx=(0, 8))
            
            file_label = ctk.CTkLabel(
                file_label_frame,
                text="é€‰æ‹©æ±‡æ€»æ–‡ä»¶\nSelect Summary File",
                font=("Microsoft YaHei", 12, "bold"),
                text_color=TEXT_COLOR
            )
            file_label.pack(side="left")
            
            # è¾“å…¥æ¡†å’ŒæŒ‰é’®å®¹å™¨
            input_frame = ctk.CTkFrame(row1, fg_color="transparent")
            input_frame.pack(side="right", fill="x", expand=True)
            
            # è¾“å…¥æ¡†
            file_entry = ctk.CTkEntry(
                input_frame,
                textvariable=self.summary_file_var,
                font=("Microsoft YaHei", 11),
    state="readonly",
                placeholder_text="ç‚¹å‡»æµè§ˆé€‰æ‹©æ±‡æ€»æ–‡ä»¶...",
                height=35,
                corner_radius=8
            )
            file_entry.pack(side="left", fill="x", expand=True, padx=(0, 10))
            
            # æµè§ˆæŒ‰é’®
            browse_btn1 = ctk.CTkButton(
                input_frame,
                text="ç€è¦½...\nBrowse...",
                font=("Microsoft YaHei", 10, "bold"),
                command=self._select_summary_file,
                width=100,
                height=35,
                corner_radius=8,
                fg_color=ACCENT_BLUE,
                hover_color="#1976d2"
            )
            browse_btn1.pack(side="right")

            # é…ç½®æ–‡ä»¶é€‰æ‹© - ç¾åŒ–ç‰ˆæœ¬
            row2 = ctk.CTkFrame(form_frame, fg_color="transparent")
            row2.pack(fill="x", pady=8)
            
            # æ–‡ä»¶å›¾æ ‡å’Œæ ‡ç­¾
            config_label_frame = ctk.CTkFrame(row2, fg_color="transparent")
            config_label_frame.pack(side="left", padx=(0, 15))
            
            config_icon = ctk.CTkLabel(
                config_label_frame,
                text="âš™ï¸",
                font=("Microsoft YaHei", 20)
            )
            config_icon.pack(side="left", padx=(0, 8))
            
            config_label = ctk.CTkLabel(
                config_label_frame,
                text="é€‰æ‹©é…ç½®æ–‡ä»¶\nSelect Config File",
                font=("Microsoft YaHei", 12, "bold"),
                text_color=TEXT_COLOR
            )
            config_label.pack(side="left")
            
            # è¾“å…¥æ¡†å’ŒæŒ‰é’®å®¹å™¨
            config_input_frame = ctk.CTkFrame(row2, fg_color="transparent")
            config_input_frame.pack(side="right", fill="x", expand=True)
            
            # è¾“å…¥æ¡†
            config_entry = ctk.CTkEntry(
                config_input_frame,
                textvariable=self.config_file_var,
                font=("Microsoft YaHei", 11),
                state="readonly",
                placeholder_text="ç‚¹å‡»æµè§ˆé€‰æ‹©é…ç½®æ–‡ä»¶...",
                height=35,
                corner_radius=8
            )
            config_entry.pack(side="left", fill="x", expand=True, padx=(0, 10))
            
            # æµè§ˆæŒ‰é’®
            browse_btn2 = ctk.CTkButton(
                config_input_frame,
                text="ç€è¦½...\nBrowse...",
                font=("Microsoft YaHei", 10, "bold"),
                command=self._select_config_file,
                width=100,
                height=35,
                corner_radius=8,
                fg_color=ACCENT_BLUE,
                hover_color="#1976d2"
            )
            browse_btn2.pack(side="right")

            # è¾“å‡ºæ–‡ä»¶å¤¹é€‰æ‹© - ç¾åŒ–ç‰ˆæœ¬
            row3 = ctk.CTkFrame(form_frame, fg_color="transparent")
            row3.pack(fill="x", pady=8)
            
            # æ–‡ä»¶å›¾æ ‡å’Œæ ‡ç­¾
            folder_label_frame = ctk.CTkFrame(row3, fg_color="transparent")
            folder_label_frame.pack(side="left", padx=(0, 15))
            
            folder_icon = ctk.CTkLabel(
                folder_label_frame,
                text="ğŸ“",
                font=("Microsoft YaHei", 20)
            )
            folder_icon.pack(side="left", padx=(0, 8))
            
            folder_label = ctk.CTkLabel(
                folder_label_frame,
                text="é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹\nSelect Output Folder",
                font=("Microsoft YaHei", 12, "bold"),
                text_color=TEXT_COLOR
            )
            folder_label.pack(side="left")
            
            # è¾“å…¥æ¡†å’ŒæŒ‰é’®å®¹å™¨
            folder_input_frame = ctk.CTkFrame(row3, fg_color="transparent")
            folder_input_frame.pack(side="right", fill="x", expand=True)
            
            # è¾“å…¥æ¡†
            folder_entry = ctk.CTkEntry(
                folder_input_frame,
                textvariable=self.output_folder_var,
                font=("Microsoft YaHei", 11),
                state="readonly",
                placeholder_text="ç‚¹å‡»æµè§ˆé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹...",
                height=35,
                corner_radius=8
            )
            folder_entry.pack(side="left", fill="x", expand=True, padx=(0, 10))
            
            # æµè§ˆæŒ‰é’®
            browse_btn3 = ctk.CTkButton(
                folder_input_frame,
                text="ç€è¦½...\nBrowse...",
                font=("Microsoft YaHei", 10, "bold"),
                command=self._select_output_folder,
                width=100,
                height=35,
                corner_radius=8,
                fg_color=ACCENT_BLUE,
                hover_color="#1976d2"
            )
            browse_btn3.pack(side="right")

            # æœç´¢å’Œè¿‡æ»¤å¡ç‰‡
            search_card = ctk.CTkFrame(main_container, fg_color=DARK_PANEL, corner_radius=15)
            search_card.pack(fill="x", pady=(0, 15))
            
            # æœç´¢å’Œè¿‡æ»¤æ¡†æ¶
            search_frame = ctk.CTkFrame(search_card, fg_color="transparent")
            search_frame.pack(fill="x", padx=20, pady=15)
            
            # è¿‡æ»¤å™¨è¡Œ - é‡æ–°å¸ƒå±€
            filter_row = ctk.CTkFrame(search_frame, fg_color="transparent")
            filter_row.pack(fill="x", pady=5)
            
            # ä¾›åº”å•†è¿‡æ»¤å™¨
            supplier_frame = ctk.CTkFrame(filter_row, fg_color="transparent")
            supplier_frame.pack(side="left", padx=(0, 20))
            
            supplier_icon = ctk.CTkLabel(
                supplier_frame,
                text="ğŸ¢",
                font=("Microsoft YaHei", 14)
            )
            supplier_icon.pack(side="left", padx=(0, 8))
            
            supplier_label = ctk.CTkLabel(
                supplier_frame,
                text="ä¾›åº”å•† / Supplier:",
                font=("Microsoft YaHei", 11, "bold"),
                text_color=TEXT_COLOR
            )
            supplier_label.pack(side="left", padx=(0, 10))
            
            self.operation_supplier_filter_var = ctk.StringVar(value="å…¨éƒ¨")
            supplier_combo = ctk.CTkComboBox(
                supplier_frame,
                values=["å…¨éƒ¨", "Freshening", "Legacy", "Unikleen"],
                variable=self.operation_supplier_filter_var,
                font=("Microsoft YaHei", 10),
                width=120,
                height=30,
                corner_radius=6,
                command=self._filter_treeview_results
            )
            supplier_combo.pack(side="left")
            
            # é—¨å¸‚è¿‡æ»¤å™¨
            outlet_frame = ctk.CTkFrame(filter_row, fg_color="transparent")
            outlet_frame.pack(side="left", padx=(0, 20))
            
            outlet_icon = ctk.CTkLabel(
                outlet_frame,
                text="ğŸª",
                font=("Microsoft YaHei", 14)
            )
            outlet_icon.pack(side="left", padx=(0, 8))
            
            outlet_label = ctk.CTkLabel(
                outlet_frame,
                text="é—¨å¸‚ / Outlet:",
                font=("Microsoft YaHei", 11, "bold"),
                text_color=TEXT_COLOR
            )
            outlet_label.pack(side="left", padx=(0, 10))
            
            self.operation_outlet_filter_var = ctk.StringVar(value="å…¨éƒ¨")
            outlet_combo = ctk.CTkComboBox(
                outlet_frame,
                values=["å…¨éƒ¨"],
                variable=self.operation_outlet_filter_var,
                font=("Microsoft YaHei", 10),
                width=120,
                height=30,
                corner_radius=6,
                command=self._filter_treeview_results
            )
            outlet_combo.pack(side="left")
            
            # æœç´¢æ¡† - ç§»åˆ°é—¨å¸‚å³ä¾§
            search_frame_inline = ctk.CTkFrame(filter_row, fg_color="transparent")
            search_frame_inline.pack(side="left", padx=(20, 0))
            
            search_icon = ctk.CTkLabel(
                search_frame_inline,
                text="ğŸ”",
                font=("Microsoft YaHei", 14)
            )
            search_icon.pack(side="left", padx=(0, 8))
            
            search_label = ctk.CTkLabel(
                search_frame_inline,
                text="æœç´¢ / Search:",
                font=("Microsoft YaHei", 11, "bold"),
                text_color=TEXT_COLOR
            )
            search_label.pack(side="left", padx=(0, 10))
            
            self.operation_search_var = ctk.StringVar()
            search_entry = ctk.CTkEntry(
                search_frame_inline,
                textvariable=self.operation_search_var,
                placeholder_text="è¾“å…¥å…³é”®è¯...",
                font=("Microsoft YaHei", 10),
                height=30,
                corner_radius=6,
                width=200
            )
            search_entry.pack(side="left")
            search_entry.bind("<KeyRelease>", self._filter_treeview_results)
            
            # ç»“æœå±•ç¤ºå¡ç‰‡
            results_card = ctk.CTkFrame(main_container, fg_color=DARK_PANEL, corner_radius=15)
            results_card.pack(fill="x", pady=(0, 10))
            
            # ç»“æœå±•ç¤ºæ¡†æ¶
            table_frame = ctk.CTkFrame(results_card, fg_color="transparent")
            table_frame.pack(fill="x", padx=20, pady=15)
            
            # åˆ›å»ºTreeViewå®¹å™¨
            treeview_container = ctk.CTkFrame(table_frame, fg_color="transparent")
            treeview_container.pack(fill="x")
            
            # åˆ›å»ºTreeView
            columns = ("outlet", "product", "supplier", "output_file", "match_status")
            col_labels = ("é—¨å¸‚/Outlet", "äº§å“/Product", "ä¾›åº”å•†/Supplier", "è¾“å‡ºæ–‡ä»¶/Output File", "åŒ¹é…çŠ¶æ€/Match Status")
            
            # åˆ›å»ºæ ·å¼
            style = ttk.Style()
            style.theme_use("clam")
            style.configure("Custom.Treeview.Heading", 
                          font=("Microsoft YaHei", 10, "bold"),
                          background="#2b2b2b",
                          foreground="white",
                          fieldbackground="#2b2b2b")
            style.configure("Custom.Treeview", 
                          font=("Microsoft YaHei", 10),
                          background="#1e1e1e",
                          foreground="white",
                          fieldbackground="#1e1e1e",
                          rowheight=30)
            style.map("Custom.Treeview", 
                     background=[('selected', '#3b82f6')],
                     foreground=[('selected', 'white')])
            
            self.result_treeview = ttk.Treeview(
                treeview_container,
                columns=columns,
                show="headings",
                style="Custom.Treeview",
                height=8
            )
            
            # è®¾ç½®åˆ—æ ‡é¢˜å’Œå®½åº¦
            for i, (col, label) in enumerate(zip(columns, col_labels)):
                self.result_treeview.heading(col, text=label)
                if col == "outlet":
                    self.result_treeview.column(col, width=120, anchor="center")
                elif col == "product":
                    self.result_treeview.column(col, width=250, anchor="w")
                elif col == "supplier":
                    self.result_treeview.column(col, width=100, anchor="center")
                elif col == "output_file":
                    self.result_treeview.column(col, width=200, anchor="w")
                elif col == "match_status":
                    self.result_treeview.column(col, width=120, anchor="center")
            
            # æ·»åŠ æ»šåŠ¨æ¡
            scrollbar = ttk.Scrollbar(treeview_container, orient="vertical", command=self.result_treeview.yview)
            self.result_treeview.configure(yscrollcommand=scrollbar.set)
            
            # å¸ƒå±€
            self.result_treeview.pack(side="left", fill="x", expand=True)
            scrollbar.pack(side="right", fill="y")
            
            # åˆå§‹åŒ–æ•°æ®
            self._treeview_data = []
            self.result_treeview.insert("", "end", values=("ç­‰å¾…å¤„ç†...", "", "", "", "ç­‰å¾…ä¸­"))
            
            # æŒ‰é’®æ¡†æ¶ - ç¡®ä¿å¯è§
            button_frame = ctk.CTkFrame(main_container, fg_color="transparent")
            button_frame.pack(fill="x", pady=10, side="bottom")
            
            # å¼€å§‹å¤„ç†æŒ‰é’® - ç¡®ä¿å¯è§
            process_btn = ctk.CTkButton(
                button_frame,
                text="ğŸš€ å¼€å§‹å¤„ç†\nStart Processing",
                command=self._run_new_operation_supplies_with_treeview,
                width=300,
                height=60,
                fg_color="#F97316",
                hover_color="#EA580C",
                font=("Microsoft YaHei", 18, "bold"),
                corner_radius=12,
                border_width=2,
                border_color="#EA580C"
            )
            process_btn.pack(anchor="center", pady=5)

        # æ¸…ç©ºå†…å®¹åŒº
        for w in self.content_body.winfo_children():
            w.destroy()

        # è®¾ç½®åŠŸèƒ½æ ‡é¢˜
        self.function_title.configure(text=t("operation_supplies"))
        self.function_subtitle.configure(
    text="å¤„ç†è¿è¥ç”¨å“æœˆè®¢å•\nProcess monthly operation supplies orders")

        # ç›´æ¥æ„å»ºè¿è¥ç”¨å“ç•Œé¢
        build(self.content_body)

    def _select_summary_file(self):
        """é€‰æ‹©æ±‡æ€»æ–‡ä»¶"""
        f = filedialog.askopenfilename(
    title="é€‰æ‹©æ±‡æ€»æ–‡ä»¶/Select Summary File", filetypes=[
        ("Excel Files", "*.xlsx;*.xls;*.xlsm"),
        ("Excel Workbook", "*.xlsx"),
        ("Excel Macro-Enabled", "*.xlsm"),
        ("Excel 97-2003", "*.xls"),
        ("All Files", "*.*")])
        if f: self.summary_file_var.set(f)

    def _select_config_file(self):
        """é€‰æ‹©é…ç½®æ–‡ä»¶"""
        f = filedialog.askopenfilename(
    title="é€‰æ‹©é…ç½®æ–‡ä»¶/Select Config File",
    filetypes=[
        ("Excel",
         "*.xlsx;*.xls")])
        if f: self.config_file_var.set(f)

    def _select_output_folder(self):
        """é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹"""
        f = filedialog.askdirectory(title=t("select_folder"))
        if f: self.output_folder_var.set(f)
    
    def _on_supplier_change(self, choice):
        """ä¾›åº”å•†é€‰æ‹©æ”¹å˜æ—¶çš„å›è°ƒå‡½æ•°"""
        if choice == "all":
            print("ğŸ¯ é€‰æ‹©å¤„ç†æ‰€æœ‰ä¾›åº”å•†")
        else:
            print(f"ğŸ¯ é€‰æ‹©åªå¤„ç† {choice} ä¾›åº”å•†")

    def _run_new_operation_supplies_with_treeview(self):
        """è¿è¡Œæ–°çš„è¿è¥ç”¨å“å¤„ç† - å¸¦TreeViewæ˜¾ç¤º"""
        print("ğŸš€ å¼€å§‹å¤„ç†æŒ‰é’®è¢«ç‚¹å‡»")
        
        try:
            summary_file = self.summary_file_var.get()
            config_file = self.config_file_var.get()
            output_folder = self.output_folder_var.get()
            
            print(f"ğŸ“ æ–‡ä»¶è·¯å¾„æ£€æŸ¥:")
            print(f"  Summary: {summary_file}")
            print(f"  Config: {config_file}")
            print(f"  Output: {output_folder}")
            
            if not summary_file or not config_file or not output_folder:
                messagebox.showwarning(
                    "è­¦å‘Š/Warning",
         "è¯·é€‰æ‹©æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼\nPlease select all required files and folders!")
                return
            
            print("âœ… æ–‡ä»¶è·¯å¾„æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹å¤„ç†...")
        except Exception as e:
            print(f"âŒ æŒ‰é’®ç‚¹å‡»å¤„ç†å¤±è´¥: {str(e)}")
            messagebox.showerror("é”™è¯¯", f"å¤„ç†å¤±è´¥: {str(e)}")
            return

        # æ¸…ç©ºTreeView
        for item in self.result_treeview.get_children():
            self.result_treeview.delete(item)
        self._treeview_data = []
        
        # æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
        self.result_treeview.insert("", "end", values=("å¤„ç†ä¸­...", "", "", "", "å¤„ç†ä¸­"))
        
        def update_treeview(results):
            """æ›´æ–°TreeViewæ˜¾ç¤ºç»“æœ"""
            # æ¸…ç©ºç°æœ‰æ•°æ®
            for item in self.result_treeview.get_children():
                self.result_treeview.delete(item)
            self._treeview_data = []
            
            # æ·»åŠ æ–°æ•°æ®
            for result in results:
                outlet_name = result.get('outlet_name', '')
                product = result.get('product', '')
                supplier = result.get('supplier', '')
                output_file = result.get('output_file', '')
                match_status = result.get('match_status', '')
                
                self.result_treeview.insert("", "end", values=(
                    outlet_name, product, supplier, output_file, match_status
                ))
                self._treeview_data.append({
                    'outlet_name': outlet_name,
                    'product': product,
                    'supplier': supplier,
                    'output_file': output_file,
                    'match_status': match_status
                })
            
            # æ›´æ–°è¿‡æ»¤å™¨é€‰é¡¹
            self._update_filter_options()
        
        def log_callback(message):
            """æ—¥å¿—å›è°ƒ"""
            print(f"Operation Supplies: {message}")
        
        # åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œå¤„ç†
        def run_processing():
            try:
                print("ğŸ”„ å¼€å§‹åå°å¤„ç†...")
                # ä½¿ç”¨æ–°çš„å¤„ç†æ–¹æ³•
                results = self._process_operation_supplies_new_format(
                    summary_file, config_file, output_folder, update_treeview
                )
                print("âœ… åå°å¤„ç†å®Œæˆ")
            except Exception as e:
                print(f"âŒ åå°å¤„ç†å¤±è´¥: {str(e)}")
                import traceback
                traceback.print_exc()
                self.after(0, lambda: messagebox.showerror("é”™è¯¯", f"å¤„ç†å¤±è´¥: {str(e)}"))
        
        print("ğŸš€ å¯åŠ¨åå°çº¿ç¨‹...")
        threading.Thread(target=run_processing, daemon=True).start()
    
    def _process_operation_supplies_new_format(self, summary_file, config_file, output_folder, update_callback):
        """æ–°çš„è¿è¥ç”¨å“å¤„ç†æ–¹æ³• - ä½¿ç”¨ç°æœ‰è®¢å•æ¨¡æ¿ï¼Œä»Summary Sheetè¯»å–æ•°æ®"""
        try:
            import pandas as pd
            from datetime import datetime, timedelta
            import os
            import openpyxl
            from openpyxl.utils import get_column_letter
            
            # 1. è¯»å–Summary Sheetæ•°æ®
            print("ğŸ“– è¯»å–Summary Sheetæ•°æ®...")
            print(f"ğŸ“ æ–‡ä»¶è·¯å¾„: {summary_file}")
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if not os.path.exists(summary_file):
                raise FileNotFoundError(f"Summaryæ–‡ä»¶ä¸å­˜åœ¨: {summary_file}")
            
            # ä½¿ç”¨openpyxlè¯»å–Excelæ–‡ä»¶ï¼Œä¿ç•™æ¨¡æ¿æ ¼å¼
            try:
                wb = openpyxl.load_workbook(summary_file, data_only=False)
                print(f"ğŸ“‹ å¯ç”¨çš„å·¥ä½œè¡¨: {wb.sheetnames}")
                
                # è¯»å–Summaryå·¥ä½œè¡¨
                if "Summary" in wb.sheetnames:
                    summary_ws = wb["Summary"]
                else:
                    print("âš ï¸ æ²¡æœ‰æ‰¾åˆ°Summaryå·¥ä½œè¡¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨")
                    summary_ws = wb.worksheets[0]
                
                # å°†Summaryæ•°æ®è½¬æ¢ä¸ºDataFrame
                summary_data = []
                for row in summary_ws.iter_rows(min_row=2, values_only=True):  # è·³è¿‡æ ‡é¢˜è¡Œ
                    if any(cell for cell in row):  # è·³è¿‡ç©ºè¡Œ
                        summary_data.append(row)
                
                # åŠ¨æ€è·å–åˆ—æ•°
                if summary_data:
                    max_cols = max(len(row) for row in summary_data)
                    print(f"ğŸ“Š æ£€æµ‹åˆ°æœ€å¤§åˆ—æ•°: {max_cols}")
                    
                    # åˆ›å»ºåˆ—å
                    columns = ['Out', 'Suppli', 'Description', 'Chinese', 'PRI', 'Q']
                    # å¦‚æœåˆ—æ•°ä¸å¤Ÿï¼Œæ·»åŠ é¢å¤–çš„åˆ—
                    while len(columns) < max_cols:
                        columns.append(f'Extra_{len(columns)}')
                    
                    # åˆ›å»ºDataFrame
                    summary_df = pd.DataFrame(summary_data, columns=columns[:max_cols])
                    print(f"ğŸ“Š å®é™…ä½¿ç”¨çš„åˆ—æ•°: {len(summary_df.columns)}")
                else:
                    # å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºç©ºçš„DataFrame
                    summary_df = pd.DataFrame(columns=['Out', 'Suppli', 'Description', 'Chinese', 'PRI', 'Q'])
                print(f"ğŸ“Š Summary Sheetè¡Œæ•°: {len(summary_df)}")
                print(f"ğŸ“Š Summary Sheetåˆ—æ•°: {len(summary_df.columns)}")
                
            except Exception as e:
                print(f"âŒ è¯»å–Summaryæ–‡ä»¶å¤±è´¥: {str(e)}")
                raise e
            
            # 2. è¯»å–Configæ–‡ä»¶çš„é—¨å¸‚ä¿¡æ¯
            print("ğŸ“– è¯»å–é—¨å¸‚é…ç½®ä¿¡æ¯...")
            print(f"ğŸ“ Configæ–‡ä»¶è·¯å¾„: {config_file}")
            
            if not os.path.exists(config_file):
                raise FileNotFoundError(f"Configæ–‡ä»¶ä¸å­˜åœ¨: {config_file}")
            
            try:
                # ä½¿ç”¨openpyxlè¯»å–Configæ–‡ä»¶
                config_wb = openpyxl.load_workbook(config_file, data_only=False)
                print(f"ğŸ“‹ Configæ–‡ä»¶å·¥ä½œè¡¨: {config_wb.sheetnames}")
                
                if "OUTLET" in config_wb.sheetnames:
                    config_ws = config_wb["OUTLET"]
                else:
                    print("âš ï¸ æ²¡æœ‰æ‰¾åˆ°OUTLETå·¥ä½œè¡¨ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨")
                    config_ws = config_wb.worksheets[0]
                
                # å°†Configæ•°æ®è½¬æ¢ä¸ºDataFrame
                config_data = []
                for row in config_ws.iter_rows(min_row=2, values_only=True):  # è·³è¿‡æ ‡é¢˜è¡Œ
                    if any(cell for cell in row):  # è·³è¿‡ç©ºè¡Œ
                        config_data.append(row)
                
                # åŠ¨æ€è·å–åˆ—æ•°
                if config_data:
                    max_cols = max(len(row) for row in config_data)
                    print(f"ğŸ“Š Configæ£€æµ‹åˆ°æœ€å¤§åˆ—æ•°: {max_cols}")
                    
                    # åˆ›å»ºåˆ—å
                    columns = ['Short Name', 'Outlet Full Name', 'Email', 'Address', 'Name in Email', 'Freshening Delivery Date', 'Monthend Code']
                    # å¦‚æœåˆ—æ•°ä¸å¤Ÿï¼Œæ·»åŠ é¢å¤–çš„åˆ—
                    while len(columns) < max_cols:
                        columns.append(f'Extra_{len(columns)}')
                    
                    # åˆ›å»ºDataFrame
                    config_df = pd.DataFrame(config_data, columns=columns[:max_cols])
                    print(f"ğŸ“Š Configå®é™…ä½¿ç”¨çš„åˆ—æ•°: {len(config_df.columns)}")
                else:
                    # å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºç©ºçš„DataFrame
                    config_df = pd.DataFrame(columns=['Short Name', 'Outlet Full Name', 'Email', 'Address', 'Name in Email', 'Freshening Delivery Date', 'Monthend Code'])
                
                print(f"ğŸ“Š Configæ–‡ä»¶è¡Œæ•°: {len(config_df)}")
                print(f"ğŸ“Š Configæ–‡ä»¶åˆ—æ•°: {len(config_df.columns)}")
                print(f"ğŸ“Š Configåˆ—å: {list(config_df.columns)}")
                
            except Exception as e:
                print(f"âŒ è¯»å–Configæ–‡ä»¶å¤±è´¥: {str(e)}")
                raise e
            
            outlet_config = {}
            
            # æ ¹æ®å®é™…Configç»“æ„æ˜ å°„åˆ—
            # Config Sheet: Short Name, Outlet Full Name, Email, Address, Name in Email, Freshening Delivery Date, Monthend Code
            short_name_col = 'Short Name' if 'Short Name' in config_df.columns else None
            full_name_col = 'Outlet Full Name' if 'Outlet Full Name' in config_df.columns else None
            address_col = 'Address' if 'Address' in config_df.columns else None
            delivery_date_col = 'Freshening Delivery Date' if 'Freshening Delivery Date' in config_df.columns else None
            
            print(f"ğŸ” Configåˆ—æ˜ å°„: ç®€ç§°={short_name_col}, å…¨å={full_name_col}, åœ°å€={address_col}, é…é€æ—¥æœŸ={delivery_date_col}")
            
            for idx, row in config_df.iterrows():
                try:
                    if short_name_col and full_name_col:
                        short_name = str(row[short_name_col]).strip()
                        full_name = str(row[full_name_col]).strip()
                        address = str(row[address_col]).strip() if address_col else ""
                        delivery_date = str(row[delivery_date_col]).strip() if delivery_date_col else ""
                    else:
                        # ä½¿ç”¨ä½ç½®ç´¢å¼•ä½œä¸ºå¤‡é€‰
                        short_name = str(row.iloc[0]).strip() if len(row) > 0 else ""
                        full_name = str(row.iloc[1]).strip() if len(row) > 1 else ""
                        address = str(row.iloc[3]).strip() if len(row) > 3 else ""
                        delivery_date = str(row.iloc[5]).strip() if len(row) > 5 else ""
                    
                    if short_name and short_name != 'nan' and full_name and full_name != 'nan':
                        outlet_config[short_name] = {
                            'full_name': full_name,
                            'address': address,
                            'delivery_date': delivery_date
                        }
                        print(f"âœ… æ·»åŠ é—¨å¸‚é…ç½®: {short_name} -> {full_name} (é…é€: {delivery_date})")
                except Exception as e:
                    print(f"âš ï¸ å¤„ç†ç¬¬{idx}è¡Œé…ç½®æ—¶å‡ºé”™: {str(e)}")
                    continue
            
            print(f"âœ… è¯»å–åˆ° {len(outlet_config)} ä¸ªé—¨å¸‚é…ç½®")
            
            # 3. æŒ‰ä¾›åº”å•†åˆ†ç»„å¤„ç†ï¼Œä½¿ç”¨ç°æœ‰æ¨¡æ¿
            suppliers = ['Freshening', 'Legacy', 'Unikleen']
            all_results = []
            
            print(f"ğŸ“Š Summaryæ•°æ®åˆ—å: {list(summary_df.columns)}")
            print(f"ğŸ“Š Summaryæ•°æ®ç¤ºä¾‹: {summary_df.head()}")
            
            for supplier in suppliers:
                print(f"ğŸ­ å¤„ç† {supplier} ä¾›åº”å•†...")
                
                # è·å–è¯¥ä¾›åº”å•†ç›¸å…³çš„æ•°æ®
                supplier_data = summary_df[summary_df['Suppli'] == supplier]
                print(f"ğŸ“Š {supplier} æ•°æ®è¡Œæ•°: {len(supplier_data)}")
                
                if len(supplier_data) == 0:
                    print(f"âš ï¸ {supplier} æ²¡æœ‰æ•°æ®ï¼Œè·³è¿‡")
                    continue
                
                # æŒ‰é—¨å¸‚åˆ†ç»„
                outlet_groups = {}
                for idx, row in supplier_data.iterrows():
                    outlet_name = str(row['Out']).strip()
                    if outlet_name and outlet_name != 'nan':
                        if outlet_name not in outlet_groups:
                            outlet_groups[outlet_name] = []
                        outlet_groups[outlet_name].append(row)
                
                print(f"ğŸ“Š {supplier} æ‰¾åˆ° {len(outlet_groups)} ä¸ªé—¨å¸‚çš„æ•°æ®")
                
                # ä¸ºæ¯ä¸ªé—¨å¸‚åˆ›å»ºè®¢å•æ–‡ä»¶
                for outlet_name, outlet_data in outlet_groups.items():
                    print(f"ğŸª åˆ›å»ºé—¨å¸‚ {outlet_name} çš„ {supplier} è®¢å•...")
                    
                    # å¤åˆ¶ä¾›åº”å•†æ¨¡æ¿
                    template_ws = wb[supplier]  # ä½¿ç”¨ç°æœ‰çš„ä¾›åº”å•†æ¨¡æ¿
                    new_wb = openpyxl.Workbook()
                    new_ws = new_wb.active
                    
                    # å¤åˆ¶æ¨¡æ¿å†…å®¹
                    for row in template_ws.iter_rows():
                        for cell in row:
                            new_cell = new_ws[cell.coordinate]
                            new_cell.value = cell.value
                            if cell.has_style:
                                new_cell.font = cell.font
                                new_cell.border = cell.border
                                new_cell.fill = cell.fill
                                new_cell.number_format = cell.number_format
                                new_cell.protection = cell.protection
                                new_cell.alignment = cell.alignment
                    
                    # å¡«å†™é—¨å¸‚ä¿¡æ¯
                    if outlet_name in outlet_config:
                        config = outlet_config[outlet_name]
                        # F5: é—¨å¸‚å…¨å
                        new_ws['F5'] = config['full_name']
                        # F6: åœ°å€
                        new_ws['F6'] = config['address']
                        
                        # F8: é…é€æ—¥æœŸ (åªæœ‰Fresheningéœ€è¦)
                        if supplier == 'Freshening':
                            delivery_date = self._calculate_freshening_delivery_date(config['delivery_date'])
                            new_ws['F8'] = delivery_date
                    
                    # å¡«å†™äº§å“æ•°æ®åˆ°F-Kåˆ— (æ˜ŸæœŸä¸€-æ˜ŸæœŸå…­)
                    # æ‰¾åˆ°äº§å“æ•°æ®è¡Œ (ä»ç¬¬10è¡Œå¼€å§‹)
                    product_row = 10
                    for data_row in outlet_data:
                        # æŸ¥æ‰¾åŒ¹é…çš„äº§å“è¡Œ
                        for row_num in range(10, 30):  # å‡è®¾äº§å“æ•°æ®åœ¨10-30è¡Œ
                            if new_ws[f'B{row_num}'].value and str(new_ws[f'B{row_num}'].value).strip():
                                # æ£€æŸ¥äº§å“åç§°æ˜¯å¦åŒ¹é…
                                template_product = str(new_ws[f'B{row_num}'].value).strip()
                                summary_product = str(data_row['Description']).strip()
                                
                                if self._is_product_match(template_product, summary_product):
                                    # å¡«å†™æ•°é‡åˆ°F-Kåˆ— (æ˜ŸæœŸä¸€-æ˜ŸæœŸå…­)
                                    quantity = data_row['Q']
                                    if quantity and quantity > 0:
                                        # æ ¹æ®é…é€æ—¥æœŸé€‰æ‹©åˆ—
                                        if supplier == 'Freshening':
                                            # Freshening: æ ¹æ®é…é€æ—¥æœŸé€‰æ‹©åˆ—
                                            delivery_col = self._get_delivery_column_for_freshening(config['delivery_date'])
                                        else:
                                            # Legacyå’ŒUnikleen: ä½¿ç”¨ç¬¬ä¸€åˆ— (æ˜ŸæœŸä¸€)
                                            delivery_col = 'F'
                                        
                                        new_ws[f'{delivery_col}{row_num}'] = quantity
                                        print(f"âœ… å¡«å†™ {summary_product}: {quantity} åˆ° {delivery_col}{row_num}")
                                    break
                    
                    # ä¿å­˜é—¨å¸‚è®¢å•æ–‡ä»¶
                    output_file = os.path.join(output_folder, f"{supplier}_{outlet_name}_{datetime.now().strftime('%Y%m%d')}.xlsx")
                    new_wb.save(output_file)
                    print(f"âœ… ä¿å­˜ {supplier} {outlet_name} æ–‡ä»¶: {output_file}")
                    
                    # è®°å½•ç»“æœ
                    all_results.append({
                        'outlet_name': outlet_name,
                        'product': f"{len(outlet_data)} ä¸ªäº§å“",
                        'supplier': supplier,
                        'output_file': f"{supplier}_{outlet_name}_{datetime.now().strftime('%Y%m%d')}.xlsx",
                        'match_status': 'æˆåŠŸ'
                    })
            
            # æ›´æ–°TreeView
            if update_callback:
                update_callback(all_results)
            
            return all_results
            
        except Exception as e:
            print(f"âŒ å¤„ç†å¤±è´¥: {str(e)}")
            raise e
    
    def _calculate_freshening_delivery_date(self, delivery_schedule):
        """è®¡ç®—Fresheningé…é€æ—¥æœŸ - æ™ºèƒ½åˆ¤æ–­ä¸‹ä¸ªæœˆæ—¥æœŸ"""
        try:
            from datetime import datetime, timedelta
            import calendar
            
            # è§£æé…é€æ—¶é—´è¡¨ (ä¾‹å¦‚: "SAT/WED", "FRI/TUE", "THU/MON")
            if not delivery_schedule or delivery_schedule == 'nan':
                return "æœªè®¾ç½®é…é€æ—¥æœŸ"
            
            # è®¡ç®—ä¸‹ä¸ªæœˆ1å·
            today = datetime.now()
            if today.month == 12:
                next_month = today.replace(year=today.year + 1, month=1, day=1)
            else:
                next_month = today.replace(month=today.month + 1, day=1)
            
            # æ˜ŸæœŸå‡ æ˜ å°„
            day_mapping = {
                'MON': 0, 'TUE': 1, 'WED': 2, 'THU': 3, 'FRI': 4, 'SAT': 5, 'SUN': 6
            }
            
            # è§£æé…é€æ—¥æœŸ
            days = delivery_schedule.split('/')
            if len(days) >= 2:
                day1, day2 = days[0].strip(), days[1].strip()
                
                # æ‰¾åˆ°ä¸‹ä¸ªæœˆç¬¬ä¸€ä¸ªé…é€æ—¥æœŸ
                for day in [day1, day2]:
                    if day in day_mapping:
                        target_weekday = day_mapping[day]
                        
                        # ä»ä¸‹ä¸ªæœˆ1å·å¼€å§‹æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ˜ŸæœŸå‡ 
                        current_date = next_month
                        while current_date.weekday() != target_weekday:
                            current_date += timedelta(days=1)
                        
                        return current_date.strftime('%Y-%m-%d (%A)')
            
            return f"ä¸‹ä¸ªæœˆ1å·: {next_month.strftime('%Y-%m-%d')}"
            
        except Exception as e:
            print(f"âš ï¸ è®¡ç®—é…é€æ—¥æœŸå¤±è´¥: {str(e)}")
            return "æ—¥æœŸè®¡ç®—é”™è¯¯"
    
    def _is_product_match(self, template_product, summary_product):
        """æ£€æŸ¥äº§å“æ˜¯å¦åŒ¹é…"""
        try:
            # ç®€å•çš„å­—ç¬¦ä¸²åŒ¹é…
            template_lower = template_product.lower()
            summary_lower = summary_product.lower()
            
            # æ£€æŸ¥å…³é”®è¯åŒ¹é…
            keywords = summary_lower.split()
            for keyword in keywords:
                if len(keyword) > 3 and keyword in template_lower:
                    return True
            
            # æ£€æŸ¥å®Œå…¨åŒ¹é…
            if template_lower == summary_lower:
                return True
            
            return False
        except:
            return False
    
    def _get_delivery_column_for_freshening(self, delivery_schedule):
        """æ ¹æ®Fresheningé…é€æ—¶é—´è¡¨è·å–é…é€åˆ—"""
        try:
            # è§£æé…é€æ—¶é—´è¡¨ (ä¾‹å¦‚: "SAT/WED", "FRI/TUE", "THU/MON")
            if not delivery_schedule or delivery_schedule == 'nan':
                return 'F'  # é»˜è®¤æ˜ŸæœŸä¸€
            
            days = delivery_schedule.split('/')
            if len(days) >= 1:
                day = days[0].strip()
                # æ˜ŸæœŸå‡ åˆ°åˆ—çš„æ˜ å°„ (F-Kå¯¹åº”æ˜ŸæœŸä¸€-æ˜ŸæœŸå…­)
                day_to_col = {
                    'MON': 'F', 'TUE': 'G', 'WED': 'H', 'THU': 'I', 'FRI': 'J', 'SAT': 'K'
                }
                return day_to_col.get(day, 'F')
            
            return 'F'  # é»˜è®¤æ˜ŸæœŸä¸€
        except:
            return 'F'  # é»˜è®¤æ˜ŸæœŸä¸€
    
    def _update_filter_options(self):
        """æ›´æ–°è¿‡æ»¤å™¨é€‰é¡¹"""
        # æ›´æ–°ä¾›åº”å•†é€‰é¡¹
        suppliers = set()
        outlets = set()
        
        for item in self._treeview_data:
            if item.get('supplier'):
                suppliers.add(item['supplier'])
            if item.get('outlet_name'):
                outlets.add(item['outlet_name'])
        
        # æ›´æ–°ä¾›åº”å•†ä¸‹æ‹‰æ¡†
        supplier_values = ["å…¨éƒ¨"] + sorted(list(suppliers))
        # è¿™é‡Œéœ€è¦æ‰¾åˆ°ä¾›åº”å•†ä¸‹æ‹‰æ¡†å¹¶æ›´æ–°å…¶values
        
        # æ›´æ–°é—¨å¸‚ä¸‹æ‹‰æ¡†
        outlet_values = ["å…¨éƒ¨"] + sorted(list(outlets))
        # è¿™é‡Œéœ€è¦æ‰¾åˆ°é—¨å¸‚ä¸‹æ‹‰æ¡†å¹¶æ›´æ–°å…¶values
    
    def _filter_treeview_results(self, event=None):
        """è¿‡æ»¤TreeViewç»“æœ"""
        search_term = self.operation_search_var.get().lower()
        supplier_filter = self.operation_supplier_filter_var.get()
        outlet_filter = self.operation_outlet_filter_var.get()
        
        # æ¸…ç©ºTreeView
        for item in self.result_treeview.get_children():
            self.result_treeview.delete(item)
        
        # è¿‡æ»¤æ•°æ®
        filtered_data = []
        for item in self._treeview_data:
            # æœç´¢è¿‡æ»¤
            if search_term:
                searchable_text = f"{item.get('outlet_name', '')} {item.get('product', '')} {item.get('supplier', '')}".lower()
                if search_term not in searchable_text:
                    continue
            
            # ä¾›åº”å•†è¿‡æ»¤
            if supplier_filter != "å…¨éƒ¨" and item.get('supplier') != supplier_filter:
                continue
            
            # é—¨å¸‚è¿‡æ»¤
            if outlet_filter != "å…¨éƒ¨" and item.get('outlet_name') != outlet_filter:
                continue
            
            filtered_data.append(item)
        
        # æ˜¾ç¤ºè¿‡æ»¤åçš„æ•°æ®
        for item in filtered_data:
            self.result_treeview.insert("", "end", values=(
                item.get('outlet_name', ''),
                item.get('product', ''),
                item.get('supplier', ''),
                item.get('output_file', ''),
                item.get('match_status', '')
            ))

    def _thread_task(self, fn, show_message=True):
        """çº¿ç¨‹ä»»åŠ¡ - åœ¨å¾Œå°ç·šç¨‹ä¸­åŸ·è¡Œ"""
        import threading

        def run_in_thread():
            try:
                result = fn()
                if show_message:
                    self.after(
    0, lambda: messagebox.showinfo(
        t("success"), result))
            except Exception as e:
                error_msg = str(e)
                self.after(
    0, lambda: messagebox.showerror(
        t("error"), f"æ“ä½œå¤±è´¥: {error_msg}"))

        # åœ¨å¾Œå°ç·šç¨‹ä¸­åŸ·è¡Œä»»å‹™
        thread = threading.Thread(target=run_in_thread, daemon=True)
        thread.start()

    def _select_download_folder(self):
        f = filedialog.askdirectory(title=t("select_folder"))
        if f:
            self.download_folder_var.set(f)

    def _select_checklist_folder(self):
        f = filedialog.askdirectory(title=t("select_folder"))
        if f:
            self.checklist_folder_var.set(f)

    def _run_download(self):
        """åŸ·è¡Œä¸‹è¼‰"""
        folder = self.download_folder_var.get()
        config_file = self.config_file_var.get()
        if not folder:
            messagebox.showwarning("è­¦å‘Š", "è«‹é¸æ“‡ä¸‹è¼‰è³‡æ–™å¤¾ï¼")
            return

        # åœ¨ä¸»ç·šç¨‹ä¸­é¸æ“‡å¸³è™Ÿ
        try:
            import win32com.client
            import pythoncom

            # åˆå§‹åŒ– COM çµ„ä»¶
            pythoncom.CoInitialize()

            outlook = win32com.client.Dispatch(
                "Outlook.Application").GetNamespace("MAPI")
            accounts = [
    outlook.Folders.Item(
        i +
        1) for i in range(
            outlook.Folders.Count)]
            account_names = [acct.Name for acct in accounts]

            # ä½¿ç”¨å°è©±æ¡†é¸æ“‡å¸³è™Ÿ
            selected_account_idx = show_outlook_account_selector(
                self, account_names)
            if selected_account_idx is None:
                return  # ç”¨æˆ¶å–æ¶ˆ

        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"ç²å– Outlook å¸³è™Ÿå¤±æ•—: {e}")
            return

        # è¨ˆç®—ä¸‹è¼‰æ—¥æœŸç¯„åœ
        from datetime import datetime, timedelta
        today = datetime.now()
        days_since_last_friday = (today.weekday() - 4) % 7 or 7
        start_of_period = (
    today -
    timedelta(
        days=days_since_last_friday)).replace(
            hour=0,
            minute=0,
            second=0,
             microsecond=0)
        end_of_period = today.replace(
    hour=23, minute=59, second=59, microsecond=999999)
        start_date = start_of_period.strftime("%Y-%m-%d")
        end_date = end_of_period.strftime("%Y-%m-%d")

        # å‰µå»ºé€²åº¦å½ˆçª—ï¼Œé¡¯ç¤ºæ—¥æœŸç¯„åœ
        p = ProgressPopup(self, "ä¸‹è¼‰ä¸­...", start_date, end_date, 0)
        self.progress_popup = p

        def log_callback(message):
            # æ¯å€‹æ¶ˆæ¯å¾Œé¢æ·»åŠ ç©ºè¡Œ
            p.log(message + "\n")
            print(message)  # åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°

        self._thread_task(
            lambda: OutlookDownloader.download_weekly_orders(
                folder, config_file, selected_account_idx,  # ä½¿ç”¨é¸æ“‡çš„å¸³è™Ÿ
                callback=log_callback, progress_popup=p
            ),
            show_message=False
        )

    def _run_download_amendments(self):
        """åŸ·è¡Œ Amendment ä¸‹è¼‰"""
        folder = self.download_folder_var.get()
        config_file = self.config_file_var.get()
        if not folder:
            messagebox.showwarning("è­¦å‘Š", "è«‹é¸æ“‡ä¸‹è¼‰è³‡æ–™å¤¾ï¼")
            return

        # åœ¨ä¸»ç·šç¨‹ä¸­é¸æ“‡å¸³è™Ÿ
        try:
            import win32com.client
            import pythoncom

            # åˆå§‹åŒ– COM çµ„ä»¶
            pythoncom.CoInitialize()

            outlook = win32com.client.Dispatch(
                "Outlook.Application").GetNamespace("MAPI")
            accounts = [
    outlook.Folders.Item(
        i +
        1) for i in range(
            outlook.Folders.Count)]
            account_names = [acct.Name for acct in accounts]

            # ä½¿ç”¨å°è©±æ¡†é¸æ“‡å¸³è™Ÿ
            selected_account_idx = show_outlook_account_selector(
                self, account_names)
            if selected_account_idx is None:
                return  # ç”¨æˆ¶å–æ¶ˆ

        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"ç²å– Outlook å¸³è™Ÿå¤±æ•—: {e}")
            return

        # è¨ˆç®—ä¸‹è¼‰æ—¥æœŸç¯„åœ
        from datetime import datetime, timedelta
        today = datetime.now()
        days_since_last_friday = (today.weekday() - 4) % 7 or 7
        start_of_period = (
    today -
    timedelta(
        days=days_since_last_friday)).replace(
            hour=0,
            minute=0,
            second=0,
             microsecond=0)
        end_of_period = today.replace(
    hour=23, minute=59, second=59, microsecond=999999)
        start_date = start_of_period.strftime("%Y-%m-%d")
        end_date = end_of_period.strftime("%Y-%m-%d")

        # å‰µå»ºé€²åº¦å½ˆçª—ï¼Œé¡¯ç¤ºæ—¥æœŸç¯„åœ
        p = ProgressPopup(self, "ä¸‹è¼‰ Amendment ä¸­...", start_date, end_date, 0)
        self.progress_popup = p

        def log_callback(message):
            # æ¯å€‹æ¶ˆæ¯å¾Œé¢æ·»åŠ ç©ºè¡Œ
            p.log(message + "\n")
            print(message)  # åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°

        self._thread_task(
            lambda: OutlookDownloader.download_amendment_orders(
                folder, config_file, selected_account_idx,  # ä½¿ç”¨é¸æ“‡çš„å¸³è™Ÿ
                callback=log_callback, progress_popup=p
            ),
            show_message=False
        )

    def _run_download_siahuat(self):
        """åŸ·è¡Œ Siahuat è¨‚å–®ä¸‹è¼‰ - å¾æœ¬æœˆ1è™Ÿé–‹å§‹"""
        folder = self.download_folder_var.get()
        config_file = self.config_file_var.get()
        if not folder:
            messagebox.showwarning("è­¦å‘Š", "è«‹é¸æ“‡ä¸‹è¼‰è³‡æ–™å¤¾ï¼")
            return

        # åœ¨ä¸»ç·šç¨‹ä¸­é¸æ“‡å¸³è™Ÿ
        try:
            import win32com.client
            import pythoncom

            # åˆå§‹åŒ– COM çµ„ä»¶
            pythoncom.CoInitialize()

            outlook = win32com.client.Dispatch(
                "Outlook.Application").GetNamespace("MAPI")
            accounts = [
                outlook.Folders.Item(
                    i +
                    1) for i in range(
                        outlook.Folders.Count)]
            account_names = [acct.Name for acct in accounts]

            # ä½¿ç”¨å°è©±æ¡†é¸æ“‡å¸³è™Ÿ
            selected_account_idx = show_outlook_account_selector(
                self, account_names)
            if selected_account_idx is None:
                return  # ç”¨æˆ¶å–æ¶ˆ

        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"ç²å– Outlook å¸³è™Ÿå¤±æ•—: {e}")
            return

        # è¨­ç½® Siahuat ç‰¹å®šçš„æ—¥æœŸç¯„åœï¼šæœ¬æœˆ1è™Ÿåˆ°ä»Šå¤©
        from datetime import datetime
        today = datetime.now()
        start_of_month = today.replace(day=1, hour=0, minute=0, second=0, microsecond=0)
        end_of_period = today.replace(hour=23, minute=59, second=59, microsecond=999999)
        start_date = start_of_month.strftime("%Y-%m-%d")
        end_date = end_of_period.strftime("%Y-%m-%d")

        # å‰µå»ºé€²åº¦å½ˆçª—ï¼Œé¡¯ç¤ºæ—¥æœŸç¯„åœ
        p = ProgressPopup(self, "ä¸‹è¼‰ Siahuat è¨‚å–®ä¸­...", start_date, end_date, 0)
        self.progress_popup = p

        def log_callback(message):
            # æ¯å€‹æ¶ˆæ¯å¾Œé¢æ·»åŠ ç©ºè¡Œ
            p.log(message + "\n")
            print(message)  # åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°

        self._thread_task(
            lambda: OutlookDownloader.download_siahuat_orders(
                folder, config_file, selected_account_idx,  # ä½¿ç”¨é¸æ“‡çš„å¸³è™Ÿ
                callback=log_callback, progress_popup=p
            ),
            show_message=False
        )

    def _run_enhanced_automation(self):
        source = self.folder_vars.get("source_folder", ctk.StringVar()).get()
        supplier = self.folder_vars.get(
    "supplier_folder", ctk.StringVar()).get()
        master_config = self.master_config_var.get()
        if not source or not supplier or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return
        p = ProgressPopup(self, t("processing"))
        self.progress_popup = p
        def logcb(m): p.log(m)
        config_mgr = UnifiedConfigManager(master_config)
        auto = EnhancedOrderAutomation(config_mgr)
        import threading

        def run_and_show_count():
            result = auto.run_automation(
    source, supplier, log_callback=logcb)[1]
            # çµ±è¨ˆå·²æ•´ç†åˆ†åº—æ•¸é‡
            import re
            outlet_count = 0
            for line in result.splitlines():
                m = re.match(r"- (.+)_Week", line)
                if m:
                    outlet_count += 1
            # åœ¨ popup ä¸‹æ–¹é¡¯ç¤º
            if hasattr(p, 'outlet_count_label') and p.outlet_count_label:
                p.outlet_count_label.configure(
    text=f"ğŸª å·²æ•´ç†åˆ†åº—æ•¸é‡: {outlet_count} é–“", text_color="#10b981")
            else:
                import customtkinter as ctk
                p.outlet_count_label = ctk.CTkLabel(
                    p,
                    text=f"ğŸª å·²æ•´ç†åˆ†åº—æ•¸é‡: {outlet_count} é–“",
                    font=("Microsoft JhengHei", 18, "bold"),
                    text_color="#10b981"
                )
                p.outlet_count_label.pack(pady=(0, 10))
        threading.Thread(target=run_and_show_count).start()

    def _run_yellow_highlighted_automation(self):
        """åªæ•´åˆæœ‰é»ƒè‰²æ¨™è¨˜çš„è¨‚å–®"""
        source = self.folder_vars.get("source_folder", ctk.StringVar()).get()
        supplier = self.folder_vars.get(
    "supplier_folder", ctk.StringVar()).get()
        master_config = self.master_config_var.get()
        if not source or not supplier or not master_config:
            messagebox.showwarning(t("warning"), t("folder_warning"))
            return

        p = ProgressPopup(self, "è™•ç†é»ƒè‰²æ¨™è¨˜è¨‚å–®ä¸­...")
        self.progress_popup = p
        def logcb(m): p.log(m)

        config_mgr = UnifiedConfigManager(master_config)
        auto = YellowHighlightedOrderAutomation(config_mgr)

        import threading

        def run_and_show_count():
            result = auto.run_automation(
    source, supplier, log_callback=logcb)[1]
            # çµ±è¨ˆå·²æ•´ç†åˆ†åº—æ•¸é‡
            import re
            outlet_count = 0
            for line in result.splitlines():
                m = re.match(r"- (.+)_Week", line)
                if m:
                    outlet_count += 1
            # åœ¨ popup ä¸‹æ–¹é¡¯ç¤º
            if hasattr(p, 'outlet_count_label') and p.outlet_count_label:
                p.outlet_count_label.configure(
    text=f"ğŸª å·²æ•´ç†åˆ†åº—æ•¸é‡: {outlet_count} é–“", text_color="#f59e0b")
            else:
                import customtkinter as ctk
                p.outlet_count_label = ctk.CTkLabel(
                    p,
                    text=f"ğŸª å·²æ•´ç†åˆ†åº—æ•¸é‡: {outlet_count} é–“",
                    font=("Microsoft JhengHei", 18, "bold"),
                    text_color="#f59e0b"
                )
                p.outlet_count_label.pack(pady=(0, 10))
        threading.Thread(target=run_and_show_count).start()

    def _select_config_file(self, var=None, filetypes=None):
        f = filedialog.askopenfilename(
    title=t("select_folder"), filetypes=filetypes or [
        ("Excel files", "*.xlsx;*.xls")])
        if f:
            if var:
                var.set(f)
            else:
                self.config_file_var.set(f)

    def _select_folder(self, key):
        f = filedialog.askdirectory(title=t("select_folder"))
        if f:
            self.folder_vars[key].set(f)

    def _select_folder_var(self, var):
        f = filedialog.askdirectory(title=t("select_folder"))
        if f:
            var.set(f)

    def _show_required_outlets_window(self):
        import pandas as pd
        import tkinter.ttk as ttk
        master_config = self.master_config_var.get()
        df_req = pd.read_excel(
    master_config,
     sheet_name="Supplier Requirements")
        config_suppliers = set(
            str(row[0]).strip() for _, row in df_req.iterrows() if str(row[0]).strip())

        win = ctk.CTkToplevel(self)
        win.title("å¿…è¦é–€å¸‚æ¸…å–®/Required Outlets List")
        win.geometry("800x500")
        ctk.CTkLabel(
    win,
    text="ğŸ“‹ ä¾›æ‡‰å•†/Supplier        â—ç¼ºæ¼åˆ†åº—/Missing Outlets",
    font=FONT_BIGBTN).pack(
        pady=10)
        frame = ctk.CTkFrame(win)
        frame.pack(fill="both", expand=True, padx=10, pady=10)
        tree = ttk.Treeview(
    frame,
    columns=(
        "supplier",
        "missing"),
        show="headings",
         height=16)
        tree.heading("supplier", text="ğŸ“‹ ä¾›æ‡‰å•†/Supplier")
        tree.heading("missing", text="â—ç¼ºæ¼åˆ†åº—/Missing Outlets")
        tree.column("supplier", width=180, anchor="center")
        tree.column("missing", width=600, anchor="w")

        # 1. åˆ†çµ„æ•´ç† missing outletï¼Œåªé‡å° config supplier
        missing_by_supplier = {}
        for row in getattr(self, '_checklist_table_data', []):
            if row.get("cover_status") == "âŒ":
                supplier = str(row.get("supplier", "")).strip()
                outlet = str(row.get("outlet", "")).strip()
                if supplier in config_suppliers:
                    if supplier not in missing_by_supplier:
                        missing_by_supplier[supplier] = []
                    missing_by_supplier[supplier].append(outlet)

        # 2. é¡¯ç¤º
        for supplier in config_suppliers:
            if supplier in missing_by_supplier:
                tree.insert(
    "", "end", values=(
        supplier, ", ".join(
            missing_by_supplier[supplier])))
        tree.pack(fill="both", expand=True)

        # è‹¥æ²’æœ‰ä»»ä½•ç¼ºæ¼
        if not any(missing_by_supplier.values()):
            tree.insert("", "end", values=("âœ” All covered", ""))

        # è¤‡è£½æŒ‰éˆ•
        def copy_selected():
            items = tree.selection()
            if not items:
                return
            import pyperclip
            rows = []
            for item in items:
                vals = tree.item(item, "values")
                rows.append("\t".join(vals))
            pyperclip.copy("\n".join(rows))
            messagebox.showinfo(
    "è¤‡è£½æˆåŠŸ/Copy Success",
     "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼/Copied to clipboard!")
        ctk.CTkButton(
    win,
    text="è¤‡è£½æ‰€é¸/Copy Selected",
    command=copy_selected).pack(
        pady=5)

    def show_user_guide(self):
        """æ˜¾ç¤ºç”¨æˆ·æŒ‡å—"""
        try:
            guide_path = resource_path("UserGuide.txt")
            if os.path.exists(guide_path):
                with open(guide_path, "r", encoding="utf-8") as f:
                    content = f.read()
                ScrollableMessageBox(self, "ç”¨æˆ·æŒ‡å—", content)
            else:
                messagebox.showwarning("æŒ‡å—ç¼ºå¤±", "ç”¨æˆ·æŒ‡å—æ–‡ä»¶æœªæ‰¾åˆ°")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"æ— æ³•åŠ è½½ç”¨æˆ·æŒ‡å—: {str(e)}")

    def _run_cross_check_email_log(self):
        import os
        import re
        import pandas as pd
        import customtkinter as ctk
        folder = self.checklist_folder_var.get()
        table = getattr(self, '_checklist_table_data', [])
        config_path = self.master_config_var.get()
        
        # ä½¿ç”¨æ™ºèƒ½æŸ¥æ‰¾é€»è¾‘æŸ¥æ‰¾ email_bodies_log.txt
        today = datetime.now()
        week_no = today.isocalendar()[1]
        possible_paths = []
        
        # æ–¹æ³•1ï¼šæ£€æŸ¥æœˆä»½-Weekæ ¼å¼çš„æ–‡ä»¶å¤¹
        for week_offset in range(0, 4):  # æ£€æŸ¥å½“å‰å‘¨å’Œå‰3å‘¨
            check_week = week_no - week_offset
            # è®¡ç®—å¯¹åº”æ—¥æœŸçš„æœˆä»½å’Œæ˜ŸæœŸ
            check_date = today - timedelta(weeks=week_offset)
            month_name = check_date.strftime('%b').title()  # ç¡®ä¿é¦–å­—æ¯å¤§å†™ï¼Œä¾‹å¦‚: Aug, Sep
            week_of_month = get_week_of_month(check_date)
            check_path = os.path.join(folder, f"{month_name} - Week {week_of_month}")
            if os.path.exists(check_path):
                possible_paths.append(check_path)
        
        # æ–¹æ³•2ï¼šæ£€æŸ¥Weekly Order/Augæ ¼å¼çš„æ–‡ä»¶å¤¹
        aug_path = os.path.join(folder, "Weekly Order", "Aug")
        if os.path.exists(aug_path):
            possible_paths.append(aug_path)
        
        # æ–¹æ³•3ï¼šæ£€æŸ¥ç›´æ¥åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„é‚®ä»¶æ—¥å¿—
        if os.path.exists(os.path.join(folder, "email_bodies_log.txt")):
            possible_paths.append(folder)
        
        # æ–¹æ³•4ï¼šæ£€æŸ¥ä¸Šçº§æ–‡ä»¶å¤¹ä¸­çš„é‚®ä»¶æ—¥å¿—ï¼ˆé’ˆå¯¹ Supplier Order å­æ–‡ä»¶å¤¹çš„æƒ…å†µï¼‰
        parent_folder = os.path.dirname(folder)
        if parent_folder and os.path.exists(os.path.join(parent_folder, "email_bodies_log.txt")):
            possible_paths.append(parent_folder)
        
        # æŸ¥æ‰¾åŒ…å«é‚®ä»¶æ—¥å¿—çš„æ–‡ä»¶å¤¹
        email_log_path = None
        for path in possible_paths:
            temp_log = os.path.join(path, "email_bodies_log.txt")
            if os.path.exists(temp_log):
                email_log_path = temp_log
                break
        
        if not email_log_path:
            from tkinter import messagebox
            debug_info = f"åœ¨ä»¥ä¸‹è·¯å¾„ä¸­æœªæ‰¾åˆ°email_bodies_log.txtï¼š\n"
            debug_info += f"å½“å‰æ—¥æœŸ: {today.strftime('%Y-%m-%d')}\n"
            debug_info += f"å½“å‰å‘¨æ•°: {week_no}\n"
            debug_info += f"Checklistæ–‡ä»¶å¤¹: {folder}\n\n"
            debug_info += f"æ£€æŸ¥çš„è·¯å¾„:\n"
            for i, path in enumerate(possible_paths, 1):
                debug_info += f"{i}. {path}\n"
            debug_info += f"\nè¯·ç¡®è®¤:\n"
            debug_info += f"1. æ˜¯å¦å·²ç»ä½¿ç”¨ 'outlet order download' ä¸‹è½½äº†é‚®ä»¶ï¼Ÿ\n"
            debug_info += f"2. ä¸‹è½½çš„æ–‡ä»¶å¤¹æ˜¯å¦ä¸ checklist æ–‡ä»¶å¤¹ç›¸åŒï¼Ÿ\n"
            debug_info += f"3. é‚®ä»¶æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºä¸Šè¿°è·¯å¾„ä¸­ï¼Ÿ"
            messagebox.showinfo(
    "äº¤å‰æª¢æŸ¥çµæœ\nCross Check Result",
     f"æ‰¾ä¸åˆ° email_bodies_log.txtï¼\nEmail log not found!\n\n{debug_info}")
            return
        # 1. è®€å– OUTLET mapping
        outlet_map = {}
        unknown_records = []  # æ”¶é›† unknown éƒµä»¶è³‡è¨Š
        if os.path.exists(config_path):
            try:
                df = pd.read_excel(config_path, sheet_name=None)
                outlet_df = None
                for key in df.keys():
                    if key.strip().lower() in ["outlets", "outlet"]:
                        outlet_df = df[key]
                        break
                if outlet_df is not None:
                    for _, row in outlet_df.iterrows():
                        short = str(
    row[0]).strip().upper() if pd.notna(
        row[0]) else ''
                        full = str(row[1]).strip() if pd.notna(row[1]) else ''
                        email = str(
    row[2]).strip().lower() if pd.notna(
        row[2]) else ''
                        # æ”¯æ´ Alias/Keyword æ¬„ï¼ˆç¬¬4æ¬„æˆ–ç¬¬5æ¬„ï¼Œå…è¨±å¤šå€‹é€—è™Ÿåˆ†éš”ï¼‰
                        alias_col = None
                        for idx in range(3, len(row)):
                            colname = str(
    outlet_df.columns[idx]).strip().lower()
                            if colname in ["alias", "keyword", "åˆ¥å", "é—œéµå­—"]:
                                alias_col = idx
                                break
                        aliases = []
                        if alias_col is not None and pd.notna(row[alias_col]):
                            aliases = [
    a.strip() for a in str(
        row[alias_col]).split(",") if a.strip()]
                        # å»ºç«‹ mapping
                        for key in [short, full, email] + aliases:
                            k = key.strip().lower().replace(" ", "")
                            if k:
                                outlet_map[k] = short
            except Exception as e:
                print(f"[DEBUG] è®€ config å‡ºéŒ¯: {e}")

        def normalize_name(name):
            if not name:
                return ""
            import re
            name = re.sub(r'\(.*?\)', '', name)
            name = re.sub(r'update', '', name, flags=re.IGNORECASE)
            name = re.sub(r'[^a-zA-Z0-9]', '', name)
            return name.strip().upper()
        
        def normalize_supplier_name(name):
            """æ ‡å‡†åŒ–ä¾›åº”å•†åç§°ï¼Œå¤„ç†å˜ä½“"""
            if not name:
                return ""
            
            # è½¬æ¢ä¸ºå°å†™å¹¶å»é™¤å¤šä½™ç©ºæ ¼
            name = name.strip().lower()
            
            # å¤„ç†å¸¸è§çš„ä¾›åº”å•†åç§°å˜ä½“
            replacements = {
                'super q (chawanmushi)': 'super q (chawan)',
                'super q chawanmushi': 'super q (chawan)',
                'super q chawan': 'super q (chawan)',
                'super q(chawan)': 'super q (chawan)',
                'super q (chawanmushi)': 'super q (chawan)',
                'chawanmushi': 'super q (chawan)',
            }
            
            # åº”ç”¨æ›¿æ¢
            for variant, standard in replacements.items():
                if variant in name:
                    name = name.replace(variant, standard)
            
            return name.strip()

        def is_supplier_match(s1, s2):
            # æ ‡å‡†åŒ–å¤„ç†ï¼šç§»é™¤æ•°å­—å‰ç¼€ï¼Œè½¬æ¢ä¸ºå¤§å†™ï¼Œç§»é™¤å¤šä½™ç©ºæ ¼
            def clean_name(name):
                # ç§»é™¤æ•°å­—å‰ç¼€ï¼ˆå¦‚ "1, CHANG CHENG" -> "CHANG CHENG"ï¼‰
                name = re.sub(r'^\d+[,.\s]*', '', name).strip()
                # ç§»é™¤å…¬å¸åç¼€ï¼ˆå¦‚ "PTE LTD", "LTD", "INC" ç­‰ï¼‰
                name = re.sub(r'\s+(PTE\s+LTD|LTD|INC|CORP|COMPANY|CO\.?)\s*$', '', name, flags=re.IGNORECASE)
                # ç§»é™¤æ‹¬å·åŠå…¶å†…å®¹ï¼ˆå¦‚ "Perfect Choice (Chawan)" -> "Perfect Choice"ï¼‰
                name = re.sub(r'\s*\([^)]*\)\s*', '', name)
                # ç§»é™¤å¤šä½™ç©ºæ ¼ï¼Œè½¬æ¢ä¸ºå¤§å†™
                name = re.sub(r'\s+', ' ', name.strip().upper())
                return name
            
            # é¦–å…ˆä½¿ç”¨ä¾›åº”å•†åç§°æ ‡å‡†åŒ–
            s1_normalized = normalize_supplier_name(s1)
            s2_normalized = normalize_supplier_name(s2)
            
            # å¦‚æœæ ‡å‡†åŒ–åç›¸åŒï¼Œç›´æ¥è¿”å›True
            if s1_normalized.lower() == s2_normalized.lower():
                print(f"[DEBUG] âœ“ ä¾›åº”å•†æ ‡å‡†åŒ–åŒ¹é…: '{s1}' -> '{s1_normalized}' == '{s2}' -> '{s2_normalized}'")
                return True
            
            # ç„¶åä½¿ç”¨åŸæœ‰çš„clean_nameé€»è¾‘
            n1, n2 = clean_name(s1), clean_name(s2)
            
            # å®Œå…¨åŒ¹é…
            if n1 == n2:
                return True
            
            # å­å­—ç¬¦ä¸²åŒ¹é…ï¼ˆåŒ…å«å…³ç³»ï¼‰
            if n1 in n2 or n2 in n1:
                return True
            
            # æ¨¡ç³ŠåŒ¹é…ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è‡³å°‘3ä¸ªè¿ç»­å­—ç¬¦ç›¸åŒ
            def has_common_substring(str1, str2, min_length=3):
                """æ£€æŸ¥ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æœ‰è‡³å°‘min_lengthä¸ªè¿ç»­å­—ç¬¦ç›¸åŒ"""
                if len(str1) < min_length or len(str2) < min_length:
                    return False
                
                # æ£€æŸ¥str1çš„æ¯ä¸ªå­ä¸²æ˜¯å¦åœ¨str2ä¸­
                for i in range(len(str1) - min_length + 1):
                    substring = str1[i:i + min_length]
                    if substring in str2:
                        return True
                
                # æ£€æŸ¥str2çš„æ¯ä¸ªå­ä¸²æ˜¯å¦åœ¨str1ä¸­
                for i in range(len(str2) - min_length + 1):
                    substring = str2[i:i + min_length]
                    if substring in str1:
                        return True
                
                return False
            
            # ä½¿ç”¨æ›´ä¸¥æ ¼çš„æ¨¡ç³ŠåŒ¹é…
            # åªæœ‰å½“æ¸…ç†åçš„åç§°é•¿åº¦ç›¸ä¼¼æ—¶æ‰è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
            if len(n1) >= 6 and len(n2) >= 6:  # è‡³å°‘6ä¸ªå­—ç¬¦æ‰è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
                if has_common_substring(n1, n2, 4):  # è‡³å°‘4ä¸ªå­—ç¬¦åŒ¹é…
                    # é¢å¤–æ£€æŸ¥ï¼šç¡®ä¿åŒ¹é…çš„éƒ¨åˆ†å æ€»é•¿åº¦çš„åˆç†æ¯”ä¾‹
                    common_length = 0
                    for i in range(len(n1) - 3):
                        substring = n1[i:i + 4]
                        if substring in n2:
                            common_length = max(common_length, len(substring))
                    
                    if common_length >= 4 and common_length >= min(len(n1), len(n2)) * 0.6:
                        return True
            
            # æ£€æŸ¥å‰4ä¸ªå­—ç¬¦åŒ¹é…ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
            if len(n1) >= 4 and len(n2) >= 4:
                if n1[:4] == n2[:4]:
                    return True
            
            return False

        def is_cover_status_ok(status):
            return any(x in status for x in ['âœ”', 'âœ“'])
        # ===== Outlet mapping èˆ‡æ–°ç‰ˆæ¯”å° function =====
        short_to_full = {}
        full_to_short = {}
        email_name_to_short = {}
        outlet_all_names = set()
        # ä¿®æ­£ master_config æœªå®šä¹‰ä¸º config_path
        if os.path.exists(config_path):
            try:
                df = pd.read_excel(config_path, sheet_name=None)
                outlet_df = None
                for key in df.keys():
                    if key.strip().lower() == "outlet":
                        outlet_df = df[key]
                        break
                if outlet_df is not None:
                    for _, row in outlet_df.iterrows():
                        short = str(row.get("Short Name", "")).strip()
                        full = str(row.get("Outlet Full Name", "")).strip()
                        email_name = str(row.get("Name in Email", "")).strip()
                        n_short = normalize_name(short)
                        n_full = normalize_name(full)
                        n_email = normalize_name(email_name)
                        if short:
                            short_to_full[n_short] = full
                            outlet_all_names.add(n_short)
                        if full:
                            full_to_short[n_full] = short
                            outlet_all_names.add(n_full)
                        if email_name:
                            email_name_to_short[n_email] = short
                            outlet_all_names.add(n_email)
            except Exception as e:
                print("Outlet mapping read error:", e)

        def is_outlet_match(req_outlet, ordered_outlet):
            n_req = normalize_name(req_outlet)
            n_ordered = normalize_name(ordered_outlet)
            # ä¸‰è€…ä»»å…©å€‹ normalize å¾Œæœ‰ match å°± True
            if n_req and n_ordered and n_req == n_ordered:
                return True
            if n_req in outlet_all_names or n_ordered in outlet_all_names:
                return True
            for n in outlet_all_names:
                if n == n_req or n == n_ordered:
                    return True
            return False
        # 2. è§£æ email log
        with open(email_log_path, "r", encoding="utf-8") as f:
            content = f.read()
        
        # è°ƒè¯•ï¼šæ˜¾ç¤ºé‚®ä»¶å†…å®¹
        print(f"[DEBUG] é‚®ä»¶å†…å®¹å‰500å­—ç¬¦:")
        print(content[:500])
        print(f"[DEBUG] é‚®ä»¶å†…å®¹æ€»é•¿åº¦: {len(content)} å­—ç¬¦")
        
        outlet_results = {}
        import re
        
        # å°è¯•ä¸åŒçš„åˆ†å‰²ç¬¦
        split_patterns = [
            r"â€”â€”â€” ?é‚®ä»¶ ?\d+ ?â€”â€”â€”",  # åŸæ ¼å¼
            r"â€”â€”â€” ?éƒµä»¶ ?\d+ ?â€”â€”â€”",  # ç¹ä½“
            r"â€”â€”â€”é‚®ä»¶\d+â€”â€”â€”",        # æ— ç©ºæ ¼
            r"â€”â€”â€”éƒµä»¶\d+â€”â€”â€”",        # ç¹ä½“æ— ç©ºæ ¼
        ]
        
        blocks = []
        used_pattern = None
        for pattern in split_patterns:
            if re.search(pattern, content):
                blocks = re.split(pattern, content)
                used_pattern = pattern
                print(f"[DEBUG] ä½¿ç”¨åˆ†å‰²ç¬¦: {pattern}, æ‰¾åˆ° {len(blocks)} ä¸ªé‚®ä»¶å—")
                break
        
        if not blocks:
            print("[DEBUG] æœªæ‰¾åˆ°æ ‡å‡†åˆ†å‰²ç¬¦ï¼Œå°è¯•æŒ‰æ®µè½åˆ†å‰²")
            blocks = content.split("\n\n")
        
        print(f"[DEBUG] æ€»å…± {len(blocks)} ä¸ªé‚®ä»¶å—")
        for i, block in enumerate(blocks):
            print(f"\n--- é‚®ä»¶å— {i} ---")
            lines = [l.strip() for l in block.strip().splitlines() if l.strip()]
            if not lines or len(lines) < 2:
                print(f"  è·³è¿‡é‚®ä»¶å— {i}ï¼šè¡Œæ•°ä¸è¶³")
                continue
            
            print(f"  é‚®ä»¶å— {i} å†…å®¹é¢„è§ˆ:")
            print(f"  {lines[:3]}...")  # æ˜¾ç¤ºå‰3è¡Œ
            
            outlet_raw = ""
            for l in lines:
                m = re.match(r"\[å‘ä»¶äºº\](.+)", l)
                if m:
                    outlet_raw = m.group(1).strip()
                    break
                # ä¹Ÿå°è¯•ç¹ä½“æ ¼å¼
                m2 = re.match(r"\[ç™¼ä»¶äºº\](.+)", l)
                if m2:
                    outlet_raw = m2.group(1).strip()
                    break
            
            if not outlet_raw:
                print(f"  è·³è¿‡é‚®ä»¶å— {i}ï¼šæœªæ‰¾åˆ°å‘ä»¶äºº")
                continue
            
            print(f"  æ‰¾åˆ°é—¨å¸‚: {outlet_raw}")
            
            # ä½¿ç”¨ä¸ä¸‹è½½é€»è¾‘å®Œå…¨ä¸€è‡´çš„é—¨å¸‚åŒ¹é…
            def find_outlet_using_download_logic(sender_name, config_path):
                """ä½¿ç”¨ OUTLET sheetï¼ˆå«è¡¨å¤´ï¼‰å°†é‚®ç®±/åç§°æ˜ å°„ä¸º Short Code ä¸ Full Name"""
                if not os.path.exists(config_path):
                    return sender_name, sender_name
                try:
                    sheets = pd.read_excel(config_path, sheet_name=None)
                    outlet_df = None
                    for name, df in sheets.items():
                        if str(name).strip().lower() == "outlet":
                            outlet_df = df
                            break
                    if outlet_df is None:
                        # å…¼å®¹æ—  sheet åæ—¶çš„å•è¡¨
                        outlet_df = next(iter(sheets.values()))

                    # è§„èŒƒåˆ—å
                    cols = {c.strip().lower(): c for c in outlet_df.columns if isinstance(c, str)}
                    c_short = cols.get("short name") or cols.get("short") or list(outlet_df.columns)[0]
                    c_full = cols.get("outlet full name") or cols.get("full name") or list(outlet_df.columns)[1]
                    c_email = cols.get("email") or list(outlet_df.columns)[2]
                    c_name_in_email = cols.get("name in email") or cols.get("name") or (list(outlet_df.columns)[4] if len(outlet_df.columns) > 4 else c_full)

                    email_to_short = {}
                    name_to_short = {}
                    fullname_to_short = {}
                    short_to_full = {}
                    def norm(s):
                        return re.sub(r"\s+", "", str(s).strip().lower()) if isinstance(s, str) else ""
                    for _, r in outlet_df.iterrows():
                        short = str(r.get(c_short, '')).strip()
                        full = str(r.get(c_full, '')).strip()
                        email = str(r.get(c_email, '')).strip().lower()
                        name_in_email = str(r.get(c_name_in_email, '')).strip().lower()
                        if short:
                            if email:
                                email_to_short[email] = short
                            if name_in_email:
                                name_to_short[name_in_email] = short
                            if full:
                                fullname_to_short[norm(full)] = short
                            short_to_full[short] = full or short

                    sender_lower = sender_name.strip().lower()
                    sender_norm = norm(sender_name)
                    if sender_lower in email_to_short:
                        s = email_to_short[sender_lower]
                        return s, short_to_full.get(s, s)
                    if sender_lower in name_to_short:
                        s = name_to_short[sender_lower]
                        return s, short_to_full.get(s, s)
                    # æ¨¡ç³ŠåŒ…å«ï¼šName in Email æˆ– Full Name å‡ºç¾åœ¨ sender æˆ–å…¶ç›¸ååŒ…å«
                    for k, s in name_to_short.items():
                        kn = norm(k)
                        if kn and (kn in sender_norm or sender_norm in kn):
                            return s, short_to_full.get(s, s)
                    for k, s in fullname_to_short.items():
                        if k and (k in sender_norm or sender_norm in k):
                            return s, short_to_full.get(s, s)
                    return sender_name, sender_name
                except Exception as e:
                    print(f"    âœ— åŒ¹é…é—¨å¸‚æ—¶å‡ºé”™: {e}")
                    return sender_name, sender_name
            
            # ä½¿ç”¨ä¸ä¸‹è½½é€»è¾‘ä¸€è‡´çš„åŒ¹é…
            if outlet_raw:
                outlet_short, outlet_full = find_outlet_using_download_logic(outlet_raw, config_path)
                # ä½¿ç”¨é–€å¸‚ç°¡ç¨±ï¼ˆå¦‚ SKG/HGMï¼‰ä»¥èˆ‡ä¸»è¡¨ä¸€è‡´
                outlet = outlet_short or outlet_full or ""
            else:
                outlet = ""
            
            # ä½¿ç”¨Short Nameä½œä¸ºé—¨å¸‚æ ‡è¯†ï¼ˆä¸checklistä¿æŒä¸€è‡´ï¼‰
            display_outlet = outlet_short if outlet_short else outlet_full
            
            # æ™ºèƒ½ä¾›åº”å•†è§£æé€»è¾‘
            def is_valid_supplier_name(text):
                """åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ä¾›åº”å•†åç§°"""
                text = text.strip()
                if not text or len(text) < 2:
                    return False
                
                # æ’é™¤æ˜æ˜¾ä¸æ˜¯ä¾›åº”å•†çš„å†…å®¹
                exclude_patterns = [
                    # é—®å€™è¯­å’Œç¤¼è²Œç”¨è¯­
                    r'^(hi|hello|dear|good\s+(morning|afternoon|day|evening))',
                    r'(please|kindly|thank\s+you|thanks|regards|best\s+regards)',
                    r'(see\s+attached|please\s+see|attached\s+file)',
                    
                    # æ—¥æœŸå’Œæ—¶é—´æ ¼å¼
                    r'^\d{1,2}[/-]\d{1,2}[/-]\d{2,4}',
                    r'^\d{4}[/-]\d{1,2}[/-]\d{1,2}',
                    r'^\d{1,2}:\d{2}',
                    
                    # é‚®ä»¶ç›¸å…³
                    r'^(from|to|subject|date):',
                    r'@\w+\.\w+',  # é‚®ç®±åœ°å€
                    r'http[s]?://',  # ç½‘å€
                    r'www\.',
                    
                    # è¯´æ˜æ€§æ–‡å­—
                    r'(supplier|suppliers)\s+as\s+below',
                    r'delivery\s+as\s+below',
                    r'as\s+below',
                    r'below:',
                    r'order\s+form',
                    r'weekly\s+order',
                    
                    # ç¬¦å·å’Œæ•°å­—
                    r'^[\d\s\-_.,()]+$',
                ]
                
                text_lower = text.lower()
                for pattern in exclude_patterns:
                    if re.search(pattern, text_lower):
                        return False
                
                # å¿…é¡»åŒ…å«å­—æ¯
                if not re.search(r'[a-zA-Z]', text):
                    return False
                
                # å­—æ¯æ•°é‡è‡³å°‘å 50%
                alpha_count = len([c for c in text if c.isalpha()])
                if alpha_count < len(text) * 0.5:
                    return False
                
                return True
            
            def extract_suppliers_from_text(lines):
                """ä»æ–‡æœ¬è¡Œä¸­æå–ä¾›åº”å•†åç§°"""
                suppliers = []
                in_content_section = False
                
                print(f"  å¼€å§‹æ™ºèƒ½è§£æä¾›åº”å•†ï¼Œæ€»å…± {len(lines)} è¡Œ:")
                
                for i, line in enumerate(lines):
                    print(f"    è¡Œ {i+1}: '{line}'")
                    
                    # æ£€æŸ¥æ˜¯å¦è¿›å…¥å†…å®¹åŒºåŸŸ
                    if "[å†…å®¹]" in line or "[å…§å®¹]" in line:
                        in_content_section = True
                        print(f"      -> è¿›å…¥å†…å®¹åŒºåŸŸ")
                        continue
                    
                    if in_content_section:
                        line = line.strip()
                        if not line or line.startswith("[") or line.startswith("â€”â€”â€”"):
                            print(f"      -> è·³è¿‡ç©ºè¡Œæˆ–æ ‡é¢˜: {line}")
                            continue
                        
                        # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆä¾›åº”å•†åç§°
                        if is_valid_supplier_name(line):
                            # å¤„ç†æ•°å­—æ ¼å¼ï¼š1) supplier, 2) supplier æˆ– 1. supplier, 2. supplier
                            m1 = re.match(r"\d+\)\s*(.+)", line)
                            m2 = re.match(r"\d+\.\s*(.+)", line)
                            
                            if m1:
                                supplier_name = m1.group(1).strip()
                                if is_valid_supplier_name(supplier_name):
                                    # ä½¿ç”¨ä¾›åº”å•†åç§°æ ‡å‡†åŒ–
                                    normalized_name = normalize_supplier_name(supplier_name)
                                    suppliers.append(normalized_name)
                                    print(f"      -> âœ“ æ·»åŠ æ•°å­—æ ¼å¼ä¾›åº”å•†: {supplier_name} -> {normalized_name}")
                                else:
                                    print(f"      -> âœ— è·³è¿‡æ— æ•ˆæ•°å­—æ ¼å¼: {supplier_name}")
                            elif m2:
                                supplier_name = m2.group(1).strip()
                                if is_valid_supplier_name(supplier_name):
                                    # ä½¿ç”¨ä¾›åº”å•†åç§°æ ‡å‡†åŒ–
                                    normalized_name = normalize_supplier_name(supplier_name)
                                    suppliers.append(normalized_name)
                                    print(f"      -> âœ“ æ·»åŠ æ•°å­—æ ¼å¼ä¾›åº”å•†: {supplier_name} -> {normalized_name}")
                                else:
                                    print(f"      -> âœ— è·³è¿‡æ— æ•ˆæ•°å­—æ ¼å¼: {supplier_name}")
                            else:
                                # ç›´æ¥çš„ä¾›åº”å•†åç§°
                                normalized_name = normalize_supplier_name(line)
                                suppliers.append(normalized_name)
                                print(f"      -> âœ“ æ·»åŠ ç›´æ¥ä¾›åº”å•†: {line} -> {normalized_name}")
                        else:
                            print(f"      -> âœ— è·³è¿‡æ— æ•ˆå†…å®¹: {line}")
                
                return suppliers
            
            # ä½¿ç”¨æ™ºèƒ½è§£æ
            claimed = extract_suppliers_from_text(lines)
            
            # å¦‚æœæ™ºèƒ½è§£ææ²¡æœ‰æ‰¾åˆ°ä¾›åº”å•†ï¼Œå°è¯•ç®€å•è§£æ
            if not claimed:
                print(f"  -> æ™ºèƒ½è§£ææœªæ‰¾åˆ°ä¾›åº”å•†ï¼Œå°è¯•ç®€å•è§£æ:")
                for i, line in enumerate(lines):
                    m = re.match(r"\d+\.\s*(.+)", line)
                    if m:
                        supplier_name = m.group(1).strip()
                        if is_valid_supplier_name(supplier_name):
                            claimed.append(supplier_name)
                            print(f"    è¡Œ {i+1}: âœ“ æ·»åŠ ç®€å•æ ¼å¼ä¾›åº”å•†: {supplier_name}")
                        else:
                            print(f"    è¡Œ {i+1}: âœ— è·³è¿‡æ— æ•ˆç®€å•æ ¼å¼: {supplier_name}")
            
            print(f"  -> æœ€ç»ˆè§£æåˆ°ä¾›åº”å•†: {claimed}")
            found = set()
            for row in table:
                row_outlet_norm = normalize_name(row["outlet"])
                # outlet æ¯”å°åŠ å¼·ï¼šå…è¨± substring/å‰4ç¢¼
                outlet_match = is_outlet_match(row["outlet"], outlet_full)
                for s in claimed:
                    supplier_match = is_supplier_match(row["supplier"], s)
                    cover_ok = is_cover_status_ok(row["cover_status"])
                    print(
    f"[DEBUG] æ¯”å°: supplier: {
        normalize_name(
            row['supplier'])} <-> {
                normalize_name(s)} | outlet: {
                    row['outlet']} <-> {outlet_full} | outlet_match: {outlet_match} | cover: {
                        row['cover_status']} => {cover_ok}")
                    if outlet_full and outlet_match and supplier_match and cover_ok:
                        found.add(s)
            if claimed:  # åªæœ‰å½“æ‰¾åˆ°ä¾›åº”å•†æ—¶æ‰æ·»åŠ ç»“æœ
                outlet_results[display_outlet] = []
                for supplier in claimed:
                    if supplier in found:
                        outlet_results[display_outlet].append((supplier, True))
                    else:
                        outlet_results[display_outlet].append((supplier, False))
                print(f"  æœ€ç»ˆç»“æœ: {outlet_full} -> {len(claimed)} ä¸ªä¾›åº”å•†")
            else:
                print(f"  è·³è¿‡ {outlet_full}ï¼šæœªæ‰¾åˆ°ä¾›åº”å•†")
        
        print(f"\n[DEBUG] æœ€ç»ˆè§£æç»“æœ:")
        print(f"æ€»å…±è§£æåˆ° {len(outlet_results)} ä¸ªé—¨å¸‚")
        print(f"Checklistä¸­çš„é—¨å¸‚æ€»æ•°: {len(set(row['outlet'] for row in table))}")
        print(f"Checklistä¸­çš„é—¨å¸‚: {sorted(set(row['outlet'] for row in table))}")
        
        for outlet, suppliers in outlet_results.items():
            print(f"  {outlet}: {len(suppliers)} ä¸ªä¾›åº”å•†")
            for supplier, status in suppliers:
                print(f"    {supplier}: {'âœ“' if status else 'âœ—'}")
        
        print(f"\n[DEBUG] é€ä¸€æ ¸å¯¹ç»“æœ:")
        for outlet, suppliers in outlet_results.items():
            print(f"\n--- é—¨å¸‚: {outlet} ---")
            print(f"é‚®ä»¶ä¸­çš„ä¾›åº”å•†: {[s for s, _ in suppliers]}")
            
            # æŸ¥æ‰¾checklistä¸­å¯¹åº”çš„é—¨å¸‚
            checklist_suppliers = []
            for row in table:
                if row["outlet"] == outlet and row["cover_status"] == "âœ”ï¸":
                    checklist_suppliers.append(row["supplier"])
            
            print(f"Checklistä¸­çš„ä¾›åº”å•†: {checklist_suppliers}")
            
            # è¯¦ç»†å¯¹æ¯”
            email_suppliers_set = set([s for s, _ in suppliers])
            checklist_suppliers_set = set(checklist_suppliers)
            
            # print(f"é‚®ä»¶æœ‰ä½†Checklistæ— : {email_suppliers_set - checklist_suppliers_set}")
            # print(f"Checklistæœ‰ä½†é‚®ä»¶æ— : {checklist_suppliers_set - email_suppliers_set}")
            # print(f"å…±åŒä¾›åº”å•†: {email_suppliers_set & checklist_suppliers_set}")
        # åˆ›å»ºç”¨æˆ·æƒ³è¦çš„è¡¨æ ¼æ ¼å¼ï¼šé—¨å¸‚ | email ä¸‹å–® | å¯¦éš›è¨‚å–® | ç‹€æ…‹
        # æ”¶é›†æ‰€æœ‰é—¨å¸‚ï¼ˆåŒ…æ‹¬é‚®ä»¶ä¸­å’Œchecklistä¸­çš„ï¼‰
        all_outlets = set()
        
        # ä»é‚®ä»¶ä¸­æ”¶é›†é—¨å¸‚
        for outlet in outlet_results.keys():
            all_outlets.add(outlet)
        
        # ä»checklistä¸­æ”¶é›†é—¨å¸‚
        for row in table:
            all_outlets.add(row["outlet"])
        
        print(f"[DEBUG] æ‰€æœ‰é—¨å¸‚æ€»æ•°: {len(all_outlets)}")
        print(f"[DEBUG] é‚®ä»¶ä¸­çš„é—¨å¸‚: {len(outlet_results)}")
        print(f"[DEBUG] Checklistä¸­çš„é—¨å¸‚: {len(set(row['outlet'] for row in table))}")
        
        # åˆ›å»ºé—¨å¸‚åç§°æ˜ å°„ï¼Œè§£å†³ short name å’Œ full name ä¸ä¸€è‡´çš„é—®é¢˜
        def normalize_outlet_name_for_matching(name):
            """æ ‡å‡†åŒ–é—¨å¸‚åç§°ç”¨äºåŒ¹é…"""
            if not name:
                return ""
            
            # ç§»é™¤å¸¸è§å‰ç¼€
            name = re.sub(r'^sushi\s+express\s*', '', name, flags=re.IGNORECASE)
            name = name.strip()
            
            # ç§»é™¤å¸¸è§åç¼€
            name = re.sub(r'\s*mall\s*$', '', name, flags=re.IGNORECASE)
            name = re.sub(r'\s*square\s*$', '', name, flags=re.IGNORECASE)
            name = re.sub(r'\s*centre\s*$', '', name, flags=re.IGNORECASE)
            name = re.sub(r'\s*center\s*$', '', name, flags=re.IGNORECASE)
            
            # ç»Ÿä¸€ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
            name = re.sub(r'\s+', ' ', name.strip())
            
            # è½¬æ¢ä¸ºå°å†™è¿›è¡Œæ¯”è¾ƒ
            return name.lower()
        
        # åˆ›å»ºé—¨å¸‚æ˜ å°„è¡¨ï¼šæ ‡å‡†åç§° -> (é‚®ä»¶ä¸­çš„åç§°, checklistä¸­çš„åç§°)
        outlet_mapping = {}
        
        # æ”¶é›†æ‰€æœ‰é—¨å¸‚åç§°
        for outlet in all_outlets:
            normalized = normalize_outlet_name_for_matching(outlet)
            if normalized not in outlet_mapping:
                outlet_mapping[normalized] = {'email': None, 'checklist': None}
            
            # åˆ¤æ–­è¿™ä¸ªoutletæ¥è‡ªé‚®ä»¶è¿˜æ˜¯checklist
            if outlet in outlet_results:
                outlet_mapping[normalized]['email'] = outlet
            else:
                outlet_mapping[normalized]['checklist'] = outlet
        
        # å¤„ç†checklistä¸­çš„outlet
        for row in table:
            outlet = row["outlet"]
            normalized = normalize_outlet_name_for_matching(outlet)
            if normalized not in outlet_mapping:
                outlet_mapping[normalized] = {'email': None, 'checklist': None}
            outlet_mapping[normalized]['checklist'] = outlet
        
        print(f"\n[DEBUG] é—¨å¸‚æ˜ å°„è¡¨:")
        for norm_name, mapping in outlet_mapping.items():
            print(f"  '{norm_name}': email='{mapping['email']}', checklist='{mapping['checklist']}'")
        
        # print(f"\n[DEBUG] é‚®ä»¶ä¸­çš„é—¨å¸‚è¯¦æƒ…:")
        # for outlet, suppliers in outlet_results.items():
        #     print(f"  '{outlet}': {len(suppliers)} ä¸ªä¾›åº”å•†")
        
        print(f"\n[DEBUG] Checklistä¸­çš„é—¨å¸‚è¯¦æƒ…:")
        checklist_outlets = {}
        for row in table:
            outlet = row["outlet"]
            if outlet not in checklist_outlets:
                checklist_outlets[outlet] = []
            if row["cover_status"] == "âœ”ï¸":
                checklist_outlets[outlet].append(row["supplier"])
        
        for outlet, suppliers in checklist_outlets.items():
            print(f"  '{outlet}': {len(suppliers)} ä¸ªä¾›åº”å•†")
        
        # æ ¹æ®configåˆ›å»ºé—¨å¸‚æ˜ å°„è¡¨ï¼Œä½¿ç”¨Short Nameå’ŒOutlet Full Name
        def create_outlet_mapping_from_config(config_path):
            """æ ¹æ®configåˆ›å»ºé—¨å¸‚æ˜ å°„è¡¨"""
            outlet_mapping = {}  # short_name -> full_name
            email_to_short = {}  # email -> short_name
            name_to_short = {}   # name_in_email -> short_name
            
            if config_path and os.path.exists(config_path):
                try:
                    df = pd.read_excel(config_path)
                    for _, row in df.iterrows():
                        short_name = str(row.iloc[0]).strip() if len(row) > 0 and not pd.isna(row.iloc[0]) else ''
                        full_name = str(row.iloc[1]).strip() if len(row) > 1 and not pd.isna(row.iloc[1]) else ''
                        email = str(row.iloc[2]).strip().lower() if len(row) > 2 and not pd.isna(row.iloc[2]) else ''
                        name_in_email = str(row.iloc[4]).strip().lower() if len(row) > 4 and not pd.isna(row.iloc[4]) else ''
                        
                        if short_name and full_name:
                            outlet_mapping[short_name] = full_name
                        
                        if email and short_name:
                            email_to_short[email] = short_name
                        
                        if name_in_email and short_name:
                            name_to_short[name_in_email] = short_name
                            
                except Exception as e:
                    print(f"[DEBUG] è¯»å–configå¤±è´¥: {e}")
            
            return outlet_mapping, email_to_short, name_to_short
        
        # åˆ›å»ºconfigæ˜ å°„è¡¨
        config_outlet_mapping, config_email_to_short, config_name_to_short = create_outlet_mapping_from_config(config_path)
        
        print(f"\n[DEBUG] Configé—¨å¸‚æ˜ å°„:")
        for short_name, full_name in config_outlet_mapping.items():
            print(f"  '{short_name}' -> '{full_name}'")
        
        # print(f"\n[DEBUG] Emailæ˜ å°„æ•°é‡: {len(config_email_to_short)}")
        # print(f"[DEBUG] Nameæ˜ å°„æ•°é‡: {len(config_name_to_short)}")
        
        # åˆ›å»ºè¯¦ç»†çš„å¯¹æ¯”è¡¨æ ¼ï¼ˆæŒ‰ä¾›åº”å•†çº§åˆ«ï¼‰
        table_data = []
        
        # æ”¶é›†æ‰€æœ‰ä¾›åº”å•†
        all_suppliers = set()
        
        # ä»é‚®ä»¶ä¸­æ”¶é›†ä¾›åº”å•†
        email_suppliers_by_outlet = {}
        for outlet, suppliers in outlet_results.items():
            email_suppliers_by_outlet[outlet] = [supplier for supplier, _ in suppliers]
            all_suppliers.update(email_suppliers_by_outlet[outlet])
        
        # ä»checklistä¸­æ”¶é›†ä¾›åº”å•†
        checklist_suppliers_by_outlet = {}
        for row in table:
            if row["cover_status"] == "âœ”ï¸":
                outlet = row["outlet"]
                supplier = row["supplier"]
                if outlet not in checklist_suppliers_by_outlet:
                    checklist_suppliers_by_outlet[outlet] = []
                checklist_suppliers_by_outlet[outlet].append(supplier)
                all_suppliers.add(supplier)
        
        # ä¸ºæ¯ä¸ªé—¨å¸‚åˆ›å»ºå¯¹æ¯”è¡¨æ ¼
        for outlet in sorted(set(list(email_suppliers_by_outlet.keys()) + list(checklist_suppliers_by_outlet.keys()))):
            email_suppliers = email_suppliers_by_outlet.get(outlet, [])
            checklist_suppliers = checklist_suppliers_by_outlet.get(outlet, [])
            
            # print(f"\n[DEBUG] å¤„ç†é—¨å¸‚: {outlet}")
            # print(f"  é‚®ä»¶ä¾›åº”å•†: {email_suppliers}")
            # print(f"  å®é™…ä¾›åº”å•†: {checklist_suppliers}")
            
            # æ˜¾ç¤ºæ¸…ç†åçš„åç§°ç”¨äºè°ƒè¯•
            def clean_name_for_debug(name):
                name = re.sub(r'^\d+[,.\s]*', '', name).strip()
                name = re.sub(r'\s+(PTE\s+LTD|LTD|INC|CORP|COMPANY|CO\.?)\s*$', '', name, flags=re.IGNORECASE)
                name = re.sub(r'\s*\([^)]*\)\s*', '', name)
                name = re.sub(r'\s+', ' ', name.strip().upper())
                return name
            
            # print(f"  é‚®ä»¶ä¾›åº”å•†(æ¸…ç†å): {[clean_name_for_debug(s) for s in email_suppliers]}")
            # print(f"  å®é™…ä¾›åº”å•†(æ¸…ç†å): {[clean_name_for_debug(s) for s in checklist_suppliers]}")
            
            # åˆ›å»ºåŒ¹é…æ˜ å°„
            matched_pairs = set()  # (email_supplier, actual_supplier) é…å¯¹
            unmatched_email = set(email_suppliers)
            unmatched_actual = set(checklist_suppliers)
            
            # æ™ºèƒ½åŒ¹é…ï¼šæ£€æŸ¥æ¯ä¸ªé‚®ä»¶ä¾›åº”å•†æ˜¯å¦åŒ¹é…ä»»ä½•å®é™…ä¾›åº”å•†
            for email_supplier in email_suppliers:
                best_match = None
                for actual_supplier in checklist_suppliers:
                    if is_supplier_match(email_supplier, actual_supplier):
                        # é€‰æ‹©æœ€ä½³åŒ¹é…ï¼ˆä¼˜å…ˆé€‰æ‹©å®Œå…¨åŒ¹é…æˆ–æ›´é•¿çš„åŒ¹é…ï¼‰
                        if best_match is None or len(actual_supplier) > len(best_match):
                            best_match = actual_supplier
                
                if best_match:
                    matched_pairs.add((email_supplier, best_match))
                    unmatched_email.discard(email_supplier)
                    unmatched_actual.discard(best_match)
                    # print(f"  âœ“ åŒ¹é…: '{email_supplier}' <-> '{best_match}'")
            
            # æ·»åŠ åŒ¹é…çš„è¡Œ
            for email_supplier, actual_supplier in matched_pairs:
                table_data.append((
                    outlet,
                    email_supplier,
                    actual_supplier,
                    "âœ“"
                ))
            
            # æ·»åŠ æœªåŒ¹é…çš„é‚®ä»¶ä¾›åº”å•†
            for email_supplier in unmatched_email:
                table_data.append((
                    outlet,
                    email_supplier,
                    "X",
                    "X å¯¦éš›å¹¶æ²’æœ‰è¨‚å–®"
                ))
                # print(f"  âœ— é‚®ä»¶æœ‰ä½†å®é™…æ²¡æœ‰: '{email_supplier}'")
            
            # æ·»åŠ æœªåŒ¹é…çš„å®é™…ä¾›åº”å•†
            for actual_supplier in unmatched_actual:
                table_data.append((
                    outlet,
                    "X",
                    actual_supplier,
                    "X Email å¹¶æ²’æœ‰ä¸‹å–®"
                ))
                print(f"  âœ— å®é™…æœ‰ä½†é‚®ä»¶æ²¡æœ‰: '{actual_supplier}'")

        class CrossCheckResultTable(ctk.CTkToplevel):
            def __init__(self, master, table_data):
                super().__init__(master)
                self.title("äº¤å‰æª¢æŸ¥çµæœ\nCross Check Result")
                self.geometry("1000x600")
                self.search_var = ctk.StringVar()
                ctk.CTkLabel(
                    self, text="æœå°‹é–€å¸‚\nSearch Outlet").pack(pady=(10, 0))
                search_entry = ctk.CTkEntry(self, textvariable=self.search_var)
                search_entry.pack(fill="x", padx=10)
                search_entry.bind("<KeyRelease>", self.update_filter)
                import tkinter as tk
                from tkinter import ttk
                frame = ctk.CTkFrame(self)
                frame.pack(fill="both", expand=True, padx=10, pady=10)
                columns = ("outlet", "email_order", "actual_order", "status")
                self.tree = ttk.Treeview(
                    frame, columns=columns, show="headings", height=25)
                self.tree.heading("outlet", text="Outlet")
                self.tree.heading("email_order", text="Email ä¸‹å–®")
                self.tree.heading("actual_order", text="å¯¦éš›è¨‚å–®")
                self.tree.heading("status", text="ç‹€æ…‹")
                self.tree.column("outlet", width=150)
                self.tree.column("email_order", width=300)
                self.tree.column("actual_order", width=300)
                self.tree.column("status", width=150)
                self.tree.pack(fill="both", expand=True)
                vsb = ttk.Scrollbar(
                    frame, orient="vertical", command=self.tree.yview)
                self.tree.configure(yscroll=vsb.set)
                vsb.pack(side="right", fill="y")
                self.full_data = table_data
                self.update_table(self.full_data)
                ctk.CTkButton(
                    self,
                    text="é—œé–‰\nClose",
                    command=self.destroy).pack(pady=10)

            def update_table(self, data):
                for row in self.tree.get_children():
                    self.tree.delete(row)
                for outlet, email_order, actual_order, status in data:
                    self.tree.insert("", "end", values=(outlet, email_order, actual_order, status))

            def update_filter(self, event=None):
                keyword = self.search_var.get().lower()
                filtered = [row for row in self.full_data if keyword in row[0].lower()]
                self.update_table(filtered)
        
        # æ·»åŠ æŸ¥çœ‹åŸå§‹é‚®ä»¶å†…å®¹çš„æŒ‰é’®
        class CrossCheckResultTable(ctk.CTkToplevel):
            def __init__(self, master, table_data, email_content=None):
                super().__init__(master)
                self.title("äº¤å‰æª¢æŸ¥çµæœ\nCross Check Result")
                self.geometry("1000x600")
                
                # æ·»åŠ æŒ‰é’®æ¡†æ¶
                button_frame = ctk.CTkFrame(self)
                button_frame.pack(fill="x", padx=10, pady=(10, 0))
                
                # æŸ¥çœ‹åŸå§‹é‚®ä»¶å†…å®¹æŒ‰é’®
                if email_content:
                    view_email_btn = ctk.CTkButton(
                        button_frame,
                        text="æŸ¥çœ‹åŸå§‹é‚®ä»¶å†…å®¹\nView Original Email Content",
                        command=lambda: self.show_email_content(email_content),
                        width=200,
                        height=30
                    )
                    view_email_btn.pack(side="left", padx=5)
                
                self.search_var = ctk.StringVar()
                ctk.CTkLabel(
                    self, text="æœå°‹é–€å¸‚\nSearch Outlet").pack(pady=(10, 0))
                search_entry = ctk.CTkEntry(self, textvariable=self.search_var)
                search_entry.pack(fill="x", padx=10)
                search_entry.bind("<KeyRelease>", self.update_filter)
                import tkinter as tk
                from tkinter import ttk
                frame = ctk.CTkFrame(self)
                frame.pack(fill="both", expand=True, padx=10, pady=10)
                columns = ("outlet", "email_order", "actual_order", "status")
                self.tree = ttk.Treeview(
                    frame, columns=columns, show="headings", height=25)
                self.tree.heading("outlet", text="Outlet")
                self.tree.heading("email_order", text="Email ä¸‹å–®")
                self.tree.heading("actual_order", text="å¯¦éš›è¨‚å–®")
                self.tree.heading("status", text="ç‹€æ…‹")
                self.tree.column("outlet", width=150)
                self.tree.column("email_order", width=300)
                self.tree.column("actual_order", width=300)
                self.tree.column("status", width=150)
                self.tree.pack(fill="both", expand=True)
                vsb = ttk.Scrollbar(
                    frame, orient="vertical", command=self.tree.yview)
                self.tree.configure(yscroll=vsb.set)
                vsb.pack(side="right", fill="y")
                self.full_data = table_data
                self.update_table(self.full_data)
                ctk.CTkButton(
                    self,
                    text="é—œé–‰\nClose",
                    command=self.destroy).pack(pady=10)

            def update_table(self, data):
                for row in self.tree.get_children():
                    self.tree.delete(row)
                for outlet, email_order, actual_order, status in data:
                    self.tree.insert("", "end", values=(outlet, email_order, actual_order, status))

            def update_filter(self, event=None):
                keyword = self.search_var.get().lower()
                filtered = [row for row in self.full_data if keyword in row[0].lower()]
                self.update_table(filtered)
            
            def show_email_content(self, email_content):
                """æ˜¾ç¤ºåŸå§‹é‚®ä»¶å†…å®¹"""
                email_window = ctk.CTkToplevel(self)
                email_window.title("åŸå§‹é‚®ä»¶å†…å®¹\nOriginal Email Content")
                email_window.geometry("800x600")
                
                # åˆ›å»ºæ–‡æœ¬æ¡†
                import tkinter as tk
                from tkinter import scrolledtext
                text_widget = scrolledtext.ScrolledText(
                    email_window, 
                    wrap='word', 
                    font=('Consolas', 10),
                    bg='#2b2b2b',
                    fg='white'
                )
                text_widget.pack(fill="both", expand=True, padx=10, pady=10)
                text_widget.insert('1.0', email_content)
                text_widget.config(state='disabled')
                
                # æ·»åŠ å…³é—­æŒ‰é’®
                ctk.CTkButton(
                    email_window,
                    text="é—œé–‰\nClose",
                    command=email_window.destroy
                ).pack(pady=10)
        
        # è¿”å›table_dataä¾›ä¸»çª—å£ä½¿ç”¨
        return table_data, content

    def _run_cross_check_and_update_remarks(self):
        """è¿è¡Œäº¤å‰æ£€æŸ¥å¹¶æ›´æ–°å¤‡æ³¨åˆ—"""
        try:
            # è¿è¡Œäº¤å‰æ£€æŸ¥
            cross_check_data, email_content = self._run_cross_check_email_log()
            
            # æ›´æ–°ä¸»è¡¨æ ¼çš„å¤‡æ³¨åˆ—
            self._update_checklist_remarks(cross_check_data)
            
            # æ˜¾ç¤ºäº¤å‰æ£€æŸ¥ç»“æœçª—å£
            self._show_cross_check_results(cross_check_data, email_content)
            
        except Exception as e:
            from tkinter import messagebox
            messagebox.showerror("é”™è¯¯", f"äº¤å‰æ£€æŸ¥å¤±è´¥: {str(e)}")

    def _update_checklist_remarks(self, cross_check_data):
        """æ ¹æ®äº¤å‰æ£€æŸ¥ç»“æœæ›´æ–°ä¸»è¡¨æ ¼çš„å¤‡æ³¨åˆ—"""
        # è·å–å½“å‰è¡¨æ ¼æ•°æ®
        if not hasattr(self, '_checklist_table_data') or not self._checklist_table_data:
            return
        
        # åˆ›å»ºäº¤å‰æ£€æŸ¥ç»“æœçš„æŸ¥æ‰¾å­—å…¸
        cross_check_dict = {}
        # è®°å½•â€œé‚®ä»¶å£°ç§°ä¸‹å•ä½†å®é™…æ²¡æœ‰â€çš„æ¡ç›®ï¼Œç”¨äºåç»­æ–°å¢è¡Œ
        unmatched_email_entries = []  # [(outlet, supplier, status)]
        for row in cross_check_data:
            outlet = row[0]  # é—¨å¸‚ï¼ˆæ‡‰ç‚ºç°¡ç¨±ï¼Œå¦‚ SKG/HGMï¼‰
            email_supplier = row[1]
            actual_supplier = row[2]
            status = row[3]  # ç‹€æ…‹
            
            # 1) éƒµä»¶è²ç¨±ä¸‹å–®ä½†å¯¦éš›æ²’æœ‰
            if "X å¯¦éš›å¹¶æ²’æœ‰è¨‚å–®" in status or "X å®é™…å¹¶æ²¡æœ‰è®¢å•" in status:
                key = f"{outlet}_{email_supplier}"
                cross_check_dict[key] = status
                unmatched_email_entries.append((outlet, email_supplier, status))
            # 2) å¯¦éš›æœ‰ä½†éƒµä»¶æ²’æœ‰ï¼ˆé€™æ™‚å€™æ‡‰è©²ä»¥ã€å¯¦éš›ä¾›æ‡‰å•†ã€ç‚ºéµä¾†æ›´æ–°ä¸»è¡¨å‚™è¨»ï¼‰
            elif "X Email å¹¶æ²’æœ‰ä¸‹å–®" in status or "X Email å¹¶æ²¡æœ‰ä¸‹å•" in status:
                key = f"{outlet}_{actual_supplier}"
                cross_check_dict[key] = status
        
        # æ›´æ–°ä¸»è¡¨æ ¼æ•°æ®
        updated_count = 0
        for row in self._checklist_table_data:
            outlet = row.get("outlet", "")
            supplier = row.get("supplier", "")
            key = f"{outlet}_{supplier}"
            
            if key in cross_check_dict:
                # æ›´æ–°å¤‡æ³¨åˆ—
                existing_remark = row.get("remark", "")
                new_remark = cross_check_dict[key]
                
                # å¦‚æœå¤‡æ³¨åˆ—å·²ç»æœ‰å†…å®¹ï¼Œç”¨åˆ†å·åˆ†éš”
                if existing_remark:
                    row["remark"] = f"{existing_remark}; {new_remark}"
                else:
                    row["remark"] = new_remark
                
                updated_count += 1
        
        # å°†â€œé‚®ä»¶å£°ç§°ä¸‹å•ä½†å®é™…æ²¡æœ‰â€çš„ç¼ºå¤±ç»„åˆåŠ å…¥ä¸»è¡¨ï¼ˆcover_status æ ‡è®°ä¸º Xï¼‰
        # ä»…åœ¨ä¸»è¡¨ä¸­ä¸å­˜åœ¨ç›¸åŒ outlet+supplier æ—¶æ·»åŠ 
        existing_keys = {f"{r.get('outlet','')}_{r.get('supplier','')}" for r in self._checklist_table_data}
        added_count = 0
        for outlet, supplier, status in unmatched_email_entries:
            key = f"{outlet}_{supplier}"
            if key not in existing_keys:
                self._checklist_table_data.append({
                    "supplier": supplier,
                    "outlet": outlet,
                    "cover_status": "X",
                    "remark": status
                })
                added_count += 1
        
        # åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º
        self._refresh_checklist_table()
        
        # æ˜¾ç¤ºæ›´æ–°ç»“æœ
        if updated_count > 0:
            from tkinter import messagebox
            messagebox.showinfo("æ›´æ–°å®Œæˆ", f"å·²æ›´æ–°/æ–°å¢ {updated_count + added_count} æ¡è®°å½•ï¼ˆæ–°å¢ {added_count} æ¡ç¼ºå¤±é …ï¼‰")

    def _show_cross_check_results(self, table_data, email_content):
        """æ˜¾ç¤ºäº¤å‰æ£€æŸ¥ç»“æœçª—å£"""
        import customtkinter as ctk
        
        class CrossCheckResultTable(ctk.CTkToplevel):
            def __init__(self, master, table_data, email_content=None):
                super().__init__(master)
                self.title("äº¤å‰æª¢æŸ¥çµæœ\nCross Check Result")
                self.geometry("1000x600")
                
                # æ·»åŠ æŒ‰é’®æ¡†æ¶
                button_frame = ctk.CTkFrame(self)
                button_frame.pack(fill="x", padx=10, pady=(10, 0))
                
                # æŸ¥çœ‹åŸå§‹é‚®ä»¶å†…å®¹æŒ‰é’®
                ctk.CTkButton(
                    button_frame,
                    text="æŸ¥çœ‹åŸå§‹é‚®ä»¶å†…å®¹\nView Raw Email Content",
                    command=lambda: self._show_email_content(email_content)
                ).pack(side="left", padx=(0, 10))
                
                # æœç´¢æ¡†
                search_frame = ctk.CTkFrame(button_frame)
                search_frame.pack(side="right", fill="x", expand=True)
                
                ctk.CTkLabel(search_frame, text="æœå°‹é–€å¸‚\nSearch Outlet:").pack(side="left", padx=(10, 5))
                self.search_var = ctk.StringVar()
                search_entry = ctk.CTkEntry(search_frame, textvariable=self.search_var)
                search_entry.pack(side="left", fill="x", expand=True, padx=(0, 10))
                search_entry.bind("<KeyRelease>", self.update_filter)
                
                # åˆ›å»ºè¡¨æ ¼
                self.full_data = table_data
                self.tree = ctk.CTkFrame(self)
                self.tree.pack(fill="both", expand=True, padx=10, pady=10)
                
                # ä½¿ç”¨tkinterçš„Treeview
                import tkinter as tk
                from tkinter import ttk
                
                self.treeview = ttk.Treeview(self.tree, columns=("Outlet", "Emailä¸‹å–®", "å¯¦éš›è¨‚å–®", "ç‹€æ…‹"), show="headings")
                self.treeview.heading("Outlet", text="é–€å¸‚\nOutlet")
                self.treeview.heading("Emailä¸‹å–®", text="Emailä¸‹å–®\nEmail Order")
                self.treeview.heading("å¯¦éš›è¨‚å–®", text="å¯¦éš›è¨‚å–®\nActual Order")
                self.treeview.heading("ç‹€æ…‹", text="ç‹€æ…‹\nStatus")
                
                # è®¾ç½®åˆ—å®½
                self.treeview.column("Outlet", width=100)
                self.treeview.column("Emailä¸‹å–®", width=200)
                self.treeview.column("å¯¦éš›è¨‚å–®", width=200)
                self.treeview.column("ç‹€æ…‹", width=150)
                
                # æ»šåŠ¨æ¡
                scrollbar = ttk.Scrollbar(self.tree, orient="vertical", command=self.treeview.yview)
                self.treeview.configure(yscrollcommand=scrollbar.set)
                
                self.treeview.pack(side="left", fill="both", expand=True)
                scrollbar.pack(side="right", fill="y")
                
                self.update_table(table_data)
            
            def update_filter(self, event=None):
                keyword = self.search_var.get().lower()
                filtered = [row for row in self.full_data if keyword in row[0].lower()]
                self.update_table(filtered)
            
            def update_table(self, data):
                # æ¸…ç©ºç°æœ‰æ•°æ®
                for item in self.treeview.get_children():
                    self.treeview.delete(item)
                
                # æ·»åŠ æ–°æ•°æ®
                for row in data:
                    self.treeview.insert("", "end", values=row)
            
            def _show_email_content(self, content):
                if not content:
                    return
                
                email_window = ctk.CTkToplevel(self)
                email_window.title("åŸå§‹é‚®ä»¶å†…å®¹\nRaw Email Content")
                email_window.geometry("800x600")
                
                import tkinter as tk
                from tkinter import scrolledtext
                
                text_widget = scrolledtext.ScrolledText(email_window, wrap=tk.WORD)
                text_widget.pack(fill="both", expand=True, padx=10, pady=10)
                text_widget.insert("1.0", content)
                text_widget.config(state="disabled")
                
                ctk.CTkButton(
                    email_window,
                    text="é—œé–‰\nClose",
                    command=email_window.destroy
                ).pack(pady=10)
        
        CrossCheckResultTable(self, table_data, email_content)

    def _search_missing_orders(self):
        """å¿«é€Ÿæœå°‹ 'Missing'ï¼ˆç¼ºæ¼åˆ†åº—ï¼‰"""
        self.checklist_search_var.set("Missing")
        self._filter_checklist_table()

    def _search_crosscheck_email_no_actual(self):
        """å¿«é€Ÿæœå°‹ 'X å¯¦éš›å¹¶æ²’æœ‰è¨‚å–®' äº¤å‰æª¢æŸ¥çµæœ"""
        # èˆ‡å‚™è¨»ä¸€è‡´çš„é—œéµå­—
        self.checklist_search_var.set("X å¯¦éš›å¹¶æ²’æœ‰è¨‚å–®")
        self._filter_checklist_table()

    def _search_crosscheck_actual_no_email(self):
        """å¿«é€Ÿæœå°‹ 'X Email å¹¶æ²’æœ‰ä¸‹å–®' äº¤å‰æª¢æŸ¥çµæœ"""
        # èˆ‡å‚™è¨»ä¸€è‡´çš„é—œéµå­—
        self.checklist_search_var.set("X Email å¹¶æ²’æœ‰ä¸‹å–®")
        self._filter_checklist_table()

    def show_download_summary(self, start_date, end_date, outlet_count):
        # æ¸…ç©ºå…§å®¹å€
        for w in self.content_body.winfo_children():
            w.destroy()
        frame = ctk.CTkFrame(
    self.content_body,
    fg_color="#1e293b",
     corner_radius=18)
        frame.pack(fill="both", expand=True, padx=60, pady=60)
        ctk.CTkLabel(
            frame,
            text=f"ğŸ“… æŠ“å–æ—¥æœŸç¯„åœ\n{start_date} ~ {end_date}",
            font=("Microsoft JhengHei", 24, "bold"),
            text_color="#3b82f6"
        ).pack(pady=(30, 10))
        ctk.CTkFrame(
    frame,
    height=2,
    fg_color="#60a5fa").pack(
        fill="x",
        padx=20,
         pady=10)
        ctk.CTkLabel(
            frame,
            text=f"ğŸª å·²ä¸‹è¼‰åˆ†åº—æ•¸é‡\n{outlet_count} é–“",
            font=("Microsoft JhengHei", 28, "bold"),
            text_color="#10b981"
        ).pack(pady=(10, 30))

# ========== Outlookä¸‹è½½å™¨ ==========


class OutlookDownloader:
    """Outlookè®¢å•ä¸‹è½½å™¨"""

    @staticmethod
    def get_smtp_address(msg):
        """å–å¾—éƒµä»¶çš„ SMTP æ ¼å¼å¯„ä»¶äººï¼Œå¼·åŒ– fallbackï¼Œæ”¯æ´ Exchange éƒµä»¶"""
        try:
            if hasattr(
    msg,
     "SenderEmailType") and msg.SenderEmailType == "SMTP":
                return str(msg.SenderEmailAddress).lower().strip()
            if hasattr(
    msg,
    "Sender") and hasattr(
        msg.Sender,
         "GetExchangeUser"):
                try:
                    ex_user = msg.Sender.GetExchangeUser()
                    if ex_user and hasattr(ex_user, "PrimarySmtpAddress"):
                        smtp = str(ex_user.PrimarySmtpAddress).lower().strip()
                        if smtp:
                            return smtp
                except Exception:
                    pass
            # æ–°å¢ï¼šç”¨ MAPI å±¬æ€§æŠ“ SMTP
            try:
                mapi = msg.Sender
                smtp = mapi.PropertyAccessor.GetProperty(
                    "http://schemas.microsoft.com/mapi/proptag/0x39FE001E")
                if smtp:
                    return str(smtp).lower().strip()
            except Exception:
                pass
            # fallback: ç›´æ¥ç”¨ SenderEmailAddressï¼ˆå³ä½¿æ˜¯ EXï¼‰
            if hasattr(msg, "SenderEmailAddress"):
                email_addr = str(msg.SenderEmailAddress).lower().strip()
                if email_addr:
                    return email_addr
            # fallback: ç›´æ¥ç”¨ SenderName
            if hasattr(msg, "SenderName"):
                return str(msg.SenderName).lower().strip()
        except Exception:
            pass
        return ""

    @staticmethod
    def get_time_range():
        """ç²å–æ™‚é–“ç¯„åœï¼šå¾ä¸Šä¸€å‘¨æ˜ŸæœŸäº”åˆ°ä»Šå¤©"""
        from datetime import datetime, timedelta

        today = datetime.now()
        # ç„¡è«–ä»Šå¤©æ˜¯æ˜ŸæœŸå¹¾ï¼Œéƒ½å›æ¨åˆ°ä¸Šä¸€å‘¨çš„æ˜ŸæœŸäº”
        days_since_last_friday = (today.weekday() - 4) % 7 + 7
        start_of_period = (
    today -
    timedelta(
        days=days_since_last_friday)).replace(
            hour=0,
            minute=0,
            second=0,
             microsecond=0)
        end_of_period = today.replace(
    hour=23, minute=59, second=59, microsecond=999999)

        return start_of_period, end_of_period, today.isocalendar()[1]

    @staticmethod
    def get_outlook_account(account_idx=None):
        """ç²å– Outlook å¸³è™Ÿ"""
        import win32com.client
        import pythoncom

        # åˆå§‹åŒ– COM çµ„ä»¶
        pythoncom.CoInitialize()

        outlook = win32com.client.Dispatch("Outlook.Application")
        namespace = outlook.GetNamespace("MAPI")
        accounts = [
    namespace.Folders.Item(
        i +
        1) for i in range(
            namespace.Folders.Count)]

        if account_idx is None:
            account_names = [acct.Name for acct in accounts]
            idx = show_outlook_account_selector(None, account_names)
            if idx is None:
                return None
            account_idx = idx

        return accounts[account_idx]

    @staticmethod
    def get_inbox(account, callback=None):
        """ç²å–æ”¶ä»¶åŒ£ï¼Œå˜—è©¦ä¸åŒåç¨±"""
        inbox_names = ["Inbox", "æ”¶ä»¶åŒ£", "æ”¶ä»¶ç®±"]

        for inbox_name in inbox_names:
            try:
                inbox = account.Folders(inbox_name)
                if callback:
                    callback(f"âœ… æˆåŠŸè¨ªå•æ”¶ä»¶åŒ£: {inbox_name}")
                return inbox
            except:
                continue

        # å¦‚æœæ‰¾ä¸åˆ°æ”¶ä»¶åŒ£ï¼Œåˆ—å‡ºå¯ç”¨æ–‡ä»¶å¤¾
        available_folders = []
        try:
            for i in range(account.Folders.Count):
                folder = account.Folders.Item(i + 1)
                available_folders.append(folder.Name)
        except:
            pass

        error_msg = f"âŒ ç„¡æ³•æ‰¾åˆ°æ”¶ä»¶åŒ£åœ¨å¸³è™Ÿ '{account.Name}' ä¸­"
        if available_folders:
            error_msg += f"\nå¯ç”¨æ–‡ä»¶å¤¾: {', '.join(available_folders)}"

        if callback:
            callback(error_msg)
        return None

    @staticmethod
    def load_config(config_file):
        """è¼‰å…¥é…ç½®æ–‡ä»¶"""
        if not config_file or not os.path.exists(config_file):
            return set(), {}

        try:
            import pandas as pd
            df = pd.read_excel(config_file)

            config_emails = set()
            email_to_short = {}

            for _, row in df.iterrows():
                # å‡è¨­ç¬¬3åˆ—æ˜¯éƒµç®±ï¼Œç¬¬1åˆ—æ˜¯çŸ­åç¨±
                email = str(row.iloc[2]).strip().lower() if len(
                    row) > 2 and not pd.isna(row.iloc[2]) else ''
                short_name = str(row.iloc[0]).strip() if len(
                    row) > 0 and not pd.isna(row.iloc[0]) else ''

                if email and short_name:
                    config_emails.add(email)
                    email_to_short[email] = short_name

            return config_emails, email_to_short
        except Exception as e:
            return set(), {}

    @staticmethod
    def search_messages_in_folder(
    folder,
    start_time,
    end_time,
    subject_keywords,
    config_emails=None,
     callback=None):
        """åœ¨æŒ‡å®šæ–‡ä»¶å¤¾ä¸­æœå°‹ç¬¦åˆæ¢ä»¶çš„éƒµä»¶"""
        messages = []

        try:
            items = folder.Items
            items.Sort("[ReceivedTime]", True)

            # éæ¿¾æ™‚é–“ç¯„åœ - ä½¿ç”¨æ­£ç¢ºçš„ Outlook æ—¥æœŸæ ¼å¼
            try:
                # å˜—è©¦ä½¿ç”¨ Outlook çš„æ—¥æœŸæ ¼å¼
                start_str = start_time.strftime('%m/%d/%Y')
                end_str = end_time.strftime('%m/%d/%Y')
                filter_str = f"[ReceivedTime] >= '{start_str}' AND [ReceivedTime] <= '{end_str}'"
                filtered_messages = items.Restrict(filter_str)

                if callback:
                    callback(f"ğŸ” ä½¿ç”¨éæ¿¾æ¢ä»¶: {filter_str}")
                    callback(f"ğŸ“Š æ™‚é–“éæ¿¾å¾Œæ‰¾åˆ° {filtered_messages.Count} å°éƒµä»¶")

            except Exception as e:
                if callback:
                    callback(f"âš ï¸ Restrict éæ¿¾å¤±æ•—ï¼Œæ”¹ç”¨æ‰‹å‹•éæ¿¾: {e}")

                # å¦‚æœ Restrict å¤±æ•—ï¼Œä½¿ç”¨æ‰‹å‹•éæ¿¾ï¼ˆåªæª¢æŸ¥æœ€è¿‘çš„éƒµä»¶ï¼‰
                filtered_messages = []
                count = 0
                max_check = 500  # åªæª¢æŸ¥æœ€è¿‘ 500 å°éƒµä»¶ä»¥æé«˜æ•ˆç‡

                for msg in items:
                    if count >= max_check:
                        break
                    count += 1

                    try:
                        received = getattr(msg, 'ReceivedTime', None)
                        if received:
                            # è™•ç†æ™‚å€å•é¡Œ
                            if hasattr(
    received, 'tzinfo') and received.tzinfo is not None:
                                received_naive = received.replace(tzinfo=None)
                            else:
                                received_naive = received

                            # æª¢æŸ¥æ˜¯å¦åœ¨æ™‚é–“ç¯„åœå…§
                            if start_time <= received_naive <= end_time:
                                filtered_messages.append(msg)
                    except:
                        continue

                if callback:
                    callback(f"ğŸ“Š æ‰‹å‹•éæ¿¾å¾Œæ‰¾åˆ° {len(filtered_messages)} å°éƒµä»¶")

            # éæ­·éæ¿¾å¾Œçš„éƒµä»¶ï¼ˆå¯èƒ½æ˜¯ Outlook é›†åˆæˆ– Python åˆ—è¡¨ï¼‰
            try:
                # æª¢æŸ¥æ˜¯å¦æ˜¯ Outlook é›†åˆ
                if hasattr(filtered_messages, 'Count'):
                    message_count = filtered_messages.Count
                    message_iter = filtered_messages
                else:
                    message_count = len(filtered_messages)
                    message_iter = filtered_messages

                if callback:
                    callback(f"ğŸ” é–‹å§‹æª¢æŸ¥ {message_count} å°éƒµä»¶çš„ä¸»é¡Œå’Œé™„ä»¶...")

                checked_count = 0
                found_count = 0

                for msg in message_iter:
                    try:
                        checked_count += 1

                        # æª¢æŸ¥éƒµä»¶ä¸»é¡Œ
                        subject = getattr(msg, 'Subject', '').lower()
                        if not any(
    keyword in subject for keyword in subject_keywords):
                            continue

                        # æª¢æŸ¥ç™¼ä»¶äºº
                        sender_email = OutlookDownloader.get_sender_email(msg)
                        if not sender_email:
                            continue

                        # æª¢æŸ¥æ˜¯å¦åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼ˆå¦‚æœæœ‰é…ç½®æ–‡ä»¶çš„è©±ï¼‰
                        if config_emails and len(config_emails) > 0:
                            if not any(
    email in sender_email for email in config_emails):
                                continue

                        # æª¢æŸ¥æ˜¯å¦æœ‰ Excel é™„ä»¶
                        has_excel = False
                        for attachment in msg.Attachments:
                            if attachment.FileName.lower().endswith(('.xlsx', '.xls')):
                                has_excel = True
                                break

                        if has_excel:
                            messages.append(msg)
                            found_count += 1
                            if callback and found_count <= 3:  # åªå ±å‘Šå‰3å€‹
                                callback(
    f"  âœ… æ‰¾åˆ°: {
        getattr(
            msg,
            'Subject',
             'No Subject')}")

                    except Exception as e:
                        continue

                if callback:
                    callback(f"ğŸ“§ æ‰¾åˆ° {found_count} å°ç¬¦åˆæ¢ä»¶çš„éƒµä»¶")

            except Exception as e:
                if callback:
                    callback(f"âŒ éæ­·éƒµä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
                return []

        except Exception as e:
            if callback:
                callback(f"âŒ æœå°‹æ–‡ä»¶å¤¾ {folder.Name} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

        return messages

    @classmethod
    def download_weekly_orders(
    cls,
    destination_folder,
    config_file=None,
    account_idx=None,
    callback=None,
     progress_popup=None):
        import win32com.client
        import pythoncom
        from datetime import datetime, timedelta
        import os
        import re
        import pandas as pd
        import hashlib
        import sys

        # åˆå§‹åŒ– COM çµ„ä»¶
        pythoncom.CoInitialize()
        # å–å¾—ä»Šå¤©æ—¥æœŸ
        today = datetime.now()
        week_no = today.isocalendar()[1]

        # ====== æ­£ç¢ºå›æ¨åˆ°ä¸Šé€±äº” ======
        # today.weekday(): 0=Mon, 4=Fri, 6=Sun
        days_since_last_friday = (today.weekday() - 4) % 7 or 7
        start_of_period = (
    today -
    timedelta(
        days=days_since_last_friday)).replace(
            hour=0,
            minute=0,
            second=0,
             microsecond=0)
        end_of_period = today.replace(
    hour=23, minute=59, second=59, microsecond=999999)

        # ç”Ÿæˆæœˆä»½-æ˜ŸæœŸæ ¼å¼çš„æ–‡ä»¶å¤¹åç§°
        # ä½¿ç”¨ä¸‹é€±ä¸€çš„æ—¥æœŸä¾†è¨ˆç®—æ–‡ä»¶å¤¾åç¨±ï¼Œèˆ‡è¨‚å–®è‡ªå‹•åŒ–é‚è¼¯ä¿æŒä¸€è‡´
        next_monday = today + timedelta(days=(7 - today.weekday()))
        month_name = next_monday.strftime('%b').title()  # ç¡®ä¿é¦–å­—æ¯å¤§å†™ï¼Œä¾‹å¦‚: Aug, Sep
        week_of_month = get_week_of_month(next_monday)
        folder_name = f"{month_name} - Week {week_of_month}"
        
        save_path = os.path.join(destination_folder, folder_name)
        os.makedirs(save_path, exist_ok=True)

        # å‰µå»º Supplier Order å­æ–‡ä»¶å¤¾
        supplier_order_path = os.path.join(
    save_path, f"Supplier Order - Week {week_no}")
        os.makedirs(supplier_order_path, exist_ok=True)

        if callback:
            callback(f"ğŸ“ å·²å‰µå»ºæ–‡ä»¶å¤¾: {folder_name}")
            callback(f"ğŸ“ å·²å‰µå»ºå­æ–‡ä»¶å¤¾: Supplier Order - Week {week_no}")

        # ====== æª¢æŸ¥å·²ä¸‹è¼‰æª”æ¡ˆè¨˜éŒ„ ======
        downloaded_log_file = os.path.join(
    save_path, "downloaded_files_log.txt")
        downloaded_files = set()
        if os.path.exists(downloaded_log_file):
            try:
                with open(downloaded_log_file, 'r', encoding='utf-8') as f:
                    for line in f:
                        line = line.strip()
                        if line:
                            downloaded_files.add(line)
                if callback:
                    callback(f"ğŸ“‹ å·²è¼‰å…¥ {len(downloaded_files)} å€‹å·²ä¸‹è¼‰æª”æ¡ˆè¨˜éŒ„")
            except Exception as e:
                if callback:
                    callback(f"âš ï¸ è¼‰å…¥å·²ä¸‹è¼‰è¨˜éŒ„å¤±æ•—: {e}")

        def save_downloaded_file_info(
    filename,
    sender_email,
    subject,
     received_time):
            """è¨˜éŒ„å·²ä¸‹è¼‰çš„æª”æ¡ˆè³‡è¨Š"""
            try:
                with open(downloaded_log_file, 'a', encoding='utf-8') as f:
                    file_info = f"{filename}|{sender_email}|{subject}|{received_time}"
                    f.write(file_info + "\n")
                    downloaded_files.add(file_info)
            except Exception as e:
                if callback:
                    callback(f"âš ï¸ è¨˜éŒ„ä¸‹è¼‰è³‡è¨Šå¤±æ•—: {e}")

        def is_file_already_downloaded(
    filename,
    sender_email,
    subject,
     received_time):
            """æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å·²ç¶“ä¸‹è¼‰é"""
            file_info = f"{filename}|{sender_email}|{subject}|{received_time}"
            return file_info in downloaded_files

        def get_latest_order_for_outlet(short_name, messages_list):
            """ç²å–æŒ‡å®šé–€å¸‚çš„æœ€æ–°è¨‚å–®éƒµä»¶"""
            latest_msg = None
            latest_time = None
            
            for msg in messages_list:
                try:
                    attachments = msg.Attachments
                    subject = getattr(msg, 'Subject', '') or ''
                    received_time = getattr(msg, 'ReceivedTime', None)
                    
                    if attachments.Count == 0:
                        continue
                    
                    # æª¢æŸ¥éƒµä»¶ä¸»æ—¨æ˜¯å¦ç‚º Weekly Order
                    subject_lower = subject.lower()
                    
                    # å®šç¾© Weekly Order çš„é—œéµå­—
                    weekly_order_keywords = [
                        'weekly order', 'weekly ordering', 'weeklyorder', 'weeklyordering',
                        'weeky order', 'weeky ordering',
                        'weekly', 'weeky',
                        'order', 'ordering',
                        'order form', 'ordering form'
                    ]
                    
                    # å®šç¾©è¦æ’é™¤çš„é—œéµå­—
                    exclude_keywords = [
                        'amendment', 'amend', 'ament', 'admentmend', 'adment', 'amendmend', 'amendement',
                        'assets', 'uniform', 'asset', 'uniforms', 'request form', 'outlet assets &', 'outlet assets and',
                        'uniform request', 'assets request', 'assets & uniform', 'assets and uniform',
                        'invoice', 'payment', 'receipt', 'confirmation', 'delivery note',
                        'siahuat', 'siah', 'uat', 'æ€è¯é”', 'siah uat',
                        'monthly', 'month', 'æœˆ', 'æœˆåº¦'
                    ]
                    
                    # æª¢æŸ¥ä¸»æ—¨æ˜¯å¦åŒ…å« Weekly Order é—œéµå­—
                    has_weekly_order = any(
    keyword in subject_lower for keyword in weekly_order_keywords)
                    
                    # æª¢æŸ¥ä¸»æ—¨æ˜¯å¦åŒ…å«æ’é™¤é—œéµå­—
                    has_exclude_keywords = any(
    keyword in subject_lower for keyword in exclude_keywords)
                    
                    # ç‰¹åˆ¥æª¢æŸ¥Amendmentç›¸é—œé—œéµå­—
                    amendment_keywords = [
    'amendment',
    'amend',
    'ament',
    'admentmend',
    'adment',
    'amendmend',
     'amendement']
                    has_amendment = any(
    keyword in subject_lower for keyword in amendment_keywords)
                    
                    # å¦‚æœä¸»æ—¨åŒ…å«Amendmenté—œéµå­—ï¼Œè·³é
                    if has_amendment:
                        continue
                    
                    # å¦‚æœä¸»æ—¨ä¸åŒ…å«ä»»ä½•è¨‚å–®ç›¸é—œé—œéµå­—ï¼Œæˆ–åŒ…å«å…¶ä»–æ’é™¤é—œéµå­—ï¼Œå‰‡è·³é
                    if not has_weekly_order or has_exclude_keywords:
                        # ä½†æ˜¯å¦‚æœæœ‰Excelé™„ä»¶ï¼Œæˆ‘å€‘é‚„æ˜¯è¦æª¢æŸ¥é™„ä»¶åç¨±
                        excel_attachments_for_check = []
                        for att in attachments:
                            filename = att.FileName
                            name_lower = filename.lower()
                            if name_lower.endswith(
                                '.xlsx') or name_lower.endswith('.xls'):
                                # ç‰¹åˆ¥æª¢æŸ¥é™„ä»¶åç¨±æ˜¯å¦åŒ…å«Amendmenté—œéµå­—
                                att_has_amendment = any(
    keyword in name_lower for keyword in amendment_keywords)
                                if att_has_amendment:
                                    continue
                                
                                # æª¢æŸ¥é™„ä»¶åç¨±æ˜¯å¦åŒ…å«è¨‚å–®é—œéµå­—
                                att_has_order = any(
    keyword in name_lower for keyword in weekly_order_keywords)
                                att_has_exclude = any(
    keyword in name_lower for keyword in exclude_keywords)
                                
                                if att_has_order and not att_has_exclude:
                                    excel_attachments_for_check.append(att)
                        
                        # å¦‚æœä¸»æ—¨å’Œé™„ä»¶éƒ½ä¸ç¬¦åˆæ¢ä»¶ï¼Œæ‰è·³é
                        if not excel_attachments_for_check:
                            continue
                    
                    # æª¢æŸ¥æ˜¯å¦æœ‰ç¬¦åˆæ¢ä»¶çš„ Excel é™„ä»¶
                    excel_attachments = []
                    for att in attachments:
                        filename = att.FileName
                        name_lower = filename.lower()
                        
                        # æª¢æŸ¥æ˜¯å¦ç‚º Excel æ–‡ä»¶
                        if name_lower.endswith(
                            '.xlsx') or name_lower.endswith('.xls'):
                            # ç‰¹åˆ¥æª¢æŸ¥é™„ä»¶åç¨±æ˜¯å¦åŒ…å«Amendmenté—œéµå­—
                            filename_has_amendment = any(
    keyword in name_lower for keyword in amendment_keywords)
                            if filename_has_amendment:
                                continue
                            
                            # æª¢æŸ¥é™„ä»¶åç¨±æ˜¯å¦åŒ…å«å…¶ä»–æ’é™¤é—œéµå­—
                            filename_has_exclude = any(
    keyword in name_lower for keyword in exclude_keywords)
                            
                            # å¦‚æœé™„ä»¶åŒ…å«æ’é™¤é—œéµå­—ï¼Œè·³é
                            if filename_has_exclude:
                                continue
                            
                            # å¦‚æœé™„ä»¶æ²’æœ‰æ’é™¤é—œéµå­—ï¼Œå°±æ¥å—
                            excel_attachments.append(att)
                    
                    # å¦‚æœæ²’æœ‰ Excel é™„ä»¶ï¼Œç¹¼çºŒä¸‹ä¸€å°éƒµä»¶
                    if not excel_attachments:
                        continue
                    
                    # æ‰¾åˆ°æœ‰æ•ˆçš„è¨‚å–®éƒµä»¶ï¼Œæª¢æŸ¥æ˜¯å¦æ˜¯æœ€æ–°çš„
                    if latest_time is None or received_time > latest_time:
                        latest_msg = msg
                        latest_time = received_time
                        
                except Exception:
                    continue
            
            return latest_msg

        # ===== è®€ configï¼Œå»ºç«‹ email -> short_name æ˜ å°„ =====
        email_to_short = {}  # email(lowercase) -> short_name
        name_to_short = {}   # name(lowercase)  -> short_name
        if config_file and os.path.exists(config_file):
            try:
                df = pd.read_excel(config_file)
                for _, row in df.iterrows():
                    email = str(row.iloc[2]).strip().lower() if len(
                        row) > 2 and not pd.isna(row.iloc[2]) else ''
                    short_name = str(row.iloc[0]).strip() if len(
                        row) > 0 and not pd.isna(row.iloc[0]) else ''
                    name_in_email = str(row.iloc[4]).strip().lower() if len(
                        row) > 4 and not pd.isna(row.iloc[4]) else ''
                    if email and short_name:
                        email_to_short[email] = short_name
                    if name_in_email and short_name:
                        name_to_short[name_in_email] = short_name
            except Exception as e:
                pass

        # é¸æ“‡å¸³è™Ÿ
        outlook = win32com.client.Dispatch(
            "Outlook.Application").GetNamespace("MAPI")
        accounts = [
    outlook.Folders.Item(
        i +
        1) for i in range(
            outlook.Folders.Count)]
        if account_idx is None:
            from tkinter import simpledialog
            account_names = [acct.Name for acct in accounts]
            # å˜—è©¦æ‰¾åˆ°ä¸»è¦–çª—
            import tkinter as tk
            main_window = None
            for w in tk._default_root.winfo_children():
                if hasattr(w, 'attributes'):
                    main_window = w
                    break

            # ç¢ºä¿ä¸»è¦–çª—åœ¨æœ€é ‚å±¤
            if main_window:
                main_window.attributes('-topmost', True)
                main_window.lift()  # æå‡åˆ°æœ€é ‚å±¤
                main_window.focus_force()  # å¼·åˆ¶ç²å¾—ç„¦é»

            idx = simpledialog.askinteger(
                t("select_account"),
                "\n".join([f"[{i}] {name}" for i, name in enumerate(
                    account_names)]) + "\n" + t("enter_index"),
                minvalue=0, maxvalue=len(account_names) - 1,
                parent=main_window if main_window else None
            )

            # æ¢å¾©ä¸»è¦–çª—è¨­ç½®
            if main_window:
                main_window.attributes('-topmost', False)

            if idx is None:
                # if callback:
                #     callback("âŒ æœªé¸æ“‡å¸³è™Ÿï¼Œå·²å–æ¶ˆä¸‹è¼‰")
                return
            account_idx = idx
        account_folder = accounts[account_idx]
        # éè¿´æŠ“å–æ‰€æœ‰å­è³‡æ–™å¤¾çš„éƒµä»¶

        def collect_messages_from_subfolders(folder):
            all_messages = []
            try:
                if hasattr(
    folder,
     'DefaultItemType') and folder.DefaultItemType == 0:
                    print(f"[DEBUG] Scanning folder: {folder.Name}")
                    items = folder.Items
                    items.Sort("[ReceivedTime]", True)
                    count = 0
                    for msg in items:
                        try:
                            if msg.Class == 43:
                                received = getattr(msg, 'ReceivedTime', None)
                                subject = getattr(msg, 'Subject', '')
                                if received:
                                    # è‹¥ received æœ‰ tzinfoï¼Œè½‰æˆ naive
                                    if hasattr(
    received, 'tzinfo') and received.tzinfo is not None:
                                        received_naive = received.replace(
                                            tzinfo=None)
                                    else:
                                        received_naive = received
                                    if start_of_period <= received_naive <= end_of_period:
                                        print(
    f"[DEBUG] Message: ReceivedTime={received}, Subject={subject}")
                                        all_messages.append(msg)
                                        count += 1
                        except Exception as e:
                            print(
    f"[DEBUG] Error reading message in {
        folder.Name}: {e}")
                    print(
    f"[DEBUG] Folder '{
        folder.Name}' matched messages: {count}")
            except Exception as e:
                print(
    f"[DEBUG] Exception in collect_messages_from_subfolders: {e} (Folder: {
        getattr(
            folder,
            'Name',
             '')})")
            for sub in folder.Folders:
                all_messages.extend(collect_messages_from_subfolders(sub))
            return all_messages
        messages = collect_messages_from_subfolders(account_folder)
        if callback:
            callback(f"ğŸ“¬ å–å¾—éƒµä»¶æ•¸é‡ï¼ˆé™åˆ¶ä¸Šé€±äº”èµ·ï¼Œå«æ‰€æœ‰å­è³‡æ–™å¤¾ï¼‰: {len(messages)}")
            callback("ğŸ” é–‹å§‹è™•ç†æ‰€æœ‰éƒµä»¶ï¼Œå°‹æ‰¾æœ€æ–°çš„ Weekly Order...")
            callback("ğŸ’¡ ç³»çµ±æœƒè‡ªå‹•è·³éåŒ…å« 'amendment'ã€'amend'ã€'ament' ç­‰é—œéµå­—çš„éƒµä»¶å’Œé™„ä»¶")
            callback("ğŸ’¡ å°æ–¼åŒä¸€å®¶é–€å¸‚ï¼Œç³»çµ±æœƒä¸‹è¼‰æœ€æ–°çš„è¨‚å–®ä¸¦è‡ªå‹•åˆªé™¤èˆŠçš„è¨‚å–®æ–‡ä»¶")
            callback("ğŸ’¡ ç¢ºä¿æ‚¨å§‹çµ‚æ“æœ‰æ¯å®¶é–€å¸‚çš„æœ€æ–°è¨‚å–®")
            callback("")  # æ·»åŠ ç©ºè¡Œ

        # åªä¿ç•™ config è£¡ email/name çš„æœ€æ–°ä¸€å°éƒµä»¶
        latest_msg_by_sender = {}
        for msg in messages:
            try:
                sender_email = cls.get_smtp_address(msg).strip().lower()
                sender_name = getattr(msg, "SenderName", "").strip().lower()
                key = None
                if sender_email in email_to_short:
                    key = sender_email
                elif sender_name in name_to_short:
                    key = sender_name
                if not key:
                    continue
                if key not in latest_msg_by_sender or msg.ReceivedTime > latest_msg_by_sender[
                    key].ReceivedTime:
                    latest_msg_by_sender[key] = msg
            except Exception:
                continue
        # ç‚ºæ¯å€‹é–€å¸‚æ”¶é›†æ‰€æœ‰éƒµä»¶ï¼ŒæŒ‰æ™‚é–“æ’åº
        all_messages_by_sender = {}
        for msg in messages:
            try:
                sender_email = cls.get_smtp_address(msg).strip().lower()
                sender_name = getattr(msg, "SenderName", "").strip().lower()
                key = None
                if sender_email in email_to_short:
                    key = sender_email
                elif sender_name in name_to_short:
                    key = sender_name
                if not key:
                    continue
                if key not in all_messages_by_sender:
                    all_messages_by_sender[key] = []
                all_messages_by_sender[key].append(msg)
            except Exception:
                continue
        # æŒ‰æ™‚é–“æ’åºæ¯å€‹é–€å¸‚çš„éƒµä»¶
        for key in all_messages_by_sender:
            all_messages_by_sender[key].sort(
    key=lambda x: x.ReceivedTime, reverse=True)
        downloaded = 0
        skipped = 0
        amendment_skipped = 0  # æ–°å¢ï¼šçµ±è¨ˆè·³éçš„ Amendment æ•¸é‡
        manual_confirmed = 0
        downloaded_short_names = set()
        downloaded_emails = set()  # æ–°å¢ï¼šçµ±è¨ˆæœ‰ä¸‹è¼‰ weekly order çš„ email
        selected_messages = {}     # æ–°å¢ï¼šå¯¦éš›æˆåŠŸä¸‹è¼‰æª”æ¡ˆæ‰€å°æ‡‰çš„éƒµä»¶ï¼ˆåƒ…è¨˜éŒ„æœ¬æ¬¡ä¿å­˜çš„ï¼‰
        # ===== æ–°çš„ä¸‹è¼‰é‚è¼¯ï¼šè®€å–æ‰€æœ‰éƒµä»¶ï¼Œä¸‹è¼‰æœ€æ–°çš„è¨‚å–® =====
        for key, messages_list in all_messages_by_sender.items():
            try:
                # å…ˆæ‰¾ short_name
                if key in email_to_short:
                    short_name = email_to_short[key]
                elif key in name_to_short:
                    short_name = name_to_short[key]
                else:
                    continue

                # ç²å–è©²é–€å¸‚çš„æœ€æ–°è¨‚å–®éƒµä»¶
                latest_msg = get_latest_order_for_outlet(short_name, messages_list)
                
                if latest_msg is None:
                    # æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è¨‚å–®éƒµä»¶
                    skipped += 1
                    continue

                # è™•ç†æœ€æ–°çš„è¨‚å–®éƒµä»¶
                attachments = latest_msg.Attachments
                subject = getattr(latest_msg, 'Subject', '') or ''
                received_time = getattr(latest_msg, 'ReceivedTime', None)

                # æª¢æŸ¥æ˜¯å¦æœ‰ç¬¦åˆæ¢ä»¶çš„ Excel é™„ä»¶
                excel_attachments = []
                for att in attachments:
                    filename = att.FileName
                    name_lower = filename.lower()

                    # æª¢æŸ¥æ˜¯å¦ç‚º Excel æ–‡ä»¶
                    if name_lower.endswith(
                        '.xlsx') or name_lower.endswith('.xls'):
                        # ç‰¹åˆ¥æª¢æŸ¥é™„ä»¶åç¨±æ˜¯å¦åŒ…å«Amendmenté—œéµå­—
                        amendment_keywords = [
    'amendment',
    'amend',
    'ament',
    'admentmend',
    'adment',
    'amendmend',
     'amendement']
                        filename_has_amendment = any(
    keyword in name_lower for keyword in amendment_keywords)
                        if filename_has_amendment:
                            amendment_skipped += 1
                            if callback:
                                callback(
    f"â© è·³é Amendment é™„ä»¶: {filename} (from {key})")
                                callback("")  # æ·»åŠ ç©ºè¡Œ
                            continue

                        # æª¢æŸ¥é™„ä»¶åç¨±æ˜¯å¦åŒ…å«å…¶ä»–æ’é™¤é—œéµå­—
                        exclude_keywords = [
                            'assets', 'uniform', 'asset', 'uniforms', 'request form', 'outlet assets &', 'outlet assets and',
                            'uniform request', 'assets request', 'assets & uniform', 'assets and uniform',
                            'invoice', 'payment', 'receipt', 'confirmation', 'delivery note',
                            'siahuat', 'siah', 'uat', 'æ€è¯é”', 'siah uat',
                            'monthly', 'month', 'æœˆ', 'æœˆåº¦'
                        ]
                        filename_has_exclude = any(
    keyword in name_lower for keyword in exclude_keywords)

                        # å¦‚æœé™„ä»¶åŒ…å«æ’é™¤é—œéµå­—ï¼Œè·³é
                        if filename_has_exclude:
                            if callback:
                                callback(
    f"â© è·³éé Weekly Order é™„ä»¶: {filename}")
                                callback("")  # æ·»åŠ ç©ºè¡Œ
                            continue

                        # å¦‚æœé™„ä»¶æ²’æœ‰æ’é™¤é—œéµå­—ï¼Œå°±æ¥å—
                        excel_attachments.append(att)

                # å¦‚æœæ²’æœ‰ Excel é™„ä»¶ï¼Œè·³é
                if not excel_attachments:
                    skipped += 1
                    continue

                # ä¸‹è¼‰ç¬¬ä¸€å€‹ Excel é™„ä»¶
                att = excel_attachments[0]
                filename = att.FileName
                save_filename = f"{short_name}_WeeklyOrder_{week_no}.xlsx"
                full_path = os.path.join(save_path, save_filename)

                # æª¢æŸ¥æ˜¯å¦å·²ç¶“ä¸‹è¼‰éç›¸åŒçš„éƒµä»¶
                sender_email = cls.get_smtp_address(latest_msg).strip().lower()
                subject = getattr(latest_msg, 'Subject', '') or ''
                received_time_str = received_time.strftime(
                    '%Y-%m-%d %H:%M:%S') if hasattr(received_time, 'strftime') else ''

                if is_file_already_downloaded(
    filename, sender_email, subject, received_time_str):
                    if callback:
                        callback(f"â© è·³éå·²ä¸‹è¼‰æª”æ¡ˆ: {filename} (from {key})")
                    continue

                # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è©²é–€å¸‚çš„è¨‚å–®æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨å‰‡åˆªé™¤èˆŠçš„
                old_file_deleted = False
                if os.path.exists(full_path):
                    try:
                        os.remove(full_path)
                        old_file_deleted = True
                        if callback:
                            callback(f"ğŸ—‘ï¸ å·²åˆªé™¤èˆŠæ–‡ä»¶: {save_filename}")
                    except Exception as e:
                        if callback:
                            callback(f"âš ï¸ ç„¡æ³•åˆªé™¤èˆŠæ–‡ä»¶ {full_path}: {e}")

                # ä¸‹è¼‰æ–°æ–‡ä»¶
                att.SaveAsFile(full_path)

                # è¨˜éŒ„ä¸‹è¼‰è³‡è¨Š
                save_downloaded_file_info(
    filename, sender_email, subject, received_time_str)

                print(f"[DEBUG] Downloaded from sender_email: {key}")
                downloaded_emails.add(key)
                downloaded += 1
                downloaded_short_names.add(short_name)
                # è¨˜éŒ„æ­¤æ¬¡å¯¦éš›ä½¿ç”¨çš„éƒµä»¶
                selected_messages[key] = latest_msg
                
                if progress_popup:
                    progress_popup.update_outlet_count(
                        len(downloaded_short_names))
                
                if callback:
                    if old_file_deleted:
                        callback(f"âœ… {short_name}: {filename} (å·²æ›´æ–°)")
                    else:
                        callback(f"âœ… {short_name}: {filename}")

            except Exception as e:
                if callback:
                    callback(f"âŒ Failed to process a message: {e}")
                skipped += 1
        config_short_names = set(email_to_short.values())

        # å‚™æ´åŒ¹é…åŠŸèƒ½å·²ç§»é™¤ - åªä¾è³´ç™¼ä»¶äººåŒ¹é…

        # æª¢æŸ¥å“ªäº›é–€å¸‚å·²ç¶“æœ‰æ–‡ä»¶å­˜åœ¨ï¼ˆä¸ç®¡æ˜¯æœ¬æ¬¡ä¸‹è¼‰é‚„æ˜¯ä¹‹å‰ä¸‹è¼‰çš„ï¼‰
        existing_files = set()
        for short_name in config_short_names:
            file_path = os.path.join(
    save_path, f"{short_name}_WeeklyOrder_{week_no}.xlsx")
            if os.path.exists(file_path):
                existing_files.add(short_name)

        # çœŸæ­£æœªä¸‹è¼‰çš„æ˜¯é‚£äº›å®Œå…¨æ²’æœ‰æ–‡ä»¶çš„é–€å¸‚
        not_downloaded = config_short_names - existing_files

        summary = (
            f"\n=== Download Summary ===\n"
            f"Downloaded (auto): {downloaded}\n"
            f"Amendment Skipped: {amendment_skipped}\n"
            f"Skipped: {skipped}\n"
            f"Saved to: {save_path}\n"
            f"\n=== æª”æ¡ˆä¸‹è¼‰çµæœ ===\n"
            f"å·²ä¸‹è¼‰: {
    ', '.join(
        sorted(existing_files)) if existing_files else 'ç„¡'}\n"
            f"æœªä¸‹è¼‰: {
    ', '.join(
        sorted(not_downloaded)) if not_downloaded else 'ç„¡'}\n"
            f"è·³é Amendment: {amendment_skipped} å€‹"
        )
        if callback:
            callback(summary)
        # é¡å¤–ï¼šå‘¼å«ä¸»ç•«é¢ç¾åŒ–é¡¯ç¤º
        try:
            # å–å¾—æŠ“å–æ—¥æœŸç¯„åœ
            start_date = start_of_period.strftime("%Y-%m-%d")
            end_date = end_of_period.strftime("%Y-%m-%d")
            outlet_count = len(downloaded_short_names)
            # å˜—è©¦å–å¾— app å¯¦ä¾‹ä¸¦é¡¯ç¤º
            import tkinter as tk
            for w in tk._default_root.winfo_children():
                if hasattr(w, 'show_download_summary'):
                    w.show_download_summary(start_date, end_date, outlet_count)
                    break
        except Exception:
            pass

        # ====== ä¸‹è¼‰é‚è¼¯çµæŸå¾Œï¼Œæ•´ç†æœ¬æ¬¡å¯¦éš›ä¸‹è¼‰æ‰€ç”¨éƒµä»¶çš„ body ======
        bodies = []
        signature_keywords = [
            'best regards', 'regards', 'thanks', 'thank you', 'cheers', 'sincerely', 'æ­¤è‡´', 'æ•¬ç¤¼', 'ç¥å¥½', 'è¬è¬', 'æ„Ÿè¬', 'è‡´æ•¬', 'æ•¬ä¸Š', 'é¡ºç¥å•†ç¥º', 'é¡ºé¢‚æ—¶ç¥º', 'é¡ºé¢‚å•†ç¥º', 'é¡ºè‡´æ•¬æ„', 'With regards', 'Yours faithfully', 'Yours sincerely', 'Yours truly', 'Kind regards', 'BR', 'æ•¬è«‹', 'é †é Œ']
        import re
        for idx, msg in enumerate(selected_messages.values(), 1):
            try:
                sender = getattr(msg, 'SenderName', '')
                subject = getattr(msg, 'Subject', '')
                body = getattr(msg, 'Body', '') or ''
                
                # è·å–é‚®ä»¶å‘é€æ—¶é—´
                try:
                    received_time = getattr(msg, 'ReceivedTime', None)
                    if received_time:
                        # è½¬æ¢Outlookæ—¶é—´æ ¼å¼ä¸ºPython datetime
                        if hasattr(received_time, 'year'):
                            email_time = received_time
                        else:
                            # å¦‚æœæ˜¯COMæ—¶é—´å¯¹è±¡ï¼Œè½¬æ¢ä¸ºPython datetime
                            email_time = datetime.fromtimestamp(received_time.timestamp())
                        time_str = email_time.strftime('%Y-%m-%d %H:%M:%S')
                    else:
                        time_str = "æœªçŸ¥æ—¶é—´"
                except:
                    time_str = "æœªçŸ¥æ—¶é—´"
                
                body_lines = body.splitlines()
                cut_idx = len(body_lines)
                for i, line in enumerate(body_lines):
                    l = line.strip().lower()
                    if any(kw in l for kw in signature_keywords):
                        cut_idx = i
                        break
                clean_body = '\n'.join(body_lines[:cut_idx]).strip()
                if not clean_body:
                    clean_body = "(æ— æ­£æ–‡)"
                pretty = f"â€”â€”â€” é‚®ä»¶ {idx} â€”â€”â€”\n[å‘ä»¶äºº] {sender}\n[ä¸»é¢˜] {subject}\n[æ—¶é—´] {time_str}\n[å†…å®¹]\n" + clean_body
                bodies.append(pretty)
            except Exception:
                continue
        cls.extracted_bodies = bodies
        # è‡ªå‹•å¯«å‡º email_bodies_log.txtï¼ˆåƒ…åŒ…å«æœ¬æ¬¡æˆåŠŸä¸‹è¼‰çš„éƒµä»¶ï¼‰
        try:
            log_file = os.path.join(save_path, "email_bodies_log.txt")
            with open(log_file, "w", encoding="utf-8") as f:
                f.write("\n\n".join(bodies))
        except Exception as e:
            pass

        print("[DEBUG] config_file:", config_file)
        print("[DEBUG] save_path:", save_path)
        print("[DEBUG] email_to_short:", email_to_short)
        print("[DEBUG] messages count:", len(messages))
        for msg in messages:
            try:
                sender_email = cls.get_smtp_address(msg).strip().lower()
                if not sender_email:
                    print("[DEBUG] msg.Sender:", getattr(msg, "Sender", None))
                    print(
    "[DEBUG] msg.SenderName:", getattr(
        msg, "SenderName", None))
                    print(
    "[DEBUG] msg.SenderEmailAddress:", getattr(
        msg, "SenderEmailAddress", None))
                    print(
    "[DEBUG] msg.SenderEmailType:", getattr(
        msg, "SenderEmailType", None))
                print("[DEBUG] sender_email:", sender_email)
            except Exception as e:
                print("[DEBUG] error getting sender_email:", e)
        # åœ¨æµç¨‹çµæŸæ™‚è‡ªå‹•é—œé–‰consoleï¼ˆåƒ…é™exeä¸”æœ‰consoleæ™‚ï¼‰
        if getattr(
    sys,
    'frozen',
     False) and sys.stdout and sys.stdout.isatty():
            import time
            print(
                "[DEBUG] Download process finished. Console will close in 5 seconds...")
            time.sleep(5)
            sys.exit(0)

        print(
    "[DEBUG] All sender_email with weekly order downloaded:",
     list(downloaded_emails))

    @classmethod
    def download_amendment_orders(
    cls,
    destination_folder,
    config_file=None,
    account_idx=None,
    callback=None,
     progress_popup=None):
        """å°ˆé–€ä¸‹è¼‰ Amendment è¨‚å–®"""
        import win32com.client
        import pythoncom
        from datetime import datetime, timedelta
        import os
        import re
        import pandas as pd

        # åˆå§‹åŒ– COM çµ„ä»¶
        pythoncom.CoInitialize()

        # å–å¾—ä»Šå¤©æ—¥æœŸ
        today = datetime.now()
        week_no = today.isocalendar()[1]

        # ====== Amendment ä½¿ç”¨èˆ‡ Weekly Order ç›¸åŒçš„æ™‚é–“ç¯„åœ (ä¸Šé€±äº”åˆ°ä»Šå¤©) ======
        # today.weekday(): 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri, 5=Sat, 6=Sun
        # Amendment æ‡‰è©²å’Œ Weekly Order ä½¿ç”¨ç›¸åŒçš„æœå°‹ç¯„åœï¼šå¾ä¸Šé€±äº”é–‹å§‹
        days_since_last_friday = (today.weekday() - 4) % 7 or 7
        start_of_period = (
    today -
    timedelta(
        days=days_since_last_friday)).replace(
            hour=0,
            minute=0,
            second=0,
             microsecond=0)
        end_of_period = today.replace(
    hour=23, minute=59, second=59, microsecond=999999)

        if callback:
            callback(
    f"ğŸ“… Amendment æœå°‹æ™‚é–“ç¯„åœ: å¾ä¸Šé€±äº” {
        start_of_period.strftime('%Y-%m-%d')} åˆ°ä»Šå¤© {
            end_of_period.strftime('%Y-%m-%d')}")

        # ç”Ÿæˆæœˆä»½-æ˜ŸæœŸæ ¼å¼çš„ Amendment æ–‡ä»¶å¤¹åç§°
        # ä½¿ç”¨ä¸‹é€±ä¸€çš„æ—¥æœŸä¾†è¨ˆç®—æ–‡ä»¶å¤¾åç¨±ï¼Œèˆ‡è¨‚å–®è‡ªå‹•åŒ–é‚è¼¯ä¿æŒä¸€è‡´
        next_monday = today + timedelta(days=(7 - today.weekday()))
        month_name = next_monday.strftime('%b').title()  # ç¡®ä¿é¦–å­—æ¯å¤§å†™ï¼Œä¾‹å¦‚: Aug, Sep
        week_of_month = get_week_of_month(next_monday)
        amendment_folder_name = f"{month_name} - Week {week_of_month}_Amendment"
        
        save_path = os.path.join(
    destination_folder, amendment_folder_name)
        os.makedirs(save_path, exist_ok=True)

        # å‰µå»º Supplier Order å­æ–‡ä»¶å¤¾
        supplier_order_path = os.path.join(
    save_path, f"Supplier Order - Week {week_no}")
        os.makedirs(supplier_order_path, exist_ok=True)

        if callback:
            callback(f"ğŸ“ å·²å‰µå»ºæ–‡ä»¶å¤¾: {amendment_folder_name}")
            callback(f"ğŸ“ å·²å‰µå»ºå­æ–‡ä»¶å¤¾: Supplier Order - Week {week_no}")

        # ====== æª¢æŸ¥å·²ä¸‹è¼‰æª”æ¡ˆè¨˜éŒ„ ======
        downloaded_log_file = os.path.join(
    save_path, "downloaded_amendment_log.txt")
        downloaded_files = set()
        if os.path.exists(downloaded_log_file):
            try:
                with open(downloaded_log_file, 'r', encoding='utf-8') as f:
                    for line in f:
                        line = line.strip()
                        if line:
                            downloaded_files.add(line)
                if callback:
                    callback(
    f"ğŸ“‹ å·²è¼‰å…¥ {
        len(downloaded_files)} å€‹å·²ä¸‹è¼‰ Amendment æª”æ¡ˆè¨˜éŒ„")
            except Exception as e:
                if callback:
                    callback(f"âš ï¸ è¼‰å…¥å·²ä¸‹è¼‰ Amendment è¨˜éŒ„å¤±æ•—: {e}")

        def save_downloaded_amendment_info(
    filename, sender_email, subject, received_time):
            """è¨˜éŒ„å·²ä¸‹è¼‰çš„ Amendment æª”æ¡ˆè³‡è¨Š"""
            try:
                with open(downloaded_log_file, 'a', encoding='utf-8') as f:
                    file_info = f"{filename}|{sender_email}|{subject}|{received_time}"
                    f.write(file_info + "\n")
                    downloaded_files.add(file_info)
            except Exception as e:
                if callback:
                    callback(f"âš ï¸ è¨˜éŒ„ Amendment ä¸‹è¼‰è³‡è¨Šå¤±æ•—: {e}")

        def is_amendment_already_downloaded(
    filename, sender_email, subject, received_time):
            """æª¢æŸ¥ Amendment æª”æ¡ˆæ˜¯å¦å·²ç¶“ä¸‹è¼‰é"""
            file_info = f"{filename}|{sender_email}|{subject}|{received_time}"
            return file_info in downloaded_files

        # ===== è®€ configï¼Œå»ºç«‹ email -> short_name æ˜ å°„ =====
        email_to_short = {}  # email(lowercase) -> short_name
        name_to_short = {}   # name(lowercase)  -> short_name
        if config_file and os.path.exists(config_file):
            try:
                df = pd.read_excel(config_file)
                for _, row in df.iterrows():
                    email = str(row.iloc[2]).strip().lower() if len(
                        row) > 2 and not pd.isna(row.iloc[2]) else ''
                    short_name = str(row.iloc[0]).strip() if len(
                        row) > 0 and not pd.isna(row.iloc[0]) else ''
                    name_in_email = str(row.iloc[4]).strip().lower() if len(
                        row) > 4 and not pd.isna(row.iloc[4]) else ''
                    if email and short_name:
                        email_to_short[email] = short_name
                    if name_in_email and short_name:
                        name_to_short[name_in_email] = short_name
            except Exception as e:
                pass

        # é¸æ“‡å¸³è™Ÿ
        outlook = win32com.client.Dispatch(
            "Outlook.Application").GetNamespace("MAPI")
        accounts = [
    outlook.Folders.Item(
        i +
        1) for i in range(
            outlook.Folders.Count)]
        if account_idx is None:
            account_names = [acct.Name for acct in accounts]
            # ä½¿ç”¨ç¾åŒ–çš„å¸³è™Ÿé¸æ“‡å°è©±æ¡†
            idx = show_outlook_account_selector(None, account_names)

            if idx is None:
                return
            account_idx = idx
        account_folder = accounts[account_idx]

        # éè¿´æŠ“å–æ‰€æœ‰å­è³‡æ–™å¤¾çš„éƒµä»¶
        def collect_messages_from_subfolders(folder):
            all_messages = []
            try:
                if hasattr(
    folder,
     'DefaultItemType') and folder.DefaultItemType == 0:
                    items = folder.Items
                    items.Sort("[ReceivedTime]", True)
                    count = 0
                    for msg in items:
                        try:
                            if msg.Class == 43:
                                received = getattr(msg, 'ReceivedTime', None)
                                subject = getattr(msg, 'Subject', '')
                                if received:
                                    if hasattr(
    received, 'tzinfo') and received.tzinfo is not None:
                                        received_naive = received.replace(
                                            tzinfo=None)
                                    else:
                                        received_naive = received
                                    if start_of_period <= received_naive <= end_of_period:
                                        all_messages.append(msg)
                                        count += 1
                        except Exception as e:
                            pass
            except Exception as e:
                pass
            for sub in folder.Folders:
                all_messages.extend(collect_messages_from_subfolders(sub))
            return all_messages

        messages = collect_messages_from_subfolders(account_folder)
        if callback:
            callback(f"ğŸ“¬ å–å¾—éƒµä»¶æ•¸é‡ï¼ˆAmendment æ¨¡å¼ï¼‰: {len(messages)}")

        # ç‚ºæ¯å€‹é–€å¸‚æ”¶é›†æ‰€æœ‰éƒµä»¶ï¼ŒæŒ‰æ™‚é–“æ’åº
        all_messages_by_sender = {}
        for msg in messages:
            try:
                sender_email = cls.get_smtp_address(msg).strip().lower()
                sender_name = getattr(msg, "SenderName", "").strip().lower()
                key = None
                if sender_email in email_to_short:
                    key = sender_email
                elif sender_name in name_to_short:
                    key = sender_name
                if not key:
                    continue
                if key not in all_messages_by_sender:
                    all_messages_by_sender[key] = []
                all_messages_by_sender[key].append(msg)
            except Exception:
                continue

        # æŒ‰æ™‚é–“æ’åºæ¯å€‹é–€å¸‚çš„éƒµä»¶
        for key in all_messages_by_sender:
            all_messages_by_sender[key].sort(
    key=lambda x: x.ReceivedTime, reverse=True)

        downloaded = 0
        skipped = 0
        downloaded_short_names = set()

        # ===== Amendment ä¸‹è¼‰é‚è¼¯ =====
        for key, messages_list in all_messages_by_sender.items():
            try:
                # å…ˆæ‰¾ short_name
                if key in email_to_short:
                    short_name = email_to_short[key]
                elif key in name_to_short:
                    short_name = name_to_short[key]
                else:
                    continue
                amendment_found = False

                # éæ­·è©²é–€å¸‚çš„æ‰€æœ‰éƒµä»¶ï¼ŒæŒ‰æ™‚é–“é †åºï¼ˆå¾æ–°åˆ°èˆŠï¼‰
                for msg in messages_list:
                    attachments = msg.Attachments
                    if attachments.Count == 0:
                        continue

                    # æª¢æŸ¥æ˜¯å¦æœ‰ Amendment Excel é™„ä»¶
                    amendment_attachments = []
                    for att in attachments:
                        filename = att.FileName
                        name_lower = filename.lower()
                        # æª¢æŸ¥æ˜¯å¦ç‚º Excel æ–‡ä»¶ä¸”åŒ…å« amendment é—œéµå­—
                        if name_lower.endswith(
                            '.xlsx') or name_lower.endswith('.xls'):
                            # åªæœå°‹ amendment ç›¸é—œé—œéµå­—ï¼Œæ’é™¤ weekly order
                            amendment_keywords = [
                                'amendment', 'amend', 'ament', 'admentmend', 'adment', 'amendmend', 'amendement'
                            ]
                            if any(
    keyword in name_lower for keyword in amendment_keywords):
                                amendment_attachments.append(att)

                    # æª¢æŸ¥éƒµä»¶ä¸»æ—¨æ˜¯å¦åŒ…å« amendment
                    subject = getattr(msg, 'Subject', '') or ''
                    subject_lower = subject.lower()
                    # åªæœå°‹ amendment ç›¸é—œé—œéµå­—ï¼Œæ’é™¤ weekly order
                    amendment_keywords = [
                        'amendment', 'amend', 'ament', 'admentmend', 'adment', 'amendmend', 'amendement'
                    ]
                    is_amendment_subject = any(
    keyword in subject_lower for keyword in amendment_keywords)

                    # å¦‚æœæ²’æœ‰ Amendment é™„ä»¶ä¸”ä¸»æ—¨ä¹Ÿä¸æ˜¯ Amendmentï¼Œç¹¼çºŒä¸‹ä¸€å°éƒµä»¶
                    if not amendment_attachments and not is_amendment_subject:
                        continue

                    # æ‰¾åˆ° Amendment é™„ä»¶ï¼Œä¸‹è¼‰ç¬¬ä¸€å€‹
                    if amendment_attachments:
                        att = amendment_attachments[0]
                        filename = att.FileName
                        save_filename = f"{short_name}_Amendment_{month_name}_{week_of_month}.xlsx"
                        full_path = os.path.join(save_path, save_filename)

                        # æª¢æŸ¥æ˜¯å¦å·²ç¶“ä¸‹è¼‰éç›¸åŒçš„éƒµä»¶
                        sender_email = cls.get_smtp_address(msg).strip().lower()
                        subject = getattr(msg, 'Subject', '') or ''
                        received_time = getattr(msg, 'ReceivedTime', None)
                        received_time_str = received_time.strftime('%Y-%m-%d %H:%M:%S') if hasattr(received_time, 'strftime') else ''

                        if is_amendment_already_downloaded(filename, sender_email, subject, received_time_str):
                            if callback:
                                callback(f"â© è·³éå·²ä¸‹è¼‰ Amendment: {filename} (from {key})")
                            continue

                        # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è©²é–€å¸‚çš„ Amendment æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨å‰‡åˆªé™¤èˆŠçš„
                        old_file_deleted = False
                        if os.path.exists(full_path):
                            try:
                                os.remove(full_path)
                                old_file_deleted = True
                                if callback:
                                    callback(f"ğŸ—‘ï¸ å·²åˆªé™¤èˆŠçš„ Amendment æ–‡ä»¶: {save_filename}")
                            except Exception as e:
                                if callback:
                                    callback(f"âš ï¸ ç„¡æ³•åˆªé™¤èˆŠçš„ Amendment æ–‡ä»¶ {full_path}: {e}")

                        # ä¸‹è¼‰æ–°æ–‡ä»¶
                        att.SaveAsFile(full_path)

                        # è¨˜éŒ„ä¸‹è¼‰è³‡è¨Š
                        save_downloaded_amendment_info(filename, sender_email, subject, received_time_str)

                        downloaded += 1
                        downloaded_short_names.add(short_name)
                        amendment_found = True
                        if progress_popup:
                            progress_popup.update_outlet_count(len(downloaded_short_names))
                        if callback:
                            if old_file_deleted:
                                callback(f"âœ… {short_name}: {filename} (å·²æ›´æ–° Amendment)")
                            else:
                                callback(f"âœ… {short_name}: {filename} (Amendment)")
                        break  # æ‰¾åˆ° Amendment é™„ä»¶å¾Œè·³å‡ºå¾ªç’°

                    # å¦‚æœä¸»æ—¨åŒ…å« amendment ä½†æ²’æœ‰ amendment é™„ä»¶ï¼Œä¸‹è¼‰ç¬¬ä¸€å€‹ Excel é™„ä»¶
                    elif is_amendment_subject:
                        excel_attachments = []
                        for att in attachments:
                            filename = att.FileName
                            name_lower = filename.lower()
                            if name_lower.endswith(
                                '.xlsx') or name_lower.endswith('.xls'):
                                excel_attachments.append(att)

                        if excel_attachments:
                            att = excel_attachments[0]
                            filename = att.FileName
                            save_filename = f"{short_name}_Amendment_{month_name}_{week_of_month}.xlsx"
                            full_path = os.path.join(save_path, save_filename)

                            # æª¢æŸ¥æ˜¯å¦å·²ç¶“ä¸‹è¼‰éç›¸åŒçš„éƒµä»¶
                            sender_email = cls.get_smtp_address(msg).strip().lower()
                            subject = getattr(msg, 'Subject', '') or ''
                            received_time = getattr(msg, 'ReceivedTime', None)
                            received_time_str = received_time.strftime('%Y-%m-%d %H:%M:%S') if hasattr(received_time, 'strftime') else ''

                            if is_amendment_already_downloaded(filename, sender_email, subject, received_time_str):
                                if callback:
                                    callback(f"â© è·³éå·²ä¸‹è¼‰ Amendment: {filename} (from {key})")
                                continue

                            # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è©²é–€å¸‚çš„ Amendment æ–‡ä»¶ï¼Œå¦‚æœå­˜åœ¨å‰‡åˆªé™¤èˆŠçš„
                            old_file_deleted = False
                            if os.path.exists(full_path):
                                try:
                                    os.remove(full_path)
                                    old_file_deleted = True
                                    if callback:
                                        callback(f"ğŸ—‘ï¸ å·²åˆªé™¤èˆŠçš„ Amendment æ–‡ä»¶: {save_filename}")
                                except Exception as e:
                                    if callback:
                                        callback(f"âš ï¸ ç„¡æ³•åˆªé™¤èˆŠçš„ Amendment æ–‡ä»¶ {full_path}: {e}")

                        # ä¸‹è¼‰æ–°æ–‡ä»¶
                        att.SaveAsFile(full_path)

                        # è¨˜éŒ„ä¸‹è¼‰è³‡è¨Š
                        save_downloaded_amendment_info(filename, sender_email, subject, received_time_str)

                        downloaded += 1
                        downloaded_short_names.add(short_name)
                        amendment_found = True
                        if progress_popup:
                            progress_popup.update_outlet_count(len(downloaded_short_names))
                        if callback:
                            if old_file_deleted:
                                callback(f"âœ… {short_name}: {filename} (å·²æ›´æ–° Amendment)")
                            else:
                                callback(f"âœ… {short_name}: {filename} (Amendment)")
                        break  # æ‰¾åˆ° Amendment é™„ä»¶å¾Œè·³å‡ºå¾ªç’°

                # å¦‚æœè©²é–€å¸‚çš„æ‰€æœ‰éƒµä»¶éƒ½æ²’æœ‰æ‰¾åˆ° Amendmentï¼Œè¨˜éŒ„è·³é
                if not amendment_found:
                    if callback:
                        callback(f"â© è·³é {key} - æ²’æœ‰æ‰¾åˆ° Amendment æª”æ¡ˆ")
                    skipped += 1

            except Exception as e:
                if callback:
                    callback(f"âŒ Failed to process Amendment message: {e}")
                skipped += 1

        config_short_names = set(email_to_short.values())
        not_downloaded = config_short_names - downloaded_short_names
        summary = (
            f"\n=== Amendment Download Summary ===\n"
            f"Downloaded Amendment: {downloaded}\n"
            f"Skipped: {skipped}\n"
            f"Saved to: {save_path}\n"
            f"\n=== Amendment æª”æ¡ˆä¸‹è¼‰çµæœ ===\n"
            f"å·²ä¸‹è¼‰: {
    ', '.join(
        sorted(downloaded_short_names)) if downloaded_short_names else 'ç„¡'}\n"
            f"æœªä¸‹è¼‰: {
    ', '.join(
        sorted(not_downloaded)) if not_downloaded else 'ç„¡'}"
        )
        if callback:
            callback(summary)

    @classmethod
    def download_siahuat_orders(
        cls,
        destination_folder,
        config_file=None,
        account_idx=None,
        callback=None,
        progress_popup=None):
        """å°ˆé–€ä¸‹è¼‰ Siahuat è¨‚å–® - å¾æœ¬æœˆ1è™Ÿé–‹å§‹"""
        import win32com.client
        import pythoncom
        from datetime import datetime
        import os
        import re
        import pandas as pd

        # åˆå§‹åŒ– COM çµ„ä»¶
        pythoncom.CoInitialize()

        # å–å¾—ä»Šå¤©æ—¥æœŸ
        today = datetime.now()
        month_no = today.month
        year = today.year

        # ====== Siahuat å°ˆç”¨æ™‚é–“ç¯„åœï¼šå¾æœ¬æœˆ1è™Ÿåˆ°ä»Šå¤© ======
        start_of_month = today.replace(day=1, hour=0, minute=0, second=0, microsecond=0)
        end_of_period = today.replace(hour=23, minute=59, second=59, microsecond=999999)

        if callback:
            callback(f"ğŸ“… Siahuat æœå°‹æ™‚é–“ç¯„åœ: å¾æœ¬æœˆ1è™Ÿ {start_of_month.strftime('%Y-%m-%d')} åˆ°ä»Šå¤© {end_of_period.strftime('%Y-%m-%d')}")

        save_path = os.path.join(destination_folder, f"Siahuat_Orders_{year}_{month_no:02d}")
        os.makedirs(save_path, exist_ok=True)

        if callback:
            callback(f"ğŸ“ å·²å‰µå»ºæ–‡ä»¶å¤¾: Siahuat_Orders_{year}_{month_no:02d}")

        # ====== æª¢æŸ¥å·²ä¸‹è¼‰æª”æ¡ˆè¨˜éŒ„ ======
        downloaded_log_file = os.path.join(save_path, "downloaded_siahuat_log.txt")
        downloaded_files = set()
        if os.path.exists(downloaded_log_file):
            with open(downloaded_log_file, 'r', encoding='utf-8') as f:
                downloaded_files = set(line.strip() for line in f if line.strip())

        try:
            outlook = win32com.client.Dispatch("Outlook.Application").GetNamespace("MAPI")
            accounts = [outlook.Folders.Item(i + 1) for i in range(outlook.Folders.Count)]

            if account_idx >= len(accounts):
                if callback:
                    callback(f"âŒ å¸³è™Ÿç´¢å¼• {account_idx} è¶…å‡ºç¯„åœ")
                return

            account = accounts[account_idx]
            if callback:
                callback(f"ğŸ“§ ä½¿ç”¨å¸³è™Ÿ: {account.Name}")

            # ====== è®€å– config æ–‡ä»¶ä¸­çš„ email address ======
            config_emails = set()
            email_to_short = {}
            
            if config_file and os.path.exists(config_file):
                try:
                    import pandas as pd
                    df = pd.read_excel(config_file)
                    
                    for _, row in df.iterrows():
                        # å‡è¨­ç¬¬3åˆ—æ˜¯éƒµç®±ï¼Œç¬¬1åˆ—æ˜¯çŸ­åç¨±
                        email = str(row.iloc[2]).strip().lower() if len(row) > 2 and not pd.isna(row.iloc[2]) else ''
                        short_name = str(row.iloc[0]).strip() if len(row) > 0 and not pd.isna(row.iloc[0]) else ''
                        
                        if email and short_name:
                            config_emails.add(email)
                            email_to_short[email] = short_name
                            
                    if callback:
                        callback(f"ğŸ“‹ å¾é…ç½®æ–‡ä»¶è¼‰å…¥äº† {len(config_emails)} å€‹éƒµç®±åœ°å€")
                except Exception as e:
                    if callback:
                        callback(f"âŒ è®€å–é…ç½®æ–‡ä»¶å¤±æ•—: {e}")
                    return
            else:
                if callback:
                    callback("âŒ æœªæä¾›é…ç½®æ–‡ä»¶æˆ–æ–‡ä»¶ä¸å­˜åœ¨")
                return

            # ====== æœå°‹ Siahuat ç›¸é—œéƒµä»¶ ======
            all_messages_by_sender = {}

            # å®šç¾© Siahuat ç›¸é—œçš„æœå°‹é—œéµè©
            siahuat_keywords = ['siahuat', 'siah', 'uat', 'è¨‚å–®', 'order']

            def search_folder_for_siahuat(folder, level=0):
                """éæ­¸æœå°‹è³‡æ–™å¤¾ä¸­çš„ Siahuat ç›¸é—œéƒµä»¶"""
                indent = "  " * level
                try:
                    if callback:
                        callback(f"{indent}ğŸ” æœå°‹è³‡æ–™å¤¾: {folder.Name}")

                    # æœå°‹éƒµä»¶
                    items = folder.Items
                    items.Sort("[ReceivedTime]", True)

                    found_count = 0
                    for item in items:
                        try:
                            received = getattr(item, 'ReceivedTime', None)
                            subject = getattr(item, 'Subject', '') or ''
                            body = getattr(item, 'Body', '') or ''

                            if not received:
                                continue

                            # è½‰æ›æ™‚å€
                            if hasattr(received, 'tzinfo') and received.tzinfo is not None:
                                received_naive = received.replace(tzinfo=None)
                            else:
                                received_naive = received

                            # æª¢æŸ¥æ˜¯å¦åœ¨æœ¬æœˆæ—¥æœŸç¯„åœå…§
                            if start_of_month <= received_naive <= end_of_period:
                                # æª¢æŸ¥æ˜¯å¦åŒ…å« Siahuat é—œéµè©
                                content_to_check = (subject + ' ' + body).lower()
                                if any(keyword in content_to_check for keyword in siahuat_keywords):
                                    sender_email = cls.get_smtp_address(item)
                                    if sender_email:
                                        sender_email = sender_email.strip().lower()
                                        
                                        # æª¢æŸ¥ç™¼é€è€…æ˜¯å¦åœ¨ config æ–‡ä»¶ä¸­
                                        if config_emails and not any(config_email in sender_email for config_email in config_emails):
                                            continue
                                        
                                        if sender_email not in all_messages_by_sender:
                                            all_messages_by_sender[sender_email] = []
                                        all_messages_by_sender[sender_email].append(item)
                                        found_count += 1

                        except Exception as e:
                            continue

                    if found_count > 0 and callback:
                        callback(f"{indent}  âœ… æ‰¾åˆ° {found_count} å° Siahuat ç›¸é—œéƒµä»¶")

                    # éæ­¸æœå°‹å­è³‡æ–™å¤¾
                    for subfolder in folder.Folders:
                        search_folder_for_siahuat(subfolder, level + 1)

                except Exception as e:
                    if callback:
                        callback(f"{indent}âŒ æœå°‹è³‡æ–™å¤¾ {folder.Name} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

            # å¾æ”¶ä»¶åŒ£é–‹å§‹æœå°‹
            inbox = account.Folders("Inbox")
            search_folder_for_siahuat(inbox)

            if callback:
                callback(f"ğŸ“Š ç¸½å…±æ‰¾åˆ° {len(all_messages_by_sender)} å€‹ç™¼é€è€…çš„ Siahuat ç›¸é—œéƒµä»¶")

            # ====== ä¸‹è¼‰é™„ä»¶ ======
            downloaded = 0
            skipped = 0
            total_senders = len(all_messages_by_sender)

            for sender_idx, (sender_email, messages_list) in enumerate(all_messages_by_sender.items(), 1):
                if callback:
                    callback(f"ğŸ“§ è™•ç†ç™¼é€è€… {sender_idx}/{total_senders}: {sender_email}")

                # æŒ‰æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
                messages_list.sort(key=lambda x: getattr(x, 'ReceivedTime', datetime.min), reverse=True)

                for msg_idx, msg in enumerate(messages_list):
                    try:
                        subject = getattr(msg, 'Subject', '') or ''
                        received_time = getattr(msg, 'ReceivedTime', None)
                        attachments = msg.Attachments

                        if attachments.Count == 0:
                            continue

                        if callback:
                            callback(f"  ğŸ“ æª¢æŸ¥éƒµä»¶: {subject}")

                        # ä¸‹è¼‰æ‰€æœ‰é™„ä»¶
                        for att_idx in range(attachments.Count):
                            try:
                                att = attachments.Item(att_idx + 1)
                                filename = att.FileName

                                # æª¢æŸ¥æ˜¯å¦å·²ä¸‹è¼‰
                                file_id = f"{sender_email}_{filename}_{received_time.strftime('%Y%m%d_%H%M%S') if received_time else 'unknown'}"
                                if file_id in downloaded_files:
                                    skipped += 1
                                    continue

                                # å‰µå»ºæ–°æª”å
                                timestamp = received_time.strftime('%Y%m%d_%H%M%S') if received_time else 'unknown'
                                clean_sender = re.sub(r'[<>:"/\\|?*]', '_', sender_email)
                                file_ext = os.path.splitext(filename)[1]
                                new_filename = f"Siahuat_{clean_sender}_{timestamp}_{filename}"

                                save_file = os.path.join(save_path, new_filename)
                                att.SaveAsFile(save_file)

                                # è¨˜éŒ„ä¸‹è¼‰
                                with open(downloaded_log_file, 'a', encoding='utf-8') as f:
                                    f.write(file_id + '\n')
                                downloaded_files.add(file_id)

                                downloaded += 1
                                if callback:
                                    callback(f"    âœ… ä¸‹è¼‰: {new_filename}")

                            except Exception as e:
                                if callback:
                                    callback(f"    âŒ ä¸‹è¼‰é™„ä»¶å¤±æ•—: {e}")
                                skipped += 1

                    except Exception as e:
                        if callback:
                            callback(f"  âŒ è™•ç†éƒµä»¶å¤±æ•—: {e}")
                        skipped += 1

            # ====== ç¸½çµ ======
            summary = f"""
ğŸ‰ Siahuat è¨‚å–®ä¸‹è¼‰å®Œæˆï¼

ğŸ“Š ä¸‹è¼‰çµ±è¨ˆ:
â€¢ ğŸ“… æœå°‹æœŸé–“: {start_of_month.strftime('%Y-%m-%d')} åˆ° {end_of_period.strftime('%Y-%m-%d')}
â€¢ ğŸ“§ ç™¼é€è€…æ•¸é‡: {total_senders}
â€¢ âœ… æˆåŠŸä¸‹è¼‰: {downloaded} å€‹æª”æ¡ˆ
â€¢ â© è·³éé‡è¤‡: {skipped} å€‹æª”æ¡ˆ
â€¢ ğŸ“ ä¿å­˜ä½ç½®: {save_path}
"""

            if callback:
                callback(summary)

        except Exception as e:
            error_msg = f"âŒ Siahuat è¨‚å–®ä¸‹è¼‰å¤±æ•—: {str(e)}"
            if callback:
                callback(error_msg)
            print(error_msg)

    @classmethod
    def _collect_messages(cls, folder, start_date, end_date, allowed_senders):
        """éæ­·æ‰€æœ‰å­è³‡æ–™å¤¾ï¼Œæ”¶é›†æœ¬é€±æ‰€æœ‰éƒµä»¶ï¼ˆåªä¿ç•™ config è£¡çš„ senderï¼‰"""
        messages = []
        try:
            items = folder.Items
            items.Sort("[ReceivedTime]", True)
            for msg in items:
                try:
                    received = getattr(msg, 'ReceivedTime', None)
                    msg_class = getattr(msg, 'Class', None)
                    subject = getattr(msg, 'Subject', '')
                    sender_type = getattr(msg, 'SenderEmailType', '')
                    sender_addr = getattr(msg, 'SenderEmailAddress', '')
                    primary_smtp = ''
                    if sender_type == 'EX':
                        try:
                            ex_user = msg.Sender.GetExchangeUser()
                            if ex_user and hasattr(
                                ex_user, 'PrimarySmtpAddress'):
                                primary_smtp = str(
    ex_user.PrimarySmtpAddress).lower()
                        except Exception as e:
                            print(
    f"[DEBUG] Error getting PrimarySmtpAddress: {e}")
                    if received:
                        if hasattr(received,
     'tzinfo') and received.tzinfo is not None:
                            received_naive = received.replace(tzinfo=None)
                        else:
                            received_naive = received
                        if start_date <= received_naive <= end_date:
                            sender_email = clean_email(
                                cls.get_smtp_sender(msg))
                            print(
    f"[DEBUG] æ”¶ä»¶æ—¥: {received_naive}, ä¸»æ—¨: {subject}, SenderEmailType: {sender_type}, SenderEmailAddress: {sender_addr}, PrimarySmtpAddress: {primary_smtp}, æ¯”å°ç”¨ sender_email: {sender_email}, msg_class: {msg_class}")
                            if allowed_senders and sender_email in allowed_senders:
                                if msg_class == 43:
                                    messages.append(msg)
                except Exception as e:
                    print(f"[DEBUG] Error reading message: {e}")
        except Exception as e:
            print(f"[DEBUG] Error accessing folder {folder.Name}: {e}")
        for sub in folder.Folders:
            messages.extend(
    cls._collect_messages(
        sub,
        start_date,
        end_date,
         allowed_senders))
        return messages

    @classmethod
    def _download_attachments(
    cls,
    messages,
    save_path,
    email_to_outlet=None,
     week_no=None):
        result = {
            "downloaded": 0,
            "skipped": 0,
            "matched_outlets": [],
            "unmatched_emails": set()
        }
        allowed_senders = set(
    email_to_outlet.keys()) if email_to_outlet else set()
        for msg in messages:
            try:
                sender_email = clean_email(cls.get_smtp_address(msg))
                subject = getattr(msg, "Subject", "") or ""
                attachments = msg.Attachments
                short_name = email_to_outlet.get(sender_email, "")
                if not short_name:
                    result['unmatched_emails'].add(sender_email)
                    continue
                for att in attachments:
                    filename = att.FileName
                    name_lower = filename.lower()
                    subject_lower = subject.lower()
                    # å¤šé‡é—œéµå­—åˆ¤æ–·
                    is_weekly = any(
                        kw in subject_lower or kw in name_lower
                        for kw in ["weekly order", "order form", "ordering"]
                    )
                    if is_weekly:
                        new_filename = f"{short_name}_WeeklyOrder-Week{week_no}{
    os.path.splitext(filename)[1]}"
                        save_file = os.path.join(save_path, new_filename)
                        att.SaveAsFile(save_file)
                        print(f"âœ… Downloaded: {save_file}")
                        result['downloaded'] += 1
                        result['matched_outlets'].append(short_name)
                    else:
                        result['skipped'] += 1
            except Exception as e:
                print(f"Error downloading attachment: {e}")
                result['skipped'] += 1
        return result

    extracted_bodies = []


# ====== æœˆçµæ–‡ä»¶ä¸‹è¼‰åŠŸèƒ½ ======
INVALID_FS_CHARS = r"<>:\\|?*\""  # for Windows


def _sanitize_filename(name: str) -> str:
    """Remove invalid characters and trim length."""
    cleaned = ''.join('_' if ch in INVALID_FS_CHARS else ch for ch in name)
    cleaned = re.sub(r"\s+", " ", cleaned).strip()
    return cleaned[:240]  # keep some room for extension


def _safe_save_path(folder: str, filename: str) -> str:
    base, ext = os.path.splitext(filename)
    path = os.path.join(folder, filename)
    i = 1
    while os.path.exists(path):
        path = os.path.join(folder, f"{base} ({i}){ext}")
        i += 1
    return path


class MonthEndDownloader:
    """Core logic for Outlook SOA/Invoice downloading with filters."""

    DEFAULT_ATTACH_KEYWORDS = [
        'soa', 'statement', 'statement of account', 'invoice', 'inv', 'tax invoice',
    ]
    DEFAULT_EXTS = ['pdf', 'xlsx', 'xls', 'docx']

    def __init__(self, parent):
        self.parent = parent
        self.pdf_merger = None  # PDFåˆå¹¶å™¨
        self.merge_pdfs = True  # æ˜¯å¦åˆå¹¶PDF
        self.merge_by_supplier = True  # æ˜¯å¦æŒ‰ä¾›åº”å•†åˆ›å»ºå­æ–‡ä»¶å¤¹

    # ---- Outlook helpers ----
    def _select_outlook_account(self) -> Optional[int]:
        try:
            import win32com.client
            import pythoncom

            # åˆå§‹åŒ– COM çµ„ä»¶
            pythoncom.CoInitialize()

            mapi = win32com.client.Dispatch(
                "Outlook.Application").GetNamespace("MAPI")
            accounts = [
    mapi.Folders.Item(
        i +
        1).Name for i in range(
            mapi.Folders.Count)]
        except Exception as e:
            messagebox.showerror("Outlook", f"ç„¡æ³•è®€å– Outlook å¸³è™Ÿï¼š{e}")
            return None
        if not accounts:
            messagebox.showwarning("Outlook", "æœªç™¼ç¾ä»»ä½• Outlook å¸³è™Ÿ")
            return None
        if show_outlook_account_selector:
            return show_outlook_account_selector(self.parent, accounts)
        # fallback: pick first
        return 0

    def _resolve_folder(self, mapi, account_idx: int, folder_path: str):
        root = mapi.Folders.Item(account_idx + 1)
        if not folder_path:
            return root.Folders['Inbox']
        cur = root
        for part in folder_path.split('/'):
            part = part.strip()
            if not part:
                continue
            cur = cur.Folders[part]
        return cur

    def _get_all_folders(self, mapi, account_idx: int):
        """ç²å–æ‰€æœ‰è³‡æ–™å¤¾"""
        root = mapi.Folders.Item(account_idx + 1)
        folders = []

        def collect_folders(folder, path=""):
            try:
                current_path = f"{path}/{folder.Name}" if path else folder.Name
                folders.append((current_path, folder))

                # éè¿´æœå°‹å­è³‡æ–™å¤¾
                for i in range(folder.Folders.Count):
                    try:
                        subfolder = folder.Folders.Item(i + 1)
                        collect_folders(subfolder, current_path)
                    except Exception:
                        continue
            except Exception:
                pass

        collect_folders(root)
        return folders

    def _build_restrict(self, start_date: datetime, end_date: datetime) -> str:
        # ReceivedTime inclusive range
        # Use 24-hour clock for better compatibility
        start_str = start_date.strftime('%m/%d/%Y %H:%M')
        end_str = end_date.strftime('%m/%d/%Y %H:%M')

        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        print(f"ğŸ” æ„å»ºOutlookæŸ¥è¯¢æ¡ä»¶:")
        print(f"   å¼€å§‹æ—¥æœŸ: {start_date} -> {start_str}")
        print(f"   ç»“æŸæ—¥æœŸ: {end_date} -> {end_str}")

        return f"[ReceivedTime] >= '{start_str}' AND [ReceivedTime] <= '{end_str}'"

    # ---- Matching rules ----
    def _split_filter_tokens(self, text: str) -> List[str]:
        if not text:
            return []
        # separators: ; , whitespace, newlines
        tokens = re.split(r"[;,\s\n\r]+", text)
        return [t.strip() for t in tokens if t.strip()]

    def _match_email(self, item, email_filters: List[str]) -> bool:
        if not email_filters:
            return True  # å¦‚æœæ²¡æœ‰è¿‡æ»¤æ¡ä»¶ï¼Œæ¥å—æ‰€æœ‰é‚®ä»¶
        # Sender match only (common case). Could be extended to To/CC if
        # needed.
        try:
            sender = (item.SenderEmailAddress or '').lower()
        except Exception:
            sender = ''
        for token in email_filters:
            if token.lower() in sender:
                return True
        return False

    def _match_content(self,
    item,
    content_filters: List[str],
    scope: Tuple[bool,
     bool]) -> bool:
        if not content_filters:
            return True
        check_subj, check_body = scope
        subj = (item.Subject or '') if check_subj else ''
        body = (item.Body or '') if check_body else ''
        haystack = f"{subj}\n{body}".lower()
        return any(tok.lower() in haystack for tok in content_filters)

    def _match_attachment(
    self,
    att,
    name_filters: List[str],
     ext_whitelist: List[str]) -> bool:
        try:
            fname = att.FileName or ''
        except Exception:
            fname = ''
        if not fname:
            return False
        ext_ok = True
        if ext_whitelist:
            ext = os.path.splitext(fname)[1].lstrip('.').lower()
            ext_ok = ext in {e.lower() for e in ext_whitelist}
        name_ok = True
        if name_filters:
            low = fname.lower()
            name_ok = any(k in low for k in [k.lower() for k in name_filters])
        return ext_ok and name_ok

    def _match_attachment_simple(self, att, ext_whitelist: List[str]) -> bool:
        """ç°¡åŒ–çš„é™„ä»¶åŒ¹é…ï¼šåªæª¢æŸ¥å‰¯æª”å"""
        try:
            fname = att.FileName or ''
        except Exception:
            fname = ''
        if not fname:
            return False

        # åªæª¢æŸ¥å‰¯æª”å
        if ext_whitelist:
            ext = os.path.splitext(fname)[1].lstrip('.').lower()
            return ext in {e.lower() for e in ext_whitelist}

        # å¦‚æœæ²’æœ‰å‰¯æª”åé™åˆ¶ï¼Œæ¥å—æ‰€æœ‰é™„ä»¶
        return True

    def _merge_pdfs_by_name(self, save_dir: str, logger) -> int:
        """åˆå¹¶åŒåPDFæ–‡ä»¶"""
        try:
            # æŒ‰æ–‡ä»¶ååˆ†ç»„PDF
            pdf_groups = {}
            for filename in os.listdir(save_dir):
                if filename.lower().endswith('.pdf'):
                    # æå–åŸºç¡€æ–‡ä»¶åï¼ˆå»æ‰æ—¶é—´æˆ³å’Œå‘ä»¶äººå‰ç¼€ï¼‰
                    base_name = self._extract_base_filename(filename)
                    if base_name not in pdf_groups:
                        pdf_groups[base_name] = []
                    pdf_groups[base_name].append(filename)

            merged_count = 0
            for base_name, files in pdf_groups.items():
                if len(files) > 1:
                    # æœ‰å¤šä¸ªåŒåæ–‡ä»¶ï¼Œéœ€è¦åˆå¹¶
                    try:
                        merged_path = os.path.join(
    save_dir, f"{base_name}_merged.pdf")
                        self._merge_pdf_files(
    save_dir, files, merged_path, logger)

                        # åˆ é™¤åŸå§‹æ–‡ä»¶
                        for file in files:
                            os.remove(os.path.join(save_dir, file))

                        merged_count += 1
                        logger(f"   ğŸ“ å·²åˆå¹¶ {len(files)} ä¸ªåŒåPDF: {base_name}")
                    except Exception as e:
                        logger(f"   âš ï¸ åˆå¹¶PDFå¤±è´¥ {base_name}: {e}")

            return merged_count
        except Exception as e:
            logger(f"   âš ï¸ PDFåˆå¹¶å¤„ç†å¤±è´¥: {e}")
            return 0

    def _merge_pdfs_by_similar_names(self, save_dir: str, logger) -> int:
        """åŸºäºç›¸ä¼¼åç§°åˆå¹¶PDFæ–‡ä»¶ï¼ˆæ›´æ™ºèƒ½çš„åˆå¹¶ç­–ç•¥ï¼‰"""
        try:
            # è·å–æ‰€æœ‰PDFæ–‡ä»¶
            pdf_files = [f for f in os.listdir(
                save_dir) if f.lower().endswith('.pdf')]
            if len(pdf_files) < 2:
                return 0

            # æŒ‰ç›¸ä¼¼æ€§åˆ†ç»„
            groups = []
            processed = set()

            for i, file1 in enumerate(pdf_files):
                if file1 in processed:
                    continue

                current_group = [file1]
                processed.add(file1)

                # å¯»æ‰¾ç›¸ä¼¼çš„æ–‡ä»¶
                for j, file2 in enumerate(pdf_files[i + 1:], i + 1):
                    if file2 in processed:
                        continue

                    # æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆå¹¶
                    if self._should_merge_files(file1, file2):
                        current_group.append(file2)
                        processed.add(file2)

                if len(current_group) > 1:
                    groups.append(current_group)

            # åˆå¹¶æ¯ä¸ªç»„
            merged_count = 0
            for group in groups:
                try:
                    # ç”Ÿæˆåˆå¹¶åçš„æ–‡ä»¶å
                    base_name = self._generate_merged_filename(group)
                    merged_path = os.path.join(
    save_dir, f"{base_name}_merged.pdf")

                    # åˆå¹¶PDFæ–‡ä»¶
                    self._merge_pdf_files(save_dir, group, merged_path, logger)

                    # åˆ é™¤åŸå§‹æ–‡ä»¶
                    for file in group:
                        os.remove(os.path.join(save_dir, file))

                    merged_count += 1
                    logger(f"   ğŸ“ å·²åˆå¹¶ {len(group)} ä¸ªç›¸ä¼¼PDF: {base_name}")

                except Exception as e:
                    logger(f"   âš ï¸ åˆå¹¶PDFç»„å¤±è´¥: {e}")

            return merged_count

        except Exception as e:
            logger(f"   âš ï¸ æ™ºèƒ½PDFåˆå¹¶å¤±è´¥: {e}")
            return 0

    def _extract_base_filename(self, filename: str) -> str:
        """æå–PDFæ–‡ä»¶çš„åŸºç¡€åç§°ï¼Œæ”¹è¿›ç‰ˆæœ¬"""
        try:
            # ç§»é™¤æ–‡ä»¶æ‰©å±•å
            name_without_ext = os.path.splitext(filename)[0]

            # å°è¯•å¤šç§æ–‡ä»¶åæ ¼å¼
            # æ ¼å¼1: YYYYMMDD - Sender - Subject - filename
            parts = name_without_ext.split(' - ')
            if len(parts) >= 4:
                base_name = parts[3]  # è¿”å›åŸå§‹æ–‡ä»¶åéƒ¨åˆ†
                # ç§»é™¤å¯èƒ½çš„é‡å¤æ ‡è¯†ç¬¦ (1), (2) ç­‰
                if '(' in base_name and ')' in base_name:
                    base_name = base_name.split('(')[0].strip()
                return base_name

            # æ ¼å¼2: YYYYMMDD - Sender - Subject
            elif len(parts) >= 3:
                # å¦‚æœæ²¡æœ‰åŸå§‹æ–‡ä»¶åï¼Œä½¿ç”¨ä¸»é¢˜ä½œä¸ºåŸºç¡€åç§°
                subject = parts[2]
                # æ¸…ç†ä¸»é¢˜åç§°ï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦
                subject = re.sub(r'[<>:"/\\|?*]', '_', subject)
                return subject[:50]  # é™åˆ¶é•¿åº¦

            # æ ¼å¼3: å…¶ä»–æ ¼å¼ï¼Œå°è¯•æå–æœ‰æ„ä¹‰çš„éƒ¨åˆ†
            else:
                # æŸ¥æ‰¾å¯èƒ½çš„è®¢å•å·æˆ–å‘ç¥¨å·æ¨¡å¼
                # å¸¸è§çš„è®¢å•å·æ¨¡å¼ï¼šæ•°å­—+å­—æ¯ç»„åˆ
                order_pattern = r'[A-Z]{2,}\d{3,}|[A-Z]\d{4,}|\d{3,}[A-Z]{2,}'
                match = re.search(order_pattern, name_without_ext)
                if match:
                    return match.group()

                # å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®¢å•å·ï¼Œè¿”å›æ¸…ç†åçš„æ–‡ä»¶å
                clean_name = re.sub(r'[<>:"/\\|?*]', '_', name_without_ext)
                return clean_name[:50]

        except Exception as e:
            print(f"æå–åŸºç¡€æ–‡ä»¶åå¤±è´¥: {e}")
            # å¦‚æœæå–å¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åï¼‰
            return os.path.splitext(filename)[0]

    def _merge_pdf_files(
    self,
    save_dir: str,
    pdf_files: List[str],
    output_path: str,
     logger):
        """åˆå¹¶å¤šä¸ªPDFæ–‡ä»¶"""
        try:
            # å°è¯•ä½¿ç”¨PyPDF2
            try:
                from PyPDF2 import PdfMerger
                merger = PdfMerger()

                for pdf_file in sorted(pdf_files):  # æŒ‰æ–‡ä»¶åæ’åº
                    file_path = os.path.join(save_dir, pdf_file)
                    merger.append(file_path)

                merger.write(output_path)
                merger.close()
                logger(f"   ğŸ“ ä½¿ç”¨PyPDF2åˆå¹¶PDFæˆåŠŸ")

            except ImportError:
                # å¦‚æœæ²¡æœ‰PyPDF2ï¼Œå°è¯•ä½¿ç”¨pdfrw
                try:
                    from pdfrw import PdfReader, PdfWriter
                    writer = PdfWriter()

                    for pdf_file in sorted(pdf_files):
                        file_path = os.path.join(save_dir, pdf_file)
                        reader = PdfReader(file_path)
                        writer.addpages(reader.pages)

                    writer.write(output_path)
                    logger(f"   ğŸ“ ä½¿ç”¨pdfrwåˆå¹¶PDFæˆåŠŸ")

                except ImportError:
                    # å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨ç³»ç»Ÿå‘½ä»¤
                    logger(f"   âš ï¸ æœªæ‰¾åˆ°PDFåˆå¹¶åº“ï¼Œå°è¯•ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤")
                    self._merge_pdfs_system_command(
    save_dir, pdf_files, output_path, logger)

        except Exception as e:
            logger(f"   âš ï¸ PDFåˆå¹¶å¤±è´¥: {e}")
            raise

    def _merge_pdfs_system_command(
    self,
    save_dir: str,
    pdf_files: List[str],
    output_path: str,
     logger):
        """ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤åˆå¹¶PDFï¼ˆWindowsï¼‰"""
        try:
            import subprocess

            # å°è¯•ä½¿ç”¨pdftkï¼ˆå¦‚æœå®‰è£…äº†ï¼‰
            try:
                cmd = ['pdftk']
                for pdf_file in sorted(pdf_files):
                    file_path = os.path.join(save_dir, pdf_file)
                    cmd.extend([file_path, 'cat'])
                cmd.append(output_path)

                result = subprocess.run(cmd, capture_output=True, text=True)
                if result.returncode == 0:
                    logger(f"   ğŸ“ ä½¿ç”¨pdftkåˆå¹¶PDFæˆåŠŸ")
                    return
            except FileNotFoundError:
                pass

            # å¦‚æœæ²¡æœ‰pdftkï¼Œå°è¯•ä½¿ç”¨PowerShell
            try:
                # ç®€åŒ–ç‰ˆæœ¬ï¼šå¤åˆ¶ç¬¬ä¸€ä¸ªæ–‡ä»¶ä½œä¸ºåˆå¹¶ç»“æœ
                import shutil
                first_file = os.path.join(save_dir, sorted(pdf_files)[0])
                shutil.copy2(first_file, output_path)
                logger(f"   ğŸ“ ä½¿ç”¨æ–‡ä»¶å¤åˆ¶ä½œä¸ºPDFåˆå¹¶æ›¿ä»£æ–¹æ¡ˆ")

            except Exception as e:
                logger(f"   âš ï¸ ç³»ç»Ÿå‘½ä»¤PDFåˆå¹¶å¤±è´¥: {e}")
                # æœ€åæ–¹æ¡ˆï¼šå¤åˆ¶ç¬¬ä¸€ä¸ªæ–‡ä»¶
                import shutil
                first_file = os.path.join(save_dir, sorted(pdf_files)[0])
                shutil.copy2(first_file, output_path)
                logger(f"   ğŸ“ ä½¿ç”¨æ–‡ä»¶å¤åˆ¶ä½œä¸ºPDFåˆå¹¶æ›¿ä»£æ–¹æ¡ˆ")

        except Exception as e:
            logger(f"   âš ï¸ ç³»ç»Ÿå‘½ä»¤PDFåˆå¹¶å¤±è´¥: {e}")
            raise

    def _create_supplier_subfolder(
    self,
    save_dir: str,
     supplier_name: str) -> str:
        """ä¸ºä¾›åº”å•†åˆ›å»ºå­æ–‡ä»¶å¤¹"""
        try:
            # æ¸…ç†ä¾›åº”å•†åç§°ï¼Œç¡®ä¿æ–‡ä»¶å¤¹åæœ‰æ•ˆ
            safe_name = "".join(
    c for c in supplier_name if c.isalnum() or c in (
        ' ', '-', '_')).rstrip()
            safe_name = safe_name.replace(' ', '_')

            supplier_dir = os.path.join(save_dir, safe_name)
            os.makedirs(supplier_dir, exist_ok=True)
            return supplier_dir
        except Exception as e:
            print(f"åˆ›å»ºä¾›åº”å•†å­æ–‡ä»¶å¤¹å¤±è´¥: {e}")
            return save_dir

    def _find_supplier_name(self, sender_email: str) -> str:
        """æ ¹æ®å‘ä»¶äººé‚®ç®±æŸ¥æ‰¾ä¾›åº”å•†åç§°"""
        try:
            # ä»UIè·å–ä¾›åº”å•†åˆ—è¡¨
            if hasattr(self.parent, 'suppliers') and self.parent.suppliers:
                for supplier in self.parent.suppliers:
                    if supplier.get(
    'email', '').lower() == sender_email.lower():
                        return supplier.get('name', '')

            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä»é‚®ç®±åŸŸåæ¨æ–­
            if '@' in sender_email:
                domain = sender_email.split('@')[1].lower()
                # å¸¸è§çš„ä¾›åº”å•†åŸŸåæ˜ å°„
                domain_mapping = {
                    'freshening.com': 'Freshening',
                    'legacy.com': 'Legacy',
                    'unikleen.com': 'Unikleen',
                    # å¯ä»¥æ·»åŠ æ›´å¤šæ˜ å°„
                }
                return domain_mapping.get(domain, '')

            return ''
        except Exception as e:
            print(f"æŸ¥æ‰¾ä¾›åº”å•†åç§°å¤±è´¥: {e}")
            return ''

    def _should_merge_files(self, file1: str, file2: str) -> bool:
        """åˆ¤æ–­ä¸¤ä¸ªæ–‡ä»¶æ˜¯å¦åº”è¯¥åˆå¹¶ - æ”¹è¿›ç‰ˆæœ¬"""
        try:
            # æå–åŸºç¡€ä¿¡æ¯
            info1 = self._extract_file_info(file1)
            info2 = self._extract_file_info(file2)

            # ç­–ç•¥1: ç›¸åŒçš„åŸå§‹æ–‡ä»¶åï¼ˆå»æ‰é‡å¤æ ‡è¯†ç¬¦ï¼‰
            if info1['original_name'] and info2['original_name']:
                # æ¸…ç†æ–‡ä»¶åï¼Œç§»é™¤ (1), (2), (3) ç­‰é‡å¤æ ‡è¯†ç¬¦
                clean_name1 = re.sub(
    r'\s*\(\d+\)\s*$', '', info1['original_name'])
                clean_name2 = re.sub(
    r'\s*\(\d+\)\s*$', '', info2['original_name'])
                if clean_name1.lower() == clean_name2.lower():
                    return True

            # ç­–ç•¥2: ç›¸åŒçš„ä¸»é¢˜ï¼ˆè®¢å•å·/å‘ç¥¨å·ï¼‰
            if info1['subject'] and info2['subject']:
                if info1['subject'].lower() == info2['subject'].lower():
                    return True

            # ç­–ç•¥3: ç›¸åŒçš„å‘ä»¶äºº + åŒ…å«ç›¸åŒè®¢å•å·çš„ä¸»é¢˜
            if (info1['sender'] and info2['sender'] and
                info1['sender'].lower() == info2['sender'].lower()):

                # æ£€æŸ¥ä¸»é¢˜æ˜¯å¦åŒ…å«ç›¸åŒçš„è®¢å•å·æˆ–å‘ç¥¨å·
                subject1 = info1['subject'] or ''
                subject2 = info2['subject'] or ''

                # æŸ¥æ‰¾è®¢å•å·æ¨¡å¼ - æ”¹è¿›ç‰ˆæœ¬
                # æ”¯æŒæ›´å¤šè®¢å•å·æ ¼å¼ï¼šINV-SH250603959, SH250603959, 250603959 ç­‰
                order_patterns = [
                    r'[A-Z]{2,}-\d{6,}',  # INV-SH250603959
                    r'[A-Z]{2,}\d{6,}',   # SH250603959
                    r'\d{6,}',             # 250603959
                    r'[A-Z]{2,}\d{3,}',   # SH250603
                    r'\d{3,}[A-Z]{2,}'    # 250603SH
                ]

                for pattern in order_patterns:
                    orders1 = re.findall(pattern, subject1.upper())
                    orders2 = re.findall(pattern, subject2.upper())

                    if orders1 and orders2:
                        # æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„è®¢å•å·
                        for order1 in orders1:
                            for order2 in orders2:
                                if order1 == order2:
                                    return True

            # ç­–ç•¥4: æ–‡ä»¶åç›¸ä¼¼åº¦æ£€æŸ¥
            similarity = self._calculate_filename_similarity(file1, file2)
            if similarity > 0.8:  # æé«˜ç›¸ä¼¼åº¦é˜ˆå€¼åˆ°80%
                return True

            return False

        except Exception as e:
            print(f"æ£€æŸ¥æ–‡ä»¶åˆå¹¶æ¡ä»¶å¤±è´¥: {e}")
            return False

    def _extract_file_info(self, filename: str) -> dict:
        """æå–æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯"""
        try:
            name_without_ext = os.path.splitext(filename)[0]
            parts = name_without_ext.split(' - ')

            info = {
                'timestamp': parts[0] if len(parts) > 0 else '',
                'sender': parts[1] if len(parts) > 1 else '',
                'subject': parts[2] if len(parts) > 2 else '',
                'original_name': parts[3] if len(parts) > 3 else ''
            }

            return info

        except Exception as e:
            print(f"æå–æ–‡ä»¶ä¿¡æ¯å¤±è´¥: {e}")
            return {
                'timestamp': '',
                'sender': '',
                'subject': '',
                'original_name': ''
            }

    def _calculate_filename_similarity(self, file1: str, file2: str) -> float:
        """è®¡ç®—ä¸¤ä¸ªæ–‡ä»¶åçš„ç›¸ä¼¼åº¦"""
        try:
            # ç®€å•çš„å­—ç¬¦ä¸²ç›¸ä¼¼åº¦è®¡ç®—
            name1 = os.path.splitext(file1)[0].lower()
            name2 = os.path.splitext(file2)[0].lower()

            # ç§»é™¤æ—¶é—´æˆ³å’Œå‘ä»¶äººä¿¡æ¯ï¼Œåªæ¯”è¾ƒä¸»é¢˜å’ŒåŸå§‹æ–‡ä»¶å
            parts1 = name1.split(' - ')
            parts2 = name2.split(' - ')

            # æå–ä¸»é¢˜å’ŒåŸå§‹æ–‡ä»¶å
            subject1 = parts1[2] if len(parts1) > 2 else ''
            subject2 = parts2[2] if len(parts2) > 2 else ''

            original1 = parts1[3] if len(parts1) > 3 else ''
            original2 = parts2[3] if len(parts2) > 3 else ''

            # è®¡ç®—ç›¸ä¼¼åº¦
            total_chars = max(len(subject1), len(subject2)) + \
                              max(len(original1), len(original2))
            if total_chars == 0:
                return 0.0

            # ä½¿ç”¨ç¼–è¾‘è·ç¦»è®¡ç®—ç›¸ä¼¼åº¦
            def levenshtein_distance(s1, s2):
                if len(s1) < len(s2):
                    return levenshtein_distance(s2, s1)

                if len(s2) == 0:
                    return len(s1)

                previous_row = list(range(len(s2) + 1))
                for i, c1 in enumerate(s1):
                    current_row = [i + 1]
                    for j, c2 in enumerate(s2):
                        insertions = previous_row[j + 1] + 1
                        deletions = current_row[j] + 1
                        substitutions = previous_row[j] + (c1 != c2)
                        current_row.append(
                            min(insertions, deletions, substitutions))
                    previous_row = current_row

                return previous_row[-1]

            # è®¡ç®—ä¸»é¢˜å’ŒåŸå§‹æ–‡ä»¶åçš„ç¼–è¾‘è·ç¦»
            subject_distance = levenshtein_distance(subject1, subject2)
            original_distance = levenshtein_distance(original1, original2)

            # è®¡ç®—ç›¸ä¼¼åº¦
            subject_similarity = 1 - (subject_distance / max(len(subject1), len(
                subject2))) if max(len(subject1), len(subject2)) > 0 else 1.0
            original_similarity = 1 - (original_distance / max(len(original1), len(
                original2))) if max(len(original1), len(original2)) > 0 else 1.0

            # åŠ æƒå¹³å‡
            total_similarity = (
    subject_similarity *
    0.6 +
    original_similarity *
     0.4)

            return total_similarity

        except Exception as e:
            print(f"è®¡ç®—æ–‡ä»¶åç›¸ä¼¼åº¦å¤±è´¥: {e}")
            return 0.0

    def _generate_merged_filename(self, file_group: List[str]) -> str:
        """ä¸ºåˆå¹¶åçš„æ–‡ä»¶ç”Ÿæˆåˆé€‚çš„æ–‡ä»¶å"""
        try:
            if not file_group:
                return "merged"

            # æå–ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ä¿¡æ¯ä½œä¸ºåŸºç¡€
            first_file = file_group[0]
            info = self._extract_file_info(first_file)

            # ç”Ÿæˆåˆå¹¶åçš„æ–‡ä»¶å
            if info['subject']:
                base_name = info['subject']
            elif info['original_name']:
                base_name = info['original_name']
            else:
                base_name = "merged_document"

            # æ¸…ç†æ–‡ä»¶å
            base_name = re.sub(r'[<>:"/\\|?*]', '_', base_name)
            base_name = base_name[:50]  # é™åˆ¶é•¿åº¦

            return base_name

        except Exception as e:
            print(f"ç”Ÿæˆåˆå¹¶æ–‡ä»¶åå¤±è´¥: {e}")
            return "merged_document"

    def _generate_download_log(self, save_dir: str, logger):
        """ç”Ÿæˆä¸‹è½½æ—¥å¿—æ–‡ä»¶ï¼Œè®°å½•æ‰€æœ‰ä¸‹è½½çš„PDFæ–‡ä»¶"""
        try:
            log_file_path = os.path.join(
    save_dir, f"download_log_{
        datetime.now().strftime('%Y%m%d_%H%M%S')}.txt")

            with open(log_file_path, 'w', encoding='utf-8') as f:
                f.write("=" * 80 + "\n")
                f.write("PDF ä¸‹è½½æ—¥å¿— / PDF Download Log\n")
                f.write("=" * 80 + "\n")
                f.write(
                    f"ä¸‹è½½æ—¶é—´ / Download Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"ä¸‹è½½ç›®å½• / Download Directory: {save_dir}\n")
                f.write("=" * 80 + "\n\n")

                # è®°å½•ä¸»æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
                f.write("ğŸ“ ä¸»æ–‡ä»¶å¤¹æ–‡ä»¶ / Main Folder Files:\n")
                f.write("-" * 50 + "\n")
                main_files = [f for f in os.listdir(
                    save_dir) if f.lower().endswith('.pdf')]
                if main_files:
                    for file in sorted(main_files):
                        file_path = os.path.join(save_dir, file)
                        file_size = os.path.getsize(file_path)
                        f.write(f"ğŸ“ {file} ({file_size:,} bytes)\n")
                else:
                    f.write("æ— PDFæ–‡ä»¶ / No PDF files\n")
                f.write("\n")

                # è®°å½•ä¾›åº”å•†å­æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶
                if self.merge_by_supplier:
                    for item in os.listdir(save_dir):
                        item_path = os.path.join(save_dir, item)
                        if os.path.isdir(item_path):
                            f.write(
    f"ğŸ“ ä¾›åº”å•†å­æ–‡ä»¶å¤¹ / Supplier Subfolder: {item}\n")
                            f.write("-" * 50 + "\n")
                            sub_files = [
    f for f in os.listdir(item_path) if f.lower().endswith('.pdf')]
                            if sub_files:
                                for file in sorted(sub_files):
                                    file_path = os.path.join(item_path, file)
                                    file_size = os.path.getsize(file_path)
                                    f.write(
                                        f"ğŸ“ {file} ({file_size:,} bytes)\n")
                            else:
                                f.write("æ— PDFæ–‡ä»¶ / No PDF files\n")
                            f.write("\n")

                # ç»Ÿè®¡ä¿¡æ¯
                total_files = len(main_files)
                if self.merge_by_supplier:
                    for item in os.listdir(save_dir):
                        item_path = os.path.join(save_dir, item)
                        if os.path.isdir(item_path):
                            sub_files = [
    f for f in os.listdir(item_path) if f.lower().endswith('.pdf')]
                            total_files += len(sub_files)

                f.write("=" * 80 + "\n")
                f.write(f"æ€»è®¡ / Total: {total_files} ä¸ªPDFæ–‡ä»¶ / PDF files\n")
                f.write("=" * 80 + "\n")

            logger(f"ğŸ“ ä¸‹è½½æ—¥å¿—å·²ç”Ÿæˆ: {log_file_path}")

        except Exception as e:
            logger(f"âš ï¸ ç”Ÿæˆä¸‹è½½æ—¥å¿—å¤±è´¥: {e}")

    def _extract_order_number(self, subject: str, filename: str) -> str:
        """ä»ä¸»é¢˜å’Œæ–‡ä»¶åä¸­æå–è®¢å•å·"""
        try:
            # ä¼˜å…ˆä»æ–‡ä»¶åä¸­æå–
            if filename:
                # æ”¯æŒå¤šç§è®¢å•å·æ ¼å¼
                order_patterns = [
                    r'[A-Z]{2,}-\d{6,}',  # INV-SH250603959
                    r'[A-Z]{2,}\d{6,}',   # SH250603959
                    r'\d{6,}',             # 250603959
                    r'[A-Z]{2,}\d{3,}',   # SH250603
                    r'\d{3,}[A-Z]{2,}'    # 250603SH
                ]

                for pattern in order_patterns:
                    match = re.search(pattern, filename.upper())
                    if match:
                        return match.group()

            # å¦‚æœæ–‡ä»¶åä¸­æ²¡æœ‰ï¼Œä»ä¸»é¢˜ä¸­æå–
            if subject:
                for pattern in order_patterns:
                    match = re.search(pattern, subject.upper())
                    if match:
                        return match.group()

            return ""

        except Exception as e:
            print(f"æå–è®¢å•å·å¤±è´¥: {e}")
            return ""

    # ---- Public ops ----
    def preview(self, params, logger) -> Tuple[int, int]:
        return self._scan(params, logger, save=False)

    def download(self, params, logger) -> Tuple[int, int]:
        return self._scan(params, logger, save=True)

    def _scan(self, params, logger, save: bool) -> Tuple[int, int]:
        """Scan Outlook and optionally save matching attachments.
        Returns: (matched_emails, saved_attachments)
        """
        # unpack
        start_date: datetime = params['start_date']
        end_date: datetime = params['end_date']
        save_dir: str = params['save_dir']
        email_filter_text: str = params['email_filters']
        content_filter_text: str = params['content_filters']
        content_scope_subj: bool = params['scope_subj']
        content_scope_body: bool = params['scope_body']
        attach_use_defaults: bool = params['attach_use_defaults']
        attach_extra_keywords: str = params['attach_extra_keywords']
        ext_whitelist_text: str = params['ext_whitelist']
        account_idx: Optional[int] = params.get('account_idx')

        email_filters = self._split_filter_tokens(email_filter_text)
        content_filters = [*self._split_filter_tokens(content_filter_text)]
        if attach_use_defaults:
            content_filters = list(
                {*content_filters, *self.DEFAULT_ATTACH_KEYWORDS})
        ext_whitelist = [e.strip().lower() for e in ext_whitelist_text.split(
            ',') if e.strip()] or self.DEFAULT_EXTS

        # é¡¯ç¤ºéæ¿¾æ¢ä»¶
        logger(f"ğŸ” éæ¿¾æ¢ä»¶ï¼š")
        if email_filters:
            logger(f"   ğŸ“§ éƒµä»¶éæ¿¾ï¼š{email_filters}")
        else:
            logger(f"   ğŸ“§ éƒµä»¶éæ¿¾ï¼šç„¡ï¼ˆä¸‹è¼‰æ‰€æœ‰éƒµä»¶ï¼‰")
        logger(f"   ğŸ“ æª”æ¡ˆé¡å‹ï¼š{ext_whitelist}")
        logger(
            f"   ğŸ“… æ—¥æœŸç¯„åœï¼š{start_date.strftime('%Y-%m-%d')} åˆ° {end_date.strftime('%Y-%m-%d')}")
        logger("")

        # Outlook connect
        try:
            import win32com.client
            import pythoncom

            # åˆå§‹åŒ– COM çµ„ä»¶
            pythoncom.CoInitialize()

            outlook = win32com.client.Dispatch("Outlook.Application")
            mapi = outlook.GetNamespace("MAPI")
        except Exception as e:
            messagebox.showerror("Outlook", f"Outlook åˆå§‹åŒ–å¤±æ•—ï¼š{e}")
            return (0, 0)

        if account_idx is None:
            account_idx = self._select_outlook_account()
            if account_idx is None:
                return (0, 0)

        # ç²å–æ‰€æœ‰è³‡æ–™å¤¾
        try:
            all_folders = self._get_all_folders(mapi, account_idx)
            logger(f"ğŸ“ æ‰¾åˆ° {len(all_folders)} å€‹è³‡æ–™å¤¾")
        except Exception as e:
            messagebox.showerror("Outlook", f"ç„¡æ³•ç²å–è³‡æ–™å¤¾åˆ—è¡¨ï¼š{e}")
            return (0, 0)

        # Restrict by ReceivedTime
        restr = self._build_restrict(start_date, end_date)

        all_messages = []
        for folder_path, folder in all_folders:
            try:
                # æª¢æŸ¥æ˜¯å¦ç‚ºéƒµä»¶è³‡æ–™å¤¾
                if hasattr(folder, 'DefaultItemType'):
                    default_item_type = folder.DefaultItemType
                    # 0 = olMailItem (éƒµä»¶), 1 = olAppointmentItem (ç´„æœƒ), 2 =
                    # olContactItem (è¯çµ¡äºº), 3 = olTaskItem (å·¥ä½œ)
                    if default_item_type != 0:  # ä¸æ˜¯éƒµä»¶è³‡æ–™å¤¾ï¼Œè·³é
                        continue

                items = folder.Items
                items.IncludeRecurrences = True
                items.Sort("[ReceivedTime]", True)
                restricted = items.Restrict(restr)

                # æ”¶é›†ç¬¦åˆæ¢ä»¶çš„éƒµä»¶
                for i in range(1, restricted.Count + 1):
                    try:
                        msg = restricted.Item(i)
                        all_messages.append((msg, folder_path))
                    except Exception:
                        continue

            except Exception as e:
                logger(f"âš ï¸ è™•ç†è³‡æ–™å¤¾ {folder_path} æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
                continue

        matched_mails = 0
        saved_atts = 0

        total = len(all_messages)
        logger(f"ğŸ“¥ ç¬¦åˆæ—¥æœŸçš„éƒµä»¶ï¼š{total} å°")
        logger(f"ğŸ” é–‹å§‹è™•ç†éƒµä»¶...\n")

        processed_count = 0
        for msg, folder_path in all_messages:
            processed_count += 1
            if processed_count % 100 == 0:  # æ¯è™•ç†100å°éƒµä»¶é¡¯ç¤ºä¸€æ¬¡é€²åº¦
                logger(f"ğŸ“Š å·²è™•ç† {processed_count}/{total} å°éƒµä»¶...")
            try:
                # Skip meeting items, etc.
                cls_name = getattr(msg, 'MessageClass', '')
                if not str(cls_name).startswith('IPM.Note'):
                    continue

                # æª¢æŸ¥éƒµä»¶éæ¿¾æ¢ä»¶
                sender_email = getattr(msg, 'SenderEmailAddress', '') or ''
                subject = msg.Subject or '(no subject)'

                if not self._match_email(msg, email_filters):
                    continue

                matched_mails += 1
                subj = msg.Subject or '(no subject)'
                sender = getattr(msg, 'SenderEmailAddress', '') or ''
                rcv_time = getattr(msg, 'ReceivedTime', None)

                # ç®€åŒ–æ—¥å¿—ï¼šåªæ˜¾ç¤ºé‚®ä»¶ä¸»é¢˜å’Œå‘ä»¶äºº
                logger(f"ğŸ“§ {subj} | {sender}")

                atts = getattr(msg, 'Attachments', None)
                if not atts:
                    continue

                if save:
                    os.makedirs(save_dir, exist_ok=True)

                # iterate attachments (1-based)
                try:
                    att_count = atts.Count
                except Exception:
                    att_count = 0

                for a in range(1, att_count + 1):
                    try:
                        att = atts.Item(a)
                        att_name = att.FileName or f"attachment_{a}"
                    except Exception as e:
                        continue

                    # ç°¡åŒ–é™„ä»¶éæ¿¾ï¼šåªæª¢æŸ¥å‰¯æª”åï¼Œæ¥å—æ‰€æœ‰é™„ä»¶
                    if not self._match_attachment_simple(att, ext_whitelist):
                        continue

                    if save:
                        fname = att.FileName or 'attachment'
                        # æå–è®¢å•å·æˆ–å‘ç¥¨å·
                        order_number = self._extract_order_number(subj, fname)

                        # ç”Ÿæˆæ›´ç®€æ´çš„æ–‡ä»¶åï¼šè®¢å•å·_åŸå§‹æ–‡ä»¶å
                        if order_number:
                            out_name = f"{order_number}_{fname}"
                        else:
                            # å¦‚æœæ²¡æœ‰è®¢å•å·ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶å
                            out_name = fname

                        # æŒ‰ä¾›åº”å•†åˆ›å»ºå­æ–‡ä»¶å¤¹
                        if self.merge_by_supplier and sender:
                            # æŸ¥æ‰¾ä¾›åº”å•†åç§°
                            supplier_name = self._find_supplier_name(sender)
                            if supplier_name:
                                supplier_dir = self._create_supplier_subfolder(
                                    save_dir, supplier_name)
                                out_path = _safe_save_path(
                                    supplier_dir, out_name)
                            else:
                                out_path = _safe_save_path(save_dir, out_name)

                        try:
                            att.SaveAsFile(out_path)
                            saved_atts += 1
                            # ç®€åŒ–æ—¥å¿—ï¼šåªæ˜¾ç¤ºæ–‡ä»¶åå’Œä¿å­˜è·¯å¾„
                            logger(f"ğŸ“ {fname} â†’ {os.path.basename(out_path)}")
                        except Exception as e:
                            logger(f"âŒ ä¿å­˜å¤±æ•—ï¼š{fname}")
                    else:
                        # preview mode
                        saved_atts += 1
                        logger(f"ğŸ“ {att.FileName}")

            except Exception as e:
                logger(f"âš ï¸ éƒµä»¶è™•ç†éŒ¯èª¤ï¼š{e}")

        # ä¸‹è½½å®Œæˆåï¼Œåˆå¹¶åŒåPDFæ–‡ä»¶
        if save and self.merge_pdfs and saved_atts > 0:
            logger(f"\nğŸ”„ å¼€å§‹åˆå¹¶åŒåPDFæ–‡ä»¶...")
            try:
                # å…ˆå°è¯•æ™ºèƒ½åˆå¹¶ï¼ˆåŸºäºç›¸ä¼¼åç§°ï¼‰
                logger(f"ğŸ” å°è¯•æ™ºèƒ½PDFåˆå¹¶...")
                merged_count = self._merge_pdfs_by_similar_names(
                    save_dir, logger)

                # å¦‚æœæ™ºèƒ½åˆå¹¶æ²¡æœ‰æ•ˆæœï¼Œå°è¯•ä¼ ç»Ÿåˆå¹¶
                if merged_count == 0:
                    logger(f"ğŸ” æ™ºèƒ½åˆå¹¶æ— æ•ˆæœï¼Œå°è¯•ä¼ ç»Ÿåˆå¹¶...")
                    merged_count = self._merge_pdfs_by_name(save_dir, logger)

                # å†åˆå¹¶æ‰€æœ‰ä¾›åº”å•†å­æ–‡ä»¶å¤¹ä¸­çš„PDF
                if self.merge_by_supplier:
                    for item in os.listdir(save_dir):
                        item_path = os.path.join(save_dir, item)
                        if os.path.isdir(item_path):
                            # å…ˆå°è¯•æ™ºèƒ½åˆå¹¶
                            subfolder_merged = self._merge_pdfs_by_similar_names(
                                item_path, logger)
                            if subfolder_merged == 0:
                                # å¦‚æœæ™ºèƒ½åˆå¹¶æ— æ•ˆæœï¼Œå°è¯•ä¼ ç»Ÿåˆå¹¶
                                subfolder_merged = self._merge_pdfs_by_name(
                                    item_path, logger)

                            merged_count += subfolder_merged
                            if subfolder_merged > 0:
                                logger(
    f"ğŸ“ ä¾›åº”å•†å­æ–‡ä»¶å¤¹ {item} ä¸­åˆå¹¶äº† {subfolder_merged} ç»„PDF")

                if merged_count > 0:
                    logger(f"âœ… æˆåŠŸåˆå¹¶ {merged_count} ç»„PDFæ–‡ä»¶")
                else:
                    logger(f"â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆå¹¶çš„PDFæ–‡ä»¶")
                
                # ğŸ”— æ–°å¢ï¼šæ‰§è¡Œæœ€ç»ˆåˆå¹¶ - å°†æ‰€æœ‰å·²åˆå¹¶çš„æ–‡ä»¶å†æ¬¡åˆå¹¶
                logger(f"\nğŸ”— å¼€å§‹æœ€ç»ˆåˆå¹¶æ‰€æœ‰æ–‡ä»¶...")
                try:
                    # 1. ä¸ºæ¯ä¸ªä¾›åº”å•†åˆ›å»ºæœ€ç»ˆåˆå¹¶æ–‡ä»¶
                    if self.merge_by_supplier:
                        supplier_finals_created = self._create_supplier_final_merges(save_dir, logger)
                        logger(f"âœ… ä¾›åº”å•†æœ€ç»ˆåˆå¹¶å®Œæˆï¼Œåˆ›å»ºäº† {supplier_finals_created} ä¸ªæ–‡ä»¶")
                    
                    # 2. åˆ›å»ºåŒ…å«æ‰€æœ‰ä¾›åº”å•†çš„æœ€ç»ˆåˆå¹¶æ–‡ä»¶
                    all_suppliers_final_created = self._create_all_suppliers_final_merge(save_dir, logger)
                    if all_suppliers_final_created:
                        logger(f"âœ… æ‰€æœ‰ä¾›åº”å•†æœ€ç»ˆåˆå¹¶å®Œæˆ")
                    else:
                        logger(f"â„¹ï¸ æ‰€æœ‰ä¾›åº”å•†æœ€ç»ˆåˆå¹¶è·³è¿‡ï¼ˆæ— æ–‡ä»¶éœ€è¦åˆå¹¶ï¼‰")
                        
                except Exception as e:
                    logger(f"âš ï¸ æœ€ç»ˆåˆå¹¶è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
                    
            except Exception as e:
                logger(f"âš ï¸ PDFåˆå¹¶è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")

            # ç”Ÿæˆä¸‹è½½æ—¥å¿—æ–‡ä»¶
            self._generate_download_log(save_dir, logger)

        logger(
    f"\nç¸½çµï¼šå‘½ä¸­éƒµä»¶ {matched_mails} å°ï¼Œå‘½ä¸­é™„ä»¶ {saved_atts} å€‹{
        'ï¼ˆå·²ä¿å­˜ï¼‰' if save else 'ï¼ˆé è¦½ï¼‰'}\n")
        return matched_mails, saved_atts

    def _create_supplier_final_merges(self, save_dir: str, logger) -> int:
        """ä¸ºæ¯ä¸ªä¾›åº”å•†åˆ›å»ºæœ€ç»ˆåˆå¹¶æ–‡ä»¶"""
        try:
            logger(f"   ğŸ”— å¼€å§‹ä¸ºæ¯ä¸ªä¾›åº”å•†åˆ›å»ºæœ€ç»ˆåˆå¹¶æ–‡ä»¶...")
            
            # æŸ¥æ‰¾æ‰€æœ‰ä¾›åº”å•†å­æ–‡ä»¶å¤¹
            supplier_folders = []
            for item in os.listdir(save_dir):
                item_path = os.path.join(save_dir, item)
                if os.path.isdir(item_path):
                    supplier_folders.append(item)
            
            if not supplier_folders:
                logger(f"      âš ï¸ æœªæ‰¾åˆ°ä¾›åº”å•†å­æ–‡ä»¶å¤¹ï¼Œè·³è¿‡ä¾›åº”å•†æœ€ç»ˆåˆå¹¶")
                return 0
            
            logger(f"      ğŸ“ æ‰¾åˆ° {len(supplier_folders)} ä¸ªä¾›åº”å•†æ–‡ä»¶å¤¹")
            
            total_created = 0
            
            # ä¸ºæ¯ä¸ªä¾›åº”å•†åˆ›å»ºæœ€ç»ˆåˆå¹¶æ–‡ä»¶
            for supplier in supplier_folders:
                supplier_path = os.path.join(save_dir, supplier)
                logger(f"      ğŸ¢ å¤„ç†ä¾›åº”å•†: {supplier}")
                
                # æŸ¥æ‰¾è¯¥ä¾›åº”å•†æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰å·²åˆå¹¶æ–‡ä»¶
                supplier_merged_files = []
                for filename in os.listdir(supplier_path):
                    if filename.lower().endswith('.pdf') and '_merged.pdf' in filename:
                        supplier_merged_files.append(filename)
                
                if not supplier_merged_files:
                    logger(f"         âš ï¸ ä¾›åº”å•† {supplier} æ²¡æœ‰å·²åˆå¹¶çš„æ–‡ä»¶")
                    continue
                
                logger(f"         ğŸ“‹ ä¾›åº”å•† {supplier} æœ‰ {len(supplier_merged_files)} ä¸ªå·²åˆå¹¶æ–‡ä»¶")
                
                # æŒ‰æ–‡ä»¶åæ’åº
                supplier_merged_files.sort()
                
                # ç”Ÿæˆè¯¥ä¾›åº”å•†çš„æœ€ç»ˆåˆå¹¶æ–‡ä»¶å
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                supplier_final_filename = f"{supplier}_FINAL_MERGED_{timestamp}.pdf"
                supplier_final_path = os.path.join(supplier_path, supplier_final_filename)
                
                # æ‰§è¡Œä¾›åº”å•†æœ€ç»ˆåˆå¹¶
                try:
                    self._merge_pdf_files(supplier_path, supplier_merged_files, supplier_final_path, logger)
                    logger(f"         âœ… ä¾›åº”å•† {supplier} æœ€ç»ˆåˆå¹¶å®Œæˆ: {supplier_final_filename}")
                    total_created += 1
                    
                except Exception as e:
                    logger(f"         âŒ ä¾›åº”å•† {supplier} æœ€ç»ˆåˆå¹¶å¤±è´¥: {e}")
            
            logger(f"      ğŸ“Š ä¾›åº”å•†æœ€ç»ˆåˆå¹¶ç»Ÿè®¡: å…±åˆ›å»º {total_created} ä¸ªæœ€ç»ˆåˆå¹¶æ–‡ä»¶")
            return total_created
            
        except Exception as e:
            logger(f"      âŒ ä¾›åº”å•†æœ€ç»ˆåˆå¹¶å¤„ç†å¤±è´¥: {e}")
            return 0

    def _create_all_suppliers_final_merge(self, save_dir: str, logger) -> bool:
        """åˆ›å»ºåŒ…å«æ‰€æœ‰ä¾›åº”å•†çš„æœ€ç»ˆåˆå¹¶æ–‡ä»¶"""
        try:
            logger(f"   ğŸ”— åˆ›å»ºåŒ…å«æ‰€æœ‰ä¾›åº”å•†çš„æœ€ç»ˆåˆå¹¶æ–‡ä»¶...")
            
            # æŸ¥æ‰¾æ‰€æœ‰ä¾›åº”å•†çš„æœ€ç»ˆåˆå¹¶æ–‡ä»¶
            all_supplier_finals = []
            
            for item in os.listdir(save_dir):
                item_path = os.path.join(save_dir, item)
                if os.path.isdir(item_path):
                    # æŸ¥æ‰¾è¯¥ä¾›åº”å•†çš„æœ€ç»ˆåˆå¹¶æ–‡ä»¶
                    for filename in os.listdir(item_path):
                        if filename.startswith(f"{item}_FINAL_MERGED_") and filename.endswith('.pdf'):
                            all_supplier_finals.append(os.path.join(item, filename))
                            logger(f"      ğŸ“ æ‰¾åˆ°ä¾›åº”å•†æœ€ç»ˆæ–‡ä»¶: {item}/{filename}")
                            break
            
            if not all_supplier_finals:
                logger(f"      âš ï¸ æœªæ‰¾åˆ°ä¾›åº”å•†æœ€ç»ˆåˆå¹¶æ–‡ä»¶ï¼Œè·³è¿‡æ‰€æœ‰ä¾›åº”å•†æœ€ç»ˆåˆå¹¶")
                return False
            
            logger(f"      ğŸ“‹ æ‰¾åˆ° {len(all_supplier_finals)} ä¸ªä¾›åº”å•†æœ€ç»ˆåˆå¹¶æ–‡ä»¶")
            
            # ç”Ÿæˆä¸»ç›®å½•çš„æœ€ç»ˆåˆå¹¶æ–‡ä»¶å
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            main_final_filename = f"ALL_SUPPLIERS_FINAL_MERGED_{timestamp}.pdf"
            main_final_path = os.path.join(save_dir, main_final_filename)
            
            try:
                # æ‰§è¡Œè·¨æ–‡ä»¶å¤¹çš„æœ€ç»ˆåˆå¹¶
                self._merge_cross_folder_pdfs(save_dir, all_supplier_finals, main_final_path, logger)
                logger(f"      âœ… æ‰€æœ‰ä¾›åº”å•†æœ€ç»ˆåˆå¹¶å®Œæˆ: {main_final_filename}")
                return True
                
            except Exception as e:
                logger(f"      âŒ æ‰€æœ‰ä¾›åº”å•†æœ€ç»ˆåˆå¹¶å¤±è´¥: {e}")
                return False
                
        except Exception as e:
            logger(f"      âŒ åˆ›å»ºæ‰€æœ‰ä¾›åº”å•†æœ€ç»ˆåˆå¹¶æ–‡ä»¶å¤±è´¥: {e}")
            return False

    def _merge_cross_folder_pdfs(self, base_dir: str, relative_paths: List[str], output_path: str, logger):
        """è·¨æ–‡ä»¶å¤¹åˆå¹¶PDFæ–‡ä»¶"""
        try:
            # å°è¯•ä½¿ç”¨PyPDF2
            try:
                from PyPDF2 import PdfMerger
                merger = PdfMerger()

                for relative_path in sorted(relative_paths):
                    full_path = os.path.join(base_dir, relative_path)
                    if os.path.exists(full_path):
                        merger.append(full_path)
                        logger(f"         ğŸ“ æ·»åŠ æ–‡ä»¶: {relative_path}")
                    else:
                        logger(f"         âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: {full_path}")

                merger.write(output_path)
                merger.close()
                logger(f"         ğŸ“ è·¨æ–‡ä»¶å¤¹PDFåˆå¹¶æˆåŠŸ")

            except ImportError:
                # å¦‚æœæ²¡æœ‰PyPDF2ï¼Œå°è¯•ä½¿ç”¨pdfrw
                try:
                    from pdfrw import PdfReader, PdfWriter
                    writer = PdfWriter()

                    for relative_path in sorted(relative_paths):
                        full_path = os.path.join(base_dir, relative_path)
                        if os.path.exists(full_path):
                            reader = PdfReader(full_path)
                            writer.addpages(reader.pages)
                            logger(f"         ğŸ“ æ·»åŠ æ–‡ä»¶: {relative_path}")

                    writer.write(output_path)
                    logger(f"         ğŸ“ ä½¿ç”¨pdfrwè·¨æ–‡ä»¶å¤¹PDFåˆå¹¶æˆåŠŸ")

                except ImportError:
                    # å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨æ–‡ä»¶å¤åˆ¶ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆ
                    logger(f"         âš ï¸ æœªæ‰¾åˆ°PDFåˆå¹¶åº“ï¼Œä½¿ç”¨æ–‡ä»¶å¤åˆ¶ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆ")
                    import shutil
                    if relative_paths:
                        first_file = os.path.join(base_dir, relative_paths[0])
                        if os.path.exists(first_file):
                            shutil.copy2(first_file, output_path)
                            logger(f"         ğŸ“ ä½¿ç”¨æ–‡ä»¶å¤åˆ¶ä½œä¸ºè·¨æ–‡ä»¶å¤¹PDFåˆå¹¶æ›¿ä»£æ–¹æ¡ˆ")

        except Exception as e:
            logger(f"         âŒ è·¨æ–‡ä»¶å¤¹PDFåˆå¹¶å¤±è´¥: {e}")
            raise

    def _detect_base_date_from_worksheet(self):
        """ä»å·¥ä½œè¡¨ä¸­æ£€æµ‹åŸºå‡†æ—¥æœŸ"""
        try:
            # è¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨æœ‰å·¥ä½œè¡¨å¯¹è±¡æ—¶è°ƒç”¨
            # ç”±äºMonthEndDownloaderç±»æ²¡æœ‰ç›´æ¥è®¿é—®å·¥ä½œè¡¨ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼è·å–
            # è¿™é‡Œè¿”å›Noneï¼Œè®©è°ƒç”¨è€…ä½¿ç”¨é»˜è®¤é€»è¾‘
            return None
        except Exception as e:
            return None

    def _detect_base_date_from_worksheet(self):
        """ä»å·¥ä½œè¡¨ä¸­æ£€æµ‹åŸºå‡†æ—¥æœŸ"""
        try:
            # è¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨æœ‰å·¥ä½œè¡¨å¯¹è±¡æ—¶è°ƒç”¨
            # ç”±äºOperationSuppliesOrderç±»æ²¡æœ‰ç›´æ¥è®¿é—®å·¥ä½œè¡¨ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼è·å–
            # è¿™é‡Œè¿”å›Noneï¼Œè®©è°ƒç”¨è€…ä½¿ç”¨é»˜è®¤é€»è¾‘
            return None
        except Exception as e:
            return None


class MonthEndDownloadUI(ctk.CTkFrame):
    """UI wrapper for Month End SOA/Invoice downloader."""

    def __init__(self, master):
        super().__init__(master, fg_color='transparent')
        self.downloader = MonthEndDownloader(self)
        self.config_path = None
        self.suppliers = []
        self.selected_suppliers = []  # æ–°å¢ï¼šé€‰ä¸­çš„ä¾›åº”å•†åˆ—è¡¨
        self._build()

    # --- UI ---
    def _build(self):
        # date range row - å·¦å³æ’åˆ—
        row1 = ctk.CTkFrame(self, fg_color=DARK_PANEL)
        row1.pack(fill='x', padx=10, pady=10)

        # æ—¥æœŸé¸æ“‡å€åŸŸ
        date_frame = ctk.CTkFrame(row1, fg_color='transparent')
        date_frame.pack(fill='x', padx=10, pady=(10, 0))

        # å·¦å´ï¼šé–‹å§‹æ—¥æœŸ
        left_date_frame = ctk.CTkFrame(date_frame, fg_color='transparent')
        left_date_frame.pack(side='left', fill='x', expand=True, padx=(0, 5))
        ctk.CTkLabel(
    left_date_frame,
    text='æ—¥æœŸèµ· / From',
    font=FONT_MID,
    text_color=TEXT_COLOR).pack(
        anchor='w',
        pady=(
            0,
             5))

        start_date_frame = ctk.CTkFrame(
    left_date_frame, fg_color='transparent')
        start_date_frame.pack(fill='x')
        # è®¾ç½®å¼€å§‹æ—¥æœŸä¸ºå½“å‰æœˆä»½çš„ç¬¬ä¸€å¤©
        current_date = datetime.now()
        start_date = current_date.replace(day=1)
        self.var_start = ctk.StringVar(value=start_date.strftime('%Y-%m-%d'))

        # ä½¿ç”¨ tkcalendar.DateEntry æ›¿ä»£ CTkEntry
        import tkinter as tk
        start_cal_frame = tk.Frame(start_date_frame)
        start_cal_frame.pack(fill='x', expand=True)

        if DateEntry is not None:
            self.start_date_entry = DateEntry(start_cal_frame,
                                             selectmode='day',
                                             date_pattern='yyyy-mm-dd',
                                             font=('Arial', 12),
                                             background='#2b2b2b',
                                             foreground='white',
                                             bordercolor='#3b8ed0',
                                             headersbackground='#3b8ed0',
                                             headersforeground='white',
                                             normalbackground='#2b2b2b',
                                             normalforeground='white',
                                             weekendbackground='#343638',
                                             weekendforeground='white',
                                             othermonthbackground='#242424',
                                             othermonthforeground='gray50',
                                             selectbackground='#3b8ed0',
                                             selectforeground='white',
                                             year=datetime.now().replace(day=1).year,
                                             month=datetime.now().replace(day=1).month,
                                             day=datetime.now().replace(day=1).day,
                                             locale='en_US',
                                             state='readonly')  # å›åˆ°æœ€åŸºæœ¬çš„é…ç½®
            self.start_date_entry.pack(fill='x', expand=True)
            self.start_date_entry.bind(
    "<<DateSelected>>", self._on_start_date_selected)
            # åªä¿ç•™åŸºæœ¬çš„æœˆä»½å˜åŒ–äº‹ä»¶ç»‘å®š
            self.start_date_entry.bind(
    "<<CalendarMonthChanged>>",
     self._on_start_month_changed)
            print(f"ğŸ” å·²ç»‘å®šå¼€å§‹æ—¥æœŸåŸºæœ¬äº‹ä»¶")
        else:
            # Fallback to CTkEntry if DateEntry is not available
            self.start_date_entry = ctk.CTkEntry(
    start_cal_frame, textvariable=self.var_start)
            self.start_date_entry.pack(fill='x', expand=True)
            ctk.CTkButton(start_cal_frame, text='ğŸ“…', command=lambda: self._show_date_picker('start'),
                          width=40, fg_color=ACCENT_BLUE).pack(side='right', padx=(5, 0))

        # å³å´ï¼šçµæŸæ—¥æœŸ
        right_date_frame = ctk.CTkFrame(date_frame, fg_color='transparent')
        right_date_frame.pack(side='right', fill='x', expand=True, padx=(5, 0))
        ctk.CTkLabel(
    right_date_frame,
    text='æˆªè‡³æ—¥æœŸ / To',
    font=FONT_MID,
    text_color=TEXT_COLOR).pack(
        anchor='w',
        pady=(
            0,
             5))

        end_date_frame = ctk.CTkFrame(right_date_frame, fg_color='transparent')
        end_date_frame.pack(fill='x')
        # è®¾ç½®ç»“æŸæ—¥æœŸä¸ºå½“å‰æ—¥æœŸ
        self.var_end = ctk.StringVar(value=current_date.strftime('%Y-%m-%d'))

        # ç§»å‹•å¼·åˆ¶æ›´æ–°æŒ‰éˆ•åˆ°å¿«é€Ÿæ—¥æœŸæŒ‰éˆ•å€

        # ä½¿ç”¨ tkcalendar.DateEntry æ›¿ä»£ CTkEntry
        end_cal_frame = tk.Frame(end_date_frame)
        end_cal_frame.pack(fill='x', expand=True)

        if DateEntry is not None:
            self.end_date_entry = DateEntry(end_cal_frame,
                                           selectmode='day',
                                           date_pattern='yyyy-mm-dd',
                                           font=('Arial', 12),
                                           background='#2b2b2b',
                                           foreground='white',
                                           bordercolor='#3b8ed0',
                                           headersbackground='#3b8ed0',
                                           headersforeground='white',
                                           normalbackground='#2b2b2b',
                                           normalforeground='white',
                                           weekendbackground='#343638',
                                           weekendforeground='white',
                                           othermonthbackground='#242424',
                                           othermonthforeground='gray50',
                                           selectbackground='#3b8ed0',
                                           selectforeground='white',
                                           year=datetime.now().year,
                                           month=datetime.now().month,
                                           day=datetime.now().day,
                                           locale='en_US',
                                           state='readonly')  # å›åˆ°æœ€åŸºæœ¬çš„é…ç½®
            self.end_date_entry.pack(fill='x', expand=True)
            self.end_date_entry.bind(
    "<<DateSelected>>",
     self._on_end_date_selected)
            # åªä¿ç•™åŸºæœ¬çš„æœˆä»½å˜åŒ–äº‹ä»¶ç»‘å®š
            self.end_date_entry.bind(
    "<<CalendarMonthChanged>>",
     self._on_end_month_changed)
            print(f"ğŸ” å·²ç»‘å®šç»“æŸæ—¥æœŸåŸºæœ¬äº‹ä»¶")
        else:
            # Fallback to CTkEntry if DateEntry is not available
            self.end_date_entry = ctk.CTkEntry(
    end_cal_frame, textvariable=self.var_end)
            self.end_date_entry.pack(fill='x', expand=True)
            ctk.CTkButton(end_cal_frame, text='ğŸ“…', command=lambda: self._show_date_picker('end'),
                          width=40, fg_color=ACCENT_BLUE).pack(side='right', padx=(5, 0))

        # å¿«é€Ÿæ—¥æœŸæŒ‰éˆ•
        btns = ctk.CTkFrame(row1, fg_color='transparent')
        btns.pack(fill='x', padx=10, pady=(10, 10))
        ctk.CTkButton(
    btns,
    text='æœ¬æœˆ\nThis Month',
    command=self._quick_this_month,
    fg_color=ACCENT_BLUE,
    corner_radius=8).pack(
        side='left',
         padx=4)
        # æ–°å¢ï¼šå¼·åˆ¶æ›´æ–°æ”¾åœ¨ä¸Šæœˆå·¦é‚Š
        ctk.CTkButton(
    btns,
    text='ğŸ”„ å¼·åˆ¶æ›´æ–°\nForce Update',
    command=self._force_update_dates,
    fg_color=ACCENT_BLUE,
    corner_radius=8).pack(
        side='left',
         padx=4)
        ctk.CTkButton(
    btns,
    text='ä¸Šæœˆ\nLast Month',
    command=self._quick_last_month,
    corner_radius=8).pack(
        side='left',
         padx=4)

        # save folder row
        row2 = ctk.CTkFrame(self, fg_color=DARK_PANEL)
        row2.pack(fill='x', padx=10, pady=10)
        ctk.CTkLabel(
    row2,
    text='å¦å­˜åˆ° / Save to folder',
    font=FONT_MID,
    text_color=TEXT_COLOR).pack(
        anchor='w',
        padx=10,
        pady=(
            10,
             0))
        row2b = ctk.CTkFrame(row2, fg_color='transparent')
        row2b.pack(fill='x', padx=10, pady=(0, 10))
        self.var_save = ctk.StringVar(
    value=os.path.join(
        os.path.expanduser('~'),
        'Downloads',
         'MonthEnd'))
        ctk.CTkEntry(
    row2b,
    textvariable=self.var_save).pack(
        side='left',
        fill='x',
         expand=True)
        ctk.CTkButton(
    row2b,
    text='é¸æ“‡...',
    command=self._pick_save_dir).pack(
        side='left',
         padx=6)

        # config file selection row
        row_config = ctk.CTkFrame(self, fg_color=DARK_PANEL)
        row_config.pack(fill='x', padx=10, pady=10)
        ctk.CTkLabel(
    row_config,
    text='é…ç½®æ–‡ä»¶ / Config File',
    font=FONT_MID,
    text_color=TEXT_COLOR).pack(
        anchor='w',
        padx=10,
        pady=(
            10,
             0))
        row_configb = ctk.CTkFrame(row_config, fg_color='transparent')
        row_configb.pack(fill='x', padx=10, pady=(0, 10))
        self.var_config = ctk.StringVar(value='')
        ctk.CTkEntry(
    row_configb,
    textvariable=self.var_config,
    placeholder_text='é¸æ“‡é…ç½®æ–‡ä»¶...').pack(
        side='left',
        fill='x',
         expand=True)
        ctk.CTkButton(
    row_configb,
    text='é¸æ“‡...',
    command=self._pick_config_file).pack(
        side='left',
         padx=6)
        ctk.CTkButton(
    row_configb,
    text='è¼‰å…¥ä¾›æ‡‰å•†',
    command=self._load_suppliers,
    fg_color=ACCENT_BLUE).pack(
        side='left',
         padx=6)

        # supplier selection row - ç®€åŒ–ï¼Œåªæ˜¾ç¤ºæŒ‰é’®
        row_supplier = ctk.CTkFrame(self, fg_color=DARK_PANEL)
        row_supplier.pack(fill='x', padx=10, pady=10)
        ctk.CTkLabel(
    row_supplier,
    text='é¸æ“‡ä¾›æ‡‰å•† / Select Suppliers',
    font=FONT_MID,
    text_color=TEXT_COLOR).pack(
        anchor='w',
        padx=10,
        pady=(
            10,
             0))

        # ç®€åŒ–çš„ä¾›åº”å•†é€‰æ‹©æŒ‰é’®
        supplier_btn_frame = ctk.CTkFrame(row_supplier, fg_color='transparent')
        supplier_btn_frame.pack(fill='x', padx=10, pady=(0, 10))

        # æ‰“å¼€ä¾›åº”å•†é€‰æ‹©çª—å£çš„æŒ‰é’®
        ctk.CTkButton(supplier_btn_frame, text='ğŸ“‹ é¸æ“‡ä¾›æ‡‰å•† / Select Suppliers',
                      command=self._open_supplier_selection,
                      fg_color=ACCENT_BLUE, width=200, height=35).pack(side='left', padx=5)

        # æ˜¾ç¤ºå·²é€‰æ‹©çš„ä¾›åº”å•†æ•°é‡
        self.supplier_count_label = ctk.CTkLabel(supplier_btn_frame, text="æœªé¸æ“‡ä¾›æ‡‰å•†",
                                                font=FONT_MID, text_color=TEXT_COLOR)
        self.supplier_count_label.pack(side='left', padx=10)

        # filters row (simplified - only email filter)
        row3 = ctk.CTkFrame(self, fg_color=DARK_PANEL)
        row3.pack(fill='x', padx=10, pady=10)
        ctk.CTkLabel(
    row3,
    text='å¯„ä»¶è€…ç¯©é¸ï¼ˆä»¥ ; , ç©ºç™½ åˆ†éš”ï¼‰\nEmail Filter (Sender; , space separated)',
    font=FONT_MID,
    text_color=TEXT_COLOR).pack(
        anchor='w',
        padx=10,
        pady=(
            10,
             0))
        self.var_email = ctk.StringVar(value='')
        ctk.CTkEntry(
    row3, textvariable=self.var_email).pack(
        fill='x', padx=10, pady=4)

        # ç§»é™¤ content filter ç›¸é—œçš„ UI å…ƒç´ 

        # actions row - ä¼˜åŒ–æŒ‰é’®å¸ƒå±€
        row4 = ctk.CTkFrame(self, fg_color='transparent')
        row4.pack(fill='x', padx=10, pady=(20, 20))

        # æŒ‰é’®å®¹å™¨ - å±…ä¸­å¯¹é½ï¼Œä¼˜åŒ–é—´è·
        button_container = ctk.CTkFrame(row4, fg_color='transparent')
        button_container.pack(fill='x', expand=True)

        # åˆ›å»ºå†…éƒ¨å®¹å™¨æ¥å±…ä¸­æŒ‰é’®
        center_container = ctk.CTkFrame(
    button_container, fg_color='transparent')
        center_container.pack(expand=True)

        # é¢„è§ˆæŒ‰é’® - æ›´å¤§å°ºå¯¸
        preview_btn = ctk.CTkButton(center_container, text='é è¦½\nPreview', command=self._on_preview,
                                   fg_color=ACCENT_BLUE, width=180, height=50, corner_radius=10,
                                   font=("Microsoft YaHei", 14, "bold"))
        preview_btn.pack(side='left', padx=(0, 20), pady=15)

        # ä¸‹è½½æŒ‰é’® - æ›´å¤§å°ºå¯¸
        download_btn = ctk.CTkButton(center_container, text='ä¸‹è¼‰\nDownload', command=self._on_download,
                                    fg_color=ACCENT_GREEN, width=180, height=50, corner_radius=10,
                                    font=("Microsoft YaHei", 14, "bold"))
        download_btn.pack(side='left', padx=(0, 20), pady=15)
        
        # Siahuat è¨‚å–®ä¸‹è¼‰æŒ‰éˆ•
        siahuat_btn = ctk.CTkButton(center_container, text='ğŸ¢ Siahuat è¨‚å–®\nSiahuat Orders', command=self._on_download_siahuat,
                                   fg_color="#FF6B35", width=180, height=50, corner_radius=10,
                                   font=("Microsoft YaHei", 14, "bold"))
        siahuat_btn.pack(side='left', padx=(0, 0), pady=15)

        # æ·»åŠ çŠ¶æ€æ ‡ç­¾
        self.status_label = ctk.CTkLabel(
    self, text="", font=FONT_MID, text_color=TEXT_COLOR)
        self.status_label.pack(pady=(0, 10))

        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        print("ğŸ” è°ƒè¯•ï¼šæŒ‰é’®å·²åˆ›å»º")
        print(f"   é¢„è§ˆæŒ‰é’®: {preview_btn}")
        print(f"   ä¸‹è½½æŒ‰é’®: {download_btn}")
        print(f"   çŠ¶æ€æ ‡ç­¾: {self.status_label}")

    def _open_supplier_selection(self):
        """æ‰“å¼€ä¾›åº”å•†é€‰æ‹©çª—å£"""
        if not self.suppliers:
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆè¼‰å…¥ä¾›æ‡‰å•†é…ç½®æ–‡ä»¶")
            return

        # åˆ›å»ºä¾›åº”å•†é€‰æ‹©çª—å£
        supplier_window = ctk.CTkToplevel(self)
        supplier_window.title("é¸æ“‡ä¾›æ‡‰å•† / Select Suppliers")
        supplier_window.geometry("700x800")  # è¿›ä¸€æ­¥å¢åŠ å®½åº¦å’Œé«˜åº¦
        supplier_window.resizable(False, False)

        # å±…ä¸­æ˜¾ç¤º
        supplier_window.update_idletasks()
        x = (supplier_window.winfo_screenwidth() // 2) - (700 // 2)
        y = (supplier_window.winfo_screenheight() // 2) - (800 // 2)
        supplier_window.geometry(f"700x800+{x}+{y}")

        # è®¾ç½®ä¸ºæœ€é¡¶å±‚
        supplier_window.attributes('-topmost', True)

        # æ ‡é¢˜
        title_label = ctk.CTkLabel(supplier_window, text="é¸æ“‡ä¾›æ‡‰å•† / Select Suppliers",
                                  font=FONT_TITLE, text_color=TEXT_COLOR)
        title_label.pack(pady=20)

        # ä¾›åº”å•†æ»šåŠ¨æ¡†æ¶
        supplier_scroll = ctk.CTkScrollableFrame(
            supplier_window, height=500)  # è¿›ä¸€æ­¥å¢åŠ é«˜åº¦
        supplier_scroll.pack(fill="both", expand=True, padx=20, pady=10)

        # åˆ›å»ºä¾›åº”å•†å¤é€‰æ¡†
        supplier_vars = []
        for supplier in self.suppliers:
            var = ctk.BooleanVar()
            supplier_vars.append((supplier, var))

            # ä¾›åº”å•†å¤é€‰æ¡†
            supplier_frame = ctk.CTkFrame(
    supplier_scroll, fg_color='transparent')
            supplier_frame.pack(fill='x', pady=2)

            ctk.CTkCheckBox(supplier_frame, text=f"{supplier['name']} ({supplier['email']})",
                           variable=var, font=FONT_MID, text_color=TEXT_COLOR).pack(side='left', padx=10)

        # å…¨é€‰/å–æ¶ˆå…¨é€‰æŒ‰é’®
        select_btns_frame = ctk.CTkFrame(
    supplier_window, fg_color='transparent')
        select_btns_frame.pack(fill='x', padx=20, pady=15)

        ctk.CTkButton(select_btns_frame, text='å…¨é¸ / Select All',
                      command=lambda: [var.set(True)
                                               for _, var in supplier_vars],
                      fg_color=ACCENT_BLUE, width=120, height=30).pack(side='left', padx=5)

        ctk.CTkButton(select_btns_frame, text='å–æ¶ˆå…¨é¸ / Deselect All',
                      command=lambda: [var.set(False)
                                               for _, var in supplier_vars],
                      fg_color="#666666", width=120, height=30).pack(side='left', padx=5)

        # ç¡®è®¤æŒ‰é’® - å¢åŠ æ›´å¤šç©ºé—´ç¡®ä¿å®Œå…¨å¯è§
        def confirm_selection():
            selected_suppliers = [
    supplier for supplier,
     var in supplier_vars if var.get()]
            self.selected_suppliers = selected_suppliers

            # æ›´æ–°æ˜¾ç¤º
            if selected_suppliers:
                count = len(selected_suppliers)
                names = ", ".join([s['name'] for s in selected_suppliers[:3]])
                if count > 3:
                    names += f" ç­‰ {count} å€‹ä¾›æ‡‰å•†"
                self.supplier_count_label.configure(text=f"å·²é¸æ“‡: {names}")
            else:
                self.supplier_count_label.configure(text="æœªé¸æ“‡ä¾›æ‡‰å•†")

            supplier_window.destroy()
            messagebox.showinfo("å®Œæˆ", f"å·²é¸æ“‡ {len(selected_suppliers)} å€‹ä¾›æ‡‰å•†")

        # ä¸ºç¡®è®¤æŒ‰é’®åˆ›å»ºä¸“é—¨çš„å®¹å™¨ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´
        confirm_frame = ctk.CTkFrame(
    supplier_window, fg_color='transparent', height=80)
        confirm_frame.pack(fill='x', padx=20, pady=20)
        confirm_frame.pack_propagate(False)  # é˜²æ­¢å®¹å™¨è¢«å‹ç¼©

        confirm_btn = ctk.CTkButton(confirm_frame, text='ç¢ºèªé¸æ“‡ / Confirm Selection',
                                   command=confirm_selection, fg_color=ACCENT_GREEN, height=50, width=200)
        confirm_btn.pack(expand=True)

    def _show_date_picker(self, date_type):
        """é¡¯ç¤ºæ—¥æœŸé¸æ“‡å™¨ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰"""
        try:
            import tkcalendar
            from tkcalendar import DateEntry
        except ImportError:
            messagebox.showwarning(
    "ç¼ºå°‘æ¨¡çµ„", "è«‹å®‰è£ tkcalendar: pip install tkcalendar")
            return

        # å‰µå»ºæ—¥æœŸé¸æ“‡å™¨çª—å£
        picker_window = ctk.CTkToplevel(self)
        picker_window.title("é¸æ“‡æ—¥æœŸ / Select Date")
        picker_window.geometry("300x250")
        picker_window.resizable(False, False)

        # å±…ä¸­é¡¯ç¤º
        picker_window.update_idletasks()
        x = (picker_window.winfo_screenwidth() // 2) - (300 // 2)
        y = (picker_window.winfo_screenheight() // 2) - (250 // 2)
        picker_window.geometry(f"300x250+{x}+{y}")

        # è¨­ç½®ç‚ºæœ€é ‚å±¤
        picker_window.attributes('-topmost', True)

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(picker_window, text=f"é¸æ“‡{'é–‹å§‹' if date_type == 'start' else 'çµæŸ'}æ—¥æœŸ",
                                  font=FONT_TITLE, text_color=TEXT_COLOR)
        title_label.pack(pady=20)

        # å‰µå»ºæ—¥æœŸé¸æ“‡å™¨
        def on_date_select():
            selected_date = cal.get_date()
            if date_type == 'start':
                self.var_start.set(selected_date.strftime('%Y-%m-%d'))
            else:
                self.var_end.set(selected_date.strftime('%Y-%m-%d'))
            picker_window.destroy()

        # ä½¿ç”¨ tkinter çš„ Frame ä¾†å®¹ç´ tkcalendar
        import tkinter as tk
        cal_frame = tk.Frame(picker_window)
        cal_frame.pack(pady=10)

        # å‰µå»ºæ—¥æœŸé¸æ“‡å™¨
        cal = DateEntry(cal_frame, width=20, background='darkblue',
                       foreground='white', borderwidth=2, date_pattern='yyyy-mm-dd')
        cal.pack(pady=10)

        # ç¢ºèªæŒ‰éˆ•
        confirm_btn = ctk.CTkButton(picker_window, text="ç¢ºèª / Confirm",
                                   command=on_date_select, fg_color=ACCENT_BLUE)
        confirm_btn.pack(pady=10)

        # å–æ¶ˆæŒ‰éˆ•
        cancel_btn = ctk.CTkButton(picker_window, text="å–æ¶ˆ / Cancel",
                                  command=picker_window.destroy, fg_color="#666666")
        cancel_btn.pack(pady=5)

    # --- quick range helpers ---

    def _quick_this_month(self):
        now = datetime.now()
        start = now.replace(day=1)
        end = now
        if hasattr(self.start_date_entry, 'set_date'):
            self.start_date_entry.set_date(start.date())
            self.end_date_entry.set_date(end.date())
        self.var_start.set(start.strftime('%Y-%m-%d'))
        self.var_end.set(end.strftime('%Y-%m-%d'))
        # æ›´æ–°çŠ¶æ€æ ‡ç­¾
        self.status_label.configure(
            text=f"å·²è®¾ç½®ä¸ºæœ¬æœˆï¼š{start.strftime('%Y-%m-%d')} åˆ° {end.strftime('%Y-%m-%d')}")

    def _on_start_date_selected(self, event=None):
        """ç•¶é–‹å§‹æ—¥æœŸè¢«é¸æ“‡æ™‚è§¸ç™¼"""
        try:
            selected_date = self.start_date_entry.get_date()
            date_str = selected_date.strftime('%Y-%m-%d')
            self.var_start.set(date_str)
            print(f"é–‹å§‹æ—¥æœŸå·²æ›´æ–°: {date_str}")
        except Exception as e:
            print(f"æ›´æ–°é–‹å§‹æ—¥æœŸæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_end_date_selected(self, event=None):
        """ç•¶çµæŸæ—¥æœŸè¢«é¸æ“‡æ™‚è§¸ç™¼"""
        try:
            selected_date = self.end_date_entry.get_date()
            date_str = selected_date.strftime('%Y-%m-%d')
            self.var_end.set(date_str)
            print(f"çµæŸæ—¥æœŸå·²æ›´æ–°: {date_str}")
        except Exception as e:
            print(f"æ›´æ–°çµæŸæ—¥æœŸæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_start_month_changed(self, event=None):
        """ç•¶é–‹å§‹æ—¥æœŸçš„æœˆä»½è¢«æ”¹è®Šæ™‚è§¸ç™¼"""
        try:
            # æœˆä»½æ”¹è®Šæ™‚ï¼Œä¿æŒç•¶æœˆçš„ç¬¬ä¸€å¤©
            current_date = self.start_date_entry.get_date()
            new_date = current_date.replace(day=1)
            self.start_date_entry.set_date(new_date)
            date_str = new_date.strftime('%Y-%m-%d')
            self.var_start.set(date_str)
            print(f"é–‹å§‹æœˆä»½å·²æ”¹è®Šï¼Œæ—¥æœŸæ›´æ–°ç‚º: {date_str}")
        except Exception as e:
            print(f"è™•ç†é–‹å§‹æœˆä»½è®ŠåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_end_month_changed(self, event=None):
        """ç•¶çµæŸæ—¥æœŸçš„æœˆä»½è¢«æ”¹è®Šæ™‚è§¸ç™¼"""
        try:
            # æœˆä»½æ”¹è®Šæ™‚ï¼Œä¿æŒç•¶æœˆçš„æœ€å¾Œä¸€å¤©
            current_date = self.end_date_entry.get_date()
            # è¨ˆç®—ç•¶æœˆæœ€å¾Œä¸€å¤©
            if current_date.month == 12:
                next_month = current_date.replace(
    year=current_date.year + 1, month=1, day=1)
            else:
                next_month = current_date.replace(
                    month=current_date.month + 1, day=1)
            last_day = next_month - timedelta(days=1)

            self.end_date_entry.set_date(last_day)
            date_str = last_day.strftime('%Y-%m-%d')
            self.var_end.set(date_str)
            print(f"çµæŸæœˆä»½å·²æ”¹è®Šï¼Œæ—¥æœŸæ›´æ–°ç‚º: {date_str}")
        except Exception as e:
            print(f"è™•ç†çµæŸæœˆä»½è®ŠåŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_start_date_click(self, event=None):
        """ç•¶é–‹å§‹æ—¥æœŸè¢«é»æ“Šæ™‚è§¸ç™¼"""
        try:
            print(f"ğŸ” é–‹å§‹æ—¥æœŸè¢«é»æ“Šï¼Œäº‹ä»¶: {event}")
            # å¼·åˆ¶æ›´æ–°æ—¥æœŸè®Šæ•¸
            current_date = self.start_date_entry.get_date()
            date_str = current_date.strftime('%Y-%m-%d')
            self.var_start.set(date_str)
            print(f"é–‹å§‹æ—¥æœŸé»æ“Šå¾Œæ›´æ–°ç‚º: {date_str}")
        except Exception as e:
            print(f"è™•ç†é–‹å§‹æ—¥æœŸé»æ“Šæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_start_date_key(self, event=None):
        """ç•¶é–‹å§‹æ—¥æœŸæœ‰éµç›¤è¼¸å…¥æ™‚è§¸ç™¼"""
        try:
            print(f"ğŸ” é–‹å§‹æ—¥æœŸéµç›¤è¼¸å…¥ï¼Œäº‹ä»¶: {event}")
            # å¼·åˆ¶æ›´æ–°æ—¥æœŸè®Šæ•¸
            current_date = self.start_date_entry.get_date()
            date_str = current_date.strftime('%Y-%m-%d')
            self.var_start.set(date_str)
            print(f"é–‹å§‹æ—¥æœŸéµç›¤è¼¸å…¥å¾Œæ›´æ–°ç‚º: {date_str}")
        except Exception as e:
            print(f"è™•ç†é–‹å§‹æ—¥æœŸéµç›¤è¼¸å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_end_date_click(self, event=None):
        """ç•¶çµæŸæ—¥æœŸè¢«é»æ“Šæ™‚è§¸ç™¼"""
        try:
            print(f"ğŸ” çµæŸæ—¥æœŸè¢«é»æ“Šï¼Œäº‹ä»¶: {event}")
            # å¼·åˆ¶æ›´æ–°æ—¥æœŸè®Šæ•¸
            current_date = self.end_date_entry.get_date()
            date_str = current_date.strftime('%Y-%m-%d')
            self.var_end.set(date_str)
            print(f"çµæŸæ—¥æœŸé»æ“Šå¾Œæ›´æ–°ç‚º: {date_str}")
        except Exception as e:
            print(f"è™•ç†çµæŸæ—¥æœŸé»æ“Šæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_end_date_key(self, event=None):
        """ç•¶çµæŸæ—¥æœŸæœ‰éµç›¤è¼¸å…¥æ™‚è§¸ç™¼"""
        try:
            print(f"ğŸ” çµæŸæ—¥æœŸéµç›¤è¼¸å…¥ï¼Œäº‹ä»¶: {event}")
            # å¼·åˆ¶æ›´æ–°æ—¥æœŸè®Šæ•¸
            current_date = self.end_date_entry.get_date()
            date_str = current_date.strftime('%Y-%m-%d')
            self.var_end.set(date_str)
            print(f"çµæŸæ—¥æœŸéµç›¤è¼¸å…¥å¾Œæ›´æ–°ç‚º: {date_str}")
        except Exception as e:
            print(f"è™•ç†çµæŸæ—¥æœŸéµç›¤è¼¸å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_start_date_focus(self, event=None):
        """ç•¶é–‹å§‹æ—¥æœŸç²å¾—ç„¦é»æ™‚è§¸ç™¼"""
        try:
            print(f"ğŸ” é–‹å§‹æ—¥æœŸç²å¾—ç„¦é»ï¼Œäº‹ä»¶: {event}")
            # å¼ºåˆ¶æ˜¾ç¤ºä¸‹æ‹‰æ—¥å†å¹¶ç«‹å³è°ƒæ•´ä½ç½®
            self.after(50, self._force_show_and_position_start_calendar)
        except Exception as e:
            print(f"è™•ç†é–‹å§‹æ—¥æœŸç„¦é»æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_end_date_focus(self, event=None):
        """ç•¶çµæŸæ—¥æœŸç²å¾—ç„¦é»æ™‚è§¸ç™¼"""
        try:
            print(f"ğŸ” çµæŸæ—¥æœŸç²å¾—ç„¦é»ï¼Œäº‹ä»¶: {event}")
            # å¼ºåˆ¶æ˜¾ç¤ºä¸‹æ‹‰æ—¥å†å¹¶ç«‹å³è°ƒæ•´ä½ç½®
            self.after(50, self._force_show_and_position_end_calendar)
        except Exception as e:
            print(f"è™•ç†çµæŸæ—¥æœŸç„¦é»æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_start_date_double_click(self, event=None):
        """ç•¶é–‹å§‹æ—¥æœŸè¢«é›™æ“Šæ™‚è§¸ç™¼"""
        try:
            print(f"ğŸ” é–‹å§‹æ—¥æœŸè¢«é›™æ“Šï¼Œäº‹ä»¶: {event}")
            # å¼ºåˆ¶æ˜¾ç¤ºä¸‹æ‹‰æ—¥å†
            self.start_date_entry.event_generate('<Button-1>')
            # å»¶è¿Ÿä¸€ä¸‹å†å°è¯•æ˜¾ç¤º
            self.after(100, self._force_show_start_calendar)
        except Exception as e:
            print(f"è™•ç†é–‹å§‹æ—¥æœŸé›™æ“Šæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _on_end_date_double_click(self, event=None):
        """ç•¶çµæŸæ—¥æœŸè¢«é›™æ“Šæ™‚è§¸ç™¼"""
        try:
            print(f"ğŸ” çµæŸæ—¥æœŸè¢«é›™æ“Šï¼Œäº‹ä»¶: {event}")
            # å¼ºåˆ¶æ˜¾ç¤ºä¸‹æ‹‰æ—¥å†
            self.end_date_entry.event_generate('<Button-1>')
            # å»¶è¿Ÿä¸€ä¸‹å†å°è¯•æ˜¾ç¤º
            self.after(100, self._force_show_end_calendar)
        except Exception as e:
            print(f"è™•ç†çµæŸæ—¥æœŸé›™æ“Šæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _force_show_start_calendar(self):
        """å¼ºåˆ¶æ˜¾ç¤ºå¼€å§‹æ—¥æœŸæ—¥å†"""
        try:
            if hasattr(self.start_date_entry, '_top_cal'):
                calendar_window = self.start_date_entry._top_cal
                calendar_window.deiconify()
                calendar_window.lift()

                # è®¡ç®—æ­£ç¡®çš„æ—¥å†ä½ç½®ï¼ˆåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼‰
                x = self.start_date_entry.winfo_rootx()
                y = self.start_date_entry.winfo_rooty() + self.start_date_entry.winfo_height()

                # ç¡®ä¿æ—¥å†ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
                screen_width = self.winfo_screenwidth()
                screen_height = self.winfo_screenheight()

                if x + calendar_window.winfo_width() > screen_width:
                    x = screen_width - calendar_window.winfo_width()
                if y + calendar_window.winfo_height() > screen_height:
                    y = self.start_date_entry.winfo_rooty() - calendar_window.winfo_height()

                calendar_window.geometry(f"+{x}+{y}")
                print("âœ… å¼ºåˆ¶æ˜¾ç¤ºå¼€å§‹æ—¥æœŸæ—¥å†æˆåŠŸï¼Œä½ç½®å·²è°ƒæ•´")
        except Exception as e:
            print(f"å¼ºåˆ¶æ˜¾ç¤ºå¼€å§‹æ—¥æœŸæ—¥å†å¤±è´¥: {e}")

    def _force_show_end_calendar(self):
        """å¼ºåˆ¶æ˜¾ç¤ºç»“æŸæ—¥æœŸæ—¥å†"""
        try:
            if hasattr(self.end_date_entry, '_top_cal'):
                calendar_window = self.end_date_entry._top_cal
                calendar_window.deiconify()
                calendar_window.lift()

                # è®¡ç®—æ­£ç¡®çš„æ—¥å†ä½ç½®ï¼ˆåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼‰
                x = self.end_date_entry.winfo_rootx()
                y = self.end_date_entry.winfo_rooty() + self.end_date_entry.winfo_height()

                # ç¡®ä¿æ—¥å†ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
                screen_width = self.winfo_screenwidth()
                screen_height = self.winfo_screenheight()

                if x + calendar_window.winfo_width() > screen_width:
                    x = screen_width - calendar_window.winfo_width()
                if y + calendar_window.winfo_height() > screen_height:
                    y = self.end_date_entry.winfo_rooty() - calendar_window.winfo_height()

                calendar_window.geometry(f"+{x}+{y}")
                print("âœ… å¼ºåˆ¶æ˜¾ç¤ºç»“æŸæ—¥æœŸæ—¥å†æˆåŠŸï¼Œä½ç½®å·²è°ƒæ•´")
        except Exception as e:
            print(f"å¼ºåˆ¶æ˜¾ç¤ºç»“æŸæ—¥æœŸæ—¥å†å¤±è´¥: {e}")

    def _on_start_calendar_shown(self, event=None):
        """å½“å¼€å§‹æ—¥æœŸæ—¥å†æ˜¾ç¤ºåè§¦å‘ï¼Œç¡®ä¿ä½ç½®æ­£ç¡®"""
        try:
            print(f"ğŸ” å¼€å§‹æ—¥æœŸæ—¥å†å·²æ˜¾ç¤ºï¼Œè°ƒæ•´ä½ç½®")
            self.after(100, self._adjust_start_calendar_position)
        except Exception as e:
            print(f"å¤„ç†å¼€å§‹æ—¥æœŸæ—¥å†æ˜¾ç¤ºäº‹ä»¶æ—¶å‘ç”Ÿé”™è¯¯: {e}")

    def _on_end_calendar_shown(self, event=None):
        """å½“ç»“æŸæ—¥æœŸæ—¥å†æ˜¾ç¤ºåè§¦å‘ï¼Œç¡®ä¿ä½ç½®æ­£ç¡®"""
        try:
            print(f"ğŸ” ç»“æŸæ—¥æœŸæ—¥å†å·²æ˜¾ç¤ºï¼Œè°ƒæ•´ä½ç½®")
            self.after(100, self._adjust_end_calendar_position)
        except Exception as e:
            print(f"å¤„ç†ç»“æŸæ—¥æœŸæ—¥å†æ˜¾ç¤ºäº‹ä»¶æ—¶å‘ç”Ÿé”™è¯¯: {e}")

    def _adjust_start_calendar_position(self):
        """è°ƒæ•´å¼€å§‹æ—¥æœŸæ—¥å†ä½ç½®"""
        try:
            if hasattr(self.start_date_entry, '_top_cal'):
                calendar_window = self.start_date_entry._top_cal
                if calendar_window.winfo_exists():
                    # è®¡ç®—æ­£ç¡®çš„æ—¥å†ä½ç½®ï¼ˆåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼‰
                    x = self.start_date_entry.winfo_rootx()
                    y = self.start_date_entry.winfo_rooty() + self.start_date_entry.winfo_height()

                    # ç¡®ä¿æ—¥å†ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
                    screen_width = self.winfo_screenwidth()
                    screen_height = self.winfo_screenheight()

                    if x + calendar_window.winfo_width() > screen_width:
                        x = screen_width - calendar_window.winfo_width()
                    if y + calendar_window.winfo_height() > screen_height:
                        y = self.start_date_entry.winfo_rooty() - calendar_window.winfo_height()

                    calendar_window.geometry(f"+{x}+{y}")
                    print("âœ… å¼€å§‹æ—¥æœŸæ—¥å†ä½ç½®å·²è°ƒæ•´")
        except Exception as e:
            print(f"è°ƒæ•´å¼€å§‹æ—¥æœŸæ—¥å†ä½ç½®å¤±è´¥: {e}")

    def _adjust_end_calendar_position(self):
        """è°ƒæ•´ç»“æŸæ—¥æœŸæ—¥å†ä½ç½®"""
        try:
            if hasattr(self.end_date_entry, '_top_cal'):
                calendar_window = self.end_date_entry._top_cal
                if calendar_window.winfo_exists():
                    # è®¡ç®—æ­£ç¡®çš„æ—¥å†ä½ç½®ï¼ˆåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼‰
                    x = self.end_date_entry.winfo_rootx()
                    y = self.end_date_entry.winfo_rooty() + self.end_date_entry.winfo_height()

                    # ç¡®ä¿æ—¥å†ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
                    screen_width = self.winfo_screenwidth()
                    screen_height = self.winfo_screenheight()

                    if x + calendar_window.winfo_width() > screen_width:
                        x = screen_width - calendar_window.winfo_width()
                    if y + calendar_window.winfo_height() > screen_height:
                        y = self.end_date_entry.winfo_rooty() - calendar_window.winfo_height()

                    calendar_window.geometry(f"+{x}+{y}")
                    print("âœ… ç»“æŸæ—¥æœŸæ—¥å†ä½ç½®å·²è°ƒæ•´")
        except Exception as e:
            print(f"è°ƒæ•´ç»“æŸæ—¥æœŸæ—¥å†ä½ç½®å¤±è´¥: {e}")

    def _force_show_and_position_start_calendar(self):
        """å¼ºåˆ¶æ˜¾ç¤ºå¹¶æ­£ç¡®å®šä½å¼€å§‹æ—¥æœŸæ—¥å†"""
        try:
            print("ğŸ” å¼€å§‹å¼ºåˆ¶æ˜¾ç¤ºå¹¶å®šä½å¼€å§‹æ—¥æœŸæ—¥å†")

            # é¦–å…ˆå°è¯•è§¦å‘ä¸‹æ‹‰
            self.start_date_entry.event_generate('<Button-1>')

            # ç­‰å¾…ä¸€ä¸‹è®©æ—¥å†æ˜¾ç¤º
            self.after(100, self._reposition_start_calendar)

        except Exception as e:
            print(f"å¼ºåˆ¶æ˜¾ç¤ºå¼€å§‹æ—¥æœŸæ—¥å†å¤±è´¥: {e}")

    def _force_show_and_position_end_calendar(self):
        """å¼ºåˆ¶æ˜¾ç¤ºå¹¶æ­£ç¡®å®šä½ç»“æŸæ—¥æœŸæ—¥å†"""
        try:
            print("ğŸ” å¼€å§‹å¼ºåˆ¶æ˜¾ç¤ºå¹¶å®šä½ç»“æŸæ—¥æœŸæ—¥å†")

            # é¦–å…ˆå°è¯•è§¦å‘ä¸‹æ‹‰
            self.end_date_entry.event_generate('<Button-1>')

            # ç­‰å¾…ä¸€ä¸‹è®©æ—¥å†æ˜¾ç¤º
            self.after(100, self._reposition_end_calendar)

        except Exception as e:
            print(f"å¼ºåˆ¶æ˜¾ç¤ºç»“æŸæ—¥æœŸæ—¥å†å¤±è´¥: {e}")

    def _reposition_start_calendar(self):
        """é‡æ–°å®šä½å¼€å§‹æ—¥æœŸæ—¥å†"""
        try:
            if hasattr(self.start_date_entry, '_top_cal'):
                calendar_window = self.start_date_entry._top_cal
                if calendar_window.winfo_exists():
                    # è®¡ç®—æ­£ç¡®çš„æ—¥å†ä½ç½®ï¼ˆåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼‰
                    x = self.start_date_entry.winfo_rootx()
                    y = self.start_date_entry.winfo_rooty() + self.start_date_entry.winfo_height() + 5

                    # ç¡®ä¿æ—¥å†ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
                    screen_width = self.winfo_screenwidth()
                    screen_height = self.winfo_screenheight()

                    if x + calendar_window.winfo_width() > screen_width:
                        x = screen_width - calendar_window.winfo_width() - 10
                    if y + calendar_window.winfo_height() > screen_height:
                        y = self.start_date_entry.winfo_rooty() - calendar_window.winfo_height() - 5

                    # å¼ºåˆ¶è®¾ç½®ä½ç½®
                    calendar_window.geometry(f"+{x}+{y}")
                    calendar_window.lift()
                    calendar_window.focus_force()

                    print(f"âœ… å¼€å§‹æ—¥æœŸæ—¥å†å·²é‡æ–°å®šä½åˆ°: ({x}, {y})")
                else:
                    print("âš ï¸ å¼€å§‹æ—¥æœŸæ—¥å†çª—å£ä¸å­˜åœ¨")
            else:
                print("âš ï¸ å¼€å§‹æ—¥æœŸDateEntryæ²¡æœ‰_top_calå±æ€§")
        except Exception as e:
            print(f"é‡æ–°å®šä½å¼€å§‹æ—¥æœŸæ—¥å†å¤±è´¥: {e}")

    def _reposition_end_calendar(self):
        """é‡æ–°å®šä½ç»“æŸæ—¥æœŸæ—¥å†"""
        try:
            if hasattr(self.end_date_entry, '_top_cal'):
                calendar_window = self.end_date_entry._top_cal
                if calendar_window.winfo_exists():
                    # è®¡ç®—æ­£ç¡®çš„æ—¥å†ä½ç½®ï¼ˆåœ¨è¾“å…¥æ¡†ä¸‹æ–¹ï¼‰
                    x = self.end_date_entry.winfo_rootx()
                    y = self.end_date_entry.winfo_rooty() + self.end_date_entry.winfo_height() + 5

                    # ç¡®ä¿æ—¥å†ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
                    screen_width = self.winfo_screenwidth()
                    screen_height = self.winfo_screenheight()

                    if x + calendar_window.winfo_width() > screen_width:
                        x = screen_width - calendar_window.winfo_width() - 10
                    if y + calendar_window.winfo_height() > screen_height:
                        y = self.end_date_entry.winfo_rooty() - calendar_window.winfo_height() - 5

                    # å¼ºåˆ¶è®¾ç½®ä½ç½®
                    calendar_window.geometry(f"+{x}+{y}")
                    calendar_window.lift()
                    calendar_window.focus_force()

                    print(f"âœ… ç»“æŸæ—¥æœŸæ—¥å†å·²é‡æ–°å®šä½åˆ°: ({x}, {y})")
                else:
                    print("âš ï¸ ç»“æŸæ—¥æœŸæ—¥å†çª—å£ä¸å­˜åœ¨")
            else:
                print("âš ï¸ ç»“æŸæ—¥æœŸDateEntryæ²¡æœ‰_top_calå±æ€§")
        except Exception as e:
            print(f"é‡æ–°å®šä½ç»“æŸæ—¥æœŸæ—¥å†å¤±è´¥: {e}")

    def _force_update_dates(self):
        """å¼·åˆ¶æ›´æ–°æ—¥æœŸè®Šæ•¸"""
        try:
            # å¾ DateEntry è®€å–ç•¶å‰é¸æ“‡çš„æ—¥æœŸ
            start_date = self.start_date_entry.get_date()
            end_date = self.end_date_entry.get_date()

            # æ›´æ–°è®Šæ•¸
            self.var_start.set(start_date.strftime('%Y-%m-%d'))
            self.var_end.set(end_date.strftime('%Y-%m-%d'))

            print(f"ğŸ”„ å¼·åˆ¶æ›´æ–°æ—¥æœŸå®Œæˆ")
            print(f"   é–‹å§‹æ—¥æœŸ: {self.var_start.get()}")
            print(f"   çµæŸæ—¥æœŸ: {self.var_end.get()}")

            # é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
            messagebox.showinfo(
    'æ—¥æœŸæ›´æ–°', f'æ—¥æœŸå·²å¼·åˆ¶æ›´æ–°ç‚ºï¼š\né–‹å§‹ï¼š{
        self.var_start.get()}\nçµæŸï¼š{
            self.var_end.get()}')

        except Exception as e:
            print(f"âŒ å¼·åˆ¶æ›´æ–°æ—¥æœŸæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            messagebox.showerror('éŒ¯èª¤', f'å¼·åˆ¶æ›´æ–°æ—¥æœŸæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}')

    def _quick_last_month(self):
        now = datetime.now()
        # è¨ˆç®—ä¸Šå€‹æœˆçš„é–‹å§‹å’ŒçµæŸæ—¥æœŸ
        if now.month == 1:  # å¦‚æœæ˜¯1æœˆï¼Œä¸Šå€‹æœˆæ˜¯å»å¹´12æœˆ
            last_month_start = now.replace(year=now.year - 1, month=12, day=1)
            last_month_end = now.replace(year=now.year - 1, month=12, day=31)
        else:  # å…¶ä»–æœˆä»½
            last_month_start = now.replace(month=now.month - 1, day=1)
            # è¨ˆç®—ä¸Šå€‹æœˆçš„æœ€å¾Œä¸€å¤©
            if now.month == 3:  # 3æœˆï¼Œä¸Šå€‹æœˆæ˜¯2æœˆ
                if now.year % 4 == 0 and (
    now.year % 100 != 0 or now.year % 400 == 0):  # é–å¹´
                    last_month_end = now.replace(month=2, day=29)
                else:
                    last_month_end = now.replace(month=2, day=28)
            elif now.month in [5, 7, 10, 12]:  # 4, 6, 9, 11æœˆæœ‰30å¤©
                last_month_end = now.replace(month=now.month - 1, day=30)
            else:  # å…¶ä»–æœˆä»½æœ‰31å¤©
                last_month_end = now.replace(month=now.month - 1, day=31)

        print(f"ğŸ” èª¿è©¦ï¼š_quick_last_month è¨ˆç®—çµæœ")
        print(f"   è¨ˆç®—çš„é–‹å§‹æ—¥æœŸ: {last_month_start.strftime('%Y-%m-%d')}")
        print(f"   è¨ˆç®—çš„çµæŸæ—¥æœŸ: {last_month_end.strftime('%Y-%m-%d')}")

        if hasattr(self.start_date_entry, 'set_date'):
            self.start_date_entry.set_date(last_month_start.date())
            self.end_date_entry.set_date(last_month_end.date())
            print(f"   âœ… å·²æ›´æ–° DateEntry é¡¯ç¤º")
        else:
            print(f"   âŒ DateEntry æ²’æœ‰ set_date æ–¹æ³•")

        self.var_start.set(last_month_start.strftime('%Y-%m-%d'))
        self.var_end.set(last_month_end.strftime('%Y-%m-%d'))
        # æ›´æ–°çŠ¶æ€æ ‡ç­¾
        self.status_label.configure(
    text=f"å·²è®¾ç½®ä¸ºä¸Šæœˆï¼š{
        last_month_start.strftime('%Y-%m-%d')} åˆ° {
            last_month_end.strftime('%Y-%m-%d')}")
        print(f"   âœ… å·²æ›´æ–°è®Šæ•¸å€¼")
        print(f"   var_start: {self.var_start.get()}")
        print(f"   var_end: {self.var_end.get()}")

        # å¼·åˆ¶æ›´æ–° DateEntry çš„é¡¯ç¤º
        try:
            self.start_date_entry.configure(date_pattern='yyyy-mm-dd')
            self.end_date_entry.configure(date_pattern='yyyy-mm-dd')
            print(f"   âœ… å·²å¼·åˆ¶æ›´æ–° DateEntry é…ç½®")
        except Exception as e:
            print(f"   âŒ å¼·åˆ¶æ›´æ–° DateEntry é…ç½®å¤±æ•—: {e}")

    def _pick_save_dir(self):
        path = filedialog.askdirectory()
        if path:
            self.var_save.set(path)

    # --- actions ---
    def _collect_params(self, *, need_account=False) -> Optional[dict]:
        # èª¿è©¦ï¼šé¡¯ç¤ºç•¶å‰æ—¥æœŸè®Šæ•¸çš„å€¼
        start_date_str = self.var_start.get().strip()
        end_date_str = self.var_end.get().strip()
        print(f"ğŸ” èª¿è©¦ï¼šç•¶å‰æ—¥æœŸè®Šæ•¸å€¼")
        print(f"   var_start: '{start_date_str}'")
        print(f"   var_end: '{end_date_str}'")

        try:
            start = datetime.strptime(
    start_date_str + ' 00:00', '%Y-%m-%d %H:%M')
            end = datetime.strptime(end_date_str + ' 23:59', '%Y-%m-%d %H:%M')
            print(f"   parsed_start: {start}")
            print(f"   parsed_end: {end}")

            if end < start:
                messagebox.showwarning('æ—¥æœŸ', 'çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ')
                return None
        except Exception as e:
            print(f"âŒ æ—¥æœŸè§£æéŒ¯èª¤: {e}")
            messagebox.showwarning('æ—¥æœŸ', 'æ—¥æœŸæ ¼å¼éœ€ç‚º YYYY-MM-DD')
            return None
        save_dir = self.var_save.get().strip()
        if not save_dir:
            messagebox.showwarning('è·¯å¾‘', 'è«‹é¸æ“‡ä¸‹è¼‰å„²å­˜è³‡æ–™å¤¾')
            return None

        # ç²å–é¸ä¸­çš„ä¾›æ‡‰å•†éƒµç®±ï¼ˆå¯é¸ï¼Œä¸å¼·åˆ¶è¦æ±‚ï¼‰
        selected_supplier_emails = self._get_selected_supplier_emails()

        # çµ„åˆéƒµä»¶éæ¿¾å™¨ï¼šç”¨æˆ¶è¼¸å…¥çš„ + é¸ä¸­çš„ä¾›æ‡‰å•†éƒµç®±ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        user_email_filters = self.var_email.get().strip()
        all_email_filters = []
        if user_email_filters:
            all_email_filters.extend(
                [email.strip() for email in user_email_filters.split(';') if email.strip()])
        if selected_supplier_emails:
            all_email_filters.extend(selected_supplier_emails)

        params = {
            'start_date': start,
            'end_date': end,
            'save_dir': save_dir,
            # å¦‚æœæ²’æœ‰éæ¿¾å™¨ï¼Œå‰‡ç‚ºç©º
            'email_filters': ';'.join(all_email_filters) if all_email_filters else '',
            'content_filters': '',  # ç§»é™¤ content filter
            'scope_subj': False,    # ç§»é™¤ content filter
            'scope_body': False,    # ç§»é™¤ content filter
            'attach_use_defaults': False,  # ä¸ä½¿ç”¨é è¨­é—œéµå­—ï¼Œä¸‹è¼‰æ‰€æœ‰é™„ä»¶
            'attach_extra_keywords': '',  # ç§»é™¤é¡å¤–é—œéµå­—
            # ä½¿ç”¨é è¨­å‰¯æª”å
            'ext_whitelist': ','.join(MonthEndDownloader.DEFAULT_EXTS),
        }
        if need_account:
            idx = self.downloader._select_outlook_account()
            if idx is None:
                return None
            params['account_idx'] = idx
        return params

    def _open_log(self, title: str):
        popup = ProgressPopup(self, title)
        popup.log(f"{title}\n")
        return popup

    def _run_in_thread(self, fn, *args):
        th = threading.Thread(target=fn, args=args, daemon=True)
        th.start()

    def _on_preview(self):
        params = self._collect_params(need_account=True)
        if not params:
            return

        # èª¿è©¦ï¼šé¡¯ç¤ºå‚³éçµ¦ preview çš„åƒæ•¸
        print(f"ğŸ” èª¿è©¦ï¼šå‚³éçµ¦ preview çš„åƒæ•¸")
        print(f"   start_date: {params['start_date']}")
        print(f"   end_date: {params['end_date']}")

        # æ›´æ–°çŠ¶æ€æ ‡ç­¾
        self.status_label.configure(
    text=f"æ­£åœ¨é¢„è§ˆï¼š{
        params['start_date'].strftime('%Y-%m-%d')} åˆ° {
            params['end_date'].strftime('%Y-%m-%d')}")

        log_popup = self._open_log('MonthEnd é è¦½ / Preview')

        def logger(msg: str):
            log_popup.log(msg)

        def job():
            try:
                mails, atts = self.downloader.preview(params, logger)
                logger(f"\nPreview Done: mails={mails}, attachments={atts}\n")
                # æ›´æ–°çŠ¶æ€æ ‡ç­¾
                if mails > 0:
                    self.status_label.configure(
    text=f"é¢„è§ˆå®Œæˆï¼šæ‰¾åˆ° {mails} å°é‚®ä»¶ï¼Œ{atts} ä¸ªé™„ä»¶")
                else:
                    self.status_label.configure(text=f"é¢„è§ˆå®Œæˆï¼šæœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é‚®ä»¶")
            finally:
                pass
        self._run_in_thread(job)

    def _on_download(self):
        params = self._collect_params(need_account=True)
        if not params:
            return
        os.makedirs(params['save_dir'], exist_ok=True)

        # æ›´æ–°çŠ¶æ€æ ‡ç­¾
        self.status_label.configure(
    text=f"æ­£åœ¨ä¸‹è½½ï¼š{
        params['start_date'].strftime('%Y-%m-%d')} åˆ° {
            params['end_date'].strftime('%Y-%m-%d')}")

        log_popup = self._open_log('MonthEnd ä¸‹è¼‰ / Download')

        def logger(msg: str):
            log_popup.log(msg)

        def job():
            try:
                mails, atts = self.downloader.download(params, logger)
                logger(
    f"\nDownload Done: mails={mails}, attachments saved={atts}\n")
                messagebox.showinfo(
    'å®Œæˆ', f"ä¸‹è¼‰å®Œæˆ\néƒµä»¶ï¼š{mails}\né™„ä»¶ï¼š{atts}\nå­˜æ”¾ï¼š{
        params['save_dir']}")
                # æ›´æ–°çŠ¶æ€æ ‡ç­¾
                if mails > 0:
                    self.status_label.configure(
    text=f"ä¸‹è½½å®Œæˆï¼š{mails} å°é‚®ä»¶ï¼Œ{atts} ä¸ªé™„ä»¶å·²ä¿å­˜")
                else:
                    self.status_label.configure(text=f"ä¸‹è½½å®Œæˆï¼šæœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é‚®ä»¶")
            finally:
                pass
        self._run_in_thread(job)

    def _on_download_siahuat(self):
        """ä¸‹è¼‰ Siahuat è¨‚å–® - å¾æœ¬æœˆ1è™Ÿé–‹å§‹"""
        try:
            # è¨­ç½®ç‰¹å®šçš„æ—¥æœŸç¯„åœï¼šæœ¬æœˆ1è™Ÿåˆ°ä»Šå¤©
            current_date = datetime.now()
            start_of_month = current_date.replace(day=1)
            
            # è‡ªå‹•è¨­ç½®æ—¥æœŸ
            if hasattr(self, 'start_date_entry') and hasattr(self.start_date_entry, 'set_date'):
                self.start_date_entry.set_date(start_of_month)
            else:
                self.var_start.set(start_of_month.strftime('%Y-%m-%d'))
                
            if hasattr(self, 'end_date_entry') and hasattr(self.end_date_entry, 'set_date'):
                self.end_date_entry.set_date(current_date)
            else:
                self.var_end.set(current_date.strftime('%Y-%m-%d'))
            
            # æ”¶é›†åƒæ•¸ï¼Œä½†ä½¿ç”¨ Siahuat ç‰¹å®šè¨­ç½®
            params = self._collect_params_siahuat()
            if not params:
                return
                
            os.makedirs(params['save_dir'], exist_ok=True)
            log_popup = self._open_log('Siahuat è¨‚å–®ä¸‹è¼‰ / Siahuat Orders Download')
            
            def logger(msg: str):
                log_popup.log(msg)
                
            def job():
                try:
                    logger(f"ğŸ¢ é–‹å§‹ä¸‹è¼‰ Siahuat è¨‚å–®...")
                    logger(f"ğŸ“… æ—¥æœŸç¯„åœ: {params['start_date']} åˆ° {params['end_date']}")
                    logger(f"ğŸ“ ä¿å­˜ä½ç½®: {params['save_dir']}")
                    logger("=" * 50)
                    
                    mails, atts = self.downloader.download(params, logger)
                    logger(f"\nâœ… Siahuat è¨‚å–®ä¸‹è¼‰å®Œæˆ: éƒµä»¶={mails}, é™„ä»¶={atts}\n")
                    messagebox.showinfo('å®Œæˆ', f"Siahuat è¨‚å–®ä¸‹è¼‰å®Œæˆ\néƒµä»¶ï¼š{mails}\né™„ä»¶ï¼š{atts}\nå­˜æ”¾ï¼š{params['save_dir']}")
                except Exception as e:
                    logger(f"âŒ Siahuat è¨‚å–®ä¸‹è¼‰å¤±æ•—: {str(e)}")
                    messagebox.showerror('éŒ¯èª¤', f"Siahuat è¨‚å–®ä¸‹è¼‰å¤±æ•—:\n{str(e)}")
                    
            self._run_in_thread(job)
            
        except Exception as e:
            messagebox.showerror('éŒ¯èª¤', f"è¨­ç½® Siahuat ä¸‹è¼‰å¤±æ•—:\n{str(e)}")

    def _collect_params_siahuat(self):
        """æ”¶é›† Siahuat è¨‚å–®ä¸‹è¼‰çš„ç‰¹å®šåƒæ•¸"""
        try:
            # ä½¿ç”¨ç•¶å‰è¨­ç½®çš„æ—¥æœŸ
            start_date_str = self.var_start.get().strip()
            end_date_str = self.var_end.get().strip()
            
            if not start_date_str or not end_date_str:
                messagebox.showerror('éŒ¯èª¤', 'è«‹è¨­ç½®æœ‰æ•ˆçš„æ—¥æœŸç¯„åœ')
                return None
                
            # è§£ææ—¥æœŸ
            start_date = datetime.strptime(start_date_str, '%Y-%m-%d')
            end_date = datetime.strptime(end_date_str, '%Y-%m-%d').replace(hour=23, minute=59, second=59)
            
            # è¨­ç½®ä¿å­˜ç›®éŒ„ - åœ¨åŸç›®éŒ„ä¸‹å‰µå»º Siahuat å­æ–‡ä»¶å¤¾
            base_save_dir = self.var_save.get().strip()
            siahuat_save_dir = os.path.join(base_save_dir, 'Siahuat_Orders')
            
            # Siahuat ç‰¹å®šçš„åƒæ•¸
            params = {
                'start_date': start_date,
                'end_date': end_date,
                'save_dir': siahuat_save_dir,
                'outlook_folder': 'Inbox',  # é è¨­ä½¿ç”¨æ”¶ä»¶åŒ£
                'email_filters': ['siahuat'],  # å°ˆé–€ç¯©é¸ Siahuat ç›¸é—œéƒµä»¶
                'content_filters': ['order', 'siahuat', 'è¨‚å–®'],  # å…§å®¹ç¯©é¸é—œéµè©
                'content_scope_subj': True,
                'content_scope_body': True,
                'account_idx': self.downloader._select_outlook_account()
            }
            
            if params['account_idx'] is None:
                messagebox.showerror('éŒ¯èª¤', 'ç„¡æ³•é¸æ“‡ Outlook å¸³æˆ¶')
                return None
                
            return params
            
        except ValueError as e:
            messagebox.showerror('éŒ¯èª¤', f'æ—¥æœŸæ ¼å¼éŒ¯èª¤: {str(e)}')
            return None
        except Exception as e:
            messagebox.showerror('éŒ¯èª¤', f'åƒæ•¸æ”¶é›†å¤±æ•—: {str(e)}')
            return None

    def _test_outlook(self):
        """æµ‹è¯•Outlookè¿æ¥å’Œé‚®ä»¶æ•°é‡"""
        try:
            # æ›´æ–°çŠ¶æ€æ ‡ç­¾
            self.status_label.configure(text="æ­£åœ¨æµ‹è¯•Outlookè¿æ¥...")

            # é€‰æ‹©Outlookè´¦æˆ·
            account_idx = self.downloader._select_outlook_account()
            if account_idx is None:
                self.status_label.configure(text="æµ‹è¯•å¤±è´¥ï¼šæ— æ³•é€‰æ‹©Outlookè´¦æˆ·")
                return

            # åˆ›å»ºæµ‹è¯•å‚æ•° - ä½¿ç”¨æ›´å¤§çš„æ—¥æœŸèŒƒå›´
            now = datetime.now()
            test_start = now - timedelta(days=30)  # æµ‹è¯•æœ€è¿‘30å¤©
            test_end = now

            test_params = {
                'start_date': test_start,
                'end_date': test_end,
                # æ·»åŠ save_dir
                'save_dir': os.path.join(os.path.expanduser('~'), 'Downloads', 'MonthEnd'),
                'email_filters': '',  # ä¸è¿‡æ»¤å‘ä»¶äºº
                'content_filters': '',
                'scope_subj': False,
                'scope_body': False,
                'attach_use_defaults': True,
                'attach_extra_keywords': '',
                'ext_whitelist': ','.join(MonthEndDownloader.DEFAULT_EXTS),
                'account_idx': account_idx
            }

            log_popup = self._open_log(
                'Outlook è¿æ¥æµ‹è¯• / Outlook Connection Test')

            def logger(msg: str):
                log_popup.log(msg)

            def test_job():
                try:
                    logger("ğŸ” å¼€å§‹æµ‹è¯•Outlookè¿æ¥...")
                    logger(
                        f"ğŸ“… æµ‹è¯•æ—¥æœŸèŒƒå›´ï¼š{test_start.strftime('%Y-%m-%d')} åˆ° {test_end.strftime('%Y-%m-%d')}")
                    logger("ğŸ“§ ä¸è¿‡æ»¤å‘ä»¶äººï¼Œæ£€æŸ¥æ‰€æœ‰é‚®ä»¶...")

                    # ä½¿ç”¨é¢„è§ˆæ¨¡å¼æµ‹è¯•
                    mails, atts = self.downloader.preview(test_params, logger)

                    if mails > 0:
                        logger(f"\nâœ… æµ‹è¯•æˆåŠŸï¼æ‰¾åˆ° {mails} å°é‚®ä»¶ï¼Œ{atts} ä¸ªé™„ä»¶")
                        self.status_label.configure(
                            text=f"æµ‹è¯•æˆåŠŸï¼šæ‰¾åˆ° {mails} å°é‚®ä»¶")
                    else:
                        logger(f"\nâš ï¸ æµ‹è¯•å®Œæˆï¼Œä½†æœªæ‰¾åˆ°é‚®ä»¶")
                        logger("å¯èƒ½çš„åŸå› ï¼š")
                        logger("1. è¯¥æ—¶é—´æ®µå†…ç¡®å®æ²¡æœ‰é‚®ä»¶")
                        logger("2. Outlookæƒé™é—®é¢˜")
                        logger("3. é‚®ä»¶å­˜å‚¨åœ¨å…¶ä»–ä½ç½®")
                        self.status_label.configure(text="æµ‹è¯•å®Œæˆï¼šæœªæ‰¾åˆ°é‚®ä»¶")

                except Exception as e:
                    logger(f"\nâŒ æµ‹è¯•å¤±è´¥ï¼š{str(e)}")
                    self.status_label.configure(text=f"æµ‹è¯•å¤±è´¥ï¼š{str(e)}")

            self._run_in_thread(test_job)

        except Exception as e:
            messagebox.showerror("æµ‹è¯•å¤±è´¥", f"æµ‹è¯•Outlookæ—¶å‘ç”Ÿé”™è¯¯ï¼š{str(e)}")
            self.status_label.configure(text=f"æµ‹è¯•å¤±è´¥ï¼š{str(e)}")

    @staticmethod
    def get_smtp_sender(msg):
        try:
            sender = msg.Sender
            if sender is not None:
                if sender.AddressEntryUserType == 0:  # olExchangeUserAddressEntry
                    ex_user = sender.GetExchangeUser()
                    if ex_user is not None:
                        return ex_user.PrimarySmtpAddress.lower()
                elif sender.AddressEntryUserType == 5:  # olSmtpAddressEntry
                    return sender.Address.lower()
            return str(getattr(msg, 'SenderEmailAddress', '')).lower()
        except Exception as e:
            print(f"[DEBUG] get_smtp_sender: Exception: {e}")
            return str(getattr(msg, 'SenderEmailAddress', '')).lower()

    def _pick_config_file(self):
        """é¸æ“‡é…ç½®æ–‡ä»¶"""
        file_path = filedialog.askopenfilename(
            title="é¸æ“‡é…ç½®æ–‡ä»¶ / Select Config File",
            filetypes=[("Excel files", "*.xlsx *.xls"), ("All files", "*.*")]
        )
        if file_path:
            self.var_config.set(file_path)
            self.config_path = file_path
            # è‡ªå‹•è¼‰å…¥ä¾›æ‡‰å•†
            self._load_suppliers()

    def _load_suppliers(self):
        """å¾é…ç½®æ–‡ä»¶è¼‰å…¥ä¾›æ‡‰å•†åˆ—è¡¨"""
        config_path = self.var_config.get().strip()
        if not config_path:
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡é…ç½®æ–‡ä»¶")
            return

        if not os.path.exists(config_path):
            messagebox.showerror("éŒ¯èª¤", "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨")
            return

        try:
            # æ¸…ç©ºç¾æœ‰çš„ä¾›æ‡‰å•†åˆ—è¡¨
            self.suppliers = []

            # è®€å– Excel æ–‡ä»¶
            wb = load_workbook(config_path, data_only=True)

            # å°‹æ‰¾ monthend sheet
            monthend_sheet = None
            for sheet_name in wb.sheetnames:
                if 'monthend' in sheet_name.lower():
                    monthend_sheet = wb[sheet_name]
                    break

            if not monthend_sheet:
                messagebox.showwarning("è­¦å‘Š", "åœ¨é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ° monthend å·¥ä½œè¡¨")
                return

            # è®€å–ä¾›æ‡‰å•†ä¿¡æ¯ (Column A: ä¾›æ‡‰å•†åç¨±, Column B: éƒµç®±)
            for row in monthend_sheet.iter_rows(min_row=2, values_only=True):
                if row and row[0] and row[1]:  # ç¢ºä¿åç¨±å’Œéƒµç®±éƒ½å­˜åœ¨
                    supplier_name = str(row[0]).strip()
                    supplier_email = str(row[1]).strip()

                    if supplier_name and supplier_email:
                        supplier_data = {
                            'name': supplier_name,
                            'email': supplier_email
                        }
                        self.suppliers.append(supplier_data)

            if self.suppliers:
                messagebox.showinfo("æˆåŠŸ", f"å·²è¼‰å…¥ {len(self.suppliers)} å€‹ä¾›æ‡‰å•†")
                # æ›´æ–°ä¾›åº”å•†æ•°é‡æ ‡ç­¾
                self.supplier_count_label.configure(
                    text=f"å·²è¼‰å…¥ {len(self.suppliers)} å€‹ä¾›æ‡‰å•†")
            else:
                messagebox.showwarning("è­¦å‘Š", "æœªæ‰¾åˆ°æœ‰æ•ˆçš„ä¾›æ‡‰å•†æ•¸æ“š")
                self.supplier_count_label.configure(text="æœªæ‰¾åˆ°ä¾›æ‡‰å•†æ•¸æ“š")

        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"è¼‰å…¥ä¾›æ‡‰å•†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")
            print(f"è¼‰å…¥ä¾›æ‡‰å•†éŒ¯èª¤ï¼š{e}")

    # è¿™äº›æ–¹æ³•ç°åœ¨åœ¨ç‹¬ç«‹çª—å£ä¸­å¤„ç†
    def _select_all_suppliers(self):
        """å…¨é¸æ‰€æœ‰ä¾›æ‡‰å•† - å·²ç§»è‡³ç¨ç«‹çª—å£"""
        pass

    def _deselect_all_suppliers(self):
        """å–æ¶ˆå…¨é¸æ‰€æœ‰ä¾›æ‡‰å•† - å·²ç§»è‡³ç¨ç«‹çª—å£"""
        pass

    def _get_selected_supplier_emails(self):
        """ç²å–é¸ä¸­çš„ä¾›æ‡‰å•†éƒµç®±åˆ—è¡¨"""
        if hasattr(self, 'selected_suppliers') and self.selected_suppliers:
            return [supplier['email'] for supplier in self.selected_suppliers]
        return []

# ========== ç‡Ÿé‹ç”¨å“è¨‚å–®è™•ç† ==========

class OperationSuppliesOrder:
    """ç‡Ÿé‹ç”¨å“è¨‚å–®è™•ç† - å…¨æ–°è¨­è¨ˆç‰ˆæœ¬"""

    def __init__(self):
        """åˆå§‹åŒ–è¨‚å–®è™•ç†å™¨"""
        self.suppliers = ['Freshening', 'Legacy', 'Unikleen']
        self.outlet_data = {}  # ä»Configæ–‡ä»¶è¯»å–çš„é—¨å¸‚ä¿¡æ¯
        self.supplier_templates = {}  # å‚å•†æ¨¡æ¿æ•°æ®

        # å‚å•†äº§å“èŒƒå›´ï¼ˆæ ¹æ®å®é™…æ¨¡æ¿è°ƒæ•´ï¼‰- æ ¹æ“šå¯¦éš›æ•¸æ“šèª¿æ•´
        self.supplier_ranges = {
            'Freshening': {'start_row': 5, 'end_row': 100},
            'Legacy': {'start_row': 5, 'end_row': 100},
            'Unikleen': {'start_row': 5, 'end_row': 100}
        }

    def process_orders(self, supplies_file, config_file, output_folder, log_callback=None, selected_supplier=None):
        """å¤„ç†è®¢å•ä¸»å‡½æ•°"""
        try:
            if log_callback:
                if selected_supplier:
                    log_callback(f"ğŸš€ é–‹å§‹è™•ç† {selected_supplier} ç‡Ÿé‹ç”¨å“è¨‚å–®...")
                else:
                    log_callback("ğŸš€ é–‹å§‹è™•ç†ç‡Ÿé‹ç”¨å“è¨‚å–®...")
                log_callback(f"ğŸ“ ä¾›æ‡‰å•†æ–‡ä»¶: {os.path.basename(supplies_file)}")
                log_callback(f"ğŸ“ é…ç½®æ–‡ä»¶: {os.path.basename(config_file)}")
                log_callback(f"ğŸ“ è¼¸å‡ºè³‡æ–™å¤¾: {output_folder}")

            # ç¡®ä¿è¾“å‡ºæ–‡ä»¶å¤¹å­˜åœ¨
            if not os.path.exists(output_folder):
                os.makedirs(output_folder)

            # 1. è¯»å–Configæ–‡ä»¶çš„é—¨å¸‚ä¿¡æ¯
            self._read_outlet_config(config_file, log_callback)

            # 2. è¯»å–Operation Suppliesæ–‡ä»¶å…©æ¬¡ï¼šä¸€æ¬¡è®€å–æ•¸æ“šï¼Œä¸€æ¬¡è®€å–æ¨¡æ¿
            # ç”¨æ–¼è®€å–é–€å¸‚æ•¸æ“šçš„å·¥ä½œç°¿ï¼ˆå…¬å¼è¨ˆç®—çµæœï¼‰
            wb_data = openpyxl.load_workbook(supplies_file, data_only=True)
            # ç”¨æ–¼è¤‡è£½æ¨¡æ¿çš„å·¥ä½œç°¿ï¼ˆä¿ç•™æ ¼å¼å’Œå…¬å¼ï¼‰
            wb_templates = openpyxl.load_workbook(supplies_file, data_only=False)

            # 3. è¯»å–å‚å•†æ¨¡æ¿
            self._read_supplier_templates(wb_templates, log_callback)

            # 4. ç”Ÿæˆå‚å•†è®¢å•æ–‡ä»¶
            all_results = self._generate_supplier_orders(wb_data, wb_templates, output_folder, log_callback, selected_supplier)

            wb_data.close()
            wb_templates.close()

            # 5. é¡¯ç¤º treeview çµæœ
            if all_results:
                self._show_operation_supplies_results(all_results)

            if log_callback:
                log_callback("âœ… ç‡Ÿé‹ç”¨å“è¨‚å–®è™•ç†å®Œæˆï¼")

            return True

        except Exception as e:
            if log_callback:
                log_callback(f"âŒ è™•ç†å¤±æ•—: {str(e)}")
            return False

    def _read_outlet_config(self, config_file, log_callback=None):
        """è¯»å–Configæ–‡ä»¶çš„OUTLETå·¥ä½œè¡¨"""
        try:
            if log_callback:
                log_callback("ğŸ“– è®€å–é–€å¸‚é…ç½®ä¿¡æ¯...")

            # è¯»å–OUTLETå·¥ä½œè¡¨
            df = pd.read_excel(config_file, sheet_name="OUTLET")

            # å¤„ç†é—¨å¸‚æ•°æ®
            print(f"\nğŸ“– å¼€å§‹è¯»å–é—¨å¸‚é…ç½®...")
            print(f"ğŸ“‹ Configæ–‡ä»¶åˆ—æ•°: {len(df.columns)}")
            print(f"ğŸ“‹ Configæ–‡ä»¶è¡Œæ•°: {len(df)}")
            
            for idx, row in df.iterrows():
                short_name = str(row.iloc[0]).strip()  # Column A: Short Name (å¦‚ NEX, WS, HLM)
                outlet_name = str(row.iloc[1]).strip()  # Column B: Outlet Full Name (å¦‚ Sushi Express NEX Serangoon)
                address = str(row.iloc[3]).strip()      # Column D: Address
                delivery_date = str(row.iloc[5]).strip() # Column F: Freshening Delivery Date
                
                print(f"è¡Œ {idx+1}: ç®€ç§°='{short_name}', å…¨å='{outlet_name}', åœ°å€='{address}', é€è´§æ—¥æœŸ='{delivery_date}'")

                if short_name and short_name != 'nan' and outlet_name and outlet_name != 'nan':
                    # ä¸»è¦ä½¿ç”¨ç®€ç§°ä½œä¸ºé”®ï¼Œå› ä¸ºå·¥ä½œè¡¨åç§°é€šå¸¸æ˜¯ç®€ç§°
                    self.outlet_data[short_name] = {
                        'outlet_name': outlet_name,  # å…¨åç”¨äºæ˜¾ç¤º
                        'address': address,
                        'delivery_date': delivery_date
                    }
                    print(f"âœ… ä¿å­˜é—¨å¸‚é…ç½®: '{short_name}' -> '{outlet_name}'")
                    
                    # åŒæ—¶ä¿å­˜å…¨ååˆ°ç®€ç§°çš„æ˜ å°„ï¼Œä»¥é˜²ä¸‡ä¸€
                    self.outlet_data[outlet_name] = {
                        'outlet_name': outlet_name,
                        'address': address,
                        'delivery_date': delivery_date
                    }
                    print(f"âœ… ä¿å­˜é—¨å¸‚é…ç½®: '{outlet_name}' -> '{outlet_name}'")
                else:
                    print(f"âš ï¸ è·³è¿‡æ— æ•ˆè¡Œ: ç®€ç§°='{short_name}', å…¨å='{outlet_name}'")

            if log_callback:
                log_callback(f"âœ… è®€å–åˆ° {len(self.outlet_data)} å€‹é–€å¸‚é…ç½®")

        except Exception as e:
            if log_callback:
                log_callback(f"âŒ è®€å–é–€å¸‚é…ç½®å¤±æ•—: {str(e)}")
            raise

    def _read_supplier_templates(self, workbook, log_callback=None):
        """è¯»å–å‚å•†æ¨¡æ¿"""
        if log_callback:
            log_callback("ğŸ“– è®€å–å» å•†æ¨¡æ¿...")

        for supplier in self.suppliers:
            if supplier in workbook.sheetnames:
                if log_callback:
                    log_callback(f"è®€å– {supplier} æ¨¡æ¿")

                # ä¿å­˜æ¨¡æ¿å·¥ä½œè¡¨
                self.supplier_templates[supplier] = workbook[supplier]
            else:
                if log_callback:
                    log_callback(f"âš ï¸ æ‰¾ä¸åˆ° {supplier} æ¨¡æ¿")

    def _generate_supplier_orders(self, data_workbook, template_workbook, output_folder, log_callback=None, selected_supplier=None):
        """ç”Ÿæˆå‚å•†è®¢å•æ–‡ä»¶"""
        if log_callback:
            if selected_supplier:
                log_callback(f"ğŸ“‹ ç”Ÿæˆ {selected_supplier} å» å•†è¨‚å–®æ–‡ä»¶...")
        else:
                log_callback("ğŸ“‹ ç”Ÿæˆæ‰€æœ‰å» å•†è¨‚å–®æ–‡ä»¶...")

        # è·å–æ‰€æœ‰é—¨å¸‚å·¥ä½œè¡¨
        supplier_sheets = set(self.suppliers)
        outlet_sheets = [name for name in data_workbook.sheetnames if name not in supplier_sheets]

        if log_callback:
            log_callback(f"æ‰¾åˆ° {len(outlet_sheets)} å€‹é–€å¸‚å·¥ä½œè¡¨")

        # æ”¶é›†æ‰€æœ‰æ•¸æ“šç”¨æ–¼ treeview
        all_results = {}

        # ç¡®å®šè¦å¤„ç†çš„ä¾›åº”å•†åˆ—è¡¨
        if selected_supplier:
            suppliers_to_process = [selected_supplier] if selected_supplier in self.suppliers else []
            if log_callback:
                log_callback(f"ğŸ¯ åªå¤„ç† {selected_supplier} ä¾›åº”å•†")
        else:
            suppliers_to_process = self.suppliers
            if log_callback:
                log_callback("ğŸ¯ å¤„ç†æ‰€æœ‰ä¾›åº”å•†")

        # ä¸ºæ¯ä¸ªå‚å•†ç”Ÿæˆè®¢å•æ–‡ä»¶
        for supplier in suppliers_to_process:
            if supplier not in self.supplier_templates:
                if log_callback:
                    log_callback(f"âš ï¸ è·³é {supplier}ï¼šæ‰¾ä¸åˆ°æ¨¡æ¿")
                continue

            if log_callback:
                log_callback(f"ç”Ÿæˆ {supplier} è¨‚å–®æ–‡ä»¶...")

            # åˆ›å»ºè¾“å‡ºæ–‡ä»¶è·¯å¾„ - ä½¿ç”¨ä¸‹é€±çš„æ—¥æœŸ
            current_date = datetime.now()
            next_week = current_date + timedelta(days=7)
            filename = f"{supplier}_Order_{next_week.strftime('%Y_%m_%d')}.xlsx"
            output_path = os.path.join(output_folder, filename)

            # åˆ›å»ºæ–°çš„å·¥ä½œç°¿
            wb_new = openpyxl.Workbook()

            outlet_count = 0
            first_sheet_created = False
            supplier_results = {}

            # ä¸ºæ¯ä¸ªé—¨å¸‚åˆ›å»ºå·¥ä½œè¡¨
            for outlet_sheet_name in outlet_sheets:
                if log_callback:
                    log_callback(f"  è™•ç†é–€å¸‚: {outlet_sheet_name}")

                # è¯»å–é—¨å¸‚è®¢å•æ•°æ®ï¼ˆä½¿ç”¨æ•¸æ“šå·¥ä½œç°¿ï¼‰
                outlet_orders, found_products, valid_orders = self._read_outlet_orders(data_workbook[outlet_sheet_name], supplier)

                if outlet_orders:  # åªä¸ºæœ‰è®¢å•çš„é—¨å¸‚åˆ›å»ºå·¥ä½œè¡¨
                    outlet_count += 1

                    # å¤åˆ¶å‚å•†æ¨¡æ¿ï¼ˆä½¿ç”¨æ¨¡æ¿å·¥ä½œç°¿ï¼‰
                    template_ws = self.supplier_templates[supplier]

                    if not first_sheet_created:
                        # ä½¿ç”¨é»˜è®¤å·¥ä½œè¡¨ä½œä¸ºç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                        new_ws = wb_new.active
                        new_ws.title = outlet_sheet_name
                        first_sheet_created = True
                    else:
                        new_ws = wb_new.create_sheet(title=outlet_sheet_name)

                    # å®Œæ•´å¤åˆ¶æ¨¡æ¿ï¼ˆåŒ…æ‹¬æ ¼å¼ï¼‰
                    self._copy_template_fully(template_ws, new_ws)

                    # æ›´æ–°é—¨å¸‚ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ—¥æœŸï¼‰
                    self._update_outlet_info(new_ws, outlet_sheet_name, supplier, log_callback)

                    # ç§»é™¤é‡å¤çš„æ—¥æœŸæ›´æ–°ï¼Œå› ä¸º_update_outlet_infoå·²ç»å¤„ç†äº†æ—¥æœŸ
                    # self._update_dates(new_ws, log_callback)

                    # å¡«å…¥è®¢å•æ•°é‡
                    filled_count = self._fill_orders(new_ws, outlet_orders, supplier, outlet_sheet_name, log_callback)

                    # æ”¶é›†çµæœæ•¸æ“š
                    supplier_results[outlet_sheet_name] = {
                        'found_products': found_products,
                        'valid_orders': valid_orders,
                        'filled_count': filled_count,
                        'products': list(outlet_orders.keys()),
                        'product_quantities': outlet_orders  # æ·»åŠ äº§å“æ•°é‡ä¿¡æ¯
                    }

            # å¦‚æœæ²¡æœ‰åˆ›å»ºä»»ä½•å·¥ä½œè¡¨ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„é»˜è®¤å·¥ä½œè¡¨
            if not first_sheet_created:
                wb_new.active.title = "No Orders"

            # ä¿å­˜å·¥ä½œç°¿
            wb_new.save(output_path)

            all_results[supplier] = {
                'outlet_count': outlet_count,
                'outlets': supplier_results
            }

            if log_callback:
                log_callback(f"âœ… {supplier} è¨‚å–®æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼ŒåŒ…å« {outlet_count} å€‹é–€å¸‚")

        return all_results

    def _read_outlet_orders(self, outlet_ws, supplier):
        """è¯»å–å•ä¸ªé—¨å¸‚çš„ç‰¹å®šå‚å•†è®¢å•æ•°æ® - æ”¹é€²ç‰ˆæœ¬"""
        orders = {}

        if supplier not in self.supplier_ranges:
            return orders, 0, 0

        range_info = self.supplier_ranges[supplier]
        start_row = range_info['start_row']
        end_row = range_info['end_row']

        found_products = 0
        valid_orders = 0

        # éæ­·æ›´å¤§çš„ç¯„åœä¾†æ‰¾åˆ°æ‰€æœ‰ç”¢å“
        for row in range(start_row, min(end_row + 1, outlet_ws.max_row + 1)):
            # Column A: äº§å“åç§° (Description)
            product_cell = outlet_ws.cell(row=row, column=1)
            
            # åªå¾Låˆ—è®€å–æ•¸é‡
            quantity_cell = outlet_ws.cell(row=row, column=12)  # Låˆ—: Final Order QTY

            # å¦‚æœæœ‰ç”¢å“åç¨±
            if product_cell.value and str(product_cell.value).strip():
                product_name = str(product_cell.value).strip()
                
                # è·³éæ¨™é¡Œè¡Œ
                if product_name.lower() in ['description', 'outlet', 'product name', 'å“å']:
                    continue
                    
                found_products += 1
                final_quantity = 0

                # åªå¾Låˆ—è®€å–æ•¸é‡
                if quantity_cell.value is not None:
                    try:
                        # å˜—è©¦ç›´æ¥è®€å–æ•¸å€¼
                        quantity = float(quantity_cell.value)
                        if quantity > 0:
                            final_quantity = quantity
                    except (ValueError, TypeError):
                        # å¦‚æœæ˜¯å…¬å¼æˆ–æ–‡å­—ï¼Œè·³é
                        pass

                # å¦‚æœæ‰¾åˆ°æœ‰æ•ˆæ•¸é‡ï¼Œæ·»åŠ åˆ°è¨‚å–®
                if final_quantity > 0:
                    orders[product_name] = final_quantity
                    valid_orders += 1
                    print(f"âœ… ç”¢å“: {product_name}, æ•¸é‡: {final_quantity} (å¾Låˆ—)")
                elif product_name:  # å³ä½¿æ²’æœ‰æ•¸é‡ä¹Ÿè¨˜éŒ„ç”¢å“ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
                    print(f"âš ï¸ ç”¢å“: {product_name}, Låˆ—æ•¸é‡ç‚º0æˆ–ç„¡æ•ˆ")

        return orders, found_products, valid_orders

    def _copy_template_fully(self, source_ws, target_ws):
        """å®Œæ•´å¤åˆ¶æ¨¡æ¿ï¼ŒåŒ…æ‹¬æ ¼å¼ã€å…¬å¼ç­‰"""
        from copy import copy

        # å¤åˆ¶æ‰€æœ‰å•å…ƒæ ¼å†…å®¹ã€æ ¼å¼å’Œå…¬å¼
        for row in source_ws.iter_rows():
            for cell in row:
                target_cell = target_ws.cell(row=cell.row, column=cell.column)

                # å¤åˆ¶å€¼æˆ–å…¬å¼
                if cell.data_type == 'f':  # å…¬å¼
                    if hasattr(cell, 'formula') and cell.formula:
                        target_cell.value = f"={cell.formula}"
                    elif hasattr(cell, '_formula') and cell._formula:
                        target_cell.value = f"={cell._formula}"
                    else:
                        target_cell.value = cell.value
                else:
                    target_cell.value = cell.value

                # å¤åˆ¶æ ¼å¼
                if cell.has_style:
                    target_cell.font = copy(cell.font)
                    target_cell.border = copy(cell.border)
                    target_cell.fill = copy(cell.fill)
                    target_cell.number_format = cell.number_format
                    target_cell.protection = copy(cell.protection)
                    target_cell.alignment = copy(cell.alignment)

        # å¤åˆ¶è¡Œé«˜å’Œåˆ—å®½
        for row_num in range(1, source_ws.max_row + 1):
            if source_ws.row_dimensions[row_num].height:
                target_ws.row_dimensions[row_num].height = source_ws.row_dimensions[row_num].height

        for col_letter in source_ws.column_dimensions:
            if source_ws.column_dimensions[col_letter].width:
                target_ws.column_dimensions[col_letter].width = source_ws.column_dimensions[col_letter].width

        # å¤åˆ¶åˆå¹¶å•å…ƒæ ¼
        for merged_range in source_ws.merged_cells.ranges:
            target_ws.merge_cells(str(merged_range))

        # å¤åˆ¶æ¡ä»¶æ ¼å¼
        if hasattr(source_ws, 'conditional_formatting') and hasattr(source_ws.conditional_formatting, '_cf_rules'):
            for sqref, rules in source_ws.conditional_formatting._cf_rules.items():
                if isinstance(rules, list):
                    for rule in rules:
                        target_ws.conditional_formatting.add(sqref, rule)
                else:
                    target_ws.conditional_formatting.add(sqref, rules)

        # å¤åˆ¶å†»ç»“çª—æ ¼ - ä¿®æ­£ç‚ºæ­£ç¢ºçš„ä½ç½®
        if source_ws.freeze_panes:
            # å°æ–¼ Fresheningï¼Œå›ºå®šåœ¨ç¬¬11è¡Œ
            if source_ws.title == 'Freshening':
                target_ws.freeze_panes = 'A11'
            else:
                target_ws.freeze_panes = source_ws.freeze_panes

    def _update_outlet_info(self, worksheet, outlet_sheet_name, supplier, log_callback=None):
        """æ›´æ–°é—¨å¸‚ä¿¡æ¯"""
        try:
            # æ·»åŠ ç»ˆç«¯è¾“å‡º
            print(f"\nğŸ” æŸ¥æ‰¾é–€å¸‚é…ç½®: {outlet_sheet_name}")
            print(f"ğŸ“‹ å¯ç”¨é–€å¸‚é…ç½®é”®: {list(self.outlet_data.keys())}")
            
            if log_callback:
                log_callback(f"    ğŸ” æŸ¥æ‰¾é–€å¸‚é…ç½®: {outlet_sheet_name}")
                log_callback(f"    ğŸ“‹ å¯ç”¨é–€å¸‚: {list(self.outlet_data.keys())}")
            
            if outlet_sheet_name in self.outlet_data:
                outlet_info = self.outlet_data[outlet_sheet_name]
                print(f"âœ… æ‰¾åˆ°é–€å¸‚é…ç½®: {outlet_sheet_name}")
                print(f"   é—¨å¸‚åç§°: {outlet_info['outlet_name']}")
                print(f"   åœ°å€: {outlet_info['address']}")
                print(f"   é€è´§æ—¥æœŸ: {outlet_info['delivery_date']}")

                # æ ¹æ“šä¾›æ‡‰å•†è¨­ç½®ä¸åŒçš„æ¨™é¡Œ
                if supplier == 'Freshening':
                    worksheet.cell(row=1, column=1, value="FRESHENING INDUSTRIES PTE LTD")
                    print(f"ğŸ“ è®¾ç½®å…¬å¸æ ‡é¢˜: è¡Œ1åˆ—1 = FRESHENING INDUSTRIES PTE LTD")
                elif supplier == 'Legacy':
                    worksheet.cell(row=1, column=1, value="LEGACY OFFICE")
                    print(f"ğŸ“ è®¾ç½®å…¬å¸æ ‡é¢˜: è¡Œ1åˆ—1 = LEGACY OFFICE")
                elif supplier == 'Unikleen':
                    worksheet.cell(row=1, column=1, value="UNIKLEEN INDUSTRIES PTE LTD")
                    print(f"ğŸ“ è®¾ç½®å…¬å¸æ ‡é¢˜: è¡Œ1åˆ—1 = UNIKLEEN INDUSTRIES PTE LTD")

                # æ›´æ–°é—¨å¸‚åç§°ï¼ˆF5ä½ç½®ï¼‰
                worksheet.cell(row=5, column=6).value = outlet_info['outlet_name']
                print(f"ğŸ“ è®¾ç½®é—¨å¸‚åç§°: è¡Œ5åˆ—6 = {outlet_info['outlet_name']}")

                # æ›´æ–°é—¨å¸‚åœ°å€ï¼ˆF6ä½ç½®ï¼‰
                worksheet.cell(row=6, column=6).value = outlet_info['address']
                print(f"ğŸ“ è®¾ç½®é—¨å¸‚åœ°å€: è¡Œ6åˆ—6 = {outlet_info['address']}")

                # F7 ä¿æŒç©ºç™½ - ä¸å¡«ä»»ä½•å…§å®¹

                # F8 åªå° Freshening å¡«å…¥é€è²¨æ—¥æœŸ
                if supplier == 'Freshening':
                    # è¨ˆç®—ä¸‹é€±çš„å¯¦éš›é€è²¨æ—¥æœŸ
                    delivery_day = outlet_info['delivery_date'].strip().upper()
                    actual_date = self._get_next_delivery_date(delivery_day)
                    worksheet.cell(row=8, column=6).value = actual_date
                    print(f"ğŸ“ è®¾ç½®é€è´§æ—¥æœŸ: è¡Œ8åˆ—6 = {actual_date} (åŸå§‹: {delivery_day})")

                # ä¿®æ­£æ—¥æœŸè¡Œä½ç½®
                if supplier == 'Freshening':
                    date_row = 11  # Freshening çš„æ—¥æœŸåœ¨ç¬¬12è¡Œ
                elif supplier == 'Legacy':
                    date_row = 11  # Legacy çš„æ—¥æœŸåœ¨ç¬¬12è¡Œ
                elif supplier == 'Unikleen':
                    date_row = 11  # Unikleen çš„æ—¥æœŸåœ¨ç¬¬12è¡Œ
                else:
                    date_row = 11  # é»˜è®¤ç¬¬12è¡Œ

                # æ›´æ–°æ—¥æœŸè¡Œ
                print(f"ğŸ“… æ­£åœ¨æ›´æ–°æ—¥æœŸè¡Œï¼Œä¾›åº”å•†: {supplier}")
                
                if supplier == 'Legacy':
                    # Legacy æ¨¡æ¿ï¼šä¸ä¿®æ”¹æ—¥æœŸï¼Œä¿æŒåŸå§‹æ—¥æœŸï¼Œè·ŸUnikleenä¸€æ¨£
                    print(f"ğŸ“… Legacy æ¨¡æ¿ï¼šè·³éæ—¥æœŸæ›´æ–°ï¼Œä¿æŒåŸå§‹æ—¥æœŸ")
                    # ä¸é€²è¡Œä»»ä½•æ—¥æœŸä¿®æ”¹
                        
                elif supplier == 'Unikleen':
                    # Unikleen æ¨¡æ¿ï¼šä¸ä¿®æ”¹æ—¥æœŸï¼Œä¿æŒåŸå§‹æ—¥æœŸ
                    print(f"ğŸ“… Unikleen æ¨¡æ¿ï¼šè·³éæ—¥æœŸæ›´æ–°ï¼Œä¿æŒåŸå§‹æ—¥æœŸ")
                    # ä¸é€²è¡Œä»»ä½•æ—¥æœŸä¿®æ”¹
                        
                else:
                    # Freshening å’Œå…¶ä»–ä¾›åº”å•†ï¼šåªæ›´æ–°ä¸€ä¸ªæ—¥æœŸè¡Œ
                    print(f"ğŸ“… æ›´æ–°æ—¥æœŸè¡Œ {date_row}")
                    days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                    for i, day in enumerate(days):
                        col = 6 + i  # Fåˆ—å¼€å§‹
                        date_value = self._get_next_week_date(i)
                        worksheet.cell(row=date_row, column=col).value = date_value
                        print(f"   {day}: åˆ— {chr(64 + col)} (è¡Œ {date_row}) = {date_value}")
                        print(f"ğŸ“ è®¾ç½®æ—¥æœŸ: è¡Œ{date_row}åˆ—{col} = {date_value}")

                if log_callback:
                    log_callback(f"    âœ… æ›´æ–°é–€å¸‚ä¿¡æ¯: {outlet_sheet_name}")
            else:
                print(f"âŒ æ‰¾ä¸åˆ°é–€å¸‚é…ç½®: {outlet_sheet_name}")
                # å°è¯•æ¨¡ç³ŠåŒ¹é…
                for key in self.outlet_data.keys():
                    if outlet_sheet_name.lower() in key.lower() or key.lower() in outlet_sheet_name.lower():
                        print(f"   å¯èƒ½çš„åŒ¹é…: {key}")
                
                if log_callback:
                    log_callback(f"    âš ï¸ æ‰¾ä¸åˆ°é–€å¸‚é…ç½®: {outlet_sheet_name}")

        except Exception as e:
            if log_callback:
                log_callback(f"    âŒ æ›´æ–°é–€å¸‚ä¿¡æ¯å¤±æ•—: {str(e)}")

    def _get_next_week_date(self, day_offset):
        """ç²å–ä¸‹é€±çš„æ—¥æœŸ"""
        today = datetime.now()
        # è®¡ç®—ä¸‹å‘¨ä¸€ï¼šå¦‚æœä»Šå¤©æ˜¯å‘¨ä¸€ï¼Œåˆ™ä¸‹å‘¨ä¸€å°±æ˜¯ä»Šå¤©+7å¤©ï¼›å¦åˆ™è®¡ç®—åˆ°ä¸‹å‘¨ä¸€çš„è·ç¦»
        days_until_monday = (7 - today.weekday()) % 7
        if days_until_monday == 0:  # ä»Šå¤©æ˜¯å‘¨ä¸€
            next_monday = today + timedelta(days=7)
        else:
            next_monday = today + timedelta(days=days_until_monday)
        
        target_date = next_monday + timedelta(days=day_offset)
        
        # æ·»åŠ è¯¦ç»†çš„ç»ˆç«¯è¾“å‡º
        print(f"ğŸ“… æ—¥æœŸè®¡ç®—: ä»Šå¤©={today.strftime('%Y-%m-%d')}, ä¸‹å‘¨ä¸€={next_monday.strftime('%Y-%m-%d')}, åç§»={day_offset}å¤©, ç›®æ ‡æ—¥æœŸ={target_date}")
        
        if hasattr(self, 'log_callback') and self.log_callback:
            self.log_callback(f"    ğŸ“… è®¡ç®—æ—¥æœŸ: ä»Šå¤©={today.strftime('%Y-%m-%d')}, ä¸‹å‘¨ä¸€={next_monday.strftime('%Y-%m-%d')}, ç›®æ ‡æ—¥æœŸ={target_date}")
        return target_date.strftime('%d-%b')  # ä¾‹å¦‚: "01-Sep"

    def _get_next_delivery_date(self, delivery_day):
        """æ ¹æ“šé€è²¨æ—¥æœŸè¨ˆç®—ä¸‹é€±çš„å¯¦éš›æ—¥æœŸ"""
        try:
            # è¨ˆç®—ä¸‹é€±çš„æ—¥æœŸ
            today = datetime.now()
            # è®¡ç®—ä¸‹å‘¨ä¸€ï¼šå¦‚æœä»Šå¤©æ˜¯å‘¨ä¸€ï¼Œåˆ™ä¸‹å‘¨ä¸€å°±æ˜¯ä»Šå¤©+7å¤©ï¼›å¦åˆ™è®¡ç®—åˆ°ä¸‹å‘¨ä¸€çš„è·ç¦»
            days_until_monday = (7 - today.weekday()) % 7
            if days_until_monday == 0:  # ä»Šå¤©æ˜¯å‘¨ä¸€
                next_monday = today + timedelta(days=7)
            else:
                next_monday = today + timedelta(days=days_until_monday)
            
            # æ—¥æœŸæ˜ å°„
            day_mapping = {
                'MON': 0, 'MONDAY': 0,
                'TUE': 1, 'TUESDAY': 1,
                'WED': 2, 'WEDNESDAY': 2,
                'THU': 3, 'THURSDAY': 3,
                'FRI': 4, 'FRIDAY': 4,
                'SAT': 5, 'SATURDAY': 5,
                'SUN': 6, 'SUNDAY': 6
            }
            
            # è™•ç†å¤šå€‹é€è²¨æ—¥æœŸï¼Œå–ç¬¬ä¸€å€‹
            for day_str in delivery_day.split('/'):
                day_str = day_str.strip().upper()
                if day_str in day_mapping:
                    days_to_add = day_mapping[day_str]
                    delivery_date = next_monday + timedelta(days=days_to_add)
                    return delivery_date.strftime('%d-%b')  # ä¾‹å¦‚: "01-Sep"
            
            # é»˜èªä¸‹é€±ä¸€
            return next_monday.strftime('%d-%b')
                
        except Exception as e:
            # å¦‚æœå‡ºéŒ¯ï¼Œè¿”å›ä¸‹é€±ä¸€
            today = datetime.now()
            days_until_monday = (7 - today.weekday()) % 7
            if days_until_monday == 0:  # ä»Šå¤©æ˜¯å‘¨ä¸€
                next_monday = today + timedelta(days=7)
            else:
                next_monday = today + timedelta(days=days_until_monday)
            return next_monday.strftime('%d-%b')

    def _update_dates(self, worksheet, log_callback=None):
        """æ›´æ–°æ—¥æœŸä¸ºä¸‹ä¸€å‘¨ - åªæ›´æ–°ç¬¬10è¡Œçš„æ—¥æœŸ (å·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨)"""
        # æ­¤æ–¹æ³•å·²è¢«åºŸå¼ƒï¼Œæ—¥æœŸæ›´æ–°ç°åœ¨åœ¨ _update_outlet_info ä¸­å¤„ç†
        # ä¿ç•™æ­¤æ–¹æ³•ä»¥é¿å…ç ´åå…¶ä»–å¯èƒ½è°ƒç”¨å®ƒçš„ä»£ç 
        pass

    def _fill_orders(self, worksheet, orders, supplier, outlet_sheet_name, log_callback=None):
        """å¡«å…¥è®¢å•æ•°é‡ - ç®€åŒ–ç‰ˆæœ¬"""
        if not orders:
            return 0

        # æ ¹æ®é€è´§æ—¥æœŸè·å–ç›®æ ‡åˆ—
        print(f"\nğŸ¯ å¼€å§‹è®¡ç®—ç›®æ ‡åˆ—...")
        print(f"ğŸ¯ é—¨å¸‚: {outlet_sheet_name}, ä¾›åº”å•†: {supplier}")
        target_column = self._get_target_column(outlet_sheet_name, supplier)
        print(f"ğŸ¯ æœ€ç»ˆç›®æ ‡åˆ—: {chr(64 + target_column)} (åˆ— {target_column})")

        if log_callback:
            col_letter = chr(64 + target_column)
            log_callback(f"    ğŸ“ å¡«å…¥åˆ° Column {col_letter}")

        # æ™ºèƒ½äº§å“åŒ¹é…é€»è¾‘ - å…ˆå»ºç«‹æ¨¡æ¿äº§å“æ˜ å°„ï¼Œå†ç²¾ç¡®åŒ¹é…
        print(f"ğŸ” å¼€å§‹å¡«å†™è®¢å•ï¼Œä½¿ç”¨æ™ºèƒ½åŒ¹é…é€»è¾‘")
        
        # å¡«å…¥è®¢å•æ•°é‡
        filled_count = 0
        if log_callback:
            log_callback(f"    ğŸ” å¼€å§‹åŒ¹é…äº§å“ï¼Œä½¿ç”¨æ™ºèƒ½åŒ¹é…é€»è¾‘")
        
        # è·å–æ‰€æœ‰è®¢å•äº§å“
        order_products = list(orders.keys())
        print(f"ğŸ“‹ è®¢å•äº§å“åˆ—è¡¨: {order_products}")
        
        # ç¬¬ä¸€æ­¥ï¼šå»ºç«‹æ¨¡æ¿äº§å“è¡Œæ˜ å°„ï¼ˆä»ç¬¬12è¡Œå¼€å§‹ï¼Œé™åˆ¶æ‰«æèŒƒå›´ï¼‰
        template_products = {}
        print(f"\nğŸ” å¼€å§‹æ‰«ææ¨¡æ¿äº§å“è¡Œ...")
        
        # æ ¹æ®ä¾›åº”å•†è®¾ç½®ä¸åŒçš„æ‰«æç­–ç•¥
        if supplier == 'Legacy':
            # Legacy æ¨¡æ¿ï¼šåªæƒæç¬¬ä¸€å€‹é€±æœŸçš„ç”¢å“ï¼ˆè¡Œ11-13ï¼‰ï¼Œè·ŸUnikleenä¸€æ¨£
            start_row = 11
            max_scan_row = min(13, worksheet.max_row)
            print(f"ğŸ” Legacy ä¾›åº”å•†: æ‰«æèŒƒå›´: è¡Œ{start_row}åˆ°è¡Œ{max_scan_row}")
            print(f"ğŸ” Legacy æ¨¡æ¿ç»“æ„: åªæƒæç¬¬ä¸€å€‹é€±æœŸçš„ç”¢å“ï¼ˆè¡Œ11-13ï¼‰")
        elif supplier == 'Unikleen':
            # Unikleen æ¨¡æ¿ï¼šäº§å“åœ¨è¡Œ11, 37ç­‰ï¼ˆæ¯å‘¨è¡¨æ ¼çš„ç¬¬1è¡Œäº§å“ï¼‰
            start_row = 11
            max_scan_row = min(50, worksheet.max_row)
            print(f"ğŸ” Unikleen ä¾›åº”å•†: æ‰«æèŒƒå›´: è¡Œ{start_row}åˆ°è¡Œ{max_scan_row}")
            print(f"ğŸ” Unikleen æ¨¡æ¿ç»“æ„: äº§å“åœ¨è¡Œ11, 37ç­‰ï¼ˆæ¯å‘¨è¡¨æ ¼çš„ç¬¬1è¡Œäº§å“ï¼‰")
        else:
            # Freshening å’Œå…¶ä»–ä¾›åº”å•†ï¼šä»ç¬¬12è¡Œå¼€å§‹
            start_row = 12
            max_scan_row = min(50, worksheet.max_row)
            print(f"ğŸ” {supplier} ä¾›åº”å•†: æ‰«æèŒƒå›´: è¡Œ{start_row}åˆ°è¡Œ{max_scan_row}")
        
        # æ˜¾ç¤ºæ‰€æœ‰æ‰«æåˆ°çš„è¡Œå†…å®¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        print(f"ğŸ” æ‰«æåˆ°çš„æ‰€æœ‰è¡Œå†…å®¹:")
        for row in range(start_row, max_scan_row + 1):
            product_cell = worksheet.cell(row=row, column=2)  # Column B
            if product_cell.value:
                product_name = str(product_cell.value).strip()
                print(f"   è¡Œ{row}: '{product_name}'")
        
        print(f"ğŸ” å¼€å§‹å¤„ç†äº§å“è¡Œ...")
        for row in range(start_row, max_scan_row + 1):
            product_cell = worksheet.cell(row=row, column=2)  # Column B
            if product_cell.value:
                product_name = str(product_cell.value).strip()
                
                # è·³è¿‡æ ‡é¢˜è¡Œå’Œå…¬å¸ä¿¡æ¯
                skip_words = ['description', 'outlet', 'address', 'order', 'delivery', 'freshening', 'industries', 'pte', 'ltd', 'singapore', 'tel', 'fax', 'requesitioner', 'admin', 'moq', 'pkt']
                skip_reason = None
                for skip_word in skip_words:
                    if skip_word in product_name.lower():
                        skip_reason = skip_word
                        break

                if skip_reason:
                    print(f"â­ï¸ è·³è¿‡è¡Œ{row}: {product_name} (åŸå› : åŒ…å« '{skip_reason}')")
                    continue
                
                # æ£€æŸ¥æ˜¯å¦åˆ°è¾¾äº§å“åˆ—è¡¨çš„ç»“æŸï¼ˆé€šå¸¸æ˜¯ç©ºè¡Œæˆ–ç‰¹æ®Šæ ‡è®°ï¼‰
                if not product_name or product_name.lower() in ['remark', 'å‚™æ³¨', 'note', 'total', 'sum', 'subtotal']:
                    print(f"â­ï¸ åˆ°è¾¾äº§å“åˆ—è¡¨ç»“æŸï¼Œåœæ­¢æ‰«æ: è¡Œ{row}")
                    break
                
                # ç›´æ¥ä½¿ç”¨åŸå§‹ç”¢å“åç¨±é€²è¡ŒåŒ¹é…ï¼Œä¸é€²è¡Œéåº¦æ¸…ç†
                if len(product_name) > 2:  # ç¡®ä¿æ˜¯äº§å“è¡Œ
                    # ä¿å­˜åŸå§‹åç§°çš„æ˜ å°„
                    template_products[product_name.lower()] = row
                    print(f"âœ… æ¨¡æ¿äº§å“è¡Œ{row}: '{product_name}' -> è¡Œ{row}")
                    
                    # åŒæ™‚ä¿å­˜å»é™¤å¤šé¤˜ç©ºæ ¼çš„ç‰ˆæœ¬
                    clean_name = ' '.join(product_name.split())
                    if clean_name.lower() != product_name.lower():
                        template_products[clean_name.lower()] = row
                        print(f"âœ… æ¸…ç†ç‰ˆæœ¬è¡Œ{row}: '{clean_name}' -> è¡Œ{row}")
                    
                    # æ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯
                    print(f"ğŸ” è¡Œ{row}è¯¦ç»†ä¿¡æ¯:")
                    print(f"   Column B (äº§å“å): '{product_name}'")
                    print(f"   Column C (ä¸­æ–‡å): '{worksheet.cell(row=row, column=3).value}'")
                    print(f"   Column D (ä»·æ ¼): '{worksheet.cell(row=row, column=4).value}'")
                    print(f"   Column E (å•ä½): '{worksheet.cell(row=row, column=5).value}'")
        
        print(f"ğŸ“‹ æ¨¡æ¿äº§å“æ˜ å°„: {len(template_products)} ä¸ªäº§å“")
        for name, row in template_products.items():
            print(f"   {name} -> è¡Œ{row}")
        
        # ç¬¬äºŒæ­¥ï¼šä¸ºæ¯ä¸ªè®¢å•äº§å“æ‰¾åˆ°ç²¾ç¡®åŒ¹é…
        for product, quantity in orders.items():
            product_clean = product.lower().strip()
            print(f"ğŸ” åŒ¹é…äº§å“: '{product}' (æ¸…ç†å: '{product_clean}')")

            # ç›´æ¥æŸ¥æ‰¾ç²¾ç¡®åŒ¹é…
            matched_row = None
            
            # é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
            if product_clean in template_products:
                matched_row = template_products[product_clean]
                print(f"âœ… ç²¾ç¡®åŒ¹é…: '{product}' -> è¡Œ{matched_row}")
            else:
                # å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•åŒ…å«åŒ¹é…
                for template_name, row in template_products.items():
                    if product_clean in template_name or template_name in product_clean:
                        matched_row = row
                        print(f"âœ… åŒ…å«åŒ¹é…: '{product}' -> '{template_name}' (è¡Œ{row})")
                        break

            if matched_row:
                if log_callback:
                    log_callback(f"      âœ… åŒ¹é…æˆåŠŸ: '{product}' -> è¡Œ{matched_row}")
                
                try:
                    # è¯»å–äº§å“ä»·æ ¼ä¿¡æ¯
                    price_cell = worksheet.cell(row=matched_row, column=3)  # Column C (PRICE)
                    uom_cell = worksheet.cell(row=matched_row, column=4)   # Column D (UOM)
                    price = price_cell.value if price_cell.value else "N/A"
                    uom = uom_cell.value if uom_cell.value else "N/A"
                    
                    # æª¢æŸ¥æ˜¯å¦ç‚ºåˆä½µå–®å…ƒæ ¼
                    target_cell = worksheet.cell(row=matched_row, column=target_column)
                    
                    # æ·»åŠ è¯¦ç»†çš„ä½ç½®è¾“å‡º
                    col_letter = chr(64 + target_column)
                    print(f"ğŸ“ å‡†å¤‡å¡«å†™æ•°æ®: äº§å“='{product}', æ•°é‡={quantity}, ä»·æ ¼={price}, å•ä½={uom}")
                    print(f"ğŸ“ ç›®æ ‡ä½ç½®: è¡Œ{matched_row}åˆ—{target_column} ({col_letter}{matched_row})")
                    
                    if hasattr(target_cell, '_value'):
                        # é€™æ˜¯ä¸€å€‹åˆä½µå–®å…ƒæ ¼ï¼Œéœ€è¦æ‰¾åˆ°å¯¦éš›çš„å–®å…ƒæ ¼
                        for merged_range in worksheet.merged_cells.ranges:
                            if target_cell.coordinate in merged_range:
                                # æ‰¾åˆ°åˆä½µç¯„åœçš„å·¦ä¸Šè§’å–®å…ƒæ ¼
                                top_left = merged_range.start_cell
                                worksheet.cell(row=top_left.row, column=top_left.column).value = quantity
                                print(f"ğŸ“ åˆå¹¶å•å…ƒæ ¼ï¼Œå®é™…å¡«å†™ä½ç½®: è¡Œ{top_left.row}åˆ—{top_left.column} ({chr(64 + top_left.column)}{top_left.row})")
                                break
                        else:
                            # ä¸æ˜¯åˆä½µå–®å…ƒæ ¼ï¼Œç›´æ¥è¨­ç½®
                            target_cell.value = quantity
                            print(f"ğŸ“ ç›´æ¥å¡«å†™åˆ°: è¡Œ{matched_row}åˆ—{target_column} ({col_letter}{matched_row})")
                    else:
                        target_cell.value = quantity
                        print(f"ğŸ“ ç›´æ¥å¡«å†™åˆ°: è¡Œ{matched_row}åˆ—{target_column} ({col_letter}{matched_row})")
                    
                    filled_count += 1
                    if log_callback:
                        log_callback(f"      âœ… {product}: {quantity} (ä»·æ ¼: {price}, å•ä½: {uom})")

                except Exception as e:
                    print(f"âŒ å¡«å†™å¤±è´¥: {product}, é”™è¯¯: {str(e)}")
                    if log_callback:
                        log_callback(f"      âŒ å¡«å…¥å¤±æ•— {product}: {str(e)}")
            else:
                print(f"âš ï¸ æ‰¾ä¸åˆ°åŒ¹é…: {product}")
                if log_callback:
                    log_callback(f"      âš ï¸ æ‰¾ä¸åˆ°åŒ¹é…: {product}")

        if log_callback:
            log_callback(f"    ğŸ“Š æˆåŠŸå¡«å…¥ {filled_count}/{len(orders)} å€‹ç”¢å“")

        return filled_count

    def _get_target_column(self, outlet_sheet_name, supplier):
        """æ ¹æ®é€è´§æ—¥æœŸè·å–ç›®æ ‡åˆ—"""
        if supplier == 'Legacy':
            print(f"ğŸ¯ Legacy ä½¿ç”¨åˆ—: F (åˆ— 6)")
            return 6  # Fåˆ—ï¼ˆLegacy æ¨¡æ¿çš„æ—¥æœŸåˆ—ï¼Œèˆ‡Fresheningä¸€è‡´ï¼‰
        elif supplier == 'Unikleen':
            print(f"ğŸ¯ Unikleen ä½¿ç”¨åˆ—: J (åˆ— 10)")
            return 10  # Jåˆ—ï¼ˆUnikleen æ¨¡æ¿çš„æ—¥æœŸåˆ—ï¼‰
        elif supplier != 'Freshening':
            print(f"ğŸ¯ {supplier} ä½¿ç”¨é»˜è®¤åˆ—: F (åˆ— 6)")
            return 6  # é»˜è®¤Fåˆ—ï¼ˆä¸‹é€±ä¸€ï¼‰

        # æ·»åŠ ç»ˆç«¯è¾“å‡º
        print(f"\nğŸ¯ æŸ¥æ‰¾ç›®æ ‡åˆ—: {outlet_sheet_name}, ä¾›åº”å•†: {supplier}")
        print(f"ğŸ“‹ å¯ç”¨é—¨å¸‚é…ç½®: {list(self.outlet_data.keys())}")

        if outlet_sheet_name in self.outlet_data:
            delivery_date = self.outlet_data[outlet_sheet_name]['delivery_date']
            print(f"ğŸ“… é€è´§æ—¥æœŸ: {delivery_date}")

            # è§£æé€è´§æ—¥æœŸï¼Œä¾‹å¦‚ "MON", "TUE", "WED" ç­‰
            day_mapping = {
                'MON': 6, 'MONDAY': 6,    # Fåˆ—ï¼ˆä¸‹é€±ä¸€ï¼‰
                'TUE': 7, 'TUESDAY': 7,   # Gåˆ—ï¼ˆä¸‹é€±äºŒï¼‰
                'WED': 8, 'WEDNESDAY': 8, # Håˆ—ï¼ˆä¸‹é€±ä¸‰ï¼‰
                'THU': 9, 'THURSDAY': 9,  # Iåˆ—ï¼ˆä¸‹é€±å››ï¼‰
                'FRI': 10, 'FRIDAY': 10,  # Jåˆ—ï¼ˆä¸‹é€±äº”ï¼‰
                'SAT': 11, 'SATURDAY': 11, # Kåˆ—ï¼ˆä¸‹é€±å…­ï¼‰
                'SUN': 12, 'SUNDAY': 12   # Låˆ—ï¼ˆä¸‹é€±æ—¥ï¼‰
            }

            # å¤„ç†å¤šä¸ªé€è´§æ—¥æœŸï¼Œå–ç¬¬ä¸€ä¸ª
            for day_str in delivery_date.split('/'):
                day_str = day_str.strip().upper()
                if day_str in day_mapping:
                    target_col = day_mapping[day_str]
                    print(f"âœ… ç›®æ ‡åˆ—: {chr(64 + target_col)} (åˆ— {target_col})")
                    return target_col

        print(f"âš ï¸ ä½¿ç”¨é»˜è®¤åˆ—: F (åˆ— 6)")
        return 6  # é»˜è®¤Fåˆ—ï¼ˆä¸‹é€±ä¸€ï¼‰

    def _fuzzy_match_product(self, product_name, template_product):
        """æ¨¡ç³ŠåŒ¹é…äº§å“åç§° - æ”¹é€²ç‰ˆæœ¬"""
        if not product_name or not template_product:
            return False

        # è·³è¿‡æ ‡é¢˜è¡Œå’Œå…¬å¸ä¿¡æ¯
        skip_words = ['description', 'outlet', 'address', 'order', 'delivery', 'freshening', 'industries', 'pte', 'ltd', 'singapore', 'tel', 'fax', 'requesitioner', 'ops', 'admin']
        if any(skip_word in str(template_product).lower() for skip_word in skip_words):
            return False

        # æ¸…ç†äº§å“åç§°ï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦
        import re
        name1 = re.sub(r'[^\w\s]', ' ', str(product_name).lower().strip())
        name2 = re.sub(r'[^\w\s]', ' ', str(template_product).lower().strip())
        
        # ç§»é™¤å¤šé¤˜ç©ºæ ¼
        name1 = ' '.join(name1.split())
        name2 = ' '.join(name2.split())

        # 1. ç²¾ç¡®åŒ¹é…
        if name1 == name2:
            return True

        # 2. åŒ…å«åŒ¹é…ï¼ˆæ›´ä¸¥æ ¼ï¼‰
        if len(name1) > 3 and len(name2) > 3:  # ç¡®ä¿åç§°è¶³å¤Ÿé•¿
            if name1 in name2 or name2 in name1:
                return True

        # 3. é—œéµè©åŒ¹é… - æª¢æŸ¥ä¸»è¦é—œéµè©
        keywords1 = [w for w in name1.split() if len(w) > 3]  # å¿½ç•¥çŸ­è©
        keywords2 = [w for w in name2.split() if len(w) > 3]
        
        if keywords1 and keywords2:
            # æª¢æŸ¥æ˜¯å¦æœ‰é—œéµè©åŒ¹é…
            for k1 in keywords1:
                for k2 in keywords2:
                    if k1 in k2 or k2 in k1:
                        return True

        # 4. è¯æ±‡åŒ¹é… - æé«˜é–¾å€¼
        words1 = set(name1.split())
        words2 = set(name2.split())

        if not words1 or not words2:
            return False

        # è®¡ç®—äº¤é›†æ¯”ä¾‹
        intersection = words1.intersection(words2)
        union = words1.union(words2)

        if len(union) == 0:
            return False

        # æé«˜ Jaccard ç›¸ä¼¼åº¦é–¾å€¼
        similarity = len(intersection) / len(union)
        return similarity >= 0.5  # å¾ 0.3 æé«˜åˆ° 0.5

    def _show_operation_supplies_results(self, results):
        """é¡¯ç¤ºç‡Ÿé‹ç”¨å“è™•ç†çµæœçš„è¡¨æ ¼çª—å£ - é–€å¸‚åº•ä¸‹é¡¯ç¤ºç”¢å“æ•¸é‡"""
        try:
            import tkinter as tk
            from tkinter import ttk
            import customtkinter as ctk
            
            # å‰µå»ºçª—å£
            window = ctk.CTkToplevel()
            window.title("ç‡Ÿé‹ç”¨å“è™•ç†çµæœ Summary / Operation Supplies Results Summary")
            window.geometry("1000x700")
            window.configure(fg_color=DARK_BG)
            
            # å±…ä¸­é¡¯ç¤º
            window.update_idletasks()
            x = (window.winfo_screenwidth() // 2) - (1000 // 2)
            y = (window.winfo_screenheight() // 2) - (700 // 2)
            window.geometry(f"1000x700+{x}+{y}")
            
            # ä¸»å®¹å™¨
            main_frame = ctk.CTkFrame(window, fg_color="transparent")
            main_frame.pack(fill="both", expand=True, padx=20, pady=20)
            
            # æ¨™é¡Œ
            title_label = ctk.CTkLabel(
                main_frame,
                text="ğŸ“Š ç‡Ÿé‹ç”¨å“è™•ç†çµæœ Summary\nğŸ“Š Operation Supplies Results Summary",
                font=("Microsoft JhengHei", 18, "bold"),
                text_color=ACCENT_BLUE
            )
            title_label.pack(pady=(0, 20))
            
            # çµ±è¨ˆä¿¡æ¯
            total_suppliers = len(results)
            total_outlets = sum(data['outlet_count'] for data in results.values())
            total_products = 0
            total_matched = 0
            
            for data in results.values():
                for outlet_data in data['outlets'].values():
                    total_products += len(outlet_data['products'])
                    total_matched += outlet_data['filled_count']
            
            match_rate = (total_matched / total_products * 100) if total_products > 0 else 0
            
            stats_frame = ctk.CTkFrame(main_frame, fg_color=DARK_PANEL, corner_radius=12)
            stats_frame.pack(fill="x", pady=(0, 20))
            
            stats_text = f"ğŸ“ˆ ç¸½è¨ˆ: {total_suppliers} å€‹ä¾›æ‡‰å•†, {total_outlets} å€‹é–€å¸‚\nç¸½ç”¢å“æ•¸: {total_products}, æˆåŠŸåŒ¹é…: {total_matched} (åŒ¹é…ç‡: {match_rate:.1f}%)"
            stats_label = ctk.CTkLabel(
                stats_frame,
                text=stats_text,
                font=("Microsoft JhengHei", 14, "bold"),
                text_color=TEXT_COLOR
            )
            stats_label.pack(pady=15)
            
            # Treeview å®¹å™¨
            tree_frame = ctk.CTkFrame(main_frame, fg_color=DARK_PANEL, corner_radius=12)
            tree_frame.pack(fill="both", expand=True)
            
            # å‰µå»º Treeview
            tree = ttk.Treeview(tree_frame, columns=("supplier", "outlet", "products", "matched"), show="tree headings")
            tree.heading("#0", text="ä¾›æ‡‰å•†/é–€å¸‚/ç”¢å“")
            tree.heading("supplier", text="ä¾›æ‡‰å•†")
            tree.heading("outlet", text="é–€å¸‚")
            tree.heading("products", text="ç”¢å“æ•¸é‡")
            tree.heading("matched", text="æˆåŠŸåŒ¹é…")
            
            # è¨­ç½®åˆ—å¯¬
            tree.column("#0", width=300, minwidth=250)
            tree.column("supplier", width=100, minwidth=80)
            tree.column("outlet", width=150, minwidth=120)
            tree.column("products", width=100, minwidth=80)
            tree.column("matched", width=100, minwidth=80)
            
            # æ»¾å‹•æ¢
            v_scrollbar = ttk.Scrollbar(tree_frame, orient="vertical", command=tree.yview)
            h_scrollbar = ttk.Scrollbar(tree_frame, orient="horizontal", command=tree.xview)
            tree.configure(yscrollcommand=v_scrollbar.set, xscrollcommand=h_scrollbar.set)
            
            # å¡«å……æ•¸æ“š
            for supplier, data in results.items():
                # ä¾›æ‡‰å•†ç¯€é»
                supplier_id = tree.insert("", "end", text=f"ğŸ­ {supplier}", 
                                       values=(supplier, "", f"{total_products} å€‹", f"{total_matched} å€‹"))
                
                # é–€å¸‚ç¯€é»
                for outlet_name, outlet_data in data['outlets'].items():
                    outlet_id = tree.insert(supplier_id, "end", text=f"ğŸª {outlet_name}", 
                                          values=("", outlet_name, 
                                                 f"{len(outlet_data['products'])} å€‹",
                                                 f"{outlet_data['filled_count']} å€‹"))
                    
                    # ç”¢å“ç¯€é»
                    for product in outlet_data['products']:
                        # è·å–å®é™…çš„äº§å“æ•°é‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤º0
                        product_qty = outlet_data.get('product_quantities', {}).get(product, 0)
                        tree.insert(outlet_id, "end", text=f"ğŸ“¦ {product}", 
                                  values=("", "", f"{product_qty}", f"{product_qty}" if product_qty > 0 else "0"))
            
            # ä½ˆå±€è¡¨æ ¼å’Œæ»¾å‹•æ¢
            tree.grid(row=0, column=0, sticky="nsew", padx=10, pady=10)
            v_scrollbar.grid(row=0, column=1, sticky="ns", pady=10)
            h_scrollbar.grid(row=1, column=0, sticky="ew", padx=10)
            
            # é…ç½® grid weights
            tree_frame.grid_rowconfigure(0, weight=1)
            tree_frame.grid_columnconfigure(0, weight=1)
            
            # èªªæ˜æ¨™ç±¤
            legend_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
            legend_frame.pack(pady=(10, 0))
            
            legend_label = ctk.CTkLabel(
                legend_frame,
                text="èªªæ˜: ğŸ­ = ä¾›æ‡‰å•†, ğŸª = é–€å¸‚, ğŸ“¦ = ç”¢å“",
                font=("Microsoft JhengHei", 10),
                text_color=TEXT_COLOR
            )
            legend_label.pack()
            
            # æŒ‰éˆ•å®¹å™¨
            btn_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
            btn_frame.pack(pady=(10, 0))
            
            # é—œé–‰æŒ‰éˆ•
            close_btn = ctk.CTkButton(
                btn_frame,
                text="é—œé–‰ / Close",
                command=window.destroy,
                fg_color=ACCENT_BLUE,
                hover_color=BTN_HOVER,
                font=("Microsoft JhengHei", 12, "bold"),
                width=120,
                height=35
            )
            close_btn.pack()
            
        except Exception as e:
            print(f"âŒ é¡¯ç¤ºçµæœçª—å£å¤±æ•—: {str(e)}")
            import traceback
            traceback.print_exc()
            # å¦‚æœ treeview å¤±æ•—ï¼Œè‡³å°‘é¡¯ç¤ºåŸºæœ¬çµ±è¨ˆ
            print(f"ğŸ“Š è™•ç†å®Œæˆ: {len(results)} å€‹ä¾›æ‡‰å•†")
            for supplier, data in results.items():
                print(f"  {supplier}: {data['outlet_count']} å€‹é–€å¸‚")

class F5FixAndDeductWithFileWindow(ctk.CTkToplevel):
    """F5 ä¿®æ­£å’Œè‡ªå‹•æ‰£åˆ†çª—å£ï¼ˆåŒ…å«æ–‡ä»¶é¸æ“‡ï¼‰"""

    def __init__(self, parent, mismatch_records):
        super().__init__(parent)
        self.title("F5 ä¿®æ­£å’Œè‡ªå‹•æ‰£åˆ† / F5 Fix & Auto Deduction")
        self.geometry("1000x800")  # å¢åŠ é«˜åº¦å¾ 700 åˆ° 800
        self.minsize(900, 700)  # è¨­ç½®æœ€å°å¤§å°
        self.resizable(True, True)  # å…è¨±ç”¨æˆ¶èª¿æ•´å¤§å°
        self.transient(parent)
        self.grab_set()
        self.configure(fg_color=DARK_BG)
        self.parent = parent
        self.mismatch_records = mismatch_records

        # å±…ä¸­é¡¯ç¤º
        self.center_window()

        # ä¸»å®¹å™¨
        main_frame = ctk.CTkFrame(self, fg_color="transparent")
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
            main_frame,
            text="ğŸ”§ F5 ä¿®æ­£å’Œè‡ªå‹•æ‰£åˆ†å·¥å…·\nğŸ”§ F5 Fix & Auto Deduction Tool",
            font=("Microsoft JhengHei", 18, "bold"),
            text_color=ACCENT_BLUE
        )
        title_label.pack(pady=(0, 20))

        # èªªæ˜
        info_label = ctk.CTkLabel(
            main_frame,
            text=f"ç™¼ç¾ {
    len(mismatch_records)} å€‹ mismatch éŒ¯èª¤\nå°‡è‡ªå‹•ä¿®æ­£ F5 ä¸¦ç‚ºç›¸é—œé–€å¸‚æ‰£åˆ†\nFound {
        len(mismatch_records)} mismatch errors\nWill auto-fix F5 and deduct points for related outlets",
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR
        )
        info_label.pack(pady=(0, 20))

        # æ–‡ä»¶é¸æ“‡å€åŸŸ
        file_frame = ctk.CTkFrame(
    main_frame,
    fg_color=DARK_PANEL,
     corner_radius=12)
        file_frame.pack(fill="x", pady=(0, 20))

        ctk.CTkLabel(
            file_frame,
            text="é¸æ“‡æ‰£åˆ†æ–‡ä»¶ / Select Deduction File: *å¿…å¡«",
            font=("Microsoft JhengHei", 14, "bold"),
            text_color=ACCENT_RED
        ).pack(anchor="w", padx=15, pady=(15, 5))

        # æ–‡ä»¶è·¯å¾‘è¼¸å…¥
        file_input_frame = ctk.CTkFrame(file_frame, fg_color="transparent")
        file_input_frame.pack(fill="x", padx=15, pady=(0, 15))

        self.file_path_var = ctk.StringVar()
        self.file_path_entry = ctk.CTkEntry(
            file_input_frame,
            textvariable=self.file_path_var,
            font=("Microsoft JhengHei", 12),
            height=35,
            placeholder_text="é¸æ“‡æ‰£åˆ†æ–‡ä»¶è·¯å¾‘..."
        )
        self.file_path_entry.pack(
    side="left",
    fill="x",
    expand=True,
    padx=(
        0,
         10))

        browse_btn = ctk.CTkButton(
            file_input_frame,
            text="ç€è¦½ / Browse",
            command=self._browse_file,
            fg_color=ACCENT_BLUE,
            hover_color=BTN_HOVER,
            font=("Microsoft JhengHei", 12, "bold"),
            width=100,
            height=35
        )
        browse_btn.pack(side="right")

        # æ‰£åˆ†äººå“¡è¼¸å…¥å€åŸŸ
        deductor_frame = ctk.CTkFrame(
    main_frame, fg_color=DARK_PANEL, corner_radius=12)
        deductor_frame.pack(fill="x", pady=(0, 20))

        ctk.CTkLabel(
            deductor_frame,
            text="æ‰£åˆ†äººå“¡ / Deducted By: *å¿…å¡«",
            font=("Microsoft JhengHei", 14, "bold"),
            text_color=ACCENT_RED
        ).pack(anchor="w", padx=15, pady=(15, 5))

        self.deducted_by_var = ctk.StringVar()
        self.deducted_by_entry = ctk.CTkEntry(
            deductor_frame,
            textvariable=self.deducted_by_var,
            font=("Microsoft JhengHei", 12),
            height=35,
            placeholder_text="è«‹è¼¸å…¥æ‰£åˆ†äººå“¡å§“å..."
        )
        self.deducted_by_entry.pack(fill="x", padx=15, pady=(0, 15))

        # Mismatch è¨˜éŒ„é¡¯ç¤º
        records_frame = ctk.CTkFrame(
    main_frame, fg_color=DARK_PANEL, corner_radius=12)
        records_frame.pack(fill="both", expand=True, pady=(0, 20))

        ctk.CTkLabel(
            records_frame,
            text="Mismatch è¨˜éŒ„ / Mismatch Records:",
            font=("Microsoft JhengHei", 14, "bold"),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(15, 5))

        # è¨˜éŒ„åˆ—è¡¨
        self.records_text = ctk.CTkTextbox(
            records_frame,
            wrap="word",
            font=("Consolas", 12),
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            corner_radius=8
        )
        self.records_text.pack(fill="both", expand=True, padx=15, pady=(0, 15))

        # é¡¯ç¤º mismatch è¨˜éŒ„
        self._display_mismatch_records()

        # æŒ‰éˆ•å€åŸŸ
        btn_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        btn_frame.pack(fill="x", pady=(10, 0))

        # é—œé–‰æŒ‰éˆ•
        close_btn = ctk.CTkButton(
            btn_frame,
            text="é—œé–‰ / Close",
            command=self.destroy,
            fg_color="#6b7280",
            hover_color="#4b5563",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=120,
            height=40
        )
        close_btn.pack(side="right", padx=(10, 0))

        # åŸ·è¡Œä¿®æ­£å’Œæ‰£åˆ†æŒ‰éˆ•
        fix_btn = ctk.CTkButton(
            btn_frame,
            text="åŸ·è¡Œä¿®æ­£å’Œæ‰£åˆ†\nFix & Deduct",
            command=self._start_fix_and_deduct,
            fg_color=ACCENT_GREEN,
            hover_color="#059669",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=180,
            height=40
        )
        fix_btn.pack(side="right", padx=(0, 10))

        # å¼·åˆ¶ç²å¾—ç„¦é»
        self.focus_force()

    def center_window(self):
        """å±…ä¸­é¡¯ç¤ºè¦–çª—"""
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f"{width}x{height}+{x}+{y}")

    def _browse_file(self):
        """ç€è¦½é¸æ“‡æ–‡ä»¶"""
        from tkinter import filedialog
        file_path = filedialog.askopenfilename(
            title="é¸æ“‡æ‰£åˆ†æ–‡ä»¶",
            filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")]
        )
        if file_path:
            self.file_path_var.set(file_path)

    def _display_mismatch_records(self):
        """é¡¯ç¤º mismatch è¨˜éŒ„"""
        content = "ğŸ” Mismatch éŒ¯èª¤è¨˜éŒ„ / Mismatch Error Records\n"
        content += "=" * 80 + "\n\n"

        for i, record in enumerate(self.mismatch_records, 1):
            content += f"{i}. ä¾›æ‡‰å•† / Supplier: {
    record.get(
        'supplier', 'N/A')}\n"
            content += f"   åˆ†åº— / Outlet: {record.get('outlet', 'N/A')}\n"
            content += f"   ç‹€æ…‹ / Status: {record.get('cover_status', 'N/A')}\n"
            content += f"   éŒ¯èª¤ / Error: {record.get('remark', 'N/A')}\n"
            content += "-" * 60 + "\n"

        content += "\nğŸ“‹ å°‡åŸ·è¡Œçš„æ“ä½œ / Operations to be performed:\n"
        content += "1. ä¿®æ­£ä¾›æ‡‰å•†æ–‡ä»¶ä¸­çš„ F5 å„²å­˜æ ¼ / Fix F5 cells in supplier files\n"
        content += "2. ç‚ºæ¯å€‹ mismatch é–€å¸‚è‡ªå‹•æ‰£åˆ† / Auto deduct points for each mismatch outlet\n"
        content += "3. æ‰£åˆ†æè¿°: Order Wrong Data (e.g. Wrong Date, Wrong Outlet Selected, etc.)\n"
        content += "4. æ‰£åˆ†è¨˜éŒ„å°‡ä¿å­˜åˆ°æ‚¨é¸æ“‡çš„æ–‡ä»¶ä¸­ / Deduction records will be saved to your selected file\n"

        self.records_text.delete("1.0", "end")
        self.records_text.insert("1.0", content)

    def _start_fix_and_deduct(self):
        """é–‹å§‹ä¿®æ­£ F5 ä¸¦è‡ªå‹•æ‰£åˆ†"""
        try:
            # æª¢æŸ¥å¿…å¡«æ¬„ä½
            deducted_by = self.deducted_by_var.get().strip()
            if not deducted_by:
                messagebox.showwarning("è­¦å‘Š", "è«‹è¼¸å…¥æ‰£åˆ†äººå“¡å§“åï¼")
                return

            file_path = self.file_path_var.get().strip()
            if not file_path:
                messagebox.showwarning("è­¦å‘Š", "è«‹é¸æ“‡æ‰£åˆ†æ–‡ä»¶ï¼")
                return

            # æª¢æŸ¥æ˜¯å¦æœ‰ Master Config
            if not hasattr(
    self.parent,
     'master_config_var') or not self.parent.master_config_var.get():
                messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡ Master Config æ–‡ä»¶ï¼")
                return

            # æª¢æŸ¥æ˜¯å¦æœ‰ checklist è³‡æ–™å¤¾
            if not hasattr(
    self.parent,
     'checklist_folder_var') or not self.parent.checklist_folder_var.get():
                messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡ Weekly Order è³‡æ–™å¤¾ï¼")
                return

            # é–‹å§‹ä¿®æ­£å’Œæ‰£åˆ†æµç¨‹
            self._perform_fix_and_deduct(deducted_by, file_path)

        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"åŸ·è¡Œä¿®æ­£å’Œæ‰£åˆ†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

    def _extract_sheet_name_from_remark(self, remark):
        """å¾ remark ä¸­æå– Sheet åç¨±"""
        try:
            # å°‹æ‰¾ "Sheetâ†’" æ¨¡å¼
            if "Sheetâ†’" in remark:
                # æ‰¾åˆ° "Sheetâ†’" çš„ä½ç½®
                sheet_start = remark.find("Sheetâ†’") + len("Sheetâ†’")
                # æ‰¾åˆ°ä¸‹ä¸€å€‹åˆ†éš”ç¬¦æˆ–çµå°¾
                sheet_end = len(remark)
                for delimiter in [";", ",", ")", "\n"]:
                    pos = remark.find(delimiter, sheet_start)
                    if pos != -1 and pos < sheet_end:
                        sheet_end = pos

                sheet_name = remark[sheet_start:sheet_end].strip()
                return sheet_name if sheet_name else None

            return None
        except Exception as e:
            print(f"è§£æ Sheet åç¨±æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return None

    def _should_deduct_points(self, remark):
        """åˆ¤æ–·æ˜¯å¦æ‡‰è©²æ‰£åˆ†"""
        try:
            # åªæœ‰åŒ…å« F5 éŒ¯èª¤çš„ mismatch æ‰éœ€è¦æ‰£åˆ†
            # é¿å…é‡è¤‡æ‰£åˆ†ï¼šç´” Sheet mismatch ä¸æ‰£åˆ†
            if "F5" in remark and ("F5 error" in remark or "F5â†’" in remark):
                return True
            return False
        except Exception as e:
            print(f"åˆ¤æ–·æ˜¯å¦æ‰£åˆ†æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return False

    def _perform_fix_and_deduct(self, deducted_by, deduction_file_path):
        """åŸ·è¡Œ F5 ä¿®æ­£å’Œè‡ªå‹•æ‰£åˆ†åˆ°æŒ‡å®šæ–‡ä»¶"""
        try:
            import openpyxl
            import os
            from datetime import datetime

            config_path = self.parent.master_config_var.get()
            folder_path = self.parent.checklist_folder_var.get()

            # è¼‰å…¥ Master Config
            config_manager = UnifiedConfigManager(config_path)

            fixed_count = 0
            deduct_count = 0
            skip_count = 0  # è·³éçš„é‡è¤‡è¨˜éŒ„æ•¸
            error_count = 0
            deduction_details = {}  # è¨˜éŒ„æ¯å€‹é–€å¸‚çš„æ‰£åˆ†è©³æƒ… {outlet: points}
            # è¨˜éŒ„ä¿®æ­£è©³æƒ… [{supplier, wrong_outlet, correct_outlet, file_path,
            # sheet_name}]
            fix_details = []

            # æ‰“é–‹ç”¨æˆ¶é¸æ“‡çš„æ‰£åˆ†æ–‡ä»¶
            if not os.path.exists(deduction_file_path):
                messagebox.showerror("éŒ¯èª¤", f"æ‰£åˆ†æ–‡ä»¶ä¸å­˜åœ¨ï¼š{deduction_file_path}")
                return

            wb_deduct = openpyxl.load_workbook(deduction_file_path)

            # è™•ç†æ¯å€‹ mismatch è¨˜éŒ„
            for record in self.mismatch_records:
                supplier = record.get('supplier', '')
                outlet = record.get('outlet', '')
                remark = record.get('remark', '')

                try:
                    # å¾ remark ä¸­æå–æ­£ç¢ºçš„é–€å¸‚ä»£ç¢¼
                    sheet_name = self._extract_sheet_name_from_remark(remark)
                    correct_outlet = sheet_name if sheet_name else outlet

                    # 1. ä¿®æ­£ F5 å’Œ G5 å„²å­˜æ ¼
                    # outlet = éŒ¯èª¤çš„é–€å¸‚ä»£ç¢¼ï¼ˆä¾†è‡ª F5ï¼‰
                    # correct_outlet = æ­£ç¢ºçš„é–€å¸‚ä»£ç¢¼ï¼ˆä¾†è‡ª Sheetâ†’ï¼‰
                    print(
    f"[DEBUG] æº–å‚™ä¿®æ­£: {supplier} - éŒ¯èª¤é–€å¸‚: {outlet}, æ­£ç¢ºé–€å¸‚: {correct_outlet}")
                    fix_result = self._fix_f5_cell(
    supplier, outlet, correct_outlet, folder_path, config_manager)
                    print(f"[DEBUG] ä¿®æ­£çµæœ: {fix_result}")
                    if fix_result:
                        fixed_count += 1
                        fix_details.append(fix_result)
                        print(
    f"[DEBUG] å·²æ·»åŠ ä¿®æ­£è¨˜éŒ„ï¼Œç•¶å‰ fix_details æ•¸é‡: {
        len(fix_details)}")

                    # 2. åˆ¤æ–·æ˜¯å¦éœ€è¦æ‰£åˆ†ï¼ˆåªæœ‰åŒ…å« F5 éŒ¯èª¤çš„æ‰æ‰£åˆ†ï¼‰
                    if self._should_deduct_points(remark):
                        # 3. è‡ªå‹•æ‰£åˆ†åˆ°ç”¨æˆ¶é¸æ“‡çš„æ–‡ä»¶ï¼ˆä½¿ç”¨æ­£ç¢ºçš„é–€å¸‚ä»£ç¢¼ï¼‰
                        deduct_result = self._add_deduction_to_file(
                            wb_deduct, supplier, correct_outlet, deducted_by, remark
                        )
                        if deduct_result is True:
                            # æˆåŠŸæ·»åŠ æ–°çš„æ‰£åˆ†è¨˜éŒ„
                            deduct_count += 1
                            # è¨˜éŒ„æ‰£åˆ†è©³æƒ…ï¼ˆæ¯æ¬¡æ‰£ 10 åˆ†ï¼‰
                            if correct_outlet in deduction_details:
                                deduction_details[correct_outlet] += 10
                            else:
                                deduction_details[correct_outlet] = 10
                        elif deduct_result is False:
                            # è·³éé‡è¤‡è¨˜éŒ„
                            skip_count += 1

                except Exception as e:
                    error_count += 1
                    print(f"è™•ç† {supplier}-{outlet} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

            # ä¿å­˜æ‰£åˆ†è¨˜éŒ„æ–‡ä»¶
            wb_deduct.save(deduction_file_path)
            wb_deduct.close()

            # æ§‹å»ºçµæœè¨Šæ¯
            result_msg = f"F5 ä¿®æ­£å’Œè‡ªå‹•æ‰£åˆ†å®Œæˆï¼\n\n"
            result_msg += f"F5 ä¿®æ­£æˆåŠŸ: {fixed_count} å€‹\n"
            result_msg += f"è‡ªå‹•æ‰£åˆ†æˆåŠŸ: {deduct_count} å€‹\n"
            result_msg += f"è·³éé‡è¤‡è¨˜éŒ„: {skip_count} å€‹\n"
            result_msg += f"è™•ç†å¤±æ•—: {error_count} å€‹\n"
            result_msg += f"ç¸½è¨ˆè™•ç†: {len(self.mismatch_records)} å€‹\n\n"

            # æ·»åŠ æ‰£åˆ†çµ±è¨ˆè©³æƒ…
            if deduction_details:
                result_msg += "æ‰£åˆ†çµ±è¨ˆ:\n"
                for outlet, points in sorted(deduction_details.items()):
                    result_msg += f"  {outlet}: {points} åˆ†\n"
                result_msg += "\n"

            result_msg += f"æ‰£åˆ†è¨˜éŒ„å·²ä¿å­˜åˆ°:\n{deduction_file_path}"

            messagebox.showinfo("è™•ç†å®Œæˆ", result_msg)

            # é¡¯ç¤ºè©³ç´°çš„ä¿®æ”¹è¨˜éŒ„è¦–çª—
            if fix_details:
                self._show_fix_details_window(fix_details)

        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"åŸ·è¡Œä¿®æ­£å’Œæ‰£åˆ†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")

    def _fix_f5_cell(
    self,
    supplier,
    wrong_outlet,
    correct_outlet,
    folder_path,
     config_manager):
        """ä¿®æ­£å–®å€‹ä¾›æ‡‰å•†æ–‡ä»¶çš„ F5 å„²å­˜æ ¼

        Args:
            supplier: ä¾›æ‡‰å•†åç¨±
            wrong_outlet: éŒ¯èª¤çš„é–€å¸‚ä»£ç¢¼ï¼ˆä¾†è‡ª F5 å„²å­˜æ ¼ï¼‰
            correct_outlet: æ­£ç¢ºçš„é–€å¸‚ä»£ç¢¼ï¼ˆä¾†è‡ª Sheetâ†’ï¼‰
            folder_path: ä¾›æ‡‰å•†æ–‡ä»¶å¤¾è·¯å¾‘
            config_manager: é…ç½®ç®¡ç†å™¨

        Returns:
            dict: ä¿®æ­£è©³æƒ…ï¼ŒåŒ…å« supplier, wrong_outlet, correct_outlet, file_path, sheet_name, old_f5, new_f5, old_f6, new_f6, old_g5, new_g5
            None: ä¿®æ­£å¤±æ•—
        """
        try:
            import openpyxl
            import os

            # å¾ Master Config ç²å–æ­£ç¢ºçš„åº—åå’Œåœ°å€
            correct_outlet_info = None
            for outlet_info in config_manager.outlets:
                if outlet_info['code'].upper() == correct_outlet.upper():
                    correct_outlet_info = outlet_info
                    break

            if not correct_outlet_info:
                print(f"âŒ æ‰¾ä¸åˆ°æ­£ç¢ºé–€å¸‚ {correct_outlet} çš„é…ç½®ä¿¡æ¯")
                return None

            # æ‰¾åˆ°å°æ‡‰çš„ä¾›æ‡‰å•†æ–‡ä»¶
            supplier_files = [f for f in os.listdir(
                folder_path) if f.endswith('.xlsx')]
            supplier_file = find_supplier_file(supplier, supplier_files)

            if not supplier_file:
                print(f"âŒ æ‰¾ä¸åˆ°ä¾›æ‡‰å•† {supplier} çš„æ–‡ä»¶")
                return None

            file_path = os.path.join(folder_path, supplier_file)

            # ä¿®æ­£ F5 å„²å­˜æ ¼
            wb = openpyxl.load_workbook(file_path)

            # æ‰¾åˆ°æ­£ç¢ºçš„å·¥ä½œè¡¨ï¼ˆèˆ‡ correct_outlet åŒ¹é…ï¼‰
            target_sheet = None
            target_sheet_name = None
            for sheet_name in wb.sheetnames:
                if correct_outlet.upper() in sheet_name.upper():
                    target_sheet = wb[sheet_name]
                    target_sheet_name = sheet_name
                    break

            if target_sheet:
                # è™•ç†åˆä½µå„²å­˜æ ¼çš„å•é¡Œ
                def set_cell_value_safe(sheet, cell_ref, value):
                    """å®‰å…¨åœ°è¨­ç½®å„²å­˜æ ¼å€¼ï¼Œè™•ç†åˆä½µå„²å­˜æ ¼çš„æƒ…æ³"""
                    try:
                        # æª¢æŸ¥æ˜¯å¦ç‚ºåˆä½µå„²å­˜æ ¼
                        cell = sheet[cell_ref]
                        old_value = None

                        # å…ˆæª¢æŸ¥æ˜¯å¦åœ¨åˆä½µç¯„åœå…§
                        merged_range_to_unmerge = None
                        for merged_range in list(sheet.merged_cells.ranges):
                            if cell_ref in merged_range:
                                merged_range_to_unmerge = merged_range
                                # ç²å–åˆä½µç¯„åœçš„å·¦ä¸Šè§’å„²å­˜æ ¼å€¼
                                top_left = sheet.cell(
    merged_range.min_row, merged_range.min_col)
                                old_value = top_left.value
                                break

                        if merged_range_to_unmerge:
                            # å¦‚æœæ˜¯åˆä½µå„²å­˜æ ¼ï¼Œå…ˆå–æ¶ˆåˆä½µ
                            print(
    f"ğŸ”§ ç™¼ç¾åˆä½µå„²å­˜æ ¼ {merged_range_to_unmerge}ï¼Œæº–å‚™å–æ¶ˆåˆä½µ")
                            sheet.unmerge_cells(str(merged_range_to_unmerge))
                            print(f"âœ… å·²å–æ¶ˆåˆä½µ {merged_range_to_unmerge}")
                        else:
                            # å¦‚æœä¸æ˜¯åˆä½µå„²å­˜æ ¼ï¼Œç›´æ¥ç²å–å€¼
                            old_value = cell.value

                        # è¨­ç½®æ–°å€¼
                        sheet[cell_ref].value = value
                        print(f"âœ… è¨­ç½® {cell_ref} = '{value}'")
                        return old_value

                    except Exception as e:
                        print(f"âŒ è¨­ç½® {cell_ref} æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
                        return None

                # è¨˜éŒ„ä¿®æ­£å‰çš„å€¼ä¸¦è¨­ç½®æ–°å€¼
                # F5 = é–€å¸‚å…¨å (Outlet)
                old_f5 = set_cell_value_safe(
    target_sheet, 'F5', correct_outlet_info['name'])
                # F6 = åœ°å€ (Address) - æ ¹æ“šæ‚¨çš„æˆªåœ–ï¼Œåœ°å€æ‡‰è©²åœ¨ F6
                old_f6 = set_cell_value_safe(
    target_sheet, 'F6', correct_outlet_info['address'])

                # æ¸…é™¤ G5 ä¸­å¯èƒ½çš„éŒ¯èª¤åœ°å€æ•¸æ“š
                old_g5 = None
                try:
                    old_g5 = target_sheet['G5'].value
                    if old_g5 and (
    str(old_g5).strip() == str(
        correct_outlet_info['address']).strip()):
                        target_sheet['G5'].value = None
                        print(f"âœ… æ¸…é™¤ G5 ä¸­çš„éŒ¯èª¤åœ°å€æ•¸æ“š: '{old_g5}'")
                except:
                    pass

                print(f"âœ… ä¿®æ­£ {supplier} - å·¥ä½œè¡¨ {target_sheet_name}:")
                print(
    f"   F5 (é–€å¸‚å…¨å): '{old_f5}' â†’ '{
        correct_outlet_info['name']}'")
                print(
    f"   F6 (åœ°å€): '{old_f6}' â†’ '{
        correct_outlet_info['address']}'")
                if old_g5:
                    print(f"   G5 (æ¸…é™¤éŒ¯èª¤åœ°å€): '{old_g5}' â†’ None")

                # å®‰å…¨ä¿å­˜æ–‡ä»¶ - è™•ç†å¤–éƒ¨éˆæ¥å•é¡Œ
                try:
                    # å‰µå»ºå‚™ä»½
                    import shutil
                    backup_path = file_path.replace('.xlsx', '_backup.xlsx')
                    shutil.copy2(file_path, backup_path)

                    # ä½¿ç”¨å·¥ä½œç°¿è¤‡è£½æ–¹æ³•ï¼Œå®Œå…¨é¿å…å¤–éƒ¨éˆæ¥å’Œå‘½åç¯„åœå•é¡Œ
                    print("âœ… ä½¿ç”¨å·¥ä½œç°¿è¤‡è£½æ–¹æ³•ï¼Œé¿å…æ‰€æœ‰Excelä¿®å¾©å•é¡Œ")
                    
                    try:
                        # å‰µå»ºæ–°çš„å·¥ä½œç°¿
                        new_wb = openpyxl.Workbook()
                        
                        # åˆªé™¤é»˜èªå·¥ä½œè¡¨
                        if 'Sheet' in new_wb.sheetnames:
                            del new_wb['Sheet']
                        
                        # è¤‡è£½æ‰€æœ‰å·¥ä½œè¡¨
                        for sheet in wb.worksheets:
                            new_ws = new_wb.create_sheet(sheet.title)
                            
                            # è¤‡è£½æ‰€æœ‰æ•¸æ“šå’Œæ ¼å¼
                            for row in sheet.iter_rows():
                                for cell in row:
                                    new_cell = new_ws.cell(row=cell.row, column=cell.column)
                                    
                                    # è¤‡è£½å€¼ï¼ˆä¿æŒåŸå§‹å€¼ï¼‰
                                    if cell.value is not None:
                                        new_cell.value = cell.value
                                        print(f"[DEBUG] è¤‡è£½å€¼: {cell.coordinate} = {cell.value}")
                                    
                                    # å®‰å…¨è¤‡è£½æ ¼å¼ï¼Œé¿å…å¾ªç’°å¼•ç”¨
                                    try:
                                        if cell.font:
                                            from openpyxl.styles import Font
                                            new_cell.font = Font(
                                                name=cell.font.name,
                                                size=cell.font.size,
                                                bold=cell.font.bold,
                                                italic=cell.font.italic,
                                                vertAlign=cell.font.vertAlign,
                                                underline=cell.font.underline,
                                                strike=cell.font.strike,
                                                color=cell.font.color
                                            )
                                    except Exception:
                                        pass
                                        
                                    try:
                                        if cell.fill and hasattr(cell.fill, 'fill_type'):
                                            from openpyxl.styles import PatternFill
                                            new_cell.fill = PatternFill(
                                                fill_type=cell.fill.fill_type,
                                                start_color=cell.fill.start_color,
                                                end_color=cell.fill.end_color
                                            )
                                    except Exception:
                                        pass
                                        
                                    try:
                                        if cell.alignment:
                                            from openpyxl.styles import Alignment
                                            new_cell.alignment = Alignment(
                                                horizontal=cell.alignment.horizontal,
                                                vertical=cell.alignment.vertical,
                                                text_rotation=cell.alignment.text_rotation,
                                                wrap_text=cell.alignment.wrap_text,
                                                shrink_to_fit=cell.alignment.shrink_to_fit,
                                                indent=cell.alignment.indent
                                            )
                                    except Exception:
                                        pass
                                        
                                    try:
                                        if cell.border:
                                            from openpyxl.styles import Border, Side
                                            new_cell.border = Border(
                                                left=Side(border_style=cell.border.left.style, color=cell.border.left.color),
                                                right=Side(border_style=cell.border.right.style, color=cell.border.right.color),
                                                top=Side(border_style=cell.border.top.style, color=cell.border.top.color),
                                                bottom=Side(border_style=cell.border.bottom.style, color=cell.border.bottom.color)
                                            )
                                    except Exception:
                                        pass
                                    
                                    # è¤‡è£½æ•¸å­—æ ¼å¼ï¼ˆåŒ…å«æ—¥æœŸæ ¼å¼ï¼‰
                                    try:
                                        if cell.number_format and cell.number_format != 'General':
                                            new_cell.number_format = cell.number_format
                                            print(f"[DEBUG] è¤‡è£½æ ¼å¼: {cell.coordinate} -> {cell.number_format}")
                                    except Exception as format_error:
                                        print(f"[DEBUG] æ ¼å¼è¤‡è£½å¤±æ•—: {cell.coordinate} - {format_error}")
                                        pass
                            
                            # è¤‡è£½åˆä½µå„²å­˜æ ¼
                            for merged_range in sheet.merged_cells.ranges:
                                new_ws.merge_cells(str(merged_range))
                            
                            # è¤‡è£½åˆ—å¯¬å’Œè¡Œé«˜
                            for col in sheet.column_dimensions:
                                new_ws.column_dimensions[col].width = sheet.column_dimensions[col].width
                                # è¤‡è£½åˆ—çš„éš±è—ç‹€æ…‹
                                if hasattr(sheet.column_dimensions[col], 'hidden'):
                                    new_ws.column_dimensions[col].hidden = sheet.column_dimensions[col].hidden
                                    print(f"[DEBUG] è¤‡è£½åˆ—éš±è—ç‹€æ…‹: åˆ—{col} = {sheet.column_dimensions[col].hidden}")
                            
                            for row in sheet.row_dimensions:
                                new_ws.row_dimensions[row].height = sheet.row_dimensions[row].height
                                # è¤‡è£½è¡Œçš„éš±è—ç‹€æ…‹
                                if hasattr(sheet.row_dimensions[row], 'hidden'):
                                    new_ws.row_dimensions[row].hidden = sheet.row_dimensions[row].hidden
                                    print(f"[DEBUG] è¤‡è£½è¡Œéš±è—ç‹€æ…‹: è¡Œ{row} = {sheet.row_dimensions[row].hidden}")
                            
                            # å›ºå®šè¨­å®šå‡çµçª—æ ¼ç‚º A9
                            try:
                                new_ws.freeze_panes = "A9"
                                print(f"âœ… è¨­å®šå›ºå®šå‡çµçª—æ ¼: A9")
                            except Exception as freeze_error:
                                print(f"âš ï¸ è¨­å®šå‡çµçª—æ ¼å¤±æ•—: {freeze_error}")
                            
                            # è¤‡è£½å·¥ä½œè¡¨ä¿è­·
                            if sheet.protection:
                                new_ws.protection = sheet.protection
                            
                            # è™•ç†å…¬å¼ï¼Œå°‡å¤–éƒ¨å¼•ç”¨è½‰æ›ç‚ºæ•¸å€¼ä»¥é¿å…#REF!éŒ¯èª¤
                            print(f"[DEBUG] é–‹å§‹è™•ç†å…¬å¼è½‰æ›...")
                            for row in new_ws.iter_rows():
                                for cell in row:
                                    if cell.value and isinstance(cell.value, str) and cell.value.startswith('='):
                                        # æª¢æŸ¥æ˜¯å¦åŒ…å«å¤–éƒ¨å¼•ç”¨
                                        if any(ref in cell.value for ref in ['[', ']', '!']):
                                            try:
                                                # å˜—è©¦ä½¿ç”¨ xlwings ç²å–è¨ˆç®—çµæœ
                                                import xlwings as xw
                                                # é€™è£¡æˆ‘å€‘å…ˆä¿å­˜åŸå§‹å…¬å¼ï¼Œç„¶å¾Œåœ¨ä¿å­˜å¾Œè™•ç†
                                                print(f"[DEBUG] ç™¼ç¾å¤–éƒ¨å¼•ç”¨å…¬å¼: {cell.coordinate} = {cell.value}")
                                            except Exception as e:
                                                print(f"[DEBUG] è™•ç†å…¬å¼å¤±æ•—: {cell.coordinate} - {e}")
                        
                        # é—œé–‰åŸå·¥ä½œç°¿
                        wb.close()
                        
                        # ä¿å­˜æ–°å·¥ä½œç°¿
                        new_wb.save(file_path)
                        new_wb.close()
                        print(f"âœ… å·¥ä½œç°¿è¤‡è£½ä¿å­˜æˆåŠŸ: {file_path}")
                        
                        # ä½¿ç”¨ xlwings è®€å–åŸå§‹æ–‡ä»¶çš„è¨ˆç®—çµæœï¼Œç„¶å¾Œæ›¿æ›å…¬å¼
                        try:
                            print(f"[DEBUG] é–‹å§‹ä½¿ç”¨ xlwings è®€å–åŸå§‹æ–‡ä»¶è¨ˆç®—çµæœ...")
                            import xlwings as xw
                            
                            # æ‰“é–‹åŸå§‹æ–‡ä»¶ç²å–è¨ˆç®—çµæœ
                            app = xw.App(visible=False)
                            wb_original = app.books.open(src_file)
                            
                            # æ‰“é–‹ç›®æ¨™æ–‡ä»¶
                            wb_target = app.books.open(file_path)
                            
                            # è™•ç†æ¯å€‹å·¥ä½œè¡¨
                            for sheet_name in wb_target.sheets:
                                if sheet_name in wb_original.sheets:
                                    print(f"[DEBUG] è™•ç†å·¥ä½œè¡¨: {sheet_name}")
                                    original_sheet = wb_original.sheets[sheet_name]
                                    target_sheet = wb_target.sheets[sheet_name]
                                    
                                    # ç²å–æ‰€æœ‰ä½¿ç”¨ç¯„åœ
                                    used_range = target_sheet.used_range
                                    if used_range:
                                        # éæ­·æ‰€æœ‰å„²å­˜æ ¼
                                        for row in range(1, used_range.last_cell.row + 1):
                                            for col in range(1, used_range.last_cell.column + 1):
                                                target_cell = target_sheet.cells(row, col)
                                                if target_cell.formula and target_cell.formula.startswith('='):
                                                    # æª¢æŸ¥æ˜¯å¦åŒ…å«å¤–éƒ¨å¼•ç”¨
                                                    if any(ref in target_cell.formula for ref in ['[', ']', '!']):
                                                        try:
                                                            # å¾åŸå§‹æ–‡ä»¶ç²å–å°æ‡‰å„²å­˜æ ¼çš„è¨ˆç®—çµæœ
                                                            original_cell = original_sheet.cells(row, col)
                                                            calculated_value = original_cell.value
                                                            
                                                            if calculated_value is not None and not isinstance(calculated_value, str):
                                                                # å°‡å…¬å¼æ›¿æ›ç‚ºè¨ˆç®—çµæœ
                                                                target_cell.value = calculated_value
                                                                print(f"[DEBUG] è½‰æ›å…¬å¼: {target_cell.address} = {calculated_value}")
                                                            else:
                                                                # å¦‚æœç„¡æ³•ç²å–è¨ˆç®—çµæœï¼Œè¨­ç‚º0
                                                                target_cell.value = 0
                                                                print(f"[DEBUG] è¨­ç‚º0: {target_cell.address}")
                                                        except Exception as e:
                                                            print(f"[DEBUG] è½‰æ›å…¬å¼å¤±æ•—: {target_cell.address} - {e}")
                                                            # è¨­ç‚º0ä½œç‚ºå‚™é¸
                                                            target_cell.value = 0
                            
                            # ä¿å­˜ä¸¦é—œé–‰
                            wb_target.save()
                            wb_target.close()
                            wb_original.close()
                            app.quit()
                            print(f"âœ… å…¬å¼è½‰æ›å®Œæˆ")
                            
                        except Exception as e:
                            print(f"âš ï¸ å…¬å¼è½‰æ›å¤±æ•—: {e}")
                            # å¦‚æœ xlwings è™•ç†å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡Œ
                        
                    except Exception as copy_error:
                        print(f"âš ï¸ å·¥ä½œç°¿è¤‡è£½å¤±æ•—ï¼Œä½¿ç”¨å‚™ä»½: {copy_error}")
                        # å¦‚æœè¤‡è£½å¤±æ•—ï¼Œæ¢å¾©å‚™ä»½
                        wb.close()
                        if os.path.exists(backup_path):
                            shutil.copy2(backup_path, file_path)
                            print(f"âœ… å·²æ¢å¾©å‚™ä»½æ–‡ä»¶")
                        raise copy_error

                    # åˆªé™¤å‚™ä»½
                    import os
                    if os.path.exists(backup_path):
                        os.remove(backup_path)

                except Exception as save_error:
                    print(f"âŒ ä¿å­˜æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {save_error}")
                    # å¦‚æœä¿å­˜å¤±æ•—ï¼Œå˜—è©¦æ¢å¾©å‚™ä»½
                    if os.path.exists(backup_path):
                        shutil.copy2(backup_path, file_path)
                        os.remove(backup_path)
                        print(f"âœ… å·²æ¢å¾©å‚™ä»½æ–‡ä»¶")
                    raise save_error
                finally:
                    wb.close()

                # è¿”å›ä¿®æ­£è©³æƒ…
                return {
                    'supplier': supplier,
                    'wrong_outlet': wrong_outlet,
                    'correct_outlet': correct_outlet,
                    'file_path': supplier_file,
                    'sheet_name': target_sheet_name,
                    'old_f5': old_f5,
                    'new_f5': correct_outlet_info['name'],
                    'old_f6': old_f6,
                    'new_f6': correct_outlet_info['address'],
                    'old_g5': old_g5,
                    'new_g5': None  # G5 è¢«æ¸…é™¤
                }
            else:
                wb.close()
                print(f"âŒ åœ¨ {supplier} æ–‡ä»¶ä¸­æ‰¾ä¸åˆ°å·¥ä½œè¡¨ {wrong_outlet}")
                return None

        except Exception as e:
            print(f"ä¿®æ­£ F5 å„²å­˜æ ¼æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return None

    def _add_deduction_to_file(
    self,
    wb_deduct,
    supplier,
    outlet,
    deducted_by,
     remark=""):
        """æ·»åŠ æ‰£åˆ†è¨˜éŒ„åˆ°æŒ‡å®šçš„å·¥ä½œç°¿"""
        try:
            from datetime import datetime

            # æ‰¾åˆ°æˆ–å‰µå»ºå°æ‡‰é–€å¸‚çš„å·¥ä½œè¡¨
            sheet_name = outlet
            if sheet_name not in wb_deduct.sheetnames:
                # å¦‚æœå·¥ä½œè¡¨ä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°çš„å·¥ä½œè¡¨
                ws = wb_deduct.create_sheet(title=sheet_name)

                # è¨­ç½®æ¨™é¡Œè¡Œï¼ˆç¬¬1è¡Œï¼šé–€å¸‚åç¨±ï¼Œç¬¬2è¡Œï¼šæ¬„ä½æ¨™é¡Œï¼‰
                ws.cell(row=1, column=1, value=f"Outlet: {outlet}")
                ws.merge_cells('A1:H1')
                ws.cell(
    row=1, column=1).font = openpyxl.styles.Font(
        bold=True, size=14)
                ws.cell(
    row=1,
    column=1).alignment = openpyxl.styles.Alignment(
        horizontal="center")

                # ç¬¬2è¡Œï¼šæ¬„ä½æ¨™é¡Œ
                headers = [
                    "Offence Date", "Category", "Description", "Employee Id/Name",
                    "Points Deducted", "Offence #", "Entered By", "Notes"
                ]
                for col, header in enumerate(headers, 1):
                    cell = ws.cell(row=2, column=col, value=header)
                    cell.font = openpyxl.styles.Font(bold=True)
                    cell.alignment = openpyxl.styles.Alignment(
                        horizontal="center")

                # è¨­ç½®åˆ—å¯¬
                column_widths = [12, 15, 50, 20, 12, 10, 15, 20]
                for i, width in enumerate(column_widths, 1):
                    ws.column_dimensions[openpyxl.utils.get_column_letter(
                        i)].width = width
            else:
                ws = wb_deduct[sheet_name]

            # æ§‹å»ºå‚™è¨»ä¿¡æ¯ï¼ŒåŒ…å«ä¾›æ‡‰å•†å’ŒåŸå§‹éŒ¯èª¤ä¿¡æ¯
            notes = f"{supplier} - Mismatch"
            if remark:
                # å¦‚æœæœ‰ remarkï¼Œæ·»åŠ ç°¡åŒ–çš„éŒ¯èª¤ä¿¡æ¯
                if "Sheetâ†’" in remark:
                    notes += f" ({
    remark.split('Sheetâ†’')[0].strip().rstrip(';').rstrip(',')})"

            # æº–å‚™è¦æ·»åŠ çš„æ•¸æ“š
            today = datetime.now().strftime("%Y-%m-%d")
            category = "WeeklyOrder"
            description = "Order Wrong Data (e.g. Wrong Date, Wrong Outlet Selected, etc.)"
            employee_id = "System Auto"

            # æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨ç›¸åŒçš„è¨˜éŒ„ï¼ˆé¿å…é‡è¤‡æ‰£åˆ†ï¼‰
            existing_row = self._check_duplicate_deduction(
    ws, today, category, description, supplier, deducted_by)
            if existing_row:
                print(
    f"âš ï¸  è·³éé‡è¤‡æ‰£åˆ†: {supplier} - {outlet} (å·²å­˜åœ¨æ–¼ç¬¬ {existing_row} è¡Œ)")
                return False  # è¿”å› False è¡¨ç¤ºæ²’æœ‰æ·»åŠ æ–°è¨˜éŒ„ï¼ˆä½†ä¸æ˜¯éŒ¯èª¤ï¼‰

            # æ‰¾åˆ°ä¸‹ä¸€å€‹ç©ºè¡Œï¼ˆå¾ç¬¬3è¡Œé–‹å§‹ï¼‰
            next_row = 3
            while ws.cell(row=next_row, column=1).value is not None:
                next_row += 1

            # å¡«å…¥æ•¸æ“š
            ws.cell(row=next_row, column=1, value=today)  # A: æ—¥æœŸ
            ws.cell(row=next_row, column=2, value=category)  # B: é¡åˆ¥
            ws.cell(row=next_row, column=3, value=description)  # C: æè¿°
            ws.cell(
    row=next_row,
    column=4,
     value=employee_id)  # D: Employee Id/Name
            # E: Points Deducted (èª¿æ•´ç‚º 10)
            ws.cell(row=next_row, column=5, value=10)
            ws.cell(row=next_row, column=6, value=1)   # F: Offence # (èª¿æ•´ç‚º 1)
            ws.cell(row=next_row, column=7, value=deducted_by)  # G: Entered By
            ws.cell(row=next_row, column=8, value=notes)  # H: Notes

            print(f"âœ… æ–°å¢æ‰£åˆ†è¨˜éŒ„: {supplier} - {outlet} (ç¬¬ {next_row} è¡Œ)")
            return True

        except Exception as e:
            print(f"æ·»åŠ æ‰£åˆ†è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return False

    def _check_duplicate_deduction(
    self,
    ws,
    date,
    category,
    description,
    supplier,
     deducted_by):
        """æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨ç›¸åŒçš„æ‰£åˆ†è¨˜éŒ„"""
        try:
            # å¾ç¬¬3è¡Œé–‹å§‹æª¢æŸ¥ï¼ˆè·³éæ¨™é¡Œè¡Œï¼‰
            row = 3
            while ws.cell(row=row, column=1).value is not None:
                # æª¢æŸ¥é—œéµæ¬„ä½æ˜¯å¦åŒ¹é…
                existing_date = ws.cell(row=row, column=1).value
                existing_category = ws.cell(row=row, column=2).value
                existing_description = ws.cell(row=row, column=3).value
                existing_notes = ws.cell(row=row, column=8).value
                existing_deducted_by = ws.cell(row=row, column=7).value

                # è½‰æ›æ—¥æœŸæ ¼å¼é€²è¡Œæ¯”è¼ƒ
                if existing_date:
                    if isinstance(existing_date, str):
                        existing_date_str = existing_date
                    else:
                        # å¦‚æœæ˜¯ datetime å°è±¡ï¼Œè½‰æ›ç‚ºå­—ç¬¦ä¸²
                        existing_date_str = existing_date.strftime(
                            "%Y-%m-%d") if hasattr(existing_date, 'strftime') else str(existing_date)
                else:
                    existing_date_str = ""

                # æª¢æŸ¥æ˜¯å¦ç‚ºç›¸åŒè¨˜éŒ„
                is_same_date = existing_date_str == date
                is_same_category = str(
    existing_category or "").strip() == category
                is_same_description = str(
    existing_description or "").strip() == description
                is_same_deducted_by = str(
    existing_deducted_by or "").strip() == deducted_by
                is_same_supplier = supplier in str(existing_notes or "")

                if (is_same_date and is_same_category and is_same_description and
                    is_same_deducted_by and is_same_supplier):
                    return row  # è¿”å›é‡è¤‡è¨˜éŒ„çš„è¡Œè™Ÿ

                row += 1

            return None  # æ²’æœ‰æ‰¾åˆ°é‡è¤‡è¨˜éŒ„

        except Exception as e:
            print(f"æª¢æŸ¥é‡è¤‡è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return None

    def _show_fix_details_window(self, fix_details):
        """é¡¯ç¤ºä¿®æ­£è©³æƒ…è¦–çª—"""
        details_window = ctk.CTkToplevel(self)
        details_window.title("F5/G5 ä¿®æ­£è©³æƒ… / F5/G5 Fix Details")
        details_window.geometry("1200x700")
        details_window.minsize(1000, 600)
        details_window.resizable(True, True)
        details_window.transient(self)
        details_window.grab_set()
        details_window.configure(fg_color=DARK_BG)

        # å±…ä¸­é¡¯ç¤º
        details_window.update_idletasks()
        width = details_window.winfo_width()
        height = details_window.winfo_height()
        x = (details_window.winfo_screenwidth() // 2) - (width // 2)
        y = (details_window.winfo_screenheight() // 2) - (height // 2)
        details_window.geometry(f"{width}x{height}+{x}+{y}")

        # ä¸»å®¹å™¨
        main_frame = ctk.CTkFrame(details_window, fg_color="transparent")
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
            main_frame,
            text="ğŸ“ F5/G5 ä¿®æ­£è©³æƒ…å ±å‘Š\nğŸ“ F5/G5 Fix Details Report",
            font=("Microsoft JhengHei", 20, "bold"),
            text_color=ACCENT_BLUE
        )
        title_label.pack(pady=(0, 20))

        # èªªæ˜å’Œé¸æ“‡å€åŸŸ
        info_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        info_frame.pack(fill="x", pady=(0, 15))

        # èªªæ˜
        info_label = ctk.CTkLabel(
            info_frame,
            text=f"æˆåŠŸä¿®æ­£ {
    len(fix_details)} å€‹ä¾›æ‡‰å•†æ–‡ä»¶çš„ F5/G5 å„²å­˜æ ¼\nSuccessfully fixed F5/G5 cells in {
        len(fix_details)} supplier files",
            font=("Microsoft JhengHei", 14),
            text_color=TEXT_COLOR
        )
        info_label.pack(side="left")

        # é¸æ“‡å€åŸŸ
        select_frame = ctk.CTkFrame(info_frame, fg_color="transparent")
        select_frame.pack(side="right")

        # é¸æ“‡æ¨™ç±¤
        select_label = ctk.CTkLabel(
            select_frame,
            text="é¸æ“‡æŸ¥çœ‹ / Select:",
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR
        )
        select_label.pack(side="left", padx=(0, 10))

        # é¸æ“‡ä¸‹æ‹‰é¸å–®
        supplier_options = [
            "å…¨éƒ¨ / All"] + [f"{detail['supplier']} - {detail['sheet_name']}" for detail in fix_details]

        supplier_var = ctk.StringVar(value="å…¨éƒ¨ / All")
        supplier_dropdown = ctk.CTkComboBox(
            select_frame,
            values=supplier_options,
            variable=supplier_var,
            font=("Microsoft JhengHei", 12),
            width=300,
            height=35
        )
        supplier_dropdown.pack(side="left", padx=(0, 10))

        # è©³æƒ…æ–‡æœ¬æ¡†
        details_text = ctk.CTkTextbox(
            main_frame,
            font=("Consolas", 12),  # å¢å¤§å­—é«”å¾ 10 åˆ° 12
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            corner_radius=8
        )
        details_text.pack(fill="both", expand=True, pady=(0, 15))

        def update_details_display():
            """æ›´æ–°è©³æƒ…é¡¯ç¤º"""
            selected = supplier_var.get()
            details_text.configure(state="normal")
            details_text.delete("1.0", "end")

            if selected == "å…¨éƒ¨ / All":
                # é¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„
                content = ""
                for i, detail in enumerate(fix_details, 1):
                    content += f"{i}. ä¾›æ‡‰å•† / Supplier: {detail['supplier']}\n"
                    content += f"   æ–‡ä»¶ / File: {detail['file_path']}\n"
                    content += f"   å·¥ä½œè¡¨ / Sheet: {detail['sheet_name']}\n"
                    content += f"   éŒ¯èª¤é–€å¸‚ / Wrong Outlet: {
    detail['wrong_outlet']}\n"
                    content += f"   æ­£ç¢ºé–€å¸‚ / Correct Outlet: {
    detail['correct_outlet']}\n"
                    content += f"   \n"
                    content += f"   ä¿®æ­£å‰ / Before:\n"
                    content += f"     F5 (é–€å¸‚å…¨å): '{detail['old_f5']}'\n"
                    content += f"     G5 (åœ°å€): '{detail['old_g5']}'\n"
                    content += f"   \n"
                    content += f"   ä¿®æ­£å¾Œ / After:\n"
                    content += f"     F5 (é–€å¸‚å…¨å): '{detail['new_f5']}'\n"
                    content += f"     G5 (åœ°å€): '{detail['new_g5']}'\n"
                    content += f"   \n"
                    content += "=" * 80 + "\n\n"
            else:
                # é¡¯ç¤ºé¸ä¸­çš„è¨˜éŒ„
                for i, detail in enumerate(fix_details, 1):
                    if f"{detail['supplier']} - {detail['sheet_name']}" == selected:
                        content = f"ä¾›æ‡‰å•† / Supplier: {detail['supplier']}\n"
                        content += f"æ–‡ä»¶ / File: {detail['file_path']}\n"
                        content += f"å·¥ä½œè¡¨ / Sheet: {detail['sheet_name']}\n"
                        content += f"éŒ¯èª¤é–€å¸‚ / Wrong Outlet: {
    detail['wrong_outlet']}\n"
                        content += f"æ­£ç¢ºé–€å¸‚ / Correct Outlet: {
    detail['correct_outlet']}\n"
                        content += f"\n"
                        content += f"ä¿®æ­£å‰ / Before:\n"
                        content += f"  F5 (é–€å¸‚å…¨å): '{detail['old_f5']}'\n"
                        content += f"  G5 (åœ°å€): '{detail['old_g5']}'\n"
                        content += f"\n"
                        content += f"ä¿®æ­£å¾Œ / After:\n"
                        content += f"  F5 (é–€å¸‚å…¨å): '{detail['new_f5']}'\n"
                        content += f"  G5 (åœ°å€): '{detail['new_g5']}'\n"
                        content += f"\n"
                        content += "è©³ç´°å°æ¯” / Detailed Comparison:\n"
                        content += f"  F5 (é–€å¸‚å…¨å): '{
    detail['old_f5']}' â†’ '{
        detail['new_f5']}'\n"
                        content += f"  F6 (åœ°å€): '{
    detail['old_f6']}' â†’ '{
        detail['new_f6']}'\n"
                        if detail.get('old_g5'):
                            content += f"  G5 (æ¸…é™¤éŒ¯èª¤): '{
    detail['old_g5']}' â†’ None\n"
                        break

            details_text.insert("1.0", content)
            details_text.configure(state="disabled")

        # ç¶å®šä¸‹æ‹‰é¸å–®è®Šæ›´äº‹ä»¶
        supplier_dropdown.configure(
    command=lambda value: update_details_display())

        # åˆå§‹é¡¯ç¤ºæ‰€æœ‰è¨˜éŒ„
        update_details_display()

        # æŒ‰éˆ•å€åŸŸ
        btn_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        btn_frame.pack(fill="x")

        # å­—é«”å¤§å°æ§åˆ¶
        font_frame = ctk.CTkFrame(btn_frame, fg_color="transparent")
        font_frame.pack(side="left")

        font_label = ctk.CTkLabel(
            font_frame,
            text="å­—é«”å¤§å° / Font Size:",
            font=("Microsoft JhengHei", 12),
            text_color=TEXT_COLOR
        )
        font_label.pack(side="left", padx=(0, 10))

        def change_font_size(size):
            """æ”¹è®Šå­—é«”å¤§å°"""
            details_text.configure(font=("Consolas", size))

        # å­—é«”å¤§å°æŒ‰éˆ•
        font_small_btn = ctk.CTkButton(
            font_frame,
            text="å° / S",
            command=lambda: change_font_size(10),
            fg_color="#6b7280",
            hover_color="#4b5563",
            font=("Microsoft JhengHei", 10),
            width=50,
            height=30
        )
        font_small_btn.pack(side="left", padx=2)

        font_medium_btn = ctk.CTkButton(
            font_frame,
            text="ä¸­ / M",
            command=lambda: change_font_size(12),
            fg_color=ACCENT_BLUE,
            hover_color="#1e40af",
            font=("Microsoft JhengHei", 10),
            width=50,
            height=30
        )
        font_medium_btn.pack(side="left", padx=2)

        font_large_btn = ctk.CTkButton(
            font_frame,
            text="å¤§ / L",
            command=lambda: change_font_size(14),
            fg_color="#6b7280",
            hover_color="#4b5563",
            font=("Microsoft JhengHei", 10),
            width=50,
            height=30
        )
        font_large_btn.pack(side="left", padx=2)

        # é—œé–‰æŒ‰éˆ•
        close_btn = ctk.CTkButton(
            btn_frame,
            text="é—œé–‰ / Close",
            command=details_window.destroy,
            fg_color="#6b7280",
            hover_color="#4b5563",
            font=("Microsoft JhengHei", 14, "bold"),
            corner_radius=8,
            width=120,
            height=40
        )
        close_btn.pack(side="right")


class AddDeductionDialog(ctk.CTkToplevel):
    """æ·»åŠ æ‰£åˆ†è¨˜éŒ„å°è©±æ¡†"""

    def __init__(self, parent, file_path, outlet_name, refresh_callback):
        super().__init__(parent)
        self.title("æ·»åŠ æ‰£åˆ†è¨˜éŒ„ / Add Deduction Record")
        self.geometry("600x500")
        self.transient(parent)
        self.grab_set()
        self.configure(fg_color=DARK_BG)
        self.file_path = file_path
        self.outlet_name = outlet_name
        self.refresh_callback = refresh_callback

        # å±…ä¸­é¡¯ç¤º
        self.center_window()

        # ä¸»å®¹å™¨
        main_frame = ctk.CTkFrame(self, fg_color="transparent")
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
            main_frame,
            text=f"ğŸ“ ç‚º {outlet_name} æ·»åŠ æ‰£åˆ†è¨˜éŒ„\nğŸ“ Add Deduction Record for {outlet_name}",
            font=("Microsoft JhengHei", 16, "bold"),
            text_color=ACCENT_BLUE
        )
        title_label.pack(pady=(0, 20))

        # è¡¨å–®å€åŸŸ
        form_frame = ctk.CTkFrame(
    main_frame,
    fg_color=DARK_PANEL,
     corner_radius=12)
        form_frame.pack(fill="both", expand=True, pady=(0, 20))

        # æ—¥æœŸ
        ctk.CTkLabel(
            form_frame,
            text="æ—¥æœŸ / Date:",
            font=("Microsoft JhengHei", 12, "bold"),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(15, 5))

        self.date_var = ctk.StringVar(
    value=datetime.now().strftime("%Y-%m-%d"))
        date_entry = ctk.CTkEntry(
            form_frame,
            textvariable=self.date_var,
            font=("Microsoft JhengHei", 12),
            height=35
        )
        date_entry.pack(fill="x", padx=15, pady=(0, 10))

        # é¡åˆ¥
        ctk.CTkLabel(
            form_frame,
            text="é¡åˆ¥ / Category:",
            font=("Microsoft JhengHei", 12, "bold"),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 5))

        self.category_var = ctk.StringVar(value="WeeklyOrder")
        category_entry = ctk.CTkEntry(
            form_frame,
            textvariable=self.category_var,
            font=("Microsoft JhengHei", 12),
            height=35
        )
        category_entry.pack(fill="x", padx=15, pady=(0, 10))

        # æè¿°
        ctk.CTkLabel(
            form_frame,
            text="æè¿° / Description:",
            font=("Microsoft JhengHei", 12, "bold"),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 5))

        self.description_var = ctk.StringVar(
    value="Order Wrong Data (e.g. Wrong Date, Wrong Outlet Selected, etc.)")
        description_entry = ctk.CTkEntry(
            form_frame,
            textvariable=self.description_var,
            font=("Microsoft JhengHei", 12),
            height=35
        )
        description_entry.pack(fill="x", padx=15, pady=(0, 10))

        # æ‰£åˆ†é …ç›®
        ctk.CTkLabel(
            form_frame,
            text="æ‰£åˆ†é …ç›® / Deduction Item:",
            font=("Microsoft JhengHei", 12, "bold"),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 5))

        self.item_var = ctk.StringVar(value="10")
        item_entry = ctk.CTkEntry(
            form_frame,
            textvariable=self.item_var,
            font=("Microsoft JhengHei", 12),
            height=35
        )
        item_entry.pack(fill="x", padx=15, pady=(0, 10))

        # æ‰£åˆ†
        ctk.CTkLabel(
            form_frame,
            text="æ‰£åˆ† / Points Deducted:",
            font=("Microsoft JhengHei", 12, "bold"),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 5))

        self.points_var = ctk.StringVar(value="1")
        points_entry = ctk.CTkEntry(
            form_frame,
            textvariable=self.points_var,
            font=("Microsoft JhengHei", 12),
            height=35
        )
        points_entry.pack(fill="x", padx=15, pady=(0, 10))

        # æ‰£åˆ†äººå“¡
        ctk.CTkLabel(
            form_frame,
            text="æ‰£åˆ†äººå“¡ / Deducted By: *",
            font=("Microsoft JhengHei", 12, "bold"),
            text_color=ACCENT_RED
        ).pack(anchor="w", padx=15, pady=(5, 5))

        self.deducted_by_var = ctk.StringVar()
        deducted_by_entry = ctk.CTkEntry(
            form_frame,
            textvariable=self.deducted_by_var,
            font=("Microsoft JhengHei", 12),
            height=35,
            placeholder_text="å¿…å¡«é …ç›®..."
        )
        deducted_by_entry.pack(fill="x", padx=15, pady=(0, 10))

        # å‚™è¨»
        ctk.CTkLabel(
            form_frame,
            text="å‚™è¨» / Notes:",
            font=("Microsoft JhengHei", 12, "bold"),
            text_color=TEXT_COLOR
        ).pack(anchor="w", padx=15, pady=(5, 5))

        self.notes_var = ctk.StringVar()
        notes_entry = ctk.CTkEntry(
            form_frame,
            textvariable=self.notes_var,
            font=("Microsoft JhengHei", 12),
            height=35,
            placeholder_text="å¯é¸é …ç›®..."
        )
        notes_entry.pack(fill="x", padx=15, pady=(0, 15))

        # æŒ‰éˆ•å€åŸŸ
        btn_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        btn_frame.pack(fill="x", pady=(10, 0))

        # å–æ¶ˆæŒ‰éˆ•
        cancel_btn = ctk.CTkButton(
            btn_frame,
            text="å–æ¶ˆ / Cancel",
            command=self.destroy,
            fg_color="#6b7280",
            hover_color="#4b5563",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=120,
            height=40
        )
        cancel_btn.pack(side="right", padx=(10, 0))

        # ä¿å­˜æŒ‰éˆ•
        save_btn = ctk.CTkButton(
            btn_frame,
            text="ä¿å­˜ / Save",
            command=self._save_record,
            fg_color=ACCENT_GREEN,
            hover_color="#059669",
            font=("Microsoft JhengHei", 12, "bold"),
            corner_radius=8,
            width=120,
            height=40
        )
        save_btn.pack(side="right", padx=(0, 10))

        # å¼·åˆ¶ç²å¾—ç„¦é»
        self.focus_force()

    def center_window(self):
        """å±…ä¸­é¡¯ç¤ºè¦–çª—"""
        self.update_idletasks()
        width = self.winfo_width()
        height = self.winfo_height()
        x = (self.winfo_screenwidth() // 2) - (width // 2)
        y = (self.winfo_screenheight() // 2) - (height // 2)
        self.geometry(f"{width}x{height}+{x}+{y}")

    def _save_record(self):
        """ä¿å­˜æ‰£åˆ†è¨˜éŒ„"""
        try:
            import openpyxl

            # æª¢æŸ¥å¿…å¡«æ¬„ä½
            deducted_by = self.deducted_by_var.get().strip()
            if not deducted_by:
                messagebox.showwarning("è­¦å‘Š", "è«‹è¼¸å…¥æ‰£åˆ†äººå“¡å§“åï¼")
                return

            # æ‰“é–‹æ–‡ä»¶
            wb = openpyxl.load_workbook(self.file_path)

            # ç¢ºä¿å·¥ä½œè¡¨å­˜åœ¨
            if self.outlet_name not in wb.sheetnames:
                messagebox.showerror("éŒ¯èª¤", f"å·¥ä½œè¡¨ '{self.outlet_name}' ä¸å­˜åœ¨ï¼")
                return

            ws = wb[self.outlet_name]

            # æ‰¾åˆ°ä¸‹ä¸€å€‹ç©ºè¡Œï¼ˆå¾ç¬¬3è¡Œé–‹å§‹ï¼‰
            next_row = 3
            while ws.cell(row=next_row, column=1).value is not None:
                next_row += 1

            # å¡«å…¥æ•¸æ“š
            ws.cell(row=next_row, column=1, value=self.date_var.get().strip())
            ws.cell(
    row=next_row,
    column=2,
     value=self.category_var.get().strip())
            ws.cell(
    row=next_row,
    column=3,
     value=self.description_var.get().strip())
            ws.cell(row=next_row, column=4, value=self.item_var.get().strip())
            ws.cell(
    row=next_row,
    column=5,
     value=self.points_var.get().strip())
            ws.cell(row=next_row, column=6, value=deducted_by)
            ws.cell(row=next_row, column=7, value=self.notes_var.get().strip())

            # ä¿å­˜æ–‡ä»¶
            wb.save(self.file_path)
            wb.close()

            messagebox.showinfo("æˆåŠŸ", f"æ‰£åˆ†è¨˜éŒ„å·²ä¿å­˜åˆ° {self.outlet_name}")

            # åˆ·æ–°çˆ¶çª—å£
            if self.refresh_callback:
                self.refresh_callback()

            self.destroy()

        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"ä¿å­˜æ‰£åˆ†è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")


# ============================================================================
# Siahuat SOA æ ¸å¯¹çª—å£ / Siahuat SOA Reconciliation Window
# ============================================================================

class SiahuatSOAWindow(ctk.CTkToplevel):
    """Siahuatä¸“ç”¨çš„SOAæ ¸å¯¹å¼¹çª—"""

    def __init__(self, parent):
        super().__init__(parent)
        self.title("ğŸ¢ Siahuat SOA æ ¸å°ç³»çµ± / Siahuat SOA Reconciliation System")
        self.geometry("1200x800")
        self.resizable(True, True)
        self.configure(fg_color=DARK_BG)

        # å±…ä¸­æ˜¾ç¤º
        self.center_window()

        # åˆ›å»ºç•Œé¢
        self._setup_ui()

    def center_window(self):
        """å±…ä¸­æ˜¾ç¤ºçª—å£"""
        self.update_idletasks()
        x = (self.winfo_screenwidth() // 2) - (self.winfo_width() // 2)
        y = (self.winfo_screenheight() // 2) - (self.winfo_height() // 2)
        self.geometry(f"+{x}+{y}")

    def _setup_ui(self):
        """è®¾ç½®ç•Œé¢"""
        # ä¸»å®¹å™¨
        main_frame = ctk.CTkFrame(self, fg_color="transparent")
        main_frame.pack(fill="both", expand=True, padx=20, pady=20)

        # é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
        header_frame = ctk.CTkFrame(
    main_frame,
    fg_color=DARK_PANEL,
     corner_radius=12)
        header_frame.pack(fill="x", pady=(0, 20))

        # æ ‡é¢˜
        title_label = ctk.CTkLabel(
            header_frame,
            text="ğŸ¢ Siahuat SOA æ ¸å°ç³»çµ±\nSiahuat SOA Reconciliation System",
            font=("Microsoft YaHei", 20, "bold"),
            text_color=ACCENT_BLUE
        )
        title_label.pack(pady=20)

        # å‰¯æ ‡é¢˜
        subtitle_label = ctk.CTkLabel(
            header_frame,
            text="é‡å°æ€è¯é”è²¿æ˜“çš„ PDF å’Œ SOA æ•¸æ“šé€²è¡Œæ ¸å°\nReconcile PDF and SOA data specifically for Siahuat Trading",
            font=("Microsoft YaHei", 12),
            text_color="#cccccc"
        )
        subtitle_label.pack(pady=(0, 20))

        # SOAæ ¸å¯¹ç•Œé¢å†…å®¹
        content_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        content_frame.pack(fill="both", expand=True)

        # åˆ›å»ºSiahuatä¸“ç”¨çš„SOAæ ¸å¯¹UI
        self.soa_ui = SiahuatSOAUI(content_frame)
        self.soa_ui.pack(fill="both", expand=True)

        # åº•éƒ¨æŒ‰é’®åŒºåŸŸ
        bottom_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        bottom_frame.pack(fill="x", pady=(20, 0))

        # å…³é—­æŒ‰é’®
        close_btn = ctk.CTkButton(
            bottom_frame,
            text="âŒ é—œé–‰ / Close",
            font=("Microsoft YaHei", 12, "bold"),
            fg_color="#dc3545",
            hover_color="#c82333",
            width=120,
            height=40,
            command=self.destroy
        )
        close_btn.pack(side="right", padx=(10, 0))

        # æœ€ç»ˆåˆå¹¶æŒ‰é’®
        final_merge_btn = ctk.CTkButton(
            bottom_frame,
            text="ğŸ”— æœ€çµ‚åˆä½µ\nFinal Merge",
            font=("Microsoft YaHei", 12, "bold"),
            fg_color=ACCENT_GREEN,
            hover_color="#059669",
            width=120,
            height=40,
            command=self._create_final_merge
        )
        final_merge_btn.pack(side="right", padx=(0, 10))

        # å¸®åŠ©æŒ‰é’®
        help_btn = ctk.CTkButton(
            bottom_frame,
            text="â“ å¹«åŠ© / Help",
            font=("Microsoft YaHei", 12),
            fg_color="#6c757d",
            hover_color="#5a6268",
            width=120,
            height=40,
            command=self._show_help
        )
        help_btn.pack(side="right", padx=(0, 10))

    def _show_help(self):
        """æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"""
        help_text = """
ğŸ¢ Siahuat SOA æ ¸å°ç³»çµ±ä½¿ç”¨èªªæ˜

1. ğŸ“ é¸æ“‡æ–‡ä»¶ï¼š
   â€¢ Invoices: é¸æ“‡ Siahuat çš„ç™¼ç¥¨ PDF æ–‡ä»¶
   â€¢ SOA: é¸æ“‡å°æ‡‰çš„ SOA (Statement of Account) æ–‡ä»¶

2. ğŸ”„ é–‹å§‹æ ¸å°ï¼š
   â€¢ é»æ“Š "é–‹å§‹æ ¸å°" æŒ‰éˆ•åŸ·è¡Œè‡ªå‹•æ¯”å°
   â€¢ ç³»çµ±æœƒè‡ªå‹•æå–ç™¼ç¥¨è™Ÿç¢¼å’Œé‡‘é¡é€²è¡Œæ¯”å°

3. ğŸ“Š æŸ¥çœ‹çµæœï¼š
   â€¢ åŒ¹é…é …ç›®æœƒé¡¯ç¤ºç‚º âœ… åŒ¹é…
   â€¢ ä¸åŒ¹é…é …ç›®æœƒé¡¯ç¤ºå·®ç•°é‡‘é¡
   â€¢ å¯ä»¥å°å‡º Excel æˆ– CSV æ ¼å¼çš„å ±å‘Š

4. ğŸ”§ OCR æ™ºèƒ½ä¿®å¾©ï¼š
   â€¢ ç³»çµ±å…§å»º OCR éŒ¯èª¤ä¿®å¾©åŠŸèƒ½
   â€¢ è‡ªå‹•ä¿®æ­£å¸¸è¦‹çš„æ•¸å­—è­˜åˆ¥éŒ¯èª¤

æ³¨æ„äº‹é …ï¼š
â€¢ ç¢ºä¿ PDF æ–‡ä»¶æ ¼å¼æ­£ç¢ºä¸”æ¸…æ™°
â€¢ å»ºè­°ä½¿ç”¨é«˜è³ªé‡çš„ PDF æ–‡ä»¶ä»¥ç²å¾—æœ€ä½³æ•ˆæœ
        """

        ScrollableMessageBox(self, "å¹«åŠ© / Help", help_text.strip())


# ============================================================================
# Siahuat å°ˆç”¨ SOA UI / Siahuat Dedicated SOA UI
# ============================================================================

class SiahuatSOAUI(ctk.CTkFrame):
    """Siahuatå°ˆç”¨çš„SOAæ ¸å°ç•Œé¢"""
    
    def __init__(self, master):
        super().__init__(master, fg_color='transparent')
        self.invoice_path = None
        self.soa_path = None
        self.invoice_data = {}
        self.soa_data = {}
        self._build()
    
    def _build(self):
        """å»ºç«‹ç•Œé¢"""
        # ä¸»è¦å…§å®¹æ¡†æ¶
        main_frame = ctk.CTkFrame(self, fg_color="transparent")
        main_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        # æ–‡ä»¶é¸æ“‡å€åŸŸ
        file_frame = ctk.CTkFrame(main_frame, fg_color=DARK_PANEL, corner_radius=12)
        file_frame.pack(fill="x", pady=(0, 20))
        
        # æ¨™é¡Œ
        title_label = ctk.CTkLabel(
            file_frame, 
            text="ğŸ“ æ–‡ä»¶é¸æ“‡ / File Selection",
            font=("Microsoft YaHei", 16, "bold"),
            text_color=ACCENT_BLUE
        )
        title_label.pack(pady=(15, 10))
        
        # Invoice PDF é¸æ“‡
        invoice_frame = ctk.CTkFrame(file_frame, fg_color="transparent")
        invoice_frame.pack(fill="x", padx=20, pady=10)
        
        invoice_label = ctk.CTkLabel(
            invoice_frame,
            text="ğŸ“„ Invoice PDF\nç™¼ç¥¨ PDF æ–‡ä»¶",
            font=("Microsoft YaHei", 12, "bold"),
            text_color=ACCENT_GREEN
        )
        invoice_label.pack(side="left", padx=(0, 15))
        
        self.invoice_path_var = ctk.StringVar()
        invoice_entry = ctk.CTkEntry(
            invoice_frame,
            textvariable=self.invoice_path_var,
            placeholder_text="é¸æ“‡ Siahuat Invoice PDF æ–‡ä»¶...",
            font=("Microsoft YaHei", 11),
            width=300
        )
        invoice_entry.pack(side="left", fill="x", expand=True, padx=(0, 10))
        
        invoice_browse_btn = ctk.CTkButton(
            invoice_frame,
            text="ç€è¦½\nBrowse",
            font=("Microsoft YaHei", 10, "bold"),
            width=70,
            height=45,
            command=self._browse_invoice_file
        )
        invoice_browse_btn.pack(side="right")
        
        # SOA PDF é¸æ“‡
        soa_frame = ctk.CTkFrame(file_frame, fg_color="transparent")
        soa_frame.pack(fill="x", padx=20, pady=(10, 20))
        
        soa_label = ctk.CTkLabel(
            soa_frame,
            text="ğŸ“Š SOA PDF\nStatement of Account",
            font=("Microsoft YaHei", 12, "bold"),
            text_color=ACCENT_ORANGE
        )
        soa_label.pack(side="left", padx=(0, 15))
        
        self.soa_path_var = ctk.StringVar()
        soa_entry = ctk.CTkEntry(
            soa_frame,
            textvariable=self.soa_path_var,
            placeholder_text="é¸æ“‡ Siahuat SOA PDF æ–‡ä»¶...",
            font=("Microsoft YaHei", 11),
            width=300
        )
        soa_entry.pack(side="left", fill="x", expand=True, padx=(0, 10))
        
        soa_browse_btn = ctk.CTkButton(
            soa_frame,
            text="ç€è¦½\nBrowse",
            font=("Microsoft YaHei", 10, "bold"),
            width=70,
            height=45,
            command=self._browse_soa_file
        )
        soa_browse_btn.pack(side="right")
        
        # æ“ä½œæŒ‰éˆ•å€åŸŸ
        action_frame = ctk.CTkFrame(main_frame, fg_color="transparent")
        action_frame.pack(fill="x", pady=(0, 20))
        
        # é–‹å§‹æ ¸å°æŒ‰éˆ•
        start_btn = ctk.CTkButton(
            action_frame,
            text="ğŸ”„ é–‹å§‹æ ¸å°\nStart Reconciliation",
            font=("Microsoft YaHei", 14, "bold"),
            fg_color=ACCENT_GREEN,
            hover_color="#047857",
            width=200,
            height=60,
            command=self._start_reconciliation
        )
        start_btn.pack(side="left", padx=(0, 10))
        
        # æ¸…ç©ºçµæœæŒ‰éˆ•
        clear_btn = ctk.CTkButton(
            action_frame,
            text="ğŸ—‘ï¸ æ¸…ç©ºçµæœ\nClear Results",
            font=("Microsoft YaHei", 12, "bold"),
            fg_color="#6c757d",
            hover_color="#5a6268",
            width=120,
            height=45,
            command=self._clear_results
        )
        clear_btn.pack(side="left", padx=(0, 10))
        
        # çµæœé¡¯ç¤ºå€åŸŸ
        result_frame = ctk.CTkFrame(main_frame, fg_color=DARK_PANEL, corner_radius=12)
        result_frame.pack(fill="both", expand=True)
        
        result_title = ctk.CTkLabel(
            result_frame,
            text="ğŸ“Š æ ¸å°çµæœ / Reconciliation Results",
            font=("Microsoft YaHei", 16, "bold"),
            text_color=ACCENT_BLUE
        )
        result_title.pack(pady=(15, 10))
        
        # çµæœæ–‡æœ¬æ¡†
        self.result_text = ctk.CTkTextbox(
            result_frame,
            font=("Consolas", 11),
            wrap="word"
        )
        self.result_text.pack(fill="both", expand=True, padx=20, pady=(0, 20))
    
    def _browse_invoice_file(self):
        """ç€è¦½é¸æ“‡ Invoice PDF æ–‡ä»¶"""
        from tkinter import filedialog
        file_path = filedialog.askopenfilename(
            title="é¸æ“‡ Siahuat Invoice PDF æ–‡ä»¶",
            filetypes=[("PDF files", "*.pdf"), ("All files", "*.*")]
        )
        if file_path:
            self.invoice_path_var.set(file_path)
            self.invoice_path = file_path
            self._log(f"âœ… å·²é¸æ“‡ Invoice PDF: {file_path}")
    
    def _browse_soa_file(self):
        """ç€è¦½é¸æ“‡ SOA PDF æ–‡ä»¶"""
        from tkinter import filedialog
        file_path = filedialog.askopenfilename(
            title="é¸æ“‡ Siahuat SOA PDF æ–‡ä»¶",
            filetypes=[("PDF files", "*.pdf"), ("All files", "*.*")]
        )
        if file_path:
            self.soa_path_var.set(file_path)
            self.soa_path = file_path
            self._log(f"âœ… å·²é¸æ“‡ SOA PDF: {file_path}")
    
    def _start_reconciliation(self):
        """é–‹å§‹æ ¸å°"""
        if not self.invoice_path or not self.soa_path:
            self._log("âŒ éŒ¯èª¤: è«‹å…ˆé¸æ“‡ Invoice å’Œ SOA PDF æ–‡ä»¶")
            return
        
        self._log("ğŸ”„ é–‹å§‹ Siahuat SOA æ ¸å°...")
        
        try:
            # æå– Invoice æ•¸æ“š
            self._log("ğŸ“„ æ­£åœ¨æå– Invoice PDF æ•¸æ“š...")
            invoice_text = self._extract_pdf_text(self.invoice_path)
            self.invoice_data = self._extract_invoice_data(invoice_text)
            self._log(f"âœ… Invoice æ•¸æ“šæå–å®Œæˆï¼Œæ‰¾åˆ° {len(self.invoice_data)} æ¢è¨˜éŒ„")
            
            # æå– SOA æ•¸æ“š
            self._log("ğŸ“Š æ­£åœ¨æå– SOA PDF æ•¸æ“š...")
            soa_text = self._extract_pdf_text(self.soa_path)
            self.soa_data = self._extract_soa_data(soa_text)
            self._log(f"âœ… SOA æ•¸æ“šæå–å®Œæˆï¼Œæ‰¾åˆ° {len(self.soa_data)} æ¢è¨˜éŒ„")
            
            # é€²è¡Œæ ¸å°
            self._log("ğŸ” æ­£åœ¨é€²è¡Œæ•¸æ“šæ ¸å°...")
            self._perform_reconciliation()
            
        except Exception as e:
            self._log(f"âŒ æ ¸å°éç¨‹ç™¼ç”ŸéŒ¯èª¤: {str(e)}")
    
    def _extract_pdf_text(self, pdf_path):
        """æå– PDF æ–‡å­—å…§å®¹"""
        try:
            import pdfplumber
            text = ""
            with pdfplumber.open(pdf_path) as pdf:
                for page in pdf.pages:
                    page_text = page.extract_text()
                    if page_text:
                        text += page_text + "\n"
            return text
        except Exception as e:
            raise Exception(f"PDF æ–‡å­—æå–å¤±æ•—: {str(e)}")
    
    def _extract_invoice_data(self, text):
        """å¾ Invoice PDF æå–æ•¸æ“š - èª¿ç”¨ç¾æœ‰çš„ Siahuat å°ˆç”¨æ–¹æ³•"""
        # é€™è£¡èª¿ç”¨ç¾æœ‰çš„ SiahuatSOAWindow ä¸­çš„æ–¹æ³•
        # æˆ‘å€‘éœ€è¦æ‰¾åˆ°é€™å€‹æ–¹æ³•ä¸¦å°‡å…¶ç§»åˆ°é€™è£¡æˆ–å‰µå»ºä¸€å€‹ helper é¡
        return self._extract_invoice_data_siahuat(text)
    
    def _extract_soa_data(self, text):
        """å¾ SOA PDF æå–æ•¸æ“š - èª¿ç”¨ç¾æœ‰çš„ Siahuat å°ˆç”¨æ–¹æ³•"""
        # é€™è£¡èª¿ç”¨ç¾æœ‰çš„ SiahuatSOAWindow ä¸­çš„æ–¹æ³•
        return self._extract_soa_data_siahuat(text)
    
    def _extract_invoice_data_siahuat(self, text):
        """å¾Invoice PDFæå–Invoiceè™Ÿç¢¼å’ŒAmount Due - å°ˆé–€é‡å°Siahuatæ¨¡æ¿å„ªåŒ–"""
        data = {}
        try:
            import re
            
            print("ğŸ” DEBUG: === é–‹å§‹æå–Siahuat Invoiceæ•¸æ“š ===")
            print(f"ğŸ” DEBUG: è¼¸å…¥æ–‡æœ¬é•·åº¦: {len(text)}")
            
            # ===== SIAHUAT SPECIFIC PATTERNS =====
            # æŸ¥æ‰¾Invoiceè™Ÿç¢¼æ¨¡å¼ - Siahuatæ ¼å¼: INV-SH250604007
            inv_pattern = r'INV-SH\d+'
            inv_matches = re.findall(inv_pattern, text)
            print(f"ğŸ” DEBUG: æ‰¾åˆ°Siahuat Invoiceè™Ÿç¢¼: {inv_matches}")
            
            if inv_matches:
                # æŒ‰è¡Œè™•ç†ï¼ŒæŸ¥æ‰¾åŒ…å«Invoiceè™Ÿç¢¼å’Œé‡‘é¡çš„è¡Œ
                lines = text.split('\n')
                for idx, line in enumerate(lines):
                    line = line.strip()
                    if line and 'INV-SH' in line:
                        # æå–Invoiceè™Ÿç¢¼
                        inv_match = re.search(inv_pattern, line)
                        if inv_match:
                            inv = inv_match.group()
                            
                            # Siahuatæ ¼å¼çš„Amount DueæŸ¥æ‰¾
                            amount_patterns = [
                                r'Amount Due[:\s]*\$?(\d+\.?\d*)',
                                r'Total[:\s]*\$?(\d+\.?\d*)',
                                r'(\d+\.\d{2})'  # æœ€å¾Œå‚™ç”¨çš„é‡‘é¡æ¨¡å¼
                            ]
                            
                            amount_found = None
                            for pattern in amount_patterns:
                                matches = re.findall(pattern, line, re.IGNORECASE)
                                if matches:
                                    amount_found = matches[0]
                                    break
                            
                            if amount_found:
                                data[inv] = float(amount_found)
                                print(f"ğŸ” DEBUG: æ‰¾åˆ°åŒ¹é… {inv} -> ${amount_found}")
            
            return data
            
        except Exception as e:
            print(f"ğŸ” DEBUG: Siahuat Invoiceæ•¸æ“šæå–å¤±æ•—: {e}")
            return {}
    
    def _extract_soa_data_siahuat(self, text):
        """å¾SOA PDFæå–Invoiceè™Ÿç¢¼å’ŒDré‡‘é¡ - å°ˆé–€é‡å°Siahuat SOAæ¨¡æ¿å„ªåŒ–"""
        data = {}
        try:
            import re
            
            print("ğŸ” DEBUG: é–‹å§‹æå–Siahuat SOAæ•¸æ“š")
            
            # ===== SIAHUAT SOA SPECIFIC PATTERNS =====
            # æŸ¥æ‰¾Invoiceè™Ÿç¢¼æ¨¡å¼ - Siahuatæ ¼å¼: INV-SH250603XXX
            inv_pattern = r'INV-SH\d+'
            inv_matches = re.findall(inv_pattern, text)
            print(f"ğŸ” DEBUG: æ‰¾åˆ°Siahuat SOAä¸­çš„Invoiceè™Ÿç¢¼: {inv_matches}")
            
            # æŒ‰è¡Œè™•ç†ï¼ŒæŸ¥æ‰¾åŒ…å«Invoiceè™Ÿç¢¼å’ŒDré‡‘é¡çš„è¡Œ
            lines = text.split('\n')
            for idx, line in enumerate(lines):
                line = line.strip()
                if line and 'INV-SH' in line:
                    print(f"ğŸ” DEBUG: è™•ç†Siahuat SOAè¡Œ: {line}")
                    
                    # æå–Invoiceè™Ÿç¢¼
                    inv_match = re.search(inv_pattern, line)
                    if inv_match:
                        inv = inv_match.group()
                        
                        # Siahuat SOAç‰¹å®šçš„Dré‡‘é¡æŸ¥æ‰¾æ¨¡å¼
                        dr_patterns = [
                            r'Dr\s*([\d,]+\.?\d*)\s*(?:$|Balance|Cr)',  # æ˜ç¢ºæŠ“ Dr å¾Œé‡‘é¡
                            r'([\d,]+\.?\d*)\s*Dr',                      # é‡‘é¡åœ¨å‰ï¼Œæ¥ Dr
                        ]
                        
                        dr_amount = None
                        for pattern in dr_patterns:
                            matches = re.findall(pattern, line)
                            if matches:
                                # è¿‡æ»¤æ‰è¡Œå·ç­‰å°æ•°å­—ï¼Œé€‰æ‹©åˆç†çš„é‡‘é¢
                                potential_amounts = []
                                for m in matches:
                                    try:
                                        num = float(m.replace(',', ''))
                                        # Siahuatçš„Dré‡‘é¢é€šå¸¸åœ¨10-10000ä¹‹é—´
                                        if 10 <= num <= 10000:
                                            potential_amounts.append(num)
                                    except ValueError:
                                        continue
                                
                                if potential_amounts:
                                    dr_amount = str(max(potential_amounts))
                                    print(f"ğŸ” DEBUG: Siahuat SOAä½¿ç”¨æ¨¡å¼ '{pattern}' æ‰¾åˆ°Dré‡‘é¡: {dr_amount}")
                                    break
                        
                        if dr_amount:
                            data[inv] = float(dr_amount)
                            print(f"ğŸ” DEBUG: SOAåŒ¹é… {inv} -> Dr ${dr_amount}")
            
            return data
            
        except Exception as e:
            print(f"ğŸ” DEBUG: Siahuat SOAæ•¸æ“šæå–å¤±æ•—: {e}")
            return {}
    
    def _perform_reconciliation(self):
        """åŸ·è¡Œæ ¸å°"""
        self._log("\n" + "="*60)
        self._log("ğŸ“Š æ ¸å°çµæœæ‘˜è¦ / Reconciliation Summary")
        self._log("="*60)
        
        matched = 0
        unmatched_invoice = 0
        unmatched_soa = 0
        
        # æ¯”å° Invoice å’Œ SOA æ•¸æ“š
        for inv_no, inv_amount in self.invoice_data.items():
            if inv_no in self.soa_data:
                soa_amount = self.soa_data[inv_no]
                if abs(inv_amount - soa_amount) < 0.01:  # å…è¨±å¾®å°å·®ç•°
                    self._log(f"âœ… {inv_no}: Invoice ${inv_amount:.2f} = SOA ${soa_amount:.2f}")
                    matched += 1
                else:
                    self._log(f"âš ï¸ {inv_no}: Invoice ${inv_amount:.2f} â‰  SOA ${soa_amount:.2f} (å·®ç•°: ${abs(inv_amount - soa_amount):.2f})")
                    matched += 1  # ä»ç„¶ç®—åŒ¹é…ï¼Œåªæ˜¯é‡‘é¡ä¸åŒ
            else:
                self._log(f"âŒ {inv_no}: åªåœ¨ Invoice ä¸­æ‰¾åˆ° (${inv_amount:.2f})")
                unmatched_invoice += 1
        
        # æ‰¾å‡ºåªåœ¨ SOA ä¸­çš„é …ç›®
        for inv_no, soa_amount in self.soa_data.items():
            if inv_no not in self.invoice_data:
                self._log(f"âŒ {inv_no}: åªåœ¨ SOA ä¸­æ‰¾åˆ° (${soa_amount:.2f})")
                unmatched_soa += 1
        
        # çµ±è¨ˆæ‘˜è¦
        self._log("\n" + "-"*40)
        self._log("ğŸ“ˆ çµ±è¨ˆæ‘˜è¦ / Statistics Summary")
        self._log("-"*40)
        self._log(f"âœ… åŒ¹é…é …ç›®: {matched}")
        self._log(f"âŒ åªåœ¨ Invoice: {unmatched_invoice}")
        self._log(f"âŒ åªåœ¨ SOA: {unmatched_soa}")
        self._log(f"ğŸ“Š ç¸½è¨ˆ: {matched + unmatched_invoice + unmatched_soa}")
        
        if matched > 0 and unmatched_invoice == 0 and unmatched_soa == 0:
            self._log("\nğŸ‰ æ ¸å°å®Œæˆï¼æ‰€æœ‰é …ç›®éƒ½åŒ¹é…æˆåŠŸï¼")
        else:
            self._log(f"\nâš ï¸ æ ¸å°å®Œæˆï¼Œç™¼ç¾ {unmatched_invoice + unmatched_soa} å€‹ä¸åŒ¹é…é …ç›®")
    
    def _clear_results(self):
        """æ¸…ç©ºçµæœ"""
        self.result_text.delete("1.0", "end")
        self.invoice_data = {}
        self.soa_data = {}
        self._log("ğŸ—‘ï¸ çµæœå·²æ¸…ç©º")
    
    def _log(self, message):
        """è¨˜éŒ„æ—¥èªŒåˆ°çµæœæ–‡æœ¬æ¡†"""
        from datetime import datetime
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_message = f"[{timestamp}] {message}\n"
        self.result_text.insert("end", log_message)
        self.result_text.see("end")
        print(log_message.strip())


# ============================================================================
# Monthend Consolidate çª—å£ / Monthend Consolidate Window
# ============================================================================


# ============================================================================
# æ—§çš„MonthendConsolidateWindowç±»å·²åˆ é™¤
# ç°åœ¨ä½¿ç”¨oriental_monthend.pyä¸­çš„OrientalMonthendWindowç±»
# ============================================================================

class SOAReconciliationUI(ctk.CTkFrame):
    """æœˆçµæª¢æŸ¥åŠŸèƒ½ç•Œé¢ - æ”¯æŒå¤šå» å•†çµ±ä¸€è™•ç†"""
    
    def __init__(self, master):
        super().__init__(master, fg_color='transparent')
        self.pdf_files = {}  # {å» å•†åç¨±: {path: pdfè·¯å¾‘, data: æå–çš„æ•¸æ“š}}
        self.excel_data = {}  # å­˜å‚¨Excelæ•°æ®
        self.config_data = {}  # å­˜å‚¨é…ç½®æ˜ å°„æ•°æ®
        self._build()
    
    def _build(self):
        """æ„å»ºOrientalæœˆçµæª¢æŸ¥ç•Œé¢"""
        # ä¸»è¦åŠŸèƒ½åŒºåŸŸ - æ·»åŠ æ¸å˜è¾¹æ¡†æ•ˆæœ
        main_frame = ctk.CTkFrame(self, fg_color=DARK_PANEL, corner_radius=20)
        main_frame.pack(fill="both", expand=True, padx=25, pady=(10, 15))
        
        # æ·»åŠ æ ‡é¢˜åŒºåŸŸ
        title_frame = ctk.CTkFrame(main_frame, fg_color='transparent')
        title_frame.pack(fill='x', padx=25, pady=(20, 25))
        
        ctk.CTkLabel(
            title_frame,
            text="ğŸŒŸ å¤šå» å•†æœˆçµæª¢æŸ¥ç³»çµ±",
            font=("Microsoft YaHei", 22, "bold"),
            text_color=ACCENT_GREEN
        ).pack(anchor='center')
        
        ctk.CTkLabel(
            title_frame,
            text="Multi-Vendor Month-End Check System",
            font=("Segoe UI", 14),
            text_color=TEXT_COLOR
        ).pack(anchor='center', pady=(5, 0))
        
        # å†…å®¹åŒºåŸŸ
        content_frame = ctk.CTkFrame(main_frame, fg_color='transparent')
        content_frame.pack(fill='both', expand=True, padx=25, pady=(0, 20))
        
        # å·¦ä¾§ï¼šæ–‡ä»¶é€‰æ‹©åŒºåŸŸ - æ·»åŠ å¡ç‰‡å¼è®¾è®¡
        left_frame = ctk.CTkFrame(content_frame, fg_color='transparent')
        left_frame.pack(side='left', fill='both', expand=True, padx=(0, 15))
        
        # PDFæ–‡ä»¶é€‰æ‹© - å¡ç‰‡å¼è®¾è®¡
        pdf_frame = ctk.CTkFrame(left_frame, fg_color=DARK_BG, corner_radius=15)
        pdf_frame.pack(fill='x', pady=(0, 20))
        
        # æ·»åŠ å›¾æ ‡å’Œæ ‡é¢˜
        pdf_header = ctk.CTkFrame(pdf_frame, fg_color='transparent')
        pdf_header.pack(fill='x', padx=20, pady=(15, 10))
        
        ctk.CTkLabel(
            pdf_header,
            text="ğŸ“„",
            font=("Segoe UI", 24)
        ).pack(side='left')
        
        ctk.CTkLabel(
            pdf_header,
            text="å¤šå» å•†PDFæ–‡ä»¶ / Multi-Vendor PDF Files",
            font=("Microsoft YaHei", 16, "bold"),
            text_color=ACCENT_GREEN
        ).pack(side='left', padx=(10, 0))
        
        # å‰µå»ºä¸‰å€‹å» å•†çš„PDFé¸æ“‡å€åŸŸ
        self.pdf_widgets = {}
        vendors = [
            ("Oriental", "ğŸœ", "#10b981"),
            ("Aries Fresh", "ğŸ¥¬", "#059669"), 
            ("Ever-Shine", "âœ¨", "#3b82f6")  # è—è‰²ï¼Œè¡¨ç¤ºå•Ÿç”¨
        ]
        
        for vendor, icon, color in vendors:
            vendor_frame = ctk.CTkFrame(pdf_frame, fg_color='transparent')
            vendor_frame.pack(fill='x', padx=20, pady=(5, 10))
            
            # å» å•†æ¨™ç±¤
            vendor_label_frame = ctk.CTkFrame(vendor_frame, fg_color='transparent')
            vendor_label_frame.pack(fill='x', pady=(0, 5))
            
            ctk.CTkLabel(
                vendor_label_frame,
                text=f"{icon} {vendor}",
                font=("Microsoft YaHei", 12, "bold"),
                text_color=color
            ).pack(side='left')
            
            # PDFé¸æ“‡æ§ä»¶
            pdf_input_frame = ctk.CTkFrame(vendor_frame, fg_color='transparent')
            pdf_input_frame.pack(fill='x')
            
            path_var = ctk.StringVar()
            entry = ctk.CTkEntry(
                pdf_input_frame,
                textvariable=path_var,
                placeholder_text=f"é¸æ“‡ {vendor} PDFæ–‡ä»¶",
                font=FONT_SMALL,
                height=30,
                corner_radius=6
            )
            entry.pack(side='left', fill='x', expand=True)
            
            browse_btn = ctk.CTkButton(
                pdf_input_frame,
                text="ç€è¦½\nBrowse",
                command=lambda v=vendor: self._browse_vendor_pdf(v),
                width=70,
                height=45,  # å¢åŠ é«˜åº¦ä»¥é©æ‡‰é›™è¡Œæ–‡æœ¬
                font=FONT_SMALL,
                corner_radius=6,
                fg_color=color,
                hover_color=color
            )
            browse_btn.pack(side='left', padx=(5, 0))
            
            extract_btn = ctk.CTkButton(
                pdf_input_frame,
                text="æå–\nExtract",
                command=lambda v=vendor: self._extract_vendor_pdf(v),
                width=70,
                height=45,  # å¢åŠ é«˜åº¦ä»¥é©æ‡‰é›™è¡Œæ–‡æœ¬
                font=FONT_SMALL,
                corner_radius=6,
                fg_color=ACCENT_BLUE,
                hover_color="#2563eb"
            )
            extract_btn.pack(side='left', padx=(5, 0))
            
            # å„²å­˜æ§ä»¶å¼•ç”¨
            self.pdf_widgets[vendor] = {
                'path_var': path_var,
                'entry': entry,
                'browse_btn': browse_btn,
                'extract_btn': extract_btn,
                'enabled': True  # æ‰€æœ‰å» å•†éƒ½å•Ÿç”¨
            }
            
            # æ‰€æœ‰å» å•†éƒ½å•Ÿç”¨
            # if vendor == "Ever-Shine":
            #     entry.configure(state="disabled")
            #     browse_btn.configure(state="disabled")
            #     extract_btn.configure(state="disabled")
        
        # Consolidate Excelæ–‡ä»¶é€‰æ‹© - å¡ç‰‡å¼è®¾è®¡
        excel_frame = ctk.CTkFrame(left_frame, fg_color=DARK_BG, corner_radius=15)
        excel_frame.pack(fill='x', pady=(0, 20))
        
        excel_header = ctk.CTkFrame(excel_frame, fg_color='transparent')
        excel_header.pack(fill='x', padx=20, pady=(15, 10))
        
        ctk.CTkLabel(
            excel_header,
            text="ğŸ“Š",
            font=("Segoe UI", 24)
        ).pack(side='left')
        
        ctk.CTkLabel(
            excel_header,
            text="Consolidate Excel\nåˆä½µExcelæ–‡ä»¶",
            font=("Microsoft YaHei", 16, "bold"),
            text_color=ACCENT_BLUE
        ).pack(side='left', padx=(10, 0))
        
        excel_file_frame = ctk.CTkFrame(excel_frame, fg_color='transparent')
        excel_file_frame.pack(fill='x', padx=20, pady=(0, 15))
        
        self.excel_path_var = ctk.StringVar()
        ctk.CTkEntry(
            excel_file_frame,
            textvariable=self.excel_path_var,
            placeholder_text="é¸æ“‡Consolidate Excelæ–‡ä»¶ / Select Consolidate Excel file",
            font=FONT_MID,
            height=35,
            corner_radius=8
        ).pack(side='left', fill='x', expand=True)
        
        ctk.CTkButton(
            excel_file_frame,
            text="ç€è¦½\nBrowse",
            command=self._browse_excel,
            fg_color=ACCENT_BLUE,
            hover_color=BTN_HOVER,
            font=FONT_MID,
            width=80,
            height=45,  # å¢åŠ é«˜åº¦ä»¥é©æ‡‰é›™è¡Œæ–‡æœ¬
            corner_radius=8
        ).pack(side='right', padx=(10, 0))
        
        # Excelæ™ºèƒ½è®€å–æŒ‰éˆ•
        excel_read_frame = ctk.CTkFrame(excel_frame, fg_color='transparent')
        excel_read_frame.pack(fill='x', padx=20, pady=(0, 15))
        
        ctk.CTkButton(
            excel_read_frame,
            text="ğŸ“Š æ™ºèƒ½è®€å–Excel\nSmart Read Excel",
            command=self._read_excel_smart_ui,
            fg_color=ACCENT_BLUE,
            hover_color=BTN_HOVER,
            font=FONT_MID,
            height=55,  # å¢åŠ é«˜åº¦ä»¥é©æ‡‰é›™è¡Œæ–‡æœ¬
            corner_radius=12
        ).pack(fill='x')
        
        # Config Excelæ–‡ä»¶é€‰æ‹© - å¡ç‰‡å¼è®¾è®¡
        config_frame = ctk.CTkFrame(left_frame, fg_color=DARK_BG, corner_radius=15)
        config_frame.pack(fill='x', pady=(0, 25))
        
        config_header = ctk.CTkFrame(config_frame, fg_color='transparent')
        config_header.pack(fill='x', padx=20, pady=(15, 10))
        
        ctk.CTkLabel(
            config_header,
            text="âš™ï¸",
            font=("Segoe UI", 24)
        ).pack(side='left')
        
        ctk.CTkLabel(
            config_header,
            text="Config Excel\né…ç½®Excelæ–‡ä»¶",
            font=("Microsoft YaHei", 16, "bold"),
            text_color=ACCENT_PURPLE
        ).pack(side='left', padx=(10, 0))
        
        config_file_frame = ctk.CTkFrame(config_frame, fg_color='transparent')
        config_file_frame.pack(fill='x', padx=20, pady=(0, 15))
        
        self.config_path_var = ctk.StringVar()
        ctk.CTkEntry(
            config_file_frame,
            textvariable=self.config_path_var,
            placeholder_text="é¸æ“‡Config Excelæ–‡ä»¶ / Select Config Excel file",
            font=FONT_MID,
            height=35,
            corner_radius=8
        ).pack(side='left', fill='x', expand=True)
        
        ctk.CTkButton(
            config_file_frame,
            text="ç€è¦½\nBrowse",
            command=self._browse_config,
            fg_color=ACCENT_PURPLE,
            hover_color=BTN_HOVER,
            font=FONT_MID,
            width=80,
            height=45,  # å¢åŠ é«˜åº¦ä»¥é©æ‡‰é›™è¡Œæ–‡æœ¬
            corner_radius=8
        ).pack(side='right', padx=(10, 0))
        
        # åŠŸèƒ½æŒ‰é’®åŒºåŸŸ - ç¾åŒ–æŒ‰é’®è®¾è®¡
        button_frame = ctk.CTkFrame(left_frame, fg_color='transparent')
        button_frame.pack(fill='x', pady=(0, 20))
        
        # åŒ¹é…å¹¶æ›´æ–°/å¯¹æ¯”æŒ‰é’®
        compare_btn = ctk.CTkButton(
            button_frame,
            text="ğŸ”„ å¤šå» å•†åŒ¹é…å°æ¯”\nMulti-Vendor Match & Compare",
            command=self._update_and_compare_ui,
            fg_color=ACCENT_RED,
            hover_color=BTN_HOVER,
            font=FONT_MID,
            height=55,  # å¢åŠ é«˜åº¦ä»¥é©æ‡‰é›™è¡Œæ–‡æœ¬
            corner_radius=12
        )
        compare_btn.pack(fill='x', pady=(0, 0))
        
        # å³ä¾§ï¼šæ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ - ç¾åŒ–æ ‡ç­¾é¡µå’Œæ—¥å¿—åŒºåŸŸ
        right_frame = ctk.CTkFrame(content_frame, fg_color='transparent')
        right_frame.pack(side='right', fill='both', expand=True, padx=(15, 0))
        
        # æ—¥å¿—æ ‡é¢˜
        log_title = ctk.CTkLabel(
            right_frame,
            text="ğŸ“‹ æ“ä½œæ—¥èªŒ / Operation Logs",
            font=("Microsoft YaHei", 18, "bold"),
            text_color=ACCENT_BLUE
        )
        log_title.pack(anchor='w', pady=(0, 15))
        
        # æ ‡ç­¾é¡µ - ç¾åŒ–è®¾è®¡
        self.tabview = ctk.CTkTabview(right_frame, fg_color=DARK_BG, corner_radius=15)
        self.tabview.pack(fill="both", expand=True)
        
        # æ“ä½œæ—¥å¿—æ ‡ç­¾é¡µ
        self.tabview.add("ğŸ“ æ“ä½œæ—¥èªŒ\nOperation Log")
        self.operation_log = ctk.CTkTextbox(
            self.tabview.tab("ğŸ“ æ“ä½œæ—¥èªŒ\nOperation Log"),
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            font=FONT_LOG,
            corner_radius=10
        )
        self.operation_log.pack(fill="both", expand=True, padx=15, pady=15)
        
        # å¯¹æ¯”æ—¥å¿—æ ‡ç­¾é¡µ
        self.tabview.add("ğŸ” å°æ¯”æ—¥èªŒ\nComparison Log")
        self.comparison_log = ctk.CTkTextbox(
            self.tabview.tab("ğŸ” å°æ¯”æ—¥èªŒ\nComparison Log"),
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            font=FONT_LOG,
            corner_radius=10
        )
        self.comparison_log.pack(fill="both", expand=True, padx=15, pady=15)
        
        # æ¸…ç©ºæ—¥å¿—æŒ‰é’® - ç¾åŒ–è®¾è®¡
        clear_button = ctk.CTkButton(
            right_frame,
            text="ğŸ§¹ æ¸…ç©ºæ—¥èªŒ\nClear Logs",
            command=self._clear_logs,
            fg_color=ACCENT_ORANGE,
            hover_color=BTN_HOVER,
            font=FONT_MID,
            height=35,
            corner_radius=10
        )
        clear_button.pack(side='bottom', pady=(15, 0))
        
        # æ·»åŠ æ•¸æ“šé¡¯ç¤ºå€åŸŸï¼ˆèˆ‡pdf_extractor_ui_simple.pyç›¸åŒçš„æ ¼å¼ï¼‰
        data_frame = ctk.CTkFrame(content_frame, fg_color='transparent')
        data_frame.pack(fill='both', expand=True, pady=(20, 0))
        
        # æ•¸æ“šé¡¯ç¤ºæ¨™é¡Œ
        data_title = ctk.CTkLabel(
            data_frame,
            text="ğŸ“Š æ•¸æ“šé¡¯ç¤º / Data Display",
            font=("Microsoft YaHei", 18, "bold"),
            text_color=ACCENT_GREEN
        )
        data_title.pack(anchor='w', pady=(0, 15))
        
        # å‰µå»ºæ¨™ç±¤é å€åŸŸ
        self._create_results_table(data_frame)
    
    def _create_results_table(self, parent):
        """å‰µå»ºèˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„æ¨™ç±¤é æ ¼å¼"""
        # å‰µå»ºæ¨™ç±¤é æ§ä»¶
        self.notebook = ctk.CTkTabview(parent, fg_color=DARK_BG, corner_radius=15)
        self.notebook.pack(fill="both", expand=True, pady=10)
        
        # å‰µå»ºå„å€‹æ¨™ç±¤é 
        self._create_key_data_tab()
        self._create_invoices_tab()
        self._create_excel_data_tab()
        self._create_details_tab()
        self._create_raw_text_tab()
        self._create_compare_log_tab()
    
    def _create_key_data_tab(self):
        """å‰µå»ºé—œéµæ•¸æ“šæ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„æ ¼å¼"""
        # CTkTabview çš„èªæ³•ï¼šå…ˆ addï¼Œå†è¨­ç½® text
        tab_name = "é—œéµæ•¸æ“š\nKey Data"
        self.notebook.add(tab_name)
        frame = self.notebook.tab(tab_name)
        
        # å‰µå»ºæ¨¹å½¢è¦–åœ–
        import tkinter.ttk as ttk
        columns = ('é–€å¸‚åç¨±', 'è³¬é½¡é‡‘é¡', 'ç™¼ç¥¨æ•¸é‡', 'è¡Œè™Ÿ')
        self.key_data_tree = ttk.Treeview(frame, columns=columns, show='headings', height=15)
        
        # è¨­ç½®åˆ—æ¨™é¡Œ
        for col in columns:
            self.key_data_tree.heading(col, text=col)
            self.key_data_tree.column(col, width=150)
        
        # æ·»åŠ æ»¾å‹•æ¢
        scrollbar = ttk.Scrollbar(frame, orient='vertical', command=self.key_data_tree.yview)
        self.key_data_tree.configure(yscrollcommand=scrollbar.set)
        
        # å¸ƒå±€
        self.key_data_tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def _create_invoices_tab(self):
        """å‰µå»ºç™¼ç¥¨ä¿¡æ¯æ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„æ ¼å¼"""
        tab_name = "ç™¼ç¥¨ä¿¡æ¯\nInvoice Information"
        self.notebook.add(tab_name)
        frame = self.notebook.tab(tab_name)
        
        # å‰µå»ºæ¨¹å½¢è¦–åœ–
        import tkinter.ttk as ttk
        columns = ('é–€å¸‚åç¨±', 'æ—¥æœŸ', 'ç™¼ç¥¨è™Ÿ', 'é‡‘é¡', 'é¤˜é¡', 'è³¬é½¡é‡‘é¡')
        self.invoices_tree = ttk.Treeview(frame, columns=columns, show='headings', height=15)
        
        # è¨­ç½®åˆ—æ¨™é¡Œ
        for col in columns:
            self.invoices_tree.heading(col, text=col)
            if col in ['é‡‘é¡', 'é¤˜é¡', 'è³¬é½¡é‡‘é¡']:
                self.invoices_tree.column(col, width=100)
            else:
                self.invoices_tree.column(col, width=120)
        
        # æ·»åŠ æ»¾å‹•æ¢
        scrollbar = ttk.Scrollbar(frame, orient='vertical', command=self.invoices_tree.yview)
        self.invoices_tree.configure(yscrollcommand=scrollbar.set)
        
        # å¸ƒå±€
        self.invoices_tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def _create_excel_data_tab(self):
        """å‰µå»ºExcelæ•¸æ“šæ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„æ ¼å¼"""
        tab_name = "Excelæ•¸æ“š\nExcel Data"
        self.notebook.add(tab_name)
        frame = self.notebook.tab(tab_name)
        
        # å‰µå»ºæ¨¹å½¢è¦–åœ–
        import tkinter.ttk as ttk
        columns = ('é–€å¸‚åç¨±', 'è¡Œè™Ÿ', 'æ—¥æœŸ', 'é‡‘é¡')
        self.excel_data_tree = ttk.Treeview(frame, columns=columns, show='headings', height=15)
        
        # è¨­ç½®åˆ—æ¨™é¡Œ
        for col in columns:
            self.excel_data_tree.heading(col, text=col)
            if col == 'é‡‘é¡':
                self.excel_data_tree.column(col, width=100)
            else:
                self.excel_data_tree.column(col, width=120)
        
        # æ·»åŠ æ»¾å‹•æ¢
        scrollbar = ttk.Scrollbar(frame, orient='vertical', command=self.excel_data_tree.yview)
        self.excel_data_tree.configure(yscrollcommand=scrollbar.set)
        
        # å¸ƒå±€
        self.excel_data_tree.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def _create_details_tab(self):
        """å‰µå»ºè©³ç´°ä¿¡æ¯æ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„æ ¼å¼"""
        tab_name = "è©³ç´°ä¿¡æ¯\nDetailed Information"
        self.notebook.add(tab_name)
        frame = self.notebook.tab(tab_name)
        
        # å‰µå»ºæ–‡æœ¬å€åŸŸ
        self.details_text = ctk.CTkTextbox(
            frame, 
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            font=FONT_LOG,
            corner_radius=10
        )
        
        # æ·»åŠ æ»¾å‹•æ¢
        scrollbar = ctk.CTkScrollbar(frame, command=self.details_text.yview)
        self.details_text.configure(yscrollcommand=scrollbar.set)
        
        # å¸ƒå±€
        self.details_text.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def _create_raw_text_tab(self):
        """å‰µå»ºåŸå§‹æ–‡æœ¬æ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„æ ¼å¼"""
        tab_name = "åŸå§‹æ–‡æœ¬\nRaw Text"
        self.notebook.add(tab_name)
        frame = self.notebook.tab(tab_name)
        
        # å‰µå»ºæ–‡æœ¬å€åŸŸ
        self.raw_text = ctk.CTkTextbox(
            frame, 
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            font=FONT_LOG,
            corner_radius=10
        )
        
        # æ·»åŠ æ»¾å‹•æ¢
        scrollbar = ctk.CTkScrollbar(frame, command=self.raw_text.yview)
        self.raw_text.configure(yscrollcommand=scrollbar.set)
        
        # å¸ƒå±€
        self.raw_text.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    
    def _create_compare_log_tab(self):
        """å‰µå»ºå°æ¯”æ—¥èªŒæ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„æ ¼å¼"""
        tab_name = "å°æ¯”æ—¥èªŒ\nComparison Log"
        self.notebook.add(tab_name)
        frame = self.notebook.tab(tab_name)
        
        # å‰µå»ºæ–‡æœ¬å€åŸŸ
        self.compare_log = ctk.CTkTextbox(
            frame, 
            fg_color=TEXTBOX_BG,
            text_color=TEXT_COLOR,
            font=FONT_LOG,
            corner_radius=10
        )
        
        # æ·»åŠ æ»¾å‹•æ¢
        scrollbar = ctk.CTkScrollbar(frame, command=self.compare_log.yview)
        self.compare_log.configure(yscrollcommand=scrollbar.set)
        
        # å¸ƒå±€
        self.compare_log.pack(side='left', fill='both', expand=True)
        scrollbar.pack(side='right', fill='y')
    

    
    def _browse_vendor_pdf(self, vendor):
        """ç€è¦½ç‰¹å®šå» å•†çš„PDFæ–‡ä»¶"""
        file_path = filedialog.askopenfilename(
            title=f"é¸æ“‡ {vendor} PDFæ–‡ä»¶",
            filetypes=[("PDF files", "*.pdf"), ("All files", "*.*")]
        )
        if file_path:
            self.pdf_widgets[vendor]['path_var'].set(file_path)
            # åˆå§‹åŒ–PDFæ–‡ä»¶æ•¸æ“šçµæ§‹
            if vendor not in self.pdf_files:
                self.pdf_files[vendor] = {'path': '', 'data': None}
            self.pdf_files[vendor]['path'] = file_path
    
    def _extract_vendor_pdf(self, vendor):
        """æå–ç‰¹å®šå» å•†çš„PDFæ•¸æ“š"""
        if vendor not in self.pdf_widgets:
            self._log(f"âŒ å» å•† {vendor} ä¸å­˜åœ¨")
            return
            
        if not self.pdf_widgets[vendor]['enabled']:
            self._log(f"âŒ å» å•† {vendor} æš«æ™‚ä¸æ”¯æ´")
            return
            
        pdf_path = self.pdf_widgets[vendor]['path_var'].get().strip()
        if not pdf_path:
            self._log(f"âŒ è«‹å…ˆé¸æ“‡ {vendor} PDFæ–‡ä»¶")
            return
            
        self._log(f"ğŸ” é–‹å§‹æå– {vendor} PDFæ•¸æ“š...")
        
        try:
            if vendor == "Oriental":
                pdf_data = self._extract_oriental_pdf(pdf_path)
            elif vendor == "Aries Fresh":
                pdf_data = self._extract_aries_fresh_pdf(pdf_path)
            elif vendor == "Ever-Shine":
                pdf_data = self._extract_evershine_pdf(pdf_path)
            else:
                self._log(f"âŒ ä¸æ”¯æŒçš„å» å•†: {vendor}")
                return
                
            if pdf_data and isinstance(pdf_data, dict):
                self.pdf_files[vendor] = {'path': pdf_path, 'data': pdf_data}
                self._log(f"âœ… {vendor} PDFæ•¸æ“šæå–å®Œæˆï¼")
                self._log(f"ğŸª ç™¼ç¾ {len(pdf_data.get('outlets', []))} å€‹é–€å¸‚")
                self._log(f"ğŸ“„ ç™¼ç¾ {len(pdf_data.get('invoices', []))} å¼µç™¼ç¥¨")
                
                # æ›´æ–°å°æ‡‰æ¨™ç±¤é 
                self._update_all_tabs()
            else:
                self._log(f"âŒ {vendor} PDFæ•¸æ“šæå–å¤±æ•—")
                
        except Exception as e:
            self._log(f"âŒ {vendor} PDFæå–å¤±æ•—: {str(e)}")
    
    def _browse_pdf(self):
        """èˆŠçš„æµè§ˆPDFæ–‡ä»¶æ–¹æ³• - ä¿ç•™å‘å¾Œå…¼å®¹"""
        self._browse_vendor_pdf("Oriental")
    
    def _browse_excel(self):
        """æµè§ˆConsolidate Excelæ–‡ä»¶"""
        file_path = filedialog.askopenfilename(
            title="é¸æ“‡Consolidate Excelæ–‡ä»¶ / Select Consolidate Excel file",
            filetypes=[("Excel files", "*.xlsx *.xls"), ("All files", "*.*")]
        )
        if file_path:
            self.excel_path_var.set(file_path)
    
    def _browse_config(self):
        """æµè§ˆConfig Excelæ–‡ä»¶"""
        file_path = filedialog.askopenfilename(
            title="é¸æ“‡Config Excelæ–‡ä»¶ / Select Config Excel file",
            filetypes=[("Excel files", "*.xlsx *.xls"), ("All files", "*.*")]
        )
        if file_path:
            self.config_path_var.set(file_path)
    

    
    def _update_all_tabs(self):
        """æ›´æ–°æ‰€æœ‰æ¨™ç±¤é æ•¸æ“š - æ”¯æŒå¤šå» å•†æ•¸æ“šåˆä½µé¡¯ç¤º"""
        # æ¸…ç©ºæ‰€æœ‰æ¨™ç±¤é 
        self._clear_all_tabs()
        
        # åˆä½µæ‰€æœ‰å» å•†çš„æ•¸æ“šä¾†é¡¯ç¤º
        all_outlets = []
        all_invoices = []
        all_raw_text = []
        
        for vendor, data_info in self.pdf_files.items():
            if 'data' in data_info:
                pdf_data = data_info['data']
                
                # æ”¶é›†é–€å¸‚æ•¸æ“šï¼ˆæ·»åŠ å» å•†æ¨™è­˜ï¼‰
                for outlet in pdf_data.get('outlets', []):
                    outlet_copy = outlet.copy()
                    outlet_copy['vendor'] = vendor
                    all_outlets.append(outlet_copy)
                
                # æ”¶é›†ç™¼ç¥¨æ•¸æ“šï¼ˆæ·»åŠ å» å•†æ¨™è­˜ï¼‰
                for invoice in pdf_data.get('invoices', []):
                    invoice_copy = invoice.copy()
                    invoice_copy['vendor'] = vendor
                    all_invoices.append(invoice_copy)
                
                # æ”¶é›†åŸå§‹æ–‡æœ¬
                raw_text = pdf_data.get('raw_text', '')
                if raw_text:
                    all_raw_text.append(f"=== {vendor} ===\n{raw_text}")
        
        # æ›´æ–°å„å€‹æ¨™ç±¤é 
        self._update_key_data_tab_multi(all_outlets)
        self._update_invoices_tab_multi(all_invoices)
        self._update_details_tab_multi()
        self._update_raw_text_tab_multi(all_raw_text)
    
    def _clear_all_tabs(self):
        """æ¸…ç©ºæ‰€æœ‰æ¨™ç±¤é æ•¸æ“š"""
        # æ¸…ç©ºé—œéµæ•¸æ“š
        for item in self.key_data_tree.get_children():
            self.key_data_tree.delete(item)
        
        # æ¸…ç©ºç™¼ç¥¨ä¿¡æ¯
        for item in self.invoices_tree.get_children():
            self.invoices_tree.delete(item)
        
        # æ¸…ç©ºè©³ç´°ä¿¡æ¯
        self.details_text.delete("0.0", "end")
        
        # æ¸…ç©ºåŸå§‹æ–‡æœ¬
        self.raw_text.delete("0.0", "end")
    
    def _update_key_data_tab_multi(self, all_outlets):
        """æ›´æ–°é—œéµæ•¸æ“šæ¨™ç±¤é  - å¤šå» å•†ç‰ˆæœ¬"""
        for outlet in all_outlets:
            # è¨ˆç®—è©²é–€å¸‚çš„ç™¼ç¥¨æ•¸é‡
            vendor = outlet.get('vendor', 'Unknown')
            invoice_count = 0
            if vendor in self.pdf_files and 'data' in self.pdf_files[vendor]:
                invoice_count = len([inv for inv in self.pdf_files[vendor]['data'].get('invoices', []) 
                                   if inv.get('outlet_name') == outlet['name']])
            
            self.key_data_tree.insert('', 'end', values=(
                f"[{vendor}] {outlet['name']}",
                f"${outlet['aging_amount']:.2f}",
                invoice_count,
                outlet.get('location', 'N/A')
            ))
    
    def _update_invoices_tab_multi(self, all_invoices):
        """æ›´æ–°ç™¼ç¥¨ä¿¡æ¯æ¨™ç±¤é  - å¤šå» å•†ç‰ˆæœ¬"""
        for invoice in all_invoices:
            vendor = invoice.get('vendor', 'Unknown')
            self.invoices_tree.insert('', 'end', values=(
                f"[{vendor}] {invoice.get('outlet_name', 'N/A')}",
                invoice.get('date', 'N/A'),
                invoice.get('invoice_no', 'N/A'),
                f"${invoice.get('amount', 0):.2f}",
                f"${invoice.get('balance', 0):.2f}" if invoice.get('balance') else 'N/A',
                f"${invoice.get('outlet_aging_amount', 0):.2f}"
            ))
    
    def _update_details_tab_multi(self):
        """æ›´æ–°è©³ç´°ä¿¡æ¯æ¨™ç±¤é  - å¤šå» å•†ç‰ˆæœ¬"""
        details = f"å¤šå» å•†PDFæ•¸æ“šæ‘˜è¦\n"
        details += "="*50 + "\n\n"
        
        total_outlets = 0
        total_invoices = 0
        total_amount = 0.0
        
        for vendor, data_info in self.pdf_files.items():
            if 'data' in data_info:
                pdf_data = data_info['data']
                vendor_outlets = len(pdf_data.get('outlets', []))
                vendor_invoices = len(pdf_data.get('invoices', []))
                vendor_amount = sum(inv['amount'] for inv in pdf_data.get('invoices', []) if inv.get('amount'))
                
                details += f"ğŸ“‹ {vendor}:\n"
                details += f"  é–€å¸‚æ•¸: {vendor_outlets}\n"
                details += f"  ç™¼ç¥¨æ•¸: {vendor_invoices}\n"
                details += f"  ç¸½é‡‘é¡: ${vendor_amount:.2f}\n\n"
                
                total_outlets += vendor_outlets
                total_invoices += vendor_invoices
                total_amount += vendor_amount
        
        details += "-" * 30 + "\n"
        details += f"ğŸ“Š ç¸½è¨ˆ:\n"
        details += f"  ç¸½é–€å¸‚æ•¸: {total_outlets}\n"
        details += f"  ç¸½ç™¼ç¥¨æ•¸: {total_invoices}\n"
        details += f"  ç¸½é‡‘é¡: ${total_amount:.2f}\n"
        if total_invoices > 0:
            details += f"  å¹³å‡ç™¼ç¥¨é‡‘é¡: ${total_amount/total_invoices:.2f}\n"
        
        self.details_text.insert("0.0", details)
    
    def _update_raw_text_tab_multi(self, all_raw_text):
        """æ›´æ–°åŸå§‹æ–‡æœ¬æ¨™ç±¤é  - å¤šå» å•†ç‰ˆæœ¬"""
        combined_text = "\n\n".join(all_raw_text)
        self.raw_text.insert("0.0", combined_text)
    
    def _update_key_data_tab(self):
        """æ›´æ–°é—œéµæ•¸æ“šæ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        if not self.pdf_data or 'outlets' not in self.pdf_data:
            return
        
        # æ¸…ç©ºç¾æœ‰æ•¸æ“š
        for item in self.key_data_tree.get_children():
            self.key_data_tree.delete(item)
        
        # æ·»åŠ æ–°æ•¸æ“š
        for outlet in self.pdf_data['outlets']:
            # è¨ˆç®—è©²é–€å¸‚çš„ç™¼ç¥¨æ•¸é‡
            invoice_count = len([inv for inv in self.pdf_data.get('invoices', []) 
                               if inv.get('outlet_name') == outlet['name']])
            
            self.key_data_tree.insert('', 'end', values=(
                outlet['name'],
                f"${outlet['aging_amount']:.2f}",
                invoice_count,
                outlet['line_number']
            ))
    
    def _update_invoices_tab(self):
        """æ›´æ–°ç™¼ç¥¨ä¿¡æ¯æ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        if not self.pdf_data or 'invoices' not in self.pdf_data:
            return
        
        # æ¸…ç©ºç¾æœ‰æ•¸æ“š
        for item in self.invoices_tree.get_children():
            self.invoices_tree.delete(item)
        
        # æ·»åŠ æ–°æ•¸æ“š
        for invoice in self.pdf_data['invoices']:
            self.invoices_tree.insert('', 'end', values=(
                invoice.get('outlet_name', 'N/A'),
                invoice.get('date', 'N/A'),
                invoice.get('invoice_no', 'N/A'),
                f"${invoice.get('amount', 0):.2f}",
                f"${invoice.get('balance', 0):.2f}" if invoice.get('balance') else 'N/A',
                f"${invoice.get('outlet_aging_amount', 0):.2f}"
            ))
    
    def _update_details_tab(self):
        """æ›´æ–°è©³ç´°ä¿¡æ¯æ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        if not self.pdf_data:
            return
        
        # æ¸…ç©ºç¾æœ‰å…§å®¹
        self.details_text.delete("0.0", "end")
        
        # æ·»åŠ æ‘˜è¦ä¿¡æ¯
        details = f"PDFæ•¸æ“šæ‘˜è¦\n"
        details += "="*50 + "\n\n"
        details += f"é–€å¸‚ç¸½æ•¸: {len(self.pdf_data.get('outlets', []))}\n"
        details += f"ç™¼ç¥¨ç¸½æ•¸: {len(self.pdf_data.get('invoices', []))}\n"
        
        if 'invoices' in self.pdf_data and self.pdf_data['invoices']:
            total_amount = sum(inv['amount'] for inv in self.pdf_data['invoices'] if inv['amount'])
            avg_amount = total_amount / len(self.pdf_data['invoices']) if self.pdf_data['invoices'] else 0
            details += f"ç™¼ç¥¨ç¸½é‡‘é¡: ${total_amount:.2f}\n"
            details += f"å¹³å‡ç™¼ç¥¨é‡‘é¡: ${avg_amount:.2f}\n"
        
        details += "\né–€å¸‚è©³ç´°ä¿¡æ¯:\n"
        details += "-" * 30 + "\n"
        
        for outlet in self.pdf_data.get('outlets', []):
            details += f"é–€å¸‚: {outlet['name']}\n"
            details += f"  è³¬é½¡é‡‘é¡: ${outlet['aging_amount']:.2f}\n"
            details += f"  è¡Œè™Ÿ: {outlet['line_number']}\n"
            details += f"  å®Œæ•´åç¨±: {outlet['full_name']}\n\n"
        
        self.details_text.insert("0.0", details)
    
    def _update_excel_data_tab(self):
        """æ›´æ–°Excelæ•¸æ“šæ¨™ç±¤é  - æ”¯æŒå¤šå» å•†"""
        if not self.excel_data:
            return
        
        # æ¸…ç©ºç¾æœ‰æ•¸æ“š
        for item in self.excel_data_tree.get_children():
            self.excel_data_tree.delete(item)
        
        # è™•ç†å¤šå» å•†æ•¸æ“š
        if isinstance(self.excel_data, dict):
            # æ–°æ ¼å¼ï¼šå¤šå» å•†æ•¸æ“š {vendor: {outlets, dates, ...}}
            for vendor, vendor_data in self.excel_data.items():
                if 'outlets' in vendor_data and 'dates' in vendor_data:
                    for outlet in vendor_data['outlets']:
                        for date_info in vendor_data['dates']:
                            amount = outlet['daily_data'].get(date_info['date'], 0)
                            if amount > 0:  # åªé¡¯ç¤ºæœ‰é‡‘é¡çš„æ—¥æœŸ
                                self.excel_data_tree.insert('', 'end', values=(
                                    f"[{vendor}] {outlet['name']}",
                                    outlet['row'],
                                    date_info['date'],
                                    f"${amount:.2f}"
                                ))
        else:
            # èˆŠæ ¼å¼ï¼šå–®å» å•†æ•¸æ“šï¼ˆå‘å¾Œå…¼å®¹ï¼‰
            if 'outlets' in self.excel_data:
                for outlet in self.excel_data['outlets']:
                    for date_info in self.excel_data['dates']:
                        amount = outlet['daily_data'].get(date_info['date'], 0)
                        if amount > 0:  # åªé¡¯ç¤ºæœ‰é‡‘é¡çš„æ—¥æœŸ
                            self.excel_data_tree.insert('', 'end', values=(
                                outlet['name'],
                                outlet['row'],
                                date_info['date'],
                                f"${amount:.2f}"
                            ))
    
    def _update_raw_text_tab(self):
        """æ›´æ–°åŸå§‹æ–‡æœ¬æ¨™ç±¤é  - èˆ‡pdf_extractor_ui_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        if not self.pdf_data or 'raw_text' not in self.pdf_data:
            return
        
        # æ¸…ç©ºç¾æœ‰å…§å®¹
        self.raw_text.delete("0.0", "end")
        
        # æ·»åŠ åŸå§‹æ–‡æœ¬
        self.raw_text.insert("0.0", self.pdf_data['raw_text'])
    
    def _extract_oriental_pdf(self, pdf_path):
        """
        å¾Oriental PDFä¸­æå–é—œéµæ•¸æ“šï¼šé–€å¸‚åç¨±ã€ç™¼ç¥¨ä¿¡æ¯ã€è³¬é½¡é‡‘é¡
        å¤šé‡å‚™ç”¨æå–æ–¹æ³•ï¼špdfplumber -> PyPDF2 -> OCR
        """
        self._log(f"ğŸš€ é–‹å§‹æå–PDFé—œéµæ•¸æ“š: {pdf_path}")
        
        all_text = ""
        
        # æ–¹æ³•1: pdfplumber (ä¸»è¦æ–¹æ³•)
        try:
            import pdfplumber
            with pdfplumber.open(pdf_path) as pdf:
                self._log(f"ğŸ“„ PDFå·²æ‰“é–‹ï¼Œå…± {len(pdf.pages)} é ")
                
                for page_num, page in enumerate(pdf.pages, 1):
                    self._log(f"ğŸ“„ æ­£åœ¨è™•ç†ç¬¬ {page_num} é ...")
                    
                    page_text = page.extract_text()
                    if page_text:
                        all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                        self._log(f"âœ… ç¬¬ {page_num} é æå–æˆåŠŸï¼Œæ–‡æœ¬é•·åº¦: {len(page_text)} å­—ç¬¦")
                    else:
                        self._log(f"âš ï¸ ç¬¬ {page_num} é æ²’æœ‰æå–åˆ°æ–‡æœ¬")
                
                self._log(f"ğŸ“Š pdfplumber ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                
        except Exception as e:
            self._log(f"âš ï¸ pdfplumber æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœ pdfplumber æ²’æœ‰æå–åˆ°æ–‡æœ¬ï¼Œå˜—è©¦ PyPDF2
        if len(all_text.strip()) == 0:
            self._log("ğŸ”„ å˜—è©¦ä½¿ç”¨ PyPDF2 æå–...")
            try:
                import PyPDF2
                with open(pdf_path, 'rb') as file:
                    reader = PyPDF2.PdfReader(file)
                    for page_num, page in enumerate(reader.pages, 1):
                        page_text = page.extract_text()
                        if page_text:
                            all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                            self._log(f"âœ… PyPDF2 ç¬¬ {page_num} é æå–æˆåŠŸ")
                
                self._log(f"ğŸ“Š PyPDF2 ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                        
            except Exception as e:
                self._log(f"âš ï¸ PyPDF2 æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœ PyPDF2 ä¹Ÿæ²’æœ‰æå–åˆ°æ–‡æœ¬ï¼Œå˜—è©¦ OCR
        if len(all_text.strip()) == 0:
            self._log("ğŸ”„ å˜—è©¦ä½¿ç”¨ OCR æå–...")
            try:
                import fitz  # PyMuPDF
                import pytesseract
                from PIL import Image
                
                # æª¢æŸ¥ Tesseract æ˜¯å¦å¯ç”¨
                try:
                    pytesseract.get_tesseract_version()
                    self._log("âœ… Tesseract OCR å¯ç”¨")
                except:
                    self._log("âŒ Tesseract OCR ä¸å¯ç”¨ï¼Œè«‹å®‰è£ Tesseract")
                    raise Exception("Tesseract OCR ä¸å¯ç”¨")
                
                doc = fitz.open(pdf_path)
                for page_num, page in enumerate(doc, 1):
                    # å°‡é é¢è½‰æ›ç‚ºåœ–åƒ
                    pix = page.get_pixmap()
                    img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
                    
                    # ä½¿ç”¨ OCR æå–æ–‡æœ¬
                    page_text = pytesseract.image_to_string(img, lang='eng')
                    if page_text and page_text.strip():
                        all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                        self._log(f"âœ… OCR ç¬¬ {page_num} é æå–æˆåŠŸ")
                
                doc.close()
                self._log(f"ğŸ“Š OCR ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                        
            except Exception as e:
                self._log(f"âš ï¸ OCR æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—
        if len(all_text.strip()) == 0:
            self._log("âŒ æ‰€æœ‰ PDF æå–æ–¹æ³•éƒ½å¤±æ•—ï¼Œå¯èƒ½æ˜¯ï¼š")
            self._log("   1. PDF æ˜¯ç´”åœ–åƒæ ¼å¼ä¸” OCR ä¸å¯ç”¨")
            self._log("   2. PDF å·²åŠ å¯†æˆ–æå£")
            self._log("   3. PDF æ ¼å¼ä¸æ”¯æŒ")
            return {
                'outlets': [],
                'invoices': [],
                'raw_text': 'âŒ ç„¡æ³•æå– PDF æ–‡æœ¬å…§å®¹'
            }
        
        try:
            # è§£ææå–çš„é—œéµæ•¸æ“š
            key_data = self._parse_key_data(all_text)
            return key_data
                
        except Exception as e:
            self._log(f"âŒ æ•¸æ“šè§£æå¤±æ•—: {str(e)}")
            return {
                'outlets': [],
                'invoices': [],
                'raw_text': all_text
            }
    
    def _extract_aries_fresh_pdf(self, pdf_path):
        """
        å¾Aries Fresh PDFä¸­æå–é—œéµæ•¸æ“š
        å¤šé‡å‚™ç”¨æå–æ–¹æ³•ï¼špdfplumber -> PyPDF2 -> OCR
        """
        self._log(f"ğŸš€ é–‹å§‹æå–Aries Fresh PDFé—œéµæ•¸æ“š: {pdf_path}")
        
        all_text = ""
        
        # æ–¹æ³•1: pdfplumber (ä¸»è¦æ–¹æ³•)
        try:
            import pdfplumber
            with pdfplumber.open(pdf_path) as pdf:
                self._log(f"ğŸ“„ PDFå·²æ‰“é–‹ï¼Œå…± {len(pdf.pages)} é ")
                
                for page_num, page in enumerate(pdf.pages, 1):
                    self._log(f"ğŸ“„ æ­£åœ¨è™•ç†ç¬¬ {page_num} é ...")
                    
                    page_text = page.extract_text()
                    if page_text:
                        all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                        self._log(f"âœ… ç¬¬ {page_num} é æå–æˆåŠŸï¼Œæ–‡æœ¬é•·åº¦: {len(page_text)} å­—ç¬¦")
                    else:
                        self._log(f"âš ï¸ ç¬¬ {page_num} é æ²’æœ‰æå–åˆ°æ–‡æœ¬")
                
                self._log(f"ğŸ“Š pdfplumber ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                
        except Exception as e:
            self._log(f"âš ï¸ pdfplumber æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœ pdfplumber æ²’æœ‰æå–åˆ°æ–‡æœ¬ï¼Œå˜—è©¦ PyPDF2
        if len(all_text.strip()) == 0:
            self._log("ğŸ”„ å˜—è©¦ä½¿ç”¨ PyPDF2 æå–...")
            try:
                import PyPDF2
                with open(pdf_path, 'rb') as file:
                    reader = PyPDF2.PdfReader(file)
                    for page_num, page in enumerate(reader.pages, 1):
                        page_text = page.extract_text()
                        if page_text:
                            all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                            self._log(f"âœ… PyPDF2 ç¬¬ {page_num} é æå–æˆåŠŸ")
                
                self._log(f"ğŸ“Š PyPDF2 ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                        
            except Exception as e:
                self._log(f"âš ï¸ PyPDF2 æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœ PyPDF2 ä¹Ÿæ²’æœ‰æå–åˆ°æ–‡æœ¬ï¼Œå˜—è©¦ OCR
        if len(all_text.strip()) == 0:
            self._log("ğŸ”„ å˜—è©¦ä½¿ç”¨ OCR æå–...")
            try:
                import fitz  # PyMuPDF
                import pytesseract
                from PIL import Image
                
                # æª¢æŸ¥ Tesseract æ˜¯å¦å¯ç”¨
                try:
                    pytesseract.get_tesseract_version()
                    self._log("âœ… Tesseract OCR å¯ç”¨")
                except:
                    self._log("âŒ Tesseract OCR ä¸å¯ç”¨ï¼Œè«‹å®‰è£ Tesseract")
                    raise Exception("Tesseract OCR ä¸å¯ç”¨")
                
                doc = fitz.open(pdf_path)
                for page_num, page in enumerate(doc, 1):
                    # å°‡é é¢è½‰æ›ç‚ºåœ–åƒ
                    pix = page.get_pixmap()
                    img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
                    
                    # ä½¿ç”¨ OCR æå–æ–‡æœ¬
                    page_text = pytesseract.image_to_string(img, lang='eng')
                    if page_text and page_text.strip():
                        all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                        self._log(f"âœ… OCR ç¬¬ {page_num} é æå–æˆåŠŸ")
                
                doc.close()
                self._log(f"ğŸ“Š OCR ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                        
            except Exception as e:
                self._log(f"âš ï¸ OCR æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—
        if len(all_text.strip()) == 0:
            self._log("âŒ æ‰€æœ‰ PDF æå–æ–¹æ³•éƒ½å¤±æ•—")
            return {
                'outlets': [],
                'invoices': [],
                'raw_text': 'âŒ ç„¡æ³•æå– PDF æ–‡æœ¬å…§å®¹'
            }
        
        try:
            # è§£æAries Freshæ ¼å¼çš„é—œéµæ•¸æ“š
            key_data = self._parse_aries_fresh_data(all_text)
            return key_data
                
        except Exception as e:
            self._log(f"âŒ æ•¸æ“šè§£æå¤±æ•—: {str(e)}")
            return {
                'outlets': [],
                'invoices': [],
                'raw_text': all_text
            }
    
    def _parse_aries_fresh_data(self, text):
        """
        è§£æAries Freshæ ¼å¼çš„æ–‡æœ¬
        æ ¼å¼ï¼šCustomer Name: Sushi Express Group P/L(é–€å¸‚å)
              DATE Type Doc Number Debit Credit Balance
              Current 1 Month 2 Month 3 Month 4 Month 5 Month + Total
        """
        self._log("ğŸ” é–‹å§‹è§£æAries Freshé—œéµæ•¸æ“š...")
        
        # åˆå§‹åŒ–æ•¸æ“šçµæ§‹
        key_data = {
            'outlets': [],     # é–€å¸‚ä¿¡æ¯åˆ—è¡¨
            'invoices': [],    # ç™¼ç¥¨ä¿¡æ¯åˆ—è¡¨
            'raw_text': text   # åŸå§‹æ–‡æœ¬
        }
        
        # æŒ‰é åˆ†å‰²æ–‡æœ¬
        pages = text.split('--- ç¬¬')
        self._log(f"ğŸ“„ å…± {len(pages)-1} é ")  # ç¬¬ä¸€å€‹åˆ†å‰²é€šå¸¸æ˜¯ç©ºçš„
        
        for i, page_text in enumerate(pages):
            if not page_text.strip() or i == 0:
                continue
                
            # è§£æå–®é æ•¸æ“š
            page_data = self._parse_aries_fresh_page(page_text, i)
            if page_data:
                key_data['outlets'].append(page_data['outlet'])
                key_data['invoices'].extend(page_data['invoices'])
        
        self._log("âœ… Aries Freshé—œéµæ•¸æ“šè§£æå®Œæˆ")
        return key_data
    
    def _extract_evershine_pdf(self, pdf_path):
        """
        æå–Ever-Shine PDFä¸­çš„é—œéµæ•¸æ“š
        å¤šé‡å‚™ç”¨æå–æ–¹æ³•ï¼špdfplumber -> PyPDF2 -> OCR
        """
        self._log("ğŸ” é–‹å§‹è§£æEver-Shine PDF...")
        
        all_text = ""
        
        # æ–¹æ³•1: pdfplumber (ä¸»è¦æ–¹æ³•)
        try:
            import pdfplumber
            with pdfplumber.open(pdf_path) as pdf:
                self._log(f"ğŸ“„ PDFå·²æ‰“é–‹ï¼Œå…± {len(pdf.pages)} é ")
                
                for page_num, page in enumerate(pdf.pages, 1):
                    self._log(f"ğŸ“„ è™•ç†ç¬¬ {page_num} é ...")
                    
                    page_text = page.extract_text()
                    if page_text:
                        all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                        self._log(f"âœ… ç¬¬ {page_num} é æå–æˆåŠŸ")
                    else:
                        self._log(f"âš ï¸ ç¬¬ {page_num} é æ²’æœ‰æå–åˆ°æ–‡æœ¬")
                
                self._log(f"ğŸ“Š pdfplumber ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                
        except Exception as e:
            self._log(f"âš ï¸ pdfplumber æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœ pdfplumber æ²’æœ‰æå–åˆ°æ–‡æœ¬ï¼Œå˜—è©¦ PyPDF2
        if len(all_text.strip()) == 0:
            self._log("ğŸ”„ å˜—è©¦ä½¿ç”¨ PyPDF2 æå–...")
            try:
                import PyPDF2
                with open(pdf_path, 'rb') as file:
                    reader = PyPDF2.PdfReader(file)
                    for page_num, page in enumerate(reader.pages, 1):
                        page_text = page.extract_text()
                        if page_text:
                            all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                            self._log(f"âœ… PyPDF2 ç¬¬ {page_num} é æå–æˆåŠŸ")
                
                self._log(f"ğŸ“Š PyPDF2 ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                        
            except Exception as e:
                self._log(f"âš ï¸ PyPDF2 æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœ PyPDF2 ä¹Ÿæ²’æœ‰æå–åˆ°æ–‡æœ¬ï¼Œå˜—è©¦ OCR
        if len(all_text.strip()) == 0:
            self._log("ğŸ”„ å˜—è©¦ä½¿ç”¨ OCR æå–...")
            try:
                import fitz  # PyMuPDF
                import pytesseract
                from PIL import Image
                
                # æª¢æŸ¥ Tesseract æ˜¯å¦å¯ç”¨
                try:
                    pytesseract.get_tesseract_version()
                    self._log("âœ… Tesseract OCR å¯ç”¨")
                except:
                    self._log("âŒ Tesseract OCR ä¸å¯ç”¨ï¼Œè«‹å®‰è£ Tesseract")
                    raise Exception("Tesseract OCR ä¸å¯ç”¨")
                
                doc = fitz.open(pdf_path)
                for page_num, page in enumerate(doc, 1):
                    # å°‡é é¢è½‰æ›ç‚ºåœ–åƒ
                    pix = page.get_pixmap()
                    img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
                    
                    # ä½¿ç”¨ OCR æå–æ–‡æœ¬
                    page_text = pytesseract.image_to_string(img, lang='eng')
                    if page_text and page_text.strip():
                        all_text += f"\n--- ç¬¬ {page_num} é  ---\n{page_text}\n"
                        self._log(f"âœ… OCR ç¬¬ {page_num} é æå–æˆåŠŸ")
                
                doc.close()
                self._log(f"ğŸ“Š OCR ç¸½æ–‡æœ¬é•·åº¦: {len(all_text)} å­—ç¬¦")
                        
            except Exception as e:
                self._log(f"âš ï¸ OCR æå–å¤±æ•—: {str(e)}")
        
        # å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±æ•—
        if len(all_text.strip()) == 0:
            self._log("âŒ æ‰€æœ‰ PDF æå–æ–¹æ³•éƒ½å¤±æ•—")
            return {
                'outlets': [],
                'invoices': [],
                'raw_text': 'âŒ ç„¡æ³•æå– PDF æ–‡æœ¬å…§å®¹'
            }
        
        try:
            # è§£æEver-Shineæ ¼å¼çš„é—œéµæ•¸æ“š
            key_data = self._parse_evershine_data(all_text)
            return key_data
                
        except Exception as e:
            self._log(f"âŒ æ•¸æ“šè§£æå¤±æ•—: {str(e)}")
            return {
                'outlets': [],
                'invoices': [],
                'raw_text': all_text
            }
    
    def _parse_evershine_data(self, text):
        """è§£æEver-Shine PDFçš„é—œéµæ•¸æ“š"""
        self._log("ğŸ” é–‹å§‹è§£æEver-Shineé—œéµæ•¸æ“š...")
        
        lines = text.split('\n')
        
        key_data = {
            'outlets': [],
            'invoices': [],
            'details': [],
            'raw_text': text
        }
        
        # é€é è§£æ
        for i, page in enumerate(self._split_evershine_pages(lines)):
            page_data = self._parse_evershine_page(page, i)
            if page_data:
                key_data['outlets'].append(page_data['outlet'])
                key_data['invoices'].extend(page_data['invoices'])
        
        self._log("âœ… Ever-Shineé—œéµæ•¸æ“šè§£æå®Œæˆ")
        return key_data
    
    def _split_evershine_pages(self, lines):
        """åˆ†å‰²Ever-Shine PDFçš„é é¢"""
        pages = []
        current_page = []
        
        for line in lines:
            # Ever-Shineæ¯é éƒ½æœ‰"STATEMENT OF ACCOUNT"æ¨™é¡Œ
            if 'STATEMENT OF ACCOUNT' in line and current_page:
                pages.append(current_page)
                current_page = [line]
            else:
                current_page.append(line)
        
        if current_page:
            pages.append(current_page)
        
        return pages
    
    def _parse_evershine_page(self, page_lines, page_num):
        """è§£æEver-Shineå–®é æ•¸æ“š"""
        import re
        
        # æŸ¥æ‰¾å®¢æˆ¶ä¿¡æ¯ï¼ˆé–€å¸‚åç¨±ï¼‰
        customer_name = None
        for line in page_lines:
            # Ever-Shineæ ¼å¼ï¼šSushi Express - Northpoint æˆ– Sushi GOGO - xxx ç­‰
            if ('Sushi Express' in line or 'Sushi GOGO' in line or 'Sushi TakeOut' in line) and '-' in line:
                # æå–é–€å¸‚åç¨±ï¼Œæ”¯æŒå¤šç¨®å“ç‰Œæ ¼å¼
                patterns = [
                    r'Sushi Express\s*-\s*(.+)',
                    r'Sushi GOGO\s*-\s*(.+)', 
                    r'Sushi TakeOut\s*-\s*(.+)'
                ]
                for pattern in patterns:
                    match = re.search(pattern, line.strip())
                    if match:
                        customer_name = match.group(1).strip()
                        self._log(f"ğŸ” æ‰¾åˆ°é–€å¸‚åç¨±: '{customer_name}' (å®Œæ•´è¡Œ: {repr(line.strip())})")
                        break
                if customer_name:
                    break
        
        if not customer_name:
            self._log(f"âš ï¸ ç¬¬ {page_num+1} é æœªæ‰¾åˆ°å®¢æˆ¶åç¨±")
            return None
        
        self._log(f"ğŸª æ‰¾åˆ°é–€å¸‚: {customer_name}")
        
        # æŸ¥æ‰¾Currenté‡‘é¡ï¼ˆå¾Statement Agingè¡¨æ ¼ï¼‰
        current_amount = 0.0
        
        # é¦–å…ˆæ‰“å°æ‰€æœ‰åŒ…å«Currentçš„è¡Œé€²è¡Œèª¿è©¦
        self._log(f"ğŸ” èª¿è©¦ï¼šæŸ¥æ‰¾åŒ…å«'Current'çš„è¡Œ...")
        for i, line in enumerate(page_lines):
            if 'Current' in line:
                self._log(f"ğŸ” ç¬¬{i+1}è¡Œ: {repr(line)}")
        
        # æŸ¥æ‰¾ Sub Total é‡‘é¡ï¼ˆåœ¨ç™¼ç¥¨è¡¨æ ¼çµæŸå¾Œï¼‰
        for i, line in enumerate(page_lines):
            line_stripped = line.strip()
            if 'Sub Total' in line_stripped:
                self._log(f"ğŸ” æ‰¾åˆ°Sub Totalè¡Œ: {repr(line_stripped)}")
                
                # å¾Sub Totalè¡Œæå–é‡‘é¡
                # æ ¼å¼: "Sub Total 1880.69"
                match = re.search(r'Sub Total\s+([\d,]+\.?\d*)', line_stripped)
                if match:
                    try:
                        current_amount = float(match.group(1).replace(',', ''))
                        self._log(f"ğŸ’° å¾Sub Totalæ‰¾åˆ°é‡‘é¡: ${current_amount:.2f}")
                        break
                    except ValueError:
                        pass
                
                # å‚™ç”¨æ–¹æ³•ï¼šåˆ†å‰²ä¸¦æŸ¥æ‰¾æ•¸å­—
                parts = re.split(r'\s+', line_stripped)
                for part in parts:
                    if re.match(r'^[\d,]+\.?\d*$', part):
                        try:
                            current_amount = float(part.replace(',', ''))
                            self._log(f"ğŸ’° å¾Sub Total(å‚™ç”¨æ–¹æ³•)æ‰¾åˆ°é‡‘é¡: ${current_amount:.2f}")
                            break
                        except ValueError:
                            continue
                break
        
        # å¦‚æœæ²’æ‰¾åˆ°Sub Totalï¼ŒæŸ¥æ‰¾Statement Agingè¡¨æ ¼
        if current_amount == 0.0:
            aging_section_found = False
            for i, line in enumerate(page_lines):
                if 'Statement Aging' in line:
                    aging_section_found = True
                    self._log(f"ğŸ” æ‰¾åˆ°Statement Agingè¡¨æ ¼")
                    
                    for j in range(i+1, min(i+10, len(page_lines))):
                        header_line = page_lines[j].strip()
                        if 'Current' in header_line and 'Days' in header_line:
                            self._log(f"ğŸ” æ‰¾åˆ°agingæ¨™é¡Œè¡Œ: {repr(header_line)}")
                            
                            if j+1 < len(page_lines):
                                data_line = page_lines[j+1].strip()
                                self._log(f"ğŸ” agingæ•¸æ“šè¡Œ: {repr(data_line)}")
                                
                                parts = re.split(r'\s+', data_line)
                                numeric_parts = []
                                for part in parts:
                                    if re.match(r'^[\d,]+\.?\d*$', part):
                                        numeric_parts.append(part)
                                
                                if numeric_parts:
                                    try:
                                        current_amount = float(numeric_parts[0].replace(',', ''))
                                        self._log(f"ğŸ’° å¾Statement Agingæ‰¾åˆ°Currenté‡‘é¡: ${current_amount:.2f}")
                                        break
                                    except ValueError:
                                        continue
                                break
                    break
        
        # æª¢æŸ¥ aging_section_found è®Šé‡æ˜¯å¦å·²å®šç¾©
        if current_amount == 0.0 and 'aging_section_found' not in locals():
            self._log(f"âš ï¸ æœªæ‰¾åˆ°Sub Totalå’ŒStatement Agingè¡¨æ ¼")
        
        # æŸ¥æ‰¾ç™¼ç¥¨ä¿¡æ¯
        invoices = []
        in_invoice_table = False
        
        for line in page_lines:
            line = line.strip()
            
            # æª¢æ¸¬ç™¼ç¥¨è¡¨æ ¼é–‹å§‹
            if 'Document' in line and 'Invoice Date' in line and 'Amount' in line:
                in_invoice_table = True
                self._log(f"ğŸ“Š æ‰¾åˆ°ç™¼ç¥¨è¡¨æ ¼é–‹å§‹")
                continue
            
            # æª¢æ¸¬ç™¼ç¥¨è¡¨æ ¼çµæŸ
            if in_invoice_table and ('Sub Total' in line or 'Statement Aging' in line):
                in_invoice_table = False
                self._log(f"ğŸ“Š ç™¼ç¥¨è¡¨æ ¼çµæŸ")
                continue
            
            # è§£æç™¼ç¥¨æ•¸æ“š
            if in_invoice_table and line:
                # Ever-Shineç™¼ç¥¨æ ¼å¼ï¼šINV25-23557 02/07/25 Order INV25-23557 31/08/25 180.01 180.01
                parts = re.split(r'\s+', line)
                if len(parts) >= 6:
                    try:
                        invoice_num = parts[0]
                        invoice_date = parts[1]
                        due_date = parts[4] if len(parts) > 4 else ''
                        amount = float(parts[-2].replace(',', '')) if len(parts) >= 2 else 0.0
                        
                        if invoice_num and amount > 0:
                            invoices.append({
                                'invoice_number': invoice_num,
                                'invoice_no': invoice_num,  # æ·»åŠ invoice_noå­—æ®µ
                                'outlet_name': customer_name,  # æ·»åŠ outlet_nameå­—æ®µ
                                'amount': amount,
                                'date': invoice_date,
                                'due_date': due_date,
                                'balance': amount,  # æ·»åŠ balanceå­—æ®µ
                                'outlet_aging_amount': current_amount  # æ·»åŠ outlet_aging_amountå­—æ®µ
                            })
                            self._log(f"ğŸ“ ç™¼ç¥¨: {invoice_num}, é‡‘é¡: ${amount:.2f}")
                    except (ValueError, IndexError):
                        continue
        
        # å¦‚æœ aging é‡‘é¡ç‚º 0ï¼Œä½¿ç”¨ç™¼ç¥¨ç¸½é¡ä½œç‚ºç•¶å‰é‡‘é¡
        if current_amount == 0.0 and invoices:
            current_amount = sum(inv['amount'] for inv in invoices)
            self._log(f"ğŸ’¡ Agingé‡‘é¡ç‚º0ï¼Œä½¿ç”¨ç™¼ç¥¨ç¸½é¡ä½œç‚ºç•¶å‰é‡‘é¡: ${current_amount:.2f}")
        
        # æ‡‰ç”¨1.09èª¿æ•´ï¼ˆèˆ‡Aries Freshç›¸åŒï¼‰
        adjusted_amount = current_amount / 1.09 if current_amount > 0 else current_amount
        self._log(f"ğŸ”„ é‡‘é¡èª¿æ•´: ${current_amount:.2f} Ã· 1.09 = ${adjusted_amount:.2f}")
        
        return {
            'outlet': {
                'name': customer_name,
                'amount': adjusted_amount,
                'raw_amount': current_amount,
                'aging_amount': current_amount,  # æ·»åŠ aging_amountå­—æ®µ
                'invoice_count': len(invoices)
            },
            'invoices': invoices
        }
    
    def _parse_aries_fresh_page(self, page_text, page_num):
        """è§£æAries Freshå–®é æ•¸æ“š"""
        import re
        lines = page_text.split('\n')
        
        # æŸ¥æ‰¾Customer Name
        customer_name = None
        for line in lines:
            if 'Customer Name:' in line:
                # æå–é–€å¸‚åç¨±ï¼Œæ ¼å¼ï¼šSushi Express Group P/L(é–€å¸‚å) æˆ– Sushi Express West Mall (WSM)
                # è™•ç†å…©ç¨®æ ¼å¼
                if 'P/L(' in line and ')' in line:
                    # æ ¼å¼1: Sushi Express Group P/L(é–€å¸‚å)
                    match = re.search(r'Customer Name:\s*Sushi Express.*P/L\(([^)]+)\)', line)
                    if match:
                        customer_name = match.group(1).strip()
                elif 'Sushi Express' in line:
                    # æ ¼å¼2: Sushi Express West Mall (WSM)
                    match = re.search(r'Customer Name:\s*(Sushi Express[^C]*?)(?:\s+Customer|$)', line)
                    if match:
                        full_name = match.group(1).strip()
                        # å»é™¤ "Sushi Express" å‰ç¶´ï¼Œä¿ç•™é–€å¸‚åç¨±
                        customer_name = full_name.replace('Sushi Express ', '').strip()
                break
        
        if not customer_name:
            self._log(f"âš ï¸ ç¬¬ {page_num} é æœªæ‰¾åˆ°Customer Name")
            return None
        
        self._log(f"ğŸª æ‰¾åˆ°é–€å¸‚: {customer_name}")
        
        # æŸ¥æ‰¾Currenté‡‘é¡ï¼ˆé—œéµæ•¸æ“šï¼‰
        current_amount = 0.0
        
        # é¦–å…ˆæ‰“å°æ‰€æœ‰åŒ…å«Currentçš„è¡Œé€²è¡Œèª¿è©¦
        self._log(f"ğŸ” èª¿è©¦ï¼šæŸ¥æ‰¾åŒ…å«'Current'çš„è¡Œ...")
        for i, line in enumerate(lines):
            if 'Current' in line:
                self._log(f"ğŸ” ç¬¬{i+1}è¡Œ: {repr(line)}")
        
        # ç‰¹åˆ¥è™•ç†agingè¡¨æ ¼ï¼šæŸ¥æ‰¾åŒ…å«Currentåˆ—æ¨™é¡Œå’Œæ•¸æ“šçš„å…©è¡Œ
        aging_header_idx = -1
        for i, line in enumerate(lines):
            if 'Current' in line and '1 Month' in line and '2 Month' in line:
                aging_header_idx = i
                self._log(f"ğŸ” æ‰¾åˆ°agingè¡¨æ ¼æ¨™é¡Œè¡Œ: {repr(line)}")
                break
        
        if aging_header_idx >= 0 and aging_header_idx + 1 < len(lines):
            # æª¢æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦åŒ…å«æ•¸æ“š
            data_line = lines[aging_header_idx + 1].strip()
            self._log(f"ğŸ” agingè¡¨æ ¼æ•¸æ“šè¡Œ: {repr(data_line)}")
            
            # è§£ææ•¸æ“šè¡Œï¼šç¬¬ä¸€å€‹æ•¸å­—å°±æ˜¯Currenté‡‘é¡
            parts = re.split(r'\s+', data_line)
            if len(parts) >= 1:
                for part in parts:
                    # åŒ¹é…æ ¼å¼å¦‚ 1,553.08 æˆ– 1553.08
                    if re.match(r'^[\d,]+\.?\d*$', part):
                        try:
                            current_amount = float(part.replace(',', ''))
                            self._log(f"ğŸ’° å¾agingè¡¨æ ¼æ‰¾åˆ°Currenté‡‘é¡: ${current_amount:.2f}")
                            break
                        except ValueError:
                            continue
        
        # å¦‚æœagingè¡¨æ ¼æ–¹æ³•å¤±æ•—ï¼Œä½¿ç”¨åŸæœ‰çš„å¤šæ¨¡å¼åŒ¹é…
        if current_amount == 0.0:
            for i, line in enumerate(lines):
                # æŸ¥æ‰¾åŒ…å« "Current" å’Œæ•¸å­—çš„è¡Œï¼Œç‰¹åˆ¥æ˜¯agingè¡¨æ ¼
                if 'Current' in line and any(char.isdigit() for char in line):
                    self._log(f"ğŸ” æ­£åœ¨åˆ†æåŒ…å«Currentçš„è¡Œ: {repr(line)}")
                    
                    # å˜—è©¦å¤šç¨®æ¨¡å¼åŒ¹é…Currenté‡‘é¡
                    # æ¨¡å¼1: Currentç›´æ¥å¾Œé¢è·Ÿé‡‘é¡
                    match = re.search(r'Current\s+([\d,]+\.?\d*)', line)
                    if match:
                        try:
                            current_amount = float(match.group(1).replace(',', ''))
                            self._log(f"ğŸ’° æ‰¾åˆ°Currenté‡‘é¡ (æ¨¡å¼1): ${current_amount:.2f}")
                            break
                        except ValueError:
                            pass
                    
                    # æ¨¡å¼2: è¡¨æ ¼æ ¼å¼ Current | amount | amount | ...
                    if '|' in line or '\t' in line:
                        parts = re.split(r'[\|\t]+', line.strip())
                        for j, part in enumerate(parts):
                            if 'Current' in part and j + 1 < len(parts):
                                try:
                                    amount_str = parts[j + 1].strip().replace(',', '').replace('$', '')
                                    if amount_str and amount_str != '-':
                                        current_amount = float(amount_str)
                                        self._log(f"ğŸ’° æ‰¾åˆ°Currenté‡‘é¡ (æ¨¡å¼2): ${current_amount:.2f}")
                                        break
                                except ValueError:
                                    continue
                        if current_amount > 0:
                            break
                    
                    # æ¨¡å¼3: ç©ºæ ¼åˆ†éš”çš„è¡¨æ ¼æ ¼å¼
                    parts = re.split(r'\s+', line.strip())
                    for j, part in enumerate(parts):
                        if part == 'Current' and j + 1 < len(parts):
                            try:
                                # æª¢æŸ¥ä¸‹ä¸€å€‹æœ‰æ•ˆçš„æ•¸å­—
                                for k in range(j + 1, min(j + 4, len(parts))):  # æª¢æŸ¥æ¥ä¸‹ä¾†3å€‹ä½ç½®
                                    amount_str = parts[k].replace(',', '').replace('$', '')
                                    if re.match(r'^\d+\.?\d*$', amount_str):
                                        amount = float(amount_str)
                                        if amount > 1.0:  # éæ¿¾æ‰1.00é€™ç¨®æ˜é¡¯éŒ¯èª¤çš„å€¼
                                            current_amount = amount
                                            self._log(f"ğŸ’° æ‰¾åˆ°Currenté‡‘é¡ (æ¨¡å¼3): ${current_amount:.2f}")
                                            break
                                if current_amount > 1.0:
                                    break
                            except ValueError:
                                continue
                    if current_amount > 1.0:
                        break
        
        # æŸ¥æ‰¾ç™¼ç¥¨ä¿¡æ¯
        invoices = []
        in_invoice_table = False
        
        for line in lines:
            line = line.strip()
            
            # æª¢æ¸¬ç™¼ç¥¨è¡¨æ ¼é–‹å§‹
            if 'DATE' in line and 'Type' in line and 'Doc Number' in line:
                in_invoice_table = True
                self._log(f"ğŸ“Š æ‰¾åˆ°ç™¼ç¥¨è¡¨æ ¼é–‹å§‹")
                continue
            
            # æª¢æ¸¬ç™¼ç¥¨è¡¨æ ¼çµæŸ
            if in_invoice_table and ('Current' in line or 'E. & O.E' in line):
                in_invoice_table = False
                self._log(f"ğŸ“Š ç™¼ç¥¨è¡¨æ ¼çµæŸ")
                continue
            
            # è§£æç™¼ç¥¨è¡Œ
            if in_invoice_table and line:
                invoice = self._parse_aries_fresh_invoice_line(line, customer_name)
                if invoice:
                    invoices.append(invoice)
        
        self._log(f"ğŸ’° é–€å¸‚ {customer_name} æ‰¾åˆ° {len(invoices)} æ¢ç™¼ç¥¨")
        
        # å‰µå»ºé–€å¸‚ä¿¡æ¯
        outlet = {
            'name': customer_name,
            'full_name': f"Sushi Express Group P/L({customer_name})",
            'aging_amount': current_amount,
            'line_number': page_num
        }
        
        return {
            'outlet': outlet,
            'invoices': invoices
        }
    
    def _parse_aries_fresh_invoice_line(self, line, outlet_name):
        """è§£æAries Freshç™¼ç¥¨è¡Œ"""
        import re
        # æ ¼å¼ï¼š03/07/2025 AR INV 817318 92.92 92.92
        parts = re.split(r'\s+', line.strip())
        if len(parts) >= 5:
            try:
                date_str = parts[0]
                doc_type1 = parts[1] if len(parts) > 1 else ''
                doc_type2 = parts[2] if len(parts) > 2 else ''
                doc_number = parts[3] if len(parts) > 3 else ''
                debit_amount = parts[4] if len(parts) > 4 else '0'
                balance = parts[5] if len(parts) > 5 else '0'
                
                # åªè™•ç†AR INVé¡å‹çš„ç™¼ç¥¨
                if doc_type1 == 'AR' and doc_type2 == 'INV':
                    # é©—è­‰æ—¥æœŸæ ¼å¼
                    if re.match(r'\d{2}/\d{2}/\d{4}', date_str):
                        # è½‰æ›ç‚ºdd/mm/yyæ ¼å¼
                        date_parts = date_str.split('/')
                        if len(date_parts) == 3:
                            day, month, year = date_parts
                            short_year = year[-2:]  # å–å¹´ä»½å¾Œå…©ä½
                            converted_date = f"{day}/{month}/{short_year}"
                            
                            return {
                                'outlet_name': outlet_name,
                                'date': converted_date,
                                'invoice_no': doc_number,
                                'amount': float(debit_amount.replace(',', '')),
                                'balance': float(balance.replace(',', '')),
                                'outlet_aging_amount': 0.0,  # å°‡åœ¨å¾ŒçºŒè™•ç†ä¸­å¡«å……
                                'raw_line': line
                            }
            except (ValueError, IndexError) as e:
                # éœé»˜å¿½ç•¥è§£æéŒ¯èª¤
                pass
        
        return None
    
    def _parse_key_data(self, text):
        """
        è§£ææå–çš„æ–‡æœ¬ï¼Œè­˜åˆ¥é—œéµæ•¸æ“šå…ƒç´ 
        èˆ‡pdf_extractor_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯
        """
        self._log("ğŸ” é–‹å§‹è§£æé—œéµæ•¸æ“š...")
        
        # åˆå§‹åŒ–æ•¸æ“šçµæ§‹
        key_data = {
            'outlets': [],                # é–€å¸‚ä¿¡æ¯åˆ—è¡¨
            'invoices': [],               # ç™¼ç¥¨ä¿¡æ¯åˆ—è¡¨ï¼ˆåŒ…å«é–€å¸‚ä¿¡æ¯ï¼‰
            'raw_text': text             # åŸå§‹æ–‡æœ¬
        }
        
        # æŒ‰è¡Œåˆ†å‰²æ–‡æœ¬
        lines = text.split('\n')
        self._log(f"ğŸ“ æ–‡æœ¬å…± {len(lines)} è¡Œ")
        
        # 1. æå–æ‰€æœ‰é–€å¸‚ä¿¡æ¯
        key_data['outlets'] = self._extract_all_outlets(lines)
        
        # 2. æå–æ‰€æœ‰ç™¼ç¥¨ä¿¡æ¯ï¼ˆé—œè¯é–€å¸‚ï¼‰
        key_data['invoices'] = self._extract_all_invoices_with_outlets(lines, key_data['outlets'])
        
        self._log("âœ… é—œéµæ•¸æ“šè§£æå®Œæˆ")
        return key_data
    
    def _extract_all_outlets(self, lines):
        """æå–æ‰€æœ‰é–€å¸‚ä¿¡æ¯ - ä¿®æ­£Orientalæ ¼å¼è§£æ"""
        outlets = []
        
        for i, line in enumerate(lines):
            line = line.strip()
            
            # æŸ¥æ‰¾åŒ…å« "Customer Name" çš„è¡Œï¼ˆå…¼å®¹ä¸åŒæ ¼å¼ï¼‰
            if 'Customer Name' in line and ':' in line:
                self._log(f"ğŸ” ç¬¬{i+1}è¡Œ: æ‰¾åˆ°Customer Nameè¡Œ: '{line}'")
                
                # æå–å†’è™Ÿå¾Œé¢çš„é–€å¸‚åç¨±ï¼Œæ”¯æŒå¤šç¨®æ ¼å¼
                if 'Customer Name :' in line:
                    parts = line.split('Customer Name :')
                elif 'Customer Name:' in line:
                    parts = line.split('Customer Name:')
                else:
                    continue
                    
                if len(parts) > 1:
                    full_outlet_name = parts[1].strip()
                    
                    # æ¸…ç†é–€å¸‚åç¨±ï¼ˆç§»é™¤Currencyç­‰ä¿¡æ¯ï¼‰
                    if 'Currency' in full_outlet_name:
                        full_outlet_name = full_outlet_name.split('Currency')[0].strip()
                    
                    self._log(f"ğŸ” æ¸…ç†å¾Œçš„é–€å¸‚åç¨±: '{full_outlet_name}'")
                    
                    # æå–æ‹¬è™Ÿå…§çš„é–€å¸‚åç¨±
                    extracted_name = self._extract_outlet_from_brackets(full_outlet_name)
                    
                    if extracted_name:
                        # æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨é€™å€‹é–€å¸‚
                        if not any(outlet['name'] == extracted_name for outlet in outlets):
                            outlet_info = {
                                'name': extracted_name,  # åªä¿å­˜æ‹¬è™Ÿå…§çš„åç¨±
                                'full_name': full_outlet_name,  # ä¿å­˜å®Œæ•´åç¨±ç”¨æ–¼èª¿è©¦
                                'line_number': i + 1,
                                'aging_amount': 0.0
                            }
                            outlets.append(outlet_info)
                            self._log(f"âœ… æ–°å¢é–€å¸‚: {extracted_name}")
                    else:
                        self._log(f"âš ï¸ ç„¡æ³•å¾ '{full_outlet_name}' æå–é–€å¸‚åç¨±")
        
        # ç‚ºæ¯å€‹é–€å¸‚æŸ¥æ‰¾è³¬é½¡é‡‘é¡
        for outlet in outlets:
            outlet['aging_amount'] = self._find_outlet_aging_amount(lines, outlet['full_name'])
        
        return outlets
    
    def _extract_outlet_from_brackets(self, full_name):
        """å¾å®Œæ•´é–€å¸‚åç¨±ä¸­æå–æ‹¬è™Ÿå…§çš„éƒ¨åˆ†"""
        try:
            # æŸ¥æ‰¾æ‹¬è™Ÿå…§çš„å…§å®¹
            # æ”¯æŒå¤šç¨®æ‹¬è™Ÿæ ¼å¼ï¼š(), [], {}
            bracket_patterns = [
                r'\(([^)]+)\)',  # åœ“æ‹¬è™Ÿ ()
                r'\[([^\]]+)\]',  # æ–¹æ‹¬è™Ÿ []
                r'\{([^}]+)\}'   # å¤§æ‹¬è™Ÿ {}
            ]
            
            for pattern in bracket_patterns:
                match = re.search(pattern, full_name)
                if match:
                    extracted = match.group(1).strip()
                    self._log(f"ğŸ” å¾ '{full_name}' æå–é–€å¸‚åç¨±: '{extracted}'")
                    return extracted
            
            # å¦‚æœæ²’æœ‰æ‰¾åˆ°æ‹¬è™Ÿï¼Œè¿”å›åŸå§‹åç¨±
            self._log(f"âš ï¸ æœªæ‰¾åˆ°æ‹¬è™Ÿï¼Œä½¿ç”¨åŸå§‹åç¨±: {full_name}")
            return full_name
            
        except Exception as e:
            self._log(f"âŒ æå–é–€å¸‚åç¨±å¤±æ•—: {str(e)}")
            return full_name
    
    def _find_outlet_aging_amount(self, lines, outlet_name):
        """ç‚ºç‰¹å®šé–€å¸‚æŸ¥æ‰¾è³¬é½¡é‡‘é¡ - èˆ‡pdf_extractor_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        aging_amount = 0.0
        
        # æŸ¥æ‰¾è©²é–€å¸‚åœ¨æ–‡æª”ä¸­çš„ä½ç½®
        outlet_start = None
        outlet_end = None
        
        # æŸ¥æ‰¾é–€å¸‚é–‹å§‹ä½ç½®ï¼ˆCustomer Nameè¡Œï¼‰
        for i, line in enumerate(lines):
            if 'Customer Name :' in line and outlet_name in line:
                outlet_start = i
                break
        
        # å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç”¨éƒ¨åˆ†åç¨±åŒ¹é…ï¼ˆç”¨æ–¼é•·åç¨±é–€å¸‚ï¼‰
        if outlet_start is None:
            # æå–é—œéµè©é€²è¡ŒåŒ¹é…
            key_parts = outlet_name.split()
            for i, line in enumerate(lines):
                if 'Customer Name :' in line:
                    # æª¢æŸ¥æ˜¯å¦åŒ…å«é—œéµè©
                    match_count = sum(1 for part in key_parts if part in line)
                    if match_count >= len(key_parts) * 0.6:  # 60%åŒ¹é…åº¦
                        outlet_start = i
                        self._log(f"ğŸ” é€šééƒ¨åˆ†åŒ¹é…æ‰¾åˆ°é–€å¸‚ {outlet_name} ä½ç½®: è¡Œ {i+1}")
                        break
        
        if outlet_start is None:
            self._log(f"âš ï¸ æœªæ‰¾åˆ°é–€å¸‚ {outlet_name} çš„ä½ç½®")
            return aging_amount
        
        # æŸ¥æ‰¾è©²é–€å¸‚çš„çµæŸä½ç½®ï¼ˆä¸‹ä¸€å€‹é–€å¸‚é–‹å§‹æˆ–æ–‡æª”çµæŸï¼‰
        outlet_end = len(lines)
        for i in range(outlet_start + 1, len(lines)):
            if 'Customer Name :' in lines[i]:
                outlet_end = i
                break
        
        # åœ¨è©²é–€å¸‚ç¯„åœå…§æŸ¥æ‰¾è³¬é½¡ä¿¡æ¯
        self._log(f"ğŸ” åœ¨é–€å¸‚ {outlet_name} ç¯„åœå…§ (è¡Œ {outlet_start+1} åˆ° {outlet_end}) æŸ¥æ‰¾è³¬é½¡é‡‘é¡...")
        
        # 1. å„ªå…ˆæŸ¥æ‰¾ "Statement Aging" è¡¨æ ¼çš„ "Current" åˆ—ä¸‹çš„é‡‘é¡
        # é€™é€šå¸¸åœ¨ "Statement Aging" è¡¨æ ¼çš„ç¬¬äºŒè¡Œ
        statement_aging_found = False
        for i in range(outlet_start, outlet_end):
            line = lines[i].strip()
            if "Statement Aging" in line or ("Days Old" in line and "Current" in line):
                statement_aging_found = True
                self._log(f"ğŸ” æ‰¾åˆ°Statement Agingè¡¨æ ¼: {line}")
                
                # æŸ¥æ‰¾ä¸‹ä¸€è¡Œçš„æ•¸æ“š
                if i + 1 < outlet_end:
                    data_line = lines[i+1].strip()
                    self._log(f"ğŸ” Statement Agingæ•¸æ“šè¡Œ: '{data_line}'")
                    
                    # æª¢æŸ¥æ˜¯å¦åŒ…å« "ged Amounts" æˆ– "Aged Amounts"
                    if 'ged Amounts' in data_line or 'Aged Amounts' in data_line:
                        # å¾é€™è¡Œæå–é‡‘é¡
                        amount_text = data_line.split(':')[-1].strip() if ':' in data_line else data_line
                        amount_match = re.search(r'(\d{4,7})', amount_text)
                        if amount_match:
                            raw_amount = amount_match.group(1)
                            self._log(f"ğŸ” åœ¨Statement Agingä¸­æ‰¾åˆ°æ•¸å­—: {raw_amount}")
                            if len(raw_amount) >= 4:
                                try:
                                    corrected_amount = raw_amount[:-2] + '.' + raw_amount[-2:]
                                    aging_amount = float(corrected_amount)
                                    self._log(f"ğŸ”§ ä¿®æ­£Statement Agingé‡‘é¡: {raw_amount} -> {corrected_amount}")
                                    self._log(f"ğŸ’° é€šéStatement Agingè¡¨æ ¼æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                    return aging_amount
                                except ValueError:
                                    pass
                    else:
                        # æ¨™æº–æ ¼å¼ï¼šæŸ¥æ‰¾ç¬¬ä¸€å€‹é‡‘é¡
                        amount_match = re.search(r'(\d+,?\d*\.\d{2})', data_line)
                        if amount_match:
                            try:
                                aging_amount = float(amount_match.group(1).replace(',', ''))
                                self._log(f"ğŸ’° é€šé 'Statement Aging' è¡¨æ ¼çš„ 'Current' åˆ—æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                return aging_amount
                            except ValueError:
                                self._log(f"âš ï¸ è§£æ 'Statement Aging' è¡¨æ ¼ 'Current' é‡‘é¡å¤±æ•—: {data_line}")
                        else:
                            # è™•ç†æ²’æœ‰å°æ•¸é»çš„æ ¼å¼ï¼Œå¦‚ "52510 0.00 000 000"
                            amount_match = re.search(r'(\d{4,7})', data_line)
                            if amount_match:
                                raw_amount = amount_match.group(1)
                                self._log(f"ğŸ” æ‰¾åˆ°ç„¡å°æ•¸é»æ•¸å­—: {raw_amount}")
                                if len(raw_amount) >= 4:
                                    try:
                                        corrected_amount = raw_amount[:-2] + '.' + raw_amount[-2:]
                                        aging_amount = float(corrected_amount)
                                        self._log(f"ğŸ”§ ä¿®æ­£Statement Agingæ ¼å¼: {raw_amount} -> {corrected_amount}")
                                        self._log(f"ğŸ’° é€šéStatement Agingè¡¨æ ¼æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                        return aging_amount
                                    except ValueError:
                                        pass
                break # æ‰¾åˆ°Statement Agingå°±åœæ­¢
        
        # 2. å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦æŸ¥æ‰¾ "Aged Amounts :" é€™ä¸€è¡Œ
        if aging_amount == 0.0:
            for i in range(outlet_start, outlet_end):
                line = lines[i].strip()
                if "Aged Amounts :" in line:
                    # æå–å†’è™Ÿå¾Œé¢çš„é‡‘é¡
                    parts = line.split('Aged Amounts :')
                    if len(parts) > 1:
                        # æå–ç¬¬ä¸€å€‹é‡‘é¡ï¼ˆCurrenté‡‘é¡ï¼‰
                        amount_part = parts[1].strip()
                        self._log(f"ğŸ” åˆ†æAged Amountsè¡Œ: '{amount_part}'")
                        
                        # å…ˆå˜—è©¦æ¨™æº–æ ¼å¼ (æœ‰å°æ•¸é»)
                        amount_match = re.search(r'(\d+,?\d*\.\d{2})', amount_part)
                        if amount_match:
                            try:
                                amount_str = amount_match.group(1).replace(',', '')
                                aging_amount = float(amount_str)
                                self._log(f"ğŸ’° é€šé 'Aged Amounts :' æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                return aging_amount
                            except ValueError:
                                pass
                        
                        # å¦‚æœæ²’æœ‰å°æ•¸é»ï¼Œå˜—è©¦ä¿®æ­£æ ¼å¼
                        # ä¾‹å¦‚ "129057" æ‡‰è©²æ˜¯ "1290.57"ï¼Œ"52510" æ‡‰è©²æ˜¯ "525.10"
                        no_decimal_match = re.search(r'(\d{4,7})', amount_part)  # ä¿®æ”¹ï¼šæ”¯æŒ4-7ä½æ•¸å­—ï¼Œä¸è¦æ±‚ç©ºæ ¼
                        if no_decimal_match:
                            raw_amount = no_decimal_match.group(1)
                            self._log(f"ğŸ” æ‰¾åˆ°ç„¡å°æ•¸é»æ•¸å­—: {raw_amount}")
                            if len(raw_amount) >= 4:
                                try:
                                    # å‡è¨­æœ€å¾Œå…©ä½æ˜¯å°æ•¸éƒ¨åˆ†
                                    corrected_amount = raw_amount[:-2] + '.' + raw_amount[-2:]
                                    aging_amount = float(corrected_amount)
                                    self._log(f"ğŸ”§ ä¿®æ­£Aged Amountsæ ¼å¼: {raw_amount} -> {corrected_amount}")
                                    self._log(f"ğŸ’° é€šé 'Aged Amounts :' æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                    return aging_amount
                                except ValueError:
                                    self._log(f"âš ï¸ è½‰æ›å¤±æ•—: {corrected_amount}")
                                    pass
                            else:
                                # å°æ–¼è¼ƒçŸ­çš„æ•¸å­—ï¼Œç›´æ¥ä½¿ç”¨
                                try:
                                    aging_amount = float(raw_amount)
                                    self._log(f"ğŸ’° ç›´æ¥ä½¿ç”¨æ•¸å­—: {raw_amount} -> ${aging_amount}")
                                    return aging_amount
                                except ValueError:
                                    pass
                        else:
                            # å¦‚æœæ²’æœ‰æ‰¾åˆ°4-7ä½æ•¸å­—ï¼Œå˜—è©¦æŸ¥æ‰¾ç¬¬ä¸€å€‹3ä½ä»¥ä¸Šçš„æ•¸å­—
                            fallback_match = re.search(r'(\d{3,})', amount_part)
                            if fallback_match:
                                raw_amount = fallback_match.group(1)
                                self._log(f"ğŸ” æ‰¾åˆ°å‚™ç”¨æ•¸å­—: {raw_amount}")
                                if len(raw_amount) >= 5:  # 5ä½æˆ–ä»¥ä¸Šæ‰ä¿®æ­£å°æ•¸é»
                                    try:
                                        corrected_amount = raw_amount[:-2] + '.' + raw_amount[-2:]
                                        aging_amount = float(corrected_amount)
                                        self._log(f"ğŸ”§ ä¿®æ­£Aged Amountsæ ¼å¼: {raw_amount} -> {corrected_amount}")
                                        self._log(f"ğŸ’° é€šé 'Aged Amounts :' æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                        return aging_amount
                                    except ValueError:
                                        pass
                                elif len(raw_amount) == 4:  # å°æ–¼4ä½æ•¸å­—ï¼Œä¹Ÿå˜—è©¦ä¿®æ­£å°æ•¸é»
                                    try:
                                        corrected_amount = raw_amount[:-2] + '.' + raw_amount[-2:]
                                        aging_amount = float(corrected_amount)
                                        self._log(f"ğŸ”§ ä¿®æ­£4ä½Aged Amountsæ ¼å¼: {raw_amount} -> {corrected_amount}")
                                        self._log(f"ğŸ’° é€šé 'Aged Amounts :' æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                        return aging_amount
                                    except ValueError:
                                        pass
                        
                        self._log(f"âš ï¸ è§£æ 'Aged Amounts' é‡‘é¡å¤±æ•—: {line}")
                                
        # 3. å¦‚æœä»¥ä¸Šå…©ç¨®æ–¹å¼éƒ½å¤±æ•—ï¼Œå˜—è©¦æ›´é€šç”¨çš„æ–¹å¼æŸ¥æ‰¾åŒ…å« "Current" çš„è¡Œ
        if aging_amount == 0.0:
            self._log(f"âš ï¸ é–€å¸‚ {outlet_name} æœªæ‰¾åˆ°Aged Amountsè¡Œï¼Œä½¿ç”¨é€šç”¨Currentæ¨¡å¼")
            for i in range(outlet_start, outlet_end):
                line = lines[i].strip()
                self._log(f"ğŸ” æª¢æŸ¥ç¬¬{i+1}è¡Œ: {repr(line)}")
                
                if 'Current' in line and any(char.isdigit() for char in line):
                    self._log(f"ğŸ” æ‰¾åˆ°åŒ…å«Currentçš„è¡Œ: {repr(line)}")
                    
                    # æ”¹é€²çš„é‚è¼¯ï¼šå„ªå…ˆæŸ¥æ‰¾è¡¨æ ¼æ ¼å¼çš„Currenté‡‘é¡
                    # æ¨¡å¼1: Statement Agingè¡¨æ ¼æ ¼å¼ "Days Old Current 31- 60 Days..."
                    if 'Days Old' in line and 'Current' in line:
                        # æŸ¥æ‰¾ä¸‹ä¸€è¡Œçš„æ•¸æ“š
                        if i + 1 < outlet_end:
                            data_line = lines[i+1].strip()
                            self._log(f"ğŸ” Statement Agingæ•¸æ“šè¡Œ: {repr(data_line)}")
                            
                            # æ”¹é€²çš„é‚è¼¯ï¼šè™•ç† Statement Aging æ•¸æ“šè¡Œ
                            if 'ged Amounts' in data_line or 'Aged Amounts' in data_line:
                                # è™•ç† "ged Amounts : 2,07831 0.00 0.00 0.00" æ ¼å¼
                                parts = data_line.split(':')
                                if len(parts) > 1:
                                    amount_part = parts[1].strip()
                                    # æŸ¥æ‰¾ç¬¬ä¸€å€‹é‡‘é¡
                                    amount_match = re.search(r'(\d+,?\d*\.?\d*)', amount_part)
                                    if amount_match:
                                        raw_amount = amount_match.group(1).replace(',', '')
                                        self._log(f"ğŸ” Statement Agingæ‰¾åˆ°åŸå§‹é‡‘é¡: {raw_amount}")
                                        
                                        # æª¢æŸ¥æ˜¯å¦éœ€è¦ä¿®æ­£å°æ•¸é»
                                        if '.' not in raw_amount and len(raw_amount) >= 4:
                                            # ä¿®æ­£æ ¼å¼ï¼šå¦‚ "207831" -> "2078.31", "81529" -> "815.29"
                                            corrected_amount = raw_amount[:-2] + '.' + raw_amount[-2:]
                                            aging_amount = float(corrected_amount)
                                            self._log(f"ğŸ”§ ä¿®æ­£Statement Agingæ ¼å¼: {raw_amount} -> {corrected_amount}")
                                        else:
                                            aging_amount = float(raw_amount)
                                        
                                        self._log(f"ğŸ’° é€šéStatement Agingè¡¨æ ¼æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                        break
                            else:
                                # åŸæœ‰é‚è¼¯ï¼šç›´æ¥æå–æ•¸å­—
                                amounts = re.findall(r'(\d+,?\d*\.?\d+)', data_line)
                                if amounts:
                                    try:
                                        aging_amount = float(amounts[0].replace(',', ''))
                                        self._log(f"ğŸ’° é€šéStatement Agingè¡¨æ ¼æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount}")
                                        break
                                    except ValueError:
                                        pass
                    
                    # æ¨¡å¼2: åŸæœ‰çš„é€šç”¨æ¨¡å¼ï¼Œä½†æé«˜åŒ¹é…è¦æ±‚
                    if aging_amount == 0.0:
                        # æŸ¥æ‰¾è¼ƒå¤§çš„é‡‘é¡ï¼ˆå¯èƒ½æ˜¯è³¬é½¡é‡‘é¡ï¼‰
                        amounts = re.findall(r'(\d+,?\d*\.?\d+)', line)
                        self._log(f"ğŸ” è¡Œä¸­æ‰¾åˆ°çš„æ‰€æœ‰é‡‘é¡: {amounts}")
                        
                        # é¸æ“‡æœ€å¤§çš„é‡‘é¡ä½œç‚ºè³¬é½¡é‡‘é¡ï¼ˆé€šå¸¸è³¬é½¡é‡‘é¡æ˜¯æœ€å¤§çš„ï¼‰
                        if amounts:
                            try:
                                amount_values = [float(amt.replace(',', '')) for amt in amounts]
                                # éæ¿¾æ‰å¤ªå°çš„é‡‘é¡ï¼ˆå¯èƒ½æ˜¯å¤©æ•¸ç­‰ï¼‰
                                valid_amounts = [amt for amt in amount_values if amt > 100]
                                if valid_amounts:
                                    aging_amount = max(valid_amounts)
                                    self._log(f"ğŸ’° é€šéé€šç”¨æ¨¡å¼æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount} (å¾{amount_values}ä¸­é¸æ“‡)")
                                    break
                                elif amount_values:
                                    # å¦‚æœæ²’æœ‰å¤§æ–¼100çš„ï¼Œé¸æ“‡æœ€å¤§çš„
                                    aging_amount = max(amount_values)
                                    self._log(f"ğŸ’° é€šéé€šç”¨æ¨¡å¼æ‰¾åˆ°é–€å¸‚ {outlet_name} çš„è³¬é½¡é‡‘é¡: ${aging_amount} (å‚™ç”¨é¸æ“‡)")
                                    break
                            except ValueError:
                                pass
        
        return aging_amount
    
    def _extract_all_invoices_with_outlets(self, lines, outlets):
        """æå–æ‰€æœ‰ç™¼ç¥¨ä¿¡æ¯ï¼Œä¸¦é—œè¯é–€å¸‚ - èˆ‡pdf_extractor_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        all_invoices = []
        
        # ç‚ºæ¯å€‹é–€å¸‚æå–ç™¼ç¥¨
        for outlet in outlets:
            self._log(f"ğŸ” ç‚ºé–€å¸‚ {outlet['name']} æå–ç™¼ç¥¨...")
            
            # åœ¨é–€å¸‚åç¨±é™„è¿‘æŸ¥æ‰¾ç™¼ç¥¨æ•¸æ“š
            outlet_invoices = self._extract_invoices_for_outlet(lines, outlet)
            
            # ç‚ºæ¯å€‹ç™¼ç¥¨æ·»åŠ é–€å¸‚ä¿¡æ¯
            for invoice in outlet_invoices:
                invoice['outlet_name'] = outlet['name']
                invoice['outlet_aging_amount'] = outlet['aging_amount']
                all_invoices.append(invoice)
            
            self._log(f"ğŸ’° é–€å¸‚ {outlet['name']} æ‰¾åˆ° {len(outlet_invoices)} æ¢ç™¼ç¥¨")
        
        return all_invoices
    
    def _extract_invoices_for_outlet(self, lines, outlet):
        """ç‚ºç‰¹å®šé–€å¸‚æå–ç™¼ç¥¨ä¿¡æ¯ - èˆ‡pdf_extractor_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        invoices = []
        
        # æŸ¥æ‰¾è©²é–€å¸‚çš„äº¤æ˜“è¡¨æ ¼
        outlet_start = None
        outlet_end = None
        
        # æŸ¥æ‰¾é–€å¸‚é–‹å§‹ä½ç½®ï¼ˆCustomer Nameè¡Œï¼‰
        for i, line in enumerate(lines):
            if 'Customer Name :' in line and outlet['full_name'] in line:
                outlet_start = i
                self._log(f"ğŸª æ‰¾åˆ°é–€å¸‚ {outlet['name']} é–‹å§‹ä½ç½®: ç¬¬ {i+1} è¡Œ")
                break
        
        if outlet_start is None:
            self._log(f"âš ï¸ æœªæ‰¾åˆ°é–€å¸‚ {outlet['name']} çš„é–‹å§‹ä½ç½®")
            return invoices
        
        # æŸ¥æ‰¾è©²é–€å¸‚çš„çµæŸä½ç½®ï¼ˆä¸‹ä¸€å€‹é–€å¸‚é–‹å§‹æˆ–æ–‡æª”çµæŸï¼‰
        outlet_end = len(lines)
        for i in range(outlet_start + 1, len(lines)):
            if 'Customer Name :' in lines[i]:
                outlet_end = i
                self._log(f"ğŸª é–€å¸‚ {outlet['name']} çµæŸä½ç½®: ç¬¬ {i+1} è¡Œ")
                break
        
        # åœ¨è©²é–€å¸‚ç¯„åœå…§æŸ¥æ‰¾ç™¼ç¥¨
        self._log(f"ğŸ” åœ¨é–€å¸‚ {outlet['name']} ç¯„åœå…§æœç´¢ç™¼ç¥¨ (è¡Œ {outlet_start+1} åˆ° {outlet_end})")
        
        # æŸ¥æ‰¾äº¤æ˜“è¡¨æ ¼çš„é–‹å§‹
        table_started = False
        for i in range(outlet_start, outlet_end):
            line = lines[i].strip()
            
            # æª¢æŸ¥æ˜¯å¦åˆ°é”äº¤æ˜“è¡¨æ ¼ï¼ˆåŒ…å«åˆ—æ¨™é¡Œï¼‰
            if 'Posting Date' in line and 'Doc Type' in line and 'Document No' in line:
                table_started = True
                self._log(f"ğŸ“Š æ‰¾åˆ°äº¤æ˜“è¡¨æ ¼é–‹å§‹ï¼Œè¡Œ {i+1}: {line}")
                continue
            
            if table_started:
                # è·³éç©ºè¡Œå’Œè¡¨é ­
                if not line or any(keyword in line for keyword in ['Posting Date', 'Doc Type', 'Document No', 'Debit', 'Credit', 'Balance']):
                    continue
                
                # å˜—è©¦è§£æç™¼ç¥¨è¡Œ
                invoice = self._parse_invoice_line(line)
                if invoice:
                    invoices.append(invoice)
                    self._log(f"ğŸ’° è§£æåˆ°ç™¼ç¥¨: {invoice}")
                
                # æª¢æŸ¥æ˜¯å¦åˆ°é”è¡¨æ ¼çµæŸï¼ˆé€šå¸¸æ˜¯è³¬é½¡æ‘˜è¦é–‹å§‹ï¼‰
                if any(keyword in line for keyword in ['Statement Aging', 'Days Old', 'Aged Amounts']):
                    self._log(f"ğŸ“Š äº¤æ˜“è¡¨æ ¼çµæŸï¼Œè¡Œ {i+1}: {line}")
                    break
        
        # å¦‚æœæ²’æœ‰æ‰¾åˆ°ç™¼ç¥¨ï¼Œå˜—è©¦åœ¨è©²é–€å¸‚ç¯„åœå…§æœç´¢
        if not invoices:
            self._log(f"ğŸ” åœ¨äº¤æ˜“è¡¨æ ¼ä¸­æ²’æœ‰æ‰¾åˆ°ç™¼ç¥¨ï¼Œå˜—è©¦åœ¨é–€å¸‚ {outlet['name']} ç¯„åœå…§æœç´¢...")
            invoices = self._search_invoices_in_outlet_range(lines, outlet, outlet_start, outlet_end)
        
        return invoices
    
    def _search_invoices_in_outlet_range(self, lines, outlet, start_line, end_line):
        """åœ¨ç‰¹å®šé–€å¸‚ç¯„åœå…§æœç´¢ç™¼ç¥¨ä¿¡æ¯ - èˆ‡pdf_extractor_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        invoices = []
        
        self._log(f"ğŸ” åœ¨é–€å¸‚ {outlet['name']} ç¯„åœå…§ (è¡Œ {start_line+1} åˆ° {end_line}) æœç´¢ç™¼ç¥¨...")
        
        # æœç´¢ç™¼ç¥¨
        for i in range(start_line, end_line):
            line = lines[i].strip()
            
            # è·³éç©ºè¡Œ
            if not line:
                continue
            
            # å˜—è©¦è§£æç™¼ç¥¨è¡Œ
            invoice = self._parse_invoice_line(line)
            if invoice:
                invoices.append(invoice)
                self._log(f"ğŸ’° åœ¨ç¬¬ {i+1} è¡Œæ‰¾åˆ°é–€å¸‚ {outlet['name']} çš„ç™¼ç¥¨: {invoice}")
            
            # å¦‚æœæ‰¾åˆ°å¤ªå¤šç™¼ç¥¨ï¼Œåœæ­¢æœç´¢
            if len(invoices) > 50:
                self._log(f"ğŸ” é–€å¸‚ {outlet['name']} å·²æ‰¾åˆ°è¶³å¤ å¤šçš„ç™¼ç¥¨ï¼Œåœæ­¢æœç´¢")
                break
        
        return invoices
    
    def _parse_invoice_line(self, line):
        """è§£æå–®è¡Œç™¼ç¥¨è¨˜éŒ„ - èˆ‡pdf_extractor_simple.pyå®Œå…¨ç›¸åŒçš„é‚è¼¯"""
        # æ¸…ç†è¡Œæ•¸æ“š
        line = line.strip()
        if not line:
            return None
        
        # å˜—è©¦åŒ¹é…ç™¼ç¥¨è¡Œæ¨¡å¼
        # æ ¼å¼: æ—¥æœŸ | Invoice | ç™¼ç¥¨è™Ÿ | é‡‘é¡ | é¤˜é¡
        
        # æŸ¥æ‰¾æ—¥æœŸ
        date_match = re.search(r'(\d{1,2}/\d{1,2}/\d{2,4})', line)
        if not date_match:
            return None
        
        date_str = date_match.group(1)
        
        # æª¢æŸ¥æ˜¯å¦æ˜¯ç™¼ç¥¨è¡Œ - æ›´åš´æ ¼çš„æª¢æŸ¥
        if 'Invoice' not in line:
            return None
        
        # æŸ¥æ‰¾ç™¼ç¥¨è™Ÿ - æ›´æº–ç¢ºçš„æ¨¡å¼
        # ç™¼ç¥¨è™Ÿé€šå¸¸æ˜¯6-7ä½æ•¸å­—
        invoice_match = re.search(r'Invoice\s+(\d{6,7})', line)
        if not invoice_match:
            return None
        
        invoice_no = invoice_match.group(1)
        
        # æŸ¥æ‰¾é‡‘é¡ - å„ªåŒ–çš„æ¨¡å¼ï¼Œæ”¯æŒå¤šç¨®æ ¼å¼
        # é‡‘é¡æ‡‰è©²æ˜¯Debitåˆ—çš„å€¼ï¼Œé€šå¸¸æ˜¯æ­£æ•¸
        # å˜—è©¦å¤šç¨®é‡‘é¡æ ¼å¼çš„æ¨¡å¼
        
        # æ¨¡å¼1: æ¨™æº–é‡‘é¡æ ¼å¼ (xx.xx)
        debit_match = re.search(r'Invoice\s+\d{6,7}\s+(\d+,?\d*\.\d{2})', line)
        if debit_match:
            try:
                amount = float(debit_match.group(1).replace(',', ''))
            except ValueError:
                return None
        else:
            # æ¨¡å¼2: è™•ç†æ ¼å¼éŒ¯èª¤çš„æƒ…æ³ï¼Œå¦‚ "12573" æ‡‰è©²æ˜¯ "125.73"
            # æŸ¥æ‰¾ç™¼ç¥¨è™Ÿå¾Œé¢çš„ç¬¬ä¸€å€‹æ•¸å­—
            pattern = r'Invoice\s+\d{6,7}\s+(\d+)\s+[\d,]+\.\d{2}'
            error_match = re.search(pattern, line)
            if error_match:
                raw_amount = error_match.group(1)
                # å¦‚æœæ˜¯4-5ä½æ•¸å­—ä¸”æ²’æœ‰å°æ•¸é»ï¼Œå˜—è©¦æ’å…¥å°æ•¸é»
                if len(raw_amount) >= 4 and '.' not in raw_amount:
                    try:
                        # å‡è¨­æœ€å¾Œå…©ä½æ˜¯å°æ•¸éƒ¨åˆ†
                        amount_str = raw_amount[:-2] + '.' + raw_amount[-2:]
                        amount = float(amount_str)
                        self._log(f"ğŸ”§ ä¿®æ­£é‡‘é¡æ ¼å¼: {raw_amount} -> {amount_str}")
                    except ValueError:
                        return None
                else:
                    return None
            else:
                # æ¨¡å¼3: å¾Œå‚™æ–¹æ¡ˆï¼ŒæŸ¥æ‰¾è¡Œä¸­çš„ä»»ä½•æœ‰æ•ˆé‡‘é¡
                fallback_match = re.search(r'(\d+,?\d*\.\d{2})', line)
                if fallback_match:
                    try:
                        amount = float(fallback_match.group(1).replace(',', ''))
                    except ValueError:
                        return None
                else:
                    return None
        
        # æŸ¥æ‰¾é¤˜é¡ - é€šå¸¸æ˜¯Balanceåˆ—çš„å€¼
        balance_match = re.search(r'(\d+,?\d*\.\d{2})(?:\s*$)', line)
        balance = None
        if balance_match:
            try:
                balance = float(balance_match.group(1).replace(',', ''))
            except ValueError:
                pass
        
        # é©—è­‰æ•¸æ“šåˆç†æ€§
        if amount <= 0 or amount > 10000:  # é‡‘é¡æ‡‰è©²åœ¨åˆç†ç¯„åœå…§
            return None
        
        if balance and balance < 0:  # é¤˜é¡ä¸æ‡‰è©²ç‚ºè² æ•¸
            return None
        
        invoice = {
            'date': date_str,
            'invoice_no': invoice_no,
            'amount': amount,
            'balance': balance,
            'raw_line': line
        }
        
        return invoice
    
    def _read_excel_smart_ui(self):
        """æ™ºèƒ½è¯»å–Excel UI"""
        excel_path = self.excel_path_var.get().strip()
        if not excel_path:
            self._log("âŒ è«‹å…ˆé¸æ“‡Consolidate Excelæ–‡ä»¶")
            return
        
        if not os.path.exists(excel_path):
            self._log("âŒ Excelæ–‡ä»¶ä¸å­˜åœ¨")
            return
        
        self._log("ğŸ“Š é–‹å§‹æ™ºèƒ½è®€å–Excelæ•¸æ“š...")
        try:
            from openpyxl import load_workbook
            from openpyxl.utils import get_column_letter
            
            # åŠ è¼‰å·¥ä½œç°¿
            wb = load_workbook(excel_path, data_only=True)
            
            # è®€å–æ‰€æœ‰å» å•†çš„å·¥ä½œè¡¨è³‡æ–™
            target_sheets = ["Oriental", "Aries Fresh", "Ever-Shine"]
            all_excel_data = {}
            
            self._log(f"ğŸ“‹ å·¥ä½œç°¿ä¸­çš„æ‰€æœ‰å·¥ä½œè¡¨: {wb.sheetnames}")
            
            for sheet_name in target_sheets:
                if sheet_name in wb.sheetnames:
                    self._log(f"ğŸ“‹ æ­£åœ¨è®€å–å·¥ä½œè¡¨: {sheet_name}")
                    ws = wb[sheet_name]
                    
                    # æ™ºèƒ½è­˜åˆ¥çµæ§‹
                    structure_result = self._identify_excel_structure(ws)
                    if structure_result[0] == 'ORIENTAL_FORMAT':
                        # Orientalæ ¼å¼ï¼šç›´æ¥ä½¿ç”¨ç”Ÿæˆçš„æ—¥æœŸå’Œé–€å¸‚åˆ—
                        outlet_col = structure_result[1]
                        dates = structure_result[2]
                        date_row = 'ORIENTAL_FORMAT'  # è¨­ç½®ç‰¹æ®Šæ¨™è¨˜
                        self._log(f"ğŸ¯ {sheet_name} ä½¿ç”¨Orientalæ ¼å¼ï¼šé–€å¸‚åˆ— {get_column_letter(outlet_col)}, ç”Ÿæˆ {len(dates)} å€‹æ—¥æœŸ")
                    else:
                        # æ¨™æº–æ ¼å¼ï¼šè§£ææ—¥æœŸè¡Œ
                        date_row, outlet_col, dates = structure_result
                        if date_row is None or outlet_col is None:
                            self._log(f"âŒ ç„¡æ³•è­˜åˆ¥ {sheet_name} å·¥ä½œè¡¨çµæ§‹")
                            continue
                        
                        self._log(f"ğŸ“… {sheet_name} æ—¥æœŸè¡Œ: {date_row}, é–€å¸‚åˆ—: {get_column_letter(outlet_col)}")
                        
                        # è§£ææ—¥æœŸ
                        dates = self._parse_excel_dates(ws, date_row)
                        if not dates:
                            self._log(f"âŒ ç„¡æ³•è§£æ {sheet_name} æ—¥æœŸ")
                            continue
                    
                    self._log(f"âœ… {sheet_name} æˆåŠŸè§£æ {len(dates)} å€‹æ—¥æœŸ")
                    
                    # è®€å–é–€å¸‚æ•¸æ“š
                    outlets = self._read_excel_outlets(ws, outlet_col, date_row, dates)
                    if not outlets:
                        self._log(f"âŒ ç„¡æ³•è®€å– {sheet_name} é–€å¸‚æ•¸æ“š")
                        continue
                    
                    self._log(f"âœ… {sheet_name} æˆåŠŸè®€å– {len(outlets)} å€‹é–€å¸‚")
                    
                    # ä¿å­˜è©²å» å•†çš„æ•¸æ“š
                    all_excel_data[sheet_name] = {
                        'sheet_name': sheet_name,
                        'dates': dates,
                        'outlets': outlets,
                        'file_path': excel_path
                    }
                else:
                    self._log(f"âš ï¸ æœªæ‰¾åˆ° {sheet_name} å·¥ä½œè¡¨")
            
            if not all_excel_data:
                self._log("âŒ æ²’æœ‰æˆåŠŸè®€å–ä»»ä½•å·¥ä½œè¡¨æ•¸æ“š")
                wb.close()
                return
            
            # ä¿å­˜æ‰€æœ‰å» å•†çš„æ•¸æ“š
            self.excel_data = all_excel_data
            
            wb.close()
            self._log("ğŸ‰ Excelæ•¸æ“šè®€å–å®Œæˆï¼")
            
            # æ›´æ–°Excelæ•¸æ“šæ¨™ç±¤é 
            self._update_excel_data_tab()
            
        except Exception as e:
            self._log(f"âŒ Excelè®€å–å¤±æ•—: {str(e)}")
            import traceback
            self._log(f"ğŸ” éŒ¯èª¤è©³æƒ…: {traceback.format_exc()}")
    
    def _identify_excel_structure(self, ws):
        """æ™ºèƒ½è­˜åˆ¥Excelçµæ§‹ - é‡å°Orientalæ ¼å¼å„ªåŒ–"""
        try:
            self._log(f"ğŸ” é–‹å§‹æ™ºèƒ½è­˜åˆ¥Excelçµæ§‹...")
            self._log(f"  å·¥ä½œè¡¨å¤§å°: {ws.max_row} è¡Œ x {ws.max_column} åˆ—")
            
            # é‡å°Orientalæ ¼å¼çš„ç‰¹æ®Šè™•ç†ï¼šæ²’æœ‰æ—¥æœŸè¡Œï¼Œæ—¥æœŸé€šéåˆ—ä½ç½®è¡¨ç¤º
            # ç¬¬1è¡Œï¼šORIENTALï¼ˆæ¨™é¡Œï¼‰
            # ç¬¬2è¡Œï¼šCode, Outletsï¼ˆåˆ—æ¨™é¡Œï¼‰
            # ç¬¬3è¡Œé–‹å§‹ï¼šé–€å¸‚æ•¸æ“šï¼Œæ¯è¡ŒåŒ…å«é–€å¸‚ä»£ç¢¼ã€é–€å¸‚åç¨±å’Œæ¯æ—¥é‡‘é¡
            
            # æª¢æŸ¥æ˜¯å¦æ˜¯Orientalæ ¼å¼
            first_row = ws.cell(row=1, column=1).value
            second_row_a = ws.cell(row=2, column=1).value
            second_row_b = ws.cell(row=2, column=2).value
            
            # æª¢æŸ¥Orientalæ ¼å¼ï¼šç¬¬1è¡ŒåŒ…å«"ORIENTAL"ï¼Œç¬¬2è¡Œæœ‰CODEå’ŒOUTLETS
            is_oriental = (isinstance(first_row, str) and 'ORIENTAL' in first_row.upper() and
                          isinstance(second_row_a, str) and 'CODE' in second_row_a.upper() and
                          isinstance(second_row_b, str) and 'OUTLETS' in second_row_b.upper())
            
            # æª¢æŸ¥Aries Freshæ ¼å¼ï¼šç¬¬2è¡Œæœ‰CODEå’ŒOUTLETSï¼ˆä½†ç¬¬1è¡Œä¸æ˜¯ORIENTALï¼‰
            is_aries_fresh = (not is_oriental and
                             isinstance(second_row_a, str) and 'CODE' in second_row_a.upper() and
                             isinstance(second_row_b, str) and 'OUTLETS' in second_row_b.upper())
            
            if is_oriental or is_aries_fresh:
                
                format_name = "Oriental" if is_oriental else "Aries Fresh"
                self._log(f"  ğŸ¯ æª¢æ¸¬åˆ°{format_name}æ ¼å¼ï¼šæ²’æœ‰æ—¥æœŸè¡Œï¼Œæ—¥æœŸé€šéåˆ—ä½ç½®è¡¨ç¤º")
                
                # é–€å¸‚åˆ—æ˜¯ç¬¬2åˆ—ï¼ˆBåˆ—ï¼‰
                outlet_col = 2
                self._log(f"  ğŸª é–€å¸‚åˆ—: åˆ— B (Outlets)")
                
                # æ•¸æ“šå¾ç¬¬3è¡Œé–‹å§‹
                data_start_row = 3
                self._log(f"  ğŸ“Š æ•¸æ“šé–‹å§‹è¡Œ: ç¬¬ {data_start_row} è¡Œ")
                
                # æ—¥æœŸåˆ—å¾ç¬¬3åˆ—ï¼ˆCåˆ—ï¼‰é–‹å§‹ï¼Œæ¯åˆ—ä»£è¡¨ä¸€å¤©
                # åŸºæ–¼æª¢æ¸¬åˆ°çš„æœˆä»½ä½œç‚ºåŸºæº–æœˆä»½
                from datetime import datetime, timedelta
                
                # æª¢æŸ¥ç¬¬2è¡Œæ˜¯å¦åŒ…å«æœˆä»½ä¿¡æ¯
                month_patterns = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec']
                detected_month = None
                detected_year = None
                
                # æ·»åŠ è°ƒè¯•ä¿¡æ¯
                self._log(f"  ğŸ” é–‹å§‹æª¢æ¸¬ç¬¬2è¡Œçš„æœˆä»½ä¿¡æ¯...")
                
                for col in range(3, min(21, ws.max_column + 1)):
                    cell_value = ws.cell(row=2, column=col).value
                    self._log(f"    åˆ— {get_column_letter(col)}: '{cell_value}' (é¡å‹: {type(cell_value)})")
                    
                    # æª¢æŸ¥æ˜¯å¦æ˜¯æ—¥æœŸæ™‚é–“å°è±¡
                    if hasattr(cell_value, 'month') and hasattr(cell_value, 'year'):
                        detected_month = month_patterns[cell_value.month - 1]  # æœˆä»½å¾1é–‹å§‹ï¼Œæ‰€ä»¥æ¸›1
                        detected_year = cell_value.year
                        self._log(f"  ğŸ¯ æª¢æ¸¬åˆ°æ—¥æœŸæ™‚é–“å°è±¡: æœˆä»½={detected_month}, å¹´ä»½={detected_year}")
                        break
                    
                    # æª¢æŸ¥å­—ç¬¦ä¸²æ ¼å¼çš„æ—¥æœŸ
                    if cell_value and isinstance(cell_value, str):
                        # æª¢æŸ¥ "1-Aug" æ ¼å¼
                        if '-' in str(cell_value):
                            parts = str(cell_value).split('-')
                            self._log(f"      åˆ†å‰²å¾Œ: {parts}")
                            
                            if len(parts) == 2:
                                day_part, month_part = parts
                                self._log(f"      æ—¥æœŸéƒ¨åˆ†: '{day_part}', æœˆä»½éƒ¨åˆ†: '{month_part}'")
                                
                                if day_part.isdigit() and month_part.lower()[:3] in month_patterns:
                                    detected_month = month_part.lower()[:3]
                                    detected_year = datetime.now().year
                                    self._log(f"  ğŸ¯ æª¢æ¸¬åˆ°æœˆä»½: {detected_month}, å¹´ä»½: {detected_year}")
                                    break
                                else:
                                    self._log(f"      æª¢æŸ¥å¤±æ•—: day_part.isdigit()={day_part.isdigit()}, month_part.lower()[:3]='{month_part.lower()[:3]}' in month_patterns={month_part.lower()[:3] in month_patterns}")
                        
                        # æª¢æŸ¥ "2025-08-01" æ ¼å¼
                        elif cell_value.count('-') == 2:
                            try:
                                # å˜—è©¦è§£æç‚ºæ—¥æœŸ
                                date_obj = datetime.strptime(cell_value, '%Y-%m-%d')
                                detected_month = month_patterns[date_obj.month - 1]
                                detected_year = date_obj.year
                                self._log(f"  ğŸ¯ æª¢æ¸¬åˆ°æ—¥æœŸæ ¼å¼: æœˆä»½={detected_month}, å¹´ä»½={detected_year}")
                                break
                            except ValueError:
                                self._log(f"      ç„¡æ³•è§£ææ—¥æœŸæ ¼å¼: {cell_value}")
                
                # å¦‚æœé‚„æ˜¯æ²’æœ‰æª¢æ¸¬åˆ°ï¼Œå˜—è©¦æ›´å¯¬é¬†çš„æª¢æ¸¬
                if not detected_month:
                    self._log(f"  ğŸ” å˜—è©¦æ›´å¯¬é¬†çš„æœˆä»½æª¢æ¸¬...")
                    for col in range(3, min(21, ws.max_column + 1)):
                        cell_value = ws.cell(row=2, column=col).value
                        if cell_value and isinstance(cell_value, str):
                            # ç›´æ¥æª¢æŸ¥æ˜¯å¦åŒ…å«æœˆä»½ç¸®å¯«
                            for month_abbr in month_patterns:
                                if month_abbr in cell_value.lower():
                                    detected_month = month_abbr
                                    detected_year = datetime.now().year
                                    self._log(f"  ğŸ¯ é€šéå¯¬é¬†æª¢æ¸¬æ‰¾åˆ°æœˆä»½: {detected_month}, å¹´ä»½: {detected_year}")
                                    break
                            if detected_month:
                                break
                
                # å¦‚æœæª¢æ¸¬åˆ°æœˆä»½ä¿¡æ¯ï¼Œä½¿ç”¨æª¢æ¸¬åˆ°çš„æœˆä»½ï¼›å¦å‰‡ä½¿ç”¨ç•¶å‰æœˆä»½
                if detected_month and detected_year:
                    month_map = {
                        'jan': 1, 'feb': 2, 'mar': 3, 'apr': 4,
                        'may': 5, 'jun': 6, 'jul': 7, 'aug': 8,
                        'sep': 9, 'oct': 10, 'nov': 11, 'dec': 12
                    }
                    detected_month_num = month_map.get(detected_month, 7)
                    base_date = datetime(detected_year, detected_month_num, 1)
                    self._log(f"  ğŸ“… ä½¿ç”¨æª¢æ¸¬åˆ°çš„åŸºæº–æ—¥æœŸ: {base_date.strftime('%Y-%m-%d')}")
                else:
                    # å¦‚æœç„¡æ³•æª¢æ¸¬åˆ°æœˆä»½ï¼Œä½¿ç”¨ç•¶å‰æœˆä»½
                    current_date = datetime.now()
                    base_date = current_date.replace(day=1)
                    self._log(f"  ğŸ“… ä½¿ç”¨ç•¶å‰æœˆä»½ä½œç‚ºåŸºæº–æ—¥æœŸ: {base_date.strftime('%Y-%m-%d')}")
                
                dates = []
                for col in range(3, ws.max_column + 1):
                    # è¨ˆç®—æ—¥æœŸï¼šCåˆ—=7æœˆ1æ—¥ï¼ŒDåˆ—=7æœˆ2æ—¥ï¼Œä»¥æ­¤é¡æ¨
                    days_offset = col - 3
                    date_value = base_date + timedelta(days=days_offset)
                    date_str = date_value.strftime('%d/%m/%y')
                    
                    dates.append({
                        'column': get_column_letter(col),
                        'date': date_str,
                        'col_index': col,
                        'original_value': f'åˆ—{get_column_letter(col)}',
                        'datetime': date_value
                    })
                
                self._log(f"  ğŸ“… åŸºæ–¼åˆ—ä½ç½®ç”Ÿæˆ {len(dates)} å€‹æ—¥æœŸ")
                
                # è¿”å›ç‰¹æ®Šæ¨™è¨˜ï¼Œè¡¨ç¤ºé€™æ˜¯Orientalæ ¼å¼
                return 'ORIENTAL_FORMAT', outlet_col, dates
            
            # å¦‚æœä¸æ˜¯Orientalæ ¼å¼ï¼Œä½¿ç”¨åŸæœ‰çš„æ—¥æœŸè¡Œè­˜åˆ¥é‚è¼¯
            self._log(f"  ğŸ“… ä½¿ç”¨æ¨™æº–æ—¥æœŸè¡Œè­˜åˆ¥é‚è¼¯...")
            
            # æŸ¥æ‰¾æ—¥æœŸè¡Œï¼ˆé€šå¸¸åœ¨å‰10è¡Œï¼‰
            date_row = None
            for row in range(1, min(11, ws.max_row + 1)):
                self._log(f"    æª¢æŸ¥ç¬¬ {row} è¡Œ...")
                date_cells = 0
                total_cells = 0
                
                for col in range(1, min(21, ws.max_column + 1)):
                    cell_value = ws.cell(row=row, column=col).value
                    if cell_value:
                        total_cells += 1
                        col_letter = get_column_letter(col)
                        self._log(f"      åˆ— {col_letter}: '{cell_value}' (é¡å‹: {type(cell_value)})")
                        
                        # æª¢æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ—¥æœŸæˆ–æ—¥æœŸå…¬å¼
                        if self._is_valid_date_or_formula(cell_value):
                            date_cells += 1
                            self._log(f"        âœ… æœ‰æ•ˆæ—¥æœŸ/å…¬å¼")
                        else:
                            self._log(f"        âŒ ç„¡æ•ˆæ—¥æœŸ/å…¬å¼")
                
                # é™ä½é–¾å€¼åˆ°30%ï¼Œå› ç‚ºæœ‰äº›è¡Œå¯èƒ½åªæœ‰éƒ¨åˆ†æ—¥æœŸ
                if total_cells > 0 and date_cells / total_cells > 0.3:
                    date_row = row
                    self._log(f"      âœ… æ‰¾åˆ°æ—¥æœŸè¡Œ: ç¬¬ {row} è¡Œ (æ—¥æœŸå–®å…ƒæ ¼: {date_cells}/{total_cells})")
                    break
                else:
                    self._log(f"      âŒ ç¬¬ {row} è¡Œä¸æ˜¯æ—¥æœŸè¡Œ (æ—¥æœŸå–®å…ƒæ ¼: {date_cells}/{total_cells})")
            
            if not date_row:
                self._log(f"      âŒ æœªæ‰¾åˆ°æ—¥æœŸè¡Œ")
                return None, None, None
            
            # æŸ¥æ‰¾é–€å¸‚åˆ—ï¼ˆé€šå¸¸åœ¨Aã€Bã€Cåˆ—ï¼‰â€” ä½¿ç”¨è©•åˆ†é¸æ“‡æ›´åƒ"åç¨±"çš„åˆ—
            outlet_col = None
            self._log(f"  ğŸª æŸ¥æ‰¾é–€å¸‚åˆ—...")
            best_score = -1
            for col in [1, 2, 3]:  # A, B, Cåˆ—
                if col <= ws.max_column:
                    score = 0
                    col_letter = get_column_letter(col)
                    self._log(f"    æª¢æŸ¥åˆ— {col_letter}...")
                    for row in range(date_row + 1, min(date_row + 31, ws.max_row + 1)):
                        value = ws.cell(row=row, column=col).value
                        if value is None:
                            continue
                        # æ–‡æœ¬ä¸”åŒ…å«å­—æ¯æˆ–ç©ºæ ¼ï¼Œçµ¦è¼ƒé«˜åˆ†
                        if isinstance(value, str):
                            txt = value.strip()
                            if len(txt) >= 2:
                                if any(ch.isalpha() for ch in txt):
                                    score += 3
                                # ç´”æ•¸å­—çš„å­—ç¬¦ä¸²ä¸çµ¦åˆ†
                                elif not txt.isdigit():
                                    score += 1
                        # ç´”æ•¸å­—ï¼ˆé–€åº—ä»£ç¢¼ï¼‰é™ä½åˆ†
                        elif isinstance(value, (int, float)):
                            score -= 2
                    self._log(f"      åˆ— {col_letter} å¾—åˆ†: {score}")
                    if score > best_score:
                        best_score = score
                        outlet_col = col
            if outlet_col:
                col_letter = get_column_letter(outlet_col)
                self._log(f"      âœ… åˆ¤å®šé–€å¸‚åˆ—: åˆ— {col_letter} (å¾—åˆ† {best_score})")
            
            if not outlet_col:
                self._log(f"      âŒ æœªæ‰¾åˆ°é–€å¸‚åˆ—")
                return None, None
            
            self._log(f"  âœ… çµæ§‹è­˜åˆ¥å®Œæˆ: æ—¥æœŸè¡Œ={date_row}, é–€å¸‚åˆ—={get_column_letter(outlet_col)}")
            return date_row, outlet_col
            
        except Exception as e:
            self._log(f"âŒ çµæ§‹è­˜åˆ¥å¤±æ•—: {str(e)}")
            return None, None
    
    def _is_valid_date_or_formula(self, value):
        """æª¢æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ—¥æœŸæˆ–æ—¥æœŸå…¬å¼ï¼ˆæ›´åš´æ ¼çš„åˆ¤æ–·ï¼‰"""
        try:
            if isinstance(value, str):
                # æ’é™¤æ˜é¡¯çš„éæ—¥æœŸå…§å®¹
                if value.lower() in ['code', 'outlets', 'oriental', 'ever-shine']:
                    return False
                
                # æª¢æŸ¥æ˜¯å¦æ˜¯è·¨å·¥ä½œè¡¨çš„å¼•ç”¨å…¬å¼ï¼ˆé€™äº›é€šå¸¸ä¸æ˜¯æ—¥æœŸï¼‰
                if value.startswith("='") and "!" in value:
                    return False
                
                # æª¢æŸ¥æ˜¯å¦æ˜¯WEEKDAYå‡½æ•¸ï¼ˆé€™äº›é€šå¸¸ä¸æ˜¯æ—¥æœŸï¼‰
                if value.startswith('=WEEKDAY('):
                    return False
                
                # æª¢æŸ¥æ˜¯å¦æ˜¯æ—¥æœŸå…¬å¼
                if value.startswith('='):
                    # æª¢æŸ¥æ˜¯å¦åŒ…å«æ—¥æœŸç›¸é—œçš„é—œéµè©
                    date_keywords = ['date', 'today', 'now', '+', '-']
                    return any(keyword in value.lower() for keyword in date_keywords)
                
                # æª¢æŸ¥æ˜¯å¦æ˜¯æ—¥æœŸæ ¼å¼
                date_patterns = [
                    r'\d{1,2}[/-]\d{1,2}[/-]\d{2,4}',  # dd/mm/yy, dd-mm-yy
                    r'\d{1,2}-[A-Za-z]{3}',  # 1-Jul, 2-Aug
                    r'\d{4}-\d{1,2}-\d{1,2}'  # yyyy-mm-dd
                ]
                return any(re.match(pattern, str(value)) for pattern in date_patterns)
            
            # æª¢æŸ¥æ˜¯å¦æ˜¯datetimeå°è±¡
            if hasattr(value, 'strftime'):
                return True
            
            # æª¢æŸ¥æ˜¯å¦æ˜¯Excelæ—¥æœŸåºåˆ—è™Ÿ
            if isinstance(value, (int, float)) and value > 1000:
                return True
            
            return False
        except:
            return False
    
    def _parse_excel_dates(self, ws, date_row):
        """æ™ºèƒ½è§£æExcelæ—¥æœŸï¼ˆè™•ç†å…¬å¼ï¼‰"""
        try:
            dates = []
            base_date = None
            
            self._log(f"ğŸ” é–‹å§‹è§£æç¬¬ {date_row} è¡Œçš„æ—¥æœŸ...")
            
            for col in range(1, ws.max_column + 1):
                cell = ws.cell(row=date_row, column=col)
                cell_value = cell.value
                
                if not cell_value:
                    continue
                
                col_letter = get_column_letter(col)
                self._log(f"  ğŸ“… åˆ— {col_letter}: å€¼ = '{cell_value}' (é¡å‹: {type(cell_value)})")
                
                # è™•ç†æ—¥æœŸå…¬å¼
                if isinstance(cell_value, str) and cell_value.startswith('='):
                    self._log(f"    ğŸ”§ æª¢æ¸¬åˆ°å…¬å¼: {cell_value}")
                    date_value = self._evaluate_date_formula(cell_value, base_date, col)
                    if date_value:
                        self._log(f"    âœ… å…¬å¼è§£ææˆåŠŸ: {date_value}")
                    else:
                        self._log(f"    âŒ å…¬å¼è§£æå¤±æ•—")
                else:
                    self._log(f"    ğŸ“ å˜—è©¦è§£ææ™®é€šæ—¥æœŸå€¼")
                    date_value = self._parse_date_value(cell_value)
                    if date_value:
                        self._log(f"    âœ… æ—¥æœŸè§£ææˆåŠŸ: {date_value}")
                    else:
                        self._log(f"    âŒ æ—¥æœŸè§£æå¤±æ•—")
                
                if date_value:
                    if base_date is None:
                        base_date = date_value
                        self._log(f"    ğŸ¯ è¨­ç½®åŸºæº–æ—¥æœŸ: {base_date}")
                    
                    date_str = date_value.strftime('%d/%m/%y')
                    dates.append({
                        'column': col,
                        'date': date_str,
                        'col_index': col,
                        'original_value': str(cell_value),
                        'datetime': date_value
                    })
                    self._log(f"    ğŸ“… æ·»åŠ æ—¥æœŸ: {date_str}")
                else:
                    self._log(f"    âš ï¸ è·³éç„¡æ•ˆæ—¥æœŸå€¼")
            
            self._log(f"ğŸ“Š ç¸½å…±è§£æåˆ° {len(dates)} å€‹æœ‰æ•ˆæ—¥æœŸ")
            return dates
        except Exception as e:
            self._log(f"âŒ æ—¥æœŸè§£æå¤±æ•—: {str(e)}")
            return []
    
    def _evaluate_date_formula(self, formula, base_date, col_index):
        """è©•ä¼°æ—¥æœŸå…¬å¼"""
        try:
            self._log(f"        ğŸ”§ è©•ä¼°å…¬å¼: '{formula}' (åŸºæº–æ—¥æœŸ: {base_date}, åˆ—: {col_index})")
            
            # è™•ç†å¸¸è¦‹çš„æ—¥æœŸå…¬å¼æ¨¡å¼
            if '=' in formula:
                # è™•ç† =C2+1, =E2+1 ç­‰æ¨¡å¼
                if '+' in formula:
                    # ç°¡åŒ–é‚è¼¯ï¼šç›´æ¥åŸºæ–¼åˆ—ä½ç½®è¨ˆç®—æ—¥æœŸ
                    try:
                        # å˜—è©¦å¾å·¥ä½œè¡¨ä¸­æª¢æ¸¬åŸºæº–æœˆä»½
                        base_date = self._detect_base_date_from_worksheet()
                        if not base_date:
                            # å¦‚æœç„¡æ³•æª¢æ¸¬ï¼Œä½¿ç”¨ç•¶å‰æœˆä»½
                            current_date = datetime.now()
                            base_date = current_date.replace(day=1)
                        
                        days_offset = col_index - 3  # Cåˆ—æ˜¯ç¬¬3åˆ—ï¼Œå¾0é–‹å§‹è¨ˆç®—
                        if days_offset >= 0:
                            result = base_date + timedelta(days=days_offset)
                            self._log(f"        âœ… åŸºæ–¼åˆ—ä½ç½®è¨ˆç®—æ—¥æœŸ: {base_date} + {days_offset}å¤© = {result}")
                            return result
                    except Exception as e:
                        self._log(f"        âŒ åˆ—ä½ç½®æ—¥æœŸè¨ˆç®—å¤±æ•—: {str(e)}")
                
                # è™•ç† =C2-1 ç­‰æ¨¡å¼
                elif '-' in formula:
                    parts = formula.split('-')
                    if len(parts) == 2 and parts[1].strip().isdigit():
                        days_to_subtract = int(parts[1].strip())
                        if base_date:
                            result = base_date - timedelta(days=days_to_subtract)
                            self._log(f"        âœ… æ¸›æ³•å…¬å¼è§£ææˆåŠŸ: {base_date} - {days_to_subtract}å¤© = {result}")
                            return result
                        else:
                            self._log(f"        âŒ ç¼ºå°‘åŸºæº–æ—¥æœŸ")
                
                # è™•ç† =C2 ç­‰å¼•ç”¨å…¬å¼
                elif '=' in formula and not ('+' in formula or '-' in formula):
                    self._log(f"        â„¹ï¸ å¼•ç”¨å…¬å¼ï¼Œéœ€è¦åŸºæº–æ—¥æœŸ")
                    if base_date:
                        result = base_date
                        self._log(f"        âœ… ä½¿ç”¨åŸºæº–æ—¥æœŸ: {result}")
                        return result
            
            # å¦‚æœç„¡æ³•è§£æå…¬å¼ï¼Œå˜—è©¦åŸºæ–¼åˆ—ä½ç½®è¨ˆç®—
            if base_date and col_index > 1:
                days_offset = col_index - 1
                result = base_date + timedelta(days=days_offset)
                self._log(f"        âœ… åŸºæ–¼åˆ—ä½ç½®è¨ˆç®—: {base_date} + {days_offset}å¤© = {result}")
                return result
            elif col_index > 1:
                # å¦‚æœæ²’æœ‰åŸºæº–æ—¥æœŸï¼Œå˜—è©¦åŸºæ–¼åˆ—ä½ç½®å’Œæª¢æ¸¬åˆ°çš„æœˆä»½ä½œç‚ºåŸºæº–
                try:
                    # å˜—è©¦å¾å·¥ä½œè¡¨ä¸­æª¢æ¸¬åŸºæº–æœˆä»½
                    base_date = self._detect_base_date_from_worksheet()
                    if not base_date:
                        # å¦‚æœç„¡æ³•æª¢æ¸¬ï¼Œä½¿ç”¨ç•¶å‰æœˆä»½
                        current_date = datetime.now()
                        base_date = current_date.replace(day=1)
                    
                    days_offset = col_index - 3  # Cåˆ—æ˜¯ç¬¬3åˆ—ï¼Œå¾0é–‹å§‹è¨ˆç®—
                    if days_offset >= 0:
                        result = base_date + timedelta(days=days_offset)
                        self._log(f"        âœ… ä½¿ç”¨æª¢æ¸¬åˆ°çš„åŸºæº–æ—¥æœŸè¨ˆç®—: {base_date} + {days_offset}å¤© = {result}")
                        return result
                except Exception as e:
                    self._log(f"        âŒ åŸºæº–æ—¥æœŸè¨ˆç®—å¤±æ•—: {str(e)}")
            else:
                self._log(f"        âŒ ç„¡æ³•è¨ˆç®—: ç¼ºå°‘åŸºæº–æ—¥æœŸæˆ–åˆ—ä½ç½®ç„¡æ•ˆ")
                
        except Exception as e:
            self._log(f"        âŒ å…¬å¼è©•ä¼°ç•°å¸¸: {str(e)}")
        
        return None
    
    def _parse_date_value(self, value):
        """è§£ææ—¥æœŸå€¼"""
        try:
            self._log(f"      ğŸ” è§£ææ—¥æœŸå€¼: '{value}' (é¡å‹: {type(value)})")
            
            # æª¢æŸ¥æ˜¯å¦æ˜¯datetimeå°è±¡
            if hasattr(value, 'strftime'):
                self._log(f"      âœ… å·²ç¶“æ˜¯datetimeå°è±¡: {value}")
                return value
            
            # æª¢æŸ¥æ˜¯å¦æ˜¯Excelæ—¥æœŸåºåˆ—è™Ÿ
            if isinstance(value, (int, float)) and value > 1000:
                try:
                    from openpyxl.utils.datetime import from_excel
                    excel_date = from_excel(value)
                    self._log(f"      âœ… Excelåºåˆ—è™Ÿè½‰æ›æˆåŠŸ: {excel_date}")
                    return excel_date
                except:
                    self._log(f"      âš ï¸ Excelåºåˆ—è™Ÿè½‰æ›å¤±æ•—")
            
            if isinstance(value, str):
                self._log(f"      ğŸ“ è™•ç†å­—ç¬¦ä¸²å€¼")
                
                # è™•ç† "1-Jul" æ ¼å¼
                if '-' in value and len(value.split('-')) == 2:
                    day, month = value.split('-')
                    if day.isdigit():
                        day = int(day)
                        # ç°¡åŒ–çš„æœˆä»½æ˜ å°„
                        month_map = {
                            'jan': 1, 'feb': 2, 'mar': 3, 'apr': 4,
                            'may': 5, 'jun': 6, 'jul': 7, 'aug': 8,
                            'sep': 9, 'oct': 10, 'nov': 11, 'dec': 12
                        }
                        month_str = month.lower()[:3]
                        if month_str in month_map:
                            month = month_map[month_str]
                            # å‡è¨­ç•¶å‰å¹´ä»½
                            year = datetime.now().year
                            result = datetime(year, month, day)
                            self._log(f"      âœ… 1-Julæ ¼å¼è§£ææˆåŠŸ: {result}")
                            return result
                        else:
                            self._log(f"      âŒ æœˆä»½æ˜ å°„å¤±æ•—: {month_str}")
                
                # è™•ç†å…¶ä»–æ—¥æœŸæ ¼å¼
                date_formats = ['%d/%m/%y', '%d-%m-%y', '%Y-%m-%d', '%d/%m/%Y', '%m/%d/%y', '%m-%d-%y']
                for fmt in date_formats:
                    try:
                        result = datetime.strptime(value, fmt)
                        self._log(f"      âœ… æ ¼å¼ {fmt} è§£ææˆåŠŸ: {result}")
                        return result
                    except ValueError:
                        continue
                
                self._log(f"      âŒ æ‰€æœ‰æ—¥æœŸæ ¼å¼éƒ½è§£æå¤±æ•—")
            else:
                self._log(f"      âŒ ä¸æ”¯æŒçš„å€¼é¡å‹: {type(value)}")
            
        except Exception as e:
            self._log(f"      âŒ è§£æç•°å¸¸: {str(e)}")
        
        return None
    
    def _read_excel_outlets(self, ws, outlet_col, date_row, dates):
        """æ™ºèƒ½è®€å–Excelé–€å¸‚æ•¸æ“š - æ”¯æŒOrientalæ ¼å¼"""
        try:
            outlets = []
            col_letter = get_column_letter(outlet_col)
            self._log(f"ğŸ” é–‹å§‹è®€å–é–€å¸‚æ•¸æ“š...")
            self._log(f"  é–€å¸‚åˆ—: {col_letter}")
            
            # ç¢ºå®šæ•¸æ“šé–‹å§‹è¡Œ
            if date_row == 'ORIENTAL_FORMAT':
                # Orientalæ ¼å¼ï¼šæ•¸æ“šå¾ç¬¬3è¡Œé–‹å§‹
                data_start_row = 3
                self._log(f"  ğŸ“Š Orientalæ ¼å¼ï¼šæ•¸æ“šå¾ç¬¬ {data_start_row} è¡Œé–‹å§‹")
            else:
                # æ¨™æº–æ ¼å¼ï¼šæ•¸æ“šå¾æ—¥æœŸè¡Œ+1é–‹å§‹
                data_start_row = date_row + 1
                self._log(f"  ğŸ“Š æ¨™æº–æ ¼å¼ï¼šæ•¸æ“šå¾ç¬¬ {data_start_row} è¡Œé–‹å§‹")
            
            for row in range(data_start_row, ws.max_row + 1):
                outlet_name = ws.cell(row=row, column=outlet_col).value
                if not outlet_name:
                    continue
                
                self._log(f"  ğŸª è™•ç†é–€å¸‚: '{outlet_name}' (è¡Œ {row})")
                
                outlet_info = {
                    'name': str(outlet_name).strip(),
                    'row': row,
                    'daily_data': {}
                }
                
                # è®€å–è©²é–€å¸‚çš„æ¯æ—¥é‡‘é¡
                for date_info in dates:
                    amount_cell = ws.cell(row=row, column=date_info['col_index'])
                    if amount_cell.value:
                        try:
                            amount = float(amount_cell.value)
                            outlet_info['daily_data'][date_info['date']] = amount
                            if amount > 0:
                                self._log(f"    ğŸ“… {date_info['date']}: ${amount:.2f}")
                        except (ValueError, TypeError):
                            outlet_info['daily_data'][date_info['date']] = 0.0
                    else:
                        outlet_info['daily_data'][date_info['date']] = 0.0
                
                outlets.append(outlet_info)
            
            self._log(f"  âœ… æˆåŠŸè®€å– {len(outlets)} å€‹é–€å¸‚")
            return outlets
        except Exception as e:
            self._log(f"âŒ é–€å¸‚æ•¸æ“šè®€å–å¤±æ•—: {str(e)}")
            return []
    
    def _update_and_compare_ui(self):
        """å¤šå» å•†åŒ¹é…å¹¶æ›´æ–°/å¯¹æ¯”UI"""
        # æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•PDFæ•¸æ“š
        active_vendors = [v for v in self.pdf_files.keys() if self.pdf_files[v].get('data')]
        if not active_vendors:
            self._log("âŒ è«‹å…ˆæå–è‡³å°‘ä¸€å€‹å» å•†çš„PDFæ•¸æ“š")
            return
        
        if not self.excel_data:
            self._log("âŒ è«‹å…ˆè®€å–Excelæ•¸æ“š")
            return
        
        config_path = self.config_path_var.get().strip()
        if not config_path or not os.path.exists(config_path):
            self._log("âŒ è«‹å…ˆé¸æ“‡Config Excelæ–‡ä»¶")
            return
        
        consolidate_path = self.excel_path_var.get().strip()
        if not consolidate_path or not os.path.exists(consolidate_path):
            self._log("âŒ è«‹å…ˆé¸æ“‡Consolidate Excelæ–‡ä»¶")
            return
        
        self._log(f"ğŸ”„ é–‹å§‹å¤šå» å•†åŒ¹é…å°æ¯” ({', '.join(active_vendors)})...")
        self._log_compare(f"ğŸ”„ é–‹å§‹å¤šå» å•†åŒ¹é…å°æ¯” ({', '.join(active_vendors)})...")
        
        try:
            from openpyxl import load_workbook
            from openpyxl.styles import PatternFill
            
            # 1) è®€å–é…ç½®æ˜ å°„: B(åˆä½µåº—å) -> C(PDFåº—å)
            self._log("ğŸ“‹ è®€å–é…ç½®æ˜ å°„...")
            self._log_compare("ğŸ“‹ è®€å–é…ç½®æ˜ å°„...")
            map_wb = load_workbook(config_path, data_only=True)
            map_ws = map_wb.active
            
            # å»ºç«‹PDFé–€å¸‚åˆ°Consolidateé–€å¸‚çš„æ˜ å°„
            pdf_to_consolidate = {}
            def _norm(name: str) -> str:
                import re
                s = re.sub(r"[\s\-_/()]+", "", name.upper())
                # å»æ‰å…¬å¸å‰å¾Œç¶´ç­‰å™ªè²è©
                for token in ["SUSHIEXPRESSGROUPPTELTD", "SUSHIEXPRESS", "PTE", "LTD", "@"]:
                    s = s.replace(token, "")
                return s
            
            for row in range(2, map_ws.max_row + 1):
                consolidate_name = map_ws.cell(row=row, column=2).value  # Båˆ—ï¼šConsolidateé–€å¸‚å
                pdf_name = map_ws.cell(row=row, column=3).value         # Cåˆ—ï¼šPDFé–€å¸‚å
                if consolidate_name and pdf_name:
                    pdf_key = str(pdf_name).strip().upper()
                    consolidate_val = str(consolidate_name).strip()
                    pdf_to_consolidate[pdf_key] = consolidate_val
                    pdf_to_consolidate[_norm(pdf_key)] = consolidate_val  # æ­¸ä¸€åŒ–éµï¼Œæ”¯æŒæ¨¡ç³Š
            map_wb.close()
            self._log(f"âœ… é…ç½®æ˜ å°„è®€å–å®Œæˆï¼Œå…± {len(pdf_to_consolidate)} å€‹æ˜ å°„")
            self._log_compare(f"âœ… é…ç½®æ˜ å°„è®€å–å®Œæˆï¼Œå…± {len(pdf_to_consolidate)} å€‹æ˜ å°„")
            
            # 2) åˆä½µæ‰€æœ‰å» å•†çš„PDFé–€å¸‚æ—¥é‡‘é¡ï¼Œé‡‘é¡/1.09ï¼Œä¸¦è¨˜éŒ„ç™¼ç¥¨è™Ÿ
            daily_pdf = {}  # {consolidate_outlet: {dd/mm/yy: {amount: float, invoice_nos: [str], vendors: [str]}}}
            
            # è™•ç†æ¯å€‹æ´»èºå» å•†çš„æ•¸æ“š
            for vendor in active_vendors:
                vendor_data = self.pdf_files[vendor]['data']
                self._log(f"ğŸ“Š è™•ç† {vendor} å» å•†æ•¸æ“š...")
                self._log_compare(f"ğŸ“Š è™•ç† {vendor} å» å•†æ•¸æ“š...")
                
                for inv in vendor_data.get('invoices', []):
                    raw_name = str(inv.get('outlet_name', '')).strip()
                    pdf_name = raw_name.upper()
                    mapped = pdf_to_consolidate.get(pdf_name)
                    if not mapped:
                        mapped = pdf_to_consolidate.get(_norm(pdf_name))
                    if not mapped:
                        # é¡¯ç¤ºæœªåŒ¹é…ä¿¡æ¯
                        self._log(f"[{vendor}] [æœªåŒ¹é…] PDFé–€å¸‚ '{raw_name}' æœªåœ¨é…ç½®ä¸­æ‰¾åˆ°æ˜ å°„ï¼Œè·³éèšåˆ")
                        self._log_compare(f"[{vendor}] [æœªåŒ¹é…] PDFé–€å¸‚ '{raw_name}' æœªåœ¨é…ç½®ä¸­æ‰¾åˆ°æ˜ å°„ï¼Œè·³éèšåˆ")
                        continue
                    date_str = inv.get('date')
                    amt = inv.get('amount', 0) or 0
                    amt = float(amt) / 1.09
                    invoice_no = str(inv.get('invoice_no', '')).strip()
                    if mapped and date_str:
                        entry = daily_pdf.setdefault(mapped, {}).setdefault(date_str, {"amount": 0.0, "invoice_nos": [], "vendors": []})
                        entry["amount"] += amt
                        if invoice_no:
                            entry["invoice_nos"].append(f"[{vendor}] {invoice_no}")
                        if vendor not in entry["vendors"]:
                            entry["vendors"].append(vendor)
            
            # 3) æ‰“é–‹åˆä½µè¡¨ï¼Œå¯«å…¥é—œéµæ•¸æ“šåˆ°AKåˆ—ï¼ˆæŒ‰æ˜ å°„å°é½Šï¼‰ä¸¦é€æ—¥å°æ¯”
            wb = load_workbook(consolidate_path)
            
            # æ ¹æ“šæ´»èºå» å•†å°æ¯”å„è‡ªçš„å·¥ä½œè¡¨
            comparison_results = {}
            for vendor in active_vendors:
                self._log(f"ğŸ” è™•ç† {vendor} å» å•†å·¥ä½œè¡¨...")
                self._log_compare(f"ğŸ” è™•ç† {vendor} å» å•†å·¥ä½œè¡¨...")
                
                # é¸æ“‡å°æ‡‰å» å•†çš„å·¥ä½œè¡¨
                if vendor in wb.sheetnames:
                    ws = wb[vendor]
                    self._log(f"ğŸ“‹ é¸æ“‡å·¥ä½œè¡¨: {vendor}")
                else:
                    self._log(f"âš ï¸ æœªæ‰¾åˆ° '{vendor}' å·¥ä½œè¡¨ï¼Œè·³éæ­¤å» å•†")
                    self._log_compare(f"âš ï¸ æœªæ‰¾åˆ° '{vendor}' å·¥ä½œè¡¨ï¼Œè·³éæ­¤å» å•†")
                    continue
            
            # 3.1 æ‰¾å‡ºæ—¥æœŸè¡Œèˆ‡é–€å¸‚åˆ—(B)
            # å›ºå®šä½¿ç”¨ç¬¬2è¡Œä½œç‚ºæ—¥æœŸè¡Œï¼ˆèˆ‡æ™ºèƒ½è­˜åˆ¥ä¸€è‡´ï¼‰ï¼Œè‹¥ç‚ºç©ºå‰‡å›é€€åˆ°è‡ªå‹•æ¢æ¸¬
            date_row = 2
            if not any(ws.cell(row=date_row, column=c).value for c in range(3, ws.max_column + 1)):
                for r in range(1, min(10, ws.max_row + 1)):
                    if any(ws.cell(row=r, column=c).value for c in range(3, ws.max_column + 1)):
                        date_row = r
                        break
            
            # æ§‹é€ åˆ—ç´¢å¼•: æ—¥æœŸ -> åˆ—ï¼ˆæ”¯æŒå…¬å¼ï¼Œé€šéæ™ºèƒ½è§£æç¬¬äºŒè¡Œæ—¥æœŸï¼‰
            date_to_col = {}
            from datetime import datetime as _dt
            import re as _re
            # å¾©ç”¨æ™ºèƒ½æ—¥æœŸè§£æï¼šå¦‚æœæ˜¯å­—ç¬¦ä¸²å…¬å¼å¦‚ =C2+1ï¼Œä¹Ÿèƒ½è§£æ
            base_date = None
            for c in range(1, ws.max_column + 1):
                raw = ws.cell(row=date_row, column=c).value
                parsed = None
                if hasattr(raw, 'strftime'):
                    parsed = raw
                elif isinstance(raw, (int, float)) and raw > 1000:
                    try:
                        from openpyxl.utils.datetime import from_excel as _from_excel
                        parsed = _from_excel(raw)
                    except Exception:
                        parsed = None
                elif isinstance(raw, str):
                    s = raw.strip()
                    if s.startswith('='):
                        # è™•ç† =C2+1 æŒ‰åˆ—åç§»
                        if base_date is None:
                            # æŸ¥æ‰¾å·¦é‚Šæœ€è¿‘ä¸€å€‹éç©ºçš„å·²è§£ææ—¥æœŸä½œç‚ºåŸºæº–
                            for c2 in range(c-1, 0, -1):
                                left = ws.cell(row=date_row, column=c2).value
                                if isinstance(left, str) and not left:
                                    continue
                                if isinstance(left, str) and '/' in left:
                                    try:
                                        base_date = _dt.strptime(left, '%d/%m/%y')
                                        break
                                    except Exception:
                                        pass
                        if base_date is None:
                            # ä½¿ç”¨ 1-Jul ç•¶å‰å¹´ä½œç‚ºåŸºæº–
                            base_date = _dt(_dt.now().year, 7, 1)
                        # æ ¹æ“šåˆ°ç¬¬3åˆ—(C)çš„åç§»ä¼°ç®—
                        try:
                            from datetime import timedelta as _td
                            offset = c - 3
                            parsed = base_date + _td(days=max(0, offset))
                        except Exception:
                            parsed = None
                    else:
                        # æ™®é€šæ—¥æœŸæ–‡æœ¬
                        for fmt in ['%d/%m/%y', '%d-%m-%y', '%Y-%m-%d', '%d/%m/%Y']:
                            try:
                                parsed = _dt.strptime(s, fmt)
                                break
                            except Exception:
                                continue
                if parsed is not None:
                    date_to_col[parsed.strftime('%d/%m/%y')] = c
            
            yellow = PatternFill(start_color="00FFFF00", end_color="00FFFF00", fill_type="solid")
            
            # 3.2 éæ­·é–€å¸‚è¡Œï¼Œå¾Båˆ—è®€å–åº—åï¼Œå¯«AKåˆ—ä¸¦æ¯”å°
            AK_COL = 37  # AK åˆ—ç´¢å¼•
            matched_outlets = 0
            unmatched_outlets = 0
            total_differences = 0
            
            for r in range(date_row + 1, ws.max_row + 1):
                outlet = ws.cell(row=r, column=2).value
                if not outlet:
                    continue
                outlet = str(outlet).strip()
                
                # å¯«å…¥é—œéµæ•¸æ“š: å–æ˜ å°„åˆ°è©²é–€å¸‚çš„è³¬é½¡é‡‘é¡ï¼ˆå¦‚æœæœ‰ï¼‰
                aging_amount = 0.0
                # å¾ç•¶å‰å» å•†çš„PDFæ•¸æ“šä¸­æŸ¥æ‰¾é–€å¸‚
                vendor_data = self.pdf_files[vendor]['data']
                for o in vendor_data.get('outlets', []):
                    oname = str(o['name']).strip()
                    mapped = pdf_to_consolidate.get(oname.upper()) or pdf_to_consolidate.get(_norm(oname))
                    if mapped == outlet:
                        aging_amount = o.get('aging_amount', 0.0) or 0.0
                        break
                ws.cell(row=r, column=AK_COL, value=aging_amount)
                
                # å°æ¯”é€æ—¥
                pdf_days = daily_pdf.get(outlet, {})
                if pdf_days:
                    matched_outlets += 1
                    self._log(f"ğŸª è™•ç†é–€å¸‚: {outlet}")
                    self._log(f"  âœ… æ‰¾åˆ°PDFå°æ‡‰")
                    # å°æ¯”æ—¥èªŒåªè¨˜éŒ„å·®ç•°ï¼Œä¸è¨˜éŒ„è™•ç†éç¨‹
                    
                    for d, pdf_entry in pdf_days.items():
                        pdf_amt = pdf_entry.get("amount", 0.0)
                        invoice_list = pdf_entry.get("invoice_nos", [])
                        c = date_to_col.get(d)
                        if not c:
                            # åªè¨˜éŒ„å·®ç•°/å•é¡Œï¼›æ‰¾ä¸åˆ°åˆ—ä¹Ÿè¨˜ä¸€æ¬¡
                            self._log(f"    [ç¼ºåˆ—] {d}ï¼šæ‰¾ä¸åˆ°åˆ—ï¼ŒPDF={pdf_amt:.2f} ç™¼ç¥¨={','.join(invoice_list) or '-'}")
                            self._log_compare(f"    [ç¼ºåˆ—] {d}ï¼šæ‰¾ä¸åˆ°åˆ—ï¼ŒPDF={pdf_amt:.2f} ç™¼ç¥¨={','.join(invoice_list) or '-'}")
                            continue
                        try:
                            excel_amt = ws.cell(row=r, column=c).value or 0
                            excel_amt = float(excel_amt)
                        except Exception:
                            excel_amt = 0
                        # å·®ç•°é«˜äº®
                        if abs(pdf_amt - excel_amt) > 0.01:
                            ws.cell(row=r, column=c).fill = yellow
                            total_differences += 1
                            invs = ','.join(invoice_list) if invoice_list else '-'
                            self._log(f"    âŒ {d}: PDF=${pdf_amt:.2f} vs Excel=${excel_amt:.2f} (å·®ç•°: ${abs(pdf_amt - excel_amt):.2f})")
                            self._log_compare(f"ğŸª {outlet} - âŒ {d}: PDF=${pdf_amt:.2f} vs Excel=${excel_amt:.2f} (å·®ç•°: ${abs(pdf_amt - excel_amt):.2f})")
                            self._log(f"        ğŸ“„ PDFç™¼ç¥¨: {invs}")
                            self._log_compare(f"        ğŸ“„ PDFç™¼ç¥¨: {invs}")
                        else:
                            self._log(f"    âœ… {d}: PDF=${pdf_amt:.2f} vs Excel=${excel_amt:.2f} (åŒ¹é…)")
                            # å°æ¯”æ—¥èªŒåªè¨˜éŒ„å·®ç•°ï¼Œä¸è¨˜éŒ„åŒ¹é…
                else:
                    unmatched_outlets += 1
                    self._log(f"ğŸª è™•ç†é–€å¸‚: {outlet}")
                    self._log(f"  âŒ æœªæ‰¾åˆ°PDFå°æ‡‰")
                    # å°æ¯”æ—¥èªŒåªè¨˜éŒ„å·®ç•°ï¼Œä¸è¨˜éŒ„æœªåŒ¹é…é–€å¸‚
            
            # ä¿å­˜Excelæ–‡ä»¶
            wb.save(consolidate_path)
            
            # è¨˜éŒ„çµ±è¨ˆçµæœ
            self._log("ğŸ“Š åŒ¹é…çµ±è¨ˆçµæœ:")
            self._log_compare("ğŸ“Š åŒ¹é…çµ±è¨ˆçµæœ:")
            self._log(f"  âœ… åŒ¹é…é–€å¸‚: {matched_outlets}")
            self._log_compare(f"  âœ… åŒ¹é…é–€å¸‚: {matched_outlets}")
            self._log(f"  âŒ æœªåŒ¹é…é–€å¸‚: {unmatched_outlets}")
            self._log_compare(f"  âŒ æœªåŒ¹é…é–€å¸‚: {unmatched_outlets}")
            self._log(f"  ğŸ” ç¸½å·®ç•°: {total_differences}")
            self._log_compare(f"  ğŸ” ç¸½å·®ç•°: {total_differences}")
            
            self._log("ğŸ‰ åŒ¹é…ä¸¦æ›´æ–°/å°æ¯”å®Œæˆï¼")
            self._log_compare("ğŸ‰ åŒ¹é…ä¸¦æ›´æ–°/å°æ¯”å®Œæˆï¼")
            self._log("âœ… Excelæ–‡ä»¶å·²æ›´æ–°ï¼š")
            self._log_compare("âœ… Excelæ–‡ä»¶å·²æ›´æ–°ï¼š")
            self._log("   - AKåˆ—å·²å¯«å…¥PDFé—œéµæ•¸æ“š")
            self._log_compare("   - AKåˆ—å·²å¯«å…¥PDFé—œéµæ•¸æ“š")
            self._log("   - å·®ç•°å–®å…ƒæ ¼å·²æ¨™é»ƒ")
            self._log_compare("   - å·®ç•°å–®å…ƒæ ¼å·²æ¨™é»ƒ")
            self._log(f"   - æ–‡ä»¶å·²ä¿å­˜åˆ°: {consolidate_path}")
            self._log_compare(f"   - æ–‡ä»¶å·²ä¿å­˜åˆ°: {consolidate_path}")
            
            # ç”Ÿæˆå‘ç¥¨å·ç æ€»ç»“æŠ¥å‘Š
            self._log("ğŸ“‹ ç™¼ç¥¨è™Ÿç¢¼ç¸½çµå ±å‘Š:")
            self._log_compare("ğŸ“‹ ç™¼ç¥¨è™Ÿç¢¼ç¸½çµå ±å‘Š:")
            
            # æŒ‰å‚å•†åˆ†ç»„ç»Ÿè®¡å‘ç¥¨å·ç 
            vendor_invoices = {}
            for vendor in active_vendors:
                vendor_data = self.pdf_files[vendor]['data']
                vendor_invoices[vendor] = []
                
                for inv in vendor_data.get('invoices', []):
                    invoice_no = str(inv.get('invoice_no', '')).strip()
                    if invoice_no:
                        vendor_invoices[vendor].append(invoice_no)
            
            # è¾“å‡ºæ¯ä¸ªå‚å•†çš„å‘ç¥¨å·ç 
            for vendor, invoices in vendor_invoices.items():
                if invoices:
                    self._log(f"[{vendor}]")
                    self._log_compare(f"[{vendor}]")
                    # å°†æ¯ä¸ªå‘ç¥¨å·ç å•ç‹¬ä¸€è¡Œè¾“å‡º
                    for invoice in invoices:
                        self._log(f"{invoice}")
                        self._log_compare(f"{invoice}")
                    self._log("")  # å‘ç¥¨å·ç åç©ºä¸€è¡Œ
                    self._log_compare("")  # å‘ç¥¨å·ç åç©ºä¸€è¡Œ
                    self._log("")  # ç©ºè¡Œåˆ†éš”
                    self._log_compare("")  # ç©ºè¡Œåˆ†éš”
                else:
                    self._log(f"[{vendor}]")
                    self._log_compare(f"[{vendor}]")
                    self._log("ç„¡ç™¼ç¥¨è™Ÿç¢¼")
                    self._log_compare("ç„¡ç™¼ç¥¨è™Ÿç¢¼")
                    self._log("")
                    self._log_compare("")
            
            self._log("ğŸ“‹ ç™¼ç¥¨è™Ÿç¢¼ç¸½çµå ±å‘Šå®Œæˆï¼")
            self._log_compare("ğŸ“‹ ç™¼ç¥¨è™Ÿç¢¼ç¸½çµå ±å‘Šå®Œæˆï¼")
            
        except Exception as e:
            self._log(f"âŒ åŒ¹é…ä¸¦æ›´æ–°/å°æ¯”å¤±æ•—: {str(e)}")
            import traceback
            self._log(f"ğŸ” éŒ¯èª¤è©³æƒ…: {traceback.format_exc()}")
    
    def _log(self, message):
        """è®°å½•æ“ä½œæ—¥å¿—"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_message = f"[{timestamp}] {message}\n"
        self.operation_log.insert('end', log_message)
        self.operation_log.see('end')
        print(log_message.strip())
    
    def _log_compare(self, message):
        """è®°å½•å¯¹æ¯”æ—¥å¿—åˆ°å¯¹æ¯”æ—¥å¿—æ ‡ç­¾é¡µ"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_message = f"[{timestamp}] {message}\n"
        if hasattr(self, 'compare_log'):
            self.compare_log.insert('end', log_message)
            self.compare_log.see('end')
        print(log_message.strip())
    
    def _clear_logs(self):
        """æ¸…ç©ºæ‰€æœ‰æ—¥å¿—"""
        self.operation_log.delete('1.0', 'end')
        self.comparison_log.delete('1.0', 'end')
        self._log("æ—¥èªŒå·²æ¸…ç©º")
    
    def _extract_pdf_data(self):
        """æå–PDFæ•°æ®"""
        print("ğŸ” DEBUG: å¼€å§‹æå–PDFæ•°æ®")
        pdf_path = self.pdf_path_var.get()
        print(f"ğŸ” DEBUG: PDFæ–‡ä»¶è·¯å¾„: {pdf_path}")
        
        if not pdf_path:
            print("âŒ DEBUG: æ²¡æœ‰é€‰æ‹©PDFæ–‡ä»¶")
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡PDFæ–‡ä»¶ï¼")
            return
        
        try:
            print("ğŸ” DEBUG: æ¸…ç©ºä¹‹å‰çš„æ•°æ®")
            # æ¸…ç©ºä¹‹å‰çš„æ•°æ®
            self.pdf_text.delete('1.0', 'end')
            self.pdf_data = {}
            
            print("ğŸ” DEBUG: å¼€å§‹è°ƒç”¨_extract_pdf_content")
            # æå–PDFæ•°æ®
            extracted_data = self._extract_pdf_content(pdf_path)
            print(f"ğŸ” DEBUG: æå–çš„æ•°æ®é•¿åº¦: {len(extracted_data) if extracted_data else 0}")
            
            print("ğŸ” DEBUG: æ˜¾ç¤ºæå–çš„æ•°æ®åˆ°æ–‡æœ¬æ¡†")
            # æ˜¾ç¤ºæå–çš„æ•°æ®
            self.pdf_text.insert('1.0', extracted_data)
            
            print("ğŸ” DEBUG: æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯")
            messagebox.showinfo("æˆåŠŸ", "PDFæ•¸æ“šæå–å®Œæˆï¼")
            print("âœ… DEBUG: PDFæ•°æ®æå–å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ DEBUG: PDFæ•°æ®æå–å¤±è´¥: {e}")
            import traceback
            print(f"âŒ DEBUG: é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            messagebox.showerror("éŒ¯èª¤", f"PDFæ•¸æ“šæå–å¤±æ•—ï¼š{str(e)}")
    
    def _test_pdf_text(self):
        """æµ‹è¯•PDFæ–‡æœ¬æå– - æ˜¾ç¤ºè¯¦ç»†çš„æå–è¿‡ç¨‹"""
        if not self.pdf_path_var.get():
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡PDFæ–‡ä»¶ï¼")
            return
        
        try:
            pdf_path = self.pdf_path_var.get()
            print(f"ğŸ§ª DEBUG: å¼€å§‹æµ‹è¯•PDFæ–‡æœ¬æå–: {pdf_path}")
            
            # æµ‹è¯•ä¸åŒçš„æå–æ–¹æ³•
            print("ğŸ§ª DEBUG: === æµ‹è¯•PDFæ–‡æœ¬æå– ===")
            
            # æ–¹æ³•1: pdfplumber
            try:
                import pdfplumber
                print("ğŸ§ª DEBUG: å°è¯•ä½¿ç”¨pdfplumber...")
                with pdfplumber.open(pdf_path) as pdf:
                    text_content = ""
                    for i, page in enumerate(pdf.pages):
                        page_text = page.extract_text()
                        print(f"ğŸ§ª DEBUG: ç¬¬{i+1}é¡µ (pdfplumber): é•¿åº¦={len(page_text) if page_text else 0}")
                        if page_text:
                            text_content += f"\n--- ç¬¬{i+1}é¡µ ---\n{page_text}\n"
                    
                    if text_content.strip():
                        print(f"ğŸ§ª DEBUG: pdfplumberæˆåŠŸï¼Œæ€»é•¿åº¦: {len(text_content)}")
                        # æ˜¾ç¤ºå‰500ä¸ªå­—ç¬¦
                        preview = text_content[:500] + "..." if len(text_content) > 500 else text_content
                        print(f"ğŸ§ª DEBUG: æ–‡æœ¬é¢„è§ˆ: {preview}")
                    else:
                        print("ğŸ§ª DEBUG: pdfplumberæå–çš„æ–‡æœ¬ä¸ºç©º")
            except Exception as e:
                print(f"ğŸ§ª DEBUG: pdfplumberå¤±è´¥: {e}")
            
            # æ–¹æ³•2: PyPDF2
            try:
                import PyPDF2
                print("ğŸ§ª DEBUG: å°è¯•ä½¿ç”¨PyPDF2...")
                with open(pdf_path, 'rb') as file:
                    pdf_reader = PyPDF2.PdfReader(file)
                    text_content = ""
                    for i, page in enumerate(pdf_reader.pages):
                        page_text = page.extract_text()
                        print(f"ğŸ§ª DEBUG: ç¬¬{i+1}é¡µ (PyPDF2): é•¿åº¦={len(page_text) if page_text else 0}")
                        if page_text:
                            text_content += f"\n--- ç¬¬{i+1}é¡µ ---\n{page_text}\n"
                    
                    if text_content.strip():
                        print(f"ğŸ§ª DEBUG: PyPDF2æˆåŠŸï¼Œæ€»é•¿åº¦: {len(text_content)}")
                        # æ˜¾ç¤ºå‰500ä¸ªå­—ç¬¦
                        preview = text_content[:500] + "..." if len(text_content) > 500 else text_content
                        print(f"ğŸ§ª DEBUG: æ–‡æœ¬é¢„è§ˆ: {preview}")
                    else:
                        print("ğŸ§ª DEBUG: PyPDF2æå–çš„æ–‡æœ¬ä¸ºç©º")
            except Exception as e:
                print(f"ğŸ§ª DEBUG: PyPDF2å¤±è´¥: {e}")
            
            # æ–¹æ³•3: OCR (å¦‚æœå¯ç”¨)
            try:
                import fitz  # PyMuPDF
                import pytesseract
                from PIL import Image
                print("ğŸ§ª DEBUG: å°è¯•ä½¿ç”¨OCR...")
                
                # æ£€æŸ¥Tesseractæ˜¯å¦å¯ç”¨
                try:
                    pytesseract.get_tesseract_version()
                    print("ğŸ§ª DEBUG: Tesseractå¯ç”¨")
                except:
                    print("ğŸ§ª DEBUG: Tesseractä¸å¯ç”¨")
                    return
                
                doc = fitz.open(pdf_path)
                text_content = ""
                for i, page in enumerate(doc):
                    # å°†é¡µé¢è½¬æ¢ä¸ºå›¾åƒ
                    pix = page.get_pixmap()
                    img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
                    
                    # ä½¿ç”¨OCRæå–æ–‡æœ¬
                    page_text = pytesseract.image_to_string(img, lang='eng')
                    print(f"ğŸ§ª DEBUG: ç¬¬{i+1}é¡µ (OCR): é•¿åº¦={len(page_text) if page_text else 0}")
                    if page_text:
                        text_content += f"\n--- ç¬¬{i+1}é¡µ ---\n{page_text}\n"
                
                doc.close()
                
                if text_content.strip():
                    print(f"ğŸ§ª DEBUG: OCRæˆåŠŸï¼Œæ€»é•¿åº¦: {len(text_content)}")
                    # æ˜¾ç¤ºå‰500ä¸ªå­—ç¬¦
                    preview = text_content[:500] + "..." if len(text_content) > 500 else text_content
                    print(f"ğŸ§ª DEBUG: æ–‡æœ¬é¢„è§ˆ: {preview}")
                else:
                    print("ğŸ§ª DEBUG: OCRæå–çš„æ–‡æœ¬ä¸ºç©º")
                    
            except Exception as e:
                print(f"ğŸ§ª DEBUG: OCRå¤±è´¥: {e}")
            
            print("ğŸ§ª DEBUG: === PDFæ–‡æœ¬æå–æµ‹è¯•å®Œæˆ ===")
            messagebox.showinfo("æµ‹è¯•å®Œæˆ", "PDFæ–‡æœ¬æå–æµ‹è¯•å®Œæˆï¼\nè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºè·å–è¯¦ç»†ä¿¡æ¯ã€‚")
            
        except Exception as e:
            print(f"ğŸ§ª DEBUG: PDFæ–‡æœ¬æµ‹è¯•å¼‚å¸¸: {e}")
            messagebox.showerror("éŒ¯èª¤", f"PDFæ–‡æœ¬æµ‹è¯•å¤±æ•—ï¼š{str(e)}")
    
    def _analyze_extracted_text(self):
        """åˆ†æå·²æå–çš„æ–‡æœ¬å†…å®¹ - å¸®åŠ©è¯Šæ–­æ•°æ®æå–é—®é¢˜"""
        try:
            # è·å–å·²æå–çš„PDFæ–‡æœ¬
            pdf_text = self.pdf_text.get('1.0', 'end-1c')
            if not pdf_text.strip():
                messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆæå–PDFæ•¸æ“šï¼")
                return
            
            print("ğŸ” DEBUG: === åˆ†æå·²æå–çš„æ–‡æœ¬å†…å®¹ ===")
            print(f"ğŸ” DEBUG: æ–‡æœ¬æ€»é•¿åº¦: {len(pdf_text)}")
            
            # åˆ†ææ–‡æœ¬å†…å®¹
            lines = pdf_text.split('\n')
            print(f"ğŸ” DEBUG: æ€»è¡Œæ•°: {len(lines)}")
            
            # æŸ¥æ‰¾å…³é”®ä¿¡æ¯
            import re
            
            # 1. æŸ¥æ‰¾Invoiceå·ç 
            inv_pattern = r'INV-SH\d+'
            inv_matches = re.findall(inv_pattern, pdf_text)
            print(f"ğŸ” DEBUG: æ‰¾åˆ°çš„Invoiceå·ç : {inv_matches}")
            print(f"ğŸ” DEBUG: Invoiceå·ç æ•°é‡: {len(inv_matches)}")
            
            # 2. æŸ¥æ‰¾æ‰€æœ‰æ•°å­—
            all_numbers = re.findall(r'(\d+\.?\d*)', pdf_text)
            print(f"ğŸ” DEBUG: æ‰¾åˆ°çš„æ‰€æœ‰æ•°å­—: {all_numbers[:20]}...")  # åªæ˜¾ç¤ºå‰20ä¸ª
            
            # 3. æŸ¥æ‰¾å¯èƒ½çš„é‡‘é¢
            potential_amounts = []
            for num_str in all_numbers:
                try:
                    num = float(num_str)
                    if 10 <= num <= 100000:  # åˆç†çš„é‡‘é¢èŒƒå›´
                        potential_amounts.append((num, num_str))
                except ValueError:
                    continue
            
            # æŒ‰é‡‘é¢æ’åº
            potential_amounts.sort(key=lambda x: x[0], reverse=True)
            print(f"ğŸ” DEBUG: æ½œåœ¨çš„é‡‘é¢ (å‰10ä¸ª): {[f'{num:.2f}' for num, _ in potential_amounts[:10]]}")
            
            # 4. æŸ¥æ‰¾å…³é”®æ–‡æœ¬æ¨¡å¼
            key_patterns = [
                r'Amount Due',
                r'Total',
                r'Sub Total',
                r'GST',
                r'Invoice',
                r'Date',
                r'Due Date'
            ]
            
            for pattern in key_patterns:
                matches = re.findall(pattern, pdf_text, re.IGNORECASE)
                if matches:
                    print(f"ğŸ” DEBUG: æ‰¾åˆ° '{pattern}': {len(matches)} æ¬¡")
            
            # 5. æ˜¾ç¤ºæ–‡æœ¬çš„å‰å‡ è¡Œå’Œåå‡ è¡Œ
            print(f"ğŸ” DEBUG: æ–‡æœ¬å‰5è¡Œ:")
            for i, line in enumerate(lines[:5]):
                print(f"  {i+1}: {line}")
            
            print(f"ğŸ” DEBUG: æ–‡æœ¬å5è¡Œ:")
            for i, line in enumerate(lines[-5:]):
                print(f"  {len(lines)-4+i}: {line}")
            
            # 6. æŸ¥æ‰¾åŒ…å«Invoiceå·ç çš„è¡Œ
            print(f"ğŸ” DEBUG: åŒ…å«Invoiceå·ç çš„è¡Œ:")
            for i, line in enumerate(lines):
                if 'INV-SH' in line:
                    print(f"  ç¬¬{i+1}è¡Œ: {line}")
            
            print("ğŸ” DEBUG: === æ–‡æœ¬åˆ†æå®Œæˆ ===")
            messagebox.showinfo("åˆ†æå®Œæˆ", "æ–‡æœ¬å†…å®¹åˆ†æå®Œæˆï¼\nè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºè·å–è¯¦ç»†ä¿¡æ¯ã€‚")
            
        except Exception as e:
            print(f"ğŸ” DEBUG: æ–‡æœ¬åˆ†æå¤±è´¥: {e}")
            import traceback
            print(f"ğŸ” DEBUG: é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            messagebox.showerror("éŒ¯èª¤", f"æ–‡æœ¬åˆ†æå¤±æ•—ï¼š{str(e)}")
    
    # _extract_pdf_contentæ–¹æ³•å·²ç§»é™¤
    
    def _parse_soa_data_from_text(self, text):
        """ä»PDFæ–‡æœ¬ä¸­è§£æSOAæ•°æ®"""
        try:
            import re
            
            # æ¸…ç©ºä¹‹å‰çš„æ•°æ®
            self.soa_data = {}
            
            # æ”¹è¿›çš„é‡‘é¢æ¨¡å¼ï¼Œæ”¯æŒæ›´å¤šæ ¼å¼
            amount_pattern = r'[\$]?[\d,]+\.?\d*'
            
            # æŒ‰è¡Œå¤„ç†æ–‡æœ¬
            lines = text.split('\n')
            line_count = 0
            
            for line in lines:
                line = line.strip()
                line_count += 1
                
                if line and len(line) > 5:  # ç¡®ä¿è¡Œæœ‰è¶³å¤Ÿçš„å†…å®¹
                    # æŸ¥æ‰¾è¡Œä¸­çš„é‡‘é¢
                    amounts = re.findall(amount_pattern, line)
                    
                    if amounts:
                        # å°è¯•æå–é¡¹ç›®åç§°
                        for amount in amounts:
                            amount_pos = line.find(amount)
                            if amount_pos > 0:
                                # æå–é‡‘é¢å‰çš„æ–‡æœ¬ä½œä¸ºé¡¹ç›®åç§°
                                item_name = line[:amount_pos].strip()
                                # æ¸…ç†é¡¹ç›®åç§°ï¼Œä¿ç•™æ›´å¤šæœ‰æ•ˆå­—ç¬¦
                                item_name = re.sub(r'[^\w\s\-\.\-\/\(\)]', '', item_name).strip()
                                
                                if item_name and len(item_name) > 2:
                                    # é¿å…é‡å¤ï¼Œä½¿ç”¨è¡Œå·ä½œä¸ºæ ‡è¯†
                                    unique_name = f"{item_name}_è¡Œ{line_count}"
                                    self.soa_data[unique_name] = amount
                                elif not item_name or len(item_name) <= 2:
                                    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æœ‰æ„ä¹‰çš„é¡¹ç›®åç§°ï¼Œä½¿ç”¨è¡Œå·
                                    unique_name = f"é¡¹ç›®_è¡Œ{line_count}"
                                    self.soa_data[unique_name] = amount
            
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»“æ„åŒ–æ•°æ®ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
            if not self.soa_data:
                self._parse_table_format_data(text)
            
            # å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºä¸€äº›ç¤ºä¾‹æ•°æ®ç”¨äºæ¼”ç¤º
            if not self.soa_data:
                self.soa_data = {
                    "ç¤ºä¾‹é¡¹ç›®1": "$100.00",
                    "ç¤ºä¾‹é¡¹ç›®2": "$250.50",
                    "ç¤ºä¾‹é¡¹ç›®3": "$75.25"
                }
            
            print(f"è§£æå®Œæˆï¼Œæ‰¾åˆ° {len(self.soa_data)} ä¸ªé¡¹ç›®")
            for item, amount in self.soa_data.items():
                print(f"  {item}: {amount}")
                
        except Exception as e:
            print(f"è§£æSOAæ•°æ®å¤±è´¥: {e}")
            import traceback
            print(f"é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            # åˆ›å»ºé»˜è®¤æ•°æ®
            self.soa_data = {
                "é»˜è®¤é¡¹ç›®": "$0.00"
            }
    
    def _parse_table_format_data(self, text):
        """è§£æè¡¨æ ¼æ ¼å¼çš„æ•°æ®"""
        try:
            import re
            
            # æŸ¥æ‰¾è¡¨æ ¼è¡Œï¼ˆé€šå¸¸åŒ…å«å¤šä¸ªé‡‘é¢ï¼‰
            lines = text.split('\n')
            for line in lines:
                line = line.strip()
                if line and len(line) > 10:  # ç¡®ä¿è¡Œæœ‰è¶³å¤Ÿçš„å†…å®¹
                    # æŸ¥æ‰¾è¡Œä¸­çš„é‡‘é¢
                    amounts = re.findall(r'[\$]?[\d,]+\.?\d*', line)
                    if len(amounts) >= 2:  # è‡³å°‘æœ‰ä¸¤ä¸ªé‡‘é¢çš„è¡Œå¯èƒ½æ˜¯è¡¨æ ¼è¡Œ
                        # å°è¯•åˆ†å‰²è¡Œå†…å®¹
                        parts = re.split(r'\s+', line)
                        for i, part in enumerate(parts):
                            if re.match(r'[\$]?[\d,]+\.?\d*', part):
                                # è¿™æ˜¯ä¸€ä¸ªé‡‘é¢ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”çš„é¡¹ç›®åç§°
                                if i > 0:
                                    item_name = ' '.join(parts[:i]).strip()
                                    if item_name:
                                        self.soa_data[item_name] = part
                                        break
                                        
        except Exception as e:
            print(f"è§£æè¡¨æ ¼æ ¼å¼æ•°æ®å¤±è´¥: {e}")
    
    def _extract_soa_pdf_data(self):
        """æå–SOA PDFæ•°æ®"""
        print("ğŸ” DEBUG: å¼€å§‹æå–SOA PDFæ•°æ®")
        soa_path = self.soa_path_var.get()
        print(f"ğŸ” DEBUG: SOA PDFæ–‡ä»¶è·¯å¾„: {soa_path}")
        
        if not soa_path:
            print("âŒ DEBUG: æ²¡æœ‰é€‰æ‹©SOA PDFæ–‡ä»¶")
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡SOA PDFæ–‡ä»¶ï¼")
            return
        
        try:
            print("ğŸ” DEBUG: æ¸…ç©ºä¹‹å‰çš„æ•°æ®")
            # æ¸…ç©ºä¹‹å‰çš„æ•°æ®
            self.soa_text.delete('1.0', 'end')
            self.soa_data = {}
            
            print("ğŸ” DEBUG: å¼€å§‹è°ƒç”¨_extract_pdf_content")
            # æå–SOA PDFæ•°æ®
            extracted_data = self._extract_pdf_content(soa_path)
            print(f"ğŸ” DEBUG: æå–çš„æ•°æ®é•¿åº¦: {len(extracted_data) if extracted_data else 0}")
            
            print("ğŸ” DEBUG: æ˜¾ç¤ºæå–çš„æ•°æ®åˆ°æ–‡æœ¬æ¡†")
            # æ˜¾ç¤ºæå–çš„æ•°æ®
            self.soa_text.insert('1.0', extracted_data)
            
            print("ğŸ” DEBUG: å¼€å§‹è§£æSOAæ•°æ®")
            # ä»æå–çš„æ–‡æœ¬ä¸­è§£æå…³é”®æ•°æ®
            self._parse_soa_data_from_text(extracted_data)
            print(f"ğŸ” DEBUG: è§£æåçš„SOAæ•°æ®æ•°é‡: {len(self.soa_data)}")
            
            print("ğŸ” DEBUG: æ˜¾ç¤ºè§£æåçš„æ•°æ®")
            # æ˜¾ç¤ºè§£æåçš„æ•°æ®
            self._display_soa_data()
            
            print("ğŸ” DEBUG: æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯")
            messagebox.showinfo("æˆåŠŸ", "SOA PDFæ•¸æ“šæå–å®Œæˆï¼")
            print("âœ… DEBUG: SOA PDFæ•°æ®æå–å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ DEBUG: SOA PDFæ•°æ®æå–å¤±è´¥: {e}")
            import traceback
            print(f"âŒ DEBUG: é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            messagebox.showerror("éŒ¯èª¤", f"SOA PDFæ•¸æ“šæå–å¤±æ•—ï¼š{str(e)}")
    
    def _load_csv_data(self, file_path):
        """åŠ è½½CSVæ•°æ®"""
        import csv
        
        with open(file_path, 'r', encoding='utf-8') as file:
            reader = csv.DictReader(file)
            for row in reader:
                # å‡è®¾CSVæœ‰ 'item', 'amount' åˆ—
                item = row.get('item', '')
                amount = row.get('amount', '')
                if item and amount:
                    self.soa_data[item] = amount
    
    def _load_excel_data(self, file_path):
        """åŠ è½½Excelæ•°æ®"""
        try:
            import openpyxl
            
            wb = openpyxl.load_workbook(file_path)
            ws = wb.active
            
            # å‡è®¾ç¬¬ä¸€è¡Œæ˜¯æ ‡é¢˜ï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹è¯»å–æ•°æ®
            for row in ws.iter_rows(min_row=2, values_only=True):
                if len(row) >= 2:
                    item = str(row[0]) if row[0] else ''
                    amount = str(row[1]) if row[1] else ''
                    if item and amount:
                        self.soa_data[item] = amount
            
            wb.close()
            
        except Exception as e:
            raise Exception(f"Excelæ–‡ä»¶è®€å–å¤±æ•—ï¼š{str(e)}")
    
    def _display_soa_data(self):
        """æ˜¾ç¤ºSOAæ•°æ®"""
        self.soa_text.delete('1.0', 'end')
        
        if not self.soa_data:
            self.soa_text.insert('1.0', "ç„¡æ•¸æ“š / No data")
            return
        
        # æ ¼å¼åŒ–æ˜¾ç¤ºæ•°æ®
        for item, amount in self.soa_data.items():
            self.soa_text.insert('end', f"{item}: {amount}\n")
    
    def _start_reconciliation(self):
        """å¼€å§‹æ ¸å¯¹"""
        print("ğŸ” DEBUG: å¼€å§‹æ‰§è¡Œæ ¸å¯¹")
        
        # ç°¡åŒ–ï¼šåƒ…æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†å…©å€‹æª”æ¡ˆ
        if not self.pdf_path_var.get():
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡ Invoices PDFï¼")
            return
        if not self.soa_path_var.get():
            messagebox.showwarning("è­¦å‘Š", "è«‹å…ˆé¸æ“‡ SOA PDFï¼")
            return
        
        # ç°¡åŒ–æ¨¡å¼ä¸å†é å…ˆä¾è³´ self.soa_dataï¼›ç›´æ¥åœ¨æ ¸å°æµç¨‹ä¸­è§£æé¸å–çš„ SOA æª”æ¡ˆ
        
        try:
            print("ğŸ” DEBUG: æ¸…ç©ºä¹‹å‰çš„ç»“æœè¡¨æ ¼")
            # æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            for item in self.tree.get_children():
                self.tree.delete(item)
            
            print("ğŸ” DEBUG: å¼€å§‹æ‰§è¡Œ_perform_reconciliation")
            # æ‰§è¡Œæ ¸å¯¹
            self.reconciliation_results = self._perform_reconciliation()
            print(f"ğŸ” DEBUG: æ ¸å¯¹ç»“æœæ•°é‡: {len(self.reconciliation_results) if self.reconciliation_results else 0}")
            
            print("ğŸ” DEBUG: å¼€å§‹æ˜¾ç¤ºç»“æœ")
            # æ˜¾ç¤ºç»“æœ
            self._display_reconciliation_results()
            
            if self.reconciliation_results:
                print(f"âœ… DEBUG: æ ¸å¯¹å®Œæˆï¼Œæ‰¾åˆ° {len(self.reconciliation_results)} ä¸ªé¡¹ç›®")
                messagebox.showinfo("æˆåŠŸ", f"æ ¸å°å®Œæˆï¼ç™¼ç¾ {len(self.reconciliation_results)} å€‹é …ç›®")
            else:
                print("âš ï¸ DEBUG: æ ¸å¯¹å®Œæˆï¼Œä½†æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®")
                messagebox.showwarning("è­¦å‘Š", "æ ¸å°å®Œæˆï¼Œä½†æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•¸æ“šï¼")
            
        except Exception as e:
            print(f"âŒ DEBUG: æ ¸å¯¹å¤±è´¥: {e}")
            import traceback
            print(f"âŒ DEBUG: é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            messagebox.showerror("éŒ¯èª¤", f"æ ¸å°å¤±æ•—ï¼š{str(e)}")
    
    def _perform_reconciliation(self):
        """æ‰§è¡Œæ ¸å¯¹é€»è¾‘ - æ¯”è¾ƒä¸¤ä¸ªPDFæ–‡ä»¶"""
        print("ğŸ” DEBUG: å¼€å§‹æ‰§è¡Œæ ¸å¯¹é€»è¾‘")
        results = []
        
        # ä»ä¸¤ä¸ªPDFæ–‡æœ¬ä¸­æå–å…³é”®æ•°æ®
        # è‡ªå‹•å¾æª”æ¡ˆè·¯å¾‘è®€å–æ–‡æœ¬ï¼ˆç°¡åŒ–æ¨¡å¼ï¼‰
        pdf1_text = self._extract_pdf_content(self.pdf_path_var.get()) if getattr(self, 'pdf_path_var', None) else ''
        pdf2_text = self._extract_pdf_content(self.soa_path_var.get()) if getattr(self, 'soa_path_var', None) else ''
        print(f"ğŸ” DEBUG: PDF1æ–‡æœ¬é•¿åº¦: {len(pdf1_text)}")
        print(f"ğŸ” DEBUG: PDF2æ–‡æœ¬é•¿åº¦: {len(pdf2_text)}")
        
        import re
        
        print("ğŸ” DEBUG: å¼€å§‹ä»PDF1æå–ç»“æ„åŒ–æ•°æ®")
        # ä»ç¬¬ä¸€ä¸ªPDFä¸­æå–æ•°æ®
        pdf1_data = self._extract_structured_data(pdf1_text, "PDF1")
        print(f"ğŸ” DEBUG: PDF1ç»“æ„åŒ–æ•°æ®: {pdf1_data}")
        
        print("ğŸ” DEBUG: å¼€å§‹ä»PDF2æå–ç»“æ„åŒ–æ•°æ®")
        # ä»ç¬¬äºŒä¸ªPDFä¸­æå–æ•°æ®
        pdf2_data = self._extract_structured_data(pdf2_text, "PDF2")
        print(f"ğŸ” DEBUG: PDF2ç»“æ„åŒ–æ•°æ®: {pdf2_data}")
        
        # æ¯”è¾ƒä¸¤ä¸ªPDFçš„æ•°æ®
        all_items = set(list(pdf1_data.keys()) + list(pdf2_data.keys()))
        print(f"ğŸ” DEBUG: æ‰€æœ‰é¡¹ç›®æ•°é‡: {len(all_items)}")
        print(f"ğŸ” DEBUG: æ‰€æœ‰é¡¹ç›®: {all_items}")
        
        for item in all_items:
            pdf1_value = pdf1_data.get(item, "æœªæ‰¾åˆ°")
            pdf2_value = pdf2_data.get(item, "æœªæ‰¾åˆ°")
            
            print(f"ğŸ” DEBUG: æ ¸å¯¹é¡¹ç›® {item}: PDF1={pdf1_value}, PDF2={pdf2_value}")
            
            if pdf1_value != "æœªæ‰¾åˆ°" and pdf2_value != "æœªæ‰¾åˆ°":
                # ä¸¤ä¸ªPDFéƒ½æœ‰è¿™ä¸ªé¡¹ç›®
                try:
                    # æ¸…ç†é‡‘é¢å­—ç¬¦ä¸²ï¼Œåªä¿ç•™æ•°å­—å’Œå°æ•°ç‚¹
                    pdf1_clean = re.sub(r'[^\d.]', '', str(pdf1_value))
                    pdf2_clean = re.sub(r'[^\d.]', '', str(pdf2_value))
                    
                    print(f"ğŸ” DEBUG: æ¸…ç†åé‡‘é¢: PDF1={pdf1_clean}, PDF2={pdf2_clean}")
                    
                    if pdf1_clean == pdf2_clean:
                        # é‡‘é¢åŒ¹é…
                        status = "âœ… åŒ¹é…"
                        difference = "0.00"
                        print(f"ğŸ” DEBUG: é‡‘é¢åŒ¹é…: {pdf1_clean}")
                    else:
                        # é‡‘é¢ä¸åŒ¹é…
                        status = "âš ï¸ é‡‘é¡ä¸åŒ¹é…"
                        try:
                            diff = float(pdf1_clean) - float(pdf2_clean)
                            difference = f"{diff:+.2f}"
                            print(f"ğŸ” DEBUG: é‡‘é¢ä¸åŒ¹é…ï¼Œå·®å¼‚: {difference}")
                        except:
                            difference = "è¨ˆç®—éŒ¯èª¤"
                            print(f"ğŸ” DEBUG: é‡‘é¢è®¡ç®—é”™è¯¯")
                except Exception as e:
                    print(f"ğŸ” DEBUG: é‡‘é¢å¤„ç†å¼‚å¸¸: {e}")
                    status = "âŒ è™•ç†éŒ¯èª¤"
                    difference = "éŒ¯èª¤"
                
                results.append({
                    'item': item,
                    'pdf_value': pdf1_value,
                    'soa_value': pdf2_value,
                    'difference': difference,
                    'status': status
                })
            elif pdf1_value != "æœªæ‰¾åˆ°":
                # åªåœ¨Invoiceä¸­æ‰¾åˆ°
                print(f"ğŸ” DEBUG: ä»…åœ¨Invoiceä¸­æ‰¾åˆ°: {item} = {pdf1_value}")
                results.append({
                    'item': item,
                    'pdf_value': pdf1_value,
                    'soa_value': "æœªæ‰¾åˆ°",
                    'difference': "N/A",
                    'status': "âŒ ä»…åœ¨Invoiceä¸­"
                })
            else:
                # åªåœ¨SOAä¸­æ‰¾åˆ°
                print(f"ğŸ” DEBUG: ä»…åœ¨SOAä¸­æ‰¾åˆ°: {item} = {pdf2_value}")
                results.append({
                    'item': item,
                    'pdf_value': "æœªæ‰¾åˆ°",
                    'soa_value': pdf2_value,
                    'difference': "N/A",
                    'status': "âŒ ä»…åœ¨SOAä¸­"
                })
        
        print(f"ğŸ” DEBUG: æ ¸å¯¹å®Œæˆï¼Œå…±ç”Ÿæˆ {len(results)} ä¸ªç»“æœ")
        
        return results
    
    def _extract_structured_data(self, text, source_name):
        """ä»PDFæ–‡æœ¬ä¸­æå–ç»“æ„åŒ–æ•°æ®"""
        print(f"ğŸ” DEBUG: å¼€å§‹ä»{source_name}æå–ç»“æ„åŒ–æ•°æ®")
        data = {}
        
        try:
            import re
            
            if source_name == "PDF1":  # Invoice PDF
                # æå–Invoiceå·ç å’ŒAmount Due
                data = self._extract_invoice_data(text)
            elif source_name == "PDF2":  # SOA PDF
                # æå–Invoiceå·ç å’ŒDré‡‘é¢
                data = self._extract_soa_data(text)
            
            print(f"ğŸ” DEBUG: {source_name}æœ€ç»ˆæå–æ•°æ®: {data}")
            return data
            
        except Exception as e:
            print(f"ğŸ” DEBUG: {source_name}ç»“æ„åŒ–æ•°æ®æå–å¤±è´¥: {e}")
            import traceback
            print(f"ğŸ” DEBUG: é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            return {}
    
    def _is_likely_non_amount(self, amount_str, line_context):
        """åˆ¤æ–­æå–çš„æ•°å­—æ˜¯å¦å¯èƒ½ä¸æ˜¯Amount Due"""
        line_upper = line_context.upper()
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯é¡µç ã€è¡Œå·ã€æ•°é‡ç­‰
        non_amount_indicators = [
            'PAGE', 'P.', 'QTY', 'QUANTITY', 'S/NO', 'NO.', 'ITEM',
            'STOCK CODE', 'PC', 'PCS', 'PIECES', 'UNIT', 'PCT', 'PKT',
            'LOT', 'BOX', 'CARTON', 'DOZEN', 'DOZ'
        ]
        
        for indicator in non_amount_indicators:
            if indicator in line_upper:
                return True
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯å¾ˆå°çš„æ•´æ•°ï¼ˆé€šå¸¸ä¸æ˜¯é‡‘é¢ï¼‰
        try:
            amt_float = float(amount_str)
            if amt_float <= 10 and amt_float == int(amt_float):  # å°äºç­‰äº10çš„æ•´æ•°
                return True
        except:
            pass
            
        return False

    def _fix_ocr_amount_errors(self, amount_str):
        """ä¿®å¤å¸¸è§çš„OCRé‡‘é¢è¯†åˆ«é”™è¯¯"""
        try:
            # å¸¸è§OCRé”™è¯¯æ¨¡å¼ä¿®å¤
            corrected = amount_str
            
            # æ¨¡å¼1: 705.xx -> 105.xx (7è¢«è¯¯è¯†åˆ«ä¸º1)
            if corrected.startswith('7') and '.' in corrected:
                # æ£€æŸ¥æ˜¯å¦æ˜¯7xx.xxæ ¼å¼
                import re
                if re.match(r'^7\d{1,2}\.\d{1,2}$', corrected):
                    test_corrected = '1' + corrected[1:]  # 7 -> 1
                    test_float = float(test_corrected)
                    # å¦‚æœä¿®æ­£åçš„é‡‘é¢åœ¨åˆç†èŒƒå›´å†…ï¼Œä½¿ç”¨ä¿®æ­£å€¼
                    if 50 <= test_float <= 500:
                        print(f"ğŸ” DEBUG: OCRä¿®æ­£ {corrected} -> {test_corrected}")
                        corrected = test_corrected
            
            # æ¨¡å¼2: 8538 -> 85.38 (å°æ•°ç‚¹ä¸¢å¤±)
            if len(corrected) == 4 and corrected.isdigit():
                if int(corrected) > 1000:
                    test_corrected = corrected[:2] + '.' + corrected[2:]
                    test_float = float(test_corrected)
                    if 10 <= test_float <= 500:
                        print(f"ğŸ” DEBUG: OCRä¿®æ­£ {corrected} -> {test_corrected}")
                        corrected = test_corrected
            
            # æ¨¡å¼3: 797.63 -> 79.63 æˆ– 97.63 (å¤šäº†ä¸€ä½æ•°å­—)
            if len(corrected) >= 6 and '.' in corrected:
                parts = corrected.split('.')
                if len(parts[0]) >= 3:
                    # å°è¯•å»æ‰ç¬¬ä¸€ä½æ•°å­—
                    test_corrected = parts[0][1:] + '.' + parts[1]
                    test_float = float(test_corrected)
                    if 20 <= test_float <= 500:
                        print(f"ğŸ” DEBUG: OCRä¿®æ­£ {corrected} -> {test_corrected}")
                        corrected = test_corrected
            
            return corrected
            
        except Exception as e:
            print(f"ğŸ” DEBUG: OCRä¿®æ­£å¤±è´¥: {e}")
            return amount_str
    
    def _extract_invoice_data(self, text):
        """ä»Invoice PDFæå–Invoiceå·ç å’ŒAmount Due - ä¸“é—¨é’ˆå¯¹Siahuatæ¨¡æ¿ä¼˜åŒ–"""
        data = {}
        try:
            import re
            
            print("ğŸ” DEBUG: === å¼€å§‹æå–Siahuat Invoiceæ•°æ® ===")
            print(f"ğŸ” DEBUG: è¾“å…¥æ–‡æœ¬é•¿åº¦: {len(text)}")
            
            # ===== SIAHUAT SPECIFIC PATTERNS =====
            # æŸ¥æ‰¾Invoiceå·ç æ¨¡å¼ - Siahuatæ ¼å¼: INV-SH250604007
            inv_pattern = r'INV-SH\d+'
            inv_matches = re.findall(inv_pattern, text)
            print(f"ğŸ” DEBUG: æ‰¾åˆ°Siahuat Invoiceå·ç : {inv_matches}")
            print(f"ğŸ” DEBUG: Invoiceå·ç æ•°é‡: {len(inv_matches)}")
            
            # å¼ºåˆ¶è°ƒè¯•ï¼šæ˜¾ç¤ºæ‰€æœ‰æ‰¾åˆ°çš„Invoiceå·ç 
            if inv_matches:
                print("ğŸ” DEBUG: è¯¦ç»†Invoiceå·ç åˆ—è¡¨:")
                for i, inv in enumerate(inv_matches):
                    print(f"  {i+1}. {inv}")
            else:
                print("ğŸ” DEBUG: æ²¡æœ‰æ‰¾åˆ°ä»»ä½•Invoiceå·ç ï¼")
                # å°è¯•å…¶ä»–æ¨¡å¼
                print("ğŸ” DEBUG: å°è¯•å…¶ä»–Invoiceæ¨¡å¼...")
                alt_patterns = [
                    r'INV-\w+\d+',  # INV-ä»»æ„å­—æ¯+æ•°å­—
                    r'INV\d+',       # INV+æ•°å­—
                    r'INVOICE\s*\d+', # INVOICE+æ•°å­—
                    r'INV\s*\d+',    # INV+ç©ºæ ¼+æ•°å­—
                ]
                
                for pattern in alt_patterns:
                    alt_matches = re.findall(pattern, text, re.IGNORECASE)
                    if alt_matches:
                        print(f"ğŸ” DEBUG: ä½¿ç”¨æ¨¡å¼ '{pattern}' æ‰¾åˆ°: {alt_matches}")
                        inv_matches = alt_matches
                        break
            
            # ä¸å†æŸ¥æ‰¾å•ä¸€å…¨å±€Amount Dueï¼Œç›´æ¥è·³è¿‡è¿™ä¸ªé”™è¯¯é€»è¾‘
            # å› ä¸ºè¿™ä¼šå¯¼è‡´æ‰€æœ‰Invoiceä½¿ç”¨ç›¸åŒçš„Amount Due
            amount_found = None
            print(f"ğŸ” DEBUG: è·³è¿‡å…¨å±€Amount DueæŸ¥æ‰¾ï¼Œæ”¹ç”¨ç²¾ç¡®åŒ¹é…æ¯ä¸ªInvoiceçš„Amount Due")

            # è‹¥ä»æœªæ‰¾åˆ°ï¼Œå†ç”¨æ¨¡å¼ï¼ˆé¿å…èª¤æŠ“ Sub Totalï¼‰
            if not amount_found:
                siahuat_amount_patterns = [
                    r'Amount\s*Due[^\d\n]*([\d,]+\.?\d*)',     # é‡‘é¡åœ¨åŒä¸€è¡Œçš„ä»»æ„ä½ç½®
                    r'(?<!Sub\s)Total[:\s]*([\d,]+\.?\d*)',     # Totalï¼Œä½†æ’é™¤ Sub Total
                    r'(?<!Sub\s)Total\s*([\d,]+\.?\d*)',
                    r'([\d,]+\.?\d*)\s*(?<!Sub\s)Total',
                ]
            
                for pattern in siahuat_amount_patterns:
                    matches = re.findall(pattern, text, re.IGNORECASE)
                    if matches:
                        amount_found = matches[0]
                        print(f"ğŸ” DEBUG: Siahuatä½¿ç”¨æ¨¡å¼ '{pattern}' æ‰¾åˆ°é‡‘é¢: {amount_found}")
                        break
            
            # Siahuatç‰¹å®šï¼šå¦‚æœæ²¡æ‰¾åˆ°Amount Dueï¼Œå°è¯•æŸ¥æ‰¾GSTåçš„æ€»é‡‘é¢
            if not amount_found:
                print("ğŸ” DEBUG: å°è¯•Siahuatç‰¹å®šçš„GSTåæ€»é‡‘é¢æŸ¥æ‰¾")
                # æŸ¥æ‰¾GSTè¡Œï¼Œç„¶åæ‰¾ä¸‹ä¸€è¡Œçš„é‡‘é¢
                for i, line in enumerate(lines):
                    if 'GST' in line and re.search(r'\d+\.?\d*', line):
                        print(f"ğŸ” DEBUG: æ‰¾åˆ°GSTè¡Œ: {line}")
                        # æŸ¥æ‰¾GSTè¡Œä¸­çš„é‡‘é¢
                        gst_amount_match = re.search(r'([\d,]+\.?\d*)', line)
                        if gst_amount_match:
                            gst_amount = gst_amount_match.group(1)
                            print(f"ğŸ” DEBUG: GSTé‡‘é¢: {gst_amount}")
                            # æŸ¥æ‰¾ä¸‹ä¸€è¡Œçš„Amount Due
                            if i + 1 < len(lines):
                                next_line = lines[i + 1].strip()
                                print(f"ğŸ” DEBUG: GSTä¸‹ä¸€è¡Œ: {next_line}")
                                if 'Amount Due' in next_line:
                                    amount_match = re.search(r'([\d,]+\.?\d*)', next_line)
                                    if amount_match:
                                        amount_found = amount_match.group(1)
                                        print(f"ğŸ” DEBUG: GSTåæ‰¾åˆ°Amount Due: {amount_found}")
                                        break
            
            # Siahuatç‰¹å®šï¼šå¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾æœ€åçš„æ•°å­—é‡‘é¢
            if not amount_found:
                print("ğŸ” DEBUG: å°è¯•Siahuatç‰¹å®šçš„æœ€åé‡‘é¢æŸ¥æ‰¾")
                # ä»åå¾€å‰æŸ¥æ‰¾åŒ…å«æ•°å­—çš„è¡Œ
                for line in reversed(lines):
                    line = line.strip()
                    if line and re.search(r'\d', line):
                        # æŸ¥æ‰¾è¡Œä¸­çš„é‡‘é¢ï¼ˆæ’é™¤è¡Œå·ç­‰å°æ•°å­—ï¼‰
                        amount_matches = re.findall(r'(\d+\.?\d*)', line)
                        if amount_matches:
                            # é€‰æ‹©æœ€å¤§çš„æ•°å­—ä½œä¸ºé‡‘é¢
                            potential_amounts = [float(m) for m in amount_matches if float(m) > 10]  # æ’é™¤å°äº10çš„æ•°å­—
                            if potential_amounts:
                                amount_found = str(max(potential_amounts))
                                print(f"ğŸ” DEBUG: Siahuatåœ¨è¡Œ '{line}' æ‰¾åˆ°é‡‘é¢: {amount_found}")
                                break
            
            # æ–°å¢ï¼šå¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾æ‰€æœ‰åˆç†çš„é‡‘é¢
            if not amount_found:
                print("ğŸ” DEBUG: å°è¯•æŸ¥æ‰¾æ‰€æœ‰åˆç†çš„é‡‘é¢")
                # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é‡‘é¢æ¨¡å¼
                all_amount_patterns = [
                    r'(\d+\.?\d*)',  # åŸºæœ¬æ•°å­—æ¨¡å¼
                    r'(\d{1,3}(?:,\d{3})*\.?\d*)',  # å¸¦é€—å·çš„é‡‘é¢
                ]
                
                all_amounts = []
                for pattern in all_amount_patterns:
                    matches = re.findall(pattern, text)
                    for match in matches:
                        try:
                            # æ¸…ç†é‡‘é¢å­—ç¬¦ä¸²
                            clean_amount = match.replace(',', '')
                            num = float(clean_amount)
                            # è¿‡æ»¤åˆç†çš„é‡‘é¢èŒƒå›´ï¼ˆæ’é™¤é¡µç ã€æ—¥æœŸç­‰ï¼‰
                            if 10 <= num <= 100000:  # æ‰©å¤§èŒƒå›´åˆ°100,000
                                all_amounts.append((num, match))
                        except ValueError:
                            continue
                
                if all_amounts:
                    # æŒ‰é‡‘é¢å¤§å°æ’åºï¼Œé€‰æ‹©æœ€å¤§çš„
                    all_amounts.sort(key=lambda x: x[0], reverse=True)
                    amount_found = all_amounts[0][1]
                    print(f"ğŸ” DEBUG: ä»æ‰€æœ‰é‡‘é¢ä¸­é€‰æ‹©æœ€å¤§çš„: {amount_found}")
                    print(f"ğŸ” DEBUG: æ‰¾åˆ°çš„æ‰€æœ‰é‡‘é¢: {[f'{num:.2f}' for num, _ in all_amounts[:5]]}")
            
            # æ–°å¢ï¼šå¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾æ‰€æœ‰åˆç†çš„é‡‘é¢
            if not amount_found:
                print("ğŸ” DEBUG: å°è¯•æŸ¥æ‰¾æ‰€æœ‰åˆç†çš„é‡‘é¢")
                # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é‡‘é¢æ¨¡å¼
                all_amount_patterns = [
                    r'(\d+\.?\d*)',  # åŸºæœ¬æ•°å­—æ¨¡å¼
                    r'(\d{1,3}(?:,\d{3})*\.?\d*)',  # å¸¦é€—å·çš„é‡‘é¢
                ]
                
                all_amounts = []
                for pattern in all_amount_patterns:
                    matches = re.findall(pattern, text)
                    for match in matches:
                        try:
                            # æ¸…ç†é‡‘é¢å­—ç¬¦ä¸²
                            clean_amount = match.replace(',', '')
                            num = float(clean_amount)
                            # è¿‡æ»¤åˆç†çš„é‡‘é¢èŒƒå›´ï¼ˆæ’é™¤é¡µç ã€æ—¥æœŸç­‰ï¼‰
                            if 10 <= num <= 100000:  # æ‰©å¤§èŒƒå›´åˆ°100,000
                                all_amounts.append((num, match))
                        except ValueError:
                            continue
                
                if all_amounts:
                    # æŒ‰é‡‘é¢å¤§å°æ’åºï¼Œé€‰æ‹©æœ€å¤§çš„
                    all_amounts.sort(key=lambda x: x[0], reverse=True)
                    amount_found = all_amounts[0][1]
                    print(f"ğŸ” DEBUG: ä»æ‰€æœ‰é‡‘é¢ä¸­é€‰æ‹©æœ€å¤§çš„: {amount_found}")
                    print(f"ğŸ” DEBUG: æ‰¾åˆ°çš„æ‰€æœ‰é‡‘é¢: {[f'{num:.2f}' for num, _ in all_amounts[:5]]}")
            
            # æ–°å¢ï¼šå¦‚æœä»ç„¶æ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾Invoiceå·ç é™„è¿‘çš„é‡‘é¢
            if not amount_found and inv_matches:
                print("ğŸ” DEBUG: å°è¯•æŸ¥æ‰¾Invoiceå·ç é™„è¿‘çš„é‡‘é¢")
                lines = text.split('\n')
                for inv in inv_matches:
                    for i, line in enumerate(lines):
                        if inv in line:
                            print(f"ğŸ” DEBUG: æ‰¾åˆ°Invoice {inv} åœ¨ç¬¬{i+1}è¡Œ: {line}")
                            # æŸ¥æ‰¾è¯¥è¡ŒåŠé™„è¿‘è¡Œçš„é‡‘é¢
                            for j in range(max(0, i-2), min(len(lines), i+3)):
                                nearby_line = lines[j].strip()
                                if nearby_line and re.search(r'\d', nearby_line):
                                    amount_matches = re.findall(r'(\d+\.?\d*)', nearby_line)
                                    potential_amounts = []
                                    for m in amount_matches:
                                        try:
                                            num = float(m)
                                            if 10 <= num <= 100000:
                                                potential_amounts.append(num)
                                        except ValueError:
                                            continue
                                    
                                    if potential_amounts:
                                        amount_found = str(max(potential_amounts))
                                        print(f"ğŸ” DEBUG: åœ¨Invoice {inv} é™„è¿‘æ‰¾åˆ°é‡‘é¢: {amount_found}")
                                        break
                            if amount_found:
                                break
                    if amount_found:
                        break
            
            print(f"ğŸ” DEBUG: Siahuatæœ€ç»ˆæ‰¾åˆ°çš„é‡‘é¢: {amount_found}")
            
            # é¦–å…ˆå»é‡Invoiceå·ç 
            unique_inv_matches = list(set(inv_matches)) if inv_matches else []
            print(f"ğŸ” DEBUG: å»é‡åçš„Invoiceæ•°é‡: {len(unique_inv_matches)}")
            
            # ä¸å†ä½¿ç”¨å•ä¸€é‡‘é¢åˆ†é…ç»™æ‰€æœ‰Invoiceï¼Œè€Œæ˜¯è·³è¿‡è¿™ä¸ªé”™è¯¯é€»è¾‘
            # ç›´æ¥è¿›å…¥æ™ºèƒ½åŒ¹é…é˜¶æ®µ
            print(f"ğŸ” DEBUG: è·³è¿‡å•ä¸€é‡‘é¢åˆ†é…ï¼Œè¿›å…¥æ™ºèƒ½åŒ¹é…é˜¶æ®µ")
            print(f"ğŸ” DEBUG: æ‰¾åˆ°çš„å…¨å±€é‡‘é¢: {amount_found} (ä»…ç”¨äºè°ƒè¯•)")
            print(f"ğŸ” DEBUG: Invoiceå·ç æ•°é‡: {len(inv_matches)}, å»é‡åæ•°é‡: {len(unique_inv_matches)}")
            
            # ç§»é™¤é”™è¯¯çš„å¤‡ç”¨åˆ†é…é€»è¾‘ - è¿™ä¸ªé€»è¾‘ä¼šåœ¨æ™ºèƒ½åŒ¹é…ä¹‹å‰ç»™Invoiceåˆ†é…é”™è¯¯é‡‘é¢
            # ç›´æ¥è·³åˆ°æ™ºèƒ½åŒ¹é…é˜¶æ®µ
            print("ğŸ” DEBUG: è·³è¿‡å¤‡ç”¨åˆ†é…ï¼Œç›´æ¥è¿›å…¥æ™ºèƒ½Amount DueåŒ¹é…é˜¶æ®µ")
            
            # æ–°å¢ï¼šæ™ºèƒ½Invoice-é‡‘é¢åŒ¹é…
            if unique_inv_matches:
                print("ğŸ” DEBUG: å¼€å§‹æ™ºèƒ½Invoice-é‡‘é¢åŒ¹é…...")
                print(f"ğŸ” DEBUG: éœ€è¦åŒ¹é…çš„Invoiceæ•°é‡: {len(unique_inv_matches)}")
                
                # æŒ‰è¡Œåˆ†æï¼ŒæŸ¥æ‰¾æ¯ä¸ªInvoiceé™„è¿‘çš„é‡‘é¢
                lines = text.split('\n')
                print(f"ğŸ” DEBUG: æ–‡æœ¬æ€»è¡Œæ•°: {len(lines)}")
                
                for inv in unique_inv_matches:
                    if inv not in data:  # å¦‚æœè¿˜æ²¡æœ‰åŒ¹é…åˆ°é‡‘é¢
                        print(f"ğŸ” DEBUG: ä¸ºInvoice {inv} æŸ¥æ‰¾é™„è¿‘çš„Amount Due...")
                        
                        # æŸ¥æ‰¾åŒ…å«è¯¥Invoiceå·ç çš„è¡Œ
                        inv_lines = []
                        for i, line in enumerate(lines):
                            if inv in line:
                                inv_lines.append((i, line))
                        
                        print(f"ğŸ” DEBUG: Invoice {inv} å‡ºç°åœ¨ {len(inv_lines)} è¡Œ")
                        
                        if inv_lines:
                            # åˆ†ææ¯ä¸ªåŒ…å«Invoiceçš„è¡Œï¼Œå¹¶åœ¨æ›´å¤§èŒƒå›´å†…æŸ¥æ‰¾Amount Due
                            for line_num, line_content in inv_lines:
                                print(f"ğŸ” DEBUG: ç¬¬{line_num+1}è¡Œ: {line_content}")
                                
                                # é¦–å…ˆæ£€æŸ¥è¿™ä¸ªInvoiceæ˜¯å¦æ˜¯Tax Invoiceï¼ˆè€Œä¸æ˜¯Delivery Orderï¼‰
                                is_tax_invoice = False
                                if 'TAX' in line_content.upper() and 'INVOICE' in line_content.upper():
                                    is_tax_invoice = True
                                    print(f"ğŸ” DEBUG: âœ… è¿™æ˜¯Tax Invoiceè¡Œï¼Œå°†æœç´¢Amount Due")
                                elif 'DELIVERY' in line_content.upper() and 'ORDER' in line_content.upper():
                                    print(f"ğŸ” DEBUG: âŒ è¿™æ˜¯Delivery Orderè¡Œï¼Œè·³è¿‡ï¼ˆæ²¡æœ‰Amount Dueï¼‰")
                                    continue
                                else:
                                    # å¦‚æœæ— æ³•æ˜ç¡®åŒºåˆ†ï¼Œæ£€æŸ¥å‰åè¡Œæ˜¯å¦æœ‰Tax Invoiceæ ‡è¯†
                                    check_range = range(max(0, line_num-2), min(len(lines), line_num+3))
                                    for check_idx in check_range:
                                        check_line = lines[check_idx].strip().upper()
                                        if 'TAX' in check_line and 'INVOICE' in check_line:
                                            is_tax_invoice = True
                                            print(f"ğŸ” DEBUG: âœ… åœ¨ç¬¬{check_idx+1}è¡Œæ‰¾åˆ°Tax Invoiceæ ‡è¯†")
                                            break
                                        elif 'DELIVERY' in check_line and 'ORDER' in check_line:
                                            print(f"ğŸ” DEBUG: âŒ åœ¨ç¬¬{check_idx+1}è¡Œæ‰¾åˆ°Delivery Orderæ ‡è¯†ï¼Œè·³è¿‡")
                                            break
                                    
                                    if not is_tax_invoice:
                                        print(f"ğŸ” DEBUG: âš ï¸ æ— æ³•ç¡®å®šInvoiceç±»å‹ï¼Œå°†ç»§ç»­æœç´¢Amount Due")
                                        is_tax_invoice = True  # é»˜è®¤å°è¯•æœç´¢
                                
                                if not is_tax_invoice:
                                    continue
                                
                                # åœ¨è¯¥Tax Invoiceé¡µé¢èŒƒå›´å†…æŸ¥æ‰¾Amount Due
                                amount_due_found = False
                                # æ‰©å¤§æœç´¢èŒƒå›´åˆ°æ•´ä¸ªInvoiceé¡µé¢ï¼ˆå‡è®¾æ¯ä¸ªInvoiceå¤§çº¦20-50è¡Œï¼‰
                                search_range = range(max(0, line_num-10), min(len(lines), line_num+100))
                                print(f"ğŸ” DEBUG: Tax Invoiceæœç´¢èŒƒå›´: ç¬¬{max(1, line_num-9)}è¡Œåˆ°ç¬¬{min(len(lines), line_num+100)}è¡Œ")
                                
                                for j in search_range:
                                    nearby_line = lines[j].strip()
                                    # æ”¹è¿›Amount Dueçš„æ£€æµ‹ï¼Œè€ƒè™‘OCRå¯èƒ½çš„é”™è¯¯
                                    if nearby_line and (
                                        'Amount Due' in nearby_line or 
                                        'Amount' in nearby_line and 'Due' in nearby_line or
                                        'AmountDue' in nearby_line or
                                        'AMOUNT DUE' in nearby_line.upper() or
                                        'Amount' in nearby_line and 'Due:' in nearby_line
                                    ):
                                        print(f"ğŸ” DEBUG: ç¬¬{j+1}è¡Œæ‰¾åˆ°Amount Due: {nearby_line}")
                                        
                                        # å¤šç§Amount Dueæ ¼å¼çš„ç²¾ç¡®æå–ï¼Œä¼˜åŒ–åŒ¹é…ç²¾åº¦
                                        amount_due_patterns = [
                                            r'Amount\s*Due\s*[:\s]*([0-9,]+\.[0-9]{2})',  # Amount Due: 489.34 (ç²¾ç¡®å°æ•°ç‚¹)
                                            r'Amount\s*Due\s*[:\s]*([0-9,]+\.?[0-9]*)',  # Amount Due: 489 æˆ– 489.34
                                            r'AmountDue\s*[:\s]*([0-9,]+\.[0-9]{2})',     # AmountDue:489.34
                                            r'Amount\s*Due[^\d]*?([0-9,]+\.[0-9]{2})',    # Amount Due [éæ•°å­—] 489.34
                                        ]
                                        
                                        amount_extracted = False
                                        for pattern in amount_due_patterns:
                                            amount_due_match = re.search(pattern, nearby_line, re.IGNORECASE)
                                            if amount_due_match:
                                                amount = amount_due_match.group(1)
                                                # åº”ç”¨OCRé”™è¯¯ä¿®å¤
                                                corrected_amount = self._fix_ocr_amount_errors(amount)
                                                # éªŒè¯é‡‘é¢çš„åˆç†æ€§
                                                try:
                                                    amount_float = float(corrected_amount.replace(',', ''))
                                                    if (5 <= amount_float <= 100000 and 
                                                        not self._is_likely_non_amount(corrected_amount, nearby_line)):
                                                        data[inv] = corrected_amount
                                                        print(f"ğŸ” DEBUG: âœ… Invoice {inv} åŒ¹é…åˆ°Amount Due: {corrected_amount}")
                                                        amount_due_found = True
                                                        amount_extracted = True
                                                        break
                                                    else:
                                                        print(f"ğŸ” DEBUG: âš ï¸ é‡‘é¢ {corrected_amount} ä¸åˆç†ï¼Œç»§ç»­æœç´¢")
                                                except ValueError:
                                                    print(f"ğŸ” DEBUG: âš ï¸ æ— æ³•è§£æé‡‘é¢ {corrected_amount}")
                                                    pass
                                        
                                        if not amount_extracted:
                                            print(f"ğŸ” DEBUG: âŒ åœ¨Amount Dueè¡Œæ— æ³•æå–æœ‰æ•ˆé‡‘é¢: {nearby_line}")
                                            # å°è¯•åœ¨ä¸‹ä¸€è¡Œæˆ–ä¸‹å‡ è¡ŒæŸ¥æ‰¾é‡‘é¢
                                            for offset in range(1, 6):  # æ‰©å¤§åˆ°6è¡Œ
                                                if j + offset < len(lines):
                                                    next_line = lines[j + offset].strip()
                                                    if next_line:
                                                        # å¯»æ‰¾åªåŒ…å«é‡‘é¢çš„è¡Œ
                                                        amount_only_patterns = [
                                                            r'^([0-9,]+\.[0-9]{2})$',  # çº¯é‡‘é¢è¡Œ
                                                            r'^\s*([0-9,]+\.[0-9]{2})\s*$',  # å‰åæœ‰ç©ºæ ¼çš„é‡‘é¢
                                                            r'[:\s]+([0-9,]+\.[0-9]{2})\s*$',  # å†’å·åçš„é‡‘é¢
                                                        ]
                                                        for pattern in amount_only_patterns:
                                                            amount_only_match = re.search(pattern, next_line)
                                                            if amount_only_match:
                                                                amount = amount_only_match.group(1)
                                                                # åº”ç”¨OCRé”™è¯¯ä¿®å¤
                                                                corrected_amount = self._fix_ocr_amount_errors(amount)
                                                                try:
                                                                    amount_float = float(corrected_amount.replace(',', ''))
                                                                    if (5 <= amount_float <= 5000 and 
                                                                        not self._is_likely_non_amount(corrected_amount, next_line)):
                                                                        data[inv] = corrected_amount
                                                                        print(f"ğŸ” DEBUG: âœ… Invoice {inv} åœ¨ç¬¬{j+offset+1}è¡Œæ‰¾åˆ°Amount Due: {corrected_amount} (åŸå§‹: {amount})")
                                                                        amount_due_found = True
                                                                        amount_extracted = True
                                                                        break
                                                                except ValueError:
                                                                    pass
                                                        if amount_extracted:
                                                            break
                                        
                                        if amount_due_found:
                                            break
                                        
                                        if amount_due_found:
                                            break
                                
                                if amount_due_found:
                                    break
                                else:
                                    print(f"ğŸ” DEBUG: âŒ Tax Invoice {inv} åœ¨ç¬¬{line_num+1}è¡Œé™„è¿‘100è¡ŒèŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°Amount Due")
                                    
                                    # æœ€åçš„fallback: åœ¨æ•´ä¸ªTax Invoiceé¡µé¢èŒƒå›´å†…æŸ¥æ‰¾åˆç†çš„å°é‡‘é¢
                                    print(f"ğŸ” DEBUG: ğŸ”„ å¯ç”¨fallbackç­–ç•¥ï¼Œåœ¨Tax Invoiceé¡µé¢æŸ¥æ‰¾åˆç†é‡‘é¢...")
                                    page_range = range(max(0, line_num-10), min(len(lines), line_num+100))
                                    candidate_amounts = []
                                    
                                    for k in page_range:
                                        page_line = lines[k].strip()
                                        if page_line:
                                            # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é‡‘é¢
                                            amounts_in_line = re.findall(r'(\d+\.\d{2})', page_line)
                                            for amt in amounts_in_line:
                                                # åº”ç”¨OCRé”™è¯¯ä¿®å¤
                                                corrected_amt = self._fix_ocr_amount_errors(amt)
                                                try:
                                                    amt_float = float(corrected_amt)
                                                    # ä¼˜å…ˆé€‰æ‹©åˆç†çš„Invoiceé‡‘é¢èŒƒå›´ï¼Œæ’é™¤æ˜æ˜¾çš„éé‡‘é¢æ•°å­—
                                                    if 10 <= amt_float <= 1000 and not self._is_likely_non_amount(corrected_amt, page_line):
                                                        candidate_amounts.append((amt_float, corrected_amt, k+1))
                                                except ValueError:
                                                    pass
                                
                                    if candidate_amounts:
                                        # é€‰æ‹©æœ€åˆç†çš„é‡‘é¢ï¼ˆä¸­ç­‰å¤§å°ï¼Œé è¿‘é¡µé¢æœ«å°¾çš„ï¼‰
                                        candidate_amounts.sort(key=lambda x: (x[2], x[0]))  # æŒ‰è¡Œå·å’Œé‡‘é¢æ’åº
                                        best_amount = candidate_amounts[-1][1]  # é€‰æ‹©æœ€åä¸€ä¸ªï¼ˆé è¿‘é¡µé¢åº•éƒ¨ï¼‰
                                        data[inv] = best_amount
                                        print(f"ğŸ” DEBUG: ğŸ¯ Fallbackç­–ç•¥: Invoice {inv} -> é¡µé¢åˆç†é‡‘é¢: {best_amount}")
                                        amount_due_found = True
                                    # è°ƒè¯•ï¼šæ˜¾ç¤ºæœç´¢èŒƒå›´å†…çš„ä¸€äº›è¡Œ
                                    print(f"ğŸ” DEBUG: æ˜¾ç¤ºæœç´¢èŒƒå›´å†…çš„éƒ¨åˆ†è¡Œ (ç¬¬{max(1, line_num-4)}è¡Œåˆ°ç¬¬{min(len(lines), line_num+50)}è¡Œ):")
                                    debug_range = range(max(0, line_num-2), min(len(lines), line_num+10))
                                    for debug_idx in debug_range:
                                        debug_line = lines[debug_idx].strip()
                                        if debug_line:
                                            print(f"ğŸ” DEBUG:   ç¬¬{debug_idx+1}è¡Œ: {debug_line[:100]}...")  # åªæ˜¾ç¤ºå‰100å­—ç¬¦
                        else:
                            print(f"ğŸ” DEBUG: âŒ æ²¡æœ‰æ‰¾åˆ°åŒ…å«Invoice {inv} çš„è¡Œ")
                
                # å¦‚æœè¿˜æœ‰Invoiceæ²¡æœ‰é‡‘é¢ï¼Œä½¿ç”¨å…¨å±€é‡‘é¢åˆ†é…
                unmatched_invs = [inv for inv in unique_inv_matches if inv not in data]
                if unmatched_invs:
                    print(f"ğŸ” DEBUG: è¿˜æœ‰ {len(unmatched_invs)} ä¸ªInvoiceæ²¡æœ‰é‡‘é¢ï¼Œä½¿ç”¨å…¨å±€åˆ†é…...")
                    print(f"ğŸ” DEBUG: æœªåŒ¹é…çš„Invoice: {unmatched_invs}")
                    
                    # æŸ¥æ‰¾æ‰€æœ‰å¯ç”¨é‡‘é¢ï¼Œä¼˜å…ˆé€‰æ‹©è¾ƒå°çš„åˆç†é‡‘é¢ï¼ˆå‡å°‘å¤§æ•°å­—å¹²æ‰°ï¼‰
                    global_amounts = []
                    for pattern in [r'(\d+\.\d{2})', r'(\d{1,3}(?:,\d{3})*\.\d{2})']:  # åªåŒ¹é…æœ‰å°æ•°ç‚¹çš„é‡‘é¢
                        matches = re.findall(pattern, text)
                        for match in matches:
                            try:
                                clean_amount = match.replace(',', '')
                                num = float(clean_amount)
                                # æ›´ä¸¥æ ¼çš„é‡‘é¢ç­›é€‰ï¼Œé¿å…å¤§æ•°å­—å¹²æ‰°
                                if 10 <= num <= 1000:
                                    global_amounts.append((num, match))
                                elif 1000 < num <= 5000:
                                    # ä¸­ç­‰é‡‘é¢é™ä½ä¼˜å…ˆçº§
                                    global_amounts.append((num - 1000, match))  # é™ä½æƒé‡
                            except ValueError:
                                continue
                    
                    if global_amounts:
                        # æŒ‰é‡‘é¢æ’åºï¼Œå»é‡
                        global_amounts = list(set(global_amounts))
                        global_amounts.sort(key=lambda x: x[0], reverse=True)
                        print(f"ğŸ” DEBUG: å…¨å±€å¯ç”¨é‡‘é¢ (å‰10ä¸ª): {[f'{num:.2f}' for num, _ in global_amounts[:10]]}")
                        
                        # ä¸ºæœªåŒ¹é…çš„Invoiceåˆ†é…é‡‘é¢
                        for i, inv in enumerate(unmatched_invs):
                            if i < len(global_amounts):
                                assigned_amount = global_amounts[i][1]
                                data[inv] = assigned_amount
                                print(f"ğŸ” DEBUG: ğŸŒ å…¨å±€åˆ†é…: Invoice {inv} -> é‡‘é¢: {assigned_amount}")
                            else:
                                # ä½¿ç”¨æœ€åä¸€ä¸ªé‡‘é¢
                                if global_amounts:
                                    last_amount = global_amounts[-1][1]
                                    data[inv] = last_amount
                                    print(f"ğŸ” DEBUG: ğŸŒ å…¨å±€åˆ†é…: Invoice {inv} -> é‡‘é¢: {last_amount}")
                    else:
                        print(f"ğŸ” DEBUG: âŒ æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å…¨å±€é‡‘é¢")
                else:
                    print("ğŸ” DEBUG: âœ… æ‰€æœ‰Invoiceéƒ½å·²åŒ¹é…åˆ°é‡‘é¢")
            else:
                print("ğŸ” DEBUG: âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•Invoiceå·ç ï¼Œæ— æ³•è¿›è¡ŒåŒ¹é…")
            
            print(f"ğŸ” DEBUG: æœ€ç»ˆInvoiceæ•°æ®: {data}")
            print(f"ğŸ” DEBUG: åŒ¹é…æˆåŠŸçš„Invoiceæ•°é‡: {len(data)}")
            return data
            
        except Exception as e:
            print(f"ğŸ” DEBUG: Siahuat Invoiceæ•°æ®æå–å¤±è´¥: {e}")
            import traceback
            print(f"ğŸ” DEBUG: é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            return {}
    
    def _extract_soa_data(self, text):
        """ä»SOA PDFæå–Invoiceå·ç å’ŒDré‡‘é¢ - ä¸“é—¨é’ˆå¯¹Siahuat SOAæ¨¡æ¿ä¼˜åŒ–"""
        data = {}
        try:
            import re
            
            print("ğŸ” DEBUG: å¼€å§‹æå–Siahuat SOAæ•°æ®")
            
            # ===== SIAHUAT SOA SPECIFIC PATTERNS =====
            # æŸ¥æ‰¾Invoiceå·ç æ¨¡å¼ - Siahuatæ ¼å¼: INV-SH250603XXX
            inv_pattern = r'INV-SH\d+'
            inv_matches = re.findall(inv_pattern, text)
            print(f"ğŸ” DEBUG: æ‰¾åˆ°Siahuat SOAä¸­çš„Invoiceå·ç : {inv_matches}")
            
            # æŒ‰è¡Œå¤„ç†ï¼ŒæŸ¥æ‰¾åŒ…å«Invoiceå·ç å’ŒDré‡‘é¢çš„è¡Œ
            lines = text.split('\n')
            for idx, line in enumerate(lines):
                line = line.strip()
                if line and 'INV-SH' in line:
                    print(f"ğŸ” DEBUG: å¤„ç†Siahuat SOAè¡Œ: {line}")
                    
                    # æå–Invoiceå·ç 
                    inv_match = re.search(inv_pattern, line)
                    if inv_match:
                        inv = inv_match.group()
                        
                        # Siahuat SOAç‰¹å®šçš„Dré‡‘é¢æŸ¥æ‰¾æ¨¡å¼
                        # æ ¹æ®å®é™…SOAæ¨¡æ¿ï¼ŒDré‡‘é¢é€šå¸¸åœ¨è¡Œçš„æœ«å°¾
                        siahuat_dr_patterns = [
                            r'Dr\s*([\d,]+\.?\d*)\s*(?:$|Balance|Cr)',  # æ˜ç¢ºæŠ“ Dr å¾Œé‡‘é¡
                            r'([\d,]+\.?\d*)\s*Dr',                      # é‡‘é¡åœ¨å‰ï¼Œæ¥ Dr
                        ]  # ä¸å†ä½¿ç”¨è¡Œæœ«é‡‘é¡ä»¥é¿å…æŠ“åˆ° Balance
                        
                        dr_amount = None
                        for pattern in siahuat_dr_patterns:
                            matches = re.findall(pattern, line, re.IGNORECASE)
                            if matches:
                                # è¿‡æ»¤æ‰è¡Œå·ç­‰å°æ•°å­—ï¼Œé€‰æ‹©åˆç†çš„é‡‘é¢
                                potential_amounts = []
                                for m in matches:
                                    try:
                                        num = float(m.replace(',', ''))
                                        # Siahuatçš„Dré‡‘é¢é€šå¸¸åœ¨10-10000ä¹‹é—´
                                        if 10 <= num <= 10000:
                                            potential_amounts.append(num)
                                    except ValueError:
                                        continue
                                
                                if potential_amounts:
                                    dr_amount = str(max(potential_amounts))
                                    print(f"ğŸ” DEBUG: Siahuat SOAä½¿ç”¨æ¨¡å¼ '{pattern}' æ‰¾åˆ°Dré‡‘é¢: {dr_amount}")
                                    break
                        
                        # è‹¥æœ¬è¡Œä»æœªå–åˆ°ï¼Œå…ˆåœ¨æœ¬è¡ŒæŠ“å–æˆå°é‡‘é¡ï¼ˆç¬¬ä¸€å€‹è¦–ç‚º Drï¼Œç¬¬äºŒå€‹è¦–ç‚º Balanceï¼‰
                        if not dr_amount:
                            dec_pat = r'(\d{1,3}(?:,\d{3})*\.\d{2}|\d+\.\d{2})'
                            pair = re.findall(dec_pat, line)
                            if len(pair) >= 2:
                                dr_amount = pair[0]
                                print(f"ğŸ” DEBUG: æœ¬è¡Œé›™é‡‘é¡ï¼Œå–ç¬¬ä¸€å€‹ç‚ºDr: Dr={pair[0]}, Balance={pair[1]}")
                            elif len(pair) == 1:
                                dr_amount = pair[0]
                                print(f"ğŸ” DEBUG: æœ¬è¡Œå–®ä¸€é‡‘é¡ï¼Œè¦–ç‚ºDr: {pair[0]}")

                        # è‹¥æœ¬è¡Œä»æ²’æœ‰æ•¸å­—ï¼Œå†å‘å¾Œå¹¾è¡Œæ‰¾ç¬¬ä¸€å€‹é‡‘é¡è¦–ç‚º Dr
                        if not dr_amount:
                            lookahead_max = 2
                            dec_pat = r'(\d{1,3}(?:,\d{3})*\.\d{2}|\d+\.\d{2})'
                            for j in range(idx, min(idx + 1 + lookahead_max, len(lines))):
                                row = lines[j]
                                m = re.findall(dec_pat, row)
                                if len(m) >= 2:
                                    dr_amount = m[0]
                                    print(f"ğŸ” DEBUG: å‰ç»é›™é‡‘é¡ï¼Œå–ç¬¬ä¸€å€‹ç‚ºDrï¼Œç¬¬{j+1}è¡Œ: Dr={m[0]}, Balance={m[1]}")
                                    break
                                elif len(m) == 1:
                                    dr_amount = m[0]
                                    print(f"ğŸ” DEBUG: å‰ç»å–®ä¸€é‡‘é¡ï¼Œè¦–ç‚ºDrï¼Œç¬¬{j+1}è¡Œ: {m[0]}")
                                    break

                        if dr_amount:
                            if inv not in data:
                                data[inv] = dr_amount
                                print(f"ğŸ” DEBUG: Siahuat SOA {inv} -> Dré‡‘é¢: {dr_amount}")
                            else:
                                print(f"ğŸ” DEBUG: å·²æœ‰Dré‡‘é¡ {data[inv]}ï¼Œå¿½ç•¥å¾ŒçºŒå€¼ {dr_amount}")
                        else:
                            # å›é€€ï¼šè‹¥æ²’æœ‰æ˜ç¢º 'Dr' æ¨™è¨˜ï¼Œå‰‡å–è©²è¡Œæ•¸å­—ä¸­å€’æ•¸ç¬¬äºŒå€‹ï¼ˆæœ€å¾Œä¸€å€‹é€šå¸¸æ˜¯ Balanceï¼‰
                            nums = re.findall(r'([0-9]{1,3}(?:,[0-9]{3})*\.\d{2}|\d+\.\d{2})', line)
                            # éæ¿¾åˆç†é‡‘é¡
                            nums_clean = []
                            for s in nums:
                                try:
                                    val = float(s.replace(',', ''))
                                    if 1 <= val <= 100000:
                                        nums_clean.append(s)
                                except Exception:
                                    pass
                            if len(nums_clean) >= 2:
                                dr_guess = nums_clean[-2]
                                if inv not in data:
                                    data[inv] = dr_guess
                                    print(f"ğŸ” DEBUG: ç„¡Dræ¨™è¨˜ï¼Œä½¿ç”¨å€’æ•¸ç¬¬äºŒå€‹æ•¸å­—ä½œç‚ºDr: {dr_guess}")
                                else:
                                    print(f"ğŸ” DEBUG: å·²æœ‰Dré‡‘é¡ {data[inv]}ï¼Œå¿½ç•¥å›é€€å€¼ {dr_guess}")
                            elif len(nums_clean) == 1:
                                dr_guess = nums_clean[0]
                                if inv not in data:
                                    data[inv] = dr_guess
                                    print(f"ğŸ” DEBUG: ç„¡Dræ¨™è¨˜ï¼Œåƒ…ä¸€å€‹æ•¸å­—ï¼Œè¦–ç‚ºDr: {dr_guess}")
                                else:
                                    print(f"ğŸ” DEBUG: å·²æœ‰Dré‡‘é¡ {data[inv]}ï¼Œå¿½ç•¥å›é€€å€¼ {dr_guess}")
                            else:
                                print(f"ğŸ” DEBUG: æœªæ‰¾åˆ°Siahuat SOA {inv} çš„Dré‡‘é¢")
            
            print(f"ğŸ” DEBUG: Siahuat SOAæ•°æ®æå–å®Œæˆï¼Œå…±æ‰¾åˆ° {len(data)} ä¸ªé¡¹ç›®")
            return data
            
        except Exception as e:
            print(f"ğŸ” DEBUG: Siahuat SOAæ•°æ®æå–å¤±è´¥: {e}")
            import traceback
            print(f"ğŸ” DEBUG: é”™è¯¯è¯¦æƒ…: {traceback.format_exc()}")
            return {}
    
    def _extract_fallback_data(self, text, source_name):
        """å¤‡ç”¨æ•°æ®æå–æ–¹æ³•"""
        data = {}
        
        try:
            import re
            
            # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é‡‘é¢
            amounts = re.findall(r'[\$]?[\d,]+\.?\d*', text)
            
            # ä¸ºæ¯ä¸ªé‡‘é¢åˆ›å»ºä¸€ä¸ªé¡¹ç›®åç§°
            for i, amount in enumerate(amounts):
                item_name = f"é¡¹ç›®{i+1}_{source_name}"
                data[item_name] = amount
                
        except Exception as e:
            print(f"å¤‡ç”¨æ•°æ®æå–å¤±è´¥: {e}")
        
        return data
    
    def _test_invoice_extraction_fix(self):
        """æµ‹è¯•Invoiceé‡‘é¢æå–ä¿®å¤"""
        print("ğŸ§ª æµ‹è¯•: ä¿®å¤åçš„Invoiceé‡‘é¢æå–é€»è¾‘")
        
        # åˆ›å»ºæ¨¡æ‹Ÿçš„PDFæ–‡æœ¬æ•°æ®ï¼ŒåŒ…å«å¤šä¸ªInvoiceå’Œä¸åŒé‡‘é¢
        test_text = """
        SIAHUAT TRADING SDN BHD
        
        Invoice: INV-SH250603201
        Amount Due: 150.50
        
        Invoice: INV-SH250603202  
        Amount Due: 275.75
        
        Invoice: INV-SH250603203
        Amount Due: 432.10
        
        Invoice: INV-SH250603204
        Amount Due: 89.25
        """
        
        # æµ‹è¯•æå–
        result = self._extract_invoice_data(test_text)
        
        print(f"ğŸ§ª æµ‹è¯•ç»“æœ:")
        for inv, amount in result.items():
            print(f"  {inv} -> {amount}")
        
        # éªŒè¯æ˜¯å¦æ¯ä¸ªInvoiceéƒ½æœ‰ä¸åŒçš„é‡‘é¢
        unique_amounts = set(result.values())
        if len(unique_amounts) == len(result):
            print("âœ… æµ‹è¯•é€šè¿‡: æ¯ä¸ªInvoiceéƒ½æœ‰ç‹¬ç«‹çš„é‡‘é¢")
        else:
            print("âŒ æµ‹è¯•å¤±è´¥: ä»æœ‰Invoiceä½¿ç”¨ç›¸åŒé‡‘é¢")
        
        return len(unique_amounts) == len(result)
    
    def _display_reconciliation_results(self):
        """æ˜¾ç¤ºæ ¸å¯¹ç»“æœ"""
        for result in self.reconciliation_results:
            self.tree.insert('', 'end', values=(
                result['item'],
                result['pdf_value'],
                result['soa_value'],
                result['difference'],
                result['status']
            ))
    
    def _export_results(self):
        """å¯¼å‡ºç»“æœ"""
        if not self.reconciliation_results:
            messagebox.showwarning("è­¦å‘Š", "æ²’æœ‰å¯å°å‡ºçš„çµæœï¼")
            return
        
        try:
            file_path = filedialog.asksaveasfilename(
                title="å°å‡ºæ ¸å°çµæœ / Export reconciliation results",
                defaultextension=".xlsx",
                filetypes=[
                    ("Excel files", "*.xlsx"),
                    ("CSV files", "*.csv"),
                    ("All files", "*.*")
                ]
            )
            
            if file_path:
                if file_path.lower().endswith('.csv'):
                    self._export_to_csv(file_path)
                else:
                    self._export_to_excel(file_path)
                
                messagebox.showinfo("æˆåŠŸ", f"çµæœå·²å°å‡ºåˆ°ï¼š{file_path}")
        
        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"å°å‡ºå¤±æ•—ï¼š{str(e)}")
    
    def _export_to_excel(self, file_path):
        """å¯¼å‡ºåˆ°Excel"""
        import openpyxl
        
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "SOAæ ¸å¯¹ç»“æœ"
        
        # å†™å…¥æ ‡é¢˜
        headers = ['é …ç›®', 'PDF1å€¼', 'PDF2å€¼', 'å·®ç•°', 'ç‹€æ…‹']
        for col, header in enumerate(headers, 1):
            ws.cell(row=1, column=col, value=header)
        
        # å†™å…¥æ•°æ®
        for row, result in enumerate(self.reconciliation_results, 2):
            ws.cell(row=row, column=1, value=result['item'])
            ws.cell(row=row, column=2, value=result['pdf_value'])
            ws.cell(row=row, column=3, value=result['soa_value'])
            ws.cell(row=row, column=4, value=result['difference'])
            ws.cell(row=row, column=5, value=result['status'])
        
        wb.save(file_path)
        wb.close()
    
    def _export_to_csv(self, file_path):
        """å¯¼å‡ºåˆ°CSV"""
        import csv
        
        with open(file_path, 'w', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            
            # å†™å…¥æ ‡é¢˜
            writer.writerow(['é …ç›®', 'PDF1å€¼', 'PDF2å€¼', 'å·®ç•°', 'ç‹€æ…‹'])
            
            # å†™å…¥æ•°æ®
            for result in self.reconciliation_results:
                writer.writerow([
                    result['item'],
                    result['pdf_value'],
                    result['soa_value'],
                    result['difference'],
                    result['status']
                ])
    
    def _generate_report(self):
        """ç”ŸæˆæŠ¥å‘Š"""
        if not self.reconciliation_results:
            messagebox.showwarning("è­¦å‘Š", "æ²’æœ‰å¯ç”Ÿæˆå ±å‘Šçš„çµæœï¼")
            return
        
        try:
            # åˆ›å»ºæŠ¥å‘Šå†…å®¹
            report_content = self._create_report_content()
            
            # æ˜¾ç¤ºæŠ¥å‘Š
            self._show_report_window(report_content)
            
        except Exception as e:
            messagebox.showerror("éŒ¯èª¤", f"ç”Ÿæˆå ±å‘Šå¤±æ•—ï¼š{str(e)}")
    
    def _create_report_content(self):
        """åˆ›å»ºæŠ¥å‘Šå†…å®¹"""
        total_items = len(self.reconciliation_results)
        matched_items = sum(1 for r in self.reconciliation_results if r['status'] == "âœ… åŒ¹é…")
        unmatched_items = total_items - matched_items
        
        report = f"""
PDF æ–‡ä»¶æ ¸å¯¹æŠ¥å‘Š / PDF Files Reconciliation Report
{'='*50}

æ€»ç»“ / Summary:
- æ€»é¡¹ç›®æ•° / Total Items: {total_items}
- åŒ¹é…é¡¹ç›® / Matched Items: {matched_items}
- æœªåŒ¹é…é¡¹ç›® / Unmatched Items: {unmatched_items}
- åŒ¹é…ç‡ / Match Rate: {(matched_items/total_items*100):.1f}%

è¯¦ç»†ç»“æœ / Detailed Results:
{'-'*50}
"""
        
        for result in self.reconciliation_results:
            report += f"""
é¡¹ç›® / Item: {result['item']}
PDF1å€¼ / PDF1 Value: {result['pdf_value']}
PDF2å€¼ / PDF2 Value: {result['soa_value']}
å·®å¼‚ / Difference: {result['difference']}
çŠ¶æ€ / Status: {result['status']}
{'-'*30}
"""
        
        return report
    
    def _show_report_window(self, report_content):
        """æ˜¾ç¤ºæŠ¥å‘Šçª—å£ - æ·»åŠ ç½®é¡¶å’Œæœç´¢åŠŸèƒ½"""
        report_window = ctk.CTkToplevel(self)
        report_window.title("PDF æ–‡ä»¶æ ¸å¯¹æŠ¥å‘Š / PDF Files Reconciliation Report")
        report_window.geometry("900x700")
        report_window.resizable(True, True)
        
        # è®¾ç½®çª—å£ç½®é¡¶
        report_window.attributes('-topmost', True)
        report_window.lift()
        report_window.focus_force()
        
        # æœç´¢æ¡†æ¶
        search_frame = ctk.CTkFrame(report_window, fg_color='transparent')
        search_frame.pack(fill='x', padx=20, pady=(20, 10))
        
        # æœç´¢æ ‡ç­¾
        search_label = ctk.CTkLabel(search_frame, text="æœç´¢ / Search:", font=FONT_MID)
        search_label.pack(side='left', padx=(0, 10))
        
        # æœç´¢è¾“å…¥æ¡†
        search_var = ctk.StringVar()
        search_entry = ctk.CTkEntry(search_frame, textvariable=search_var, 
                                   placeholder_text="è¾“å…¥Invoiceå·ç æˆ–é‡‘é¢è¿›è¡Œæœç´¢...", 
                                   width=300, font=FONT_MID)
        search_entry.pack(side='left', padx=(0, 10))
        
        # æœç´¢æŒ‰é’®
        def perform_search():
            search_term = search_var.get().strip().lower()
            if not search_term:
                # å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºå…¨éƒ¨å†…å®¹
                report_text.delete('1.0', 'end')
                report_text.insert('1.0', report_content)
                return
            
            # æœç´¢åŒ¹é…çš„å†…å®¹
            search_results = []
            lines = report_content.split('\n')
            current_item = []
            in_item = False
            
            for line in lines:
                if line.startswith('é¡¹ç›® / Item:') or line.startswith('é¡¹ç›®/ Item:'):
                    if in_item and current_item:
                        # æ£€æŸ¥å½“å‰é¡¹ç›®æ˜¯å¦åŒ¹é…æœç´¢æ¡ä»¶
                        item_text = '\n'.join(current_item)
                        if search_term in item_text.lower():
                            search_results.extend(current_item)
                            search_results.append('-' * 30)
                        current_item = []
                    current_item = [line]
                    in_item = True
                elif in_item:
                    current_item.append(line)
            
            # æ£€æŸ¥æœ€åä¸€ä¸ªé¡¹ç›®
            if in_item and current_item:
                item_text = '\n'.join(current_item)
                if search_term in item_text.lower():
                    search_results.extend(current_item)
            
            # æ˜¾ç¤ºæœç´¢ç»“æœ
            if search_results:
                search_content = '\n'.join(search_results)
                report_text.delete('1.0', 'end')
                report_text.insert('1.0', f"æœç´¢ç»“æœ / Search Results for '{search_term}':\n{'-'*50}\n{search_content}")
            else:
                report_text.delete('1.0', 'end')
                report_text.insert('1.0', f"æœªæ‰¾åˆ°åŒ¹é… '{search_term}' çš„ç»“æœ / No results found for '{search_term}'")
        
        search_btn = ctk.CTkButton(search_frame, text="æœç´¢ / Search", 
                                  command=perform_search, 
                                  fg_color=ACCENT_GREEN, font=FONT_MID)
        search_btn.pack(side='left', padx=(0, 10))
        
        # æ¸…é™¤æœç´¢æŒ‰é’®
        def clear_search():
            search_var.set("")
            report_text.delete('1.0', 'end')
            report_text.insert('1.0', report_content)
        
        clear_btn = ctk.CTkButton(search_frame, text="æ¸…é™¤ / Clear", 
                                 command=clear_search, 
                                 fg_color=ACCENT_PURPLE, font=FONT_MID)
        clear_btn.pack(side='left')
        
        # æŠ¥å‘Šå†…å®¹
        report_text = ctk.CTkTextbox(report_window, font=FONT_MID)
        report_text.pack(fill='both', expand=True, padx=20, pady=(0, 20))
        report_text.insert('1.0', report_content)
        
        # æŒ‰é’®æ¡†æ¶
        button_frame = ctk.CTkFrame(report_window, fg_color='transparent')
        button_frame.pack(fill='x', padx=20, pady=(0, 20))
        
        # å…³é—­æŒ‰é’®
        ctk.CTkButton(
            button_frame,
            text="é—œé–‰ / Close",
            command=report_window.destroy,
            fg_color=ACCENT_BLUE,
            font=FONT_MID
        ).pack(side='right')
        
        # ç»‘å®šå›è½¦é”®æœç´¢
        search_entry.bind('<Return>', lambda event: perform_search())
        
        # è®¾ç½®ç„¦ç‚¹åˆ°æœç´¢æ¡†
        search_entry.focus()

    def _run_auto_f5_deduction(self):
        """è‡ªåŠ¨F5æ‰£åˆ†ï¼šæ£€æŸ¥å‘¨ä¸‰12ç‚¹åçš„è®¢å•"""
        from datetime import datetime, timedelta
        import os
        from tkinter import messagebox
        
        folder = self.download_folder_var.get()
        if not folder:
            messagebox.showwarning("è­¦å‘Š", "è¯·å…ˆé€‰æ‹©ä¸‹è½½æ–‡ä»¶å¤¹ï¼")
            return
        
        # è®¡ç®—æœ¬å‘¨ä¸‰12ç‚¹çš„æ—¶é—´
        today = datetime.now()
        days_until_wednesday = (2 - today.weekday()) % 7  # 2 = Wednesday
        if days_until_wednesday == 0:  # å¦‚æœä»Šå¤©æ˜¯å‘¨ä¸‰
            wednesday_noon = today.replace(hour=12, minute=0, second=0, microsecond=0)
        else:
            wednesday_noon = (today + timedelta(days=days_until_wednesday)).replace(hour=12, minute=0, second=0, microsecond=0)
        
        # æ£€æŸ¥é‚®ä»¶æ—¥å¿—æ–‡ä»¶
        month_name = today.strftime('%b').title()
        week_of_month = get_week_of_month(today)
        save_path = os.path.join(folder, f"{month_name} - Week {week_of_month}")
        log_file = os.path.join(save_path, "email_bodies_log.txt")
        
        if not os.path.exists(log_file):
            messagebox.showinfo("ä¿¡æ¯", "æœªæ‰¾åˆ°é‚®ä»¶æ—¥å¿—æ–‡ä»¶ï¼Œè¯·å…ˆä¸‹è½½é‚®ä»¶ï¼")
            return
        
        # è¯»å–é‚®ä»¶æ—¥å¿—ï¼Œæ£€æŸ¥å‘¨ä¸‰12ç‚¹åçš„è®¢å•
        late_orders = []
        try:
            with open(log_file, "r", encoding="utf-8") as f:
                content = f.read()
            
            # è§£æé‚®ä»¶å†…å®¹
            email_blocks = content.split("â€”â€”â€” é‚®ä»¶")
            for block in email_blocks[1:]:  # è·³è¿‡ç¬¬ä¸€ä¸ªç©ºå—
                lines = block.strip().splitlines()
                if len(lines) < 3:
                    continue
                
                # æå–é‚®ä»¶æ—¶é—´ï¼ˆå‡è®¾æ ¼å¼ï¼šæ—¶é—´åœ¨ä¸»é¢˜è¡Œä¸­ï¼‰
                subject_line = ""
                for line in lines:
                    if line.startswith("[ä¸»é¢˜]"):
                        subject_line = line
                        break
                
                # æ£€æŸ¥æ˜¯å¦åŒ…å«æ—¶é—´ä¿¡æ¯
                if "å‘¨ä¸‰" in subject_line or "wednesday" in subject_line.lower():
                    # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„æ—¶é—´è§£æé€»è¾‘
                    # æš‚æ—¶æ ‡è®°ä¸ºéœ€è¦æ£€æŸ¥çš„é‚®ä»¶
                    late_orders.append(f"é‚®ä»¶ä¸»é¢˜: {subject_line}")
        
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"è¯»å–é‚®ä»¶æ—¥å¿—å¤±è´¥: {e}")
            return
        
        # æ˜¾ç¤ºç»“æœ
        if late_orders:
            result_text = f"å‘ç° {len(late_orders)} ä¸ªå¯èƒ½è¿Ÿäº¤çš„è®¢å•ï¼ˆå‘¨ä¸‰12ç‚¹åï¼‰ï¼š\n\n"
            result_text += "\n".join(late_orders)
            result_text += "\n\nå»ºè®®è¿›è¡ŒF5æ‰£åˆ†å¤„ç†ã€‚"
            messagebox.showwarning("F5æ‰£åˆ†æé†’", result_text)
        else:
            messagebox.showinfo("F5æ‰£åˆ†æ£€æŸ¥", "æœªå‘ç°å‘¨ä¸‰12ç‚¹åçš„è¿Ÿäº¤è®¢å•ã€‚")
    
    def _show_manual_f5_deduction(self):
        """æ˜¾ç¤ºæ‰‹åŠ¨F5æ‰£åˆ†ç•Œé¢"""
        from tkinter import messagebox
        import tkinter as tk
        
        # åˆ›å»ºæ‰‹åŠ¨æ‰£åˆ†çª—å£
        deduction_window = tk.Toplevel(self)
        deduction_window.title("æ‰‹åŠ¨F5æ‰£åˆ† / Manual F5 Deduction")
        deduction_window.geometry("600x500")
        deduction_window.configure(bg="#f1f5f9")
        
        # æ ‡é¢˜
        title_label = tk.Label(
            deduction_window,
            text="æ‰‹åŠ¨F5æ‰£åˆ†ç³»ç»Ÿ",
            font=("Microsoft YaHei", 18, "bold"),
            bg="#f1f5f9",
            fg="#1e3a8a"
        )
        title_label.pack(pady=20)
        
        # æ‰£åˆ†åŸå› é€‰æ‹©
        reason_frame = tk.Frame(deduction_window, bg="#f1f5f9")
        reason_frame.pack(pady=10)
        
        tk.Label(
            reason_frame,
            text="æ‰£åˆ†åŸå›  / Deduction Reason:",
            font=("Microsoft YaHei", 12, "bold"),
            bg="#f1f5f9"
        ).pack(anchor="w")
        
        reason_var = tk.StringVar(value="è¿Ÿäº¤è®¢å•")
        reasons = [
            "è¿Ÿäº¤è®¢å• / Late Order",
            "è®¢å•æ ¼å¼é”™è¯¯ / Wrong Order Format", 
            "æ•°é‡é”™è¯¯ / Wrong Quantity",
            "å…¶ä»– / Others"
        ]
        
        reason_menu = tk.OptionMenu(reason_frame, reason_var, *reasons)
        reason_menu.config(font=("Microsoft YaHei", 11), width=25)
        reason_menu.pack(pady=5)
        
        # æ‰£åˆ†åˆ†æ•°
        score_frame = tk.Frame(deduction_window, bg="#f1f5f9")
        score_frame.pack(pady=10)
        
        tk.Label(
            score_frame,
            text="æ‰£åˆ†åˆ†æ•° / Deduction Score:",
            font=("Microsoft YaHei", 12, "bold"),
            bg="#f1f5f9"
        ).pack(anchor="w")
        
        score_var = tk.StringVar(value="5")
        scores = ["1", "2", "3", "5", "10", "15", "20"]
        
        score_menu = tk.OptionMenu(score_frame, score_var, *scores)
        score_menu.config(font=("Microsoft YaHei", 11), width=15)
        score_menu.pack(pady=5)
        
        # å¤‡æ³¨è¾“å…¥
        note_frame = tk.Frame(deduction_window, bg="#f1f5f9")
        note_frame.pack(pady=10)
        
        tk.Label(
            note_frame,
            text="å¤‡æ³¨ / Notes:",
            font=("Microsoft YaHei", 12, "bold"),
            bg="#f1f5f9"
        ).pack(anchor="w")
        
        note_text = tk.Text(note_frame, height=4, width=50, font=("Microsoft YaHei", 11))
        note_text.pack(pady=5)
        
        # æ‰£åˆ†æŒ‰é’®
        def apply_deduction():
            reason = reason_var.get()
            score = score_var.get()
            note = note_text.get("1.0", "end-1c")
            
            if not note.strip():
                messagebox.showwarning("è­¦å‘Š", "è¯·è¾“å…¥æ‰£åˆ†å¤‡æ³¨ï¼")
                return
            
            # è¿™é‡Œå¯ä»¥æ·»åŠ æ‰£åˆ†è®°å½•ä¿å­˜é€»è¾‘
            result_text = f"F5æ‰£åˆ†å·²åº”ç”¨ï¼š\n\n"
            result_text += f"æ‰£åˆ†åŸå› : {reason}\n"
            result_text += f"æ‰£åˆ†åˆ†æ•°: {score}\n"
            result_text += f"å¤‡æ³¨: {note}\n\n"
            result_text += "æ‰£åˆ†è®°å½•å·²ä¿å­˜ã€‚"
            
            messagebox.showinfo("æ‰£åˆ†æˆåŠŸ", result_text)
            deduction_window.destroy()
        
        button_frame = tk.Frame(deduction_window, bg="#f1f5f9")
        button_frame.pack(pady=20)
        
        apply_btn = tk.Button(
            button_frame,
            text="åº”ç”¨æ‰£åˆ† / Apply Deduction",
            command=apply_deduction,
            font=("Microsoft YaHei", 12, "bold"),
            bg="#dc2626",
            fg="white",
            padx=20,
            pady=10,
            relief="flat"
        )
        apply_btn.pack(side="left", padx=10)
        
        cancel_btn = tk.Button(
            button_frame,
            text="å–æ¶ˆ / Cancel",
            command=deduction_window.destroy,
            font=("Microsoft YaHei", 12, "bold"),
            bg="#6b7280",
            fg="white",
            padx=20,
            pady=10,
            relief="flat"
        )
        cancel_btn.pack(side="left", padx=10)
    
    def _extract_outlet_from_subject(self, subject):
        """
        ä»é‚®ä»¶ä¸»é¢˜ä¸­æå–é—¨å¸‚åç§°ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é—¨å¸‚æ˜ å°„
        """
        try:
            # è·å–é…ç½®æ–‡ä»¶è·¯å¾„
            config_file = self.config_file_var.get()
            if not config_file or not os.path.exists(config_file):
                print(f"[è­¦å‘Š] é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_file}")
                return self._fallback_extract_outlet(subject)
            
            # è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„é—¨å¸‚ä¿¡æ¯
            import pandas as pd
            try:
                # è¯»å–OUTLETå·¥ä½œè¡¨
                df = pd.read_excel(config_file, sheet_name="OUTLET")
                
                # æ„å»ºé—¨å¸‚æ˜ å°„å­—å…¸
                outlet_mapping = {}
                for _, row in df.iterrows():
                    short_name = str(row['Short Name']).strip().upper()
                    full_name = str(row['Outlet Full Name']).strip().lower()
                    email_name = str(row['Name in Email']).strip().lower()
                    
                    # å°†å„ç§åç§°æ˜ å°„åˆ°çŸ­åç§°
                    if short_name and short_name != 'nan':
                        outlet_mapping[full_name] = short_name
                        outlet_mapping[email_name] = short_name
                        
                        # ä¹Ÿæ·»åŠ ä¸€äº›å¸¸è§çš„å˜ä½“
                        if ' ' in full_name:
                            words = full_name.split()
                            for word in words:
                                if len(word) >= 2:
                                    outlet_mapping[word] = short_name
                
                # å°†ä¸»é¢˜è½¬æ¢ä¸ºå°å†™è¿›è¡ŒåŒ¹é…
                subject_lower = subject.lower()
                
                # å°è¯•åŒ¹é…é—¨å¸‚åç§°
                for key, value in outlet_mapping.items():
                    if key in subject_lower and key != 'nan':
                        print(f"[DEBUG] åŒ¹é…åˆ°é—¨å¸‚: {key} -> {value}")
                        return value
                
                # å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œå°è¯•æå–ç¬¬ä¸€ä¸ªå•è¯ä½œä¸ºé—¨å¸‚åç§°
                words = subject.split()
                if words:
                    first_word = words[0].strip('-_').upper()
                    if len(first_word) >= 2:  # è‡³å°‘2ä¸ªå­—ç¬¦
                        print(f"[DEBUG] ä½¿ç”¨ç¬¬ä¸€ä¸ªå•è¯ä½œä¸ºé—¨å¸‚: {first_word}")
                        return first_word
                
                print(f"[DEBUG] æœªæ‰¾åˆ°åŒ¹é…çš„é—¨å¸‚ï¼Œä½¿ç”¨é»˜è®¤æ–¹æ³•")
                return self._fallback_extract_outlet(subject)
                
            except Exception as e:
                print(f"[é”™è¯¯] è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
                return self._fallback_extract_outlet(subject)
                
        except Exception as e:
            print(f"[é”™è¯¯] é…ç½®æ–‡ä»¶å¤„ç†å¤±è´¥: {e}")
            return self._fallback_extract_outlet(subject)
    
    def _fallback_extract_outlet(self, subject):
        """
        å¤‡ç”¨é—¨å¸‚æå–æ–¹æ³•ï¼ˆå½“é…ç½®æ–‡ä»¶ä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰
        """
        # å¸¸è§çš„é—¨å¸‚åç§°æ˜ å°„ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
        fallback_mapping = {
            'west mall': 'WWP',
            'westgate': 'WG',
            '313': '313',
            'tpy': 'TPY',
            'oasis': 'OASIS',
            'hbb': 'HBB',
            'nex': 'NEX',
            'sm': 'SM',
            'fn': 'FN',
            'imm': 'IMM',
            'npc': 'NPC',
            'tcm': 'TCM',
            'yts': 'YTS',
            'pp': 'PP',
            'csq': 'CSQ',
            'hlm': 'HLM',
            't1': 'image.pngT1',
            'hm': 'HM',
            'skmrt': 'SKMRT',
            'skg': 'SKG',
            'bgm': 'BGM',
            'amk': 'AMK',
            'resendgtm': 'GTM',
            'plq': 'PLQ',
            'j8': 'J8',
            'junction 8': 'J8',
            'tpc': 'TPC'
        }
        
        # å°†ä¸»é¢˜è½¬æ¢ä¸ºå°å†™è¿›è¡ŒåŒ¹é…
        subject_lower = subject.lower()
        
        # å°è¯•åŒ¹é…é—¨å¸‚åç§°
        for key, value in fallback_mapping.items():
            if key in subject_lower:
                return value
        
        # å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œå°è¯•æå–ç¬¬ä¸€ä¸ªå•è¯ä½œä¸ºé—¨å¸‚åç§°
        words = subject.split()
        if words:
            first_word = words[0].strip('-_').upper()
            if len(first_word) >= 2:  # è‡³å°‘2ä¸ªå­—ç¬¦
                return first_word
        
        # é»˜è®¤è¿”å›æœªçŸ¥é—¨å¸‚
        return "UNKNOWN"


if __name__ == '__main__':
    try:
        app = SushiExpressApp()
        app.mainloop()
    except Exception as e:
        messagebox.showerror("Error", f"Startup failed: {e}")
        sys.exit(1)
